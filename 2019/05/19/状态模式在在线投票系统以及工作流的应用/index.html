<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="设计模式,状态模式,设计模式应用,">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="状态模式在在线投票系统以及工作流的应用  原文地址：https://juejin.im/post/5cd98e1af265da03705fd749   在线投票场景问题&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;考虑一个在线投票的应用，要实现控制同一个用户只能投一票，如果一个用户反复投票，而且投票次数超过5次，则判定为恶意刷票，要取消该用户投票的资格，当然同时也要取消他">
<meta name="keywords" content="设计模式,状态模式,设计模式应用">
<meta property="og:type" content="article">
<meta property="og:title" content="状态模式在在线投票系统以及工作流的应用">
<meta property="og:url" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="状态模式在在线投票系统以及工作流的应用  原文地址：https://juejin.im/post/5cd98e1af265da03705fd749   在线投票场景问题&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;考虑一个在线投票的应用，要实现控制同一个用户只能投一票，如果一个用户反复投票，而且投票次数超过5次，则判定为恶意刷票，要取消该用户投票的资格，当然同时也要取消他">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde2b6cc9d7d7.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde5559f368f2.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde7bb969be4c.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acded71f35e5e2.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdee03c1270ab.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdfa0603e41fe.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdfa0603e41fe.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdff7a7c4a175.png">
<meta property="og:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16ace05b55a968d6.png">
<meta property="og:updated_time" content="2019-05-19T10:57:12.063Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="状态模式在在线投票系统以及工作流的应用">
<meta name="twitter:description" content="状态模式在在线投票系统以及工作流的应用  原文地址：https://juejin.im/post/5cd98e1af265da03705fd749   在线投票场景问题&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;考虑一个在线投票的应用，要实现控制同一个用户只能投一票，如果一个用户反复投票，而且投票次数超过5次，则判定为恶意刷票，要取消该用户投票的资格，当然同时也要取消他">
<meta name="twitter:image" content="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde2b6cc9d7d7.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/">





  <title>状态模式在在线投票系统以及工作流的应用 | 搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">状态模式在在线投票系统以及工作流的应用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-19T12:12:57+08:00">
                2019-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/设计模式应用/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式应用</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/设计模式应用/状态模式/" itemprop="url" rel="index">
                    <span itemprop="name">状态模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="状态模式在在线投票系统以及工作流的应用"><a href="#状态模式在在线投票系统以及工作流的应用" class="headerlink" title="状态模式在在线投票系统以及工作流的应用"></a>状态模式在在线投票系统以及工作流的应用</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://juejin.im/post/5cd98e1af265da03705fd749" target="_blank" rel="noopener">https://juejin.im/post/5cd98e1af265da03705fd749</a></p>
</blockquote>
<p><br></p>
<h2 id="在线投票场景问题"><a href="#在线投票场景问题" class="headerlink" title="在线投票场景问题"></a>在线投票场景问题</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;考虑一个在线投票的应用，要实现控制同一个用户只能投一票，如果一个用户反复投票，而且投票次数超过5次，则判定为恶意刷票，要取消该用户投票的资格，当然同时也要取消他所投的票。如果一个用户的投票次数超过8次，将进入黑名单，禁止再登录和使用系统。</p>
<h2 id="过程式代码实现"><a href="#过程式代码实现" class="headerlink" title="过程式代码实现"></a>过程式代码实现</h2><p>该怎么实现这样的功能呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了控制用户投票，需要记录用户所投票的记录，同时还要记录用户投票的次数，为了简单，直接使用<strong>两个<code>Map</code></strong>来记录。</p>
<p>在投票的过程中，又有四种情况：</p>
<ul>
<li>一是用户是正常投票</li>
<li>二是用户正常投票过后，有意或者无意的重复投票</li>
<li>三是用户恶意投票</li>
<li>四是黑名单用户</li>
</ul>
<p>这几种情况下对应的处理是不一样的。看看代码吧，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 投票管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoteManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票的结果,Map&lt;String,String&gt;对应Map&lt;用户名称,投票的选项&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; mapVote =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票次数,Map&lt;String,Integer&gt;对应Map&lt;用户名称,投票的次数&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; mapVoteCount =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投票</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 投票人，为了简单，就是用户名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteItem 投票的选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user,String voteItem)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//1：先为该用户增加投票的次数</span></span><br><span class="line">       <span class="comment">//先从记录中取出已有的投票次数</span></span><br><span class="line">       Integer oldVoteCount = mapVoteCount.get(user);</span><br><span class="line">       <span class="keyword">if</span> (oldVoteCount==<span class="keyword">null</span>) &#123;</span><br><span class="line">           oldVoteCount = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       oldVoteCount = oldVoteCount + <span class="number">1</span>;</span><br><span class="line">       mapVoteCount.put(user, oldVoteCount);</span><br><span class="line">      </span><br><span class="line">       <span class="comment">//2：判断该用户投票的类型，到底是正常投票、重复投票、恶意投票</span></span><br><span class="line"><span class="comment">//还是上黑名单，然后根据投票类型来进行相应的操作  </span></span><br><span class="line">       <span class="keyword">if</span> (oldVoteCount==<span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">//正常投票</span></span><br><span class="line">           <span class="comment">//记录到投票记录中</span></span><br><span class="line">           mapVote.put(user, voteItem);</span><br><span class="line">           System.out.println(<span class="string">"恭喜你投票成功"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVoteCount&gt;<span class="number">1</span> &amp;&amp; oldVoteCount&lt;<span class="number">5</span>) &#123;</span><br><span class="line">           <span class="comment">//重复投票</span></span><br><span class="line">           <span class="comment">//暂时不做处理</span></span><br><span class="line">           System.out.println(<span class="string">"请不要重复投票"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVoteCount &gt;= <span class="number">5</span> &amp;&amp; oldVoteCount&lt;<span class="number">8</span>) &#123;</span><br><span class="line">           <span class="comment">//恶意投票</span></span><br><span class="line">           <span class="comment">//取消用户的投票资格，并取消投票记录</span></span><br><span class="line">           String s = mapVote.get(user);</span><br><span class="line">           <span class="keyword">if</span>(s!=<span class="keyword">null</span>)&#123;</span><br><span class="line">              mapVote.remove(user);</span><br><span class="line">           &#125;</span><br><span class="line">           System.out.println(<span class="string">"你有恶意刷票行为，取消投票资格"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;=<span class="number">8</span>) &#123;</span><br><span class="line">           <span class="comment">//黑名单</span></span><br><span class="line">           <span class="comment">//记入黑名单中，禁止登录系统了</span></span><br><span class="line">           System.out.println(<span class="string">"进入黑名单，将禁止登录和使用本系统"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写个客户端来测试看看，是否能满足功能要求，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       VoteManager vm = <span class="keyword">new</span> VoteManager();</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">           vm.vote(<span class="string">"u1"</span>, <span class="string">"A"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<blockquote>
<p>恭喜你投票成功</p>
<p>请不要重复投票</p>
<p>请不要重复投票</p>
<p>请不要重复投票</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>进入黑名单，将禁止登录和使用本系统</p>
</blockquote>
<h3 id="有何问题"><a href="#有何问题" class="headerlink" title="有何问题"></a>有何问题</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看起来很简单，是不是？幸亏这里只是示意，否则，你想想，在<code>vote()</code>方法中那么多判断，还有每个判断对应的功能处理都放在一起，是不是有点太杂乱了，那简直就是个大杂烩，如果把每个功能都完整的实现出来，那<code>vote()</code>方法会很长的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个问题是：<strong>如果现在要修改某种投票情况所对应的具体功能处理，那就需要在那个大杂烩里面，找到相应的代码块，然后进行改动</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外一个问题是：如果要添加新的功能，比如投票超过8次但不足10次的，给个机会，只是禁止登录和使用系统3天，如果再犯，才永久封掉账号，该怎么办呢？那就需要改动投票管理的源代码，在上面的<code>if-else</code>结构中再添加一个<code>else if</code>块进行处理。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不管哪一种情况，都是在一大堆的控制代码里面找出需要的部分，然后进行修改，这从来都不是好方法，那么该如何实现才能做到：既能够很容易的给<code>vote()</code>方法添加新的功能，又能够很方便的修改已有的功能处理呢？</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>状态模式来解决</p>
<p>用来解决上述问题的一个合理的解决方案就是状态模式。那么什么是状态模式呢？</p>
<h2 id="状态模式介绍"><a href="#状态模式介绍" class="headerlink" title="状态模式介绍"></a>状态模式介绍</h2><h3 id="状态模式定义"><a href="#状态模式定义" class="headerlink" title="状态模式定义"></a>状态模式定义</h3><p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde2b6cc9d7d7.png" alt="img"></p>
<h3 id="应用状态模式来解决的思路"><a href="#应用状态模式来解决的思路" class="headerlink" title="应用状态模式来解决的思路"></a>应用状态模式来解决的思路</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;仔细分析上面的问题，会发现，那几种用户投票的类型，就相当于是描述了人员的<strong>几种投票状态，而各个状态和对应的功能处理具有很强的对应性</strong>，有点类似于“一个萝卜一个坑”，各个状态下的处理基本上都是不一样的，也不存在可以相互替换的可能。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了解决上面提出的问题，很自然的一个设计就是首先把状态和状态对应的行为从原来的大杂烩代码中分离出来，<strong>把每个状态所对应的功能处理封装在一个独立的类里面，这样选择不同处理的时候，其实就是在选择不同的状态处理类</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后为了统一操作这些不同的状态类，定义一个状态接口来约束它们，这样外部就可以面向这个统一的状态接口编程，而无需关心具体的状态类实现了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样一来，要修改某种投票情况所对应的具体功能处理，那就是直接修改或者扩展某个状态处理类的功能就可以了。而要添加新的功能就更简单，直接添加新的状态处理类就可以了，当然在使用<code>Context</code>的时候，需要设置使用这个新的状态类的实例。</p>
<h3 id="模式结构和说明"><a href="#模式结构和说明" class="headerlink" title="模式结构和说明"></a>模式结构和说明</h3><p>状态模式的结构如图所示：</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde5559f368f2.png" alt="img"></p>
<p><code>Context</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">环境，也称上下文，通常用来定义客户感兴趣的接口，同时维护一个来具体处理当前状态的实例对象。</span><br></pre></td></tr></table></figure>
<p><code>State</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">状态接口，用来封装与上下文的一个特定状态所对应的行为。</span><br></pre></td></tr></table></figure>
<p><code>ConcreteState</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">具体实现状态处理的类，每个类实现一个跟上下文相关的状态的具体处理。</span><br></pre></td></tr></table></figure>
<h3 id="状态模式示例代码"><a href="#状态模式示例代码" class="headerlink" title="状态模式示例代码"></a>状态模式示例代码</h3><p>（1）首先来看状态接口，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装与Context的一个特定状态相关的行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态对应的处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sampleParameter 示例参数，说明可以传入参数，具体传入</span></span><br><span class="line"><span class="comment">     *             什么样的参数，传入几个参数，由具体应用来具体分析</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String sampleParameter)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）再来看看具体的状态实现，目前具体的实现<code>ConcreteStateA</code>和<code>ConcreteStateB</code>示范的是一样的，只是名称不同，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现一个与Context的一个特定状态相关的行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStateA</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String sampleParameter)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//实现具体的处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现一个与Context的一个特定状态相关的行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStateB</span> <span class="keyword">implements</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String sampleParameter)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//实现具体的处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）再来看看上下文的具体实现，上下文通常用来定义客户感兴趣的接口，同时维护一个具体的处理当前状态的实例对象。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义客户感兴趣的接口，通常会维护一个State类型的对象实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 持有一个State类型的对象实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置实现State的对象的实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state 实现State的对象的实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户感兴趣的接口方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sampleParameter 示意参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(String sampleParameter)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//在处理中，会转调state来处理</span></span><br><span class="line">       state.handle(sampleParameter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用状态模式重写示例"><a href="#使用状态模式重写示例" class="headerlink" title="使用状态模式重写示例"></a>使用状态模式重写示例</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;要使用状态模式，首先就需要把投票过程的各种状态定义出来，然后把这些状态对应的处理从原来大杂烩的实现中分离出来，形成独立的状态处理对象。而原来的投票管理的对象就相当于<code>Context</code>了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;把状态对应的行为分离出去过后，怎么调用呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;按照状态模式的示例，是在<code>Context</code>中，处理客户请求的时候，转调相应的状态对应的具体的状态处理类来进行处理。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那就引出下一个问题：那么这些状态怎么变化呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看原来的实现，就是在投票方法里面，根据投票的次数进行判断，并维护投票类型的变化。那好，也依葫芦画瓢，就在投票方法里面来维护状态变化。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个时候的程序结构如图:</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acde7bb969be4c.png" alt="img"></p>
<p>（1）先来看状态接口的代码实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装一个投票状态相关的行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VoteState</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理状态对应的行为</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 投票人</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteItem 投票项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteManager 投票上下文，用来在实现状态对应的功能处理的时候，</span></span><br><span class="line"><span class="comment">     *                    可以回调上下文的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user,String voteItem,VoteManager voteManager)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）定义了状态接口，那就该来看看如何实现各个状态对应的处理了，现在的实现很简单，就是把原来的实现从投票管理类里面分离出来就可以了。</p>
<p>先看正常投票状态对应的处理，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem,VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//正常投票</span></span><br><span class="line">       <span class="comment">//记录到投票记录中</span></span><br><span class="line">       voteManager.getMapVote().put(user, voteItem);</span><br><span class="line">       System.out.println(<span class="string">"恭喜你投票成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看重复投票状态对应的处理，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem,VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//重复投票</span></span><br><span class="line">       <span class="comment">//暂时不做处理</span></span><br><span class="line">       System.out.println(<span class="string">"请不要重复投票"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看恶意投票状态对应的处理，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpiteVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem,VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//恶意投票</span></span><br><span class="line">       <span class="comment">//取消用户的投票资格，并取消投票记录</span></span><br><span class="line">       String s = voteManager.getMapVote().get(user);</span><br><span class="line">       <span class="keyword">if</span>(s!=<span class="keyword">null</span>)&#123;</span><br><span class="line">           voteManager.getMapVote().remove(user);</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">"你有恶意刷票行为，取消投票资格"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看黑名单状态对应的处理，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem,VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//黑名单</span></span><br><span class="line">       <span class="comment">//记入黑名单中，禁止登录系统了</span></span><br><span class="line">       System.out.println(<span class="string">"进入黑名单，将禁止登录和使用本系统"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）定义好了状态接口和状态实现，看看现在的投票管理，相当于状态模式中的上下文，相对而言，它的改变如下：</p>
<ul>
<li>添加持有状态处理对象</li>
<li>添加能获取记录用户投票结果的<code>Map</code>的方法，各个状态处理对象，在进行状态对应的处理的时候，需要获取上下文中的记录用户投票结果的<code>Map</code>数据</li>
<li>在<code>vote()</code>方法实现里面，原来判断投票类型就变成了判断投票的状态，而原来每种投票类型对应的处理，现在已经封装到对应的状态对象里面去了，因此直接转调对应的状态对象的方法即可</li>
</ul>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 投票管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoteManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 持有状态处理对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> VoteState state = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票的结果,Map&lt;String,String&gt;对应Map&lt;用户名称,投票的选项&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; mapVote =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票次数,Map&lt;String,Integer&gt;对应Map&lt;用户名称,投票的次数&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; mapVoteCount =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取记录用户投票结果的Map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 记录用户投票结果的Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getMapVote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mapVote;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投票</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 投票人，为了简单，就是用户名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteItem 投票的选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user,String voteItem)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//1：先为该用户增加投票的次数</span></span><br><span class="line">       <span class="comment">//先从记录中取出已有的投票次数</span></span><br><span class="line">       Integer oldVoteCount = mapVoteCount.get(user);</span><br><span class="line">       <span class="keyword">if</span>(oldVoteCount==<span class="keyword">null</span>)&#123;</span><br><span class="line">           oldVoteCount = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       oldVoteCount = oldVoteCount + <span class="number">1</span>;</span><br><span class="line">       mapVoteCount.put(user, oldVoteCount); </span><br><span class="line">       </span><br><span class="line">       <span class="comment">//2：判断该用户投票的类型，就相当于是判断对应的状态</span></span><br><span class="line">       <span class="comment">//到底是正常投票、重复投票、恶意投票还是上黑名单的状态</span></span><br><span class="line">       <span class="keyword">if</span> (oldVoteCount==<span class="number">1</span>) &#123;</span><br><span class="line">           state = <span class="keyword">new</span> NormalVoteState();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;<span class="number">1</span> &amp;&amp; oldVoteCount&lt;<span class="number">5</span>) &#123;</span><br><span class="line">           state = <span class="keyword">new</span> RepeatVoteState();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount &gt;= <span class="number">5</span> &amp;&amp; oldVoteCount&lt;<span class="number">8</span>) &#123;</span><br><span class="line">           state = <span class="keyword">new</span> SpiteVoteState();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;=<span class="number">8</span>) &#123;</span><br><span class="line">           state = <span class="keyword">new</span> BlackVoteState();</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">       <span class="comment">//然后转调状态对象来进行相应的操作</span></span><br><span class="line">       state.vote(user, voteItem, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）该写个客户端来测试一下了，经过这么修改过后，好用吗？试试看就知道了。客户端没有任何的改变，跟前面实现的一样，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       VoteManager vm = <span class="keyword">new</span> VoteManager();</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">           vm.vote(<span class="string">"u1"</span>, <span class="string">"A"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行一下试试吧，结果应该是跟前面一样的，也就是说都是实现一样的功能，只是采用了状态模式来实现。测试结果如下：</p>
<blockquote>
<p>恭喜你投票成功</p>
<p>请不要重复投票</p>
<p>请不要重复投票</p>
<p>请不要重复投票</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>你有恶意刷票行为，取消投票资格</p>
<p>进入黑名单，将禁止登录和使用本系统</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从上面的示例可以看出，<strong>状态的转换基本上都是内部行为，主要在状态模式内部来维护</strong>。比如对于投票的人员，任何时候他的操作都是投票，但是投票管理对象的处理却不一定一样，会根据投票的次数来判断状态，然后根据状态去选择不同的处理。</p>
<h2 id="认识状态模式"><a href="#认识状态模式" class="headerlink" title="认识状态模式"></a>认识状态模式</h2><h3 id="状态和行为"><a href="#状态和行为" class="headerlink" title="状态和行为"></a>状态和行为</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<strong>对象的状态，通常指的就是对象实例的属性的值；而行为指的就是对象的功能</strong>，再具体点说，行为多半可以对应到方法上。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>状态模式的功能就是分离状态的行为，通过维护状态的变化，来调用不同的状态对应的不同的功能</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;也就是说，状态和行为是相关联的，它们的关系可以描述为：<strong>状态决定行为</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于状态是在运行期被改变的，因此行为也会在运行期，根据状态的改变而改变，看起来，同一个对象，在不同的运行时刻，行为是不一样的，就像是类被修改了一样。</p>
<h3 id="行为的平行性"><a href="#行为的平行性" class="headerlink" title="行为的平行性"></a>行为的平行性</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注意是平行性而不是平等性。所谓平行性指的是各个状态的行为所处的层次是一样的，相互是独立的、没有关联的，是<strong>根据不同的状态来决定到底走平行线的那一条，行为是不同的，当然对应的实现也是不同的，相互之间是不可替换的</strong>。</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acded71f35e5e2.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而平等性强调的是可替换性，<strong>大家是同一行为的不同描述或实现，因此在同一个行为发生的时候，可以根据条件来挑选任意一个实现来进行相应的处理</strong>。</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdee03c1270ab.png" alt="img"></p>
<p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大家可能会发现状态模式的结构和策略模式的结构完全一样，但是，它们的目的、实现、本质都是完全不一样的。这个行为之间的特性也是状态模式和策略模式一个很重要的区别，<strong>状态模式的行为是平行性的，不可相互替换的；而策略模式的行为是平等性的，是可以相互替换的</strong>。</p>
<h3 id="上下文和状态处理对象"><a href="#上下文和状态处理对象" class="headerlink" title="上下文和状态处理对象"></a>上下文和状态处理对象</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在状态模式中，上下文是持有状态的对象，但是上下文自身并不处理跟状态相关的行为，而是把处理状态的功能委托给了状态对应的状态处理类来处理</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在具体的状态处理类里面经常需要获取上下文自身的数据，甚至在必要的时候会回调上下文的方法，因此，<strong>通常将上下文自身当作一个参数传递给具体的状态处理类</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>客户端一般只和上下文交互</strong>，客户端可以用状态对象来配置一个上下文，一旦配置完毕，就不再需要和状态对象打交道了，<strong>客户端通常不负责运行期间状态的维护，也不负责决定到底后续使用哪一个具体的状态处理对象</strong>。</p>
<h3 id="不完美的OCP体验"><a href="#不完美的OCP体验" class="headerlink" title="不完美的OCP体验"></a>不完美的OCP体验</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;好了，已经使用状态模式来重写了前面的示例，那么到底能不能解决前面提出的问题呢？也就是修改和扩展方不方便呢？一起来看一下。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先看修改已有的功能吧，由于现在每个状态对应的处理已经封装到对应的状态类里面了，<strong>要修改已有的某个状态的功能，直接扩展某个类进行修改就好了，对其它的程序没有影响</strong>。比如：现在要修改正常投票状态对应的功能，对于正常投票的用户给予积分奖励，那么只需要扩展正常投票状态对应的类，然后进行修改，示例代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalVoteState2</span> <span class="keyword">extends</span> <span class="title">NormalVoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//先调用已有的功能</span></span><br><span class="line">       <span class="keyword">super</span>.vote(user, voteItem, voteManager);</span><br><span class="line">       <span class="comment">//给予积分奖励，示意一下</span></span><br><span class="line">       System.out.println(<span class="string">"奖励积分10分"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一切良好，对吧，可是怎么让<code>VoteManager</code>能使用这个新的实现类呢？按照目前的实现，没有办法，只好去修改<code>VoteManager</code>的<code>vote()</code>方法中对状态的维护代码了，把使用<code>NormalVoteState</code>的地方换成使用<code>NormalVoteState2</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;再看看如何添加新的功能，比如投票超过8次但不足10次的，给个机会，只是禁止登录和使用系统3天，如果再犯，才进入黑名单。要实现这个功能，先要对原来的投票超过8次进入黑名单的功能进行修改，修改成投票超过10次才进入黑名单；然后新加入一个功能，实现超过8次但不足10次的，只是禁止登录和使用系统3天的功能。把这个新功能实现出来，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackWarnVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//待进黑名单警告状态</span></span><br><span class="line">       System.out.println(<span class="string">"禁止登录和使用系统3天"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实现好了这个类，该怎样加入到已有的系统呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同样需要去修改上下文的vote()方法中对于状态判断和维护的代码，示例代码如下：</span></span><br><span class="line"><span class="keyword">if</span> (oldVoteCount==<span class="number">1</span>) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> NormalVoteState2();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;<span class="number">1</span> &amp;&amp; oldVoteCount&lt;<span class="number">5</span>) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> RepeatVoteState();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount &gt;= <span class="number">5</span> &amp;&amp; oldVoteCount&lt;<span class="number">8</span>) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> SpiteVoteState();</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;=<span class="number">8</span> &amp;&amp; oldVoteCount&lt;<span class="number">10</span>) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> BlackWarnVoteState();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(oldVoteCount&gt;<span class="number">10</span>) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> BlackVoteState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;好像也实现了功能是不是，而且改动起来确实也变得简单点了，但是仔细想想，是不是没有完全遵循<code>OCP</code>原则？结论是很显然的，明显没有完全遵循<code>OCP</code>原则。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里要说明一点，设计原则是大家在设计和开发中尽量去遵守的，但不是一定要遵守，尤其是完全遵守，在实际开发中，完全遵守那些设计原则几乎是不可能完成的任务。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就像<strong>状态模式的实际实现中，由于状态的维护和转换在状态模式结构里面，不管你是扩展了状态实现类，还是新添加了状态实现类，都需要修改状态维护和转换的地方，以使用新的实现</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽然可以有好几个地方来维护状态的变化，这个后面会讲到，但是都是在状态模式结构里面的，所以都有这个问题，算是不完美的<code>OCP</code>体验吧。 </p>
<h3 id="创建和销毁状态对象"><a href="#创建和销毁状态对象" class="headerlink" title="创建和销毁状态对象"></a>创建和销毁状态对象</h3><p>在应用状态模式的时候，有一个常见的考虑，那就是：究竟何时创建和销毁状态对象。常见的有几个选择：</p>
<ul>
<li>一个是当需要使用状态对象的时候创建，使用完后就销毁它们</li>
<li>另一个是提前创建它们并且始终不销毁</li>
<li>还有一种是采用延迟加载和缓存合用的方式，就是当第一次需要使用状态对象的时候创建，使用完后并不销毁对象，而是把这个对象缓存起来，等待下一次使用，而且在合适的时候，会由缓存框架销毁状态对象</li>
</ul>
<p>怎么选择呢？下面给出选择建议：</p>
<p>如果要进入的状态在运行时是不可知的，而且上下文是比较稳定的，不会经常改变状态，而且使用也不频繁，这个时候建议选第一种方案。</p>
<p>如果状态改变很频繁，也就是需要频繁的创建状态对象，而且状态对象还存储着大量的信息数据，这种情况建议选第二种方案。</p>
<p>如果无法确定状态改变是否频繁，而且有些状态对象的状态数据量大，有些比较小，一切都是未知的，建议选第三种方案。</p>
<p>事实上，在实际工程开发中，第三种方案是首选，因为它兼顾了前面两种方案的优点，而又避免了它们的缺点，几乎能适应各种情况的需要。只是这个方案在实现的时候，要实现一个合理的缓存框架，而且要考虑多线程并发的问题，因为需要由缓存框架来在合适的时候销毁状态对象，因此实现上难度稍高点。另外在实现中还可以考虑结合享元模式，通过享元模式来共享状态对象。</p>
<h3 id="状态模式的调用顺序示意图"><a href="#状态模式的调用顺序示意图" class="headerlink" title="状态模式的调用顺序示意图"></a>状态模式的调用顺序示意图</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式在实现上，对于状态的维护有不同的实现方式，前面的示例中，采用的是在<code>Context</code>中进行状态的维护和转换，这里就先画出这种方式的调用顺序示意图，其它的方式在后面讲到了再画。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在<code>Context</code>进行状态维护和转换的调用顺序示意图如图：</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdfa0603e41fe.png" alt="img"></p>
<h3 id="状态的维护和转换控制"><a href="#状态的维护和转换控制" class="headerlink" title="状态的维护和转换控制"></a>状态的维护和转换控制</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<strong>状态的维护，指的就是维护状态的数据，就是给状态设置不同的状态值；而状态的转换，指的就是根据状态的变化来选择不同的状态处理对象</strong>。在状态模式中，通常有两个地方可以进行状态的维护和转换控制。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个就是在上下文当中，因为状态本身通常被实现为上下文对象的状态，因此可以在上下文里面进行状态维护，当然也就可以控制状态的转换了。前面投票的示例就是采用的这种方式。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外一个地方就是<strong>在状态的处理类里面，当每个状态处理对象处理完自身状态所对应的功能后，可以根据需要指定后继的状态，以便让应用能正确处理后续的请求</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先看看示例，为了对比学习，就来看看如何把前面投票的例子修改成：<strong>在状态处理类里面进行后续状态的维护和转换</strong>。</p>
<p>（1）同样先来看投票状态的接口，没有变化，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装一个投票状态相关的行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VoteState</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理状态对应的行为</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 投票人</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteItem 投票项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteManager 投票上下文，用来在实现状态对应的功能处理的时候，</span></span><br><span class="line"><span class="comment">     *                    可以回调上下文的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user,String voteItem,VoteManager voteManager)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）对于各个具体的状态实现对象，主要的变化在于：在处理完自己状态对应的功能后，还需要维护和转换状态对象。</p>
<p>一个一个来看吧，先看看正常投票的状态处理对象，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//正常投票，记录到投票记录中</span></span><br><span class="line">       voteManager.getMapVote().put(user, voteItem);</span><br><span class="line">       System.out.println(<span class="string">"恭喜你投票成功"</span>);</span><br><span class="line">       <span class="comment">//正常投票完成，维护下一个状态，同一个人再投票就重复了</span></span><br><span class="line">       voteManager.getMapState().put(user,<span class="keyword">new</span> RepeatVoteState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看重复投票状态对应的处理对象，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//重复投票，暂时不做处理</span></span><br><span class="line">       System.out.println(<span class="string">"请不要重复投票"</span>);   </span><br><span class="line">       <span class="comment">//重复投票完成，维护下一个状态，重复投票到5次，就算恶意投票了</span></span><br><span class="line">       <span class="comment">//注意这里是判断大于等于4，因为这里设置的是下一个状态</span></span><br><span class="line">       <span class="comment">//下一个操作次数就是5了，就应该算是恶意投票了</span></span><br><span class="line">       <span class="keyword">if</span>(voteManager.getMapVoteCount().get(user) &gt;= <span class="number">4</span>)&#123;</span><br><span class="line">           voteManager.getMapState().put(user,<span class="keyword">new</span> SpiteVoteState());</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看恶意投票状态对应的处理对象，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpiteVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//恶意投票，取消用户的投票资格，并取消投票记录</span></span><br><span class="line">       String s = voteManager.getMapVote().get(user);</span><br><span class="line">       <span class="keyword">if</span> (s!=<span class="keyword">null</span>) &#123;</span><br><span class="line">           voteManager.getMapVote().remove(user);</span><br><span class="line">       &#125;</span><br><span class="line">       System.out.println(<span class="string">"你有恶意刷票行为，取消投票资格"</span>);    </span><br><span class="line">       <span class="comment">//恶意投票完成，维护下一个状态，投票到8次，就进黑名单了</span></span><br><span class="line">       <span class="comment">//注意这里是判断大于等于7，因为这里设置的是下一个状态</span></span><br><span class="line">       <span class="comment">//下一个操作次数就是8了，就应该算是进黑名单了</span></span><br><span class="line">       <span class="keyword">if</span> (voteManager.getMapVoteCount().get(user) &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">           voteManager.getMapState().put(user,<span class="keyword">new</span> BlackVoteState());</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看黑名单状态对应的处理对象，没什么变化，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//黑名单，记入黑名单中，禁止登录系统了</span></span><br><span class="line">       System.out.println(<span class="string">"进入黑名单，将禁止登录和使用本系统"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）该来看看现在的投票管理类该如何实现了，跟在上下文中维护和转换状态相比，大致有如下的变化：</p>
<ul>
<li><strong>需要按照每个用户来记录他们对应的投票状态</strong>，不同的用户，对应的投票状态是不同的，因此使用一个<code>Map</code>来记录，而不再是原来的一个单一的投票状态对象。可能有些朋友会问，那为什么前面的实现可以呢？那是因为投票状态是由投票管理对象集中控制的，不同的人员在进入投票方法的时候，是重新判断该人员具体的状态对象的，而现在是要把状态维护分散到各个状态类里面去，因此需要记录各个状态类判断过后的结果。</li>
<li>需要把记录投票状态的数据，还有记录投票次数的数据，提供相应的<code>getter</code>方法，各个状态在处理的时候需要通过这些方法来访问数据。</li>
<li>将原来在<code>vote()</code>方法里面进行的状态控制和转换去掉，变成<strong>直接根据人员来从状态记录的<code>Map</code>中获取对应的状态对象了</strong>。</li>
</ul>
<p>看看实现代码吧，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoteManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录当前每个用户对应的状态处理对象，每个用户当前的状态是不同的</span></span><br><span class="line"><span class="comment">     * Map&lt;String,VoteState&gt;对应Map&lt;用户名称,当前对应的状态处理对象&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,VoteState&gt; mapState =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,VoteState&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票的结果,Map&lt;String,String&gt;对应Map&lt;用户名称,投票的选项&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; mapVote =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记录用户投票次数,Map&lt;String,Integer&gt;对应Map&lt;用户名称,投票的次数&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Integer&gt; mapVoteCount =</span><br><span class="line"><span class="keyword">new</span> HashMap&lt;String,Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取记录用户投票结果的Map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 记录用户投票结果的Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getMapVote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mapVote;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取记录每个用户对应的状态处理对象的Map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 记录每个用户对应的状态处理对象的Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, VoteState&gt; <span class="title">getMapState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mapState;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取记录每个用户对应的投票次数的Map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 记录每个用户对应的投票次数的Map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Integer&gt; <span class="title">getMapVoteCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> mapVoteCount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 投票</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 投票人，为了简单，就是用户名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> voteItem 投票的选项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user,String voteItem)</span></span>&#123;</span><br><span class="line">       <span class="comment">//1：先为该用户增加投票的次数</span></span><br><span class="line">       <span class="comment">//先从记录中取出已有的投票次数</span></span><br><span class="line">       Integer oldVoteCount = mapVoteCount.get(user);</span><br><span class="line">       <span class="keyword">if</span>(oldVoteCount==<span class="keyword">null</span>)&#123;</span><br><span class="line">           oldVoteCount = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       oldVoteCount = oldVoteCount + <span class="number">1</span>;</span><br><span class="line">       mapVoteCount.put(user, oldVoteCount);    </span><br><span class="line"> </span><br><span class="line">       <span class="comment">//2：获取该用户的投票状态</span></span><br><span class="line">       VoteState state = mapState.get(user);</span><br><span class="line">       <span class="comment">//如果没有投票状态，说明还没有投过票，就初始化一个正常投票状态</span></span><br><span class="line">       <span class="keyword">if</span> (state==<span class="keyword">null</span>) &#123;</span><br><span class="line">           state = <span class="keyword">new</span> NormalVoteState();</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">       <span class="comment">//然后转调状态对象来进行相应的操作</span></span><br><span class="line">       state.vote(user, voteItem, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）实现得差不多了，该来测试了，客户端没有变化，去运行一下，看看效果，看看两种维护状态变化的方式实现的结果一样吗？答案应该是一样的。</p>
<p>那么到底如何选择这两种方式呢？</p>
<ul>
<li><strong>一般情况下，如果状态转换的规则是一定的，一般不需要进行什么扩展规则，那么就适合在上下文中统一进行状态的维护</strong>。</li>
<li><strong>如果状态的转换取决于前一个状态动态处理的结果，或者是依赖于外部数据，为了增强灵活性，这种情况下，一般是在状态处理类里面进行状态的维护</strong>。</li>
</ul>
<p>（5）采用让状态对象来维护和转换状态的调用顺序示意图</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdfa0603e41fe.png" alt="img"></p>
<p>（6）再来看看这种实现方式下，如何修改已有的功能，或者是添加新的状态处理。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>要修改已有的功能，同样是找到对应的状态处理对象，要么直接修改，要么扩展</strong>，前面已经示例过了，就不再赘述了</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于添加新的状态处理的功能，这种实现方式会比较简单。先直接添加新的状态处理的类，然后去找到需要转换到这个新状态的状态处理类，修改那个处理类，让其转换到这个新状态就可以了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如还是来实现那个：投票超过8次但不足10次的，给个机会，只是禁止登录和使用系统3天，如果再犯，才进入黑名单的功能。按照现在的方式，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlackWarnVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//待进黑名单警告状态</span></span><br><span class="line">       System.out.println(<span class="string">"禁止登录和使用系统3天"</span>);</span><br><span class="line">       <span class="comment">//待进黑名单警告处理完成，维护下一个状态，投票到10次，就进黑名单了</span></span><br><span class="line">       <span class="comment">//注意这里是判断大于等于9，因为这里设置的是下一个状态</span></span><br><span class="line">       <span class="comment">//下一个操作次数就是10了，就应该算是进黑名单了</span></span><br><span class="line">       <span class="keyword">if</span> (voteManager.getMapVoteCount().get(user) &gt;= <span class="number">9</span>) &#123;</span><br><span class="line">           voteManager.getMapState().put(user, <span class="keyword">new</span> BlackVoteState());</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么如何加入系统呢？</p>
<p><strong>不再是去修改<code>VoteManger</code>了，而是找到应该转换到这个新状态的那个状态，修改它的状态维护和转换</strong>。应该是在恶意投票处理里面，让它转换到这个新的状态，也就是把恶意投票处理里面的下面这句话：</p>
<p><code>voteManager.getMapState().put(user, new BlackVoteState());</code></p>
<p>替换成：</p>
<p><code>voteManager.getMapState().put(user, new BlackWarnVoteState());</code></p>
<p>这样就自然的把现在新的状态处理添加到了已有的应用中。</p>
<h3 id="使用数据库来维护状态"><a href="#使用数据库来维护状态" class="headerlink" title="使用数据库来维护状态"></a>使用数据库来维护状态</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在实际开发中，还有一个方式来维护状态，那就是使用数据库，在数据库中存储下一个状态的识别数据，也就是说，维护下一个状态，演化成了维护下一个状态的识别数据，比如状态编码。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样在程序中，<strong>通过查询数据库中的数据来得到状态编码，然后再根据状态编码来创建出相应的状态对象，然后再委托相应的状态对象进行功能处理</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还是用前面投票的示例来说明，如果使用数据库来维护状态的话，大致如何实现。</p>
<p>（1）首先，就是每个具体的状态处理类中，原本在处理完成后，要判断下一个状态是什么，然后创建下一个状态对象，并设置回到上下文中。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果使用数据库的方式，那就不用创建下一个状态对象，也不用设置回到上下文中了，而是把下一个状态对应的编码记入数据库中，这样就可以了。还是示意一个，看看重复投票状态下的实现吧，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RepeatVoteState</span> <span class="keyword">implements</span> <span class="title">VoteState</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">vote</span><span class="params">(String user, String voteItem, VoteManager voteManager)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//重复投票，暂时不做处理</span></span><br><span class="line"></span><br><span class="line">       System.out.println(<span class="string">"请不要重复投票"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//重复投票完成，维护下一个状态，重复投票到5次，就算恶意投票了</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(voteManager.getMapVoteCount().get(user) &gt;= <span class="number">4</span>)&#123;</span><br><span class="line"></span><br><span class="line">            voteManager.getMapState().put(user, <span class="keyword">new</span>  SpiteVoteState());</span><br><span class="line"></span><br><span class="line">           <span class="comment">//直接把下一个状态的编码记录入数据库就好了</span></span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里只是示意一下，并不真的去写和数据库操作的代码。其它的状态实现类，也做同样类似的修改，就不去赘述了。</p>
<p>（2）在<code>Context</code>里面，也就是投票管理对象里面，就不需要那个记录所有用户状态的Map了，直接从数据库中获取该用户当前对应的状态编码，然后根据状态编码来创建出状态对象来。原有的示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2：获取该用户的投票状态</span></span><br><span class="line">VoteState state = mapState.get(user);</span><br><span class="line"><span class="comment">//如果没有投票状态，说明还没有投过票，就初始化一个正常投票状态</span></span><br><span class="line"><span class="keyword">if</span>(state==<span class="keyword">null</span>)&#123;</span><br><span class="line">    state = <span class="keyword">new</span> NormalVoteState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在被修改成，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">VoteState state = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//2：直接从数据库获取该用户对应的下一个状态的状态编码</span></span><br><span class="line">String stateId = <span class="string">"从数据库中获取这个状态编码"</span>;</span><br><span class="line"><span class="comment">//开始根据状态编码来创建需用的状态对象</span></span><br><span class="line"><span class="keyword">if</span> (stateId==<span class="keyword">null</span> || stateId.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//如果没有值，说明还没有投过票，就初始化一个正常投票状态</span></span><br><span class="line">    state = <span class="keyword">new</span> NormalVoteState();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"重复投票"</span>.equals(stateId)) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> RepeatVoteState();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"恶意投票"</span>.equals(stateId)) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> SpiteVoteState();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"黑名单"</span>.equals(stateId)) &#123;</span><br><span class="line">    state = <span class="keyword">new</span> BlackVoteState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可能有些朋友会发现，如果向数据库里面存储下一个状态对象的状态编码，那么上下文中就不需要再持有状态对象了，有点相当于把这个功能放到数据库中了。有那么点相似性，不过要注意，<strong>数据库存储的只是状态编码，而不是状态对象，获取到数据库中的状态编码过后，在程序里面还是需要根据状态编码去真正创建对应的状态对象</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，要想程序更通用一点，可以<strong>通过配置文件来配置状态编码和对应的状态处理类</strong>，当然也可以<strong>直接在数据库中记录状态编码和对应的状态处理类</strong>，这样的话，在上下文中，先获取下一个状态的状态编码，然后根据这个状态编码去获取对应的类，然后可以通过反射来创建对象，这样实现就避免了那一长串的<code>if-else</code>，而且以后添加新的状态编码和状态处理对象也不用再修改代码了。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VoteState state = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//2：直接从数据库获取该用户对应的下一个状态的状态编码</span></span><br><span class="line">String stateId = <span class="string">"从数据库中获取这个值"</span>;</span><br><span class="line"><span class="comment">//开始根据状态编码来创建需用的状态对象</span></span><br><span class="line">      </span><br><span class="line"><span class="comment">//根据状态编码去获取相应的类</span></span><br><span class="line">String className = <span class="string">"根据状态编码去获取相应的类"</span>;</span><br><span class="line"><span class="comment">//使用反射创建对象实例，简单示意一下</span></span><br><span class="line">Class c = Class.forName(className);</span><br><span class="line">state = (VoteState)c.newInstance();</span><br></pre></td></tr></table></figure>
<p>（3）直接把“转移”记录到数据库中</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还有一种情况是直接把“转移”记录到数据库中，这样会更灵活。所谓<strong>转移，指的就是描述从A状态到B状态的这么一个转换变化</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如：在正常投票状态处理对象里面指定使用“转移A”，而“转移A”描述的就是从正常投票状态转换成重复投票状态。这样一来，假如今后想要让正常投票处理过后变换成恶意投票状态，那么就不需要修改程序，直接修改数据库中的数据，把数据库中“转移A”的描述数据修改一下，使其描述从正常投票状态转换成恶意投票状态就可以了。</p>
<h2 id="模拟工作流"><a href="#模拟工作流" class="headerlink" title="模拟工作流"></a>模拟工作流</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;做企业应用的朋友，大多数都接触过工作流，至少处理过业务流程。当然对于工作流，复杂的应用可能会使用工作流中间件，用工作流引擎来负责流程处理，这个会比较复杂，其实工作流引擎的实现也可以应用上状态模式，这里不去讨论。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;简单点的，<strong>把流程数据存放在数据库里面，然后在程序里面自己来进行流程控制。对于简单点的业务流程控制，可以使用状态模式来辅助进行流程控制，因为大部分这种流程都是状态驱动的</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子来说明吧，举个最常见的“请假流程”，流程是这样的：当某人提出请假申请过后，先由项目经理来审批，如果项目经理不同意，审批就直接结束；如果项目经理同意了，再看请假的天数是否超过3天，项目经理的审批权限只有3天以内，如果请假天数在3天以内，那么审批也直接结束，否则就提交给部门经理；部门经理审核过后，无论是否同意，审批都直接结束。流程图如图：</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16acdff7a7c4a175.png" alt="img"></p>
<p>在实际开发中，如果不考虑使用工作流软件，按照流程来自己实现的话，这个流程基本的运行过程简化描述如下：</p>
<ul>
<li>1：UI操作：请假人填写请假单，提出请假申请</li>
<li>2：后台处理：保存请假单数据到数据库中，然后为项目经理创建一个工作，把工作信息保存到数据库中</li>
<li>3：UI操作：项目经理登录系统，获取自己的工作列表</li>
<li>4：后台处理：从数据库中获取相应的工作列表</li>
<li>5：UI操作：项目经理完成审核工作，提交保存</li>
<li>6：后台处理：处理项目经理审核的业务，保存审核的信息到数据库。同时判断后续的工作，如果是需要人员参与的，就为参与下一个工作的人员创建工作，把工作信息保存到数据库中</li>
<li>7：UI操作：部门经理登录系统，获取自己的工作列表，基本上是重复第3步</li>
<li>8：后台处理：从数据库中获取相应的工作列表，基本上是重复第4步</li>
<li>9：UI操作：部门经理完成审核工作，提交保存，基本上是重复第5步</li>
<li>10：后台处理：类推，基本上是重复第6步</li>
</ul>
<p>1：实现思路</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;仔细分析上面的流程图和运行过程，把请假单在流程中的各个阶段的状态分析出来，会发现，整个流程完全可以看成是状态驱动的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在上面的流程中，请假单大致有如下状态：<strong>等待项目经理审核、等待部门经理审核、审核结束</strong>。如果用状态驱动来描述上述流程：</p>
<ul>
<li><p>当请假人填写请假单，提出请假申请后，请假单的状态是等待项目经理审核状态；</p>
</li>
<li><p>当项目经理完成审核工作，提交保存后，如果项目经理不同意，请假单的状态是审核结束状态；</p>
<p>如果项目经理同意，请假天数又在3天以内，请假单的状态是审核结束状态；</p>
<p>如果项目经理同意，请假天数大于3天，请假单的状态是等待部门经理审核状态；</p>
</li>
<li><p>当部门经理完成审核工作，提交保存后，无论是否同意，请假单的状态都是审核结束状态；</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;既然可以把流程看成是状态驱动的，那么就可以自然的使用上状态模式<strong>，每次当相应的工作人员完成工作，请求流程响应的时候，流程处理的对象会根据当前所处的状态，把流程处理委托给相应的状态对象去处理</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;又考虑到在一个系统中会有很多流程，虽然不像通用工作流那么复杂的设计，但还是稍稍提炼一下，至少把各个不同的业务流程，在应用状态模式时的公共功能，或者是架子给搭出来，以便复用这些功能。</p>
<p>（1）首先提供一个公共的状态处理机</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;相当于一个公共的状态模式的<code>Context</code>，在里面提供基本的、公共的功能，这样在实现具体的流程的时候，可以简单一些，对于要求不复杂的流程，甚至可以直接使用。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 公共状态处理机，相当于状态模式的Context</span></span><br><span class="line"><span class="comment"> * 包含所有流程使用状态模式时的公共功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">class</span> <span class="title">StateMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 持有一个状态对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> State state = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 包含流程处理需要的业务数据对象，不知道具体类型,为了简单，不去使用泛型，</span></span><br><span class="line"><span class="comment">     * 用Object，反正只是传递到具体的状态对象里面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object businessVO = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行工作，客户端处理流程的接口方法。</span></span><br><span class="line"><span class="comment">     * 在客户完成自己的业务工作后调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="comment">//转调相应的状态对象真正完成功能处理</span></span><br><span class="line">       <span class="keyword">this</span>.state.doWork(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getBusinessVO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> businessVO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBusinessVO</span><span class="params">(Object businessVO)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.businessVO = businessVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）来提供公共的状态接口，各个状态对象在处理流程的时候，可以使用统一的接口，那么它们需要的业务数据从何而来呢？那就通过上下文传递过来。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 公共状态接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行状态对应的功能处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx 上下文的实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine ctx)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;好了，现在架子已经搭出来了，在实现具体的流程的时候，可以分别扩展它们，来加入跟具体流程相关的功能。</p>
<p>2：使用状态模式来实现流程</p>
<p>（1）定义请假单的业务数据模型，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaveRequestModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请假人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请假开始时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String beginDate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请假天数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> leaveDays;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 审核结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String result;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBeginDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> beginDate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLeaveDays</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> leaveDays;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(String user)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeginDate</span><span class="params">(String beginDate)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.beginDate = beginDate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLeaveDays</span><span class="params">(<span class="keyword">int</span> leaveDays)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.leaveDays = leaveDays;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）定义处理客户端请求的上下文，虽然这里并不需要扩展功能，但还是继承一下状态机，表示可以添加自己的处理。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeaveRequestContext</span> <span class="keyword">extends</span> <span class="title">StateMachine</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里可以扩展跟自己流程相关的处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）接下来定义处理请假流程的状态接口，虽然这里并不需要扩展功能，但还是继承一下状态，表示可以添加自己的处理。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LeaveRequestState</span> <span class="keyword">extends</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里可以扩展跟自己流程相关的处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）接下来该来实现各个状态具体的处理对象了，先看看处理项目经理审核的状态类的实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理项目经理的审核，处理后可能对应部门经理审核、审核结束之中的一种</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProjectManagerState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//先把业务对象造型回来</span></span><br><span class="line">		LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//业务处理，把审核结果保存到数据库中</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//根据选择的结果和条件来设置下一步</span></span><br><span class="line">		<span class="keyword">if</span> (! <span class="string">"同意"</span>.equals(lrm.getResult())) &#123;</span><br><span class="line">			<span class="comment">//项目经理不同意的话，也就不用提交给部门经理了，转向审核结束状态</span></span><br><span class="line">			request.setState(<span class="keyword">new</span>  AuditOverState());</span><br><span class="line">			<span class="comment">//给申请人增加一个工作，让他查看审核结果</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (lrm.getLeaveDays() &gt; <span class="number">3</span>) &#123;</span><br><span class="line">			<span class="comment">//如果请假天数大于3天，而且项目经理同意了，就提交给部门经理</span></span><br><span class="line">			request.setState(<span class="keyword">new</span> DepManagerState());</span><br><span class="line">			<span class="comment">//为部门经理增加一个工作</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//3天以内的请假，由项目经理做主,</span></span><br><span class="line">			<span class="comment">//就不用提交给部门经理了，转向审核结束状态</span></span><br><span class="line">			request.setState(<span class="keyword">new</span>  AuditOverState());</span><br><span class="line">			<span class="comment">//给申请人增加一个工作，让他查看审核结果</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看处理项目经理审核的状态类的实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理部门经理的审核，处理后对应审核结束状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepManagerState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//先把业务对象造型回来</span></span><br><span class="line">       LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line"> </span><br><span class="line">       <span class="comment">//业务处理，把审核结果保存到数据库中</span></span><br><span class="line">      </span><br><span class="line">       <span class="comment">//部门经理审核过后，直接转向审核结束状态了</span></span><br><span class="line">       request.setState(<span class="keyword">new</span> AuditOverState());</span><br><span class="line"> </span><br><span class="line">       <span class="comment">//给申请人增加一个工作，让他查看审核结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看处理审核结束的状态类的实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理审核结束的类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditOverState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//先把业务对象造型回来</span></span><br><span class="line">       LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line">       <span class="comment">//业务处理，在数据里面记录整个流程结束   </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（5）由于上面的实现中，涉及到大量需要数据库支持的功能，同时还需要提供页面来让用户操作，才能驱动流程运行，所以无法像其它示例那样，写个客户端就能进行测试。当然这个可以在后面稍稍改变一下，模拟一下实现，就可以运行起来看效果了。</p>
<p>先来看看此时用状态模式实现的这个流程的程序结构示意图，如图：</p>
<p><img src="//blog.com/2019/05/19/状态模式在在线投票系统以及工作流的应用/16ace05b55a968d6.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面来看看怎么改造一下上面的示例，让它能运转起来，这样更加有利于大家去体会在处理这种流程的应用中，如何使用状态模式。</p>
<p>3：改进上面使用状态模式来实现流程的示例</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上面的示例不能运行有两个基本原因：一是没有数据库实现部分，二是没有界面。要解决这个问题，那就采用字符界面，来让客户输入数据，另外把运行放到同一个线程里面，这样就不存在传递数据的问题，也就不需要保存数据了，数据在内存里面。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;原来是提交了请假申请，把数据保存在数据库里面，然后项目经理从数据库去获取这些数据。现在一步到位，直接把申请数据传递过去，就可以处理了。</p>
<p>（1）根据上面的思路，其实也就只是需要修改那几个状态处理对象的实现，先看看处理项目经理审核的状态类的实现，使用Scanner来接受命令行输入数据，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理项目经理的审核，处理后可能对应部门经理审核、审核结束之中的一种</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProjectManagerState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//先把业务对象造型回来</span></span><br><span class="line">		LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">"项目经理审核中，请稍候......"</span>);</span><br><span class="line">		<span class="comment">//模拟用户处理界面，通过控制台来读取数据</span></span><br><span class="line">		System.out.println(lrm.getUser()+<span class="string">"申请从"</span>+lrm.getBeginDate()+<span class="string">"开始请假"</span>+lrm.getLeaveDays()+<span class="string">"天,请项目经理审核(1为同意，2为不同意)："</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//读取从控制台输入的数据</span></span><br><span class="line">		Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		<span class="keyword">if</span> (scanner.hasNext()) &#123;</span><br><span class="line">			<span class="keyword">int</span> a = scanner.nextInt();</span><br><span class="line">			<span class="comment">//设置回到上下文中</span></span><br><span class="line">			String result = <span class="string">"不同意"</span>;</span><br><span class="line">			<span class="keyword">if</span> (a==<span class="number">1</span>) &#123;</span><br><span class="line">				result = <span class="string">"同意"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			lrm.setResult(<span class="string">"项目经理审核结果："</span>+result);</span><br><span class="line">			<span class="keyword">if</span> (a != <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="comment">//项目经理不同意，就不用提交给部门经理了，转向审核结束状态</span></span><br><span class="line">				request.setState(<span class="keyword">new</span>  AuditOverState());</span><br><span class="line">				<span class="comment">//继续执行下一步工作</span></span><br><span class="line">				request.doWork();</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (lrm.getLeaveDays() &gt; <span class="number">3</span>) &#123;</span><br><span class="line">				<span class="comment">//如果请假天数大于3天，而且项目经理同意了，</span></span><br><span class="line">				<span class="comment">//就提交给部门经理</span></span><br><span class="line">				request.setState(<span class="keyword">new</span> DepManagerState());</span><br><span class="line">				<span class="comment">//继续执行下一步工作【这里的下一步，可以认为插入数据库下一步的流程快照】</span></span><br><span class="line">				request.doWork();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//3天以内的请假，由项目经理做主,就不用提交给部门经理了，</span></span><br><span class="line">				<span class="comment">//转向审核结束状态</span></span><br><span class="line">				request.setState(<span class="keyword">new</span>  AuditOverState());</span><br><span class="line">				<span class="comment">//继续执行下一步工作</span></span><br><span class="line">				request.doWork();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看看处理项目经理审核的状态类的实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理部门经理的审核，处理后对应审核结束状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepManagerState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//先把业务对象造型回来</span></span><br><span class="line">       LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line">        </span><br><span class="line">       System.out.println(<span class="string">"部门经理审核中，请稍候......"</span>);</span><br><span class="line">       <span class="comment">//模拟用户处理界面，通过控制台来读取数据</span></span><br><span class="line">       System.out.println(lrm.getUser()+<span class="string">"申请从"</span>+lrm.getBeginDate()+<span class="string">"开始请假"</span>+lrm.getLeaveDays()+<span class="string">"天,请部门经理审核(1为同意，2为不同意)："</span>);</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//读取从控制台输入的数据</span></span><br><span class="line">       Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">       <span class="keyword">if</span> (scanner.hasNext()) &#123;</span><br><span class="line">           <span class="keyword">int</span> a = scanner.nextInt();</span><br><span class="line">           <span class="comment">//设置回到上下文中</span></span><br><span class="line">           String result = <span class="string">"不同意"</span>;</span><br><span class="line">           <span class="keyword">if</span> (a==<span class="number">1</span>) &#123;</span><br><span class="line">              result = <span class="string">"同意"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           lrm.setResult(<span class="string">"部门经理审核结果："</span>+result);</span><br><span class="line">           <span class="comment">//部门经理审核过后，直接转向审核结束状态了</span></span><br><span class="line">           request.setState(<span class="keyword">new</span> AuditOverState());</span><br><span class="line">           <span class="comment">//继续执行下一步工作</span></span><br><span class="line">           request.doWork();</span><br><span class="line">       &#125;     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看处理审核结束的状态类的实现，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditOverState</span> <span class="keyword">implements</span> <span class="title">LeaveRequestState</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">(StateMachine request)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//先把业务对象造型回来</span></span><br><span class="line">       LeaveRequestModel lrm = (LeaveRequestModel)request.getBusinessVO();</span><br><span class="line">       System.out.println(lrm.getUser()+<span class="string">"，你的请假申请已经审核结束，结果是："</span>+lrm.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）万事俱备，可以写个客户端，来开始我们的流程之旅了。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//创建业务对象，并设置业务数据</span></span><br><span class="line">       LeaveRequestModel lrm = <span class="keyword">new</span> LeaveRequestModel();</span><br><span class="line">       lrm.setUser(<span class="string">"小李"</span>);</span><br><span class="line">       lrm.setBeginDate(<span class="string">"2010-02-08"</span>);</span><br><span class="line">       lrm.setLeaveDays(<span class="number">5</span>);</span><br><span class="line">      </span><br><span class="line">       <span class="comment">//创建上下文对象</span></span><br><span class="line">       LeaveRequestContext request = <span class="keyword">new</span> LeaveRequestContext();</span><br><span class="line">       <span class="comment">//为上下文对象设置业务数据对象</span></span><br><span class="line">       request.setBusinessVO(lrm);</span><br><span class="line">       <span class="comment">//配置上下文，作为开始的状态，以后就不管了</span></span><br><span class="line">       request.setState(<span class="keyword">new</span> ProjectManagerState());</span><br><span class="line">      </span><br><span class="line">       <span class="comment">//请求上下文，让上下文开始处理工作</span></span><br><span class="line">       request.doWork();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>辛苦了这么久，一定要好好的运行一下，体会在流程处理中是如何使用状态模式的。</p>
<blockquote>
<p>第一步：运行一下，刚开始会出现如下信息：</p>
<p><strong>项目经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请项目经理审核(1为同意，2为不同意)：</strong></p>
<p>第二步：程序并没有停止，在等待你输入项目经理审核的结果，如果你输入1，表示同意，那么程序会继续判断，发现请假天数5天大于项目经理审核的范围了，会提交给部门经理审核。在控制台输入1，然后回车看看，会出现如下信息：</p>
<p><strong>项目经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请项目经理审核(1为同意，2为不同意)：</strong></p>
<p><strong>1</strong></p>
<p><strong>部门经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请部门经理审核(1为同意，2为不同意)：</strong></p>
<p>第三步：同样，程序仍然没有停止，在等待你输入部门经理审核的结果，假如输入1，然后回车，看看会发生什么，提示信息如下：</p>
<p><strong>项目经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请项目经理审核(1为同意，2为不同意)：</strong></p>
<p><strong>1</strong></p>
<p><strong>部门经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请部门经理审核(1为同意，2为不同意)：</strong></p>
<p><strong>1</strong></p>
<p><strong>小李，你的请假申请已经审核结束，结果是：部门经理审核结果：同意</strong></p>
<p>这个时候流程运行结束了，程序运行也结束了，有点流程控制的意味了吧。</p>
<p>如果在上面第一步运行过后，在第二步输入2，也就是项目经理不同意，会怎样呢？应该就不会再到部门经理了吧，试试看，运行提示信息如下：</p>
<p><strong>项目经理审核中，请稍候……</strong></p>
<p><strong>小李申请从2010-02-08开始请假5天,请项目经理审核(1为同意，2为不同意)：</strong></p>
<p>2</p>
<p><strong>小李，你的请假申请已经审核结束，结果是：项目经理审核结果：不同意</strong></p>
</blockquote>
<p>（5）小结一下</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;事实上，上面的程序可以和数据库结合起来，比如把审核结果存放在数据库里面，也可以把审核的步骤也放到数据库里面，每次运行的时候从数据库里面获取这些值，然后来判断是创建哪一个状态处理类，然后执行相应的处理就可以了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在这些东西都在内存里，所以程序不能停止，否则流程就运行不下去了。</p>
<p>另外，为了演示的简洁性，这里做了相当的简化，比如没有去根据申请人选择相应的项目经理和部门经理，也没有去考虑如果申请人就是项目经理或者部门经理怎么办，只是为了让大家看明白状态模式在这里面的应用，主要是为了体现状态模式而不是业务。</p>
<h2 id="状态模式的优缺点"><a href="#状态模式的优缺点" class="headerlink" title="状态模式的优缺点"></a>状态模式的优缺点</h2><h3 id="简化应用逻辑控制"><a href="#简化应用逻辑控制" class="headerlink" title="简化应用逻辑控制"></a>简化应用逻辑控制</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式使用单独的类来封装一个状态的处理。如果把一个大的程序控制分成很多小块，每块定义一个状态来代表，那么就可以把这些逻辑控制的代码分散到很多单独的状态类当中去，这样就把着眼点从执行状态提高到整个对象的状态，使得代码结构化和意图更清晰，从而简化应用的逻辑控制。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于依赖于状态的<code>if-else</code>，理论上来讲，也可以改变成应用状态模式来实现，把每个<code>if或else</code>块定义一个状态来代表，那么就可以把块内的功能代码移动到状态处理类去了，从而减少<code>if-else</code>，避免出现巨大的条件语句。</p>
<h3 id="更好的分离状态和行为"><a href="#更好的分离状态和行为" class="headerlink" title="更好的分离状态和行为"></a>更好的分离状态和行为</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式通过设置所有状态类的公共接口，把状态和状态对应的行为分离开来，把所有与一个特定的状态相关的行为都放入一个对象中，使得应用程序在控制的时候，只需要关心状态的切换，而不用关心这个状态对应的真正处理。</p>
<h3 id="更好的扩展性"><a href="#更好的扩展性" class="headerlink" title="更好的扩展性"></a>更好的扩展性</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;引入了状态处理的公共接口后，使得扩展新的状态变得非常容易，只需要新增加一个实现状态处理的公共接口的实现类，然后在进行状态维护的地方，设置状态变化到这个新的状态即可。</p>
<h3 id="显式化进行状态转换"><a href="#显式化进行状态转换" class="headerlink" title="显式化进行状态转换"></a>显式化进行状态转换</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式为不同的状态引入独立的对象，使得状态的转换变得更加明确。而且状态对象可以保证上下文不会发生内部状态不一致的情况，因为上下文中只有一个变量来记录状态对象，只要为这一个变量赋值就可以了。</p>
<h3 id="引入太多的状态类"><a href="#引入太多的状态类" class="headerlink" title="引入太多的状态类"></a>引入太多的状态类</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式也有一个很明显的缺点，一个状态对应一个状态处理类，会使得程序引入太多的状态类，使程序变得杂乱。</p>
<h2 id="思考状态模式"><a href="#思考状态模式" class="headerlink" title="思考状态模式"></a>思考状态模式</h2><h3 id="状态模式的本质"><a href="#状态模式的本质" class="headerlink" title="状态模式的本质"></a>状态模式的本质</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;状态模式的本质：<strong>根据状态来分离和选择行为</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;仔细分析状态模式的结构，如果没有上下文，那么就退化回到只有接口和实现了，正是通过接口，把状态和状态对应的行为分开，才使得通过状态模式设计的程序易于扩展和维护。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而<strong>上下文主要负责的是公共的状态驱动，每当状态发生改变的时候，通常都是回调上下文来执行状态对应的功能</strong>。当然，上下文自身也可以维护状态的变化，另外，上下文通常还会作为多个状态处理类之间的数据载体，在多个状态处理类之间传递数据。</p>
<h3 id="何时选用状态模式"><a href="#何时选用状态模式" class="headerlink" title="何时选用状态模式"></a>何时选用状态模式</h3><p>建议在如下情况中，选用状态模式：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如果一个对象的行为取决于它的状态，而且它必须在运行时刻根据状态来改变它的行为</strong>。可以使用状态模式，来把状态和行为分离开，虽然分离开了，但状态和行为是有对应关系的，可以在运行期间，通过改变状态，就能够调用到该状态对应的状态处理对象上去，从而改变对象的行为。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如果一个操作中含有庞大的多分支语句，而且这些分支依赖于该对象的状态</strong>。可以使用状态模式，把各个分支的处理分散包装到单独的对象处理类里面，这样，这些分支对应的对象就可以不依赖于其它对象而独立变化了。</p>
<h2 id="相关模式"><a href="#相关模式" class="headerlink" title="相关模式"></a>相关模式</h2><h3 id="状态模式和观察者模式"><a href="#状态模式和观察者模式" class="headerlink" title="状态模式和观察者模式"></a>状态模式和观察者模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个模式乍一看，功能是很相似的，但是又有区别，可以组合使用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个模式都是在状态发生改变的时候触发行为，只不过<strong>观察者模式的行为是固定的，那就是通知所有的观察者，而状态模式是根据状态来选择不同的处理</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从表面来看，两个模式功能相似，观察者模式中的被观察对象就好比状态模式中的上下文，观察者模式中当被观察对象的状态发生改变的时候，触发的通知所有观察者的方法；就好比是状态模式中，根据状态的变化，选择对应的状态处理。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但实际这两个模式是不同的，观察者模式的目的是在被观察者的状态发生改变的时候，触发观察者联动，具体如何处理观察者模式不管；而状态模式的主要目的在于根据状态来分离和选择行为，当状态发生改变的时候，动态改变行为。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个模式是可以组合使用的，比如在观察者模式的观察者部分，当被观察对象的状态发生了改变，触发通知了所有的观察者过后，<strong>观察者该怎么处理呢？这个时候就可以使用状态模式，根据通知过来的状态选择相应的处理</strong>。</p>
<h3 id="状态模式和单例模式"><a href="#状态模式和单例模式" class="headerlink" title="状态模式和单例模式"></a>状态模式和单例模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个模式可以组合使用，可以<strong>把状态模式中的状态处理类实现成单例</strong>。</p>
<h3 id="状态模式和享元模式"><a href="#状态模式和享元模式" class="headerlink" title="状态模式和享元模式"></a>状态模式和享元模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个模式可以组合使用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于状态模式把状态对应的行为分散到多个状态对象中，会造成很多细粒度的状态对象，可以把这些<strong>状态处理对象通过享元模式来共享</strong>，从而节省资源。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/设计模式/" rel="tag"># 设计模式</a>
          
            <a href="/tags/状态模式/" rel="tag"># 状态模式</a>
          
            <a href="/tags/设计模式应用/" rel="tag"># 设计模式应用</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/05/19/grep的高级用法-统计单词出现次数/" rel="next" title="grep的高级用法-统计单词出现次数">
                <i class="fa fa-chevron-left"></i> grep的高级用法-统计单词出现次数
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/19/迭代器模式应用分析/" rel="prev" title="迭代器模式应用分析">
                迭代器模式应用分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#状态模式在在线投票系统以及工作流的应用"><span class="nav-number">1.</span> <span class="nav-text">状态模式在在线投票系统以及工作流的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#在线投票场景问题"><span class="nav-number">1.1.</span> <span class="nav-text">在线投票场景问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过程式代码实现"><span class="nav-number">1.2.</span> <span class="nav-text">过程式代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#有何问题"><span class="nav-number">1.2.1.</span> <span class="nav-text">有何问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案"><span class="nav-number">1.2.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态模式介绍"><span class="nav-number">1.3.</span> <span class="nav-text">状态模式介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式定义"><span class="nav-number">1.3.1.</span> <span class="nav-text">状态模式定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用状态模式来解决的思路"><span class="nav-number">1.3.2.</span> <span class="nav-text">应用状态模式来解决的思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模式结构和说明"><span class="nav-number">1.3.3.</span> <span class="nav-text">模式结构和说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式示例代码"><span class="nav-number">1.3.4.</span> <span class="nav-text">状态模式示例代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用状态模式重写示例"><span class="nav-number">1.4.</span> <span class="nav-text">使用状态模式重写示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#认识状态模式"><span class="nav-number">1.5.</span> <span class="nav-text">认识状态模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#状态和行为"><span class="nav-number">1.5.1.</span> <span class="nav-text">状态和行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#行为的平行性"><span class="nav-number">1.5.2.</span> <span class="nav-text">行为的平行性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文和状态处理对象"><span class="nav-number">1.5.3.</span> <span class="nav-text">上下文和状态处理对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不完美的OCP体验"><span class="nav-number">1.5.4.</span> <span class="nav-text">不完美的OCP体验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建和销毁状态对象"><span class="nav-number">1.5.5.</span> <span class="nav-text">创建和销毁状态对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式的调用顺序示意图"><span class="nav-number">1.5.6.</span> <span class="nav-text">状态模式的调用顺序示意图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态的维护和转换控制"><span class="nav-number">1.5.7.</span> <span class="nav-text">状态的维护和转换控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用数据库来维护状态"><span class="nav-number">1.5.8.</span> <span class="nav-text">使用数据库来维护状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟工作流"><span class="nav-number">1.6.</span> <span class="nav-text">模拟工作流</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态模式的优缺点"><span class="nav-number">1.7.</span> <span class="nav-text">状态模式的优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简化应用逻辑控制"><span class="nav-number">1.7.1.</span> <span class="nav-text">简化应用逻辑控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更好的分离状态和行为"><span class="nav-number">1.7.2.</span> <span class="nav-text">更好的分离状态和行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更好的扩展性"><span class="nav-number">1.7.3.</span> <span class="nav-text">更好的扩展性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显式化进行状态转换"><span class="nav-number">1.7.4.</span> <span class="nav-text">显式化进行状态转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引入太多的状态类"><span class="nav-number">1.7.5.</span> <span class="nav-text">引入太多的状态类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思考状态模式"><span class="nav-number">1.8.</span> <span class="nav-text">思考状态模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式的本质"><span class="nav-number">1.8.1.</span> <span class="nav-text">状态模式的本质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#何时选用状态模式"><span class="nav-number">1.8.2.</span> <span class="nav-text">何时选用状态模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#相关模式"><span class="nav-number">1.9.</span> <span class="nav-text">相关模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式和观察者模式"><span class="nav-number">1.9.1.</span> <span class="nav-text">状态模式和观察者模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式和单例模式"><span class="nav-number">1.9.2.</span> <span class="nav-text">状态模式和单例模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态模式和享元模式"><span class="nav-number">1.9.3.</span> <span class="nav-text">状态模式和享元模式</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
