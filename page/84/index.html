<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/84/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/84/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/08/linux资源限制配置文件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/08/linux资源限制配置文件/" itemprop="url">linux资源限制配置文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-08T12:12:57+08:00">
                2019-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/bash/" itemprop="url" rel="index">
                    <span itemprop="name">bash</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/bash/文件描述符/" itemprop="url" rel="index">
                    <span itemprop="name">文件描述符</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="linux资源限制配置文件-etc-security-limits-conf-文件描述符"><a href="#linux资源限制配置文件-etc-security-limits-conf-文件描述符" class="headerlink" title="linux资源限制配置文件/etc/security/limits.conf 文件描述符"></a>linux资源限制配置文件/etc/security/limits.conf 文件描述符</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://blog.csdn.net/fanren224/article/details/79971359" target="_blank" rel="noopener">https://blog.csdn.net/fanren224/article/details/79971359</a></p>
</blockquote>
<h2 id="文件描述符是什么？和文件句柄有啥区别？"><a href="#文件描述符是什么？和文件句柄有啥区别？" class="headerlink" title="文件描述符是什么？和文件句柄有啥区别？"></a>文件描述符是什么？和文件句柄有啥区别？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;文件描述符是<code>linux/unix</code>操作系统中特有的概念。相当于<code>windows</code>系统中的文件句柄。一个意思不同叫法。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Linux系统中， 每当进程打开一个文件时，系统就为其分配一个唯一的整型文件描述符，用来标识这个文件。标准C中每个进程默认打开的有三个文件，标准输入，标准输出，标准错误，分别用一个FILE结构的指针来表示，即stdin，stout，sterr，这三个结构分别对应着三个文件描述符0,1,2。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>文件描述符是一个简单的整数，用以标明每一个被进程所打开的文件和socket</strong>。第一个打开的文件是0，第二个是1，依此类推。<strong>linux 操作系统通常对每个进程能打开的文件数量有一个限制</strong>。</p>
<h2 id="linux系统对文件描述符的限制有两个级别"><a href="#linux系统对文件描述符的限制有两个级别" class="headerlink" title="linux系统对文件描述符的限制有两个级别"></a>linux系统对文件描述符的限制有两个级别</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;系统级别，使用<code>cat /proc/sys/fs/file-max</code>查看，默认值是根据内存大小，系统自动设置的，一般为内存大小（KB）的10%，shell下可以这样计算<code>grep -r MemTotal /proc/meminfo | awk &#39;{printf(&quot;%d&quot;,$2/10)}&#39;</code>（可能有各种其他原因导致file-max没有设置为内存的10%）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;进程级别（也叫用户级别），默认是1024，使用<code>ulimit -n</code>查看</p>
<h2 id="为什么要限制打开的文件描述符？"><a href="#为什么要限制打开的文件描述符？" class="headerlink" title="为什么要限制打开的文件描述符？"></a>为什么要限制打开的文件描述符？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;原因1 – <strong>资源问题</strong>：每个打开的文件都需要消耗内存来管理，而内存是有限的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;原因2 –<strong>安全问题</strong>：如果不限制的话，有不怀好心的人启动一个进程来无限的创建和打开新的文件，会让服务器崩溃。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;所以限制文件描述符的数量对于linux系统的稳定性是非常重要的。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;限制资源使用的配置文件是 <code>/etc/security/limits.conf</code>，和<code>/etc/security/limits.d/目录</code>，<strong><code>/etc/security/limits.d/</code>里面配置会覆盖<code>/etc/security/limits.conf</code>的配置</strong></p>
<p>可以限制的资源类型如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">所创建的内核文件的大小</span><br><span class="line">进程数据块的大小</span><br><span class="line">Shell 进程创建文件的大小</span><br><span class="line">内存锁住的大小</span><br><span class="line">常驻内存集的大小</span><br><span class="line">打开文件描述符的数量</span><br><span class="line">分配堆栈的最大大小</span><br><span class="line">CPU 时间</span><br><span class="line">单个用户的最大线程数</span><br><span class="line">Shell 进程所能使用的最大虚拟内存</span><br></pre></td></tr></table></figure>
<ol>
<li><strong>hard和soft的区别： soft是一个警告值，而hard则是一个真正意义的阀值，超过就会报错，一般情况下都是设为同一个值</strong>。</li>
<li>第一列表示用户和组（@开头）。第二列表示软限制还是硬限制，第三列表示限制的资源类型，第四列表示限制的最大值</li>
<li>core是内核文件，<strong>nofile是文件描述符，noproc是进程，一般情况下只限制文件描述符数和进程数就够了</strong></li>
</ol>
<h2 id="系统级别"><a href="#系统级别" class="headerlink" title="系统级别"></a>系统级别</h2><h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/sys/fs/file-max</span><br><span class="line">186405</span><br></pre></td></tr></table></figure>
<h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><h4 id="临时性"><a href="#临时性" class="headerlink" title="临时性"></a>临时性</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1000000 &gt; /proc/sys/fs/file-max</span><br></pre></td></tr></table></figure>
<h4 id="永久性"><a href="#永久性" class="headerlink" title="永久性"></a>永久性</h4><p>在/etc/sysctl.conf中设置，应该设什么值是最佳实践？比如8G的内存，设为8192/2 * 256 = 524288</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.file-max = 1000000</span><br></pre></td></tr></table></figure>
<h2 id="进程级别"><a href="#进程级别" class="headerlink" title="进程级别"></a>进程级别</h2><h3 id="查看-1"><a href="#查看-1" class="headerlink" title="查看"></a>查看</h3><p>-n默认查看的是<code>soft limit</code>，这个值是从<code>/etc/security/limits.conf</code>文件的<code>* soft nofile 655350</code>来的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ulimit</span> -n</span><br><span class="line">170000</span><br></pre></td></tr></table></figure>
<p>查看hard limit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ulimit</span> -Hn</span><br><span class="line">170000</span><br></pre></td></tr></table></figure>
<h3 id="设置-1"><a href="#设置-1" class="headerlink" title="设置"></a>设置</h3><p>临时性：</p>
<p>通过<code>ulimit -Sn</code>设置最<code>soft limit</code>，注意soft limit必须小于hard limit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -Sn 160000</span><br></pre></td></tr></table></figure>
<p>通过<code>ulimit -Hn</code>设置最<code>Hard limit</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ulimit -Hn 160000</span><br></pre></td></tr></table></figure>
<p>同时设置<code>soft limit</code>和<code>hard limit</code>。对于非root用户只能设置比原来小的hard limit。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 180000</span><br></pre></td></tr></table></figure>
<p>永久性：</p>
<p>root权限下，在<code>/etc/security/limits.conf</code>中添加如下两行，*表示所有用户，重启生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 102400</span><br><span class="line"></span><br><span class="line">* hard nofile 104800</span><br></pre></td></tr></table></figure>
<p>注意：设置nofile的<code>hard limit</code>还有一点要注意的就是<strong><code>hard limit</code>不能大于<code>/proc/sys/fs/nr_open</code></strong>，假如<code>hard limit</code>大于<code>nr_open</code>，注销后将无法正常登录。</p>
<h2 id="查看系统当前打开的文件描述符数量"><a href="#查看系统当前打开的文件描述符数量" class="headerlink" title="查看系统当前打开的文件描述符数量"></a>查看系统当前打开的文件描述符数量</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;其中第一个数表示当前系统分配后已使用的文件描述符数，<strong>第二个数表示分配后未使用的</strong>（内核2.6版本中这个值总是为0，这并不是一个错误，它意味着已经分配的文件描述符总会被使用），第三个数等于file-max。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cat /proc/sys/fs/file-nr </span><br><span class="line">2176	0	2048000</span><br></pre></td></tr></table></figure>
<p><strong>已使用 =  第一个数 - 第二个数</strong></p>
<h2 id="查看某个进程打开的文件描述符数量"><a href="#查看某个进程打开的文件描述符数量" class="headerlink" title="查看某个进程打开的文件描述符数量"></a>查看某个进程打开的文件描述符数量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lsof -p 20262 |wc -l</span><br><span class="line">5</span><br></pre></td></tr></table></figure>
<h2 id="根据用户创建的进程数排序"><a href="#根据用户创建的进程数排序" class="headerlink" title="根据用户创建的进程数排序"></a>根据用户创建的进程数排序</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps h -Led -o user | sort | uniq -c | sort -n</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  1 chrony</span><br><span class="line">  1 dbus</span><br><span class="line">  1 hanli</span><br><span class="line">  1 hanli2</span><br><span class="line">  1 nginx</span><br><span class="line">  2 postfix</span><br><span class="line">  4 named</span><br><span class="line">  4 puppet</span><br><span class="line">  6 polkitd</span><br><span class="line">  6 redis</span><br><span class="line"> 21 mysql</span><br><span class="line">125 root1</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><code>/proc/sys/fs/file-max</code>限制不了<code>/etc/security/limits.conf</code></li>
<li>只有root用户才有权限修改<code>/etc/security/limits.conf</code></li>
<li>对于非root用户， <code>/etc/security/limits.conf</code>会限制<code>ulimit -n</code>，但是限制不了root用户</li>
<li>对于非root用户，<code>ulimit -n</code>只能越设置越小，root用户则无限制</li>
<li>任何用户对<code>ulimit -n</code>的修改只在当前环境有效，退出后失效，重新登录新来后，<code>ulimit -n</code>由<code>limits.conf</code>决定</li>
<li>如果<code>limits.conf</code>没有做设定，则默认值是1024</li>
<li>当前环境的用户所有进程能打开的最大文件数量由<code>ulimit -n</code>决定</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/07/TraceId 和 SpanId 生成规则/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/07/TraceId 和 SpanId 生成规则/" itemprop="url">TraceId 和 SpanId 生成规则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:57+08:00">
                2019-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/分布式链路追踪/" itemprop="url" rel="index">
                    <span itemprop="name">分布式链路追踪</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="TraceId-和-SpanId-生成规则"><a href="#TraceId-和-SpanId-生成规则" class="headerlink" title="TraceId 和 SpanId 生成规则"></a>TraceId 和 SpanId 生成规则</h1><blockquote>
<p>原文地址：<a href="https://www.sofastack.tech/sofa-tracer/docs/TraceIdGeneratedRule" target="_blank" rel="noopener">https://www.sofastack.tech/sofa-tracer/docs/TraceIdGeneratedRule</a></p>
</blockquote>
<h2 id="TraceId-生成规则"><a href="#TraceId-生成规则" class="headerlink" title="TraceId 生成规则"></a>TraceId 生成规则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>SOFATracer</code> 通过 TraceId 来将一个请求在各个服务器上的调用日志串联起来，<strong>TraceId 一般由接收请求经过的第一个服务器产生</strong>，产生规则是： <strong>服务器 IP + 产生 ID 时候的时间 + 自增序列 + 当前进程号</strong> ，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0ad1348f1403169275002100356696</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前 8 位 <code>0ad1348f</code> 即产生 <code>TraceId</code> 的机器的 IP，这是一个十六进制的数字，每两位代表 IP 中的一段，我们把这个数字，按每两位转成 10 进制即可得到常见的 IP 地址表示方式 <code>10.209.52.143</code>，大家也可以根据这个规律来查找到请求经过的第一个服务器。 后面的 13 位 <code>1403169275002</code> 是产生 TraceId 的时间。 之后的 4 位 <code>1003</code> 是一个自增的序列，从 1000 涨到 9000，到达 9000 后回到 1000 再开始往上涨。 最后的 5 位 <code>56696</code> 是当前的进程 ID，<strong>为了防止单机多进程出现 TraceId 冲突的情况，所以在 TraceId 末尾添加了当前的进程 ID</strong>。</p>
<blockquote>
<p>TraceId 目前的生成的规则参考了阿里的鹰眼组件。</p>
</blockquote>
<h2 id="SpanId-生成规则"><a href="#SpanId-生成规则" class="headerlink" title="SpanId 生成规则"></a>SpanId 生成规则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>SOFATracer</code> 中的 SpanId 代表本次调用在整个调用链路树中的位置，假设一个 Web 系统 A 接收了一次用户请求，那么在这个系统的 SOFATracer MVC 日志中，<strong>记录下的 SpanId 是 0，代表是整个调用的根节点</strong>，如果 A 系统处理这次请求，需要通过 RPC 依次调用 B，C，D 三个系统，那么在 A 系统的 SOFATracer RPC 客户端日志中，SpanId 分别是 0.1，0.2 和 0.3，在 B，C，D 三个系统的 SOFATracer RPC 服务端日志中，SpanId 也分别是 0.1，0.2 和 0.3；如果 C 系统在处理请求的时候又调用了 E，F 两个系统，那么 C 系统中对应的 SOFATracer RPC 客户端日志是 0.2.1 和 0.2.2，E，F 两个系统对应的 SOFATracer RPC 服务端日志也是 0.2.1 和 0.2.2。根据上面的描述，我们可以知道，如果把一次调用中所有的 SpanId 收集起来，可以组成一棵完整的链路树。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们假设一次分布式调用中产生的 TraceId 是 <code>0a1234</code>（实际不会这么短），那么根据上文 SpanId 的产生过程，有下图：</p>
<p><img src="//blog.com/2019/05/07/TraceId 和 SpanId 生成规则/A_qo08QLrjv-QAAAAAAAAAAABjARQnAQ.png" alt="traceId"></p>
<blockquote>
<p>SpanId 目前的生成的规则参考了阿里的鹰眼组件。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/07/mysql  date和datetime、timestamp在使用between  and时的坑/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/07/mysql  date和datetime、timestamp在使用between  and时的坑/" itemprop="url">mysql  date和datetime、timestamp在使用between  and时的坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:57+08:00">
                2019-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mysql-date和datetime、timestamp在使用between-and时的坑"><a href="#mysql-date和datetime、timestamp在使用between-and时的坑" class="headerlink" title="mysql  date和datetime、timestamp在使用between  and时的坑"></a>mysql  date和datetime、timestamp在使用between  and时的坑</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>mysql</code>的<code>between and</code>语法是包括左右边界的。但是查询时注意日期类型 <code>date</code>和 <code>datetime</code> ,<code>TIMESTAMP</code>是有一些不一样。</p>
<h2 id="date"><a href="#date" class="headerlink" title="date"></a>date</h2><p><strong>包括左右边界</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test_time` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `m_time` date DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (1, &apos;2019-05-07&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (2, &apos;2019-05-07&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (3, &apos;2019-05-06&apos;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time between &apos;2019-05-01&apos; and &apos;2019-05-07&apos;;</span><br><span class="line">+----+------------+</span><br><span class="line">| id | m_time     |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | 2019-05-07 |</span><br><span class="line">|  2 | 2019-05-07 |</span><br><span class="line">|  3 | 2019-05-06 |</span><br><span class="line">|  4 | 2019-05-01 |</span><br><span class="line">+----+------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time &gt;= &apos;2019-05-01&apos; and m_time &lt;= &apos;2019-05-07&apos;;</span><br><span class="line">+----+------------+</span><br><span class="line">| id | m_time     |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | 2019-05-07 |</span><br><span class="line">|  2 | 2019-05-07 |</span><br><span class="line">|  3 | 2019-05-06 |</span><br><span class="line">+----+------------+</span><br></pre></td></tr></table></figure>
<h2 id="datetime"><a href="#datetime" class="headerlink" title="datetime"></a>datetime</h2><p><strong><code>datetime</code>在仅仅指定年月日时，不会包含结束的右边界</strong>。</p>
<p><strong><code>datetime</code>在指定年月日 时分秒时，会包含左右边界</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test_time` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `m_time` datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (1, &apos;2019-05-07 00:00:00&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (2, &apos;2019-05-07 12:00:00&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (3, &apos;2019-05-06 22:30:01&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (4, &apos;2019-05-21 00:00:03&apos;);</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time between &apos;2019-05-06&apos; and &apos;2019-05-07&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time &gt;= &apos;2019-05-06&apos; and m_time &lt;= &apos;2019-05-07&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time between &apos;2019-05-06 00:00:00&apos; and &apos;2019-05-07 23:59:59&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  2 | 2019-05-07 12:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time &gt;= &apos;2019-05-06 00:00:00&apos; and m_time &lt;= &apos;2019-05-07 23:59:59&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  2 | 2019-05-07 12:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br></pre></td></tr></table></figure>
<h2 id="timestamp"><a href="#timestamp" class="headerlink" title="timestamp"></a>timestamp</h2><p><strong><code>timestamp</code>在仅仅指定年月日时，不会包含结束的右边界</strong>。</p>
<p><strong><code>timestamp</code>在指定年月日 时分秒时，会包含左右边界</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test_time` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `m_time` timestamp NULL DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (1, &apos;2019-05-07 00:00:00&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (2, &apos;2019-05-07 12:00:00&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (3, &apos;2019-05-06 22:30:01&apos;);</span><br><span class="line">INSERT INTO `test_time`(`id`, `m_time`) VALUES (4, &apos;2019-05-21 00:00:03&apos;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time between &apos;2019-05-06&apos; and &apos;2019-05-07&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time &gt;= &apos;2019-05-06&apos; and m_time &lt;= &apos;2019-05-07&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time between &apos;2019-05-06 00:00:00&apos; and &apos;2019-05-07 23:59:59&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  2 | 2019-05-07 12:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM `test_time` where m_time &gt;= &apos;2019-05-06 00:00:00&apos; and m_time &lt;= &apos;2019-05-07 23:59:59&apos;;</span><br><span class="line">+----+-------------------+</span><br><span class="line">| id | m_time            |</span><br><span class="line">+----+-------------------+</span><br><span class="line">|  1 | 2019-05-07 00:00:00 |</span><br><span class="line">|  2 | 2019-05-07 12:00:00 |</span><br><span class="line">|  3 | 2019-05-06 22:30:01 |</span><br><span class="line">+----+-------------------+</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/07/分布式集群环境下调用链路追踪/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/07/分布式集群环境下调用链路追踪/" itemprop="url">分布式集群环境下调用链路追踪</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:57+08:00">
                2019-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/分布式链路追踪/" itemprop="url" rel="index">
                    <span itemprop="name">分布式链路追踪</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/分布式链路追踪/日志处理/" itemprop="url" rel="index">
                    <span itemprop="name">日志处理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分布式集群环境下调用链路追踪"><a href="#分布式集群环境下调用链路追踪" class="headerlink" title="分布式集群环境下调用链路追踪"></a>分布式集群环境下调用链路追踪</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html</a></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现代微服务系统中，一套复杂的分布式 Web 系统中，客户端的一次请求操作，可能需要经过系统中多个模块、多个中间件、多台机器的相互协作才能完成，并且这一系列调用请求中，有些是串行处理的，有些是并发执行的，那么如何确定客户端的一次操作背后调用了哪些应用、哪些模块，经过了哪些节点，每个模块的调用先后顺序是怎样的，每个模块的性能问题如何？随着业务系统模型的日趋复杂化，分布式系统中急需一套链路追踪（Trace）系统来解决这些痛点。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式服务跟踪是整个分布式系统中跟踪一个用户请求的过程，包括数据采集、数据传输、数据存储、数据分析和数据可视化，捕获此类跟踪让我们构建用户交互背后的整个调用链的视图，这是调试和监控微服务的关键工具。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Google Dapper 就是这样需求下的一套应用于大型分布式系统环境下的链路追踪系统。借助 Dapper 理念，系统开发人员只需将 Trace 组件嵌入到基础通用库中，就可以正常运行，而应用层开发者则不需要关心具体 Trace 组件实现、集成方式，达到以应用层透明的方式嵌入各个模块的目的。</p>
<h2 id="Google-Dapper-简介"><a href="#Google-Dapper-简介" class="headerlink" title="Google Dapper 简介"></a>Google Dapper 简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Google Dapper 这一分布式跟踪系统，最初只是作为一个自给自足的监控工具起步的，但最终进化成一个监控平台，并且促生出多种多样的甚至已经不是由 Dapper 团队开发的监控工具，说明分布式追踪系统在当前的分布式环境下是必不可少的工具。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现代互联网服务通常实现为复杂的大规模系统，比如采用流行的微服务架构模式。应用是由一组服务组合起来的，这些服务可能是由不同的团队开发的，而且可能采用不同的编程语言。像 Google 这种级别的公司，应用会跨越多个基础设施的上千台机器，即便是相对较小的云计算用例，推荐的做法也是使用跨地域的 Availability Zone 和 Region 运行服务的多个版本。在这种复杂的系统环境中，分布式追踪系统能够辅助我们理解系统的行为、帮助调试和排查性能问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Google 最初开发 Dapper 为了收集更多的复杂分布式系统的行为信息，然后呈现给 Google 的开发者们。这样的分布式系统因那些大规模的低端服务器作为互联网服务的载体，是一个特殊的经济划算的平台。想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从众多的分布式系统应用中得出的经验，对于分布式追踪系统需要满足至少两点要求：涵盖面的广度和持续的监控。涵盖广度的重要性不言而喻，因为在使用追踪系统的进行监控时，如果有一小部分没被监控到，那么人们对这个系统是不是值得信任都会产生巨大的质疑。另外，监控应该是 7x24 小时的，毕竟，系统异常或是那些重要的系统行为有可能出现过一次，就很难甚至不太可能重现。那么，根据这两个明确的需求，可以推出如下几个具体的设计目标：</p>
<ol>
<li>低性能损耗 (Low overhead)：分布式在线系统对于性能、资源要求都很严格，Trace 组件必须对服务影响足够小。对于一些高度优化过的服务，即使一点点性能损耗也会很容易察觉到，而且有可能迫使在线服务的部署团队不得不将分布式追踪系统关停。</li>
<li>应用级的透明 (Application-level transparency)：应用层开发者不需要对 Trace 组件关心，Trace 嵌入到基础通用库中，提供高稳定性，而如果 Trace 需要应用开发者配合，那可能会引入额外的 bug 导致 Trace 系统更加脆弱。面对当下互联网公司快速迭代的开发环境来说，这一点尤其重要。</li>
<li>扩展性 (Scalability)：Google 的服务在线集群数量可想而知，一次检索就可能跨越上百台甚至成千台机器，因此这个 Trace Infrastructure 的扩展性也很重要。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，以上几点设计目标的背后，还有一个额外的设计目标就是追踪数据产生之后，能够快速导出数据，快速进行数据分析，在最短的时间内定位系统异常，理想情况是数据存入跟踪仓库后一分钟内就能统计出来。尽管跟踪系统对一小时前的旧数据进行统计也是相当有价值的，但如果跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外，要做到真正的应用级别的透明（这应该是当下面临的最挑战性的设计目标），我们需要把核心跟踪代码做的很轻巧，然后把它植入到那些无所不在的公共组件中，比如线程调用、控制流以及 RPC 库。使用自适应的采样率可以使跟踪系统变得可伸缩，并降低性能损耗。结果展示的相关系统也需要包含一些用来收集跟踪数据的代码，用来图形化的工具，以及用来分析大规模跟踪数据的库和 API。虽然单独使用 Dapper 有时就足够让开发人员查明异常的来源，但是 Dapper 的初衷不是要取代所有其他监控的工具。Dapper 的数据往往侧重性能方面的调查，其他监控工具也有他们各自的用处。</p>
<h2 id="基于-Google-Dapper-的分布式追踪介绍"><a href="#基于-Google-Dapper-的分布式追踪介绍" class="headerlink" title="基于 Google Dapper 的分布式追踪介绍"></a>基于 Google Dapper 的分布式追踪介绍</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们进行微服务架构开发时，通常会根据业务或功能划分成若干个不同的微服务模块，各模块之间通过 REST/RPC 等协议进行调用。一个用户在前端发起某种操作，可能需要很多微服务的协同才能完成，如果在业务调用链路上任何一个微服务出现问题或者网络超时，将导致功能失效，或出现某些模块在调用链中耗时突然增大等问题。随着业务越来越复杂，微服务架构横向、纵向扩展之后，其规模越来越大，对于微服务之间的调用链路的分析将会越来越复杂。此时你会发现，如果在最初架构设计时，能够将分布式链路追踪这种需求考虑进来，后期微服务集群扩容时候，前期所做的工作将会达到事半功倍的效果。</p>
<p>下面先来看看 Google Dapper 论文里面介绍的一个非常简单、常见的一个场景：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image001.png" alt=""></p>
<p><em>引用自文章 “Dapper, a Large-Scale Distributed Systems Tracing Infrastructure” 中的 Figure 1</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;图 1 中 A~E 分别表示五个服务，用户发起一次 X 请求到前端系统 A，然后 A 分别发送 RPC 请求到中间层 B 和 C，B 处理请求后返回，C 还要发起两个 RPC 请求到后端系统 D 和 E。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上完整调用回路中，一次请求需要经过多个系统处理完成，并且追踪系统像是内嵌在 RPC 调用链上的树形结构，然而，我们的核心数据模型不只局限于特定的 RPC 框架，我们还能跟踪其他行为，例如外界的 HTTP 请求，和外部对 Kafka 服务器的调用等。从形式上看，分布式追踪模型使用的 Trace 树形结构来记录请求之间的关系（父子关系、先后顺序等）。</p>
<h3 id="Trace-和-Span"><a href="#Trace-和-Span" class="headerlink" title="Trace 和 Span"></a>Trace 和 Span</h3><p>Google Dapper 中关于 Trace 的介绍中主要有以下三个主要元素构成：</p>
<ol>
<li>Span：基本工作单元，例如，在一个新建的 Span 中发送一个 RPC 等同于发送一个回应请求给 RPC，Span 通过一个 64 位 ID 唯一标识，Trace 以另一个 64 位 ID 表示。Span 还有其他数据信息，比如摘要、时间戳事件、关键值注释 (Tags)、Span 的 ID、以及进度 ID (通常是 IP 地址)。Span 在不断地启动和停止，同时记录了时间信息，当你创建了一个 Span，你必须在未来的某个时刻停止它。</li>
<li>Trace 树：一系列 Span 组成的一个树状结构，例如，如果你正在跑一个分布式大数据工程，你可能需要创建一个 Trace 树。</li>
<li>Annotation（标注）：用来及时记录一个事件的存在，一些核心 Annotation 用来定义一个请求的开始和结束。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式追踪系统要做的就是记录每次发送和接受动作的标识符和时间戳，将一次请求涉及到的所有服务串联起来，只有这样才能清楚记录每次请求的完整调用链。在分布式追踪系统中使用 Trace 表示对一次请求完整调用链的跟踪，将两个服务例如上面图 1 中的服务 A 和服务 B 的请求/响应过程叫做一次 Span。 我们可以看出每一次跟踪 Trace 都是一个树型结构，Span 可以体现出服务之间的具体依赖关系。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于每个 Trace 树，Trace 都要定义一个全局唯一的 Trace ID，在这个跟踪中的所有 Span 都将获取到这个 Trace ID。 每个 Span 都有一个 Parent Span ID 和它自己的 Span ID。上面图 1 中 A 服务的 Parent Span ID 为空，Span ID 为 1；然后 B 服务的 Parent Span ID 为 1，Span ID 为 2；C 服务的 Parent Span ID 也为 1，Span ID 为 3，依次类推，如图 2 所示：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image002.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N10092" target="_blank" rel="noopener">点击查看大图</a></p>
<p><em>引用自文章 “Dapper, a Large-Scale Distributed Systems Tracing Infrastructure” 中的 Figure 2</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;追踪系统中用 Span 来表示一个服务调用的开始和结束时间，也就是时间区间。追踪系统记录了 Span 的名称以及每个 Span ID 的 Parent Span ID，如果一个 Span 没有 Parent Span ID 则被称为 Root Span，当前节点的 Parent Span ID 即为调用链路上游的 Span ID，所有的 Span 都挂在一个特定的追踪上，共用一个 Trace ID。</p>
<h3 id="Span-内部结构"><a href="#Span-内部结构" class="headerlink" title="Span 内部结构"></a>Span 内部结构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面看一下 Span 的内部结构，Span 除了记录 Parent Span ID 和自身的 Span ID 外，还会记录自己请求其他服务的时间和响应时间。但是每个服务器的时间可能不是完全相同，为了解决这个问题需要约定一个前提，即 RPC 客户端必须发出请求后，服务端才能收到，如果服务端的时间戳比客户端发出请求的时间戳还靠前，那么就按请求时间来算，响应时间也是如此。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;任何一个 Span 可以包含来自不同 Server 的信息，这些也要记录下来。事实上，每一个 RPC Span 可能包含客户端和服务器两个过程的 Annotation 内容。由于客户端和服务器上的时间戳来自不同的主机，我们必须考虑到 Server 之间的时间偏差。在链路追踪分析中，每一个请求，总是一方先发送一个请求之后，然后另外一方才接收到；这样一来，每个调用请求就有一个时间戳的上限和下限。</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image003.png" alt=""></p>
<p><em>引用自文章 “Dapper, a Large-Scale Distributed Systems Tracing Infrastructure” 中的 Figure 3</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从图 3 可以可以很清楚的看出，这是一次 Span 名为 <code>Hello.Call</code> 的调用，Span ID 是 5，Parent Span ID 是 3，Trace ID 是 100。 我们重点看一下 Span 对应的四个状态：</p>
<ul>
<li>Client Send（CS）：客户端发送时间，客户端发起一个请求，这个 Annotation 描述了这个 Span 的开始。</li>
<li>Server Received（SR）：服务端接收时间，服务端获得请求并准备开始处理它，如果将其 SR 减去 CS 时间戳便可得到网络延迟。</li>
<li>Server Send（SS）：服务端发送时间，Annotation 表明请求处理的完成（当请求返回客户端），如果 SS 减去 SR 时间戳便可得到服务端需要的处理请求时间。</li>
<li>Client Received（CR）：客户端接收时间，表明 Span 的结束，客户端成功接收到服务端的回复，如果 CR 减去 CS 时间戳便可得到客户端从服务端获取回复的所有所需时间。</li>
</ul>
<p>通过收集这四个时间戳，就可以在一次请求完成后计算出整个 Trace 的执行耗时和网络耗时，以及 Trace 中每个 Span 过程的执行耗时和网络耗时:</p>
<ul>
<li>服务调用耗时 = CR – CS</li>
<li>服务处理耗时 = SS – SR</li>
<li>网络耗时 = 服务调用耗时 – 服务处理耗时</li>
</ul>
<h3 id="生成-Span"><a href="#生成-Span" class="headerlink" title="生成 Span"></a>生成 Span</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们已经初步了解了 Span 的组成，那么怎么生成 Span 呢？Google Dapper 中使用到的是基于标注 (Annotation-based) 的监控方案。此方案会有代码侵入，所以应尽可能少改动代码。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于标注的方式就是根据请求中的 Trace ID 来获取 Trace 这个实例，各种编程语言有各自的方式。获取到 Trace 实例后就可以调用 Recorder 来记录 Span 了，记录值先直接以日志的形式存在本地，然后跟踪系统会启动一个 Collector Daemon 来收集日志，然后整理日志写入数据库。解析的日志结果建议放在 BigTable (Cassandra 或者 HDFS) 这类稀疏表的数据库里。因为每个 Trace 携带的 Span 可能不一样，最终的记录是每一行代表一个 Trace，这一行的每一列代表一个 Span，如图 4 所示：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image004.png" alt=""></p>
<p><em>引用自文章 “Dapper, a Large-Scale Distributed Systems Tracing Infrastructure” 中的 Figure 5</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于减少代码的侵入性，论文建议将核心跟踪代码做的很轻巧，然后把它植入公共组件中，比如线程调用、控制流以及 RPC 库。</p>
<h3 id="采样率"><a href="#采样率" class="headerlink" title="采样率"></a>采样率</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式跟踪系统的实现要求性能低损耗，尤其在生产环境中不能影响到核心业务的性能，也不可能每次请求都跟踪，所以要进行采样，每个应用和服务可以自己设置采样率。采样率应该是在每个应用自己的配置里设置的，这样每个应用可以动态调整，特别是刚应用刚上线时可以适当调高采样率。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般在系统峰值流量很大的情况下，只需要采样其中很小一部分请求，例如 1/1000 的采样率，即分布式跟踪系统只会在 1000 次请求中采样其中的某一次。</p>
<h3 id="Trace-收集"><a href="#Trace-收集" class="headerlink" title="Trace 收集"></a>Trace 收集</h3><p>分布式跟踪系统的追踪记录和收集管道的过程分为三个阶段：</p>
<ol>
<li>Span 数据写入本地日志文件中。</li>
<li>Dapper 的守护进程和收集组件把这些数据从生产环境的主机中拉出来。</li>
<li>最终写到 Dapper 的 Bigtable 仓库中。一次跟踪被设计成 Bigtable 中的一行，每一列相当于一个 Span。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Bigtable 的支持稀疏表格布局正适合这种情况，因为每一次追踪请求可能产生多个 Span。写入数据后的 Bigtable，每一条记录集表示一条 Trace 记录。这些监控数据的汇总是单独进行的，而不是伴随系统对用户的应答一起返回的。如此选择主要有如下的两个原因：</p>
<ul>
<li><p>首先，一个内置的汇总方案 (监控数据随 RPC 应答头返回）会影响网络动态。一般来说，RPC 应答数据规模比较小，通常不超过 10KB。而区间数据往往非常庞大，如果将二者放在一起传输，会使这些 RPC 应答数据相对”矮化”进而影响后期的分析。</p>
</li>
<li><p>另一方面，内置的汇总方案需要保证所有的 RPC 都是完全嵌套的，但有许多的中间件系统在其所有的后台返回最终结果之前就对调用者返回结果，这样有些监控信息就无法被收集。</p>
</li>
</ul>
<p>基于这两个考虑，最终选择将监控数据和应答信息分开传输。</p>
<h2 id="Java-下-Trace-介绍以及实践"><a href="#Java-下-Trace-介绍以及实践" class="headerlink" title="Java 下 Trace 介绍以及实践"></a>Java 下 Trace 介绍以及实践</h2><h3 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h3><p>分布式追踪系统一般主要由两方面构成：即基于 Annotation 的标注和追踪系统框架。对应 Java 中主要有下面两个工具：</p>
<ul>
<li><p>Brave：用来装备 Java 程序的类库，提供了面向 Standard Servlet、Spring MVC、HTTP Client、JAX RS、Jersey、Resteasy 和 MySQL 等接口的装备能力，可以通过编写简单的配置和代码，让基于这些框架构建的应用可以向 Zipkin 报告数据。同时 Brave 也提供了非常简单且标准化的接口，在以上封装无法满足要求的时候可以方便扩展与定制。</p>
</li>
<li><p>Zipkin：是一款开源的分布式实时数据追踪系统（Distributed Tracking System），基于 Google Dapper 的论文设计而来，由 Twitter 公司开发贡献。其主要功能是聚集来自各个异构系统的实时监控数据，用来追踪微服务架构下的系统延时问题。</p>
</li>
</ul>
<p>两种工具在追踪系统中的用途如下：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image005.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N1012E" target="_blank" rel="noopener">点击查看大图</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由上图可见，一次请求过程中，请求先通过 HTTP 到达前端，然后通过 HTTP 调用后台系统，同时后台系统通过 RPC 调用 Greeting 模块，每一个 Span 对应的 Annotation 信息都会实时的回传至 Zipkin Server，通过这样的链路可以准确的分析出网络、系统性能等问题。</p>
<h3 id="工具选择"><a href="#工具选择" class="headerlink" title="工具选择"></a>工具选择</h3><p>鉴于目前微服务框架大多都选择 Spring Cloud 来实现，本文主要使用 Spring Cloud Sleuth 和 Zipkin 来进行介绍：</p>
<ul>
<li><p>Sleuth：是 Spring Cloud 在分布式系统中提供链路追踪解决方案。</p>
</li>
<li><p>Zipkin：是一套基于 Google Dapper 的分布式链路调用的监控系统。</p>
</li>
</ul>
<h3 id="搭建-Zipkin-Server"><a href="#搭建-Zipkin-Server" class="headerlink" title="搭建 Zipkin Server"></a>搭建 Zipkin Server</h3><ol>
<li><p>新建一个基于 Spring Boot 的 Gradle 项目，项目名称为：zipkin-server。</p>
</li>
<li><p>项目 build.gradle 配置如下：</p>
<p><strong>清单 1. zipkin-server Gradle 脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter&apos;)</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-jdbc&apos;)</span><br><span class="line">    compile(&apos;io.zipkin.java:zipkin-server&apos;)</span><br><span class="line">    runtime(&apos;io.zipkin.java:zipkin-autoconfigure-ui&apos;)</span><br><span class="line">    compile(&apos;io.zipkin.java:zipkin-autoconfigure-storage-mysql&apos;)</span><br><span class="line">    compile(&apos;mysql:mysql-connector-java&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>项目 application.yml 配置如下：</p>
<p><strong>清单 2. application.yml 配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9411</span><br><span class="line"> </span><br><span class="line">docs:</span><br><span class="line">  service:</span><br><span class="line">    name: docs-zipkin</span><br><span class="line"> </span><br><span class="line"># Spring Profiles</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: docs-zipkin-server</span><br><span class="line">  # Http Encoding</span><br><span class="line">  http:</span><br><span class="line">    encoding.charset: UTF-8</span><br><span class="line">    encoding.enable: true</span><br><span class="line">    encoding.force: true</span><br><span class="line">  datasource: </span><br><span class="line">    schema: classpath:/mysql.sql</span><br><span class="line">    url: jdbc:mysql://127.0.0.1:3306/zipkin</span><br><span class="line">    username: root</span><br><span class="line">    password: password</span><br><span class="line">    # Switch this on to create the schema on startup:</span><br><span class="line">    initialize: true</span><br><span class="line">    continueOnError: true</span><br><span class="line">     </span><br><span class="line">zipkin:</span><br><span class="line">  storage:</span><br><span class="line">    type: mysql</span><br><span class="line">     </span><br><span class="line">spring.profiles.active: dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>Spring Boot 启动类参照项目代码：<a href="https://github.com/lenvon2012/trace-demo/blob/master/zipkin-server/src/main/java/com/trace/demo/ZipkinApplication.java" target="_blank" rel="noopener">ZipkinApplication.java</a>。</p>
</li>
<li><p>zipkin-server 配置完成，将其启动之后，访问 <a href="http://localhost:9411" target="_blank" rel="noopener">http://localhost:9411</a> 将看到如下 Zipkin 管理界面：</p>
</li>
</ol>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image006.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N1016E" target="_blank" rel="noopener">点击查看大图</a></p>
<h3 id="创建-demoe-web-工程"><a href="#创建-demoe-web-工程" class="headerlink" title="创建 demoe-web 工程"></a>创建 demoe-web 工程</h3><ol>
<li><p>新建一个基于 Spring Boot Web 的 Gradle 项目，项目名称为：demo-web。</p>
</li>
<li><p>项目 build.gradle 配置如下：</p>
<p><strong>清单 3. demo-web Gradle 脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile project(&apos;:demo-model&apos;)</span><br><span class="line">    compile project(&apos;:demo-util&apos;)</span><br><span class="line"> </span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-web&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-starter-sleuth&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-sleuth-zipkin&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>项目 application.yml 配置如下，由于是 demo 环境，所以采样率设置为 100%。</p>
<p><strong>清单 4. application.yml 配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: demo-web</span><br><span class="line">  profiles:</span><br><span class="line">    active: dev</span><br><span class="line">  sleuth:</span><br><span class="line">    sampler:</span><br><span class="line">      percentage: 1</span><br><span class="line">  #   Percentage of logs export to zipkin server</span><br><span class="line">  zipkin:</span><br><span class="line">    # For enabling Zipkin Client for this Microservice</span><br><span class="line">    enabled: true</span><br><span class="line">    # Server Url</span><br><span class="line">    baseUrl: http://localhost:9411</span><br><span class="line"> </span><br><span class="line"># Server Information</span><br><span class="line">server:</span><br><span class="line">  port: 8080</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="4">
<li><p>Spring Boot 启动类如清单 5 中所示，通过配置HttpResponseInjectingTraceFilter、CustomHttpServletResponseSpanInjector类（具体参考项目代码），将 Trace ID 和 Web 模块的 Span ID 保存在 header 中返回给用户端，通过这种方式也可以显示在 Web 界面。</p>
<p><strong>清单 5. demo-web 启动类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(scanBasePackages = &#123; &quot;com.ibm.demo&quot; &#125;)</span><br><span class="line">public class DemoWebApplication &#123;</span><br><span class="line"> </span><br><span class="line">       public static void main(String[] args) &#123;</span><br><span class="line">               SpringApplication.run(DemoWebApplication.class, args);</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">       @Bean</span><br><span class="line">       public RestTemplate restTemplate() &#123;</span><br><span class="line">              return new RestTemplate();</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">       @Bean</span><br><span class="line">       public SpanInjector&lt;HttpServletResponse&gt; </span><br><span class="line">customHttpServletResponseSpanInjector() &#123;</span><br><span class="line">               return new CustomHttpServletResponseSpanInjector();</span><br><span class="line">       &#125;</span><br><span class="line"> </span><br><span class="line">       @Bean</span><br><span class="line">       public HttpResponseInjectingTraceFilter responseInjectingTraceFilter(Tracer </span><br><span class="line">tracer) &#123;</span><br><span class="line">               return new HttpResponseInjectingTraceFilter(tracer, </span><br><span class="line">customHttpServletResponseSpanInjector());</span><br><span class="line">       &#125;</span><br><span class="line">     </span><br><span class="line">    @Bean</span><br><span class="line">    public Sampler defaultSampler() &#123;</span><br><span class="line">         return new AlwaysSampler();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li>Web Controller 类中包含以下 4 个接口：</li>
</ol>
<ul>
<li>/demo/web/：demo-web 直接返回。</li>
<li>/demo/web/call：demo-web 通过 HTTP 调用 demo-service 接口。</li>
<li>/demo/web/callkafka：demo-web 通过 Kafka 发消息给 demo-service。</li>
<li>/demo/web/callredis：demo-web 通过 Redis 发消息给 demo-service。</li>
</ul>
<h2 id="Node-js-下-Trace-介绍以及实践"><a href="#Node-js-下-Trace-介绍以及实践" class="headerlink" title="Node.js 下 Trace 介绍以及实践"></a>Node.js 下 Trace 介绍以及实践</h2><p>Node.js 追踪是通过与 Zipkin 集成来实现的，具体是通过 Express 与 Zipkin 集成来完成，两者的集成非常简单，并且入侵性也小。</p>
<h3 id="集成介绍"><a href="#集成介绍" class="headerlink" title="集成介绍"></a>集成介绍</h3><ul>
<li><p>Express Server：Express Server 与 Zipkin 的集成，即 Server 接收到请求时把自身的调用信息发送到 Zipkin。</p>
</li>
<li><p>Rest Client：服务 A 调用服务 B 时，服务 A 把调用链信息发送到 Zipkin。</p>
</li>
<li><p>Tracer：根据 context 把记录的 Span 信息通过 Recorder 发送到 Zipkin。</p>
</li>
<li><p>Recorder：发送信息到 Zipkin，支持两种方式，一种是直接发送到 Zipkin Server，还有一种是控制台输出，控制台输出的方式可以用来调试，本 demo 中我们选择第一种方式。</p>
</li>
</ul>
<h3 id="创建-demo-front-工程"><a href="#创建-demo-front-工程" class="headerlink" title="创建 demo-front 工程"></a>创建 demo-front 工程</h3><p>限于篇幅问题，将涉及 Node.js 的 demo-frontend、demo-backend 都放在 <a href="https://github.com/lenvon2012/trace-demo/tree/master/demo-front" target="_blank" rel="noopener">demo-front</a> 工程中。</p>
<ol>
<li><p>新建一个基于 Node.js 的项目，项目名称为：demo-front。</p>
</li>
<li><p>项目 package.json 配置如下：</p>
<p><strong>清单 6. package.json 配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;demo-front&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;0.0.1&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;Example project that shows how to use zipkin with javascript&quot;,</span><br><span class="line">  &quot;repository&quot;: &quot;https://github.com/openzipkin/zipkin-js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;lint&quot;: &quot;eslint .&quot;,</span><br><span class="line">    &quot;start&quot;: &quot;node servers.js&quot;,</span><br><span class="line">    &quot;browserify&quot;: &quot;browserify browser.js -o bundle.js&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;browser-process-hrtime&quot;: &quot;^0.1.2&quot;,</span><br><span class="line">    &quot;express&quot;: &quot;^4.14.0&quot;,</span><br><span class="line">    &quot;rest&quot;: &quot;^1.3.2&quot;,</span><br><span class="line">    &quot;zipkin&quot;: &quot;^0.11.1&quot;,</span><br><span class="line">    &quot;zipkin-context-cls&quot;: &quot;^0.11.0&quot;,</span><br><span class="line">    &quot;zipkin-instrumentation-cujojs-rest&quot;: &quot;^0.11.1&quot;,</span><br><span class="line">    &quot;zipkin-instrumentation-express&quot;: &quot;^0.11.1&quot;,</span><br><span class="line">    &quot;zipkin-instrumentation-fetch&quot;: &quot;^0.11.1&quot;,</span><br><span class="line">    &quot;zipkin-transport-http&quot;: &quot;^0.11.1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;browserify&quot;: &quot;^14.1.0&quot;,</span><br><span class="line">    &quot;eslint&quot;: &quot;^3.4.0&quot;,</span><br><span class="line">    &quot;eslint-config-airbnb&quot;: &quot;^14.1.0&quot;,</span><br><span class="line">    &quot;eslint-plugin-import&quot;: &quot;^2.2.0&quot;,</span><br><span class="line">    &quot;eslint-plugin-jsx-a11y&quot;: &quot;^4.0.0&quot;,</span><br><span class="line">    &quot;eslint-plugin-react&quot;: &quot;^6.2.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>创建 frontend.js，后续将使用 frontend.js 作为最前端调用 demo-web，完成 Node.js 端调用 Java Web 模块的 Trace 模拟，如清单 7 所示，完整代码参照项目：</p>
<p><strong>清单 7. frontend.js 代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/redis&apos;, (req, res) =&gt; &#123;</span><br><span class="line">  var url_parts = url.parse(req.url, true);</span><br><span class="line">  var query = url_parts.query;</span><br><span class="line">  res.header(&apos;X-B3-TraceId&apos;, tracer.id.traceId);</span><br><span class="line">  res.header(&apos;X-B3-SpanId&apos;, tracer.id.spanId);</span><br><span class="line">  tracer.local(&apos;docs-front&apos;, () =&gt;</span><br><span class="line">    zipkinRest(`http://localhost:8080/docs/web/callredis?msg=$&#123;query.msg&#125;`)</span><br><span class="line">      .then(response =&gt; res.send(response.entity))</span><br><span class="line">      .catch(err =&gt; console.error(&apos;Error&apos;, err.stack))</span><br><span class="line">  );</span><br><span class="line">  console.log(`tracerId : $&#123;tracer.id.traceId&#125;, spanId : $&#123;tracer.id.spanId&#125;`);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(&apos;/kafka&apos;, (req, res) =&gt; &#123;</span><br><span class="line">         var url_parts = url.parse(req.url, true);</span><br><span class="line">         var query = url_parts.query;</span><br><span class="line">         res.header(&apos;X-B3-TraceId&apos;, tracer.id.traceId);</span><br><span class="line">         res.header(&apos;X-B3-SpanId&apos;, tracer.id.spanId);</span><br><span class="line">         tracer.local(&apos;docs-front&apos;, () =&gt;</span><br><span class="line">           zipkinRest(`http://localhost:8080/docs/web/callkafka?msg=$&#123;query.msg&#125;`)</span><br><span class="line">               .then(response =&gt; res.send(response.entity))</span><br><span class="line">               .catch(err =&gt; console.error(&apos;Error&apos;, err.stack))</span><br><span class="line">         );</span><br><span class="line">         console.log(`tracerId : $&#123;tracer.id.traceId&#125;, spanId : </span><br><span class="line">$&#123;tracer.id.spanId&#125;`);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="4">
<li><p>创建 backend.js，如清单 8 所示。后续将使用 backend.js 作为最后端，完成 Node.js 端调用 Java 模块，然后 Java 模块调用 Node.js 模块的一套完整的 Trace 模拟。</p>
<p><strong>清单 8. backend.js 代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/api&apos;, (req, res) =&gt; &#123;</span><br><span class="line">       var url_parts = url.parse(req.url, true);</span><br><span class="line">       var query = url_parts.query;</span><br><span class="line">       console.log(`docs-backend msg : $&#123;query.msg&#125;`);</span><br><span class="line">       console.log(`docs-backend tracerId : $&#123;tracer.id.traceId&#125;, spanId : </span><br><span class="line">$&#123;tracer.id.spanId&#125;`);</span><br><span class="line">       res.send(new Date().toString())</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="中间件中-Trace-介绍以及实践"><a href="#中间件中-Trace-介绍以及实践" class="headerlink" title="中间件中 Trace 介绍以及实践"></a>中间件中 Trace 介绍以及实践</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文 demo 中所谈到的中间件是基于 Java 语言环境下，与 Kafka、Redis 中间件的集成，Spring Cloud 中已经包含与 Kafka 的集成工具：spring-cloud-starter-stream-kafka，只需在 dependency 中引用加上配置即可，与 Redis 的集成，由于版本还处于 1.0 并且已经被 deprecated 了，所以只能按照 Stream binder 实现方式自行实现。</p>
<h3 id="集成介绍-1"><a href="#集成介绍-1" class="headerlink" title="集成介绍"></a>集成介绍</h3><ul>
<li>spring-cloud-starter-stream-kafka：Spring Cloud 中与 Kafka 集成的工具包，即通过集成之后能够将 Trace 信息通过 Kafka Message 传递到下游系统。</li>
<li>Redis：与 Redis 集成能够传递 Trace 信息，在上游系统发送 Message 到 Redis 之前在 Message 基础上将 Trace 信息封包进去，通过 Redis 传递到下游系统，下游系统收到消息之后再将封包消息进行解包处理，同时将解包出来的 Trace 信息注册到系统中，解包出来的 Message 信息交由下游系统处理，并且需要做到封包处理和解包处理对于 Redis 上、下游模块都是透明的。</li>
<li>Pub/Sub：与 Redis 集成 Pub/Sub。</li>
</ul>
<h3 id="Redis-集成思路"><a href="#Redis-集成思路" class="headerlink" title="Redis 集成思路"></a>Redis 集成思路</h3><ol>
<li>在上游系统在接收包用户消息之后，将 Trace 信息封装包 Message 中，然后再发送给 Redis。</li>
<li>Message 保存到 Redis。</li>
<li>下游系统收到消息之后，对消息进行解包处理，同时将解包出来的 Trace 信息注册到当前系统中，解包出来的 Message 信息交由后续系统处理。</li>
</ol>
<p>以上方式是通过 Pub/Sub 方式实现，并且需要保持对 Pub/Sub 两端系统都透明；不过本 demo 中 Redis 消息集成仅限于 JSON 消息格式，如清单 9 所示:</p>
<p><strong>清单 9. Message 封包示例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        contentType = application / json,</span><br><span class="line">        header = &#123;</span><br><span class="line">               spanParentSpanId = 1665384374984194801,</span><br><span class="line">               spanTraceId = 4676089090076077054,</span><br><span class="line">               spanId = -4549244921492974775,</span><br><span class="line">               spanProcessId = null,</span><br><span class="line">               spanName = publish</span><br><span class="line">        &#125;,</span><br><span class="line">        message = &#123;</span><br><span class="line">               &quot;id&quot;: &quot;24506&quot;,</span><br><span class="line">               &quot;name&quot;: &quot;abef&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建-demoe-service-工程"><a href="#创建-demoe-service-工程" class="headerlink" title="创建 demoe-service 工程"></a>创建 demoe-service 工程</h3><ol>
<li><p>新建一个基于 Spring Boot Web 的 Gradle 项目，项目名称为：demo-service。</p>
</li>
<li><p>项目 build.gradle 配置如下：</p>
<p><strong>清单 10. demo-service Gradle 脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile project(&apos;:demo-model&apos;)</span><br><span class="line">    compile project(&apos;:demo-util&apos;)</span><br><span class="line"> </span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-aop&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-starter-sleuth&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-sleuth-stream&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-starter-stream-kafka&apos;)</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-data-redis&apos;)</span><br><span class="line">    compile(&apos;org.springframework.kafka:spring-kafka&apos;)</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-web&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-sleuth-zipkin&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>配置 demo-service controller 类（如清单 11 所示），主要处理 demo-web 发送过来的 HTTP 请求，并发送消息到 Kafka、Redis 中间件。</p>
<p><strong>清单 11. demo-service controller 类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> @RequestMapping(value = &quot;/testkafka&quot;, method = RequestMethod.GET)</span><br><span class="line">    public String testkafka(@RequestParam(value = &quot;msg&quot;) String msg) throws </span><br><span class="line">JsonProcessingException &#123;</span><br><span class="line">        logger.info(&quot;Hello Docs Service testkafka Test!&quot;);</span><br><span class="line">        KafkaModel kafkaModel = new KafkaModel();</span><br><span class="line">        kafkaModel.setId(String.valueOf(Math.round(Math.random() * 99999)));</span><br><span class="line">        kafkaModel.setName(msg);</span><br><span class="line">        ObjectMapper jsonMapper = new ObjectMapper();</span><br><span class="line">        logger.info(&quot;Putting message to kafka topic name : sampletopic&quot;);</span><br><span class="line">        MessageBuilder&lt;String&gt; messageBuilder = </span><br><span class="line">MessageBuilder.withPayload(jsonMapper.writeValueAsString(kafkaModel));</span><br><span class="line">        source.output().send(messageBuilder.build());</span><br><span class="line">        return &quot;Message successfully pushed to kafka&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @RequestMapping(value = &quot;/testredis&quot;, method = RequestMethod.GET)</span><br><span class="line">    public String testredis(@RequestParam(value = &quot;msg&quot;) String msg) throws </span><br><span class="line">JsonProcessingException &#123;</span><br><span class="line">        logger.info(&quot;Hello Demo Service testredis Test!&quot;);</span><br><span class="line">        KafkaModel kafkaModel = new KafkaModel();</span><br><span class="line">        kafkaModel.setId(String.valueOf(Math.round(Math.random() * 99999)));</span><br><span class="line">        kafkaModel.setName(msg);</span><br><span class="line">        ObjectMapper jsonMapper = new ObjectMapper();</span><br><span class="line">        Object message = jsonMapper.writeValueAsString(kafkaModel);</span><br><span class="line">        customerInfoPublisher.publish(message);</span><br><span class="line">        return &quot;Message successfully pushed to redis&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="4">
<li><p>demoe-service Redis 消息封包处理 （如清单 12 所示），基于 Aspect 实现，以此来实现对发送消息进行封包，同时尽可能实现透明注入。</p>
<p><strong>清单 12. demo-service Message 封包处理</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"> @Pointcut(&quot;execution(* publish(..)) &amp; &amp;  </span><br><span class="line">target(com.ibm.demo.service.redis.pubsub.CustomerInfoPublisher)&quot;)</span><br><span class="line">    public void messageListener() &#123;</span><br><span class="line">        // This func is intentionally empty. Nothing special is needed here.</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Around(&quot;messageListener()&quot;)</span><br><span class="line">    public void interceptMessage(ProceedingJoinPoint joinPoint) throws Throwable &#123;</span><br><span class="line">        Object[] joinPointArgs = joinPoint.getArgs();</span><br><span class="line">        Map&lt;String, Object&gt; messageObj = new HashMap&lt;&gt;();</span><br><span class="line">        createSpanIntoTrace(joinPoint);</span><br><span class="line">        Map&lt;String, String&gt; spanObj = SleuthHelper.toMap(tracer.getCurrentSpan());</span><br><span class="line">        messageObj.put(&quot;contentType&quot;, &quot;application/json&quot;);</span><br><span class="line">        messageObj.put(&quot;header&quot;, spanObj);</span><br><span class="line">        RedisMessage redisMessage = new RedisMessage(&quot;application/json&quot;, spanObj, </span><br><span class="line">joinPointArgs[0]);</span><br><span class="line">        ObjectMapper jsonMapper = new ObjectMapper();</span><br><span class="line">        Object mesgObj = jsonMapper.writeValueAsString(redisMessage);</span><br><span class="line">        Object[] message = new Object[] &#123; mesgObj &#125;;</span><br><span class="line">        joinPoint.proceed(message);</span><br><span class="line">        logger.info(&quot;Putting message into redis with message &#123;&#125;&quot;, message);</span><br><span class="line">        afterSendCompletion(mesgObj, joinPoint.getSignature().getName(), null);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private void createSpanIntoTrace(ProceedingJoinPoint joinPoint) &#123;</span><br><span class="line">        Span span = startSpan(this.tracer.getCurrentSpan(), joinPoint.getSignature().getName());</span><br><span class="line">        SpanBuilder spanBuilder = Span.builder().from(span);</span><br><span class="line">        Span currentSpan = spanBuilder.remote(false).build();</span><br><span class="line">        this.tracer.continueSpan(currentSpan);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void afterSendCompletion(Object object, String name, Exception ex) &#123;</span><br><span class="line">        ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">        try &#123;</span><br><span class="line">            RedisMessage redisMessage = objectMapper.readValue((String) </span><br><span class="line">object.toString(), RedisMessage.class);</span><br><span class="line">            Map&lt;String, String&gt; spanMap = redisMessage.getHeader();</span><br><span class="line">            Span currentSpan = this.tracer.isTracing() ? </span><br><span class="line">this.tracer.getCurrentSpan() : SleuthHelper.fromMap(spanMap);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Completed sending and current span is &quot; + </span><br><span class="line">currentSpan);</span><br><span class="line">            &#125;</span><br><span class="line">            if (containsServerReceived(currentSpan)) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Marking span with server send&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                currentSpan.logEvent(Span.SERVER_SEND);</span><br><span class="line">            &#125; else if (currentSpan != null) &#123;</span><br><span class="line">                if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                    logger.debug(&quot;Marking span with client received&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                currentSpan.logEvent(Span.CLIENT_RECV);</span><br><span class="line">            &#125;</span><br><span class="line">            addErrorTag(ex);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Closing messaging span &quot; + currentSpan);</span><br><span class="line">            &#125;</span><br><span class="line">            this.tracer.close(currentSpan);</span><br><span class="line">            if (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(&quot;Messaging span &quot; + currentSpan + &quot; successfully </span><br><span class="line">closed&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            logger.error(&quot;Parse Messaging span &#123;&#125; with exception &#123;&#125;&quot;, </span><br><span class="line">this.tracer.getCurrentSpan(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private boolean containsServerReceived(Span span) &#123;</span><br><span class="line">        if (span == null) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        for (Log log : span.logs()) &#123;</span><br><span class="line">            if (Span.SERVER_RECV.equals(log.getEvent())) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private void addErrorTag(Exception ex) &#123;</span><br><span class="line">        if (ex != null) &#123;</span><br><span class="line">            this.errorParser.parseErrorTags(this.tracer.getCurrentSpan(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private Span startSpan(Span span, String name) &#123;</span><br><span class="line">        return startSpan(span, name, null);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private Span startSpan(Span span, String name, RedisMessage message) &#123;</span><br><span class="line">        if (span != null) &#123;</span><br><span class="line">            return this.tracer.createSpan(name, span);</span><br><span class="line">        &#125;</span><br><span class="line">        if (message != null &amp; &amp;  </span><br><span class="line">Span.SPAN_NOT_SAMPLED.equals(message.getHeader().get(TraceMessageHeaders.SAMPLED_NA</span><br><span class="line">ME))) &#123;</span><br><span class="line">            return this.tracer.createSpan(name, NeverSampler.INSTANCE);</span><br><span class="line">        &#125;</span><br><span class="line">        return this.tracer.createSpan(name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="创建-demoe-message-工程"><a href="#创建-demoe-message-工程" class="headerlink" title="创建 demoe-message 工程"></a>创建 demoe-message 工程</h3><ol>
<li><p>新建一个基于 Spring Boot Web 的 Gradle 项目，项目名称为：demo-message。</p>
</li>
<li><p>项目 build.gradle 配置如下：</p>
<p><strong>清单 13. demo-message Gradle 脚本</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile project(&apos;:demo-model&apos;)</span><br><span class="line">    compile project(&apos;:demo-util&apos;)</span><br><span class="line"> </span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-aop&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-starter-sleuth&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-sleuth-stream&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-starter-stream-kafka&apos;)</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-data-redis&apos;)</span><br><span class="line">    compile(&apos;org.springframework.kafka:spring-kafka&apos;)</span><br><span class="line">    compile(&apos;org.springframework.boot:spring-boot-starter-web&apos;)</span><br><span class="line">    compile(&apos;org.springframework.cloud:spring-cloud-sleuth-zipkin&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>demoe-message Redis 消息解包处理， （如清单 14 所示），基于 Aspect 实现，以此来实现对接受到的消息进行解包处理，同时保证代码透明注入，请在项目中查看完整源代码。</p>
<p><strong>清单 14. demo-message Message 封包处理</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"> @Pointcut(&quot;execution(* onMessage(..)) &amp; &amp;  </span><br><span class="line">target(org.springframework.data.redis.connection.MessageListener)&quot;)</span><br><span class="line">    public void messageListener() &#123;</span><br><span class="line">        // This func is intentionally empty. Nothing special is needed here.</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Around(&quot;messageListener()&quot;)</span><br><span class="line">    public void interceptMessage(ProceedingJoinPoint joinPoint) throws Throwable &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Object[] joinPointArgs = joinPoint.getArgs();</span><br><span class="line">            Object[] result = new Object[joinPointArgs.length];</span><br><span class="line">            for (int i = 0; i &lt; joinPointArgs.length; i++) &#123;</span><br><span class="line">                Object object = joinPointArgs[i];</span><br><span class="line">                ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">                if (object instanceof Message &amp;&amp; jsonParse(object)) &#123;</span><br><span class="line">                    Message message = (Message) object;</span><br><span class="line">                    RedisMessage redisMessage = objectMapper.readValue((String) </span><br><span class="line">object.toString(), RedisMessage.class);</span><br><span class="line">                    logger.debug(&quot;Received &gt;&gt; redisMessage &#123;&#125; &quot;, redisMessage);</span><br><span class="line">                    Map&lt;String, String&gt; spanMap = redisMessage.getHeader();</span><br><span class="line">                    String traceIdString = </span><br><span class="line">Span.idToHex(Long.parseLong(spanMap.get(TraceMessageHeaders.TRACE_ID_NAME)));</span><br><span class="line">                    String spanId = </span><br><span class="line">Span.idToHex(Long.parseLong(spanMap.get(TraceMessageHeaders.SPAN_ID_NAME)));</span><br><span class="line">                    Span parentSpan = SleuthHelper.fromMap(spanMap);</span><br><span class="line">                    logger.debug(&quot;Received &gt;&gt; trace &#123;&#125; span &#123;&#125;&quot;, traceIdString, </span><br><span class="line">spanId);</span><br><span class="line">                    if (sleuthProperties != null &amp;&amp; </span><br><span class="line">sleuthProperties.isSupportsJoin()) &#123;</span><br><span class="line">                        SleuthHelper.joinSpan(tracer, spanMap);</span><br><span class="line">                        logger.debug(&quot;Join trace span &#123;&#125;&quot;, spanMap);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        SleuthHelper.continueSpan(tracer, spanMap);</span><br><span class="line">                        logger.debug(&quot;Continue trace span &#123;&#125;&quot;, spanMap);</span><br><span class="line">                    &#125;</span><br><span class="line">                    slf4jSpanLogger.logStartedSpan(parentSpan, </span><br><span class="line">tracer.getCurrentSpan());</span><br><span class="line">                    logger.debug(&quot;Received &gt;&gt; trace &#123;&#125; span &#123;&#125;&quot;, </span><br><span class="line">Span.idToHex(tracer.getCurrentSpan().getTraceId()),</span><br><span class="line">                            Span.idToHex(tracer.getCurrentSpan().getSpanId()));</span><br><span class="line">                    byte[] channel = message.getChannel();</span><br><span class="line">                    byte[] body = </span><br><span class="line">SerializationUtils.serialize(redisMessage.getMessage());</span><br><span class="line">                    logger.debug(&quot;Received &gt;&gt; message &#123;&#125;&quot;, </span><br><span class="line">SerializationUtils.deserialize(body));</span><br><span class="line">                    result[i] = new RedisDefaultMessage(channel, body);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    result[i] = object;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            SpanBuilder spanBuilder = </span><br><span class="line">Span.builder().from(this.tracer.getCurrentSpan());</span><br><span class="line">            Span currentSpan = </span><br><span class="line">spanBuilder.parents(this.tracer.getCurrentSpan().getParents()).name(joinPoint.getSi</span><br><span class="line">gnature().getName()).remote(false).build();</span><br><span class="line">            currentSpan.logEvent(&quot;sr&quot;);</span><br><span class="line">            this.tracer.close(currentSpan);</span><br><span class="line">            this.tracer.continueSpan(currentSpan);</span><br><span class="line">            joinPoint.proceed(result);</span><br><span class="line">        &#125; catch (JsonParseException e) &#123;</span><br><span class="line">            logger.error(&quot;Join trace span with JsonParseException &#123;&#125; &quot;, e);</span><br><span class="line">        &#125; catch (JsonMappingException e) &#123;</span><br><span class="line">            logger.error(&quot;Join trace span with JsonMappingException &#123;&#125; &quot;, e);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            logger.error(&quot;Join trace span with IOException &#123;&#125;&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private boolean jsonParse(Object object) &#123;</span><br><span class="line">        boolean falg = true;</span><br><span class="line">        ObjectMapper objectMapper = new ObjectMapper();</span><br><span class="line">        try &#123;</span><br><span class="line">            objectMapper.readValue((String) object.toString(), RedisMessage.class);</span><br><span class="line">            falg = true;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            falg = false;</span><br><span class="line">        &#125;</span><br><span class="line">        return falg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="完整-Trace-链路实践"><a href="#完整-Trace-链路实践" class="headerlink" title="完整 Trace 链路实践"></a>完整 Trace 链路实践</h2><h3 id="链路图"><a href="#链路图" class="headerlink" title="链路图"></a>链路图</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前文介绍和模拟了从 Node.js 前端调用 Java API，Java API 再调用 Java Service API 从而发送 Kafka、Redis 消息到 Java Message 模块，Java Message 模块收到消息之后再调用最后端的 Node.js 系统，从而完成一套完整的 Node.js -&gt; Java -&gt; Kafka/Redis -&gt; Java -&gt; Node.js 的调用链路模拟。具体模拟见下图：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image007.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N10283" target="_blank" rel="noopener">点击查看大图</a></p>
<h3 id="模块流图"><a href="#模块流图" class="headerlink" title="模块流图"></a>模块流图</h3><p>下图为各个模块之间调用流程图：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image008.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N10295" target="_blank" rel="noopener">点击查看大图</a></p>
<h3 id="Zipkin-信息图"><a href="#Zipkin-信息图" class="headerlink" title="Zipkin 信息图"></a>Zipkin 信息图</h3><p>下图为 Zipkin Server 中查到该次请求中对应各个模块之间调用时序图，可以清晰知道各个模块耗时、网络耗时等信息：</p>
<p><img src="//blog.com/2019/05/07/分布式集群环境下调用链路追踪/image009.png" alt=""></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-distributed-systems-request-tracing/index.html#N102A7" target="_blank" rel="noopener">点击查看大图</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于分布式集群环境，特别是当前微服务广泛应用，对于每个请求，全链路调用的跟踪就变得越来越重要，通过实现对请求调用的跟踪可以帮助我们快速发现错误根源以及监控分析每条请求链路上的性能瓶颈等。以上只是个人在项目中的一点思考，希望与您交流心得，一同学习进步。</p>
<h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><ul>
<li>参考 <a href="https://cloud.spring.io/spring-cloud-sleuth/" target="_blank" rel="noopener">spring-cloud-sleuth</a>，查看更多有关 Spring Cloud Sleuth 的最新信息。</li>
<li>参考 <a href="https://github.com/spring-cloud/spring-cloud-stream" target="_blank" rel="noopener">spring-cloud-stream</a>，了解更多 Spring Cloud Stream 的相关内容。</li>
<li>参考 <a href="https://zipkin.io/" target="_blank" rel="noopener">Zipkin</a>，了解更多 Zipkin 的相关内容。</li>
<li>查看文章 “<a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36356.pdf" target="_blank" rel="noopener">Dapper, a Large-Scale Distributed Systems Tracing Infrastructure</a>“，了解更多 Google Dapper 的相关内容。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/06/CAP定理的含义/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/06/CAP定理的含义/" itemprop="url">CAP定理的含义</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-06T12:12:57+08:00">
                2019-05-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/一致性协议/" itemprop="url" rel="index">
                    <span itemprop="name">一致性协议</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/一致性协议/CAP定理/" itemprop="url" rel="index">
                    <span itemprop="name">CAP定理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="CAP定理的含义"><a href="#CAP定理的含义" class="headerlink" title="CAP定理的含义"></a>CAP定理的含义</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="http://www.ruanyifeng.com/blog/2018/07/cap.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2018/07/cap.html</a></p>
<p>英文地址：<a href="https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/" target="_blank" rel="noopener">https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式系统（<code>distributed system</code>）正变得越来越重要，大型网站几乎都是分布式的。</p>
<p>分布式系统的最大难点，就是各个节点的状态如何同步。<code>CAP</code>定理是这方面的基本定理，也是理解分布式系统的起点。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文介绍该定理。它其实很好懂，而且是显而易见的。下面的内容主要参考了 <code>Michael Whittaker</code>的<a href="https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/" target="_blank" rel="noopener">文章</a>。</p>
<h2 id="一、分布式系统的三个指标"><a href="#一、分布式系统的三个指标" class="headerlink" title="一、分布式系统的三个指标"></a>一、分布式系统的三个指标</h2><p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071607.jpg" alt="img"></p>
<p>1998年，加州大学的计算机科学家 <code>Eric Brewer</code>提出，分布式系统有三个指标。</p>
<blockquote>
<ul>
<li>Consistency</li>
<li>Availability</li>
<li>Partition tolerance</li>
</ul>
</blockquote>
<p>它们的第一个字母分别是 C、A、P。</p>
<p><code>Eric Brewer</code>说，这三个指标不可能同时做到。这个结论就叫做<code>CAP</code> 定理。</p>
<h2 id="二、Partition-tolerance"><a href="#二、Partition-tolerance" class="headerlink" title="二、Partition tolerance"></a>二、Partition tolerance</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先看 <code>Partition tolerance</code>，中文叫做”分区容错”。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大多数分布式系统都分布在多个子网络。<strong>每个子网络就叫做一个区（<code>partition</code>）</strong>。<strong>分区容错的意思是，区间通信可能失败</strong>。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071601.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。<code>CAP</code> 定理告诉我们，剩下的 C 和 A 无法同时做到</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>分区容错发生在分布式系统内部互访通信，是指分布式网络中部分网络不可用，但系统依然正常对外提供服务</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如：北京的订单系统，访问上海的库存系统，可能导致失败。如果发生失败，就要在A和C之间做出选择。<br>要么停止系统进行错误恢复，要么继续服务但是降低一致性，所以说只能保证<code>AP</code>或<code>CP</code>。</p>
<h2 id="三、Consistency"><a href="#三、Consistency" class="headerlink" title="三、Consistency"></a>三、Consistency</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Consistency</code>中文叫做”一致性”。意思是，<strong>写操作之后的读操作，必须返回该值</strong>。举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071602.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接下来，用户的读操作就会得到 v1。这就叫一致性。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071603.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0</strong>。<strong>G1 和 G2 读操作的结果不一致，这就不满足一致性了</strong>。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071604.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1</strong>。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071605.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样的话，用户向 G2 发起读操作，也能得到 v1。</p>
<p><img src="//blog.com/2019/05/06/CAP定理的含义/bg2018071606.png" alt="img"></p>
<h2 id="四、Availability"><a href="#四、Availability" class="headerlink" title="四、Availability"></a>四、Availability</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Availability</code>中文叫做”可用性”，意思是<strong>只要收到用户的请求，服务器就必须给出回应</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p>
<h2 id="五、Consistency-和-Availability-的矛盾"><a href="#五、Consistency-和-Availability-的矛盾" class="headerlink" title="五、Consistency 和 Availability 的矛盾"></a>五、Consistency 和 Availability 的矛盾</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一致性和可用性，为什么不可能同时成立？答案很简单，<strong>因为可能通信失败（即出现分区容错）</strong>。</p>
<blockquote>
<p>​        如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写<strong>。</strong>锁定期间，G2 不能读写，所以可用性不成立。</p>
</blockquote>
<blockquote>
<p>​        如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。<strong>如果追求一致性，那么无法保证所有节点的可用性</strong>；<strong>如果追求所有节点的可用性，那就没法做到一致性</strong>。</p>
<p>现在互联网公司的一般选择：<strong>可用性 + 最终一致性</strong></p>
<p><code>zookeeper：CP</code>，选主期间无法提供服务</p>
<h2 id="六、在什么场合，可用性高于一致性？"><a href="#六、在什么场合，可用性高于一致性？" class="headerlink" title="六、在什么场合，可用性高于一致性？"></a>六、在什么场合，可用性高于一致性？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举例来说，发布一张网页到 CDN，多个服务器有这张网页的副本。后来发现一个错误，需要更新网页，这时只能每个服务器都更新一遍。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般来说，网页的更新不是特别强调一致性。短时期内，一些用户拿到老版本，另一些用户拿到新版本，问题不会特别大。当然，所有人最终都会看到新版本。所以，这个场合就是可用性高于一致性。</p>
<h2 id="七、深入理解一致性"><a href="#七、深入理解一致性" class="headerlink" title="七、深入理解一致性"></a>七、深入理解一致性</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们上面说到牺牲一致性，不是完全不管数据的一致性，否则混乱的数据就没有意义了。牺牲一致性，只是不要求像关系数据库那样达到强一致，而放低要求，达到最终一致即可。也就是数据延迟多久的选择。有三种程度的一致性。</p>
<p>1、强一致性：系统中的某个数据被成功更新后，后续<strong>任何对该数据的读取操作都将得到更新后的值</strong>；</p>
<p>2、弱一致性：系统中的某个数据被成功更新后，后续对该数据的读取操作不承诺可以读到更新后的值，也<strong>不承诺多久之后数据能够达到一致</strong>，但会尽可能地保证到某个时间级别（比如秒级别）后，数据能够达到一致状态；</p>
<p>3、最终一致性：是弱一致性的一个特例，系统会<strong>保证在一定时间内，能够达到一个数据一致的状态</strong>。这里之所以将最终一致性单独提出来，是因为它是弱一致性中非常推崇的一种一致性模型，也是业界在大型分布式系统的数据一致性上比较推崇的模型。即<strong>有可能读到脏数据，但是一段时间之后总是能够读到新数据</strong>；</p>
<p><strong>CAP中的C指的是强一致性</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/83/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/83/">83</a><span class="page-number current">84</span><a class="page-number" href="/page/85/">85</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/85/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
