<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/124/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/124/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/03/12/MySQL中的general log日志/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/12/MySQL中的general log日志/" itemprop="url">MySQL中的general log日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T12:12:57+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySql日志/" itemprop="url" rel="index">
                    <span itemprop="name">MySql日志</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL中的general-log日志"><a href="#MySQL中的general-log日志" class="headerlink" title="MySQL中的general log日志"></a>MySQL中的general log日志</h1><blockquote>
<p>原文地址：<a href="https://cloud.tencent.com/developer/article/1405092" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1405092</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<code>general log</code>即<code>General Query Log</code>，记录了<code>mysql</code>服务器的操作。当客户端连接、断开连接、接收到客户端的SQL语句时，会向<code>general log</code>中写入日志。开启<code>general_log</code>会损失一定的性能，但是在开发、测试环境下开启日志，可以帮忙我们加快排查出现的问题。</p>
<h2 id="如何开启"><a href="#如何开启" class="headerlink" title="如何开启"></a>如何开启</h2><h3 id="开启开关"><a href="#开启开关" class="headerlink" title="开启开关"></a>开启开关</h3><p><code>general_log</code>默认是没有启用的。</p>
<p><img src="//blog.com/2019/03/12/MySQL中的general log日志/w1hzwalb9o.png" alt="img"></p>
<p>&nbsp;&nbsp;可以通过修改配置文件my.cnf(Linux)/my.ini（Windows），在mysqld下面增加或修改（如已存在配置项）<code>general_log</code>的值为1，修改后重启MySQL服务即可生效。</p>
<p>&nbsp;&nbsp;也可以通过在MySQL终端执行<code>set global general_log = ON</code>来开启general log，此方法可以不用重启MySQL。</p>
<p>&nbsp;&nbsp;<code>general_log</code>的值是全局生效的，那么怎么仅关闭当前Session的日志记录呢，答案就是在当前session中执行<code>set SQL_LOG_OFF=ON</code>，此值默认为OFF，即开启日志记录。此操作本身会被记录到general_log文件中，但当前session的后续操作就不会再被记录到日志文件中。</p>
<h3 id="日志位置"><a href="#日志位置" class="headerlink" title="日志位置"></a>日志位置</h3><p>可以通过参数general_log_file来设置日志的路径。</p>
<ol>
<li><p>默认日志的目录是mysql的data目录，文件名默认为<code>主机名.log</code>。</p>
</li>
<li><p>如果general_log_file仅指定了文件名，那么日志路径为data目录下该文件名指定的文件</p>
</li>
<li><p>如果general_log_file指定了完整的路径</p>
<ol>
<li>如果路径目录存在，则日志文件就是general_log_file指定路径的文件</li>
<li>如果路径目录不存在，则general_log无法开启，即使general_log参数的值配置为开也不行。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global general_log=ON;</span><br><span class="line">2013 - Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 0 &quot;Internal error/check (Not system error)&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">general_log=1                                                                        general_log_file=/root/liuzeming/general_log.log</span><br><span class="line"></span><br><span class="line"># 在指定的目录不存在时，不会创建日志文件，记录日志会失败</span><br><span class="line"># 错误日志：</span><br><span class="line">2019-04-19 21:35:32 22211 [ERROR] Could not open /root/liuzeming/general_log.log for logging (error 2). Turning logging off for the whole duration of the MySQL server process. To turn it on again: fix the cause, shutdown the MySQL server and restart it.</span><br><span class="line"></span><br><span class="line">general_log=1</span><br><span class="line">general_log_file=general_log.log</span><br><span class="line">mysql&gt; show variables like &quot;%general%&quot;;</span><br><span class="line">+---------------+---------------+</span><br><span class="line">| Variable_name  | Value         |</span><br><span class="line">+---------------+---------------+</span><br><span class="line">| general_log    | ON           |</span><br><span class="line">| general_log_file | general_log.log |</span><br><span class="line">+---------------+---------------+</span><br><span class="line">2 rows in set (1.03 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">general_log=1</span><br><span class="line">general_log_file=/root/general_log.log</span><br><span class="line">mysql&gt; show variables like &quot;%general%&quot;;</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| Variable_name  | Value             |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">| general_log    | ON               |</span><br><span class="line">| general_log_file | /root/general_log.log |</span><br><span class="line">+---------------+-------------------+</span><br><span class="line">2 rows in set (0.25 sec)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="日志文件内容"><a href="#日志文件内容" class="headerlink" title="日志文件内容"></a>日志文件内容</h2><p>如下图是日志文件的示例内容</p>
<p><img src="//blog.com/2019/03/12/MySQL中的general log日志/3zc4smlm55.png" alt="img"></p>
<h3 id="各列说明"><a href="#各列说明" class="headerlink" title="各列说明"></a>各列说明</h3><ul>
<li>Time 日志记录的时间</li>
<li>Id 进程ID，可以通过<code>show processlist</code>命令查看</li>
<li>Command 执行的命令</li>
<li>Argument 命令参数</li>
</ul>
<h3 id="关于Command"><a href="#关于Command" class="headerlink" title="关于Command"></a>关于Command</h3><ul>
<li>Connect 就是客户端连接到服务端的记录，参数里会记录用户以及连接的协议</li>
<li>Query 查询/更新/删除记录/删除表等</li>
<li>Init DB 使用命令<code>use</code>选择库时的记录</li>
<li><p>Quit 断开连接</p>
<p>当然还有很多其他的命令，一般都是可以通过名字直接看出是什么操作的。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/03/12/现代PHP框架中如何实施水平分表/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/12/现代PHP框架中如何实施水平分表/" itemprop="url">现代PHP框架中如何实施水平分表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T12:12:57+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/分库分表/" itemprop="url" rel="index">
                    <span itemprop="name">分库分表</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="现代PHP框架中如何实施水平分表"><a href="#现代PHP框架中如何实施水平分表" class="headerlink" title="现代PHP框架中如何实施水平分表"></a>现代PHP框架中如何实施水平分表</h1><h2 id="水平分表的常见做法"><a href="#水平分表的常见做法" class="headerlink" title="水平分表的常见做法"></a>水平分表的常见做法</h2><ol>
<li><p>针对业务唯一id                       <strong>hash取余</strong></p>
</li>
<li><p>业务唯一id范围或时间范围   <strong>根据范围判断落到那个表</strong></p>
</li>
</ol>
<p><strong>弊端</strong>：<strong>不利于后期扩展，数据迁移成本高，数据需要大量移动</strong></p>
<h2 id="我们的方案"><a href="#我们的方案" class="headerlink" title="我们的方案"></a>我们的方案</h2><p>采用<strong>一致性hash算法【虚节点】</strong> ，保证数据的均匀分布</p>
<h2 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现"></a>如何实现</h2><p>如何在不借助其它中间件的情况下，实现分表？</p>
<p>方案：<strong>将分表键全局保存，修改模型对应的表名</strong></p>
<p><strong>全局保存的存储载体是session或缓存</strong></p>
<h2 id="一致性hash算法实现"><a href="#一致性hash算法实现" class="headerlink" title="一致性hash算法实现"></a>一致性hash算法实现</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__contruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     $consistHash = <span class="keyword">new</span> \ConsistHashingHelper(物理节点配置);</span><br><span class="line">     <span class="keyword">$this</span>-&gt;table = $consistHash-&gt;allocateServer(分表键值);</span><br><span class="line">     <span class="keyword">$this</span>-&gt;setTable(<span class="keyword">$this</span>-&gt;table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: LZM</span></span><br><span class="line"><span class="comment"> * Email：2550705721<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> * Date: 2019/2/1</span></span><br><span class="line"><span class="comment"> * Time: 10:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsistHashingHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//物理节点</span></span><br><span class="line">    <span class="keyword">private</span> $resourceAddress = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一致性哈希环</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $hashRing = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//虚拟节点数目</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $VIRTUAL_NODE_COUNT = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hash环的最大位置2^32</span></span><br><span class="line">    <span class="keyword">const</span> MAX_HASH_LOCATION = <span class="number">1</span>&lt;&lt;<span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ConsistHashingHelper constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $resourceAddress 物理节点（数据库表名或服务器地址……）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $need_virtual_node 是否需要开启虚节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $virtual_node_number 虚节点个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($resourceAddress, $need_virtual_node=true, $virtual_node_number=<span class="number">1024</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( ! is_array($resourceAddress) )&#123;</span><br><span class="line">            $resourceAddress = (<span class="keyword">array</span>)$resourceAddress;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>::$VIRTUAL_NODE_COUNT = $virtual_node_number;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resourceAddress = $resourceAddress;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$hashRing)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($need_virtual_node &amp;&amp; $virtual_node_number) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;initHashRingWithVirtualNode();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;initHashRingWithoutVirtualNode();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化哈希环，没有虚拟节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initHashRingWithoutVirtualNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;resourceAddress <span class="keyword">as</span> $resource_item) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$hashRing[<span class="keyword">self</span>::hash($resource_item)] = $resource_item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化哈希环，没有虚拟节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initHashRingWithVirtualNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;resourceAddress <span class="keyword">as</span> $resource_item) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;addServer($resource_item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">hash</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// hash(i) = hash(i-1) * 33 + str[i]</span></span><br><span class="line">        $hash = <span class="number">0</span>;</span><br><span class="line">        $s    = md5($str);</span><br><span class="line">        $seed = <span class="number">5</span>;</span><br><span class="line">        $len  = <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">            <span class="comment">// (hash &lt;&lt; 5) + hash 相当于 hash * 33</span></span><br><span class="line">            <span class="comment">//$hash = sprintf("%u", $hash * 33) + ord($s&#123;$i&#125;);</span></span><br><span class="line">            <span class="comment">//$hash = ($hash * 33 + ord($s&#123;$i&#125;)) &amp; 0x7FFFFFFF;</span></span><br><span class="line">            $hash = ($hash &lt;&lt; $seed) + $hash + ord($s&#123;$i&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $hash &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public static function hash($key)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $str = md5($key);</span></span><br><span class="line"><span class="comment">        return sprintf('%u', crc32($str));</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据虚节点获取对应物理节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealNode</span><span class="params">($virtualNode)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos($virtualNode, <span class="string">'#'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $virtualNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> explode(<span class="string">'#'</span>, $virtualNode)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为key分配resource(真实物理节点)</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">allocateServer</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $hashValue = <span class="keyword">self</span>::hash($key);</span><br><span class="line">        $virtualNode = <span class="keyword">$this</span>-&gt;getNextAll($hashValue);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRealNode($virtualNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应的物理节点或虚节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $findKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="function"><span class="keyword">function</span>  <span class="title">getNextAll</span><span class="params">($findKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ksort(<span class="keyword">self</span>::$hashRing, SORT_NUMERIC);</span><br><span class="line"></span><br><span class="line">        $len  = count(<span class="keyword">self</span>::$hashRing);</span><br><span class="line">        <span class="keyword">if</span> ($len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"分配虚节点出错"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 虚节点hash值或物理节点hash</span></span><br><span class="line">        $keys   = array_keys(<span class="keyword">self</span>::$hashRing);</span><br><span class="line">        <span class="comment">// 虚节点或物理节点</span></span><br><span class="line">        $values = array_values(<span class="keyword">self</span>::$hashRing);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不在区间内，则返回最后一个物理节点</span></span><br><span class="line">        <span class="keyword">if</span> ($findKey &lt;= $keys[<span class="number">0</span>] || $findKey &gt;= $keys[$len - <span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> $values[$len - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历虚节点hash值或物理节点hash</span></span><br><span class="line">        <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key  =&gt; $pos) &#123;</span><br><span class="line">            $next_pos = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否是最后一个虚节点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($keys[$key + <span class="number">1</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                $next_pos = $keys[$key + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (is_null($next_pos)) &#123;</span><br><span class="line">                <span class="keyword">return</span> $values[$key];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 区间判断</span></span><br><span class="line">            <span class="keyword">if</span> ($findKey &gt;= $pos &amp;&amp; $findKey &lt;= $next_pos) &#123;</span><br><span class="line">                <span class="keyword">return</span> $values[$key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHashRing</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$hashRing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $resource_item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addServer</span><span class="params">($resource_item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! in_array($resource_item, <span class="keyword">$this</span>-&gt;resourceAddress)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;resourceAddress[] = $resource_item;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="keyword">self</span>::$VIRTUAL_NODE_COUNT; $i++) &#123;</span><br><span class="line">            $virtualServer = $resource_item .<span class="string">"#virtual"</span> .$i;</span><br><span class="line">            <span class="keyword">self</span>::$hashRing[<span class="keyword">self</span>::hash($virtualServer)] = $virtualServer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $resource_item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dropServer</span><span class="params">($resource_item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $index = array_search($resource_item, <span class="keyword">$this</span>-&gt;resourceAddress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($index === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"服务器不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 物理节点是相等 存在虚节点时，是以对应物理存储地址开头</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$hashRing <span class="keyword">as</span> $hash =&gt; $resource_item_address) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">"/^$resource_item/"</span>, $resource_item_address)) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">self</span>::$hashRing[$hash]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;resourceAddress[$index]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$resource_arr = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'t1'</span> =&gt; <span class="string">'t1'</span>,</span><br><span class="line">    <span class="string">'t2'</span> =&gt; <span class="string">'t2'</span>,</span><br><span class="line">    <span class="string">'t3'</span> =&gt; <span class="string">'t3'</span>,</span><br><span class="line">    <span class="string">'t4'</span> =&gt; <span class="string">'t4'</span></span><br><span class="line">);</span><br><span class="line">$counter = <span class="keyword">array</span>();</span><br><span class="line">$util = <span class="keyword">new</span> ConsistHashingHelper(array_values($resource_arr));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGenerator</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;=<span class="number">10000</span>; $i++) &#123;</span><br><span class="line">        <span class="keyword">yield</span> $i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (createGenerator() <span class="keyword">as</span> $val) &#123;</span><br><span class="line">    $resource_item = $util-&gt;allocateServer($val);</span><br><span class="line">    @$counter[$resource_item]++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var_dump($counter);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/03/10/SQL中的where条件，在数据库中提取与应用浅析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/10/SQL中的where条件，在数据库中提取与应用浅析/" itemprop="url">SQL中的where条件，在数据库中提取与应用浅析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-10T12:12:57+08:00">
                2019-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SQL中的where条件，在数据库中提取与应用浅析"><a href="#SQL中的where条件，在数据库中提取与应用浅析" class="headerlink" title="SQL中的where条件，在数据库中提取与应用浅析"></a>SQL中的where条件，在数据库中提取与应用浅析</h1><blockquote>
<p>原文地址：<a href="http://hedengcheng.com/?p=577" target="_blank" rel="noopener">http://hedengcheng.com/?p=577</a></p>
</blockquote>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一条SQL，在数据库中是如何执行的呢？相信很多人都会对这个问题比较感兴趣。当然，要完整描述一条SQL在数据库中的生命周期，这是一个非常巨大的问题，涵盖了SQL的词法解析、语法解析、权限检查、查询优化、SQL执行等一系列的步骤，简短的篇幅是绝对无能为力的。因此，本文挑选了其中的部分内容，也是我一直都想写的一个内容，做重点介绍：</p>
<p><strong>给定一条SQL，如何提取其中的where条件？where条件中的每个子条件，在SQL执行的过程中有分别起着什么样的作用？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过本文的介绍，希望读者能够更好地理解查询条件对于SQL语句的影响；撰写出更为优质的SQL语句；更好地理解一些术语，例如：MySQL 5.6中一个重要的优化——Index Condition Pushdown，究竟push down了什么？</p>
<p>本文接下来的内容，安排如下：</p>
<ol>
<li>简单介绍关系型数据库中数据的组织形式；</li>
<li>给定一条SQL，如何提取其中的where条件；</li>
<li>最后做一个小的总结；</li>
</ol>
<h1 id="关系型数据库中的数据组织"><a href="#关系型数据库中的数据组织" class="headerlink" title="关系型数据库中的数据组织"></a><strong>关系型数据库中的数据组织</strong></h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关系型数据库中，数据组织涉及到两个最基本的结构：表与索引。表中存储的是完整记录，一般有两种组织形式：堆表(所有的记录无序存储)，或者是聚簇索引表(所有的记录，按照记录主键进行排序存储)。索引中存储的是完整记录的一个子集，用于加速记录的查询速度，索引的组织形式，一般均为B+树结构。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有了这些基本知识之后，接下来让我们创建一张测试表，为表新增几个索引，然后插入几条记录，最后看看表的完整数据组织、存储结构式怎么样的。(注意：下面的实例，使用的表的结构为堆表形式，这也是Oracle/DB2/PostgreSQL等数据库采用的表组织形式，而不是InnoDB引擎所采用的聚簇索引表。其实，表结构采用何种形式并不重要，最重要的是理解下面章节的核心，在任何表结构中均适用)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">create table t1 (a int primary key, b int, c int, d int, e varchar(20));</span><br><span class="line"></span><br><span class="line">create index idx_t1_bcd on t1(b, c, d);</span><br><span class="line"></span><br><span class="line">insert into t1 values (4,3,1,1,’d’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (1,1,1,1,’a’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (8,8,8,8,’h’):</span><br><span class="line"></span><br><span class="line">insert into t1 values (2,2,2,2,’b’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (5,2,3,5,’e’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (3,3,2,2,’c’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (7,4,5,5,’g’);</span><br><span class="line"></span><br><span class="line">insert into t1 values (6,6,4,4,’f’);</span><br></pre></td></tr></table></figure>
<p>t1表的存储结构如下图所示(只画出了idx_t1_bcd索引与t1表结构，没有包括t1表的主键索引)：</p>
<p><img src="//blog.com/2019/03/10/SQL中的where条件，在数据库中提取与应用浅析/1.jpg" alt="t1表的组织结构图"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;简单分析一下上图，idx_t1_bcd索引上有[b,c,d]三个字段(注意：若是InnoDB类的聚簇索引表，idx_t1_bcd上还会包括主键a字段)，不包括[a,e]字段。idx_t1_bcd索引，首先按照b字段排序，b字段相同，则按照c字段排序，以此类推。记录在索引中按照[b,c,d]排序，但是在堆表上是乱序的，不按照任何字段排序。</p>
<h1 id="SQL的where条件提取"><a href="#SQL的where条件提取" class="headerlink" title="SQL的where条件提取"></a><strong>SQL的where条件提取</strong></h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在有了以上的t1表之后，接下来就可以在此表上进行SQL查询了，获取自己想要的数据。例如，考虑以下的一条SQL：</p>
<p><code>select * from t1 where b &gt;= 2 and b &lt; 8 and c &gt; 1 and d != 4 and e != ‘a’;</code></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一条比较简单的SQL，一目了然就可以发现where条件使用到了[b,c,d,e]四个字段，而t1表的idx_t1_bcd索引，恰好使用了[b,c,d]这三个字段，那么走idx_t1_bcd索引进行条件过滤，应该是一个不错的选择。接下来，让我们抛弃数据库的思想，直接思考这条SQL的几个关键性问题：</p>
<p><strong>此SQL，覆盖索引idx_t1_bcd上的哪个范围？</strong></p>
<p>起始范围：记录[2,2,2]是第一个需要检查的索引项。索引起始查找范围由b &gt;= 2，c &gt; 1决定。</p>
<p>终止范围：记录[8,8,8]是第一个不需要检查的记录，而之前的记录均需要判断。索引的终止查找范围由b &lt; 8决定；</p>
<p><strong>在确定了查询的起始、终止范围之后，SQL中还有哪些条件可以使用索引idx_t1_bcd过滤？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;根据SQL，固定了索引的查询范围[(2,2,2),(8,8,8))之后，此索引范围中并不是每条记录都是满足where查询条件的。例如：(3,1,1)不满足c &gt; 1的约束；(6,4,4)不满足d != 4的约束。而c，d列，均可在索引idx_t1_bcd中过滤掉不满足条件的索引记录的。</p>
<p>因此，SQL中还可以使用c &gt; 1 and d != 4条件进行索引记录的过滤。</p>
<p><strong>在确定了索引中最终能够过滤掉的条件之后，还有哪些条件是索引无法过滤的？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此问题的答案显而易见，e != ‘a’这个查询条件，无法在索引idx_t1_bcd上进行过滤，因为索引并未包含e列。e列只在堆表上存在，为了过滤此查询条件，必须将已经满足索引查询条件的记录回表，取出表中的e列，然后使用e列的查询条件e != ‘a’进行最终的过滤。</p>
<p>在理解以上的问题解答的基础上，做一个抽象，可总结出一套放置于所有SQL语句而皆准的where查询条件的提取规则：</p>
<p><strong>所有SQL的where条件，均可归纳为3大类：Index Key (First Key &amp; Last Key)，Index Filter，Table Filter。</strong></p>
<p>接下来，让我们来详细分析者3大类分别是如何定义，以及如何提取的。</p>
<p><strong>Index Key</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用于确定SQL查询在索引中的连续范围(起始范围+结束范围)的查询条件，被称之为Index Key。由于一个范围，至少包含一个起始与一个终止，因此Index Key也被拆分为Index First Key和Index Last Key，分别用于定位索引查找的起始，以及索引查询的终止条件。</p>
<p><strong>Index First Key</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用于确定索引查询的起始范围。提取规则：从索引的第一个键值开始，检查其在where条件中是否存在，若存在并且条件是=、&gt;=，则将对应的条件加入Index First Key之中，继续读取索引的下一个键值，使用同样的提取规则；若存在并且条件是&gt;，则将对应的条件加入Index First Key中，同时终止Index First Key的提取；若不存在，同样终止Index First Key的提取。</p>
<p>针对上面的SQL，应用这个提取规则，提取出来的Index First Key为(b &gt;= 2, c &gt; 1)。由于c的条件为 &gt;，提取结束，不包括d。</p>
<p><strong>Index Last Key</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Last Key的功能与Index First Key正好相反，用于确定索引查询的终止范围。提取规则：从索引的第一个键值开始，检查其在where条件中是否存在，若存在并且条件是=、&lt;=，则将对应条件加入到Index Last Key中，继续提取索引的下一个键值，使用同样的提取规则；若存在并且条件是 &lt; ，则将条件加入到Index Last Key中，同时终止提取；若不存在，同样终止Index Last Key的提取。</p>
<p>针对上面的SQL，应用这个提取规则，提取出来的Index Last Key为(b &lt; 8)，由于是 &lt; 符号，因此提取b之后结束。</p>
<p><strong>Index Filter</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在完成Index Key的提取之后，我们根据where条件固定了索引的查询范围，但是此范围中的项，并不都是满足查询条件的项。在上面的SQL用例中，(3,1,1)，(6,4,4)均属于范围中，但是又均不满足SQL的查询条件。</p>
<p>Index Filter的提取规则：同样从索引列的第一列开始，检查其在where条件中是否存在：若存在并且where条件仅为 =，则跳过第一列继续检查索引下一列，下一索引列采取与索引第一列同样的提取规则；若where条件为 &gt;=、&gt;、&lt;、&lt;= 其中的几种，则跳过索引第一列，将其余where条件中索引相关列全部加入到Index Filter之中；若索引第一列的where条件包含 =、&gt;=、&gt;、&lt;、&lt;= 之外的条件，则将此条件以及其余where条件中索引相关列全部加入到Index Filter之中；若第一列不包含查询条件，则将所有索引相关条件均加入到Index Filter之中。</p>
<p>针对上面的用例SQL，索引第一列只包含 &gt;=、&lt; 两个条件，因此第一列可跳过，将余下的c、d两列加入到Index Filter中。因此获得的Index Filter为 c &gt; 1 and d != 4 。</p>
<p><strong>Table Filter</strong></p>
<p>T&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;able Filter是最简单，最易懂，也是提取最为方便的。提取规则：所有不属于索引列的查询条件，均归为Table Filter之中。</p>
<p>同样，针对上面的用例SQL，Table Filter就为 e != ‘a’。</p>
<h2 id="Index-Key-Index-Filter-Table-Filter小结"><a href="#Index-Key-Index-Filter-Table-Filter小结" class="headerlink" title="Index Key/Index Filter/Table Filter小结"></a><strong>Index Key/Index Filter/Table Filter小结</strong></h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SQL语句中的where条件，使用以上的提取规则，最终都会被提取到Index Key (First Key &amp; Last Key)，Index Filter与Table Filter之中。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index First Key，只是用来定位索引的起始范围，因此只在索引第一次Search Path(沿着索引B+树的根节点一直遍历，到索引正确的叶节点位置)时使用，一次判断即可；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Last Key，用来定位索引的终止范围，因此对于起始范围之后读到的每一条索引记录，均需要判断是否已经超过了Index Last Key的范围，若超过，则当前查询结束；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Filter，用于过滤索引查询范围中不满足查询条件的记录，因此对于索引范围中的每一条记录，均需要与Index Filter进行对比，若不满足Index Filter则直接丢弃，继续读取索引下一条记录；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table Filter，则是最后一道where条件的防线，用于过滤通过前面索引的层层考验的记录，此时的记录已经满足了Index First Key与Index Last Key构成的范围，并且满足Index Filter的条件，回表读取了完整的记录，判断完整记录是否满足Table Filter中的查询条件，同样的，若不满足，跳过当前记录，继续读取索引的下一条记录，若满足，则返回记录，此记录满足了where的所有条件，可以返回给前端用户。</p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a><strong>结语</strong></h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在读完、理解了以上内容之后，详细大家对于数据库如何提取where中的查询条件，如何将where中的查询条件提取为Index Key，Index Filter，Table Filter有了深刻的认识。以后在撰写SQL语句时，可以对照表的定义，尝试自己提取对应的where条件，与最终的SQL执行计划对比，逐步强化自己的理解。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，我们也可以回答文章开始提出的一个问题：MySQL 5.6中引入的Index Condition Pushdown，究竟是将什么Push Down到索引层面进行过滤呢？对了，答案是Index Filter。在MySQL 5.6之前，并不区分Index Filter与Table Filter，统统将Index First Key与Index Last Key范围内的索引记录，回表读取完整记录，然后返回给MySQL Server层进行过滤。而在MySQL 5.6之后，Index Filter与Table Filter分离，Index Filter下降到InnoDB的索引层面进行过滤，减少了回表与返回MySQL Server层的记录交互开销，提高了SQL的执行效率。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/03/10/MySQL 加锁处理分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/10/MySQL 加锁处理分析/" itemprop="url">MySQL 加锁处理分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-10T12:12:57+08:00">
                2019-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/锁/" itemprop="url" rel="index">
                    <span itemprop="name">锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL-加锁处理分析"><a href="#MySQL-加锁处理分析" class="headerlink" title="MySQL 加锁处理分析"></a>MySQL 加锁处理分析</h1><blockquote>
<p>原文地址：<a href="http://hedengcheng.com/?p=771#_Toc374698311" target="_blank" rel="noopener">http://hedengcheng.com/?p=771#_Toc374698311</a></p>
</blockquote>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL/InnoDB的加锁分析，一直是一个比较困难的话题。我在工作过程中，经常会有同事咨询这方面的问题。同时，微博上也经常会收到MySQL锁相关的私信，让我帮助解决一些死锁的问题。本文，准备就MySQL/InnoDB的加锁问题，展开较为深入的分析与讨论，主要是介绍一种思路，运用此思路，拿到任何一条SQL语句，都能完整的分析出这条语句会加什么锁？会有什么样的使用风险？甚至是分析线上的一个死锁场景，了解死锁产生的原因。</p>
<p><strong>注：</strong>MySQL是一个支持插件式存储引擎的数据库系统。本文下面的所有介绍，都是基于InnoDB存储引擎，其他引擎的表现，会有较大的区别。</p>
<h2 id="MVCC：Snapshot-Read-vs-Current-Read"><a href="#MVCC：Snapshot-Read-vs-Current-Read" class="headerlink" title="MVCC：Snapshot Read vs Current Read"></a>MVCC：Snapshot Read vs Current Read</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL InnoDB存储引擎，实现的是<strong>基于多版本的并发控制协议</strong>——MVCC (<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank" rel="noopener">Multi-Version Concurrency Control</a>) (注：与MVCC相对的，是基于锁的并发控制，Lock-Based Concurrency Control)。MVCC最大的好处，相信也是耳熟能详：<strong>读不加锁，读写不冲突</strong>。在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能，这也是为什么现阶段，几乎所有的RDBMS，都支持了MVCC。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在MVCC并发控制中，读操作可以分成两类：快照读 (snapshot read)与当前读 (current read)。快照读，读取的是记录的可见版本 (有可能是历史版本)，不用加锁。<strong>当前读，读取的是记录的最新版本，并且，当前读返回的记录，都会加上锁，保证其他事务不会再并发修改这条记录</strong>。</p>
<p>在一个支持MVCC并发控制的系统中，哪些读操作是快照读？哪些操作又是当前读呢？以MySQL InnoDB为例：</p>
<ul>
<li><p><strong>快照读：</strong>简单的select操作，属于快照读，不加锁。(当然，也有例外，下面会分析)</p>
<ul>
<li>select * from table where ?;</li>
</ul>
</li>
<li><p><strong>当前读：</strong>特殊的读操作，插入/更新/删除操作，属于当前读，需要加锁。</p>
<ul>
<li>select * from table where ? lock in share mode;</li>
<li>select * from table where ? for update;</li>
<li>insert into table values (…);</li>
<li>update table set ? where ?;</li>
<li>delete from table where ?;</li>
</ul>
<p>所有以上的语句，都属于当前读，读取记录的最新版本。并且，读取之后，还需要保证其他并发事务不能修改当前记录，对读取记录加锁。其中，除了第一条语句，对读取记录加S锁 (共享锁)外，其他的操作，都加的是X锁 (排它锁)。</p>
</li>
</ul>
<p>为什么将 插入/更新/删除 操作，都归为当前读？可以看看下面这个 更新 操作，在数据库中的执行流程：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/1.jpg" alt="update 执行流程"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从图中，可以看到，一个Update操作的具体流程。当Update SQL被发给MySQL后，MySQL Server会根据where条件，读取第一条满足条件的记录，然后InnoDB引擎会将第一条记录返回，并加锁 (current read)。待MySQL Server收到这条加锁的记录之后，会再发起一个Update请求，更新这条记录。一条记录操作完成，再读取下一条记录，直至没有满足条件的记录为止。因此，Update操作内部，就包含了一个当前读。同理，Delete操作也一样。Insert操作会稍微有些不同，简单来说，就是Insert操作可能会触发Unique Key的冲突检查，也会进行一个当前读。</p>
<p><strong>注</strong>：根据上图的交互，针对一条当前读的SQL语句，InnoDB与MySQL Server的交互，是一条一条进行的，因此，加锁也是一条一条进行的。先对一条满足条件的记录加锁，返回给MySQL Server，做一些DML操作；然后在读取下一条加锁，直至读取完毕。</p>
<h2 id="Cluster-Index：聚簇索引"><a href="#Cluster-Index：聚簇索引" class="headerlink" title="Cluster Index：聚簇索引"></a>Cluster Index：聚簇索引</h2><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InnoDB存储引擎的数据组织方式，是聚簇索引表：<strong>完整的记录，存储在主键索引中，通过主键索引，就可以获取记录所有的列</strong>。关于聚簇索引表的组织方式，可以参考MySQL的官方文档：<a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-index-types.html" target="_blank" rel="noopener">Clustered and Secondary Indexes</a> 。本文假设读者对这个，已经有了一定的认识，就不再做具体的介绍。接下来的部分，主键索引/聚簇索引 两个名称，会有一些混用，望读者知晓。</p>
<h2 id="2PL：Two-Phase-Locking"><a href="#2PL：Two-Phase-Locking" class="headerlink" title="2PL：Two-Phase Locking"></a>2PL：Two-Phase Locking</h2><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;传统RDBMS加锁的一个原则，就是<strong>2PL (二阶段锁)</strong>：<a href="http://en.wikipedia.org/wiki/Two-phase_locking" target="_blank" rel="noopener">Two-Phase Locking</a>。相对而言，2PL比较容易理解，说的是锁操作分为两个阶段：加锁阶段与解锁阶段，并且<strong>保证加锁阶段与解锁阶段不相交</strong>。下面，仍旧以MySQL为例，来简单看看2PL在MySQL中的实现。</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/2.jpg" alt="2PL">]</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从上图可以看出，2PL就是将加锁/解锁分为两个完全不相交的阶段。加锁阶段：只加锁，不放锁。解锁阶段：只放锁，不加锁。</p>
<h2 id="Isolation-Level"><a href="#Isolation-Level" class="headerlink" title="Isolation Level"></a>Isolation Level</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;隔离级别：<a href="http://en.wikipedia.org/wiki/Isolation_(database_systems" target="_blank" rel="noopener">Isolation Level</a>)，也是RDBMS的一个关键特性。相信对数据库有所了解的朋友，对于4种隔离级别：Read Uncommited，Read Committed，Repeatable Read，Serializable，都有了深入的认识。本文不打算讨论数据库理论中，是如何定义这4种隔离级别的含义的，而是跟大家介绍一下MySQL/InnoDB是如何定义这4种隔离级别的。</p>
<p>MySQL/InnoDB定义的4种隔离级别：</p>
<ul>
<li><p><strong>Read Uncommited</strong></p>
<p>可以读取未提交记录。此隔离级别，不会使用，忽略。</p>
</li>
<li><p><strong>Read Committed (RC)</strong></p>
<p>快照读忽略，本文不考虑。</p>
<p>针对当前读，<strong>RC隔离级别保证对读取到的记录加锁 (记录锁)</strong>，存在幻读现象。</p>
</li>
<li><p><strong>Repeatable Read (RR)</strong></p>
<p>快照读忽略，本文不考虑。</p>
<p>针对当前读，<strong>RR隔离级别保证对读取到的记录加锁 (记录锁)，同时保证对读取的范围加锁，新的满足查询条件的记录不能够插入 (间隙锁)</strong>，不存在幻读现象。</p>
</li>
<li><p><strong>Serializable</strong></p>
<p>从MVCC并发控制退化为基于锁的并发控制。不区别快照读与当前读，所有的读操作均为当前读，读加读锁 (S锁)，写加写锁 (X锁)。</p>
<p>Serializable隔离级别下，读写冲突，因此并发度急剧下降，在MySQL/InnoDB下不建议使用。</p>
</li>
</ul>
<h2 id="一条简单SQL的加锁实现分析"><a href="#一条简单SQL的加锁实现分析" class="headerlink" title="一条简单SQL的加锁实现分析"></a>一条简单SQL的加锁实现分析</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在介绍完一些背景知识之后，本文接下来将选择几个有代表性的例子，来详细分析MySQL的加锁处理。当然，还是从最简单的例子说起。经常有朋友发给我一个SQL，然后问我，这个SQL加什么锁？就如同下面两条简单的SQL，他们加什么锁？</p>
<ul>
<li><strong>SQL1：</strong>select * from t1 where id = 10;</li>
<li><strong>SQL2：</strong>delete from t1 where id = 10;</li>
</ul>
<p>针对这个问题，该怎么回答？我能想象到的一个答案是：</p>
<ul>
<li><strong>SQL1：</strong>不加锁。因为MySQL是使用多版本并发控制的，读不加锁。</li>
<li><strong>SQL2：</strong>对id = 10的记录加写锁 (走主键索引)。</li>
</ul>
<p>这个答案对吗？说不上来。即可能是正确的，也有可能是错误的，已知条件不足，这个问题没有答案。如果让我来回答这个问题，我必须还要知道以下的一些前提，前提不同，我能给出的答案也就不同。要回答这个问题，还缺少哪些前提条件？</p>
<ul>
<li><p><strong>前提一：</strong>id列是不是主键？</p>
</li>
<li><p><strong>前提二：</strong>当前系统的隔离级别是什么？</p>
</li>
<li><p><strong>前提三：</strong>id列如果不是主键，那么id列上有索引吗？</p>
</li>
<li><p><strong>前提四：</strong>id列上如果有二级索引，那么这个索引是唯一索引吗？</p>
</li>
<li><p><strong>前提五：</strong>两个SQL的执行计划是什么？索引扫描？全表扫描？</p>
</li>
</ul>
<p>没有这些前提，直接就给定一条SQL，然后问这个SQL会加什么锁，都是很业余的表现。而当这些问题有了明确的答案之后，给定的SQL会加什么锁，也就一目了然。下面，我将这些问题的答案进行组合，然后按照从易到难的顺序，逐个分析每种组合下，对应的SQL会加哪些锁？</p>
<p><strong>注：</strong>下面的这些组合，我做了一个前提假设，也就是有索引时，执行计划一定会选择使用索引进行过滤 (索引扫描)。但实际情况会复杂很多，真正的执行计划，还是需要根据MySQL输出的为准。</p>
<ul>
<li><strong>组合一：</strong>id列是主键，RC隔离级别</li>
<li><strong>组合二：</strong>id列是二级唯一索引，RC隔离级别</li>
<li><strong>组合三：</strong>id列是二级非唯一索引，RC隔离级别</li>
<li><strong>组合四：</strong>id列上没有索引，RC隔离级别</li>
<li><strong>组合五：</strong>id列是主键，RR隔离级别</li>
<li><strong>组合六：</strong>id列是二级唯一索引，RR隔离级别</li>
<li><strong>组合七：</strong>id列是二级非唯一索引，RR隔离级别</li>
<li><strong>组合八：</strong>id列上没有索引，RR隔离级别</li>
<li><strong>组合九：</strong>Serializable隔离级别</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;排列组合还没有列举完全，但是看起来，已经很多了。真的有必要这么复杂吗？事实上，要分析加锁，就是需要这么复杂。但是从另一个角度来说，只要你选定了一种组合，SQL需要加哪些锁，其实也就确定了。接下来，就让我们来逐个分析这9种组合下的SQL加锁策略。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：在前面八种组合下，也就是RC，RR隔离级别下，SQL1：select操作均不加锁，采用的是快照读，因此在下面的讨论中就忽略了，主要讨论SQL2：delete操作的加锁。</p>
<h2 id="锁情况分析"><a href="#锁情况分析" class="headerlink" title="锁情况分析"></a>锁情况分析</h2><h3 id="组合一：id主键-RC"><a href="#组合一：id主键-RC" class="headerlink" title="组合一：id主键+RC"></a>组合一：id主键+RC</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个组合，是最简单，最容易分析的组合。id是主键，Read Committed隔离级别，给定SQL：delete from t1 where id = 10; 只需要将主键上，id = 10的记录加上X锁即可。如下图所示：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/3.jpg" alt="id主键+rc"></p>
<p><strong>结论：</strong>id是主键时，此SQL只需要在id=10这条记录上加X锁即可。</p>
<h3 id="组合二：id唯一索引-RC"><a href="#组合二：id唯一索引-RC" class="headerlink" title="组合二：id唯一索引+RC"></a>组合二：id唯一索引+RC</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个组合，id不是主键，而是一个Unique的二级索引键值。那么在RC隔离级别下，delete from t1 where id = 10; 需要加什么锁呢？见下图：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/4.jpg" alt="id unique+rc"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此组合中，id是unique索引，而主键是name列。此时，加锁的情况由于组合一有所不同。由于id是unique索引，因此delete语句会选择走id列的索引进行where条件的过滤，在找到id=10的记录后，首先会将unique索引上的id=10索引记录加上X锁，同时，会根据读取到的name列，回主键索引(聚簇索引)，然后将聚簇索引上的name = ‘d’ 对应的主键索引项加X锁。为什么聚簇索引上的记录也要加锁？试想一下，如果并发的一个SQL，是通过主键索引来更新：update t1 set id = 100 where name = ‘d’; 此时，如果delete语句没有将主键索引上的记录加锁，那么并发的update就会感知不到delete语句的存在，违背了同一记录上的更新/删除需要串行执行的约束。</p>
<p><strong>结论</strong>：若id列是unique列，其上有unique索引。那么SQL需要加两个X锁，一个对应于id unique索引上的id = 10的记录，另一把锁对应于聚簇索引上的[name=’d’,id=10]的记录。</p>
<h3 id="组合三：id非唯一索引-RC"><a href="#组合三：id非唯一索引-RC" class="headerlink" title="组合三：id非唯一索引+RC"></a>组合三：id非唯一索引+RC</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;相对于组合一、二，组合三又发生了变化，隔离级别仍旧是RC不变，但是id列上的约束又降低了，id列不再唯一，只有一个普通的索引。假设delete from t1 where id = 10; 语句，仍旧选择id列上的索引进行过滤where条件，那么此时会持有哪些锁？同样见下图：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/5.jpg" alt="id 非唯一索引+rc"></p>
<p>根据此图，可以看到，首先，id列索引上，满足id = 10查询条件的记录，均已加锁。同时，这些记录对应的主键索引上的记录也都加上了锁。与组合二唯一的区别在于，组合二最多只有一个满足等值查询的记录，而组合三会将所有满足查询条件的记录都加锁。</p>
<p><strong>结论</strong>：若id列上有非唯一索引，那么对应的所有满足SQL查询条件的记录，都会被加锁。同时，这些记录在主键索引上的记录，也会被加锁。</p>
<h3 id="组合四：id无索引-RC"><a href="#组合四：id无索引-RC" class="headerlink" title="组合四：id无索引+RC"></a>组合四：id无索引+RC</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;相对于前面三个组合，这是一个比较特殊的情况。id列上没有索引，where id = 10;这个过滤条件，没法通过索引进行过滤，那么只能走全表扫描做过滤。对应于这个组合，SQL会加什么锁？或者是换句话说，全表扫描时，会加什么锁？这个答案也有很多：有人说会在表上加X锁；有人说会将聚簇索引上，选择出来的id = 10;的记录加上X锁。那么实际情况呢？请看下图：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/6.jpg" alt="id 无索引+rc"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于id列上没有索引，因此只能走聚簇索引，进行全部扫描。从图中可以看到，满足删除条件的记录有两条，但是，聚簇索引上所有的记录，都被加上了X锁。无论记录是否满足条件，全部被加上X锁。既不是加表锁，也不是在满足条件的记录上加行锁。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有人可能会问？为什么不是只在满足条件的记录上加锁呢？这是由于MySQL的实现决定的。<strong>如果一个条件无法通过索引快速过滤，那么存储引擎层面就会将所有记录加锁后返回，然后由MySQL Server层进行过滤。因此也就把所有的记录，都锁上了</strong>。</p>
<p>注：在实际的实现中，MySQL有一些改进，<strong>在MySQL Server过滤条件，发现不满足后，会调用unlock_row方法，把不满足条件的记录放锁 (违背了2PL的约束)。这样做，保证了最后只会持有满足条件记录上的锁，但是每条记录的加锁操作还是不能省略的</strong>。</p>
<p><strong>结论：</strong>若id列上没有索引，SQL会走聚簇索引的全扫描进行过滤，由于过滤是由MySQL Server层面进行的。因此每条记录，无论是否满足条件，都会被加上X锁。但是，为了效率考量，MySQL做了优化，对于不满足条件的记录，会在判断后放锁，最终持有的，是满足条件的记录上的锁，但是不满足条件的记录上的加锁/放锁动作不会省略。同时，优化也违背了2PL的约束。</p>
<h3 id="组合五：id主键-RR"><a href="#组合五：id主键-RR" class="headerlink" title="组合五：id主键+RR"></a>组合五：id主键+RR</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;组合五，id列是主键列，Repeatable Read隔离级别，针对delete from t1 where id = 10; 这条SQL，加锁与组合一：<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%B8%80%EF%BC%9Aid%E4%B8%BB%E9%94%AE+RC" target="_blank" rel="noopener">id主键，Read Committed</a>一致。</p>
<h3 id="组合六：id唯一索引-RR"><a href="#组合六：id唯一索引-RR" class="headerlink" title="组合六：id唯一索引+RR"></a>组合六：id唯一索引+RR</h3><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与组合五类似，组合六的加锁，与组合二：<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%BA%8C%EF%BC%9Aid%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95+RC" target="_blank" rel="noopener">id唯一索引，Read Committed</a>一致。两个X锁，id唯一索引满足条件的记录上一个，对应的聚簇索引上的记录一个。</p>
<h3 id="组合七：id非唯一索引-RR"><a href="#组合七：id非唯一索引-RR" class="headerlink" title="组合七：id非唯一索引+RR"></a>组合七：id非唯一索引+RR</h3><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还记得前面提到的MySQL的四种隔离级别的区别吗？<strong>RC隔离级别允许幻读，而RR隔离级别，不允许存在幻读</strong>。但是在组合五、组合六中，加锁行为又是与RC下的加锁行为完全一致。那么RR隔离级别下，如何防止幻读呢？问题的答案，就在组合七中揭晓。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;组合七，Repeatable Read隔离级别，id上有一个非唯一索引，执行delete from t1 where id = 10; 假设选择id列上的索引进行条件过滤，最后的加锁行为，是怎么样的呢？同样看下面这幅图：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/7.jpg" alt="id 非唯一索引 + rr"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此图，相对于组合三：<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E4%B8%89%EF%BC%9Aid%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95+RC" target="_blank" rel="noopener">id列上非唯一锁，Read Committed</a>看似相同，其实却有很大的区别。最大的区别在于，这幅图中多了一个GAP锁，而且GAP锁看起来也不是加在记录上的，倒像是加载两条记录之间的位置，GAP锁有何用？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实这个多出来的GAP锁，就是RR隔离级别，相对于RC隔离级别，不会出现幻读的关键。确实，GAP锁锁住的位置，也不是记录本身，而是两条记录之间的GAP。所谓幻读，就是同一个事务，连续做两次当前读 (例如：select * from t1 where id = 10 for update;)，那么这两次当前读返回的是完全相同的记录 (记录数量一致，记录本身也一致)，第二次的当前读，不会比第一次返回更多的记录 (幻象)。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如何保证两次当前读返回一致的记录，那就需要在第一次当前读与第二次当前读之间，其他的事务不会插入新的满足条件的记录并提交</strong>。为了实现这个功能，GAP锁应运而生。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如图中所示，有哪些位置可以插入新的满足条件的项 (id = 10)，考虑到B+树索引的有序性，满足条件的项一定是连续存放的。记录[6,c]之前，不会插入id=10的记录；[6,c]与[10,b]间可以插入[10, aa]；[10,b]与[10,d]间，可以插入新的[10,bb],[10,c]等；[10,d]与[11,f]间可以插入满足条件的[10,e],[10,z]等；而[11,f]之后也不会插入满足条件的记录。因此，为了保证[6,c]与[10,b]间，[10,b]与[10,d]间，[10,d]与[11,f]不会插入新的满足条件的记录，MySQL选择了用GAP锁，将这三个GAP给锁起来。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Insert操作，如insert [10,aa]，首先会定位到[6,c]与[10,b]间，然后在插入前，会检查这个GAP是否已经被锁上，如果被锁上，则Insert不能插入记录。因此，通过第一遍的当前读，不仅将满足条件的记录锁上 (X锁)，与组合三类似。同时还是增加3把GAP锁，将可能插入满足条件记录的3个<strong>GAP给锁上，保证后续的Insert不能插入新的id=10的记录，也就杜绝了同一事务的第二次当前读，出现幻象的情况</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有心的朋友看到这儿，可以会问：既然防止幻读，需要靠GAP锁的保护，为什么组合五、组合六，也是RR隔离级别，却不需要加GAP锁呢？</p>
<p>首先，这是一个好问题。其次，回答这个问题，也很简单。<strong>GAP锁的目的，是为了防止同一事务的两次当前读，出现幻读的情况</strong>。而组合五，id是主键；组合六，id是unique键，都能够保证唯一性。一个等值查询，最多只能返回一条记录，而且新的相同取值的记录，一定不会在新插入进来，因此也就避免了GAP锁的使用。其实，针对此问题，还有一个更深入的问题：如果组合五、组合六下，<strong>针对SQL：select * from t1 where id = 10 for update; 第一次查询，没有找到满足查询条件的记录，那么GAP锁是否还能够省略？</strong>此问题留给大家思考。</p>
<p><strong>结论：</strong>Repeatable Read隔离级别下，id列上有一个非唯一索引，对应SQL：delete from t1 where id = 10; 首先，通过id索引定位到第一条满足查询条件的记录，加记录上的X锁，加GAP上的GAP锁，然后加主键聚簇索引上的记录X锁，然后返回；然后读取下一条，重复进行。直至进行到第一条不满足条件的记录[11,f]，此时，不需要加记录X锁，但是仍旧需要加GAP锁，最后返回结束。</p>
<h3 id="组合八：id无索引-RR"><a href="#组合八：id无索引-RR" class="headerlink" title="组合八：id无索引+RR"></a>组合八：id无索引+RR</h3><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;组合八，Repeatable Read隔离级别下的最后一种情况，id列上没有索引。此时SQL：delete from t1 where id = 10; 没有其他的路径可以选择，只能进行全表扫描。最终的加锁情况，如下图所示：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/8.jpg" alt="id 无索引+rr"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如图，这是一个很恐怖的现象。首先，聚簇索引上的所有记录，都被加上了X锁。其次，聚簇索引每条记录间的间隙(GAP)，也同时被加上了GAP锁。这个示例表，只有6条记录，一共需要6个记录锁，7个GAP锁。试想，如果表上有1000万条记录呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这种情况下，这个表上，除了不加锁的快照度，其他任何加锁的并发SQL，均不能执行，不能更新，不能删除，不能插入，全表被锁死。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，跟组合四：[<a href="http://hedengcheng.com/?p=771#_%E7%BB%84%E5%90%88%E5%9B%9B%EF%BC%9Aid%E6%97%A0%E7%B4%A2%E5%BC%95+RC" target="_blank" rel="noopener">id无索引, Read Committed</a>]类似，这个情况下，MySQL也做了一些优化，就是所谓的semi-consistent read。semi-consistent read开启的情况下，对于不满足查询条件的记录，MySQL会提前放锁。针对上面的这个用例，就是除了记录[d,10]，[g,10]之外，所有的记录锁都会被释放，同时不加GAP锁。semi-consistent read如何触发：要么是read committed隔离级别；要么是Repeatable Read隔离级别，同时设置了 <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html" target="_blank" rel="noopener">innodb_locks_unsafe_for_binlog</a> 参数。更详细的关于semi-consistent read的介绍，可参考我之前的一篇博客：<a href="http://hedengcheng.com/?p=220" target="_blank" rel="noopener">MySQL+InnoDB semi-consitent read原理及实现分析</a> 。</p>
<p><strong>结论：</strong>在Repeatable Read隔离级别下，如果进行全表扫描的当前读，那么会锁上表中的所有记录，同时会锁上聚簇索引内的所有GAP，杜绝所有的并发 更新/删除/插入 操作。当然，也可以通过触发semi-consistent read，来缓解加锁开销与并发影响，但是semi-consistent read本身也会带来其他问题，不建议使用。</p>
<h3 id="组合九：Serializable"><a href="#组合九：Serializable" class="headerlink" title="组合九：Serializable"></a>组合九：Serializable</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对前面提到的简单的SQL，最后一个情况：Serializable隔离级别。对于SQL2：<code>delete from t1 where id = 10</code>; 来说，Serializable隔离级别与Repeatable Read隔离级别完全一致，因此不做介绍。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Serializable隔离级别，影响的是<code>SQL1：select * from t1 where id = 10;</code> 这条SQL，在RC，RR隔离级别下，都是快照读，不加锁。但是在Serializable隔离级别，SQL1会加读锁，也就是说快照读不复存在，MVCC并发控制降级为Lock-Based CC。</p>
<p><strong>结论：</strong>在MySQL/InnoDB中，所谓的读不加锁，并不适用于所有的情况，而是隔离级别相关的。Serializable隔离级别，读不加锁就不再成立，所有的读操作，都是当前读。</p>
<h2 id="一条复杂的SQL"><a href="#一条复杂的SQL" class="headerlink" title="一条复杂的SQL"></a>一条复杂的SQL</h2><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;写到这里，其实MySQL的加锁实现也已经介绍的八八九九。只要将本文上面的分析思路，大部分的SQL，都能分析出其会加哪些锁。而这里，再来看一个稍微复杂点的SQL，用于说明MySQL加锁的另外一个逻辑。SQL用例如下：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/9.jpg" alt="复杂SQL"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如图中的SQL，会加什么锁？假定在Repeatable Read隔离级别下 (Read Committed隔离级别下的加锁情况，留给读者分析。)，同时，假设SQL走的是idx_t1_pu索引。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在详细分析这条SQL的加锁情况前，还需要有一个知识储备，那就是一个SQL中的where条件如何拆分？具体的介绍，建议阅读我之前的一篇文章：<a href="http://hedengcheng.com/?p=577" target="_blank" rel="noopener">SQL中的where条件，在数据库中提取与应用浅析</a> 。在这里，我直接给出分析后的结果：</p>
<ul>
<li><strong>Index key：</strong>pubtime &gt; 1 and puptime &lt; 20。此条件，用于确定SQL在idx_t1_pu索引上的查询范围。</li>
<li><p><strong>Index Filter：</strong>userid = ‘hdc’ 。此条件，可以在idx_t1_pu索引上进行过滤，但不属于Index Key。</p>
</li>
<li><p><strong>Table Filter：</strong>comment is not NULL。此条件，在idx_t1_pu索引上无法过滤，只能在聚簇索引上过滤。</p>
</li>
</ul>
<p>在分析出SQL where条件的构成之后，再来看看这条SQL的加锁情况 (RR隔离级别)，如下图所示：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/10.jpg" alt="SQL加锁"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从图中可以看出，在Repeatable Read隔离级别下，由Index Key所确定的范围，被加上了GAP锁；Index Filter锁给定的条件 (userid = ‘hdc’)何时过滤，视MySQL的版本而定，在MySQL 5.6版本之前，不支持<a href="http://dev.mysql.com/doc/refman/5.6/en/index-condition-pushdown-optimization.html" target="_blank" rel="noopener">Index Condition Pushdown</a>(ICP)，因此Index Filter在MySQL Server层过滤，在5.6后支持了Index Condition Pushdown，则在index上过滤。若不支持ICP，不满足Index Filter的记录，也需要加上记录X锁，若支持ICP，则不满足Index Filter的记录，无需加记录X锁 (图中，用红色箭头标出的X锁，是否要加，视是否支持ICP而定)；而Table Filter对应的过滤条件，则在聚簇索引中读取后，在MySQL Server层面过滤，因此聚簇索引上也需要X锁。最后，选取出了一条满足条件的记录[8,hdc,d,5,good]，但是加锁的数量，要远远大于满足条件的记录数量。</p>
<p><strong>结论：</strong>在Repeatable Read隔离级别下，针对一个复杂的SQL，首先需要提取其where条件。<strong>Index Key确定的范围，需要加上GAP锁</strong>；Index Filter过滤条件，视MySQL版本是否支持ICP，若支持ICP，则不满足Index Filter的记录，不加X锁，否则需要X锁；Table Filter过滤条件，无论是否满足，都需要加X锁。</p>
<h3 id="死锁原理与分析"><a href="#死锁原理与分析" class="headerlink" title="死锁原理与分析"></a>死锁原理与分析</h3><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文前面的部分，基本上已经涵盖了MySQL/InnoDB所有的加锁规则。深入理解MySQL如何加锁，有两个比较重要的作用：</p>
<ul>
<li>可以根据MySQL的加锁规则，写出不会发生死锁的SQL；</li>
<li>可以根据MySQL的加锁规则，定位出线上产生死锁的原因；</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面，来看看两个死锁的例子 (一个是两个Session的两条SQL产生死锁；另一个是两个Session的一条SQL，产生死锁)：</p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/11.jpg" alt="死锁用例"></p>
<p><img src="//blog.com/2019/03/10/MySQL 加锁处理分析/12.jpg" alt="死锁用例2"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上面的两个死锁用例。第一个非常好理解，也是最常见的死锁，每个事务执行两条SQL，分别持有了一把锁，然后加另一把锁，产生死锁。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二个用例，虽然每个Session都只有一条语句，仍旧会产生死锁。要分析这个死锁，首先必须用到本文前面提到的MySQL加锁的规则。针对Session 1，从name索引出发，读到的[hdc, 1]，[hdc, 6]均满足条件，不仅会加name索引上的记录X锁，而且会加聚簇索引上的记录X锁，加锁顺序为先[1,hdc,100]，后[6,hdc,10]。而Session 2，从pubtime索引出发，[10,6],[100,1]均满足过滤条件，同样也会加聚簇索引上的记录X锁，加锁顺序为[6,hdc,10]，后[1,hdc,100]。发现没有，跟Session 1的加锁顺序正好相反，如果两个Session恰好都持有了第一把锁，请求加第二把锁，死锁就发生了。</p>
<p><strong>结论：</strong>死锁的发生与否，并不在于事务中有多少条SQL语句，<strong>死锁的关键在于</strong>：两个(或以上)的Session<strong>加锁的顺序</strong>不一致。而使用本文上面提到的，分析MySQL每条SQL语句的加锁规则，分析出每条语句的加锁顺序，然后检查多个并发SQL间是否存在以相反的顺序加锁的情况，就可以分析出各种潜在的死锁情况，也可以分析出线上死锁发生的原因。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;写到这儿，本文也告一段落，做一个简单的总结，要做的完全掌握MySQL/InnoDB的加锁规则，甚至是其他任何数据库的加锁规则，需要具备以下的一些知识点：</p>
<ul>
<li>了解数据库的一些基本理论知识：数据的存储格式 (堆组织表 vs 聚簇索引表)；并发控制协议 (MVCC vs Lock-Based CC)；Two-Phase Locking；数据库的隔离级别定义 (Isolation Level)；</li>
<li>了解SQL本身的执行计划 (主键扫描 vs 唯一键扫描 vs 范围扫描 vs 全表扫描)；</li>
<li>了解数据库本身的一些实现细节 (过滤条件提取；Index Condition Pushdown；Semi-Consistent Read)；</li>
<li>了解死锁产生的原因及分析的方法 (加锁顺序不一致；分析每个SQL的加锁顺序)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/03/10/生活中的Paxos，原来你我都在使用——对Paxos生活化的解读/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/10/生活中的Paxos，原来你我都在使用——对Paxos生活化的解读/" itemprop="url">生活中的Paxos，原来你我都在使用——对Paxos生活化的解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-10T12:12:57+08:00">
                2019-03-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据一致性/" itemprop="url" rel="index">
                    <span itemprop="name">数据一致性</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据一致性/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据一致性/架构/分布式事务/" itemprop="url" rel="index">
                    <span itemprop="name">分布式事务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="生活中的Paxos，原来你我都在使用——对Paxos生活化的解读"><a href="#生活中的Paxos，原来你我都在使用——对Paxos生活化的解读" class="headerlink" title="生活中的Paxos，原来你我都在使用——对Paxos生活化的解读"></a>生活中的Paxos，原来你我都在使用——对Paxos生活化的解读</h1><blockquote>
<p>原文地址：<a href="http://hedengcheng.com/?p=970#more-970" target="_blank" rel="noopener">http://hedengcheng.com/?p=970#more-970</a></p>
</blockquote>
<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前段时间，老婆给家里一岁半的小宝买了一套 克里斯.费利 博士的《宝宝的物理学》丛书，包括 《宝宝的量子物理学》，《宝宝的牛顿力学》，《宝宝的光学》等。小宝爱不释手，天天缠着我们读给他听，在整个过程中我也有很大的收获。在同一时间，由于工作需要，我也一直在啃计算机分布式系统中号称最难理解的协议——<a href="https://en.wikipedia.org/wiki/Paxos_(computer_science" target="_blank" rel="noopener">Paxos</a>)。看PPT、读论文、找相关文章，跟同事讨论，一段时间下来，总的来说也有一定的收获。两件事一结合，当时就萌生了一个想法，我能不能也像 费利 博士这样，用比较通俗易懂的文字（图画做不到，没这个功底…）来描述Paxos，让更多的人能够理解，进而使用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有了这个想法后，一发不可收拾，隔三差五就会从大脑中蹦出来，我也一直在构思应该怎么来写，如何动笔，时至今日，感觉基本上成熟了，也就落笔开始了下面的这篇文章。全文以家庭中的日常生活为背景，以生活中的小例子为引子（<strong>故事情节纯属YY…</strong>），来逐步揭开Paxos协议的原理，希望阅读的朋友们能够从中获益！</p>
<h1 id="什么？老婆要在家里搞民主…"><a href="#什么？老婆要在家里搞民主…" class="headerlink" title="什么？老婆要在家里搞民主…"></a>什么？老婆要在家里搞民主…</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;作为一个典型的技术人，经常被老婆说是一根筋，除了技术，生活中的很多常识都不懂。正因如此，生活中的大小事宜，都是由老婆大人一手操办，而我也落得清闲。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，不久前的一天，老婆不知道哪根筋抽着了，突然跟我说：家里所有的事都有她来操办决策，不太好，希望全家人都能一起来献策献计，家庭也能够更加和谐。当时我一听就懵逼了，这唱的是哪一出戏？连忙回应道：现在这样很好，非常和谐，老婆您能者多劳，家里由你来主政，那一切必须是妥了又妥。但是，很多阅读此文的男性朋友大概也能感同身受，一旦老婆决定的事，那是很难更改的。因此我们全家也就被迫进入了一个全民献计献策的时代…</p>
<h1 id="全民献计第一战，明确分工"><a href="#全民献计第一战，明确分工" class="headerlink" title="全民献计第一战，明确分工"></a>全民献计第一战，明确分工</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先简单介绍下我们家的成员情况。我、老婆、一岁半的小宝，外加老婆的父母（跟我们一起住，帮我们来带小宝），五口人蜗居在杭州的一小间公寓里，过着简单的生活，全家倒也是其乐融融。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;进入全民献计之后，由于小宝还小，自动被我们给忽略了。小宝的外公外婆也发话了：对杭州不熟，因此提不出太多意见，我们的意见提出来，他们一起决策倒是可以。数来数去，全民献计，只有我硬着头皮上了。开始我也反复琢磨，老婆虽然说是这么说来着，但是伴君如伴虎，谁知道真实的想法是啥啊。再加上对于生活中的大小事宜，我也确实缺乏想象。因此刚开始我也不敢对家庭生活中的各种事项妄加评论，还是以老婆大人马首是瞻。但是这样一来，又惹老婆不高兴了。没办法，那就尽量参与，提提意见呗。至此，家庭中的五人，第一轮分工完毕，对于家庭生活中的事宜，老婆和我共两人可以提出意见和建议，老婆、我外加小宝外公外婆可以进行决策，小宝太小，作为被动的接受方。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了能够胜任新的职责，我也是好好恶补了一下各种生活小常识，对于日常中经常讨论的吃什么、去哪玩等问题，我也渐渐能够提出一些比较好的意见，能够被全家所接受。为此，老婆还好好的表扬了我一番。不知道哪一位先贤哲人曾经说过：权利是最好的chun药。太有道理了，对生活一两次指手画脚之后，尝到了瘾头，发现根本停不下来。慢慢的一些问题也凸显了出来，其中最大的一个问题，是家庭四人决策小组，有时候根本达不成一致。经常出现我跟小宝外公赞同一个方案，老婆和小宝外婆赞同另一个方案的情况，2 vs 2，经常僵持不下… 这种事情多了，难免会影响家庭和谐。这个时候，还是小宝的外公识大体，主动要求退出家庭决策圈，剩下3人决策，对于两个提案，总不至于再出现打平手，这个最大的问题也就迎刃而解。经过一段时间的摸索，对老婆提的家庭全民献计的想法，也有了一定的心得，将家庭人员分工明确了下来：</p>
<ul>
<li><strong>提议人：老婆、我。两人。</strong></li>
<li><strong>决策人：老婆、我、小宝外婆。三人。</strong></li>
<li><strong>参与人：小宝外公、小宝，外加小宝外婆、老婆和我。五人。</strong></li>
</ul>
<h1 id="一波未平一波又起，你不能总是变"><a href="#一波未平一波又起，你不能总是变" class="headerlink" title="一波未平一波又起，你不能总是变"></a>一波未平一波又起，你不能总是变</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;家庭人员分工明确之后，全民献计基本上进入了正轨。大部分时候，还是老婆的生活经验最为丰富，建议也最多，三人一起表决通过，皆大欢喜。少部分时候，我也能够灵光一现，出一些鬼点子，老婆和小宝外婆外公也很满意。难得针对一件事，我跟老婆有不同的想法，每个想法先各自占有一票的情况下，小宝的外婆也能选择其中一方，形成2比1的投票结果，少数服从多数。小宝的外公落得清闲，全家人一起干啥他都是乐呵呵。而小宝呢，只要跟妈妈在一起，也是干啥都开心。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看起来是没有任何问题了，但生活上就是这样，一波未平一泼又起，这次出问题的是小宝外婆。小宝外婆有一个特点，比较善良，也比较纠结。在少数几次我跟老婆都有提议的时候，小宝外婆经常会改变主意。以中午出去吃啥为例，一个典型的场景如下：</p>
<p><strong>老婆：中午不想做饭了，出去吃啥好？</strong></p>
<p><strong>我：吃XXX吧，好久没吃了。</strong></p>
<p><strong>小宝外婆：嗯，这个可以。</strong></p>
<p><strong>老婆：这个不好，上次吃过了，还是YYY吧。</strong></p>
<p><strong>小宝外婆：好好，想吃这个好久了。</strong></p>
<p><strong>我：要不ZZZ也不错，我朋友们一直推荐。</strong></p>
<p><strong>小宝外婆：听起来不错，去试试。</strong></p>
<p><strong>老婆：… …</strong></p>
<p><strong>小宝外婆：… …</strong></p>
<p><strong>我：… …</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后，老婆受不了了：妈，您老不能总是变来变去啊… 这不，又得立规矩了不是。经过家庭决策小组（小宝外公也参与了）的多次讨论，在明确分工之外，又新增了一条新规矩：<strong>如果一个方案已经在决策小组中获得了多数派的认同，那么就不能被改变了。</strong>针对前面提到的典型场景，如果使用了这条新规矩，会怎么样：</p>
<p><strong>老婆：中午不想做饭了，出去吃啥好？</strong></p>
<p><strong>我：吃XXX吧，好久没吃了。</strong></p>
<p><strong>小宝外婆：嗯，这个可以。（画外音：此时我的方案已经被我和小宝外婆同时认可，形成多数派，不可更改。）</strong></p>
<p><strong>老婆：这个不好，上次吃过了，还是YYY吧。</strong></p>
<p><strong>小宝外婆：这次就听孩他爸的吧，下次再换YYY。</strong></p>
<p><strong>我：OK。</strong></p>
<p><strong>老婆（内心哪怕不情不愿）：OK。</strong></p>
<p><strong>我：小宝外公，小宝，我们中午去吃XXX咯。（画外音：要把决策下来的方案告诉全家人不是J）</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;感觉一切都搞定了，小宝外婆少了纠结，生活中的各种决策更加高效。虽然家庭生活本不是以高效为目的，但立下规矩，更快的达成一致，也能从某种程度上提升和谐指数J</p>
<h1 id="没想到啊没想到，献计献策变成了处处抢占先机"><a href="#没想到啊没想到，献计献策变成了处处抢占先机" class="headerlink" title="没想到啊没想到，献计献策变成了处处抢占先机"></a>没想到啊没想到，献计献策变成了处处抢占先机</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;生活中和工作中，每当我们认为所有的问题都得到解决时，后面接踵而来的新问题很快就会戳穿这个假象。有了明确的提议人、决策人、参与人的分工，又有了一条新规矩，难道还有什么问题是搞不定的？有，新问题不仅有，而且还不止一个，而且追根溯源，还都是新定的这个规矩惹的祸。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一个暴露的新问题，来自小宝的外婆。前面也提到，小宝外婆为人比较善良，也比较纠结。新规矩实施之后，每当她刚同意一人，形成多数派决议之后，提案就不能被更改了。但是小宝外婆看到另外一人欲言又止，心里又觉得过意不去。而且，每次都这么杀伐果断，没有个稍微纠结一下的机会，也比较痛苦。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果说第一个暴露的问题还好的话，那么第二个问题就更加严重一点。根据新规矩，基本上是谁先给出提案，谁就能达成多数派的决议。发展到后面就演变为我和老婆两个提议人，都不管提议本身的好坏，抢到先机再说。提议质量没法控制，家庭的生活质量也就随之下降，跟我们的本意反而背道而驰了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;没办法，决策小组继续坐下来一起思考应对之策，这次就比较花时间了，全家人一起想了许久，都没有很好地解决办法。正当大家像无头苍蝇一样乱撞之时，不得不说，还是老婆聪明，想到了一个顶顶好的解决办法，这个解决方法，说起来比较简单：</p>
<ul>
<li><p><strong>针对处处抢占先机，一轮决策后就不能更改的情况。将现在的一轮决策改为两轮：</strong></p>
<ul>
<li></li>
<li><strong>第一轮：提议阶段。在这一阶段，我跟老婆可以发起提议，小宝外婆作为决策者，可以选择听谁的提议，但是不做决策。</strong></li>
<li></li>
<li><strong>第二轮：决策阶段。在听了提议后，进入决策阶段，此时小宝外婆可以选择赞成这个提议，也可以选择反对这个提议。</strong></li>
</ul>
</li>
<li><p><strong>两轮中，第一轮提议阶段可以纠结，可以更改。第二轮决策阶段，这个跟前面提到的规矩保持一致：一旦决策阶段达成了多数派的决议，就不能更改。</strong></p>
</li>
</ul>
<p>仍旧是上面生活中同样的例子，现在会变成什么样子：</p>
<p><strong>老婆：中午不想做饭了，出去吃啥好？</strong></p>
<p><strong>我：我有一个提议，大家想不想听听？（第一阶段：提议）</strong></p>
<p><strong>小宝外婆：说来听听。</strong></p>
<p><strong>老婆：登登（我的小名），你的肯定不靠谱，其实我也有一个提议。</strong></p>
<p><strong>小宝外婆：那我们就听听琛琛（老婆的小名）的吧。（画外音：提议阶段，可以更改。这一下小宝外婆的问题解决了。）</strong></p>
<p><strong>我：我的提议是…</strong></p>
<p><strong>小宝外婆：登登，你的提议机会被琛琛抢了。（画外音：提议被抢占，我的当前提议作废。）</strong></p>
<p><strong>老婆：我们去YYY吧。</strong></p>
<p><strong>小宝外婆：好，听你的，去YYY。（画外音：决策阶段，老婆和小宝外婆两人形成了多数派的决策，不能更改了。）</strong></p>
<p><strong>我：其实我本来想说是去XXX的。但既然大家都同意去YYY，那就去YYY。小宝外公，小宝，我们中午去YYY咯！（画外音：提议形成多数派的决议之后，就不能被更改，只能被接受。与此同时，我还有义务将接受的提议传达给参与人，小宝外公和小宝。当然，这里我不能撒谎，如果我撒谎了，跟小宝外公和小宝说我们全家最后决定去XXX，那么这两位就被我带到沟里去了…）</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在老婆给出一个顶顶好的解决办法之后，在原有的基础上，我们全家也尝试实施这个新的两轮的提议方案，在实施的过程中也尝试不断地完善，前面提到的小宝外婆的问题，和一股脑儿处处抢占先机的问题，看起来也都得到了解决。</p>
<h1 id="让我们做一个规范总结吧"><a href="#让我们做一个规范总结吧" class="headerlink" title="让我们做一个规范总结吧"></a>让我们做一个规范总结吧</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;自从老婆提议家庭生活，家庭全体成员一起献计献策之后，也经历了不短的时间。整个过程中，碰到过不少问题，但在全家的同心协力下，也都得到了解决。一天，老婆提议把过程中沉淀下来的经验和规范汇总起来，我想想也有道理，就做了下面这个汇总：</p>
<ul>
<li><p><strong>家庭成员明确不同的分工。提议人、决策人、参与人。</strong></p>
<p>其中，提议人和参与人的人数没有限制，视家庭成员而定。但是，决策人的人数最好为奇数，最小人数是3人（3、5、7、9…。不是奇数的话，会碰到我们最早遇到的两个提议相持不下的情况。）</p>
</li>
</ul>
<ul>
<li><strong>整个过程分为三个阶段。提议阶段，决策阶段，通知阶段。</strong></li>
</ul>
<ul>
<li><strong>提议阶段</strong>：提议人在这个阶段，可以任意发起提议请求。提议请求可以被更改、抢占。简单起见，我们做了一个规定：<strong>新的提议请求可以抢占老的提议请求。</strong></li>
<li><strong>决策阶段</strong>：决策一旦达成了多数派，就不能被更改。与此同时，达成多数派决议的决策人，还有义务将当前达成的决议告知其他提议人和决策人，告诉大家本轮决策已经达成了，不用绞尽脑汁YY新的提议。</li>
<li><strong>通知阶段</strong>：决策达成之后，最后一个阶段就是通知阶段。将当前决策的内容告诉参与人。此时要坚守一点原则：不能说谎。当然，这也是中华民族的传统美德，我们家里是每个人都能做到的…</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;经验和规范总结起来，好像也没有几条，简单易理解，全家人都能遵守。直到有一天，一位搞技术的朋友到我家来做客，无意中聊起这个，我把这个说给他听，他猛地一拍大腿，跳了起来，嚷嚷道：我kao，这不就是分布式Paxos协议的雏形吗！这时我才知道，原来我们家误打误撞之下，也能够跟大师在同一个层面思考问题了J</p>
<h1 id="一切并未结束"><a href="#一切并未结束" class="headerlink" title="一切并未结束"></a>一切并未结束</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规矩是死的，人是活的，哪怕严谨如各种法规和法律，都会有人钻空子，更别提我们家里几个臭皮匠YY出来的了。现有的规矩，后面又逐渐暴露出一些漏洞和不足之处。我在这里列举一二：</p>
<ul>
<li><p><strong>提议更改抢占没完没了</strong></p>
<p>由于提议阶段可以抢占，后来又发生了几次抢占没完没了的事。仍旧是同样的例子：</p>
</li>
</ul>
<p><strong>老婆：中午不想做饭了，出去吃啥好？</strong></p>
<p><strong>我：我有一个提议，大家想不想听听？（1号提议）</strong></p>
<p><strong>小宝外婆：说来听听。</strong></p>
<p><strong>老婆：登登，你的肯定不靠谱，我也有一个提议。（2号提议，抢占1号）</strong></p>
<p><strong>小宝外婆：那我们就听听琛琛的吧。</strong></p>
<p><strong>我：还是听听我这个吧，我的这个提议肯定更好。（3号提议，又抢占2号）</strong></p>
<p><strong>小宝外婆：那好，登登既然坚持，还是听登登的。</strong></p>
<p><strong>老婆：凭什么他的更好，听我的。（4号提议，叒抢占3号）</strong></p>
<p><strong>小宝外婆：…</strong></p>
<p><strong>我：…</strong></p>
<p><strong>老婆：…</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在提议阶段一直相互抢占，一直未进入决策阶段。当然，实际生活中肯定不会出现这种情况，对我来说，这不是找抽吗？但是这个风险本身是存在的。</p>
<ul>
<li><p><strong>碰到连续有几件事情需要决策，效率不高</strong></p>
<p>一般周末全家出去玩，基本上是一个上午、一个下午，或者是完整的一整天。涉及到去哪玩，开车走哪条路，在哪吃饭等一系列需要决策的问题。如果对每一个问题都这么来一轮，效率太低。而且，这些问题相互之间还有关联性，分开来一个个决策也不好。总不能决定去西溪湿地玩，但是却去钱江新城吃饭，太远了也不现实。</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;问题总是用来解决的，而且无论是生活还是工作，都是在解决了一个老问题后，等着新问题的到来。有问题不怕，我们需要锻炼的，是坦然面对层出不穷新问题的心态J</p>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><blockquote>
<p>Paxos made live</p>
<p>架构师需要了解的Paxos原理、历程及实战</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/123/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/123/">123</a><span class="page-number current">124</span><a class="page-number" href="/page/125/">125</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/125/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
