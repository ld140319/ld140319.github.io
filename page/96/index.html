<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/96/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/96/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/分析SQL性能的几种方式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/分析SQL性能的几种方式/" itemprop="url">show 分析SQL性能的几种方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/SQL语句优化/" itemprop="url" rel="index">
                    <span itemprop="name">SQL语句优化</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/SQL语句优化/性能监控/" itemprop="url" rel="index">
                    <span itemprop="name">性能监控</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/SQL语句优化/性能监控/MySql-性能监控/" itemprop="url" rel="index">
                    <span itemprop="name">MySql 性能监控</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分析SQL性能的几种方式"><a href="#分析SQL性能的几种方式" class="headerlink" title="分析SQL性能的几种方式"></a>分析SQL性能的几种方式</h1><h2 id="explain生成执行计划"><a href="#explain生成执行计划" class="headerlink" title="explain生成执行计划"></a>explain生成执行计划</h2><p><strong>expalin  sql</strong></p>
<ol>
<li><strong>type</strong>：显示关联类型。重点关注<strong>ALL（全表扫描）、index（全索引扫描）</strong>；</li>
<li><strong>possible_keys</strong>：可能使用的索引   【<strong>看是否为null，为null时要考虑创建索引或者更新组合索引</strong>】；</li>
<li><strong>key</strong>：实际使用的索引   【<strong>看是否为null，在possible_keys不为null时，要注意这几种情况：SQL语句的写法是否符合最左原则、是否存在表达式计算、是否存在隐式转换、是否存在like前缀匹配</strong>】</li>
<li><strong>key_len</strong>：使用到索引的长度。通常该值⼤大于30就要注意被选中的索引是否字符串类型【<strong>对于text，varchar，char可以根据情况建立前缀索引</strong>】，可否进⼀步优化；</li>
<li><strong>rows</strong>：预估扫描的行数。通常该值⼤大于1万就要注意可否选择更更合适的索引减少扫描的行数；</li>
<li><strong>extra</strong>：显示额外信息。重点<strong>关注Using temporary，Using filesort</strong>，尽量量通过添加或调整来消除</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from center_voucher_main where id&lt;211289\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: center_voucher_main</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 4</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 14669</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from center_voucher_main order by run_id desc\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: center_voucher_main</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 29339</span><br><span class="line">        Extra: Using filesort</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="optimizer-trace"><a href="#optimizer-trace" class="headerlink" title="optimizer_trace"></a>optimizer_trace</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL的explain是各种执行计划选择的结果，如果想看整个执行计划以及对于<strong>多种索引方案之间是如何选择的</strong>？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL5.6中支持这个功能，optimizer_trace，这个是mysql的参数，默认是关闭的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%optimizer_trace%&apos;;</span><br><span class="line">+------------------------------+----------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                | Value                                                                      |</span><br><span class="line">+------------------------------+----------------------------------------------------------------------------+</span><br><span class="line">| optimizer_trace              | enabled=on,one_line=off                                                    |</span><br><span class="line">| optimizer_trace_features     | greedy_search=on,range_optimizer=on,dynamic_range=on,repeated_subselect=on |</span><br><span class="line">| optimizer_trace_limit        | 1                                                                          |</span><br><span class="line">| optimizer_trace_max_mem_size | 1000000                                                                    |</span><br><span class="line">| optimizer_trace_offset       | -1                                                                         |</span><br><span class="line">+------------------------------+----------------------------------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>具体这么使用呢？</p>
<p>需要设置如下：</p>
<p>1、开启optimizer_trace，默认是关闭的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET optimizer_trace=&quot;enabled=on&quot;;</span><br></pre></td></tr></table></figure>
<p>　</p>
<p>2、设置optimizer_trace内存的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET  OPTIMIZER_TRACE_MAX_MEM_SIZE=1000000</span><br></pre></td></tr></table></figure>
<p>　　</p>
<p>3、explain查询语句</p>
<p><strong>optimizer_trace的定义</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table information_schema.optimizer_trace\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: OPTIMIZER_TRACE</span><br><span class="line">Create Table: CREATE TEMPORARY TABLE `OPTIMIZER_TRACE` (</span><br><span class="line">  `QUERY` longtext NOT NULL,</span><br><span class="line">  `TRACE` longtext NOT NULL,</span><br><span class="line">  `MISSING_BYTES_BEYOND_MAX_MEM_SIZE` int(20) NOT NULL DEFAULT &apos;0&apos;,</span><br><span class="line">  `INSUFFICIENT_PRIVILEGES` tinyint(1) NOT NULL DEFAULT &apos;0&apos;</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from center_voucher_main where id&lt;211289\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: center_voucher_main</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 4</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 14669</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">mysql&gt; SET optimizer_trace=&quot;enabled=off&quot;;</span><br></pre></td></tr></table></figure>
<p>　　</p>
<p>4、查找对于的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from information_schema.optimizer_trace\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                            QUERY: explain select * from center_voucher_main where id&lt;211289</span><br><span class="line">                            TRACE: &#123;</span><br><span class="line">  &quot;steps&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;join_preparation&quot;: &#123;</span><br><span class="line">        &quot;select#&quot;: 1,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;expanded_query&quot;: &quot;/* select#1 */ select `center_voucher_main`.`id` AS `id`,`center_voucher_main`.`batch_number` AS `batch_number`,`center_voucher_main`.`trade_no` AS `trade_no`,`center_voucher_main`.`account_date` AS `account_date`,`center_voucher_main`.`account_period` AS `account_period`,`center_voucher_main`.`finance_type` AS `finance_type`,`center_voucher_main`.`remark` AS `remark`,`center_voucher_main`.`happen_date` AS `happen_date`,`center_voucher_main`.`belong_date` AS `belong_date`,`center_voucher_main`.`valid_auth_user` AS `valid_auth_user`,`center_voucher_main`.`valid_time` AS `valid_time`,`center_voucher_main`.`import_user` AS `import_user`,`center_voucher_main`.`import_time` AS `import_time`,`center_voucher_main`.`status` AS `status`,`center_voucher_main`.`is_process` AS `is_process`,`center_voucher_main`.`source_module` AS `source_module`,`center_voucher_main`.`run_id` AS `run_id`,`center_voucher_main`.`update_user` AS `update_user`,`center_voucher_main`.`update_time` AS `update_time`,`center_voucher_main`.`create_time` AS `create_time`,`center_voucher_main`.`create_user` AS `create_user`,`center_voucher_main`.`error_msg` AS `error_msg` from `center_voucher_main` where (`center_voucher_main`.`id` &lt; 211289)&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;join_optimization&quot;: &#123;</span><br><span class="line">        &quot;select#&quot;: 1,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;condition_processing&quot;: &#123;</span><br><span class="line">              &quot;condition&quot;: &quot;WHERE&quot;,</span><br><span class="line">              &quot;original_condition&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;,</span><br><span class="line">              &quot;steps&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;transformation&quot;: &quot;equality_propagation&quot;,</span><br><span class="line">                  &quot;resulting_condition&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;transformation&quot;: &quot;constant_propagation&quot;,</span><br><span class="line">                  &quot;resulting_condition&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;transformation&quot;: &quot;trivial_condition_removal&quot;,</span><br><span class="line">                  &quot;resulting_condition&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;table_dependencies&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;table&quot;: &quot;`center_voucher_main`&quot;,</span><br><span class="line">                &quot;row_may_be_null&quot;: false,</span><br><span class="line">                &quot;map_bit&quot;: 0,</span><br><span class="line">                &quot;depends_on_map_bits&quot;: [</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;ref_optimizer_key_uses&quot;: [</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;rows_estimation&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;table&quot;: &quot;`center_voucher_main`&quot;,</span><br><span class="line">                &quot;range_analysis&quot;: &#123;</span><br><span class="line">                  &quot;table_scan&quot;: &#123;</span><br><span class="line">                    &quot;rows&quot;: 29339,</span><br><span class="line">                    &quot;cost&quot;: 6350.9</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;potential_range_indices&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                      &quot;usable&quot;: true,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;id&quot;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;trade_no&quot;,</span><br><span class="line">                      &quot;usable&quot;: false,</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;run_id&quot;,</span><br><span class="line">                      &quot;usable&quot;: false,</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;trade_no_inx&quot;,</span><br><span class="line">                      &quot;usable&quot;: false,</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;multi_field_index&quot;,</span><br><span class="line">                      &quot;usable&quot;: false,</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  ],</span><br><span class="line">                  &quot;setup_range_conditions&quot;: [</span><br><span class="line">                  ],</span><br><span class="line">                  &quot;group_index_range&quot;: &#123;</span><br><span class="line">                    &quot;chosen&quot;: false,</span><br><span class="line">                    &quot;cause&quot;: &quot;not_group_by_or_distinct&quot;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;analyzing_range_alternatives&quot;: &#123;</span><br><span class="line">                    &quot;range_scan_alternatives&quot;: [  ---- 执行计划及成本列表</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;PRIMARY&quot;,    ---- 索引名称</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;id &lt; 211289&quot;</span><br><span class="line">                        ],</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: true,</span><br><span class="line">                        &quot;rowid_ordered&quot;: true,</span><br><span class="line">                        &quot;using_mrr&quot;: false,</span><br><span class="line">                        &quot;index_only&quot;: false,</span><br><span class="line">                        &quot;rows&quot;: 14669,        ---- 扫描行数</span><br><span class="line">                        &quot;cost&quot;: 2975.1,       ---- 代价</span><br><span class="line">                        &quot;chosen&quot;: true        ---- 是否选中</span><br><span class="line">                      &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;analyzing_roworder_intersect&quot;: &#123;</span><br><span class="line">                      &quot;usable&quot;: false,</span><br><span class="line">                      &quot;cause&quot;: &quot;too_few_roworder_scans&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &quot;chosen_range_access_summary&quot;: &#123;</span><br><span class="line">                    &quot;range_access_plan&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;range_scan&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                      &quot;rows&quot;: 14669,</span><br><span class="line">                      &quot;ranges&quot;: [</span><br><span class="line">                        &quot;id &lt; 211289&quot;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;rows_for_plan&quot;: 14669,</span><br><span class="line">                    &quot;cost_for_plan&quot;: 2975.1,</span><br><span class="line">                    &quot;chosen&quot;: true</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;considered_execution_plans&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;plan_prefix&quot;: [</span><br><span class="line">                ],</span><br><span class="line">                &quot;table&quot;: &quot;`center_voucher_main`&quot;,</span><br><span class="line">                &quot;best_access_path&quot;: &#123;</span><br><span class="line">                  &quot;considered_access_paths&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;access_type&quot;: &quot;range&quot;,</span><br><span class="line">                      &quot;rows&quot;: 14669,</span><br><span class="line">                      &quot;cost&quot;: 5908.9,</span><br><span class="line">                      &quot;chosen&quot;: true</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;cost_for_plan&quot;: 5908.9,</span><br><span class="line">                &quot;rows_for_plan&quot;: 14669,</span><br><span class="line">                &quot;chosen&quot;: true</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;attaching_conditions_to_tables&quot;: &#123;</span><br><span class="line">              &quot;original_condition&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;,</span><br><span class="line">              &quot;attached_conditions_computation&quot;: [</span><br><span class="line">              ],</span><br><span class="line">              &quot;attached_conditions_summary&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;table&quot;: &quot;`center_voucher_main`&quot;,</span><br><span class="line">                  &quot;attached&quot;: &quot;(`center_voucher_main`.`id` &lt; 211289)&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;refine_plan&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;table&quot;: &quot;`center_voucher_main`&quot;,</span><br><span class="line">                &quot;access_type&quot;: &quot;range&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;join_explain&quot;: &#123;</span><br><span class="line">        &quot;select#&quot;: 1,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">MISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0</span><br><span class="line">          INSUFFICIENT_PRIVILEGES: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>　</p>
<h2 id="profiling"><a href="#profiling" class="headerlink" title="profiling"></a>profiling</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>关注每一条SQL每一步的具体耗时</strong>，如：发送数据、排序……</p>
<p><strong>Creating sort index</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set profiling=1;</span><br><span class="line"></span><br><span class="line">mysql&gt; select……;</span><br><span class="line"></span><br><span class="line">mysql&gt; show profiles;</span><br><span class="line"></span><br><span class="line">mysql&gt; show profile for query query_id;</span><br><span class="line"></span><br><span class="line">mysql&gt; set profiling=0;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">set profiling=1;</span><br><span class="line"></span><br><span class="line">select * from center_voucher_main order by run_id desc;</span><br><span class="line"></span><br><span class="line">show profiles;</span><br><span class="line">+----------+------------+----------------------------------------------------------------+</span><br><span class="line">| Query_ID | Duration   | Query                                                          |</span><br><span class="line">+----------+------------+----------------------------------------------------------------+</span><br><span class="line">|        5 | 2.57044725 | select * from center_voucher_main order by run_id desc         |</span><br><span class="line">|        6 | 0.00463750 | show status like &quot;handler_read_%&quot;                              |</span><br><span class="line">|        7 | 0.00079075 | explain select * from center_voucher_main order by run_id desc |</span><br><span class="line">|        8 | 0.00053700 | explain select * from center_voucher_main where id&lt;211289      |</span><br><span class="line">|        9 | 0.00055025 | explain select * from center_voucher_main where id&lt;211289      |</span><br><span class="line">|       10 | 0.00066500 | explain select * from center_voucher_main where id&lt;211289      |</span><br><span class="line">|       11 | 0.00035050 | explain select * from center_voucher_main order by run_id desc |</span><br><span class="line">|       12 | 0.00122675 | show variables like &apos;%optimizer_trace%&apos;                        |</span><br><span class="line">|       13 | 0.00021300 | set optimizer_trace=&quot;enabled=on&quot;                               |</span><br><span class="line">|       14 | 0.00110200 | show variables like &apos;%optimizer_trace%&apos;                        |</span><br><span class="line">|       15 | 0.00106200 | explain select * from center_voucher_main where id&lt;211289      |</span><br><span class="line">|       16 | 0.00077275 | select * from information_schema.optimizer_trace               |</span><br><span class="line">|       17 | 0.00084625 | show create table information_schema.optimizer_trace           |</span><br><span class="line">|       18 | 0.00012625 | set profiling=1                                                |</span><br><span class="line">|       19 | 2.34017875 | select * from center_voucher_main order by run_id desc         |</span><br><span class="line">+----------+------------+----------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; show profile for query 19;</span><br><span class="line">+------------------------------+----------+</span><br><span class="line">| Status                       | Duration |</span><br><span class="line">+------------------------------+----------+</span><br><span class="line">| Waiting for query cache lock | 0.000039 |</span><br><span class="line">| Creating sort index          | 0.001343 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001397 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001385 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001454 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.002308 |</span><br><span class="line">| Waiting for query cache lock | 0.000011 |</span><br><span class="line">| Creating sort index          | 0.001377 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001358 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001321 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001428 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001388 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001382 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001461 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001282 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001270 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001575 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001754 |</span><br><span class="line">| Waiting for query cache lock | 0.000008 |</span><br><span class="line">| Creating sort index          | 0.001576 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001669 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001790 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001500 |</span><br><span class="line">| Waiting for query cache lock | 0.000008 |</span><br><span class="line">| Creating sort index          | 0.001537 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001490 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001507 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001596 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.002086 |</span><br><span class="line">| Waiting for query cache lock | 0.000010 |</span><br><span class="line">| Creating sort index          | 0.001511 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001480 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001486 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001250 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001202 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001368 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.227836 |</span><br><span class="line">| Waiting for query cache lock | 0.000012 |</span><br><span class="line">| Creating sort index          | 0.001724 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001901 |</span><br><span class="line">| Waiting for query cache lock | 0.000010 |</span><br><span class="line">| Creating sort index          | 0.001618 |</span><br><span class="line">| Waiting for query cache lock | 0.000009 |</span><br><span class="line">| Creating sort index          | 0.001519 |</span><br><span class="line">| Waiting for query cache lock | 0.000007 |</span><br><span class="line">| Creating sort index          | 0.001509 |</span><br><span class="line">| Waiting for query cache lock | 0.000005 |</span><br><span class="line">| Creating sort index          | 0.001595 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001509 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.002361 |</span><br><span class="line">| Waiting for query cache lock | 0.000010 |</span><br><span class="line">| Creating sort index          | 0.001472 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001485 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001458 |</span><br><span class="line">| Waiting for query cache lock | 0.000006 |</span><br><span class="line">| Creating sort index          | 0.001573 |</span><br><span class="line">| Waiting for query cache lock | 0.000008 |</span><br><span class="line">| Creating sort index          | 0.001827 |</span><br><span class="line">| Waiting for query cache lock | 0.000011 |</span><br><span class="line">| Creating sort index          | 0.001629 |</span><br><span class="line">| Waiting for query cache lock | 0.000010 |</span><br><span class="line">| Creating sort index          | 1.537206 |</span><br><span class="line">| end                          | 0.000015 |</span><br><span class="line">| query end                    | 0.000015 |</span><br><span class="line">| closing tables               | 0.000022 |</span><br><span class="line">| freeing items                | 0.000262 |</span><br><span class="line">| logging slow query           | 0.000066 |</span><br><span class="line">| cleaning up                  | 0.000019 |</span><br><span class="line">+------------------------------+----------+</span><br><span class="line">100 rows in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>
<h2 id="session-status"><a href="#session-status" class="headerlink" title="session status"></a>session status</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; pager cat - &gt; /dev/null;</span><br><span class="line"></span><br><span class="line">mysql&gt; flush status;</span><br><span class="line"></span><br><span class="line">mysql&gt; select ……;</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager;</span><br><span class="line"></span><br><span class="line">mysql&gt; show status like &quot;handler_read_%&quot;;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Handler_read_rnd表示随机读取的条数，即未使用索引读取的条数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &quot;handler_read_%&quot;;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Handler_read_first    | 2     |</span><br><span class="line">| Handler_read_key      | 60618 |</span><br><span class="line">| Handler_read_last     | 0     |</span><br><span class="line">| Handler_read_next     | 0     |</span><br><span class="line">| Handler_read_prev     | 0     |</span><br><span class="line">| Handler_read_rnd      | 60616 |</span><br><span class="line">| Handler_read_rnd_next | 60733 |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="mysqldumpslow或者pt-query-digest"><a href="#mysqldumpslow或者pt-query-digest" class="headerlink" title="mysqldumpslow或者pt-query-digest"></a>mysqldumpslow或者pt-query-digest</h2><h3 id="pt-query-digest"><a href="#pt-query-digest" class="headerlink" title="pt-query-digest"></a>pt-query-digest</h3><blockquote>
<p><a href="http://www.php.cn/mysql-tutorials-357655.html" target="_blank" rel="noopener">http://www.php.cn/mysql-tutorials-357655.html</a></p>
</blockquote>
<blockquote>
<p><a href="https://blog.csdn.net/seteor/article/details/24017913" target="_blank" rel="noopener">https://blog.csdn.net/seteor/article/details/24017913</a></p>
</blockquote>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line"></span><br><span class="line">wget percona.com/get/percona-toolkit.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxf percona-toolkit.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> percona-toolkit-2.2.19</span><br><span class="line"></span><br><span class="line">perl Makefile.PL PREFIX=/usr/<span class="built_in">local</span>/percona-toolkit</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">yum install -y perl-Time-HiRes</span><br><span class="line"></span><br><span class="line">工具安装目录在：/usr/<span class="built_in">local</span>/percona-toolkit/bin</span><br></pre></td></tr></table></figure>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><blockquote>
<p>pt-query-digest [OPTIONS] [FILES] [DSN]</p>
<p>​    –create-review-table 当使用–review参数把分析结果输出到表中时，如果没有表就自动创建。</p>
<p>​    –create-history-table 当使用–history参数把分析结果输出到表中时，如果没有表就自动创建。</p>
<p>​    –filter 对输入的慢查询按指定的<a href="http://www.php.cn/wiki/57.html" target="_blank" rel="noopener">字符串</a>进行匹配过滤后再进行分析</p>
<p>​    –limit 限制输出结果百分比或数量，默认值是20,即将最慢的20条语句输出，如果是50%则按总响应时间占比从大到小排序，输出到总和达到50%位置截止。</p>
<p>​    –host mysql服务器地址</p>
<p>​    –user mysql用户名</p>
<p>​    –password mysql用户密码</p>
<p>​    –history 将分析结果保存到表中，分析结果比较详细，下次再使用–history时，如果存在相同的语句，且查询所在的时间区间和历史表中的不同，则会记录到数据表中，可以通过查询同一CHECKSUM来比较某类型查询的历史变化。</p>
<p>​    –review 将分析结果保存到表中，这个分析只是对查询条件进行参数化，一个类型的查询一条记录，比较简单。当下次使用–review时，如果存在相同的语句分析，就不会记录到数据表中。</p>
<p>​    –output 分析结果输出类型，值可以是report(标准分析报告)、slowlog(Mysql slow log)、<a href="http://www.php.cn/wiki/1488.html" target="_blank" rel="noopener">json</a>、json-anon，一般使用report，以便于阅读。</p>
<p>​    –since 从什么时间开始分析，值为字符串，可以是指定的某个”yyyy-mm-dd [hh:mm:ss]”格式的时间点，也可以是简单的一个时间值：s(秒)、h(小时)、m(分钟)、d(天)，如12h就表示从12小时前开始统计。</p>
<p>​    –until 截止时间，配合—since可以分析一段时间内的慢查询。</p>
</blockquote>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><h5 id="第一部分：总体统计结果"><a href="#第一部分：总体统计结果" class="headerlink" title="第一部分：总体统计结果"></a>第一部分：总体统计结果</h5><p>Overall：总共有多少条查询</p>
<p>Time range：查询执行的时间范围</p>
<p>unique：唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询</p>
<p>total：总计 min：最小 max：最大 avg：平均</p>
<p>95%：把所有值从小到大排列，位置位于95%的那个数，这个数一般最具有参考价值</p>
<p>median：中位数，把所有值从小到大排列，位置位于中间那个数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 该工具执行日志分析的用户时间，系统时间，物理内存占用大小，虚拟内存占用大小</span><br><span class="line"></span><br><span class="line"># 340ms user time, 140ms system time, 23.99M rss, 203.11M vsz</span><br><span class="line"></span><br><span class="line"># 工具执行时间</span><br><span class="line"></span><br><span class="line"># Current date: Fri Nov 25 02:37:18 2016</span><br><span class="line"></span><br><span class="line"># 运行分析工具的主机名</span><br><span class="line"></span><br><span class="line"># Hostname: localhost.localdomain</span><br><span class="line"></span><br><span class="line"># 被分析的文件名</span><br><span class="line"></span><br><span class="line"># Files: slow.log</span><br><span class="line"></span><br><span class="line"># 语句总数量，唯一的语句数量，QPS，并发数</span><br><span class="line"></span><br><span class="line"># Overall: 2 total, 2 unique, 0.01 QPS, 0.01x concurrency </span><br><span class="line"></span><br><span class="line"># 日志记录的时间范围</span><br><span class="line"></span><br><span class="line"># Time range: 2016-11-22 06:06:18 to 06:11:40</span><br><span class="line"></span><br><span class="line"># 属性    总计  最小 最大 平均 95% 标准 中等</span><br><span class="line"></span><br><span class="line"># Attribute   total  min  max  avg  95% stddev median</span><br><span class="line"></span><br><span class="line"># ============  ======= ======= ======= ======= ======= ======= =======</span><br><span class="line"></span><br><span class="line"># 语句执行时间</span><br><span class="line"></span><br><span class="line"># Exec time    3s 640ms  2s  1s  2s 999ms  1s</span><br><span class="line"></span><br><span class="line"># 锁占用时间</span><br><span class="line"></span><br><span class="line"># Lock time   1ms  0  1ms 723us  1ms  1ms 723us</span><br><span class="line"></span><br><span class="line"># 发送到客户端的行数</span><br><span class="line"></span><br><span class="line"># Rows sent    5  1  4 2.50  4 2.12 2.50</span><br><span class="line"></span><br><span class="line"># select语句扫描行数</span><br><span class="line"></span><br><span class="line"># Rows examine  186.17k  0 186.17k 93.09k 186.17k 131.64k 93.09k</span><br><span class="line"></span><br><span class="line"># 查询的字符数</span><br><span class="line"></span><br><span class="line"># Query size   455  15  440 227.50  440 300.52 227.50</span><br></pre></td></tr></table></figure>
<h5 id="第二部分：查询分组统计结果"><a href="#第二部分：查询分组统计结果" class="headerlink" title="第二部分：查询分组统计结果"></a>第二部分：查询分组统计结果</h5><p>Rank：所有语句的排名，默认按查询时间降序排列，通过–order-by指定</p>
<p>Query ID：语句的ID，（去掉多余空格和文本字符，计算<a href="http://www.php.cn/wiki/762.html" target="_blank" rel="noopener">hash</a>值）</p>
<p>Response：总的响应时间</p>
<p>time：该查询在本次分析中总的时间占比</p>
<p>calls：执行次数，即本次分析总共有多少条这种类型的查询语句</p>
<p>R/Call：平均每次执行的响应时间</p>
<p>V/M：响应时间Variance-to-mean的比率</p>
<p>Item：查询<a href="http://www.php.cn/wiki/60.html" target="_blank" rel="noopener">对象</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Profile</span><br><span class="line"></span><br><span class="line"># Rank Query ID   Response time Calls R/Call V/M Item</span><br><span class="line"></span><br><span class="line"># ==== ================== ============= ===== ====== ===== ===============</span><br><span class="line"></span><br><span class="line"># 1 0xF9A57DD5A41825CA 2.0529 76.2%  1 2.0529 0.00 SELECT</span><br><span class="line"></span><br><span class="line"># 2 0x4194D8F83F4F9365 0.6401 23.8%  1 0.6401 0.00 SELECT wx_member_base</span><br></pre></td></tr></table></figure>
<h5 id="第三部分：每一种查询的详细统计结果"><a href="#第三部分：每一种查询的详细统计结果" class="headerlink" title="第三部分：每一种查询的详细统计结果"></a>第三部分：每一种查询的详细统计结果</h5><p>由下面查询的详细统计结果，最上面的<a href="http://www.php.cn/code/5947.html" target="_blank" rel="noopener">表格</a>列出了执行次数、最大、最小、平均、95%等各项目的统计。</p>
<p>ID：查询的ID号，和上图的Query ID对应</p>
<p>Databases：数据库名</p>
<p>Users：各个用户执行的次数（占比）</p>
<p>Query_time distribution ：查询时间分布, 长短体现区间占比，本例中1s-10s之间查询数量是10s以上的两倍。</p>
<p>Tables：查询中涉及到的表</p>
<p>Explain：SQL语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Query 1: 0 QPS, 0x concurrency, ID 0xF9A57DD5A41825CA at byte 802 </span><br><span class="line"></span><br><span class="line"># This item is included in the report because it matches --limit.</span><br><span class="line"></span><br><span class="line"># Scores: V/M = 0.00</span><br><span class="line"></span><br><span class="line"># Time range: all events occurred at 2016-11-22 06:11:40</span><br><span class="line"></span><br><span class="line"># Attribute pct total  min  max  avg  95% stddev median</span><br><span class="line"></span><br><span class="line"># ============ === ======= ======= ======= ======= ======= ======= =======</span><br><span class="line"></span><br><span class="line"># Count   50  1</span><br><span class="line"></span><br><span class="line"># Exec time  76  2s  2s  2s  2s  2s  0  2s</span><br><span class="line"></span><br><span class="line"># Lock time  0  0  0  0  0  0  0  0</span><br><span class="line"></span><br><span class="line"># Rows sent  20  1  1  1  1  1  0  1</span><br><span class="line"></span><br><span class="line"># Rows examine 0  0  0  0  0  0  0  0</span><br><span class="line"></span><br><span class="line"># Query size  3  15  15  15  15  15  0  15</span><br><span class="line"></span><br><span class="line"># String:</span><br><span class="line"></span><br><span class="line"># Databases test</span><br><span class="line"></span><br><span class="line"># Hosts  192.168.8.1</span><br><span class="line"></span><br><span class="line"># Users  mysql</span><br><span class="line"></span><br><span class="line"># Query_time distribution</span><br><span class="line"></span><br><span class="line"># 1us</span><br><span class="line"></span><br><span class="line"># 10us</span><br><span class="line"></span><br><span class="line"># 100us</span><br><span class="line"></span><br><span class="line"># 1ms</span><br><span class="line"></span><br><span class="line"># 10ms</span><br><span class="line"></span><br><span class="line"># 100ms</span><br><span class="line"></span><br><span class="line"># 1s ################################################################</span><br><span class="line"></span><br><span class="line"># 10s+</span><br><span class="line"></span><br><span class="line"># EXPLAIN /*!50100 PARTITIONS*/</span><br><span class="line"></span><br><span class="line">select sleep(2)\G</span><br></pre></td></tr></table></figure>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><p><strong>1.直接分析慢查询文件:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest slow.log &gt; slow_report.log</span><br></pre></td></tr></table></figure>
<p><strong>2.分析最近12小时内的查询：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --since=12h slow.log &gt; slow_report2.log</span><br></pre></td></tr></table></figure>
<p><strong>3.分析指定时间范围内的查询：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest slow.log --since &apos;2017-01-07 09:30:00&apos; --until &apos;2017-01-07 10:00:00&apos;&gt; &gt; slow_report3.log</span><br></pre></td></tr></table></figure>
<p><strong>4.分析指含有select语句的慢查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &apos;$event-&gt;&#123;fingerprint&#125; =~ m/^select/i&apos; slow.log&gt; slow_report4.log</span><br></pre></td></tr></table></figure>
<p><strong>5.针对某个用户的慢查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &apos;($event-&gt;&#123;user&#125; || &quot;&quot;) =~ m/^root/i&apos; slow.log&gt; slow_report5.log</span><br></pre></td></tr></table></figure>
<p><strong>6.查询所有所有的全表扫描或full join的慢查询</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --filter &apos;(($event-&gt;&#123;Full_scan&#125; || &quot;&quot;) eq &quot;yes&quot;) ||(($event-&gt;&#123;Full_join&#125; || &quot;&quot;) eq &quot;yes&quot;)&apos; slow.log&gt; slow_report6.log</span><br></pre></td></tr></table></figure>
<p><strong>7.把查询保存到query_review表</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_review--create-review-table slow.log</span><br></pre></td></tr></table></figure>
<p><strong>8.把查询保存到query_history表</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_history--create-review-table slow.log_0001``pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_history--create-review-table slow.log_0002</span><br></pre></td></tr></table></figure>
<p><strong>9.通过tcpdump抓取mysql的tcp协议数据，然后再分析</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt``pt-query-digest --type tcpdump mysql.tcp.txt&gt; slow_report9.log</span><br></pre></td></tr></table></figure>
<p><strong>10.分析binlog</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog mysql-bin.000093 &gt; mysql-bin000093.sql``pt-query-digest --type=binlog mysql-bin000093.sql &gt; slow_report10.log</span><br></pre></td></tr></table></figure>
<p><strong>11.分析general log</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-query-digest --type=genlog localhost.log &gt; slow_report11.log</span><br></pre></td></tr></table></figure>
<h3 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h3><blockquote>
<p><a href="https://www.cnblogs.com/moss_tan_jun/p/8025504.html" target="_blank" rel="noopener">https://www.cnblogs.com/moss_tan_jun/p/8025504.html</a></p>
</blockquote>
<blockquote>
<p><a href="https://blog.csdn.net/sunyuhua_keyboard/article/details/81204020" target="_blank" rel="noopener">https://blog.csdn.net/sunyuhua_keyboard/article/details/81204020</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-s 按照那种方式排序</span><br><span class="line">    c： 访问计数</span><br><span class="line">    l： 锁定时间</span><br><span class="line">    r:  返回记录</span><br><span class="line">    t:  查询时间</span><br><span class="line">    al：平均锁定时间</span><br><span class="line">    ar：平均访问记录数</span><br><span class="line">    at：平均查询时间</span><br><span class="line">-t 是top n的意思，返回多少条数据。</span><br><span class="line">-g 可以跟上正则匹配模式，大小写不敏感。</span><br></pre></td></tr></table></figure>
<p><strong>得到访问时间最长的5个sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@php5# mysqldumpslow -s t -t 5 /var/log/mysql/mysql-slow.log</span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 1  Time=7536.34s (7536s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  DROP TABLE `test1`.`user`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=3513.11s (3513s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  insert into `sys_log_back`(`admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module`) SELECT `admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module` FROM `sys_log`</span><br><span class="line"></span><br><span class="line">Count: 6  Time=544.90s (3269s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@2hosts</span><br><span class="line">  #</span><br><span class="line"></span><br><span class="line">Count: 6  Time=456.27s (2737s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  insert into `sys_log`(`admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module`) SELECT `admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module` FROM `sys_log`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=864.30s (1728s)  Lock=0.00s (0s)  Rows=8057920.0 (16115840), root[root]@2hosts</span><br><span class="line">  select * from sys_log</span><br></pre></td></tr></table></figure>
<p><strong>得到访问次数最多的20个sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@php5# mysqldumpslow -s c -t 20 /var/log/mysql/mysql-slow.log </span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 604  Time=2.50s (1512s)  Lock=0.00s (0s)  Rows=387.4 (233995), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT intcol1,charcol1 FROM t1</span><br><span class="line"></span><br><span class="line">Count: 272  Time=2.18s (593s)  Lock=0.00s (0s)  Rows=1.0 (272), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(distinct trade_no) AS tp_count FROM `center_view_voucher` WHERE  `account_period` = &apos;S&apos;  AND `first_business_code` IN (&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;)  AND `source_module` = &apos;S&apos;  AND `status` = N LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 170  Time=6.85s (1164s)  Lock=0.71s (121s)  Rows=0.0 (0), root[root]@[127.0.0.1]</span><br><span class="line">  UPDATE `flow_run_prcs`  SET `prcs_status`=N,`update_time`=&apos;S&apos;,`update_user`=N  WHERE  `op_user` IN (N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N,N)  AND `prcs_status` IN (N,N)</span><br><span class="line"></span><br><span class="line">Count: 137  Time=2.20s (300s)  Lock=0.00s (0s)  Rows=1.0 (137), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(distinct trade_no) AS tp_count FROM `center_view_voucher` WHERE  `account_period` = &apos;S&apos;  AND `first_business_code` IN (&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;,&apos;S&apos;)  AND `source_module` = &apos;S&apos;  AND `status` &lt;&gt; N LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 126  Time=2.44s (306s)  Lock=0.00s (0s)  Rows=1.0 (126), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(distinct trade_no) AS tp_count FROM `center_view_voucher` WHERE  `account_period` = &apos;S&apos;  AND `first_business_code` = &apos;S&apos;  AND `source_module` = &apos;S&apos;  AND `status` = N LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 91  Time=2.49s (226s)  Lock=0.00s (0s)  Rows=1.0 (91), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(distinct trade_no) AS tp_count FROM `center_view_voucher` WHERE  `account_period` = &apos;S&apos;  AND `first_business_code` = &apos;S&apos;  AND `source_module` = &apos;S&apos;  AND `status` &lt;&gt; N LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 90  Time=4.96s (446s)  Lock=0.02s (1s)  Rows=28.0 (2520), root[root]@[127.0.0.1]</span><br><span class="line">  select id from deviceattr where name=&apos;S&apos; or name=&apos;S&apos; group by id</span><br><span class="line"></span><br><span class="line">Count: 82  Time=2.81s (230s)  Lock=0.00s (0s)  Rows=124.5 (10211), root[root]@[192.168.132.2]</span><br><span class="line">  SHOW TABLE STATUS</span><br><span class="line"></span><br><span class="line">Count: 66  Time=3.47s (228s)  Lock=0.00s (0s)  Rows=1.0 (66), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(*) AS tp_count FROM `center_view_voucher` WHERE  (  `status` = N )  AND (  (first_business_code = &quot;S&quot;  ) or  (first_business_code = &quot;S&quot;  ) or  (first_business_code = &quot;S&quot;  ) or  (first_business_code = &quot;S&quot;  ) or  (first_business_code = &quot;S&quot;  ) or  (first_business_code = &quot;S&quot;  ) ) LIMIT N</span><br></pre></td></tr></table></figure>
<p><strong>得到返回记录最多的20个sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@php5# mysqldumpslow -s r -t 20 /var/log/mysql/mysql-slow.log </span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 2  Time=864.30s (1728s)  Lock=0.00s (0s)  Rows=8057920.0 (16115840), root[root]@2hosts</span><br><span class="line">  select * from sys_log</span><br><span class="line"></span><br><span class="line">Count: 2  Time=5.47s (10s)  Lock=0.00s (0s)  Rows=400593.0 (801186), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `cfg_online`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=21.94s (43s)  Lock=0.00s (0s)  Rows=212758.0 (425516), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `web_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=5.81s (5s)  Lock=0.00s (0s)  Rows=408894.0 (408894), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `cfg_online`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=42.50s (42s)  Lock=0.00s (0s)  Rows=389465.0 (389465), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `web_log`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=3.05s (6s)  Lock=0.00s (0s)  Rows=170996.5 (341993), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `rck_resume_privilege`</span><br><span class="line"></span><br><span class="line">Count: 604  Time=2.50s (1512s)  Lock=0.00s (0s)  Rows=387.4 (233995), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT intcol1,charcol1 FROM t1</span><br></pre></td></tr></table></figure>
<p><strong>得到平均访问记录数最多的20条sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">root@php5# mysqldumpslow -s ar -t 20 /var/log/mysql/mysql-slow.log </span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 2  Time=864.30s (1728s)  Lock=0.00s (0s)  Rows=8057920.0 (16115840), root[root]@2hosts</span><br><span class="line">  select * from sys_log</span><br><span class="line"></span><br><span class="line">Count: 1  Time=5.81s (5s)  Lock=0.00s (0s)  Rows=408894.0 (408894), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `cfg_online`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=5.47s (10s)  Lock=0.00s (0s)  Rows=400593.0 (801186), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `cfg_online`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=42.50s (42s)  Lock=0.00s (0s)  Rows=389465.0 (389465), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `web_log`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=21.94s (43s)  Lock=0.00s (0s)  Rows=212758.0 (425516), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `web_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=4.36s (4s)  Lock=0.00s (0s)  Rows=183650.0 (183650), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `rck_resume_operate_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=5.98s (5s)  Lock=0.00s (0s)  Rows=183650.0 (183650), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `rck_resume_operate_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=2.82s (2s)  Lock=0.00s (0s)  Rows=172210.0 (172210), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `rck_resume_privilege`</span><br><span class="line"></span><br><span class="line">Count: 2  Time=3.05s (6s)  Lock=0.00s (0s)  Rows=170996.5 (341993), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `rck_resume_privilege`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=14.95s (14s)  Lock=0.00s (0s)  Rows=170764.0 (170764), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `rck_resume`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=17.72s (17s)  Lock=0.00s (0s)  Rows=170764.0 (170764), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `rck_resume`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=17.90s (17s)  Lock=0.00s (0s)  Rows=168174.0 (168174), root[root]@localhost</span><br><span class="line">  SELECT /*!N SQL_NO_CACHE */ * FROM `rck_resume_body`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=20.77s (20s)  Lock=0.00s (0s)  Rows=168174.0 (168174), root[root]@[192.168.132.2]</span><br><span class="line">  SELECT * FROM `rck_resume_body`</span><br><span class="line"></span><br><span class="line">Count: 6  Time=2.15s (12s)  Lock=0.00s (0s)  Rows=30308.0 (181848), root[root]@localhost</span><br><span class="line">  select * from center_voucher_main</span><br></pre></td></tr></table></figure>
<p><strong>得到平均访问次数最多,并且里面含有sys_log字符的20条sql</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">root@php5# mysqldumpslow -s ar -t 20 -g &quot;sys_log&quot; /var/log/mysql/mysql-slow.log </span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 2  Time=864.30s (1728s)  Lock=0.00s (0s)  Rows=8057920.0 (16115840), root[root]@2hosts</span><br><span class="line">  select * from sys_log</span><br><span class="line"></span><br><span class="line">Count: 1  Time=6.27s (6s)  Lock=0.00s (0s)  Rows=36.0 (36), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT * FROM `sys_log` WHERE  `system` = &apos;S&apos; ORDER BY `id`  desc LIMIT N,N</span><br><span class="line"></span><br><span class="line">Count: 1  Time=6.69s (6s)  Lock=0.00s (0s)  Rows=20.0 (20), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT * FROM `sys_log` ORDER BY update_time desc LIMIT N,N</span><br><span class="line"></span><br><span class="line">Count: 1  Time=5.79s (5s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@[192.168.132.2]</span><br><span class="line">  select max(id) from sys_log</span><br><span class="line"></span><br><span class="line">Count: 2  Time=2.63s (5s)  Lock=0.00s (0s)  Rows=1.0 (2), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(*) AS tp_count FROM `sys_log` WHERE  `system` = &apos;S&apos; LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 1  Time=2.71s (2s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@[127.0.0.1]</span><br><span class="line">  SELECT COUNT(*) AS tp_count FROM `sys_log` LIMIT N</span><br><span class="line"></span><br><span class="line">Count: 1  Time=11.38s (11s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@localhost</span><br><span class="line">  drop table sys_log</span><br><span class="line"></span><br><span class="line">Count: 1  Time=2.34s (2s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[127.0.0.1]</span><br><span class="line">  INSERT INTO `sys_log` (`atype` , `admin` , `remark` , `ip` , `update_time` , `system` , `module`) VALUES (&apos;S&apos; , &apos;S&apos; , &apos;S&apos; , &apos;S&apos; , N , &apos;S&apos; , &apos;S&apos;)</span><br><span class="line"></span><br><span class="line">Count: 6  Time=456.27s (2737s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  insert into `sys_log`(`admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module`) SELECT `admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module` FROM `sys_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=3513.11s (3513s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  insert into `sys_log_back`(`admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module`) SELECT `admin`,`atype`,`remark`,`ip`,`update_time`, `system`, `module` FROM `sys_log`</span><br><span class="line"></span><br><span class="line">Count: 1  Time=18.73s (18s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@[192.168.132.2]</span><br><span class="line">  drop table sys_log_back</span><br><span class="line"></span><br><span class="line">Died at /usr/local/mysql/bin/mysqldumpslow line 161, &lt;&gt; chunk 2353.</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/MySQL Explain详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/MySQL Explain详解/" itemprop="url">MySQL Explain详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySQL-Explain详解/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL Explain详解</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySQL-Explain详解/Explain/" itemprop="url" rel="index">
                    <span itemprop="name">Explain</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL-Explain详解"><a href="#MySQL-Explain详解" class="headerlink" title="MySQL Explain详解"></a>MySQL Explain详解</h1><h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">通过 explain 命令获取 select 语句的执行计划，通过 explain 我们可以知道以下信息：表的读取顺序，数据读取操作的类型，哪些索引可以使用，哪些索引实际使用了，表之间的引用，每张表有多少行被优化器查询等信息。</span><br><span class="line"></span><br><span class="line">在 select 语句之前增加 explain 关键字，MySQL 会在查询上设置一个标记，执行查询时，会返回执行计划的信息，而不是执行这条SQL（如果 from 中包含子查询，仍会执行该子查询，将结果放入临时表中）。</span><br></pre></td></tr></table></figure>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p><img src="//blog.com/2019/04/20/MySQL Explain详解/示例.png" alt="示例"></p>
<h1 id="id列"><a href="#id列" class="headerlink" title="id列"></a>id列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id列的编号是 select 的序列号，有几个 select 就有几个id，并且id的顺序是按 select 出现的顺序增长的。</span><br><span class="line"></span><br><span class="line">1. id相同:执行顺序从上至下(mysql内部优化器加载表的顺序是从上到下)</span><br><span class="line">2. id不同:如果是子查询,id的序号会递增,id值越大优先级越高,越先被执行</span><br><span class="line">3.id部分相同:如果id相同,可以认为是一组从上往下顺序执行;在所有组中,id值越大优先级越高,越先被执行</span><br></pre></td></tr></table></figure>
<h1 id="select-type列"><a href="#select-type列" class="headerlink" title="select_type列"></a>select_type列</h1><p><img src="//blog.com/2019/04/20/MySQL Explain详解/select_type列.png" alt="select_type列"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. simple：简单查询。查询不包含子查询和union</span><br><span class="line">2. primary：复杂查询中最外层的 select</span><br><span class="line">3. subquery：包含在 select 中的子查询（不在 from 子句中）</span><br><span class="line">4. derived：包含在 from 子句中的子查询。MySQL会将结果存放在一个临时表中，也称为派生表（derived的英文含义）</span><br><span class="line">5. union：在 union 中的第二个和随后的 select</span><br><span class="line">6. union result：从 union 临时表检索结果的 select</span><br></pre></td></tr></table></figure>
<h1 id="table列"><a href="#table列" class="headerlink" title="table列"></a>table列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这一列表示 explain 的一行正在访问哪个表。</span><br><span class="line"></span><br><span class="line">当 from 子句中有子查询时，table列是 &lt;derivenN&gt; 格式，表示当前查询依赖 id=N 的查询，于是先执行 id=N 的查询。当有 union 时，UNION RESULT 的 table 列的值为 &lt;union1,2&gt;，1和2表示参与 union 的 select 行id。</span><br></pre></td></tr></table></figure>
<h1 id="type列"><a href="#type列" class="headerlink" title="type列"></a>type列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    这一列表示关联类型或访问类型，即MySQL决定如何查找表中的行。</span><br><span class="line">    </span><br><span class="line">    依次从最优到最差分别为：system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</span><br><span class="line"></span><br><span class="line">NULL：mysql能够在优化阶段分解查询语句，在执行阶段用不着再访问表或索引。例如：在索引列中选取最小值，可以单独查找索引来完成，不需要在执行时访问表</span><br><span class="line"></span><br><span class="line">const、system： 当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。如将主键置于where列表中，MySQL就能将该查询转换为一个常量,system是const类型的特例，当查询的表只有一行的情况下，使用system</span><br><span class="line"></span><br><span class="line">ref：相比 eq_ref，不使用唯一索引，而是使用普通索引或者唯一性索引的部分前缀，索引要和某个值相比较，可能会找到多个符合条件的行。连接匹配条件，即哪些列或常量被用于查找索引列上的值</span><br><span class="line"></span><br><span class="line">eq_ref：primary key 或 unique key 索引的所有部分被连接使用 ，最多只会返回一条符合条件的记录。这可能是在 const 之外最好的联接类型了，简单的 select 查询不会出现这种 type。 类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件</span><br><span class="line"></span><br><span class="line">range：范围扫描通常出现在 in(), between ,&gt; ,&lt;, &gt;= 等操作中。使用一个索引来检索给定范围的行。</span><br><span class="line"></span><br><span class="line">index：和ALL一样，不同就是mysql只需扫描索引树，这通常比ALL快一些。</span><br><span class="line"></span><br><span class="line">ALL：即全表扫描，意味着mysql需要从头到尾去查找所需要的行。通常情况下这需要增加索引来进行优化了</span><br><span class="line"></span><br><span class="line">ref_or_null：类似ref，但是可以搜索值为NULL的行。</span><br><span class="line"></span><br><span class="line">index_merge：表示使用了索引合并的优化方法。</span><br></pre></td></tr></table></figure>
<h1 id="possible-keys列"><a href="#possible-keys列" class="headerlink" title="possible_keys列"></a>possible_keys列</h1><p>这一列显示查询可能使用哪些索引来查找。 </p>
<p>explain 时可能出现 possible_keys 有列，而 key 显示 NULL 的情况，这种情况是因为表中数据不多，mysql认为索引对此查询帮助不大，选择了全表查询。 </p>
<p>如果该列是NULL，则没有相关的索引。在这种情况下，可以通过检查 where 子句看是否可以创造一个适当的索引来提高查询性能，然后用 explain 查看效果。</p>
<h1 id="key列"><a href="#key列" class="headerlink" title="key列"></a>key列</h1><p>这一列显示mysql实际采用哪个索引来优化对该表的访问。</p>
<p>如果没有使用索引，则该列是 NULL。如果想强制mysql使用或忽视possible_keys列中的索引，在查询中使用 force index、ignore index。</p>
<h1 id="key-len列"><a href="#key-len列" class="headerlink" title="key_len列"></a>key_len列</h1><p>这一列显示了mysql在索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列。<br>​<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">key_len计算规则如下：</span><br><span class="line">    字符串</span><br><span class="line">    char(n)：n字节长度</span><br><span class="line">    varchar(n)：2字节存储字符串长度，如果是utf-8，则长度 3n + 2</span><br><span class="line">    数值类型</span><br><span class="line">    tinyint：1字节</span><br><span class="line">    smallint：2字节</span><br><span class="line">    int：4字节</span><br><span class="line">    bigint：8字节　　</span><br><span class="line">    时间类型　</span><br><span class="line">    date：3字节</span><br><span class="line">    timestamp：4字节</span><br><span class="line">    datetime：8字节</span><br><span class="line">    如果字段允许为 NULL，需要1字节记录是否为 NULL</span><br><span class="line">    索引最大长度是768字节，当字符串过长时，mysql会做一个类似左前缀索引的处理，将前半部分的字符提取出来做索引。</span><br><span class="line"></span><br><span class="line">EXPLAIN中的key_len一列表示什么意思，该如何解读？</span><br><span class="line"></span><br><span class="line">EXPLAIN执行计划中有一列 key_len 用于表示本次查询中，所选择的索引长度有多少字节，通常我们可借此判断联合索引有多少列被选择了。</span><br><span class="line"></span><br><span class="line">在这里 key_len 大小的计算规则是：</span><br><span class="line"></span><br><span class="line">一般地，key_len 等于索引列类型字节长度，例如int类型为4-bytes，bigint为8-bytes；</span><br><span class="line">如果是字符串类型，还需要同时考虑字符集因素，例如：CHAR(30) UTF8则key_len至少是90-bytes；</span><br><span class="line">若该列类型定义时允许NULL，其key_len还需要再加 1-bytes；</span><br><span class="line">若该列类型为变长类型，例如 VARCHAR（TEXT\BLOB不允许整列创建索引，如果创建部分索引，也被视为动态列类型），其key_len还需要再加 2-bytes;</span><br><span class="line">综上，看下面几个例子：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">备注，key_len 只指示了WHERE中用于条件过滤时被选中的索引列，是不包含 ORDER BY/GROUP BY 这部分被选中的索引列。</span><br><span class="line">例如，有个联合索引 idx1(c1, c2, c3)，3个列均是INT NOT NULL，那么下面的这个SQL执行计划中，key_len的值是8而不是12：</span><br><span class="line"></span><br><span class="line">SELECT…WHERE c1=? AND c2=? ORDER BY c3;</span><br><span class="line">​</span><br></pre></td></tr></table></figure></p>
<p>综上，看下面几个例子：</p>
<table>
<thead>
<tr>
<th>列类型</th>
<th>KEY_LEN</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id int</td>
<td>key_len = 4+1 = 5</td>
<td>允许NULL，加1-byte</td>
</tr>
<tr>
<td>id int not null</td>
<td>key_len = 4</td>
<td>不允许NULL</td>
</tr>
<tr>
<td>user char(30) utf8</td>
<td>key_len = 30*3+1</td>
<td>允许NULL，加1-byte</td>
</tr>
<tr>
<td>user varchar(30)  utf8</td>
<td>key_len = 30*3+2+1</td>
<td>动态列类型，加2-bytes；允许NULL，再加1-byte</td>
</tr>
<tr>
<td>user varchar(30) not null utf8</td>
<td>key_len = 30*3+2+1</td>
<td>动态列类型，加2-bytes</td>
</tr>
<tr>
<td>detail text(10) utf8</td>
<td>key_len = 30*3+2+1</td>
<td>TEXT列截取部分，被视为动态列类型，加2-bytes；且允许NULL</td>
</tr>
</tbody>
</table>
<h1 id="ref列"><a href="#ref列" class="headerlink" title="ref列"></a>ref列</h1><p>这一列显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），func，NULL，字段名（例：film.id）</p>
<h1 id="rows列"><a href="#rows列" class="headerlink" title="rows列"></a>rows列</h1><p>这一列是mysql估计要读取并检测的行数，注意这个不是结果集里的行数。</p>
<h1 id="Extra列"><a href="#Extra列" class="headerlink" title="Extra列"></a>Extra列</h1><p>这一列展示的是额外信息。常见的重要值如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. distinct: 一旦mysql找到了与行相联合匹配的行，就不再搜索了</span><br><span class="line"></span><br><span class="line">2. Using index：这发生在对表的请求列都是同一索引的部分的时候，返回的列数据只使用了索引中的信息，而没有再去访问表中的行记录。是性能高的表现。Using index不读数据文件，只从索引文件获取数据</span><br><span class="line"></span><br><span class="line">3. Using where：mysql服务器将在存储引擎检索行后再进行过滤。就是先读取整行数据，再按 where 条件进行检查，符合就留下，不符合就丢弃。Using where只是过滤元组，和是否读取数据文件或索引文件没有关系</span><br><span class="line"></span><br><span class="line">4. Using temporary：mysql需要创建一张临时表来处理查询。出现这种情况一般是要进行优化的，首先是想到用索引来优化。表示需要创建临时表以满足需求，通常是因为GROUP BY的列没有索引，或者GROUP BY和ORDER BY的列不一样，也需要创建临时表，建议添加适当的索引。</span><br><span class="line"></span><br><span class="line">5. Using filesort：mysql 会对结果使用一个外部索引排序，而不是按索引次序从表里读取行。此时mysql会根据联接类型浏览所有符合条件的记录，并保存排序关键字和行指针，然后排序关键字并按顺序检索行信息。这种情况下一般也是要考虑使用索引来优化的。也有可能是因为多表连接时，排序字段不是驱动表中的字段，因此也没办法利用索引完成排序，建议添加适当的索引。</span><br></pre></td></tr></table></figure>
<p><img src="//blog.com/2019/04/20/MySQL Explain详解/索引对去重的影响.png" alt="索引对去重的影响"><br><img src="//blog.com/2019/04/20/MySQL Explain详解/无索引排序.png" alt="无索引排序"><br><img src="//blog.com/2019/04/20/MySQL Explain详解/有索引排序.png" alt="有索引排序"><br><img src="//blog.com/2019/04/20/MySQL Explain详解/数据提取.png" alt="数据提取"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/replace into的存在的几种情况/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/replace into的存在的几种情况/" itemprop="url">replace into的存在的几种情况</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="replace-into的存在的几种情况"><a href="#replace-into的存在的几种情况" class="headerlink" title="replace into的存在的几种情况"></a>replace into的存在的几种情况</h1><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p><strong>存在主键并且存在唯一键</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">insert into `auto`(`k`,`v`, `extra`) values (2,&apos;2&apos;,&apos;extra 2&apos;),(3,&apos;3&apos;,&apos;extra 3&apos;),(5,null,null),(6,&apos;6&apos;,null);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">| id | k | v    | extra  |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">|  2 | 2 | 2    | extra 2 |</span><br><span class="line">|  3 | 3 | 3    | extra 3 |</span><br><span class="line">|  4 | 5 | NULL | NULL   |</span><br><span class="line">|  5 | 6 | 6    | NULL   |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<h2 id="主键冲突"><a href="#主键冲突" class="headerlink" title="主键冲突"></a>主键冲突</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当replace into 记录只与主键冲突的时候，auto_increment不会增加，它会对与主键冲突的那一条记录进行更新，没有指定的列将会被更新为默认值</strong></p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; replace into auto(id,k)values(4,10);</span><br><span class="line">Query OK, 2 rows affected (1.23 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">| id | k | v    | extra  |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">|  2 | 2 | 2    | extra 2 |</span><br><span class="line">|  3 | 3 | 3    | extra 3 |</span><br><span class="line">|  4 | 10 | NULL | NULL   |</span><br><span class="line">|  5 | 6 | 6    | NULL   |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">4 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<h2 id="主键跟唯一索引同时冲突"><a href="#主键跟唯一索引同时冲突" class="headerlink" title="主键跟唯一索引同时冲突"></a>主键跟唯一索引同时冲突</h2><p>当replace into 记录与主键跟唯一索引同时冲突的时候，<strong>auto_increment不会增加</strong></p>
<ol>
<li>如果冲突的主键和索引在同一行记录，则replace into只做更新，对于没有指定值的其他列，将会被更新为默认值，</li>
<li>如果冲突的主键和索引分别对应2行数据，则MySQL将会删除唯一索引的那一行记录，更新对应主键的那一行记录。</li>
</ol>
<p><strong>冲突的主键和索引在同一行记录   直接更新</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">| id | k | v    | extra  |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">|  2 | 2 | 2    | extra 2 |</span><br><span class="line">|  3 | 3 | 3    | extra 3 |</span><br><span class="line">|  4 | 10 | NULL | NULL   |</span><br><span class="line">|  5 | 6 | 6    | NULL   |</span><br><span class="line">+----+---+------+--------+</span><br><span class="line">4 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; replace into auto(id,k,v,extra)values(4,10,20,&apos;extra&apos;);</span><br><span class="line">Query OK, 2 rows affected (1.10 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">| id | k  | v  | extra  |</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">|  2 |  2 | 2  | extra 2 |</span><br><span class="line">|  3 |  3 | 3  | extra 3 |</span><br><span class="line">|  4 | 10 | 20 | extra  |</span><br><span class="line">|  5 |  6 | 6  | NULL   |</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">4 rows in set (1.05 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<p><strong>冲突的主键和索引分别对应2行数据   删除唯一索引的那一行记录，更新对应主键的那一行记录</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">| id | k  | v  | extra  |</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">|  2 |  2 | 2  | extra 2 |</span><br><span class="line">|  3 |  3 | 3  | extra 3 |</span><br><span class="line">|  4 | 10 | 20 | extra  |</span><br><span class="line">|  5 |  6 | 6  | NULL   |</span><br><span class="line">+----+----+----+--------+</span><br><span class="line">4 rows in set (1.05 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; replace into auto(id,k,v,extra)values(5,10,100,&apos;主键跟唯一键不在同一行，同时冲突&apos;);</span><br><span class="line">Query OK, 3 rows affected (1.14 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">| id | k  | v   | extra                            |</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">|  2 |  2 | 2   | extra 2                           |</span><br><span class="line">|  3 |  3 | 3   | extra 3                           |</span><br><span class="line">|  5 | 10 | 100 | 主键跟唯一键不在同一行，同时冲突 |</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<h2 id="唯一键冲突"><a href="#唯一键冲突" class="headerlink" title="唯一键冲突"></a>唯一键冲突</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当replace into 记录唯一索引且指定ID冲突的时候，直接将id更新为新指定的ID，其它数据也更新</strong> <br>&nbsp;&nbsp;&nbsp;&nbsp;<strong>auto_increment可能会增加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">| id | k  | v   | extra                            |</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">|  2 |  2 | 2   | extra 2                           |</span><br><span class="line">|  3 |  3 | 3   | extra 3                           |</span><br><span class="line">|  5 | 10 | 100 | 主键跟唯一键不在同一行，同时冲突 |</span><br><span class="line">+----+----+-----+----------------------------------+</span><br><span class="line">3 rows in set (1.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; replace into auto(id,k,v,extra)values(6,10,1000,&apos;唯一键冲突&apos;);</span><br><span class="line">Query OK, 2 rows affected (1.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">| id | k  | v    | extra      |</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">|  2 |  2 | 2    | extra 2     |</span><br><span class="line">|  3 |  3 | 3    | extra 3     |</span><br><span class="line">|  6 | 10 | 1000 | 唯一键冲突 |</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table auto;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">| id | k  | v    | extra              |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">|  3 |  3 | 3    | extra 3             |</span><br><span class="line">|  6 | 10 | 1000 | 唯一键冲突         |</span><br><span class="line">|  7 |  2 | 4    | 唯一键冲突 未指定id |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">3 rows in set (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; replace into auto(id,k,v,extra)values(8,10,1000,&apos;唯一键冲突v1&apos;);</span><br><span class="line">Query OK, 2 rows affected (1.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">| id | k  | v    | extra              |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">|  3 |  3 | 3    | extra 3             |</span><br><span class="line">|  7 |  2 | 4    | 唯一键冲突 未指定id |</span><br><span class="line">|  8 | 10 | 1000 | 唯一键冲突v1       |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">3 rows in set (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table auto;                                                      |</span><br><span class="line">CREATE TABLE `auto` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `k` int(10) unsigned NOT NULL,</span><br><span class="line">  `v` varchar(100) DEFAULT NULL,</span><br><span class="line">  `extra` varchar(200) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_k` (`k`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当replace into 记录唯一索引冲突且未指定ID的时候，先删除唯一索引所在的旧记录，然后再插入新的数据</strong>&nbsp;&nbsp;     <br>&nbsp;&nbsp;<strong>auto_increment会增加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">| id | k  | v    | extra      |</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">|  2 |  2 | 2    | extra 2     |</span><br><span class="line">|  3 |  3 | 3    | extra 3     |</span><br><span class="line">|  6 | 10 | 1000 | 唯一键冲突 |</span><br><span class="line">+----+----+------+------------+</span><br><span class="line">3 rows in set (1.08 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; replace into auto(k,v,extra)values(2,4,&apos;唯一键冲突 未指定id&apos;);</span><br><span class="line">Query OK, 2 rows affected (1.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from auto;</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">| id | k  | v    | extra              |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">|  3 |  3 | 3    | extra 3             |</span><br><span class="line">|  6 | 10 | 1000 | 唯一键冲突         |</span><br><span class="line">|  7 |  2 | 4    | 唯一键冲突 未指定id |</span><br><span class="line">+----+----+------+--------------------+</span><br><span class="line">3 rows in set (0.05 sec)</span><br></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>当replace into 记录只与主键冲突的时候，auto_increment不会增加，它会对与主键冲突的那一条记录进行更新，没有指定的列将会被更新为默认值</li>
</ol>
<ol start="2">
<li><p>当replace into 记录与主键跟唯一索引同时冲突的时候，auto_increment不会增加</p>
<p>（1）如果冲突的主键和索引在同一行记录，则replace into只做更新，对于没有指定值的其他列，将会被更新为默认值，</p>
<p>（2）如果冲突的主键和索引分别对应2行数据，则MySQL将会删除唯一索引的那一行记录，更新对应主键的那一行记录。</p>
</li>
</ol>
<ol start="3">
<li>当replace into 记录只与唯一索引进行冲突的时候，auto_increment + 1，再对数据进行更新。</li>
</ol>
<ul>
<li><p>最后我们可以对总结分析：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL对replace into的操作是首先是insert操作，如果insert失败，则对insert失败的这条记录进行update，如果update还是失败，则会进行delete操作之后再update。</p>
</li>
</ul>
<ul>
<li><p>具体流程是这样的：</p>
<ol>
<li>insert记录，发现主键冲突，则update这一行，update的时候发现存在唯一键冲突，则delete对应的唯一键的行后再进行update。如果insert成功，auto_increment自然+1了。</li>
<li>update记录，发现唯一键冲突，replace指定了id，则将唯一键对应的id指定为新ID。replace没有指定id，将旧记录删除，然后再插入新记录。</li>
</ol>
</li>
</ul>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a href="https://mp.weixin.qq.com/s/2AgD2YSG6R8rUTucot340A" target="_blank" rel="noopener">replace into 解析</a></li>
<li><a href="https://www.cnblogs.com/honeybaobao/p/5692332.html" target="_blank" rel="noopener">replace into的存在的几种情况</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/show processlist中最哪些状态要引起关注/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/show processlist中最哪些状态要引起关注/" itemprop="url">show processlist中最哪些状态要引起关注</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="show-processlist中最哪些状态要引起关注"><a href="#show-processlist中最哪些状态要引起关注" class="headerlink" title="show processlist中最哪些状态要引起关注"></a>show processlist中最哪些状态要引起关注</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般而言，我们在processlist结果中如果经常能看到某些SQL的话，至少可以说明这些SQL的频率很高，通常需要对这些SQL进行进一步优化。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;今天我们要说的是，在processlist中，看到哪些运行状态时要引起关注，主要有下面几个：</p>
<table>
<thead>
<tr>
<th><strong>状态</strong></th>
<th><strong>建议</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>copy to tmp  table</strong></td>
<td>执行ALTER TABLE修改表结构时<br><br>          <strong>建议：</strong>放在凌晨执行或者采用类似pt-osc工具</td>
</tr>
<tr>
<td><strong>Copying to tmp table</strong></td>
<td>拷贝数据到内存中的临时表，常见于GROUP BY操作时<br><br><strong>建议：</strong>创建适当的索引</td>
</tr>
<tr>
<td><strong>Copying to tmp table on disk</strong></td>
<td>临时结果集太大，内存中放不下，需要将内存中的临时表拷贝到磁盘上，形成 .MYD、.MYI（在5.6及更高的版本，临时表可以改成InnoDB引擎了，可以参考选项<strong>default_tmp_storage_engine</strong>）<br><br><strong>建议：</strong>创建适当的索引，并且适当加大<strong>sort_buffer_size/tmp_table_size/max_heap_table_size</strong></td>
</tr>
<tr>
<td><strong>Creating sort index</strong></td>
<td>当前的SELECT中需要用到临时表在进行ORDER BY排序 <br><br><strong>建议：</strong>创建适当的索引</td>
</tr>
<tr>
<td><strong>Creating tmp table</strong></td>
<td>创建基于内存或磁盘的临时表，当从内存转成磁盘的临时表时，状态会变成：Copying to tmp table on disk <br><br><strong>建议：</strong>创建适当的索引，或者少用UNION、视图(VIEW)、子查询(SUBQUERY)之类的，确实需要用到临时表的时候，可以在session级临时适当调大 <strong>tmp_table_size/max_heap_table_size</strong> 的值</td>
</tr>
<tr>
<td><strong>Reading from net</strong></td>
<td>表示server端正通过网络读取客户端发送过来的请求                                                            <br><br><strong>建议：</strong>减小客户端发送数据包大小，提高网络带宽/质量</td>
</tr>
<tr>
<td><strong>Sending data</strong></td>
<td>从server端发送数据到客户端，也有可能是接收存储引擎层返回的数据，再发送给客户端，数据量很大时尤其经常能看见备注：Sending Data不是网络发送，是从硬盘读取，发送到网络是Writing to net<br><br><strong>建议：</strong>通过索引或加上LIMIT，减少需要扫描并且发送给客户端的数据量</td>
</tr>
<tr>
<td><strong>Sorting result</strong></td>
<td>正在对结果进行排序，类似Creating sort index，不过是正常表，而不是在内存表中进行排序<br><br><strong>建议：</strong>创建适当的索引</td>
</tr>
<tr>
<td><strong>statistics</strong></td>
<td>进行数据统计以便解析执行计划，如果状态比较经常出现，有可能是磁盘IO性能很差<br><br><strong>建议：</strong>查看当前io性能状态，例如iowait</td>
</tr>
<tr>
<td><strong>Waiting for global read lock</strong></td>
<td>FLUSH TABLES WITH READ LOCK整等待全局读锁<br><br><strong>建议：</strong>不要对线上业务数据库加上全局读锁，通常是备份引起，可以放在业务低谷期间执行或者放在slave服务器上执行备份</td>
</tr>
<tr>
<td><strong>Waiting for tables,Waiting for table flush</strong></td>
<td>FLUSH TABLES, ALTER TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE, OPTIMIZE TABLE等需要刷新表结构并重新打开<br><br><strong>建议：</strong>不要对线上业务数据库执行这些操作，可以放在业务低谷期间执行</td>
</tr>
<tr>
<td><strong>Waiting for lock_type lock</strong></td>
<td>等待各种类型的锁：• Waiting for event metadata lock• Waiting for global read lock• Waiting for schema metadata lock• Waiting for stored function metadata lock• Waiting for stored procedure metadata lock• Waiting for table level lock• Waiting for table metadata lock• Waiting for trigger metadata lock<br><br> <strong>建议：</strong>比较常见的是上面提到的global read lock以及table metadata lock，建议不要对线上业务数据库执行这些操作，可以放在业务低谷期间执行。如果是table level lock，通常是因为还在使用MyISAM引擎表，赶紧转投InnoDB引擎吧，别再老顽固了</td>
</tr>
</tbody>
</table>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更多详情可参考官方手册：8.14.2 General Thread States 章节（<a href="http://dev.mysql.com/doc/refman/5.6/en/general-thread-states.html）" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.6/en/general-thread-states.html）</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/mysql中pager命令的妙用/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/mysql中pager命令的妙用/" itemprop="url">mysql中pager命令的妙用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mysql中pager命令的妙用"><a href="#mysql中pager命令的妙用" class="headerlink" title="mysql中pager命令的妙用"></a>mysql中pager命令的妙用</h1><blockquote>
<p>原文地址：<a href="https://www.cnblogs.com/kevingrace/p/6269816.html" target="_blank" rel="noopener">https://www.cnblogs.com/kevingrace/p/6269816.html</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在mysql日常操作中，妙用pager设置显示方式，可以大大提高工作效率。比如select出来的结果集超过几个屏幕，那么前面的结果一晃而过无法看到，这时候<strong>使用pager可以设置调用os的more或者less等显示查询结果，和在os中使用more或者less查看大文件的效果一样</strong>。</p>
<p>pager用法：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际上等于将它设置以后的所有mysql操作命令的<strong>输出通过pager设置命令执行，类似于管道符的作用</strong></p>
<p>nopager命令：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>取消pager设置，恢复之前的输出状态</strong>。（如果不设置nopager，那么只能通过重启mysql服务才能恢复了）</p>
<p>举些例子来说明吧：</p>
<p>1）当处理大量数据时，不想显示查询的结果，而只需知道查询花费的时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from huanqiu.haha;</span><br><span class="line">+----+------------+</span><br><span class="line">| id | name       |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | wangshibo  |</span><br><span class="line">|  2 | wangshikui |</span><br><span class="line">|  3 | wangjuan   |</span><br><span class="line">|  4 | wangman    |</span><br><span class="line">| 11 | wangshikui |</span><br><span class="line">+----+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line">mysql&gt; pager cat /dev/null;        //实际上等于后面执行的命令|cat /dev/null，这样显示结果就只是执行时间了</span><br><span class="line">PAGER set to &apos;cat /dev/null&apos;</span><br><span class="line">mysql&gt; select * from huanqiu.haha; </span><br><span class="line">5 rows in set (0.00 sec)&lt;br&gt;</span><br><span class="line">mysql&gt; nopager;                   //恢复之前的输出状态</span><br><span class="line">PAGER set to stdout&lt;br&gt;</span><br><span class="line">mysql&gt; select * from huanqiu.haha;</span><br><span class="line">+----+------------+</span><br><span class="line">| id | name       |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | wangshibo  |</span><br><span class="line">|  2 | wangshikui |</span><br><span class="line">|  3 | wangjuan   |</span><br><span class="line">|  4 | wangman    |</span><br><span class="line">| 11 | wangshikui |</span><br><span class="line">+----+------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>2）如果有大量连接，用show processlist看不方便，想看有多少Sleep状态，则可以用pager。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+------+---------------------+--------------+---------+------+-------+------------------+</span><br><span class="line">| Id | User | Host                | db           | Command | Time | State | Info             |</span><br><span class="line">+----+------+---------------------+--------------+---------+------+-------+------------------+</span><br><span class="line">|  1 | root | 192.168.132.2:57168 | 37finance    | Sleep   | 6837 |       | NULL             |</span><br><span class="line">|  2 | root | 192.168.132.2:57170 | 37finance    | Sleep   | 7501 |       | NULL             |</span><br><span class="line">| 45 | root | localhost           | test_finance | Query   |    0 | init  | show processlist |</span><br><span class="line">| 48 | root | 192.168.132.2:62440 | 37finance    | Sleep   | 6965 |       | NULL             |</span><br><span class="line">+----+------+---------------------+--------------+---------+------+-------+------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">mysql&gt; pager grep Sleep |wc -l;    </span><br><span class="line">PAGER set to &apos;grep Sleep |wc -l&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; show processlist;           //类似于show processlist结果再通过grep Sleep |wc -l显示；下面表示一共有2个连接，其中0个Sleep状态的连接。</span><br><span class="line">0</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager;                    //恢复之前的输出状态</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">如果想进一步了解每个连接的状态，可以</span><br><span class="line"></span><br><span class="line">mysql&gt; pager awk -F &apos;|&apos; &apos;&#123;print $6&#125;&apos; |sort |uniq -c |sort -r </span><br><span class="line">PAGER set to &apos;awk -F &apos;|&apos; &apos;&#123;print $6&#125;&apos; |sort |uniq -c |sort -r&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">      3  Sleep   </span><br><span class="line">      3 </span><br><span class="line">      1  Query   </span><br><span class="line">      1  Command </span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">这样显示出连接状态。</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager       #关闭pager</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; pager awk -F &apos;|&apos; &apos;!/---------/&#123;print $6&#125;&apos; |sort |uniq -c |sort -r</span><br><span class="line">PAGER set to &apos;awk -F &apos;|&apos; &apos;!/---------/&#123;print $6&#125;&apos; |sort |uniq -c |sort -r&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">      3  Sleep   </span><br><span class="line">      1  Query   </span><br><span class="line">      1  Command </span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager       #关闭pager</span><br></pre></td></tr></table></figure>
<p>3）设置pager，只查看slave状态的几个status值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status \G;              //其中的\G表示显示要换行显示</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.1.101</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 5370489</span><br><span class="line">               Relay_Log_File: mysql-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 2476520</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: huanqiu,huanpc</span><br><span class="line">          Replicate_Ignore_DB: mysql</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 5370489</span><br><span class="line">              Relay_Log_Space: 2476693</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 101</span><br><span class="line">                  Master_UUID: b667a58f-d6e0-11e6-8c0a-fa163e2d66ac</span><br><span class="line">             Master_Info_File: /data/mysql/data/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"> </span><br><span class="line">mysql&gt; pager cat | egrep -i &apos;system user|Exec_Master_Log_Pos|Seconds_Behind_Master|Read_Master_Log_Pos&apos;;</span><br><span class="line">PAGER set to &apos;cat | egrep -i &apos;system user|Exec_Master_Log_Pos|Seconds_Behind_Master|Read_Master_Log_Pos&apos;&apos;</span><br><span class="line"> </span><br><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">          Read_Master_Log_Pos: 5370489</span><br><span class="line">          Exec_Master_Log_Pos: 5370489</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"> </span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"> </span><br><span class="line">mysql&gt; nopager;                 //恢复之前的显示状态</span><br><span class="line">PAGER set to stdout</span><br></pre></td></tr></table></figure>
<p><strong>注意事项：加上\G结果是不一样的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pager grep 刘泽明</span><br><span class="line"></span><br><span class="line">select * from center_voucher_main;</span><br><span class="line"></span><br><span class="line">                          |</span><br><span class="line">| 30383 |              | SRZG-2019-02-02-10676 | 2019-02-21   | 2019-01        | 计提                   | 201812 - 镇魔曲网页版 - 暂估腾讯收入                                                                           | 2018-12-31  | 2018-12-01  | 刘泽明       | 2019-02-21 17:22:52 | 刘泽明   | 2019-02-21 17:17:03 |      0 |          0 | income_centerincomezg                                 |  36807 | NULL        | 2019-02-21 17:23:47 | 2019-02-21 17:17:03 | 刘泽明   | NULL      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from center_voucher_main\G;</span><br><span class="line"></span><br><span class="line">import_user: 刘泽明</span><br><span class="line">create_user: 刘泽明</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; nopager;                 //恢复之前的显示状态</span><br></pre></td></tr></table></figure>
<p><strong>将输出保存到文件，采用&gt;或&gt;&gt;进行重定向输出</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 记录输出</span><br><span class="line"></span><br><span class="line">mysql&gt; pager grep 刘泽明&gt;/root/test_mysql_output.txt</span><br><span class="line">PAGER set to &apos;grep 刘泽明&gt;cat /root/test_mysql_output.txt&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from center_voucher_main\G;</span><br><span class="line">30308 rows in set (1.94 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager;                 //恢复之前的显示状态</span><br><span class="line"></span><br><span class="line">cat /root/test_mysql_output.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 统计行数</span><br><span class="line"></span><br><span class="line">mysql&gt; pager grep 刘泽明|wc -l &gt;/root/test_mysql_output.txt</span><br><span class="line">PAGER set to &apos;grep 刘泽明|wc -l &gt;/root/test_mysql_output.txt&apos;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from center_voucher_main\G;</span><br><span class="line">30308 rows in set (1.93 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; nopager;                 //恢复之前的显示状态</span><br><span class="line"></span><br><span class="line">cat /root/test_mysql_output.txt</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/95/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/95/">95</a><span class="page-number current">96</span><a class="page-number" href="/page/97/">97</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/97/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
