<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/46/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/46/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/08/shell数组操作/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/shell数组操作/" itemprop="url">shell数组操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T12:12:57+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/shell/" itemprop="url" rel="index">
                    <span itemprop="name">shell</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/shell/bash/" itemprop="url" rel="index">
                    <span itemprop="name">bash</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="shell数组操作"><a href="#shell数组操作" class="headerlink" title="shell数组操作"></a>shell数组操作</h1><hr>
<ul><br><li><a href="#define">定义</a></li><br><li><a href="#length">数组长度</a></li><br><li><a href="#scan">数组遍历</a></li><br><li><a href="#set">数组赋值</a></li><br><li><a href="#set">数组赋值</a></li><br><li><a href="#burst">数据切片</a></li><br><li><a href="#replace">数组元素替换</a></li><br><li><a href="#delete">数组元素删除</a></li><br><li><a href="#add">添加新元素到数组末尾</a></li><br><li><a href="#map">关联数组</a></li><br><li><a href="#index">获取所有键名</a></li><br></ul>

<h2 id="define">定义</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">array_name=(</span><br><span class="line">  刘泽明</span><br><span class="line">  刘艳</span><br><span class="line">  刘倩</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">names=(刘泽明 刘艳 刘倩)</span><br><span class="line"></span><br><span class="line">array_name[0]=&quot;刘泽明&quot;</span><br><span class="line">array_name[1]=&quot;刘艳&quot;</span><br><span class="line">array_name[2]=&quot;刘倩&quot;</span><br><span class="line"></span><br><span class="line">array_name=([0]=&quot;刘泽明&quot; [1]=&quot;刘艳&quot; [2]=&quot;刘倩&quot;)</span><br><span class="line"></span><br><span class="line">str=&quot;刘泽明 刘艳 刘倩&quot;</span><br><span class="line">array_name=($str)</span><br></pre></td></tr></table></figure>
<h2 id="length">数组长度</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">names=(刘泽明 刘艳 刘倩)</span><br><span class="line"></span><br><span class="line">echo $&#123;#names[*]&#125;</span><br><span class="line"></span><br><span class="line">echo $&#123;#names[@]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="scan">数组遍历</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">str=&quot;刘泽明 刘艳 刘倩&quot;</span><br><span class="line">array_name=($str)</span><br><span class="line"></span><br><span class="line">for name in $&#123;array_name[*]&#125;</span><br><span class="line">do</span><br><span class="line">    echo $name</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">for name in $&#123;array_name[@]&#125;</span><br><span class="line">do</span><br><span class="line">    echo $name</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="set">赋值</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> names=(刘泽明 刘艳 刘倩)</span><br><span class="line"> </span><br><span class="line"> echo $&#123;#names[*]&#125;</span><br><span class="line"> </span><br><span class="line">for name in $&#123;names[@]&#125;</span><br><span class="line"></span><br><span class="line">do</span><br><span class="line"></span><br><span class="line">echo $name</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">names[0]=&quot;邓琴琴&quot;</span><br><span class="line"></span><br><span class="line">echo $&#123;names[@]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="burst">数据切片</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">array=(zero one two three four)</span><br><span class="line"></span><br><span class="line">echo $array #默认取数组第一个元素</span><br><span class="line"></span><br><span class="line">echo $&#123;array[0]&#125;</span><br><span class="line"></span><br><span class="line">echo $&#123;array[@]&#125;</span><br><span class="line"></span><br><span class="line">echo $&#123;array[@]:1&#125; #表示从索引1开始,取剩下的全部元素</span><br><span class="line"></span><br><span class="line">echo $&#123;array[@]:0:3&#125; #表示从索引0开始,取3个元素</span><br><span class="line"></span><br><span class="line">echo $&#123;array[@]::4&#125; #表示从索引0开始,取4个元素</span><br><span class="line"></span><br><span class="line">echo $&#123;array[@]:(-2):2&#125; #-1表示数组最后一个元素,2表示取两个元素</span><br><span class="line"></span><br><span class="line">new_array=($&#123;array[@]:1:4&#125;) #切片后组成新的数组</span><br><span class="line"></span><br><span class="line">echo $&#123;new_array[@]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="replace">数组元素替换</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$&#123;array[@]/x/y&#125;     最小匹配替换，每个元素只替换一次</span><br><span class="line"></span><br><span class="line">$&#123;array[@]//x/y&#125;    最大匹配替换，每个元素可替换多次</span><br><span class="line"></span><br><span class="line">$&#123;array[@]/x/&#125;      最小匹配删除，只删除一个符合规定的元素</span><br><span class="line"></span><br><span class="line">$&#123;array[@]//x/&#125;     最大匹配删除，可删除多个符合规定的元素</span><br><span class="line"></span><br><span class="line">        echo $&#123;array[@]/e/E&#125;       #zEro onE two thrEe four</span><br><span class="line">        </span><br><span class="line">        echo $&#123;array[@]//e/E&#125;      #zEro onE two thrEE four</span><br><span class="line">        </span><br><span class="line">        echo $&#123;array[@]/e/&#125;      #zro on two thre four</span><br><span class="line">        </span><br><span class="line">        echo $&#123;array[@]//e/&#125;      #zro on two thr four</span><br><span class="line">        </span><br><span class="line">$&#123;array[@]/#x/y&#125;     从左往右匹配替换，只替换每个元素最左边的字符</span><br><span class="line"></span><br><span class="line">$&#123;array[@]/%x/y&#125;     从右往左匹配替换，只替换每个元素最右边的字符</span><br><span class="line">        </span><br><span class="line">        echo $&#123;array[@]/#o/O&#125;     #zero One two three four</span><br><span class="line">        </span><br><span class="line">        echo $&#123;array[@]/%o/O&#125;     #zerO one twO three four</span><br></pre></td></tr></table></figure>
<h2 id="delete">数组元素删除</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(1)删除整个数组元素</span><br><span class="line"></span><br><span class="line">array=(zero one two three four)</span><br><span class="line">    </span><br><span class="line">echo $&#123;array[@]&#125;</span><br><span class="line">    </span><br><span class="line">unset array[0]</span><br><span class="line">    </span><br><span class="line">echo $&#123;array[@]&#125;</span><br><span class="line"></span><br><span class="line">(2)删除某个数组元素的一部分</span><br><span class="line"> </span><br><span class="line"> #  每个元素,从左向右进行最短匹配</span><br><span class="line"> </span><br><span class="line"> ## 每个元素,从左向右进行最长匹配</span><br><span class="line"></span><br><span class="line"> %  每个元素,从右向左进行最短匹配   </span><br><span class="line"></span><br><span class="line"> %% 每个元素,从右向左进行最长匹配</span><br><span class="line"></span><br><span class="line">    list=(book food)</span><br><span class="line">    </span><br><span class="line">    echo $&#123;list[@]#b*o&#125;        #ok food</span><br><span class="line">    </span><br><span class="line">    echo $&#123;list[@]##b*o&#125;       #k food</span><br><span class="line">    </span><br><span class="line">    echo $&#123;list[@]%o*d&#125;        #book fo</span><br><span class="line">    </span><br><span class="line">    echo $&#123;list[@]%%o*d&#125;       #book f</span><br></pre></td></tr></table></figure>
<h2 id="add">添加新元素到数组末尾</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">number=(1111 2222 3333)</span><br><span class="line"></span><br><span class="line">echo $&#123;number[@]&#125;</span><br><span class="line"></span><br><span class="line">number=($&#123;number[@]&#125; 4444)</span><br><span class="line"></span><br><span class="line">echo $&#123;number[@]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="map">关联数组</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">declare -A ass_arr  #必须申明为数组</span><br><span class="line">ass_arr[&quot;apple&quot;]=12;</span><br><span class="line">ass_arr[&quot;orange&quot;]=19</span><br><span class="line">echo $&#123;ass_arr[@]&#125;</span><br><span class="line">for t in &quot;$&#123;ass_arr[@]&#125;&quot;</span><br><span class="line">do</span><br><span class="line">  echo $t</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">#19 12</span><br><span class="line">#19</span><br><span class="line">#12</span><br><span class="line"></span><br><span class="line">echo &quot;ass_arr[\&quot;orange\&quot;]=&quot;$&#123;ass_arr[&quot;orange&quot;]&#125; #ass_arr[“orange”]=19</span><br></pre></td></tr></table></figure>
<h2 id="index">获取所有键名</h2>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo $&#123;!ass_arr[@]&#125; #or $&#123;!ass_arr[*]&#125;</span><br><span class="line">echo $&#123;!ass_arr[*]&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/08/如何优雅的设计一个告警系统/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/如何优雅的设计一个告警系统/" itemprop="url">如何优雅的设计一个告警系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T12:12:57+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/监控体系搭建/" itemprop="url" rel="index">
                    <span itemprop="name">监控体系搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何优雅的设计一个告警系统"><a href="#如何优雅的设计一个告警系统" class="headerlink" title="如何优雅的设计一个告警系统"></a>如何优雅的设计一个告警系统</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/FwiyS2HsaY7F6nBbeeb4lw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/FwiyS2HsaY7F6nBbeeb4lw</a></p>
</blockquote>
<p><br></p>
<h2 id="告警的本质"><a href="#告警的本质" class="headerlink" title="告警的本质"></a>告警的本质</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;没有多少系统的告警是设计得当的。良好的告警设计是一项非常困难的工作。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如何知道你收到的告警是糟糕的？多少次你收到了告警之后，立即就关掉了的？是不是成天被这些没有什么卵用的东西给淹没？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最常见的告警设置：<code>cpu</code>使用率超过<code>90%</code>，然后告警。这种设置在大部分场合下是没有办法提供高质量的告警的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;高质量的告警应该是这样的：每次收到之后你可以立即评估影响的范围，并且每一个告警需要你做出分级响应。所谓每个告警都应该是，<code>actionable</code>的。</p>
<p>告警的实质可以用下图表明：</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/1.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务器的设计应该是以这样的无人值守为目的的。假设所有的运维全部放假了，服务也能<code>7*24</code>自动运转。</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/2.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;告警的实质就是“<strong>把人当服务用</strong>”。在一些事情还没有办法做到程序化执行的时候，用告警通知人的方式去干预系统达到修正的目的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一次告警就像一次服务调用一样。如果告警了，但是收到告警的人并不需要做任何处理，那么这就是一种<code>DDoS</code>攻击，攻击的是运维的幸福生活。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很多时候，告警通知人去干的事情是真的可以被自动化掉的。比如服务器挂了，换一台上来。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在小一点的系统里，可能就是停机一会，人工来处理换一台冷备的机器上去。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大一点的系统，因为服务器多了，天天都挂可不行，必须是热备的，系统自动切换到备机。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;再大一点的系统，因为切换实在太频繁了，故障机的退库，备机的保有都变成了一种管理负担，那么可以和其他的运维流程打通变成完全自动化的系统。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;只是因为业务处理不同阶段，选择不同的实现策略而已。业务量小，拿血肉当机器用，有的时候更经济而已。当然对于那个被当成机器人来用的哥们来说，生活确实有点不公平。</p>
<h2 id="告警对象"><a href="#告警对象" class="headerlink" title="告警对象"></a>告警对象</h2><p>告警对象可以分为两种：</p>
<ul>
<li><strong>业务规则监控</strong></li>
<li><strong>系统可靠性监控</strong></li>
</ul>
<p>对于业务规则监控可以举一个游戏的例子。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如DNF的游戏角色在一定装备的情况下，单次打击的伤害输出应该是有一个上限，如果超过了就说明有作弊的情况。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;又比如斗地主游戏里一个人的连胜场次是有一定上限的，每天的胜率是有一定上限，如果超出平均值太多就可能是作弊。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>业务规则监控的不是硬件，也不是软件是否工作正常</strong>。而是<strong>软件是否按照业务规则实现的，是否有漏洞</strong>。也可以理解为<strong>对“正确性”的监控</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;系统可靠性监控是最常见的监控形式，比如发现是不是服务器挂掉了，服务是不是过载了等等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于大部分后台服务，系统可以抽象建模成这个样子：</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/3.webp" alt=""></p>
<p>对于这样的系统可以采集什么指标？</p>
<ul>
<li><strong>请求数，请求到达速率</strong></li>
<li><strong>正常响应数，正常响应占比</strong></li>
<li><strong>错误响应数，错误响应占比</strong></li>
<li><strong>响应延时</strong></li>
<li><strong>队列长度，排队时间</strong></li>
</ul>
<p>实际的情况是，几乎任何系统都不是孤立运行的。而是这样的：</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/4.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个<code>DB</code>会依赖于底层的<code>cpu</code>，内存，磁盘等资源。一个<code>Http</code>服务会依赖于底层的<code>DB</code>服务。一个应用会依赖于数个底层的<code>RPC</code>服务。</p>
<p>于是又多了几个指标：</p>
<ul>
<li>资源A的调用量（比如<code>CPU</code>使用率）</li>
<li>资源B的调用量（比如内存分配和释放）</li>
<li>资源C的调用量（比如网络发送包量）</li>
<li>…</li>
</ul>
<p>这种层次结构，一般来说简单来说可以分为四层：</p>
<ul>
<li><strong>产品策略和营销</strong>：它们决定了根本的请求到达的速率</li>
<li><strong>应用层</strong>（更粗俗一点可以叫<code>web</code>层）：最上层的胶水</li>
<li><strong>服务层</strong>：<code>db</code>，各种<code>RPC</code>服务，以及层层嵌套的服务</li>
<li><strong>硬件层</strong>：<code>cpu</code>，内存，磁盘，网络</li>
</ul>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/5.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为这样的一个依赖层次。<strong>上一层对下一层的资源消耗量变成了下一层的请求数</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如<code>Http</code>服务消耗了多少<code>DB</code>的资源，就对应了<code>DB</code>服务需要处理多少请求数。<code>DB</code>繁忙与否取决于<code>Http</code>服务请求，<code>Http</code>服务请求繁忙与否取决于多少人打开客户端，多少人打开客户端又取决于产品策略和营销活动。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种层次结构决定了单纯跟踪一个指标，比如绝对请求数，很难说明这一层的服务是否出现了故障。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有这么多层次，每层又有很多指标可以采集。那么应该采集什么指标，用什么告警策略去告警呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最前面已经提到了告警必须是<code>actionable</code>的，但是实际情况下只有这种纲领性要求仍然是不好操作的。至少可以提几点不应该做的事情：</p>
<ul>
<li>不应该用采集的难度决定你使用什么指标去告警。很多情况下<code>cpu</code>使用率可能是最好采集的，但是未必是最值得告警的。</li>
</ul>
<ul>
<li>不要给运维他们想要的告警，而是要做“真正”想要的告警。大部分情况下，人们告诉你的是一个解决方案。运维告诉你它需要对<code>db</code>进程的<code>cpu</code>使用率超过<code>x%</code>的时候告警，它给你的是一个他认为最优的解决方案。但是他真正想要的是知道<code>db</code>服务是否有异常，<code>cpu</code>使用率超过<code>x%</code>未必是最好的告诉你服务是否出现异常的指标。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;盲目地采集那些容易获取的指标，并随意地设定阈值告警是大部分糟糕的告警质量的根源。</p>
<h2 id="监控的指标和策略"><a href="#监控的指标和策略" class="headerlink" title="监控的指标和策略"></a>监控的指标和策略</h2><p>那到底应该采集什么指标呢？我认为大部分的系统可靠性监控不外乎三个目标：</p>
<ul>
<li><code>is the work getting done？</code><strong>系统是否在持续完成其设定的工作</strong></li>
</ul>
<ul>
<li><code>is the user having good experience？</code><strong>用户体验是否好</strong></li>
</ul>
<ul>
<li><code>where is the problem/bottleneck？</code><strong>问题或者瓶颈在哪里</strong></li>
</ul>
<h3 id="系统是否在持续完成其设定的工作"><a href="#系统是否在持续完成其设定的工作" class="headerlink" title="系统是否在持续完成其设定的工作"></a>系统是否在持续完成其设定的工作</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其中最核心最关键的是第一个问题，<code>is the work getting done</code>。对于数据库来说，我们可以采集：</p>
<ul>
<li><p><code>cpu</code>使用率</p>
</li>
<li><p>网络带宽大小</p>
</li>
<li><p><code>db</code>请求数</p>
</li>
<li><p><code>db</code>响应数</p>
</li>
<li><p><code>db</code>错误响应数</p>
</li>
<li><p><code>db</code>请求延迟</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;显然要回答一个db是否完成了其指定的工作，更应该关注的指标是这两个：</p>
<ul>
<li><code>db</code>请求数的绝对量</li>
<li><code>db</code>正确响应相对请求数的占比</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这两个指标相对于采集什么<code>cpu</code>使用率更能说明问题。不仅仅是<code>db</code>，各个层次的服务都可以用请求量和正确响应占比来反映其工作状况。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如<code>http</code>请求数（对比<code>http</code>正确响应数），比如<code>app</code>打开次数（对比服务端记录的在线人数）等等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为什么<code>cpu</code>使用率不能说明问题？大部分时候，我们并不关心<code>cpu</code>本身，而关心使用<code>cpu</code>为资源的服务。所以<code>cpu</code>使用率只是一种资源的请求数而已。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与请求数相关的一个概念是<code>saturation</code>（上限），当上限达到的时候，处理开始排队，延迟开始变长，错误率开始升高。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那么<code>cpu</code>使用率是不是能够说明上限呢？<code>cpu</code>使用率的上限以<code>100%</code>记，那么<code>90%</code>开始告警不是很合理吗？毕竟<code>cpu 100%</code>了几乎可以等同于<code>db</code>无法正常处理请求了。</p>
<p>这种利用底层资源调用量，评估其是否达到上限的做法有两个根本缺陷：</p>
<ul>
<li><p>你<strong>无法知道上层服务可以把底层资源利用到什么程度</strong></p>
</li>
<li><p><strong>底层资源的 <code>saturation</code>未必可以容易度量</strong></p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;具体来说，<code>db</code>是不是可以真的<code>100%</code>利用<code>cpu</code>是未知的。假如请求里锁，或者<code>sleep</code>，那么也许<code>cpu</code>永远也无法达到<code>100%</code>，<code>90%</code>可能就是极限了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而且现代的<code>cpu</code>是多核的，如果请求处理只能利用单核，处理在多个核之间跳跃，对于一个核来说永远也不会一直保持<code>100%</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于<code>cpu</code>可能其上限真的有一个<code>100%</code>的值。但是对于很多非硬件的服务，比如你是一个登陆服务，依赖于一个db。那么这个<code>db</code>每秒可以处理的不同<code>sql</code>组合数是很难度量的，绝非和磁盘一样有一个<code>mb/s</code>的极限绝对值可以做为对比。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而且度量底层资源的使用还有一个缺陷是你无法枚举出所有依赖的资源的。所以与其这么绕弯子地通过底层资源来间接监控上层服务是否正常，还不如直接测量<code>work</code>是不是<code>getting done</code>呢。</p>
<h3 id="用户体验是否好"><a href="#用户体验是否好" class="headerlink" title="用户体验是否好"></a>用户体验是否好</h3><p>对于第二个问题，<code>is the user having good experience？</code>可以采集的指标为</p>
<ul>
<li><p><strong>平均排队时间，平均总响应延迟</strong></p>
</li>
<li><p><code>99/95/90 percentile</code>的<strong>排队时间</strong>，<code>99/95/90 percentile</code>的<strong>响应延迟</strong></p>
</li>
</ul>
<p>这里的用户不一定是指人或者玩家，可能是上一层的服务调用方，另外一个系统。</p>
<h3 id="故障定位"><a href="#故障定位" class="headerlink" title="故障定位"></a>故障定位</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三个问题就是所谓的故障定位。要是人工来做的话，最常见的做法是收到了告警，然后登陆<code>CRT</code>，开始敲各种命令查找原因。</p>
<p>对于系统来说，最合适的做法不是出了问题再去执行一堆命令，而是：</p>
<ol>
<li>每个层次都对自己做告警</li>
<li>顶层服务出了告警触发自动定位程序</li>
<li>按照服务的依赖关系和大致的时间范围，定位到告警之间的关联，从而找到出问题或者瓶颈的地方</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然实际情况是很复杂的。很多原因和结果是互为因果的。两个告警是两个现象，还是一个原因一个现象实际上很难说得清楚。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从告警算法的角度来讲，对成功请求率，或者平均响应延迟做告警是非常容易的。静态阈值大家看不起，觉得简单。但是大部分告警用静态阈值就可以解决问题。</p>
<h2 id="理论与现实"><a href="#理论与现实" class="headerlink" title="理论与现实"></a>理论与现实</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那告警要不要高难度的算法？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我的观点是采集到了正确的指标，是不需要复杂算法的，就是静态阈值都可以搞得定。但是至少有三种场合需要算法：</p>
<ul>
<li><strong>无法直接采集到错误数：需要对错误日志的自动分类</strong></li>
<li><strong>无法直接采集到请求成功率：需要对请求数或响应数的绝对值做异常检测</strong></li>
<li><strong>只有总数，无法采集到其中的每个细分构成项的占比：需要对参与的<code>factor</code>进行算法拟合</strong></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实这三项都是一个主题的，当你无法直接获取到告警所需的指标的时候，事情会变得复杂很多。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有一个比喻是：最近<code>NASA</code>宣布的地球孪生兄弟<code>Kepler 452b</code>。如果我们的探测器可以跑到<code>1400</code>光年之外，发现他将是非常容易的事情。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;正是因为直接获得数据非常困难，所以科学家才需要根据行星阻挡恒星时引起的亮度变化（所谓掩星法）来发现这些遥远的星球。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;采集所需的指标的困难可能是几方面的因素。一种原因是采集本身是非常消耗资源的事情。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如获取每个<code>mysql</code>查询所消耗的<code>cpu</code>。跟踪每个请求处理过程是不可能的。这个时候就需要算法的帮助了，可以仔细看一下<code>vividcortex</code>的视频：</p>
<ul>
<li><a href="http://www.youtube.com/watch?v=szAfGjwLO8k" target="_blank" rel="noopener">http://www.youtube.com/watch?v=szAfGjwLO8k</a></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更多情况是采集指标困难是<code>D/O</code>分离造成的沟通问题，运维需要的指标需要开发去埋点，而开发埋点的地方又需要运维去做告警。很多时候退而求其次就会造成，有什么指标就用什么指标的状况。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如虽然没有请求响应的错误数，但是错误基本上都会有错误日志记录，根据错误日志滚动的快慢可以大致知道是不是出了问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这就引入了一个非常困难的日志分类问题，什么日志代表了正常，什么日志代表了异常，异常又非了哪些类型？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个方面算法做得好的是<code>summo logic</code>公司：</p>
<ul>
<li><a href="https://www.sumologic.com/" target="_blank" rel="noopener">https://www.sumologic.com/</a> </li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为什么这种<code>opsdev</code>（嘲讽<code>devops</code>那）公司如此热衷于算法？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于他们来说好处是显而易见的，客户需要做的改动越少，接入成本越低，客户面就越广。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是拿机器算法去挖掘海量日志真的是回答：<code>is the work getting done？</code>的最佳手段？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;显然不是。这就是大炮打蚊子。日志的存在是用于解决问题，而不是有了海量日志了，如何用好“它们”变成了问题本身。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三类情况是没有办法采集到请求成功率，只能对绝对的处理成功的量。只有这类数据要告警，就无法做简单的静态阈值了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于延迟，一般可以定一个业务上可以接受的延迟上限。对于成功率，也可以定一个可接受的成功率上限。但是对于绝对的处理量，是没有办法简单地比较一个静态阈值就可以判断是正常还是异常的。</p>
<p>在讨论如何实现之前，再强调两点：</p>
<ul>
<li>处理成功的量不是度量<code>is work getting done</code>的最佳指标。费事费力去搞算法，不如直接把成功率指标给采集了</li>
<li>处理成功的量，还取决于请求数。而请求数根本上是取决于上层服务。</li>
</ul>
<p>你是一个<code>dba</code>，发现<code>db</code>的每秒处理的请求数陡降了。这说明是<code>db</code>故障了？还是<code>app</code>故障了？</p>
<p>都有可能……最最上层是产品和营销。</p>
<p>你发现一个业务的注册量相对前几天变少了，这个是不是说明注册服务出问题了？</p>
<p>也许是产品太烂了，游戏根本没有人来玩。也可能是营销手段的营销，不送金币了，玩家没积极性了。</p>
<h2 id="异常检测"><a href="#异常检测" class="headerlink" title="异常检测"></a>异常检测</h2><p>只有请求数，没有参考的上限值（<code>saturation</code>），也没有成功率，没有失败率，怎么检测异常？</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/6.webp" alt=""></p>
<p>上图的黄线是昨天的值，绿线是今天的值，大部分服务监控的曲线图都长这样。可以得出四个思路：</p>
<ul>
<li><strong>曲线平滑</strong>：故障一般是对近期趋势的一个破坏，视觉上来说就是不平滑</li>
<li><strong>绝对值的时间周期性</strong>：两条曲线几乎重合</li>
<li><strong>波动的时间周期性</strong>：假设两个曲线不重合，在相同时间点的波动趋势和振幅也是类似的</li>
<li><strong>有一个长度可观的坑</strong>：当曲线开始回升到历史范围的时候，一般可以确认这个时间段是真的故障了</li>
</ul>
<p>从这四种直觉展开，可以得出各种或复杂或简单的算法。下面要讲的算法都是非常简单的，无需很高深的数学知识。</p>
<h2 id="基于曲线的平滑性检测"><a href="#基于曲线的平滑性检测" class="headerlink" title="基于曲线的平滑性检测"></a>基于曲线的平滑性检测</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种检测的根据是在一个最近的时间窗口，比如1个小时。曲线会遵循某种趋势，而新的数据点打破了这种趋势，使得曲线不光滑了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;也就是说，这种检测利用的是时间序列的<code>temporal dependency</code>，T对于<code>T-1</code>有很强的趋势依赖性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业务逻辑上来说，8:00 有很多人登陆，8:01 也有很多人来登陆的概率是很高的，因为吸引人来登陆的因素是有很强的惯性的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是7.1很多人来登陆，8.1也有很多人来登陆的惯性就要差很多。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于近期趋势做告警，就需要对曲线的趋势进行拟合。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;拟合有两种方式，<code>moving average</code> 或者 <code>regression</code>。这两种拟合方式有不同的<code>bias</code>（倾向）。</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/7.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这就是一种<code>moving average</code>的算法图，叫做<code>exponentially weighted moving average</code>。它的计算非常简单</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/8.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>x</code>是实际值，<code>s</code>是<code>ewma</code>计算出来的平均值。也就是下一点的平均值是由上一点的平均值，加上当前点的实际值修正而来。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个修正的比例，就取决月这个<code>alpha</code>的<code>decay factor</code>的大小。视觉上来说就是<code>ewma</code>曲线是否紧跟实际曲线，也就是平滑程度。</p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/9.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有了平均值之后可以计算方差，方差乘以一定的倍数可以得出对于振幅的容忍范围。比较实际的值是否超出了这个范围就可以知道是否可以告警了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;超出了上界，可能是突然用户量突然激增了。超出了下届，可能是营销活动结束了，用户快速离开，也可能是光纤断了，玩家掉线了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;想要了解更多关于<code>ewma</code>的算法细节：关注Baron Schwartz：</p>
<ul>
<li><a href="http://www.slideshare.net/vividcortex/statistical-anomaly-detection" target="_blank" rel="noopener">http://www.slideshare.net/vividcortex/statistical-anomaly-detection</a></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>moving average</code>认为曲线是趋向于历史的，如果曲线的势头是上升，那么它认为下一个点应该是开始下降的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>regression</code>认为曲线是趋向于未来的，如果曲线的势头是上升，那么它认为下一个点应该是保持这个上升势头。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还有更复杂的模型是综合了<code>moving average</code>和<code>regression</code>的。无论是哪种算法，用过去10分钟预测下10分钟是不可能精确的。如果这种预测可以精确，那么股神早就诞生了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;使用<code>moving average</code>，可能会掩盖故障产生的下降（因为其<code>bias</code>是下降）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果使用<code>regression</code>，那么又有可能把没有上升得那么快当成故障了（因为其<code>bias</code>是上升）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种基于近期趋势计算方差的算法还有一个缺陷是当前面几个点振动很大的时候，方差值会被搞大。后面的故障就被掩盖了，使得连续的故障点无法被检测到。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实也就是算法对于什么是正常是没有概念的，它认为过去的历史就是正常。如果过去几分钟处于故障中，那么故障的曲线就是正常。</p>
<p>实际使用中发现这种基于曲线平滑度的算法的优点有</p>
<ul>
<li>依赖的数据少，只需要近期的历史，不依赖于周期性</li>
<li>非常敏感，历史如果波动很小，方差就很小，容忍的波动范围也会非常小</li>
</ul>
<p>缺点也是显著的：</p>
<ul>
<li>过于敏感，容易误报。因为方差会随着异常点的引入而变大，所以很难使用连续三点才告警这样的策略</li>
<li>业务曲线可能自身有规律性的陡增和陡降</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最佳的使用方式是不用一根曲线做告警。结合几条相关的曲线，如果同时出现平滑度破坏的情况，而且与业务规律的趋势相背离（比如在线人数降低，登陆请求数增高）则可以认定为业务出现故障。</p>
<h2 id="基于绝对值的时间周期性"><a href="#基于绝对值的时间周期性" class="headerlink" title="基于绝对值的时间周期性"></a>基于绝对值的时间周期性</h2><p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/10.webp" alt=""></p>
<p>上图中不同的颜色代表了不同日期的曲线。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很多监控曲线都有这样以一天为周期的周期性（早上4点最低，晚上11点最高之类的）。一种利用时间周期性的最简单的算法：</p>
<p><code>min(14 days history) * 0.6</code></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对历史14天的曲线取最小值。怎么个取最小值的方法？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于12:05分，有14天对应的点，取最小值。对于12:06分，有14天对应的点，取最小值。这样可以得出一条一天的曲线。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后对这个曲线整体乘以0.6。如果几天的曲线低于这条参考线则告警。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这其实是一种静态阈值告警的升级版，动态阈值告警。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>过去静态阈值是一个根据历史经验拍脑袋的产物。用这个算法，其实是把同时间点的历史值做为依据，计算出一个最不可能的下界</strong>。<strong>同时阈值不是唯一的一个，而是每个时间点有一个。如果1分钟一个点，一天中就有1440个下界阈值</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际使用中0.6当然还是要酌情调整的。而且一个严重的问题是如果14天历史中有停机发布或者故障，那么最小值会受到影响。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;也就是说不能把历史当成正常，而是要<strong>把历史剔除掉异常值之后再进行计算</strong>。<strong>一个务实的近似的做法是取第二小的值</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了让告警更加精确，可以累积计算实际曲线和参考曲线的差值之和。也就是相对于参考曲线下跌的面积。这个面积超过一定的值则告警。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于深度下跌，则累积几个点就可以告警。对于浅度下跌，那么多累几个点也可以告警出来。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;翻译成人话就是，一下在跌了很多，则很有可能是故障了。或者连续好久都偏离正常值，那么也很有可能是出问题了。</p>
<p>优点：</p>
<ul>
<li>计算简单</li>
<li>可以确保发现大的故障，出了告警一定是大问题，可以直接打电话</li>
</ul>
<p>缺点：</p>
<ul>
<li>依赖周期性的历史数据，计算量大，而且无法对新接入的曲线告警</li>
<li>非常不敏感，小波动无法发现</li>
</ul>
<h2 id="基于振幅的时间周期性"><a href="#基于振幅的时间周期性" class="headerlink" title="基于振幅的时间周期性"></a>基于振幅的时间周期性</h2><p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/12.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有些时候曲线是有周期性，但是两个周期的曲线相叠加是不重合的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如上图这样的，曲线整体的趋势是网上的。两个周期的曲线一叠加，一个会比另外一个高出一头。对于这种情况，利用绝对值告警就会有问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如今天是10.1日，放假第一天。过去14天的历史曲线必然会比今天的曲线低很多。那么今天出了一个小故障，曲线下跌了，相对于过去14天的曲线仍然是高很多的。这样的故障如何能够检测得出来？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>一个直觉的说法是，两个曲线虽然不一样高，但是“长得差不多”。那么怎么利用这种“长得差不多”呢？那就是振幅了</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;与其用<code>x(t)</code>的值，不如用<code>x(t) - x(t-1)</code>的值，也就是把绝对值变成变化速度。可以直接利用这个速度值，也可以是 <code>x(t) - x(t-1)</code>再除以<code>x(t-1)</code>，也就是一个速度相对于绝对值的比率。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>比如t时刻的在线900人，t-1时刻的在线是1000人，那么可以计算出掉线人数是10%。这个掉线比率在历史同时刻是高还是低？</strong>那么就和前面一样处理了。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际使用中有两个技巧：<strong>可以是<code>x(t) - x(t-1）</code>，也可以是<code>x(t) - x(t-5）</code>等值</strong>。<strong>跨度越大，越可以检测出一些缓慢下降的情况</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外一个技巧是<strong>可以计算<code>x(t) -x(t-2)</code>，以及<code>x(t+1) - x(t-1)</code>，如果两个值都异常则认为是真的异常，可以避免一个点的数据缺陷问题</strong>。</p>
<p>优点：</p>
<ul>
<li>比绝对值要敏感</li>
<li>利用了时间周期性，规避了业务曲线自身的周期性陡降</li>
</ul>
<p>缺点：</p>
<ul>
<li>要求原曲线是光滑的</li>
<li>周期性陡降的时间点必须重合，否则误警</li>
<li>按百分比计算容易在低峰时期误警</li>
<li>陡降不一定代表故障，由上层服务波动引起的冲高再回落的情况时有发生</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种异常告警算法是比较优秀的。缺点也很多。所以可以进行一些修补凑合用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>为了避免低峰时期，基于振幅百分比容易误警，可以加入绝对振幅的下限</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业务上来说，就是小波动如果相对比率大，但是绝对影响范围小也是没关系的。对于冲高回落的问题，可以判断一下冲高的情况，对于冲高之后屏蔽一段时间。</p>
<h2 id="基于曲线回升的异常判断"><a href="#基于曲线回升的异常判断" class="headerlink" title="基于曲线回升的异常判断"></a>基于曲线回升的异常判断</h2><p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/13.webp" alt=""></p>
<p><img src="//blog.com/2019/06/08/如何优雅的设计一个告警系统/14.webp" alt=""></p>
<p>当我们看见图2的时候比图1更确认是故障了。为什么？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为图2中有一个明显的回升。算法其实和人眼一样。如果多等几个时间点，发现曲线回升了可以更很准确地判断“曾经”有一个故障。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是这种基于回升的异常检测是没有多少“告警”意义上的机制的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>告警的作用就是让人参与干预，去帮助曲线回升</strong>。<strong>如果曲线已经开始回升，再告警不是事后诸葛了吗</strong>？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种检测的意义在于机器复制告警的确认。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们需要统计误警率，漏警率的时候，用另外一种视角的算法重新跑一遍可以统计出很多原算法的问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时也可以用半自动化的方式建立一个历史故障的样本库。这个样本库可以变成更复杂的机器学习算法的训练集。</p>
<h2 id="核心要点总结"><a href="#核心要点总结" class="headerlink" title="核心要点总结"></a>核心要点总结</h2><p>核心要点：</p>
<ul>
<li>高质量的告警是<code>actionable</code>的</li>
</ul>
<ul>
<li>不应该用采集的难度决定你使用什么指标去告警</li>
</ul>
<ul>
<li>不要别人做什么告警，你就做什么，要做“真正”有用的告警：特别是cpu使用率告警</li>
</ul>
<ul>
<li><code>is work getting done</code>：请求数 + 成功率</li>
</ul>
<ul>
<li><code>is the user having good experience</code>：响应延迟</li>
</ul>
<ul>
<li>只要采集对了指标，大部分时候告警不需要复杂算法</li>
</ul>
<ul>
<li>基于算法的异常检测：算法不难，实在必要也是可以做到的</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/08/微服务架构下的监控需要注意哪些方面/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/微服务架构下的监控需要注意哪些方面/" itemprop="url">微服务架构下的监控需要注意哪些方面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T12:12:57+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/监控体系搭建/" itemprop="url" rel="index">
                    <span itemprop="name">监控体系搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="微服务架构下的监控需要注意哪些方面"><a href="#微服务架构下的监控需要注意哪些方面" class="headerlink" title="微服务架构下的监控需要注意哪些方面"></a>微服务架构下的监控需要注意哪些方面</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://www.infoq.cn/article/IVKdk7l*RzjkT4etkPt2" target="_blank" rel="noopener">https://www.infoq.cn/article/IVKdk7l*RzjkT4etkPt2</a></p>
</blockquote>
<p><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;微服务架构虽然诞生的时间并不长，却因为适应现今互联网的高速发展和敏捷、<code>DevOps</code>等文化而受到很多企业的推崇。微服务架构在带来灵活性、扩展性、伸缩性以及高可用性等优点的同时，其复杂性也给运维工作中最重要的监控环节带来了很大的挑战：海量日志数据如何处理，服务如何追踪，如何高效定位故障缩短故障时常……</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>InfoQ</code>记者采访了京东云应用研发部门运维负责人，来谈一谈微服务架构下的监控应该注意哪些方面。</p>
<h2 id="微服务架构带来的变化"><a href="#微服务架构带来的变化" class="headerlink" title="微服务架构带来的变化"></a>微服务架构带来的变化</h2><p>在京东云运维专家看来，微服务架构给 IT 系统和团队带来了以下显著的变化：</p>
<ul>
<li>基础设施的升级，需要引入<strong>虚拟化</strong>（如 <code>Docker</code>），现存基础设施也需要与之进行适配；</li>
<li>系统架构的升级，需要引入<strong>服务注册</strong>（如 <code>Consul</code>），服务间的交互方式也需要与之进行适配；</li>
<li>运维平台的升级，建议引入<strong>日志收集</strong>（如 <code>Fluentd</code>），分布式跟踪（如<code>Zipkin</code>）和仪表盘（如 <code>Vizceral/Grafana</code>）等；</li>
<li>运维效率和自动化水平的提升也迫在眉睫，否则无法应对实例数量，变更频率，系统复杂度的快速增长；</li>
<li>观念的转变，基础设施，系统架构和运维平台等的大幅升级，犹如小米加步枪换成飞机大炮，相应的战略战术也需要与之相适配才行。</li>
</ul>
<h2 id="微服务架构下用户面临的监控问题"><a href="#微服务架构下用户面临的监控问题" class="headerlink" title="微服务架构下用户面临的监控问题"></a>微服务架构下用户面临的监控问题</h2><p>在转型到微服务架构以后，用户在监控方面主要会面临以下问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>首先，监控配置的维护成本增加</strong>。某个在线系统大概有 106 个模块，每个模块都需要添加端口监控，进程监控，日志监控和自定义监控；不同服务的监控指标，聚合指标，报警阈值，报警依赖，报警接收人，策略级别，处理预案和备注说明也不完全相同；如此多的内容，如何确保是否有效，是否生效，是否完整无遗漏。</p>
<p>当前针对维护成本，业界常用的几种方法有：</p>
<ul>
<li><strong>通过变量的方式尽量减少人工输入</strong>；</li>
<li><strong>通过监控配置文件解析做一些可标准化的校验</strong>；</li>
<li><strong>通过故障演练验证报警是否符合预期</strong>；</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>其次，第三方依赖越来越多</strong>。例如 <code>Docker</code>的可靠性很大程度上取决于宿主机，如果所在的宿主机发生资源争用，网络异常，硬件故障，修改内核参数，操作系统补丁升级等，都可能会让 <code>Docke</code>r 莫名其妙地中招。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>第三，服务故障的定位成本增加</strong>。假设故障是因为特定服务处理耗时增大导致的，那么如何快速从 106 个服务以及众多的第三方依赖中把它找出来，进一步，又如何确认是这个服务的单个实例还是部分实例的异常，这些都让故障定位变得更复杂。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在微服务架构下，提高故障定位效率的常用方法有：基于各类日志分析，通过仪表盘展示核心指标：数据流，异常的监控策略，变更内容，线上登录和操作记录，文件修改等内容。</p>
<h2 id="微服务监控的难点及解决思路"><a href="#微服务监控的难点及解决思路" class="headerlink" title="微服务监控的难点及解决思路"></a>微服务监控的难点及解决思路</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在微服务架构下，监控系统在报警时效性不可改变的前提下，采集的指标数量是传统监控的三倍以上，如果是万台以上的规模，监控系统整体都面临非常大的压力，在监控方面的挑战主要来源于：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>首先，存储功能的写入压力和可用性都面临巨大挑战</strong>。每秒写入几十万采集项并且需要保证 <code>99.99%</code> 的可用性，对于任何存储软件来讲，都不是一件轻松的事情。</p>
<p>对于写入和可用性的压力，业界常见的解决思路主要是基于如下方式的组合：</p>
<ul>
<li><p><strong>集群基于各种维度进行拆分</strong>（如地域维度、功能维度和产品维度等）；</p>
</li>
<li><p><strong>增加缓存服务来降低 Hbase 的读写压力</strong>；</p>
</li>
<li><p><strong>调整使用频率较低指标的采集周期</strong>；</p>
</li>
<li><p><strong>通过批量写入降低 Hbase 的写入压力</strong>；</p>
</li>
<li><p><strong>日志不直接写入到Hbase，而是写到kafka，然后再异步写到Hbase，达到削峰的目的</strong>；</p>
</li>
<li><p><strong>通过写入两套 Hbase 避免数据丢失并做到故障后快速切换</strong>；</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>其次，监控的生效速度也面临巨大挑战</strong>。微服务架构下，基于弹性伸缩的加持，从服务扩容或者迁移完毕到接入流量的耗时降低到 <code>1Min</code> 左右，且每时每刻都在不断发生着。对于复杂监控系统来讲，支持这样的变更频率绝非易事，而且实例变更如此频繁，对监控系统自身来讲，也会面临可用性的风险。</p>
<p>常见的提高监控生效速度的思路主要有如下的几种方式：</p>
<ul>
<li><strong>实时热加载服务注册信息</strong>；</li>
<li><strong>对监控配置的合规性进行强校验</strong>；</li>
<li><strong>增加实例数量的阈值保护</strong>；</li>
<li><strong>支持配置的快速回滚</strong>；</li>
</ul>
<p><strong>第三，基础设施的故障可能导致报警风暴的发生</strong>。基础设施如 <code>IDC</code>故障，可能会在瞬时产生海量报警，进而导致短信网关拥塞较长时间。</p>
<p>解决这类问题的思路主要是如下方式：</p>
<ul>
<li><p><strong>基于报警接收人通过延时发送进行合并</strong>；</p>
</li>
<li><p><strong>报警策略添加依赖关系</strong>；</p>
</li>
<li><p><strong>优先发送严重故障的报警短信</strong>；</p>
</li>
<li><p><strong>增加多种报警通知方式如电话，IM 等</strong>；</p>
</li>
</ul>
<h2 id="微服务监控原则"><a href="#微服务监控原则" class="headerlink" title="微服务监控原则"></a>微服务监控原则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于采用微服务的团队，京东云运维专家建议在做监控时可以参考 <code>Google SRE 的理论</code>，结合自己长期的运维实践经验，他总结了几点可以参考的原则：</p>
<ul>
<li>首先，<strong>所有系统和第三方依赖的核心功能必须添加黑盒监控</strong>；</li>
<li>第二，<strong>所有模块必须添加白盒监控的四个黄金指标（饱和度，错误，流量和延时）</strong>；</li>
<li>第三，<strong>所有的变更都需要进行采集</strong>，包括但不限于程序，配置，数据，网络，硬件，操作系统以及各类基础设施。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外，京东云运维专家也给大家提供了一些黑盒监控的实施经验：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先，应该监控哪些功能？建议<strong>将系统接入层的访问日志，<code>TOP-10</code>的 <code>URL</code>添加黑盒监控</strong>。那 <code>TOP-9</code> 的 <code>URL</code>是否一定需要监控？<code>TOP-11</code> 的 <code>URL</code>是否一定不需要监控？<strong>这取决于其访问量是否和前面的 URL 在一个数量级以及人工评估其接口的重要性程度</strong>，这里提供的更多是一个思路，而非可量化的方法。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二，应该使用多少个样本 / 节点对一个功能进行黑盒监控？建议<strong>样本应该覆盖到对应模块的所有实例，这样也能发现由少数实例导致的小规模故障</strong>。</p>
<h2 id="微服务架构下的理想监控系统"><a href="#微服务架构下的理想监控系统" class="headerlink" title="微服务架构下的理想监控系统"></a>微服务架构下的理想监控系统</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从用户的角度看，<code>Prometheus</code> 的整体架构设计参考了<code>Google BorgMon</code>，系统具有高度的灵活性，围绕其开放性现在也慢慢形成了一个生态系统。具体来说，<code>Prometheus</code> 使用的是 <code>Pull</code>模型，<code>Prometheus Server</code> 通过 <code>HTTP</code>的 <code>Pull</code>方式到各个目标拉取监控数据。<code>HTTP</code> 协议的支持能够更加方便的进行定制化开发，服务注册、信息采集和数据展示均支持多种形式 / 开源软件。</p>
<p><img src="//blog.com/2019/06/08/微服务架构下的监控需要注意哪些方面/微信图片_20190609003703.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;结合目前国内正在兴起的智能运维，也许不久的将来，上面提到的监控的各种问题也就迎刃而解了。监控策略不在需要人工定义，转由机器学习负责，诸如策略添加，阈值设定，异常检测，故障定位，自动止损等逐步由系统负责，运维人员不再是“救火队长”。</p>
<h2 id="京东云监控响应实践"><a href="#京东云监控响应实践" class="headerlink" title="京东云监控响应实践"></a>京东云监控响应实践</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;京东云运维平台为数万台机器提供监控，部署，机器管理，权限管理，安全管理，审计和运营分析等功能，为京东云所有的业务在各类异构网络环境下提供标准和统一的运维支撑能力。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;基于产品所处的发展阶段，用户规模的不同，报警频率也不尽相同。<strong>理想情况下，报警频率应该等同于故障频率，这里面体现了报警的准确度和召回率两个指标，如果每个报警都对应一个服务故障，则准确度为 100%，同理，如果每次服务故障均有报警产生，则召回率为 100%</strong>。大家可以基于上述两个指标，来衡量自己团队的现状，并针对性的制定提升计划即可。</p>
<p>对于响应流程，京东云有几个做的好的地方可以给大家参考。</p>
<ul>
<li>首先，所有核心报警均有可靠的应对预案和处理机制，并通过定期的破坏演练持续进行完善。</li>
<li>其次，公司的监控中心会<code>7x24</code> 值守，他们也会和业务线运维同学一样，接收所有影响核心系统稳定性的报警，收到报警后会进行通报，确保核心报警在发生后第一时间内有人处理并在规定的时间内处理完毕。如果未在规定的时间内处理完毕，监控中心会进行报警升级，通报该系统的管理人员，从而确保该报警可以得到更高的重视度和支持力度。</li>
</ul>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于监控系统的未来发展，京东云的运维专家认为长期来看，依托于<code>Kubernetes</code> 的发展，在基础设施的各个领域，都会从百花齐放到几家独大，从而将标准化落地到基础设施的各个领域，进而促进整个生态的繁荣。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在监控方向，<code>Prometheus</code> 在未来一段时间后，也许会是一个很好的选择。<code>在 Prometheus</code>等工具解决了通用的监控场景并标准化之后，在其上的各类应用场景，如容量规划，流量监控，故障定位以及各种基于大数据和人工智能场景的落地等，就会出现百花齐放之势。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/08/实现PHP5中的 var_dump 函数/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/实现PHP5中的 var_dump 函数/" itemprop="url">实现PHP5中的 var_dump 函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T12:12:57+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="实现PHP5中的-var-dump-函数"><a href="#实现PHP5中的-var-dump-函数" class="headerlink" title="实现PHP5中的 var_dump 函数"></a>实现PHP5中的 var_dump 函数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    function mydump() &#123;</span><br><span class="line">    $args   = func_num_args();</span><br><span class="line">    for($i = 0;$i &lt; $args; $i ++) &#123;</span><br><span class="line">        $param = func_get_arg($i);</span><br><span class="line">        switch(gettype($param)) &#123;</span><br><span class="line">            case &apos;NULL&apos; :</span><br><span class="line">                echo &apos;NULL&apos;;</span><br><span class="line">                break;</span><br><span class="line">            case &apos;boolean&apos; :</span><br><span class="line">                echo ($param ? &apos;bool(true)&apos; : &apos;bool(false)&apos;);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;integer&apos; :</span><br><span class="line">                echo &quot;int($param)&quot;;</span><br><span class="line">                break;</span><br><span class="line">            case &apos;double&apos; :</span><br><span class="line">                echo &quot;float($param)&quot;;</span><br><span class="line">                break;</span><br><span class="line">            case &apos;string&apos; :</span><br><span class="line">                dumpString($param);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;array&apos; :</span><br><span class="line">                dumpArr($param);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;object&apos; :</span><br><span class="line">                dumpObj($param);</span><br><span class="line">                break;</span><br><span class="line">            case &apos;resource&apos; :</span><br><span class="line">                echo &apos;resource&apos;;</span><br><span class="line">                break;</span><br><span class="line">            default :</span><br><span class="line">                echo &apos;UNKNOWN TYPE&apos;;</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function dumpString($param) &#123;</span><br><span class="line">    $str = sprintf(&quot;string(%d) %s&quot;,strlen($param),$param);</span><br><span class="line">    echo $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function dumpArr($param) &#123;</span><br><span class="line">    $len = count($param);</span><br><span class="line">    echo &quot;array($len) &#123;\r\n&quot;;</span><br><span class="line">    foreach($param as $key=&gt;$val) &#123;</span><br><span class="line">        if(is_array($val)) &#123;</span><br><span class="line">            dumpArr($val);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo sprintf(&apos;[&quot;%s&quot;] =&gt; %s(%s)&apos;,$key,gettype($val),$val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&#125;\r\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function dumpObj($param) &#123;</span><br><span class="line">    $className = get_class($param);</span><br><span class="line">    $reflect = new ReflectionClass($param);</span><br><span class="line">    $prop = $reflect-&gt;getDefaultProperties();</span><br><span class="line">    echo sprintf(&quot;Object %s #1(%d) &#123;\r\n&quot;,$className,count($prop));</span><br><span class="line">    foreach($prop as $key=&gt;$val) &#123;</span><br><span class="line">        echo &quot;[\&quot;$key\&quot;] =&gt; &quot;;</span><br><span class="line">        mydump($val);</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&#125;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyClass</span><br><span class="line">&#123;</span><br><span class="line">    protected $_name;</span><br><span class="line">    function test()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;hello&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str    = &quot;test&quot;;</span><br><span class="line">mydump(new MyClass(),$str);</span><br><span class="line">echo &quot;\r\n&quot;;</span><br><span class="line">$arr2   = array(</span><br><span class="line">    &quot;1&quot;     =&gt; &quot;Ddaddad&quot;,</span><br><span class="line">    &quot;one&quot;   =&gt; array(&quot;two&quot; =&gt; &quot;Dddd&quot; ),</span><br><span class="line">    &quot;three&quot; =&gt; 1</span><br><span class="line">);</span><br><span class="line">mydump($arr2);</span><br><span class="line">mydump(1,true,null);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/08/关于线上监控的思考总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/08/关于线上监控的思考总结/" itemprop="url">关于线上监控的思考总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-08T12:12:57+08:00">
                2019-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/监控体系搭建/" itemprop="url" rel="index">
                    <span itemprop="name">监控体系搭建</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关于线上监控的思考总结"><a href="#关于线上监控的思考总结" class="headerlink" title="关于线上监控的思考总结"></a>关于线上监控的思考总结</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://testerhome.com/topics/19188" target="_blank" rel="noopener">https://testerhome.com/topics/19188</a></p>
</blockquote>
<p><br></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;近期和大佬们对规划，梳理新财年要做的事情，有非常重要的一项就是线上监控，对于线上监控，大家都最熟悉不过，凡是在生产环境上运行的系统，或多或少都会有监控，但是否有思考过哪些监控是有效的，监控的目的是什么，监控告警出来之后又是怎么的一轮操作，今天我们来探讨关于线上监控的相关经验</p>
<h2 id="业务系统分析"><a href="#业务系统分析" class="headerlink" title="业务系统分析"></a>业务系统分析</h2><ul>
<li><p>在实施线上监控之前的梳理，核心还是要对业务系统有比较深刻的了解，才能对症下药，对于业务系统的梳理，可以套一下的框架</p>
<p><img src="//blog.com/2019/06/08/关于线上监控的思考总结/1.webp" alt=""></p>
</li>
<li><p>简单举个例子，从阶段来说，一般初创期和快速迭代的系统，业务和功能都未必稳定，这时就不宜去做比较深度的监控，把<strong>核心场景覆盖</strong>即可，结合系统的核心目标，如用户活跃和流水，对流水和用户活跃数据的敏感度的监控等，同时一般面向外部用户的业务系统都是一个前台的角色，用户敏感度比较高，所以把一些<strong>用户高频操作的功能</strong>给监控起来，再者要<strong>结合当前的技术方向以及业务方向</strong>，如技术方向，可以引入一些新技术，或者在原有的逻辑上补充监控点，技术方向有个前提是<strong>技术栈统一或相近</strong>，不然会加大监控点建立的难度和后期的维护成本，有了前置对业务系统的分析，再实施监控时才少走弯路，降低成本</p>
</li>
</ul>
<h2 id="监控梳理"><a href="#监控梳理" class="headerlink" title="监控梳理"></a>监控梳理</h2><ul>
<li><p>按照个人的经验总结，我们可以按这样子的一个框架去建立监控体系</p>
<p><img src="//blog.com/2019/06/08/关于线上监控的思考总结/2.webp" alt=""></p>
</li>
<li><p>依据上图，我们具体说一下里面的几个大点</p>
</li>
</ul>
<h3 id="监控目标"><a href="#监控目标" class="headerlink" title="监控目标"></a>监控目标</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>监控的核心目标，就是为了在发现线上问题时第一时间能够了解到情况，同时通过告警信息精准地定位到问题出现在哪里</strong>，比较专业的描述就是提升线上问题感知能力，迅速地感知到线上问题，并迅速地定位到问题，用最少的成本将线上问题的影响降到最低，下来的一切措施都是围绕着这个目标去开展</p>
<h3 id="监控范围"><a href="#监控范围" class="headerlink" title="监控范围"></a>监控范围</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;做监控梳理的第一个步骤是要明确监控的范围，哪些点是要监控起来的，那就要清晰明确<strong>业务系统的架构，技术栈以及依赖方</strong>等各种方面，并梳理优先级，简单总结为<strong>查缺补漏</strong></p>
<ol>
<li><p>查找整理当前有哪些<strong>监控点</strong>，具体的<strong>监控范围</strong>，从<strong>业务覆盖度</strong>（功能层面）和<strong>系统覆盖度</strong>（资源层面，如<code>cpu</code>资源等）盘点当前已应用的监控点及其价值</p>
</li>
<li><p>检查是否已有监控中是否有由于迭代等因素，已经废弃的监控点，或者是有影响到正常排查问题思路的监控点，<strong>已经失去监控的价值的，可以废弃</strong></p>
</li>
<li><p>检查是否有核心功能或核心数据等没有监控起来，出现问题的时候往往都是用户反馈才发现，<strong>补全监控点</strong></p>
</li>
<li><p>检查告警机制是否到位，是否出现确实有监控起来但没有很好的反馈到需要关注的相关人员处，<strong>补全告警机制</strong></p>
</li>
</ol>
<h3 id="监控类型"><a href="#监控类型" class="headerlink" title="监控类型"></a>监控类型</h3><ul>
<li>我把监控的类型分为两个大类，分别是<strong>系统监控和业务监控</strong></li>
</ul>
<h4 id="系统监控"><a href="#系统监控" class="headerlink" title="系统监控"></a>系统监控</h4><ul>
<li><p>首先讲一下系统监控，如下图</p>
<p><img src="//blog.com/2019/06/08/关于线上监控的思考总结/3.webp" alt=""></p>
</li>
<li><p>系统监控更多的是关注业务系统所在的环境及其资源的情况，简单理解就是能让系统正常运行起来的先决条件的监控，这里将系统监控分为<strong>资源层</strong>，<strong>基础架构层</strong>，<strong>数据层</strong>以及<strong>依赖方</strong></p>
</li>
</ul>
<ul>
<li><strong>资源层</strong>会关注运行环境的硬件等资源，如<code>cpu</code>，内存，磁盘的使用率以及网络流量等，这也是通用的监控点，同时也是会中间网络服务监控起来，比如<code>DNS</code>的访问，保证域名等有效性，是否负载均衡，机器流量分布不均会导致业务流程阻塞，资源也未必很好地利用起来，中间件如一些消息服务是否有出现消息堆积等情况</li>
</ul>
<ul>
<li><strong>基础架构层</strong>会关注实现业务系统的技术底层运行情况,以<code>java</code>开发的系统为例，比如<code>jvm</code>，一般会对其线程进行监控，如线程占用的内存，内存回收机制是否正常，是否有内存泄漏，同时在方法区，方法的调用情况是否正常，堆栈使用是否合理，代码逻辑异常时是否有正常抛出，日志是否清晰等等</li>
</ul>
<ul>
<li><strong>数据层</strong>为关注数据库读写情况，比如<code>proxy</code>连接数是否在运行范围内，慢查询的数量，数据量的大小以及表的大小会影响读写情况，在一些耗时超时的跟踪上是可以通过监控手段跟踪起来</li>
</ul>
<ul>
<li><strong>依赖方</strong>这里更多的是关注调用情况，调用链路是否正常，是否有越权调用的情况，调用耗时等各种方面</li>
</ul>
<h4 id="业务监控"><a href="#业务监控" class="headerlink" title="业务监控"></a>业务监控</h4><ul>
<li><p>不同的业务系统有不的监控方式，这里只例举一些通用的场景，如下图：</p>
<p><img src="//blog.com/2019/06/08/关于线上监控的思考总结/4.webp" alt=""></p>
</li>
<li><p>业务监控主要关注两个方面，就是<strong>系统功能以及数据</strong></p>
</li>
</ul>
<h5 id="功能监控"><a href="#功能监控" class="headerlink" title="功能监控"></a>功能监控</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先说说<strong>功能监控</strong>，这个很好理解就是<strong>对用户的操作行为进行打点监控</strong></p>
<blockquote>
<p>比如用户在使用某一功能过于频繁，导致操作被限制</p>
<p>用户由于对功能不理解反馈功能异常</p>
<p>对于获得利益的功能，比如领取代金券领取奖品等，领取是否正常等等，同时关注到业务接口尤其是几个关联接口的使用场景，比如领奖的几个关联接口中的某一个不通或者异常导致整个链路失败的</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这时就可以直接根据告警信息来准确地处理问题了，当然这也可以是交互上解决的问题，这里就不扯远了</p>
<ul>
<li>同时对于<strong>页面访问的情况，是否出现白屏，<code>load</code>超时，页面不兼容的情况，可以通过打点监控获取到相关的信息，如果是<code>bug</code>或其他优化问题就可以记录并做日后优化的一个工作项</strong></li>
</ul>
<ul>
<li>定时任务，在业务场景用应用是非常广泛的，如定时更新游戏里面的任务，定时给用户发奖，定时去获取某些信息等等，<strong>监控定时任务的执行情况保证业务流程的正常执行</strong></li>
</ul>
<h5 id="数据监控"><a href="#数据监控" class="headerlink" title="数据监控"></a>数据监控</h5><ul>
<li>数据监控就是针对业务数据来说的，有些业务系统每天都会出业务报表，<strong>如果报表中的业务数据变化比较大的话，就必须通过告警让相关关注人员去确认业务数据的变化是否合理，现这种场景，一般就是通过环比同比设置预警阀值进行监控</strong>，比如环比超过<code>10%</code>，就需要告警到对应人员</li>
</ul>
<ul>
<li>结合业务场景来说，如上面提到的发奖品等，数据层面就要<strong>关注发出量和领取量以及库存量</strong>，如果有设置了每天发出量的限制的话就要监控是否有超出预值，同时当库存量不足支持发奖活动的需求的，就要即时的告警出来</li>
</ul>
<ul>
<li>除了数据量相关的监控以外，还有就是数据逻辑功能，比如<strong>数据计算，是否和预期值是正常的</strong>，尤其是在大数据量的计算的时候，如果一条条找错误数据的话明显非常低效，于是就可以通过监控告警的方式，将不符合既定规则的数据告警出来，就可以精准定位到是哪条数据出现问题，然后再去追溯跟进问题原因</li>
</ul>
<ul>
<li>不同的业务系统有不同的监控点，所以这里只能聊一下比较通用的场景，<strong>业务监控是建立在具体的业务逻辑上，依据其具体的逻辑去实现监控点</strong></li>
</ul>
<h3 id="监控关注方"><a href="#监控关注方" class="headerlink" title="监控关注方"></a>监控关注方</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>监控关注方</strong>直白意思就是看监控的人，做了一堆监控，对于整个团队来说，是所有建立起监控的点都要关注，但每种职能关注的监控点的优先级是不一样的，<strong>产品业务侧会更关注用户行为以及相关的业务数据</strong>，毕竟这些告警会影响到产品需求设计上的一些方向，而<strong>技术侧会更偏于系统层面的监控</strong>，比如一些<code>error</code>日志和硬件资源使用的情况，<strong>如果作为基础服务的系统，涉及多关联方调用的，关联方也会关注其所涉及的一些依赖接口，依赖数据等告警</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个反例场景，线上出现一些资源上的<code>bug</code>，报了一堆代码信息的告警，然后全往产品经理处发，产品经理看到后最后还是找技术侧去处理，这样的一个信息传递的链路实在是有点长，<strong>所以在做监控实施之前，就必须明确什么监控是给什么人看的，这些信息传递得更准确，问题感知的能力才会有提升</strong></p>
<h2 id="监控实施"><a href="#监控实施" class="headerlink" title="监控实施"></a>监控实施</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;监控点都梳理情况之后，就可以设计监控实施的方案，这里会涉及需要用到的工具或技术栈，以及对于的一个预警方案和救火方案，可以通过这几个明细项去设计实施方案：</p>
<ol>
<li><p><strong>监控层</strong>：比如系统监控中的运行环境资源</p>
</li>
<li><p><strong>监控项</strong>：比如系统监控中的运行环境资源中的<code>cpu</code>，内存等</p>
</li>
<li><p><strong>监控点</strong>：比如网络使用中的网络<code>io</code>，网络连接数据，丢包率、重传率等</p>
</li>
<li><p><strong>监控工具（方案）</strong>：其实就是应用在这个监控点上具体的工具或者是方法</p>
</li>
<li><p><strong>预警策略</strong>：当监控工具将对应的监控点都监控起来，我们就能得到相关的数据，依据数据或信息设置一些预警策略，在业务层面上，比如当库存少于<code>XXX</code>量时，就告警，系统层面上比如磁盘使用率超过<code>90%</code>时就告警</p>
</li>
<li><p><strong>告警载体</strong>：如以邮件，钉钉等方式通知到关注方</p>
</li>
<li><p><strong>关注方</strong>：如前文所说</p>
</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个实际的例子，如下图</p>
<p><img src="//blog.com/2019/06/08/关于线上监控的思考总结/5.webp" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上图通过上述的一部分监控类型举例如果是设计监控方案落地，大家可以参考一下</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在监控工具（方案）上面，上述是通过一些点去选择具体的工具或方案，但尤其是在系统监控方面，一个个点用工具去实施维护肯定是不切实际的，现在行业里面也有很多具体的方案或工具可以全面的对系统方面进行监控，比如新型监控告警工具<strong>Prometheus</strong>，像利用<strong>Prometheus+Grafana</strong>搭建起监控运维平台，就基本上面可以满足系统监控的实施需求</p>
<h2 id="监控价值评价"><a href="#监控价值评价" class="headerlink" title="监控价值评价"></a>监控价值评价</h2><ul>
<li>从盘点到设计到落地，监控是起来了，但作为工程技术人员，实施方案都需要评价最后得到的价值和结果，结合前文做监控的目的，就是为了提升线上问题感知能力，降低排查问题的成本</li>
</ul>
<ul>
<li>基于这点目的出发，我们就可以记录每实施一项监控点是否满足这个目的，比如做数据计算规则的监控，可以精准定位到时哪一条数据出现问题，而不是自己一条条去排查，降低排查成本，告警梳理完善，信息更加精确地推送到关注方</li>
</ul>
<ul>
<li>但也有反例，就是实施了监控之后让告警信息复杂化，过多的无效告警信息，或者是不需要关注方关注的信息告警出来，长期以来会让关注方对告警信息麻木，最后真的有线上问题的时候就忽略了重要信息，还有就是实现监控之后对业务系统有较大的代码插入，带来系统<code>bug</code>，这样也是得不偿失，所以综合来说可以通过判断实施监控前和实现监控后的效果来判断监控是否有效，对于无效监控应当机立断地废弃掉</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>监控方法千万条，有效告警第一条，监控不规范，同学两行泪，不管是线上监控，还是其他方案，从业务的根本需求出发，整体地思考，细致地落地，希望通过本文能为大家在进行线上监控实施时起到一些帮助，谢谢</li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><ul>
<li><a href="https://www.linuxidc.com/Linux/2018-01/150354.htm" target="_blank" rel="noopener">使用Prometheus+Grafana搭建监控系统实践</a></li>
<li><a href="https://www.oschina.net/project/tag/146/system-monitor?from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener">系统监控工具集</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/45/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/45/">45</a><span class="page-number current">46</span><a class="page-number" href="/page/47/">47</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/47/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
