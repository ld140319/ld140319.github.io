<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/135/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/135/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/01/24/MySQL 索引原理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/MySQL 索引原理/" itemprop="url">MySQL 索引原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T12:12:57+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/索引/" itemprop="url" rel="index">
                    <span itemprop="name">索引</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL-索引原理"><a href="#MySQL-索引原理" class="headerlink" title="MySQL 索引原理"></a>MySQL 索引原理</h1><p>现在互联网应用中对数据库的使用多数都是读较多，比例可以达到 <code>10:1</code>。并且数据库在做查询时 <code>IO</code> 消耗较大，所以如果能把一次查询的 <code>IO</code> 次数控制在常量级那对数据库的性能提升将是非常明显的，因此基于 <code>B+ Tree</code> 的索引结构出现了。</p>
<h2 id="B-Tree-的数据结构"><a href="#B-Tree-的数据结构" class="headerlink" title="B+ Tree 的数据结构"></a>B+ Tree 的数据结构</h2><p><a href="https://camo.githubusercontent.com/7457379878d5ba77934fec1e8702318f002053a3/68747470733a2f2f7773322e73696e61696d672e636e2f6c617267652f303036744b665463677931666e313064366a3973696a333068633038636162332e6a7067" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/7457379878d5ba77934fec1e8702318f002053a3/68747470733a2f2f7773322e73696e61696d672e636e2f6c617267652f303036744b665463677931666e313064366a3973696a333068633038636162332e6a7067" alt="img"></a></p>
<p>如图所示是 <code>B+ Tree</code> 的数据结构。是由一个一个的磁盘块组成的树形结构，<strong>每个磁盘块由数据项和指针组成</strong>。</p>
<blockquote>
<p>所有的数据都是存放在叶子节点，非叶子节点不存放数据。</p>
</blockquote>
<h2 id="查找过程"><a href="#查找过程" class="headerlink" title="查找过程"></a>查找过程</h2><p>以磁盘块1为例，指针 P1 表示小于17的磁盘块，P2 表示在 <code>17~35</code> 之间的磁盘块，P3 则表示大于35的磁盘块。</p>
<p>比如要查找数据项99，首先将磁盘块1 load 到内存中，发生 1 次 <code>IO</code>。接着通过二分查找发现 99 大于 35，所以找到了 P3 指针。通过P3 指针发生第二次 IO 将磁盘块4加载到内存。再通过二分查找发现大于87，通过 P3 指针发生了第三次 IO 将磁盘块11 加载到内存。最后再通过一次<strong>二分查找</strong>找到了数据项99。</p>
<p>由此可见，如果一个几百万的数据查询只需要进行三次 IO 即可找到数据，那么整个效率将是非常高的。</p>
<p>观察树的结构，发现<strong>查询需要经历几次 IO 是由树的高度来决定的，而树的高度又由磁盘块，数据项的大小决定的</strong>。</p>
<p>磁盘块越大，数据项越小那么树的高度就越低。这也就是为什么索引字段要尽可能小的原因。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/01/24/MYSQL日志管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/MYSQL日志管理/" itemprop="url">MYSQL日志管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T12:12:57+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/事务/" itemprop="url" rel="index">
                    <span itemprop="name">事务</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/事务/MySql日志/" itemprop="url" rel="index">
                    <span itemprop="name">MySql日志</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MYSQL日志管理"><a href="#MYSQL日志管理" class="headerlink" title="MYSQL日志管理"></a>MYSQL日志管理</h1><h2 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h2><ol>
<li>记录内容：</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;包含了当 mysqld启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息</p>
<ol>
<li>文件位置和格式：</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以用–log-error[= file_name ]选项来指定 mysqld保存错误日志文件的位置。如果没有给定 file_name 值， <strong>mysqld使用错误日志名 host_name.err 并在数据目录中写入日志文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; vim my.cnf</span><br><span class="line">	   log-error=/var/log/mysql/mysql_error.log</span><br></pre></td></tr></table></figure>
<h2 id="BINLOG"><a href="#BINLOG" class="headerlink" title="BINLOG"></a>BINLOG</h2><ol>
<li><p>记录内容：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;二进制日志包含了所有更新了数据或者已经潜在更新了数据（例如，没有匹配任何<br>行的一个DELETE）的所有语句。语句以“事件”的形式保存，它<strong>描述数据更改</strong></p>
</li>
<li><p>文件位置和格式：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当用–log-bin[= file_name ]选项启动时， mysqld写入包含所有更新数据的SQL命令<br>的日志文件。如果未给出 file_name 值， 默认名为-bin后面所跟的主机名。如果给<br>出了文件名，但没有包含路径，则文件被写入数据目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;  vim my.cnf</span><br><span class="line">        </span><br><span class="line">    log_bin=ON</span><br><span class="line">    binlog_format=mixed</span><br><span class="line">    log_bin_basename=/var/lib/mysql/mysql-bin  </span><br><span class="line">    log_bin_index=/var/lib/mysql/mysql-bin.index  </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    第一个参数是打开binlog日志</span><br><span class="line">    第二个参数是binlog日志的基本文件名，后面会追加标识来表示每一个文件</span><br><span class="line">    第三个参数指定的是binlog文件的索引文件，这个文件管理了所有的binlog文件的目录</span><br><span class="line">    </span><br><span class="line">    log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line">    </span><br><span class="line">    这一个参数的作用和上面三个的作用是相同的，mysql会根据这个配置自动设置log_bin为on状态，自动设置log_bin_index文件为你指定的文件名后跟.index</span><br><span class="line"></span><br><span class="line">    这些配置完毕之后对于5.7以下版本应该是可以了，但是我们这个时候用的如果是5.7及以上版本的话，重启mysql服务会报错。这个时候我们必须还要指定一个参数</span><br><span class="line"></span><br><span class="line">    server-id=123454</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看binlog内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysqlbinlog  log-file</span><br></pre></td></tr></table></figure>
</li>
<li><p>日志管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 1. 查看当前正在写入的binlog文件</span><br><span class="line"> </span><br><span class="line">     show master status</span><br><span class="line">     </span><br><span class="line"> 2. 获取binlog文件列表</span><br><span class="line">     </span><br><span class="line">     show binary logs;</span><br><span class="line">     </span><br><span class="line"> 3. 登录到mysql查看binlog, 只查看第一个binlog文件的内容</span><br><span class="line"> </span><br><span class="line">      show binlog events;</span><br><span class="line">      </span><br><span class="line"> 4. 查看指定binlog文件的内容</span><br><span class="line"> </span><br><span class="line">      show binlog events in &apos;mysql-bin.000002&apos;;</span><br><span class="line">     </span><br><span class="line"> 5. 重置binlog日志(会将日志文件删除，重置index文件 生产环境不要执行)</span><br><span class="line"> </span><br><span class="line">     reset master</span><br><span class="line">     </span><br><span class="line">     reset slave;    //删除slave的中继日志</span><br><span class="line">     </span><br><span class="line"> 6. 关闭当前的二进制日志文件并创建一个新文件，新的二进制日志文件的名字在当前的二进制文件的编号上加1(误操作后，应该立即执行此语句)</span><br><span class="line"> </span><br><span class="line">     flush logs</span><br><span class="line"> </span><br><span class="line"> 7. PURGE MASTER LOGS TO &apos;mysql-bin.010&apos;;//删除mysql-bin.010之前所有日志</span><br><span class="line">PURGE MASTER LOGS BEFORE &apos;2003-04-02 22:46:26&apos;;// 删除2003-04-02 22:46:26之前产生的所有日志</span><br></pre></td></tr></table></figure>
</li>
<li><p>相关选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. --binlog-do-db= db_name</span><br><span class="line">   告诉主服务器，如果当前的数据库(即USE选定的数据库)是 db_name ，应将更新</span><br><span class="line">   记录到二进制日志中。其它所有没有明显指定的数据库被忽略</span><br><span class="line">   </span><br><span class="line">2. --binlog-ignore-db= db_name</span><br><span class="line">   告诉主服务器，如果当前的数据库(即USE选定的数据库)是 db_name ，不应将更</span><br><span class="line">   新保存到二进制日志中</span><br><span class="line">   要想记录或忽视多个数据库，使用多个选项，为每个数据库指定相应的选项。</span><br><span class="line"></span><br><span class="line">3. -innodb-safe-binlog</span><br><span class="line">   使用此选项和sync_binlog＝ N （每写N次日志同步磁盘）全局变量将使得事务能</span><br><span class="line">   够记录的更加安全</span><br><span class="line">   </span><br><span class="line">4. 具有SUPER权限的客户端可以通过SET SQL_LOG_BIN=0语句禁止将自己的语句</span><br><span class="line">   记入二进制记录</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="查询日志"><a href="#查询日志" class="headerlink" title="查询日志"></a>查询日志</h2><p><strong>记录所有语句</strong></p>
<ol>
<li><p>记录内容：</p>
<p>记录了客户端的所有语句，而二进制日志不包含只查询数据的语句</p>
</li>
<li><p>文件位置和格式：<br>用–log[= file_name ]或-l [ file_name ]选项启动它。如果没有给定 file_name 的值 ，<br>默认名是 host_name .log </p>
</li>
</ol>
<h2 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h2><p><strong>记录耗时查询</strong></p>
<ol>
<li><p>记录内容：<br>记录包含所有执行时间超过long_query_time秒的SQL语句的日志文件。获得初使表<br>锁定的时间不算作执行时间。</p>
</li>
<li><p>文件位置和格式<br>用–log-slow-queries[= file_name ]选项启动它。如果没有给出 file_name 值， 默<br>认为主机名，后缀为-slow.log。如果给出了文件名，但不是绝对路径名，文件则写<br>入数据目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell&gt;  vim my.cnf</span><br><span class="line">        slow-query-log=on</span><br><span class="line">        long_query_time=2</span><br><span class="line">        slow-query-log-file=/var/log/mysql/mysql-slow.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>快速查看：<br>   使用mysqldumpslow 命令获得日志中显示的查询摘要来处理慢查询日志，例如：<br>mysqldumpslow bj37-slow.log</p>
</li>
<li><p>其他选项：<br>在MySQL 5.1中,通过–log-slow-admin-statements服务器选项，你可以请求管<br>理语句，例如OPTIMIZE TABLE、ANALYZE TABLE和 ALTER TABLE写入慢查询日志</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/01/24/库表设计/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/库表设计/" itemprop="url">库表设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T12:12:57+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/数据库设计/" itemprop="url" rel="index">
                    <span itemprop="name">数据库设计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="库表设计"><a href="#库表设计" class="headerlink" title="库表设计"></a>库表设计</h1><h2 id="1、尽量减少冗余"><a href="#1、尽量减少冗余" class="headerlink" title="1、尽量减少冗余"></a>1、尽量减少冗余</h2><p>数据冗余虽然利于查询，但有诸多弊端，列举如下：</p>
<ul>
<li><p><strong>不易于修改数据，难以维护数据一致性</strong></p>
</li>
<li><p>过多数据冗余造成表的体积较大，SQL 查询扫描的数据量增多</p>
<p>解决方案：</p>
</li>
<li><p><strong>数据分层，底层最细粒度数据，上层汇总冗余</strong></p>
</li>
<li><p>如有数据变更，重新汇总</p>
</li>
<li><p>少冗余的设计方法不利于程序编写，有没有好办法解决？</p>
</li>
<li><p>程序代码中做<strong>连表操作</strong>，一般我们愿意认为连表操作慢于单表查询（非绝</p>
<p>对），在程序中做链表操作，可以提供整体性能，减少 mysql 压力，同时能够做</p>
<p>到代码重用</p>
</li>
</ul>
<h2 id="2、数据长什么样，存什么样，尽量保持数据依赖关系"><a href="#2、数据长什么样，存什么样，尽量保持数据依赖关系" class="headerlink" title="2、数据长什么样，存什么样，尽量保持数据依赖关系"></a>2、数据长什么样，存什么样，尽量保持数据依赖关系</h2><ul>
<li><p>保持原有的数据结构，有利于后期扩展升级或汇总等。这里保持原有结构的意思</p>
<p>是，保持数据直接原有的依赖关系及数据结构。</p>
<p>例如，有些场景我们可能会偷懒将一个 1:n 的数据放进一张表中，这样做就会有</p>
<p>如下问题：</p>
</li>
</ul>
<ul>
<li>对于 1 这个维度的数据，修改操作会很不方便</li>
</ul>
<ul>
<li>表体积倍增，因为 1 这个维度的数据产生了大量冗余</li>
</ul>
<p>  解决方案：</p>
<ul>
<li><strong>保持 1:n 的关系，然后程序中实现连表（尽量尝试）</strong></li>
</ul>
<h2 id="3、表结构设计、索引设计、查询优化"><a href="#3、表结构设计、索引设计、查询优化" class="headerlink" title="3、表结构设计、索引设计、查询优化"></a>3、表结构设计、索引设计、查询优化</h2><p>关系式：表结构设计+索引设计 -&gt; 查询性能</p>
<p>根据上述公式，我们可以看出，查询的性能取决于表结构和索引结构，简单的修</p>
<p>改 SQL 查询语句的编写方式，并不是解决问题的根本办法。</p>
<p>优良表结构设计的原则列举如下：</p>
<ul>
<li><p>根据实际的查询 SQL，考虑索引结构，避免没有意义和不合理的索引</p>
</li>
<li><p>更多的使用组合索引，并根据组合索引列的查询频繁程度，安排顺序（不需要按照各个列的离散度安排）</p>
</li>
<li><p>在没有业务主键的情况下，给出自增 ID 作为主键</p>
</li>
<li><p>控制索引体积</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/01/24/处理MySql锁等待/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/处理MySql锁等待/" itemprop="url">处理MySql锁等待</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T12:12:57+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/锁/" itemprop="url" rel="index">
                    <span itemprop="name">锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="处理MySql锁等待"><a href="#处理MySql锁等待" class="headerlink" title="处理MySql锁等待"></a>处理MySql锁等待</h1><h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>A.数据更新或新增后数据经常自动回滚。</p>
<p>B.表操作总报 Lock wait timeout exceeded 并长时间无反应</p>
<blockquote>
<p>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</p>
</blockquote>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>A.应急方法：<code>show processlist;</code>kill掉出现问题的进程</p>
<p>B.根治方法：<code>select * from innodb_trx;</code>查看有是哪些事务占据了表资源。</p>
<p><code>show engine innodb status</code></p>
<p><code>show full processlist;</code></p>
<blockquote>
<p>Mysql的 InnoDB存储引擎是支持事务的，事务开启后没有被主动Commit。导致该资源被长期占用，其他事务在抢占该资源时，因上一个事务的锁而导致抢占失败！因此出现 Lock wait timeout exceeded </p>
</blockquote>
<h2 id="与锁相关的三个表"><a href="#与锁相关的三个表" class="headerlink" title="与锁相关的三个表"></a>与锁相关的三个表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; use information_schema;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>innodb_trx                        ## 当前运行的所有事务<br>innodb_locks                    ## 当前出现的锁<br>innodb_lock_waits           ## 锁等待的对应关系</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; desc innodb_locks;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>+————-+———————+——+—–+———+——-+<br>| Field | Type | Null | Key | Default | Extra |<br>+————-+———————+——+—–+———+——-+<br>| lock_id | varchar(81) | NO | | | |#锁ID<br>| lock_trx_id | varchar(18) | NO | | | |#拥有锁的事务ID<br>| lock_mode | varchar(32) | NO | | | |#锁模式<br>| lock_type | varchar(32) | NO | | | |#锁类型<br>| lock_table | varchar(1024) | NO | | | |#被锁的表<br>| lock_index | varchar(1024) | YES | | NULL | |#被锁的索引<br>| lock_space | bigint(21) unsigned | YES | | NULL | |#被锁的表空间号<br>| lock_page | bigint(21) unsigned | YES | | NULL | |#被锁的页号<br>| lock_rec | bigint(21) unsigned | YES | | NULL | |#被锁的记录号<br>| lock_data | varchar(8192) | YES | | NULL | |#被锁的数据<br>+————-+———————+——+—–+———+——-+<br>10 rows in set (0.00 sec)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; desc innodb_lock_waits;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>+——————-+————-+——+—–+———+——-+<br>| Field | Type | Null | Key | Default | Extra |<br>+——————-+————-+——+—–+———+——-+<br>| requesting_trx_id | varchar(18) | NO | | | |#请求锁的事务ID<br>| requested_lock_id | varchar(81) | NO | | | |#请求锁的锁ID<br>| blocking_trx_id | varchar(18) | NO | | | |#当前拥有锁的事务ID<br>| blocking_lock_id | varchar(81) | NO | | | |#当前拥有锁的锁ID<br>+——————-+————-+——+—–+———+——-+<br>4 rows in set (0.00 sec)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; desc innodb_trx ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>+—————————-+———————+——+—–+———————+——-+<br>| Field | Type | Null | Key | Default | Extra |<br>+—————————-+———————+——+—–+———————+——-+<br>| trx_id | varchar(18) | NO | | | |#事务ID<br>| trx_state | varchar(13) | NO | | | |#事务状态：<br>| trx_started | datetime | NO | | 0000-00-00 00:00:00 | |#事务开始时间；<br>| trx_requested_lock_id | varchar(81) | YES | | NULL | |#innodb_locks.lock_id<br>| trx_wait_started | datetime | YES | | NULL | |#事务开始等待的时间<br>| trx_weight | bigint(21) unsigned | NO | | 0 | |#<br>| trx_mysql_thread_id | bigint(21) unsigned | NO | | 0 | |#事务线程ID<br>| trx_query | varchar(1024) | YES | | NULL | |#具体SQL语句<br>| trx_operation_state | varchar(64) | YES | | NULL | |#事务当前操作状态<br>| trx_tables_in_use | bigint(21) unsigned | NO | | 0 | |#事务中有多少个表被使用<br>| trx_tables_locked | bigint(21) unsigned | NO | | 0 | |#事务拥有多少个锁<br>| trx_lock_structs | bigint(21) unsigned | NO | | 0 | |#<br>| trx_lock_memory_bytes | bigint(21) unsigned | NO | | 0 | |#事务锁住的内存大小（B）<br>| trx_rows_locked | bigint(21) unsigned | NO | | 0 | |#事务锁住的行数<br>| trx_rows_modified | bigint(21) unsigned | NO | | 0 | |#事务更改的行数<br>| trx_concurrency_tickets | bigint(21) unsigned | NO | | 0 | |#事务并发票数<br>| trx_isolation_level | varchar(16) | NO | | | |#事务隔离级别<br>| trx_unique_checks | int(1) | NO | | 0 | |#是否唯一性检查<br>| trx_foreign_key_checks | int(1) | NO | | 0 | |#是否外键检查<br>| trx_last_foreign_key_error | varchar(256) | YES | | NULL | |#最后的外键错误<br>| trx_adaptive_hash_latched | int(1) | NO | | 0 | |#<br>| trx_adaptive_hash_timeout | bigint(21) unsigned | NO | | 0 | |#<br>+—————————-+———————+——+—–+———————+——-+<br>22 rows in set (0.01 sec)</p>
</blockquote>
<h2 id="三个表结合查看锁相关信息"><a href="#三个表结合查看锁相关信息" class="headerlink" title="三个表结合查看锁相关信息"></a>三个表结合查看锁相关信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">  pr.id,</span><br><span class="line">  pr.user,</span><br><span class="line">  pr.host,</span><br><span class="line">  pr.db,</span><br><span class="line">  pr.command,</span><br><span class="line">  pr.time,</span><br><span class="line">  inn.trx_state,</span><br><span class="line">  inn.trx_started,</span><br><span class="line">  pr.info,</span><br><span class="line">  tt.id,</span><br><span class="line">  tt.user,</span><br><span class="line">  tt.host,</span><br><span class="line">  tt.command,</span><br><span class="line">  tt.time,</span><br><span class="line">  tt.trx_state,</span><br><span class="line">  tt.trx_started,</span><br><span class="line">  tt.info </span><br><span class="line">FROM</span><br><span class="line">  information_schema.processlist pr,</span><br><span class="line">  information_schema.innodb_trx inn,</span><br><span class="line">  (SELECT </span><br><span class="line">    p.id,</span><br><span class="line">    p.user,</span><br><span class="line">    p.host,</span><br><span class="line">    p.db,</span><br><span class="line">    p.command,</span><br><span class="line">    p.time,</span><br><span class="line">    i.trx_state,</span><br><span class="line">    i.trx_started,</span><br><span class="line">    p.info,</span><br><span class="line">    l.blocking_trx_id </span><br><span class="line">  FROM</span><br><span class="line">    information_schema.processlist p,</span><br><span class="line">    information_schema.innodb_trx i,</span><br><span class="line">    information_schema.innodb_lock_waits l </span><br><span class="line">  WHERE p.id = i.trx_mysql_thread_id </span><br><span class="line">    AND i.trx_id = l.requesting_trx_id) tt </span><br><span class="line">WHERE pr.id = inn.trx_mysql_thread_id </span><br><span class="line">  AND inn.trx_id = tt.blocking_trx_id;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>###初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">use test;</span><br><span class="line"></span><br><span class="line">set autocommit=0;</span><br><span class="line"></span><br><span class="line">create table tx1(</span><br><span class="line">id int primary key ,</span><br><span class="line">c1 varchar(20),</span><br><span class="line">c2 varchar(30)</span><br><span class="line">)engine=innodb default charset = utf8 ;</span><br><span class="line"></span><br><span class="line">insert into tx1 values</span><br><span class="line">(1,&apos;aaaa&apos;,&apos;aaaaa2&apos;),</span><br><span class="line">(2,&apos;bbbb&apos;,&apos;bbbbb2&apos;),</span><br><span class="line">(3,&apos;cccc&apos;,&apos;ccccc2&apos;);</span><br><span class="line"></span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>###产生事务；</p>
<p>Session1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">update tx1 set c1=&apos;heyf&apos;,c2=&apos;heyf&apos; where id =3 ;</span><br></pre></td></tr></table></figure>
<p>###产生事务，在innodb_trx就有数据 ；</p>
<blockquote>
<p>mysql&gt; USE information_schema;<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A</p>
<p>Database changed<br>mysql&gt; select <em> from innodb_trx\G;<br><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></em> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>​                    trx_id: 112431<br>​                 trx_state: RUNNING<br>​               trx_started: 2018-11-24 11:53:48<br>​     trx_requested_lock_id: NULL<br>​          trx_wait_started: NULL<br>​                trx_weight: 3<br>​       trx_mysql_thread_id: 2<br>​                 trx_query: NULL<br>​       trx_operation_state: NULL<br>​         trx_tables_in_use: 0<br>​         trx_tables_locked: 0<br>​          trx_lock_structs: 2<br>​     trx_lock_memory_bytes: 376<br>​           trx_rows_locked: 1<br>​         trx_rows_modified: 1<br>   trx_concurrency_tickets: 0<br>​       trx_isolation_level: REPEATABLE READ<br>​         trx_unique_checks: 1<br>​    trx_foreign_key_checks: 1<br>trx_last_foreign_key_error: NULL<br> trx_adaptive_hash_latched: 0<br> trx_adaptive_hash_timeout: 10000<br>​          trx_is_read_only: 0<br>trx_autocommit_non_locking: 0<br>1 row in set (0.00 sec)</p>
</blockquote>
<p>###由于没有产生锁等待，下面两个表没有数据 ；</p>
<blockquote>
<p>mysql&gt; select * from innodb_lock_waits\G;<br>Empty set (0.00 sec)</p>
<p>ERROR:<br>No query specified</p>
<p>mysql&gt; select * from innodb_locks\G;<br>Empty set (0.00 sec)</p>
<p>ERROR:<br>No query specified</p>
</blockquote>
<p>###产生锁等待</p>
<p>###session 2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">update tx1 set c1=&apos;heyfffff&apos;,c2=&apos;heyffffff&apos; where id =3 ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>mysql&gt; select <em> from innodb_trx\G;<br><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></em> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>​                    trx_id: 112432<br>​                 trx_state: LOCK WAIT<br>​               trx_started: 2018-11-24 11:56:52<br>​     trx_requested_lock_id: 112432:794:3:4<br>​          trx_wait_started: 2018-11-24 11:56:52<br>​                trx_weight: 2<br>​       trx_mysql_thread_id: 3<br>​                 trx_query: update tx1 set c1=’heyfffff’,c2=’heyffffff’ where id =3<br>​       trx_operation_state: starting index read<br>​         trx_tables_in_use: 1<br>​         trx_tables_locked: 1<br>​          trx_lock_structs: 2<br>​     trx_lock_memory_bytes: 376<br>​           trx_rows_locked: 1<br>​         trx_rows_modified: 0<br>   trx_concurrency_tickets: 0<br>​       trx_isolation_level: REPEATABLE READ<br>​         trx_unique_checks: 1<br>​    trx_foreign_key_checks: 1<br>trx_last_foreign_key_error: NULL<br> trx_adaptive_hash_latched: 0<br> trx_adaptive_hash_timeout: 10000<br>​          trx_is_read_only: 0<br>trx_autocommit_non_locking: 0<br><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 2. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>​                    trx_id: 112431<br>​                 trx_state: RUNNING<br>​               trx_started: 2018-11-24 11:53:48<br>​     trx_requested_lock_id: NULL<br>​          trx_wait_started: NULL<br>​                trx_weight: 3<br>​       trx_mysql_thread_id: 2<br>​                 trx_query: NULL<br>​       trx_operation_state: NULL<br>​         trx_tables_in_use: 0<br>​         trx_tables_locked: 0<br>​          trx_lock_structs: 2<br>​     trx_lock_memory_bytes: 376<br>​           trx_rows_locked: 1<br>​         trx_rows_modified: 1<br>   trx_concurrency_tickets: 0<br>​       trx_isolation_level: REPEATABLE READ<br>​         trx_unique_checks: 1<br>​    trx_foreign_key_checks: 1<br>trx_last_foreign_key_error: NULL<br> trx_adaptive_hash_latched: 0<br> trx_adaptive_hash_timeout: 10000<br>​          trx_is_read_only: 0<br>trx_autocommit_non_locking: 0<br>2 rows in set (0.00 sec)</p>
<p>ERROR:<br>No query specified</p>
</blockquote>
<blockquote>
<p>mysql&gt; select <em> from innodb_locks\G;<br><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></em> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>​    lock_id: 112432:794:3:4<br>lock_trx_id: 112432<br> lock_mode: X<br> lock_type: RECORD<br>lock_table: <code>test</code>.<code>tx1</code><br>lock_index: PRIMARY<br>lock_space: 794<br> lock_page: 3<br>  lock_rec: 4<br> lock_data: 3<br><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 2. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>​    lock_id: 112431:794:3:4<br>lock_trx_id: 112431<br> lock_mode: X<br> lock_type: RECORD<br>lock_table: <code>test</code>.<code>tx1</code><br>lock_index: PRIMARY<br>lock_space: 794<br> lock_page: 3<br>  lock_rec: 4<br> lock_data: 3<br>2 rows in set (0.00 sec)</p>
<p>ERROR:<br>No query specified</p>
</blockquote>
<blockquote>
<p>mysql&gt; select <em> from innodb_lock_waits\G;<br><strong><strong><strong><strong><strong><strong>**</strong></strong></strong></strong></strong></strong></em> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>requesting_trx_id: 112432                    # 请求锁的事务<br>requested_lock_id: 112432:794:3:4     # 请求锁的锁ID<br> blocking_trx_id: 112431                      # 拥有锁的事务<br>blocking_lock_id: 112431:794:3:4       # 拥有锁的锁ID<br>1 row in set (0.00 sec)</p>
</blockquote>
<blockquote>
<p>mysql&gt; show processlist;<br>+—-+——+———————+——————–+———+——+———-+———————————————————+<br>| Id | User | Host                | db                 | Command | Time | State    | Info                                                    |<br>+—-+——+———————+——————–+———+——+———-+———————————————————+<br>|  1 | root | 192.168.132.2:51065 | information_schema | Sleep   | 1364 |          | NULL                                                    |<br>|  2 | root | 192.168.132.2:51695 | test               | Sleep   |  205 |          | NULL                                                    |<br>|  3 | root | 192.168.132.2:51704 | test               | Query   |   21 | updating | update tx1 set c1=’heyfffff’,c2=’heyffffff’ where id =3 |<br>|  4 | root | 192.168.132.2:51707 | test               | Sleep   |  362 |          | NULL                                                    |<br>|  5 | root | localhost           | information_schema | Query   |    0 | init     | show processlist                                        |<br>+—-+——+———————+——————–+———+——+———-+———————————————————</p>
</blockquote>
<p>processlist命令的输出结果显示了有哪些线程在运行，可以帮助识别出有问题的查询语句，两种方式使用这个命令。</p>
<blockquote>
<ol>
<li>进入mysql/bin目录下输入mysqladmin processlist;</li>
<li>启动mysql，输入show processlist;</li>
</ol>
</blockquote>
<p>如果有SUPER权限，则可以看到全部的线程，否则，只能看到自己发起的线程（这是指，当前对应的MySQL帐户运行的线程）。</p>
<p>得到数据形式如下（只截取了三条）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>+—–+————-+——————–+——-+———+——-+———————————-+———-</p>
<p>| Id | User | Host           | db  | Command | Time| State    | Info                                                                                          </p>
<p>+—–+————-+——————–+——-+———+——-+———————————-+———-</p>
<p>|207|root |192.168.0.20:51718 |mytest | Sleep   | 5   |        | NULL                                                                                                </p>
<p>|208|root |192.168.0.20:51719 |mytest | Sleep   | 5   |        | NULL        </p>
<p>|220|root |192.168.0.20:51731 |mytest |Query   | 84  | Locked |</p>
<p>select bookname,culture,value,type from book where id=001|</p>
</blockquote>
<p>各个列的含义：</p>
<blockquote>
<p>id列，一个标识，你要kill一个语句的时候很有用。</p>
<p>user列，显示单前用户，如果不是root，这个命令就只显示你权限范围内的sql语句。</p>
<p>host列，显示这个语句是从哪个ip的哪个端口上发出的。</p>
<p>db列，显示这个进程目前连接的是哪个数据库。</p>
<p>command列，显示当前连接的执行的命令，一般就是休眠（sleep），查询（query），连接（connect）。time列，此这个状态持续的时间，单位是秒。</p>
<p>state列，显示使用当前连接的sql语句的状态，很重要的列，后续会有所有的状态的描述，请注意，state只是语句执行中的某一个状态，一个sql语句，已查询为例，可能需要经过copying to tmp table，Sorting result，Sending data等状态才可以完成。</p>
<p>info列，显示这个sql语句，因为长度有限，所以长的sql语句就显示不全，但是一个判断问题语句的重要依据。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大部分状态对应很快的操作，只要有一个线程保持同一个状态好几秒钟，那么可能是有问题发生了，需要检查一下。</p>
<p>这个命令中最关键的就是state列，mysql列出的状态主要有以下几种：</p>
<blockquote>
<p>​    Checking table<br>　正在检查数据表（这是自动的）。</p>
<p>　Closing tables<br>　正在将表中修改的数据刷新到磁盘中，同时正在关闭已经用完的表。这是一个很快的操作，如果不是这样的话，就应该确认磁盘空间是否已经满了或者磁盘是否正处于重负中。</p>
<p>　Connect Out<br>　复制从服务器正在连接主服务器。</p>
<p>　Copying to tmp table on disk<br>　由于临时结果集大于tmp_table_size，正在将临时表从内存存储转为磁盘存储以此节省内存。</p>
<p>　Creating tmp table<br>　正在创建临时表以存放部分查询结果。</p>
<p>　deleting from main table<br>　服务器正在执行多表删除中的第一部分，刚删除第一个表。</p>
<p>　deleting from reference tables<br>　服务器正在执行多表删除中的第二部分，正在删除其他表的记录。</p>
<p>　Flushing tables<br>　正在执行FLUSH TABLES，等待其他线程关闭数据表。</p>
<p>　Killed<br>　发送了一个kill请求给某线程，那么这个线程将会检查kill标志位，同时会放弃下一个kill请求。MySQL会在每次的主循环中检查kill标志位，不过有些情况下该线程可能会过一小段才能死掉。如果该线程程被其他线程锁住了，那么kill请求会在锁释放时马上生效。</p>
<p>　Locked<br>　被其他查询锁住了。</p>
<p>　Sending data<br>　正在处理Select查询的记录，同时正在把结果发送给客户端。</p>
<p>　Sorting for group<br>　正在为GROUP BY做排序。</p>
<p>　Sorting for order<br>　正在为ORDER BY做排序。</p>
<p>　Opening tables<br>　这个过程应该会很快，除非受到其他因素的干扰。例如，在执Alter TABLE或LOCK TABLE语句行完以前，数据表无法被其他线程打开。正尝试打开一个表。</p>
<p>　Removing duplicates<br>　正在执行一个Select DISTINCT方式的查询，但是MySQL无法在前一个阶段优化掉那些重复的记录。因此，MySQL需要再次去掉重复的记录，然后再把结果发送给客户端。</p>
<p>　Reopen table<br>　获得了对一个表的锁，但是必须在表结构修改之后才能获得这个锁。已经释放锁，关闭数据表，正尝试重新打开数据表。</p>
<p>　Repair by sorting<br>　修复指令正在排序以创建索引。</p>
<p>　Repair with keycache<br>　修复指令正在利用索引缓存一个一个地创建新索引。它会比Repair by sorting慢些。</p>
<p>　Searching rows for update<br>　正在讲符合条件的记录找出来以备更新。它必须在Update要修改相关的记录之前就完成了。</p>
<p>　Sleeping<br>　正在等待客户端发送新请求。</p>
<p>　System lock<br>　正在等待取得一个外部的系统锁。如果当前没有运行多个mysqld服务器同时请求同一个表，那么可以通过增加–skip-external-locking参数来禁止外部系统锁。</p>
<p>　Upgrading lock<br>　Insert DELAYED正在尝试取得一个锁表以插入新记录。</p>
<p>　Updating<br>　正在搜索匹配的记录，并且修改它们。</p>
<p>　User Lock<br>　正在等待GET_LOCK()。</p>
<p>　Waiting for tables<br>　该线程得到通知，数据表结构已经被修改了，需要重新打开数据表以取得新的结构。然后，为了能的重新打开数据表，必须等到所有其他线程关闭这个表。以下几种情况下会产生这个通知：FLUSH TABLES tbl_name, Alter TABLE, RENAME TABLE, REPAIR TABLE, ANALYZE TABLE,或OPTIMIZE TABLE。</p>
<p>　waiting for handler insert</p>
<p>　Insert DELAYED已经处理完了所有待处理的插入操作，正在等待新的请求。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/01/24/自增锁/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/24/自增锁/" itemprop="url">自增锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-24T12:12:57+08:00">
                2019-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/锁/" itemprop="url" rel="index">
                    <span itemprop="name">锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol>
<li><p>低于8版本的mysql中innodb_autoinc_lock_mode默认值为1，不是0。导致了并发insert不会产生表锁。博默认配置是不会开启表锁的</p>
<p><strong>set session innodb_autoinc_lock_mode=OFF</strong></p>
</li>
<li><p>关闭事务自动提交</p>
<p><strong>set global autocommit=0</strong></p>
</li>
</ol>
<h2 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h2><p>MySQL，InnoDB，默认的隔离级别(RR)，假设有数据表：<br>t(id AUTO_INCREMENT, name);</p>
<p>数据表中有数据：<br>1, shenjian<br>2, zhangsan<br>3, lisi</p>
<p>事务A先执行，还未提交：<br>insert into t(name) values(xxx);</p>
<p>事务B后执行：<br>insert into t(name) values(ooo);</p>
<p>问：事务B会不会被阻塞？</p>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>InnoDB在RR隔离级别下，能解决幻读问题，上面这个案例中：<br>(1)事务A先执行insert，会得到一条(4, xxx)的记录，由于是自增列，故不用显示指定id为4，InnoDB会自动增长，注意此时事务并未提交；</p>
<p>(2)事务B后执行insert，假设不会被阻塞，那会得到一条(5, ooo)的记录；</p>
<p>此时，并未有什么不妥，但如果，<br>(3)事务A继续insert：<br>insert into t(name) values(xxoo);<br>会得到一条(6, xxoo)的记录。</p>
<p>(4)事务A再select：<br>select * from t where id&gt;3;</p>
<p>得到的结果是：<br>4, xxx<br>6, xxoo<br>画外音：不可能查询到5的记录，再RR的隔离级别下，不可能读取到还未提交事务生成的数据。</p>
<p>咦，这对于事务A来说，就很奇怪了，对于AUTO_INCREMENT的列，连续插入了两条记录，一条是4，接下来一条变成了6，就像莫名其妙的幻影。<strong>幻读</strong></p>
<h2 id="自增锁（Auto-inc-Locks）"><a href="#自增锁（Auto-inc-Locks）" class="headerlink" title="自增锁（Auto-inc Locks）"></a>自增锁（Auto-inc Locks）</h2><p>自增锁是一种特殊的表级别锁（table-level lock），专门针对事务插入AUTO_INCREMENT类型的列。最简单的情况，如果一个事务正在往表中插入记录，所有其他事务的插入必须等待，以便第一个事务插入的行，是连续的主键值。<br>画外音：官网是这么说的<br>An AUTO-INC lock is a special table-level lock taken by transactions inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values.</p>
<p>与此同时，InnoDB提供了innodb_autoinc_lock_mode配置，可以调节与改变该锁的模式与行为。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1. innodb_autoinc_lock_mode为0时的，也就是官方说的traditional级别，该自增锁是表锁级别，且必须等待当前SQL执行完成后或者回滚掉才会释放，这样在高并发的情况下自增锁竞争是比较大的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2. innodb_autoinc_lock_mode为1时的，也就是官方说的consecutive级别，，即保证同一条insert语句中新插入的auto_increment id都是连续的。这时如果是单一的insert SQL，可以立即获得该锁，并立即释放，而不必等待当前SQL执行完成。另外当SQL是一些批量insert sql时，比如insert into ...select ...,load data,replace ..select..时，这时还是表级锁，可以理解成退化为必须等待当前SQL执行完才释放。</span><br><span class="line">可以认为，该值为1时是相对比较轻量的锁，也不会对复制产生影响，唯一的缺陷是产生的自增值不一定是完全连续的。</span><br><span class="line"></span><br><span class="line">     (1)“Simple inserts”：直接通过分析语句，获得要插入的数量，然后一次性分配足够的auto_increment id，只会将整个分配的过程锁住。</span><br><span class="line"></span><br><span class="line">     (2)“Bulk inserts”：因为不能确定插入的数量，因此使用和以前的模式相同的表级锁定。</span><br><span class="line"></span><br><span class="line">     (3)“Mixed-mode inserts”：直接分析语句，获得最坏情况下需要插入的数量，然后一次性分配足够的auto_increment id，只会将整个分配的过程锁住。</span><br><span class="line"></span><br><span class="line">         需要注意的是，这种方式下，会分配过多的id，而导致“浪费”。</span><br><span class="line">         比如INSERT INTO t1 (c1,c2) VALUES (1,’a&apos;), (NULL,’b&apos;), (5,’c&apos;), (NULL,’d&apos;);会一次性的分配5个id，而不管用户是否指定了部分id；</span><br><span class="line">         INSERT … ON DUPLICATE KEY UPDATE一次性分配，而不管将来插入过程中是否会因为duplicate key而仅仅执行update操作。</span><br><span class="line">  </span><br><span class="line"> 注意：当master mysql版本&lt;5.1.22，slave mysql版本&gt;=5.1.22时，slave需要将innodb_autoinc_lock_mode设置为0，因为默认的innodb_autoinc_lock_mode为1，对于INSERT … ON DUPLICATE KEY UPDATE和INSERT INTO t1 (c1,c2) VALUES (1,’a&apos;), (NULL,’b&apos;), (5,’c&apos;), (NULL,’d&apos;);的执行结果不同，现实环境一般会使用INSERT … ON DUPLICATE KEY UPDATE。</span><br><span class="line"> </span><br><span class="line">3. 当innodb_autoinc_lock_mode设置为2时，所有insert种类的SQL都可以立马获得锁并释放，这时的效率最高。但是会引入一个新的问题：当binlog_format为statement时，这时的复制没法保证安全，因为批量的insert，比如insert ..select..语句在这个情况下，也可以立马获取到一大批的自增id值，不必锁整个表，slave在回放这个sql时必然会产生错乱。</span><br><span class="line"></span><br><span class="line">这种模式是来一个分配一个，而不会锁表，只会锁住分配id的过程，和innodb_autoinc_lock_mode = 1的区别在于，不会预分配多个，这种方式并发性最高。但是在replication中当binlog_format为statement-based时（简称SBR statement-based replication）存在问题，因为是来一个分配一个，这样当并发执行时，“Bulk inserts”在分配的时会同时向其他的INSERT分配，会出现主从不一致（从库执行结果和主库执行结果不一样），因为binlog只会记录开始的insert id。从库将会出现主键冲突。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 innodb  row复制时，可将innodb_autoinc_lock_mode设置为2，这时可在所有insert情况下表获得最大并发度</span><br><span class="line">2 innodb statement复制时，可将innodb_autoinc_lock_mode设置为1，保证复制安全的同时，获得简单insert语句的最大并发度</span><br><span class="line"></span><br><span class="line">3 myisam引擎情况下，无论什么样自增id锁都是表级锁，设置innodb_autoinc_lock_mode参数无效</span><br><span class="line"></span><br><span class="line">4 在innodb引擎下自增id值作为主键的情况下，相比uuid或者自定义的主键，是可以提到插入速度的，因为innodb是主键聚集索引，实际的主键值必须按照主键顺序存取，那么自增id本身就是升序的，那么在插入数据时，底层就不必再做额外的排序操作，也减少了索引页分裂的次数，从而大大增加insert速度（除非其他方案也能保证主键完全自增）</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/ashic/article/details/53810319" target="_blank" rel="noopener">InnoDB AUTO_INCREMENT锁定模式使用含义</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/134/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/134/">134</a><span class="page-number current">135</span><a class="page-number" href="/page/136/">136</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/136/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
