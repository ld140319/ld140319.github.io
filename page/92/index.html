<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/92/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/92/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/30/优秀日志实践准则/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/优秀日志实践准则/" itemprop="url">优秀日志实践准则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T12:12:57+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/日志处理/" itemprop="url" rel="index">
                    <span itemprop="name">日志处理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="优秀日志实践准则"><a href="#优秀日志实践准则" class="headerlink" title="优秀日志实践准则"></a>优秀日志实践准则</h1><blockquote>
<p>原文地址：<a href="http://tech.lede.com/2017/06/29/rd/server/loggingHabit/" target="_blank" rel="noopener">http://tech.lede.com/2017/06/29/rd/server/loggingHabit/</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;程序员的日常离不开日志，日志就好比是程序员的私人秘书，负责运行周期一切trace工作。优秀的日志实践能极大帮助程序员快速定位问题，减少在线错误报警。本文从日志书写时各方面来做阐述，依据日志推荐的日志等级，做相应优秀日志实践的推荐。</p>
<h2 id="重新认识日志"><a href="#重新认识日志" class="headerlink" title="重新认识日志"></a>重新认识日志</h2><h3 id="1-日志级别概述"><a href="#1-日志级别概述" class="headerlink" title="1.日志级别概述"></a>1.日志级别概述</h3><ul>
<li><strong>ERROR</strong></li>
</ul>
<p>  ERROR是最高级别错误，反映系统发生了非常<strong>严重的故障，无法自动恢复到正常态工作，需要人工介入处理</strong>。系统需要将错误相关痕迹以及错误细节记录ERROR日志中，方便后续人工回溯解决。</p>
<ul>
<li><strong>WARN</strong></li>
</ul>
<p>  WARN是低级别异常日志，反映<strong>系统在业务处理时触发了异常流程，但系统可恢复到正常态，下一次业务可以正常执行</strong>。但WARN级别问题需要开发人员给予足够关注，*<em>往往表示有参数校验问题或者程序逻辑缺陷，当功能逻辑走入异常逻辑时，应该考虑记录WARN日志</em>。</p>
<ul>
<li><strong>INFO</strong></li>
</ul>
<p>  INFO日志主要记录系统关键信息，旨在保留系统正常工作期间关键运行指标，开发人员可以将<strong>初始化系统配置、业务状态变化信息，或者用户业务流程中的核心处理记录到INFO日志中</strong>，方便日常运维工作以及错误回溯时上下文场景复现。</p>
<ul>
<li><strong>DEBUG</strong></li>
</ul>
<p>  DEBUG日志是INFO日志的好帮手，开发人员可以将<strong>各类详细信息记录到DEBUG里，起到调试的作用，包括参数信息，调试细节信息，返回值信息</strong>等等。其他等级不方便显示的信息都可以通过DEBUG日志来记录。</p>
<h3 id="2-记录日志的时机"><a href="#2-记录日志的时机" class="headerlink" title="2.记录日志的时机"></a>2.记录日志的时机</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在看线上日志的时候，我们可曾陷入到日志泥潭？该出现的日志没有，无用的日志一大堆，或者需要的信息分散在各个角落，特别是遇到紧急的在线bug时，有效的日志被大量无意义的日志信息淹没，焦急且无奈地浪费大量精力查询日志。那什么是记录日志的合适时机呢？</p>
<p>总结几个需要写日志的点：</p>
<ol>
<li><strong>编程语言提示异常</strong>：如今各类主流的编程语言都包括异常机制，业务相关的流行框架有完整的异常模块。这类捕获的异常是系统告知开发人员需要加以关注的，是质量非常高的报错。<strong>应当适当记录日志，根据实际结合业务的情况使用warn或者error级别</strong>。</li>
<li><strong>业务流程预期不符</strong>：除开平台以及编程语言异常之外，项目代码中结果与期望不符时也是日志场景之一，简单来说所有流程分支都可以加入考虑。取决于开发人员判断能否容忍情形发生。<strong>常见的合适场景包括外部参数不正确，数据处理问题导致返回码不在合理范围内等等</strong>。</li>
<li><strong>系统核心角色，组件关键动作</strong>：系统中核心角色触发的业务动作是需要多加关注的，是衡量系统正常运行的重要指标，<strong>建议记录INFO级别日志</strong>，比如电商系统用户从登录到下单的整个流程；<strong>微服务各服务节点交互；核心数据表增删改；核心组件运行</strong>等等，如果日志频度高或者打印量特别大，可以提炼关键点INFO记录，其余酌情考虑DEBUG级别。</li>
<li><strong>系统初始化</strong>：<strong>系统或者服务的启动参数</strong>。核心模块或者组件初始化过程中往往依赖一些关键配置，根据参数不同会提供不一样的服务。<strong>务必在这里记录INFO日志，打印出参数以及启动完成态服务表述</strong>。</li>
</ol>
<h3 id="3-警惕日志性能代价"><a href="#3-警惕日志性能代价" class="headerlink" title="3.警惕日志性能代价"></a>3.警惕日志性能代价</h3><p>  不管是多么优秀的日志工具，在日志输出时总会对性能产生或多或少的影响，为了将影响降低到最低，有以下几个准则需要遵守：</p>
<ul>
<li><p>根本原则：有必要才记录日志，频繁过量日志对性能是有损耗的，并且这种风险不常在系统正常时出现，系统出现问题时大量ERROR，INFO等问题相关日志有可能产生连锁反应，造成严重的后果。<strong>将关键信息保存到日志，同时考虑极端场景日志爆发</strong>。</p>
</li>
<li><p>Logger获取: 根据系统使用的日志框架组合，确定正确的实例获取方式。在log4j的早期版本，一般要求使用static，而在高版本以及后来的slf4j等一些框架封装中，该问题已经得到优化，获取（创建）logger实例的成本已经很低。但对于多例，尤其是需要频繁创建的class，推荐添加static前缀。</p>
</li>
<li><p>输出等级校验: 在log4j 1.x版本，对于可以预见的会频繁产生的日志输出，先判断一下(logger.isXXXEnabled()，对于性能有很大提升，在其他外观框架或者log4j 2.x中已经自动实现。</p>
</li>
<li><p><strong>输出格式：禁止使用字符串拼接，使用参数方式</strong>。</p>
</li>
<li><p><strong>样式配置: 布局配置输出的信息也会影响到性能，需要根据logger的具体使用场景来选择输出合适信息</strong>。</p>
<p>  上述几点可以看出，核心都是减少日志量 ，前两点偏向设计，后四点偏向日志框架及习惯，并且这四点目前一些框架组合已经能帮开发人员减少不少工作，比如log4j2.x在实例获取，输出等级判断都有优化。除开减少日志量，还需要<strong>注意多线程以及高并发情况下的日志输出</strong>。<strong>日志输出本身是写磁盘操作，自然会有性能瓶颈</strong>。更多属于日志框架选择及优化方面，选择日志框架时除了考虑正常功能使用，务必关注该日志框架影响性能的细节，日志的出发点是帮助处理问题，如果成为隐患就得不偿失了。介绍日志框架选择的文章很多，在此就不做详细介绍了。</p>
</li>
</ul>
<h2 id="优秀的INFO-DEBUG实践"><a href="#优秀的INFO-DEBUG实践" class="headerlink" title="优秀的INFO,DEBUG实践"></a>优秀的INFO,DEBUG实践</h2><p>  INFO和DEBUG级别日志描述的是系统正常运行时的表征。在监控程序正常执行，处理客服反馈，分析用户行为时起到重要作用。因此优秀的INFO,DEBUG日志能帮助开发人员快速了解运行时的各个细节。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li><strong>线上问题跟踪</strong></li>
</ul>
<p>  客服反馈或者线上问题很难解决时，需要更多细节信息，这时会寻求日志的帮助，<code>error，warn，info</code>都可能对解决问题有所帮助。<strong>必要时还需要开启<code>debug</code>日志帮忙在线定位问题</strong>。【<strong>这种一般根据info中记录的异常流程、请求参数来分析</strong>】</p>
<ul>
<li><strong>场景还原</strong></li>
</ul>
<p>  随着数据重要性越来越高，日志的作用不再单单帮助纠错，构建上下文也成为日志大放光彩的地方，还原一个会话，需要在日志中需要加入会话标识的概念，可以是简单的ip或者复杂会话痕迹：常见包括以下两个角度：<strong>模块维度记录</strong>：登录模块，商品详情模块，下单模块，支付模块，派发模块等；<strong>以行为维度记录</strong>：在什么时间，在什么地方，在干什么，结果是什么样；统一加上会话标识以及时间属性即可。这也是<strong>微服务日志以及数据分析的基础</strong>。</p>
<ul>
<li><strong>监控调优</strong></li>
</ul>
<p>  对于系统的监控调优也是日常工作之一，主要通过日志进行信息记录，主要关注以下3个部分的日志：</p>
<ol>
<li><strong>请求处理时间</strong></li>
<li><strong>模块操作处理的时间</strong></li>
<li><strong>核心组件操作的时间</strong>（<code>db</code>，缓存，磁盘<code>io</code>等等）</li>
</ol>
<h3 id="日志内容"><a href="#日志内容" class="headerlink" title="日志内容"></a>日志内容</h3><p>日志应当提供如下内容：</p>
<ul>
<li><p><strong>时间</strong>，包含时区信息和毫秒，这个工作往往日志框架足以支持。核心属性之一。</p>
</li>
<li><p><strong>日志级别</strong>，例如 <code>debug</code>、<code>info</code> 以及<code>warn</code>、<code>error</code></p>
</li>
<li><p><strong>会话标识</strong>，<strong>能知道是哪个客户端或者是哪个用户触发，登陆账号，seesion信息</strong>等</p>
</li>
<li><p><strong>功能标识</strong>，功能标识的意义在于方便日志搜索，跟踪指定功能的完整轨迹，是INFO，DEBUG日志的常见技巧。<strong>跟logger分类同一道理，更细分功能标识则是方法标识，更多使用在DEBUG做在线调试使用</strong>。</p>
</li>
<li><p><strong>精炼的内容</strong>，内容永远是日志的核心，结合上述使用场景，简单来说<strong>包括场景信息（谁，什么功能等），状态信息(开始，中断，结束)以及重要参数</strong>.</p>
</li>
<li><p><strong>其他信息</strong>，其他可能的有用信息包括：<strong>版本号，线程号</strong>等。</p>
</li>
</ul>
<h3 id="INFO和DEBUG的选择"><a href="#INFO和DEBUG的选择" class="headerlink" title="INFO和DEBUG的选择"></a>INFO和DEBUG的选择</h3><p>  <strong>DEBUG级别比INFO低，包含调试时更详细的了解系统运行状态的东西，比如变量的值等等，都可以输出到DEBUG日志里</strong>。 INFO是在线日志默认的输出级别，反馈系统的当前状态给最终用户看的。输出的信息，应该对最终用户具有实际意义的。从功能角度上说，Info输出的信息可以看作是软件产品的一部分，所以需要谨慎对待，不可随便输出。<strong>尝试记录INFO日志时不妨在头脑中模拟线上运行，如果这条日志会被频繁打印或者大部分时间对于纠错起不到作用，就应当考虑下调为DEBUG级别</strong>。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>由于<code>info</code>及<code>debug</code>日志打印量远大于<code>ERROR</code>，出于前文日志性能的考虑，<strong>如果代码为核心代码，执行频率非常高，务必推敲日志设计是否合理，是否需要下调为DEBUG级别日志</strong>。</li>
<li>注意日志的可读性，不妨在写完代码review这条日志是否通顺，能否提供真正有意义的信息。</li>
<li><strong>日志输出是多线程公用的</strong>，如果有另外一个线程正在输出日志，上面的记录就会被打断，最终显示输出和预想的就会不一致。【<strong>可能多条日志之间是不连贯的，需要自己加上唯一标识来关联</strong>】</li>
<li><strong>线上代码禁止出现各类print等</strong></li>
<li>不要认为记录DEBUG就等同于在线忽略。很多情况因为担心线上出问题时缺少有用信息而对于等级犹豫不决，担心记录为DEBUG对于在线调试起不到作用。你需要的不是研究日志级别，而是实时日志等级调整工具。尝试记录为DEBUG，<strong>线上有必要使用DEBUG级别调试时再调整对应logger级别</strong>。</li>
</ol>
<h2 id="优秀的WARN-ERROR实践"><a href="#优秀的WARN-ERROR实践" class="headerlink" title="优秀的WARN,ERROR实践"></a>优秀的WARN,ERROR实践</h2><h3 id="使用时机和思路"><a href="#使用时机和思路" class="headerlink" title="使用时机和思路"></a>使用时机和思路</h3><p>  当方法或者功能处理过程中产生不符合预期结果或者有框架报错时可以考虑使用，常见问题处理方法包括：</p>
<ul>
<li><strong>增加判断处理逻辑，尝试本地解决</strong></li>
<li><strong>抛出异常，交给上层逻辑解决</strong></li>
<li><strong>记录日志，报警提醒</strong></li>
<li><strong>使用返回码包装错误做返回</strong></li>
</ul>
<h3 id="几个成长阶段"><a href="#几个成长阶段" class="headerlink" title="几个成长阶段"></a>几个成长阶段</h3><ul>
<li>不记录日志，顺其自然，tomcat或者框架来捕获最后的异常</li>
<li>方法出入口try catch， e.printstack()， system.out， log混合使用</li>
<li><strong>有判断校验减少异常可能性，能合理小范围使用try catch，使用log作为唯一记录方式</strong></li>
<li><strong>灵活运用处理办法，合理抛留异常</strong>。<strong>报警少而精</strong></li>
</ul>
<h3 id="方法和准则"><a href="#方法和准则" class="headerlink" title="方法和准则"></a>方法和准则</h3><ul>
<li><p><strong>增加逻辑判断吞掉报警永远是最优选择</strong>。</p>
</li>
<li><p><strong>不在预期范围内的情景，则考虑返回码包装或者抛出异常</strong>，需要依情况而定：</p>
<p>返回码的缺点：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>不直观，不友好</strong>，处处都需要进行显示判断，返回码都有具体含义，但字面不体现，持续维护时代码理解成本高。</p>
<p>异常机制的缺点：</p>
<ol>
<li>必须在系统内部，<strong>多系统交互，前后台交互场景等无法使用</strong></li>
<li><strong>每一个异常分支都可能需要单独一个类作为描述和控制，大量错误类型造成代码量增加</strong>。</li>
</ol>
</li>
<li><p><strong>一旦抛出异常，必须catch处理</strong>，挑选正确方式：</p>
<ol>
<li>打印日志：当前逻辑就能处理掉的，<strong>不需要上层再处理的，或者本身就是最上层</strong>。</li>
<li>重抛异常：<strong>判断异常当前无法处理，需要继续向上抛出</strong>，可以经过异常包装转义。需要注意当前是否为最上层。</li>
</ol>
</li>
<li><p><strong>避免过大的try块，尽量保持一个try块对应一个或多个异常</strong>。</p>
</li>
<li><p><strong>细化异常的类型，避免不顾细节抛出Excetpion</strong>。异常类的作用就是告诉Java编译器我们想要处理的是哪一种异常，然后针对具体的异常类进行不同的处理。</p>
</li>
<li><p><strong>函数返回值能表达错误含义，则不应该打印ERROR日志，防止ERROR日志泛滥</strong>。错误不一定到边界才能终止，只要返回到能处理它的地方就应当终止。</p>
</li>
</ul>
<h2 id="使用WARN和统计报警"><a href="#使用WARN和统计报警" class="headerlink" title="使用WARN和统计报警"></a>使用WARN和统计报警</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>一般来说，WARN级别不会短信报警，ERROR级别则会短信报警甚至电话报警，ERROR级别的日志意味着系统中发生了非常严重的问题，必须有人马上处理</strong>，比如数据库不可用，系统的关键业务流程走不下去等等。错误的使用反而带来严重的后果，不区分问题的重要程度，只要有问题就error记录下来，其实这样是非常不负责任的，因为对于成熟的系统，都会有一套完整的报错机制，那这个错误信息什么时候需要发出来，很多都是<strong>依据单位时间内ERROR日志的数量来确定的</strong>。因此如果我们不分轻重缓急，一律ERROR对待，就会徒增报错的频率，久而久之，我们的救火队员对错误警报就不会那么在意，这个警报也就失去了原始的意义。</p>
<p>   WARN代表可恢复的异常，此次失败不影响下次业务的执行，开发人员会苦恼某些场景下几次失败可容忍，频率高的时候需要提醒，记录ERROR的结果是线上时不时出现容忍范围内的报警，这时报警是无意义的。但反之不记录ERROR日志，真正出现问题则不会有实时报警，错过最佳处理时机。</p>
<ul>
<li><strong>请使用WARN级别配合统计报警</strong>，统计报警的实现方法有很多种，代码统计，脚本统计，zabbix统计等等，挑选合适的统计方式结合warn级别，<strong>建立频次报警机制，做到适时，适量提醒</strong>。</li>
</ul>
<h2 id="强调ERROR报警"><a href="#强调ERROR报警" class="headerlink" title="强调ERROR报警"></a>强调ERROR报警</h2><p>  ERROR的报出应该伴随着业务功能受损，即上面提到的系统中发生了非常严重的问题，必须有人马上处理。</p>
<h3 id="ERROR日志目标"><a href="#ERROR日志目标" class="headerlink" title="ERROR日志目标"></a>ERROR日志目标</h3><p>  给处理者直接准确的信息：error信息形成自身闭环。</p>
<ol>
<li><strong>问题定位</strong>：发生了什么问题，哪些功能受到影响</li>
<li><strong>获取帮助信息</strong>：直接帮助信息或帮助信息的存储位置</li>
<li><strong>通过报警知道解决方案或者找何人解决</strong></li>
</ol>
<h3 id="实用模板"><a href="#实用模板" class="headerlink" title="实用模板"></a>实用模板</h3><p>日志模板2选1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log.error(“[接口名或操作名] [Some Error Msg] happens. [Probably Because]. [Probably need to do]   [params] .”);</span><br><span class="line">log.error(“[接口名或操作名] [Some Error Msg] happens. [Probably Because]. [please contact xxx@xxx]   [params] .”);</span><br></pre></td></tr></table></figure>
<p>  请尽量按上述模板完成，如果实施起来有难度，至少ERROR 日志打印时需要在做一个自我问答，能非常有效的帮助评估这条报警是否有意义：这条报警看到之后我能处理吗？ 应该怎么处理? 如果是同事看到能处理或者及时通知联系人呢吗？ 因为你不可能保证随时都处在工作状态，但报警时随时有可能出现的。</p>
<h2 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li><strong>参数检查不是异常</strong></li>
</ul>
<p>  不要将属于你的检查工作变成<code>ERROR</code>日志。参数检查属于开发人员的工作，而不是全部交给日志。</p>
<ul>
<li><strong>留意业务相关性</strong></li>
</ul>
<p>  技术相关异常是你需要记录并为此做出反应的。比如内存不足，接口访问超时。涉业务过深的返回需要结合实际情况考虑，比如用户操作错误大多属于业务范畴：用户无权限参与这次活动返回码。在大多数场景下这个日志作用不大。</p>
<ul>
<li>异常增加结构化参数</li>
</ul>
<p>  异常代表一类错误，但仅仅是异常类型无法帮助解决问题。<strong>保留异常现场参数，保证所有相关的堆栈追踪信息的开始处记录在你的日志中</strong>。</p>
<ul>
<li><strong>不要记录日志又重新向外抛出</strong></li>
</ul>
<h2 id="附录：阿里java编程规范-日志部分："><a href="#附录：阿里java编程规范-日志部分：" class="headerlink" title="附录：阿里java编程规范-日志部分："></a>附录：阿里java编程规范-日志部分：</h2><ul>
<li><strong>日志规约</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">【强制】应用中不可直接使用日志系统（Log4j、Logback）中的API，而应依赖使用日志框架SLF4J中的API，使用门面模式的日志框架，有利于维护和各个类的日志处理方式统一。</span><br><span class="line">      import org.slf4j.Logger;</span><br><span class="line">      import org.slf4j.LoggerFactory;</span><br><span class="line">          private static final Logger logger = LoggerFactory.getLogger(Abc.class);        </span><br><span class="line">      slf4j是日志门面框架，其仅提供日志记录的API，而不实现日志记录的功能，slf4j需要通过适配库适配到log4j或logback等日志系统来实现日志的记录。使用slf4j api能够提升代码和应用的可移植性，在使用不同日志系统的应用之间能够做到无缝的适配。同时，使用slf4j api的应用，在切换日志系统时（比如从logback切换到log4j2，不需要代码改造）</span><br><span class="line"></span><br><span class="line">【强制】日志文件推荐至少保存15天，因为有些异常具备以“周”为频次发生的特点。</span><br><span class="line"></span><br><span class="line">【强制】应用中的扩展日志（如打点、临时监控、访问日志等）命名方式：appName_logType_logName.log。</span><br><span class="line">       logType:日志类型，推荐分类有stats/desc/monitor/visit等；</span><br><span class="line">       logName:日志描述。这种命名的好处：通过文件名就可知道日志文件属于什么应用，什么类型，什么目的，也有利于归类查找。</span><br><span class="line">       正例：mppserver应用中单独监控时区转换异常，如： mppserver_monitor_timeZoneConvert.log</span><br><span class="line">       说明：推荐对日志进行分类，如将错误日志和业务日志分开存放，便于开发人员查看，也便于通过日志对系统进行及时监控。</span><br><span class="line"></span><br><span class="line">【强制】对trace/debug/info级别的日志输出，必须使用条件输出形式或者使用占位符的方式。</span><br><span class="line">       说明：logger.debug(&quot;Processing trade with id: &quot; + id + &quot; symbol: &quot; + symbol); 如果日志级别是warn，上述日志不会打印，但是会执行字符串拼接操作，如果symbol是对象，会执行toString()方法，浪费了系统资源，执行了上述操作，最终日志却没有打印。</span><br><span class="line">       正例：（条件）</span><br><span class="line">           if (logger.isDebugEnabled()) &#123; </span><br><span class="line">               logger.debug(&quot;Processing trade with id: &quot; + id + &quot; symbol: &quot; + symbol); </span><br><span class="line">             &#125;      </span><br><span class="line">       正例：（占位符）</span><br><span class="line">           logger.debug(&quot;Processing trade with id: &#123;&#125; symbol : &#123;&#125; &quot;, id, symbol);     </span><br><span class="line">      占位符方式，log4j2/logback支持，log4j1.x是不直接支持的，只能通过slf4j库适配</span><br><span class="line"></span><br><span class="line">【强制】避免重复打印日志，浪费磁盘空间，务必在log4j.xml中设置additivity=false。</span><br><span class="line">        正例：</span><br><span class="line">           additivity默认为true，即通过该logger输出的日志会同时输出到root logger，如果还为该logger指定了独立的appender，就会导致这部分日志重复输出</span><br><span class="line"></span><br><span class="line">【强制】异常信息应该包括两类信息：案发现场信息和异常堆栈信息。如果不处理，那么通过关键字throws往上抛出。</span><br><span class="line">        正例：</span><br><span class="line">            logger.error(各类参数或者对象toString + &quot;_&quot; + e.getMessage(), e);             </span><br><span class="line">      记录异常日志的常见错误：</span><br><span class="line">        logger.error(e);</span><br><span class="line">        logger.error(e.getMessage());</span><br><span class="line">        logger.error(&quot;上下文&quot;+e.getMessage())；        </span><br><span class="line">      上面这几种都是错的！请确保使用的是两个入参的API，如error(String s, Throwable t)</span><br><span class="line"></span><br><span class="line">【推荐】谨慎地记录日志。生产环境禁止输出debug日志；有选择地输出info日志；如果使用warn来记录刚上线时的业务行为信息，一定要注意日志输出量的问题，避免把服务器磁盘撑爆，并记得及时删除这些观察日志。</span><br><span class="line">        说明：大量地输出无效日志，不利于系统性能提升，也不利于快速定位错误点。记录日志时请思考：这些日志真的有人看吗？看到这条日志你能做什么？能不能给问题排查带来好处？不要认为日志记录不怎么消耗性能，我见过不少事无巨细式的日志把系统性能严重拖慢的案例</span><br><span class="line"></span><br><span class="line">【参考】可以使用warn日志级别来记录用户输入参数错误的情况，避免用户投诉时，无所适从。注意日志输出的级别，error级别只记录系统逻辑出错、</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/延迟任务调度系统（技术选型与设计）/" itemprop="url">延迟任务调度系统（技术选型与设计）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T12:12:57+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/延时队列/" itemprop="url" rel="index">
                    <span itemprop="name">延时队列</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/延时队列/消息队列/" itemprop="url" rel="index">
                    <span itemprop="name">消息队列</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/延时队列/消息队列/延时任务处理/" itemprop="url" rel="index">
                    <span itemprop="name">延时任务处理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="延迟任务调度系统（技术选型与设计）"><a href="#延迟任务调度系统（技术选型与设计）" class="headerlink" title="延迟任务调度系统（技术选型与设计）"></a>延迟任务调度系统（技术选型与设计）</h1><blockquote>
<p>原文地址：<a href="https://sq.163yun.com/blog/article/167374378538516480" target="_blank" rel="noopener">https://sq.163yun.com/blog/article/167374378538516480</a></p>
</blockquote>
<h2 id="延迟任务的场景是？"><a href="#延迟任务的场景是？" class="headerlink" title="延迟任务的场景是？"></a>延迟任务的场景是？</h2><ul>
<li>习题考试截止前3天，给未提交用户发送消息</li>
<li>学习项目开课前2小时，给参与用户发送通知</li>
<li>问卷开始收集时，才对用户可见</li>
<li>问卷结束收集时，触发一些操作</li>
<li>指定时间发布课件</li>
<li>课程结束时，开始计算用户结业信息</li>
<li>直播时间到了，给用户发送消息</li>
<li>用户下单后，30分钟内未付款，关闭订单</li>
<li>用户付款后，24小时内未发货，提示发货</li>
<li>用户打车后，48小时后自动评价为5星</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>这类业务的特点是：延迟执行</strong>。一种比较简单的方法是<strong>使用后台线程扫描符合条件的业务数据，逐一处理</strong>。 <strong>这种方法扫描间隔时间不好设置，间隔时间过大影响精确度，过小则影响效率和性能</strong>。</p>
<h2 id="现有的解决方案是？"><a href="#现有的解决方案是？" class="headerlink" title="现有的解决方案是？"></a>现有的解决方案是？</h2><ul>
<li>通过<code>linux</code>的<code>crontab</code>触发定时任务</li>
<li>扫描业务表，筛选出符合条件的数据对其进行操作</li>
</ul>
<h2 id="存在的问题是什么？"><a href="#存在的问题是什么？" class="headerlink" title="存在的问题是什么？"></a>存在的问题是什么？</h2><ul>
<li>由于每种类型的任务都设有扫描间隔，<strong>任务不能精确处理</strong></li>
<li><strong>扫描业务库，影响业务正常操作</strong></li>
<li><strong>任务的执行过于密集，容易导致服务器间隔性压力</strong></li>
<li><strong>存在系统单点，触发定时调度的服务挂了，所有任务都不会执行</strong></li>
<li><strong>系统不具容错能力，一旦错过了，任务就不会再被执行</strong></li>
<li><strong>没有统一的视图来查看任务的执行情况</strong></li>
<li><strong>没有告警来提示失败的任务</strong></li>
</ul>
<h2 id="希望达到的目标是？"><a href="#希望达到的目标是？" class="headerlink" title="希望达到的目标是？"></a>希望达到的目标是？</h2><ul>
<li><strong>精确性</strong>(可在指定时间触发任务处理)</li>
<li><strong>通用性</strong></li>
<li>高性能(集群能力不少于1000TPS)</li>
<li><strong>高可用(支持多实例部署)</strong></li>
<li>可伸缩(增加和减少服务时，任务会重新分配)</li>
<li><strong>可重试(任务失败可重试)</strong></li>
<li>多协议(支持http\dubbo调用)</li>
<li><strong>可管理(业务使用方可修改、删除任务)</strong></li>
<li>能告警(失败次数达到阈值可触发告警)</li>
<li><strong>统一视图(方便查看任务执行情况,可手动干预任务执行)</strong></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面所讨论<strong>技术方案的前提是精确触发</strong>，所以我们不讨论目前业界的一些分布式调度系统如：elastic-job,xxl-job,tbschedule等, 这些系统解决不了延迟任务精确触发问题。</p>
<h2 id="可以实现的方案有？"><a href="#可以实现的方案有？" class="headerlink" title="可以实现的方案有？"></a>可以实现的方案有？</h2><h3 id="RabbitMQ实现"><a href="#RabbitMQ实现" class="headerlink" title="RabbitMQ实现"></a>RabbitMQ实现</h3><h4 id="通过死信和死信路由实现"><a href="#通过死信和死信路由实现" class="headerlink" title="通过死信和死信路由实现"></a>通过死信和死信路由实现</h4><p><strong>原理如下:</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191149051b453ca2-dff0-428d-8a68-99289eb4bc58.png" alt="img"></p>
<blockquote>
<p><strong>Time To Live(TTL)</strong><br>       RabbitMQ可以针对Queue和Message设置 x-message-tt，来控制消息的生存时间，如果超时，则消息变为dead letter</p>
<p>​      RabbitMQ针对队列中的消息过期时间有两种方法可以设置。<br>A: 通过队列属性设置，队列中所有消息都有相同的过期时间。</p>
<p>B: 对消息进行单独设置，每条消息TTL可以不同。<br>      <strong>如果同时使用，则消息的过期时间以两者之间TTL较小的那个数值为准</strong>。消息在队列的生存时间一旦超过设置的TTL值，就成为dead letter</p>
<p><strong>Dead Letter Exchanges（DLX）</strong><br>    RabbitMQ的Queue可以配置x-dead-letter-exchange 和x-dead-letter-routing-key（可选）两个参数，如果队列内出现了dead letter，则按照这两个参数重新路由。</p>
<p>x-dead-letter-exchange：出现dead letter之后将dead letter重新发送到指定exchange<br>x-dead-letter-routing-key：指定routing-key发送</p>
<p>队列出现dead letter的情况有：<br>   消息或者队列的TTL过期<br>   队列达到最大长度<br>   消息被消费端拒绝（basic.reject or basic.nack）并且requeue=false</p>
<p>   <strong>利用DLX，当消息在一个队列中变成死信后，它能被重新publish到另一个Exchange。这时候消息就可以重新被消费</strong>。</p>
</blockquote>
<p><strong>何为死信:</strong></p>
<ul>
<li>消息被拒绝</li>
<li>消息已过期</li>
<li>队列达到最大长度</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RabbitMQ</code>可以对队列和消息设置<code>x-message-tt</code>、<code>expiration</code>来控制消息的存活时间，如果超时，消息变为死信。</p>
<p><strong>何为死信路由:</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RabbitMQ</code>可以对队列设置<code>x-dead-letter-exchange</code>和<code>x-dead-letter-routing-key</code>两个参数。当消息在一个队列中变成死信后会按这两个参数路由，消息就可以重新被消费。</p>
<p><strong>实例操作:</strong></p>
<ol>
<li>创建延迟队列(设置死信路由)</li>
<li>创建就绪队列</li>
<li>创建死信路由</li>
<li>绑定死信路由与就绪队列</li>
<li>发送延迟消息</li>
<li>消息过期后进入就绪队列</li>
</ol>
<p><strong>优点：</strong></p>
<ul>
<li>高效，可以利用<code>RabbitMQ</code>的分布式特性轻易进行横向扩展，且支持持久化</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>不支持对已发送的消息进行管理</strong></li>
<li><strong>一个消息比在同一队列中的其他消息提前过期，提前过期的消息也不会优先进入死信队列</strong>。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所以<strong>需要确保业务上每个任务的延迟时间是一致的</strong>。<strong>如果有不同延时的任务，需要为每种不同延迟的任务单独创建消息队列，缺乏灵活性</strong>。</p>
<h4 id="通过延迟消息插件来实现"><a href="#通过延迟消息插件来实现" class="headerlink" title="通过延迟消息插件来实现"></a>通过延迟消息插件来实现</h4><p><strong>原理如下：</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/20180619114926e95ae093-6fd9-453e-b3bc-4f92d8f013e5.png" alt="img"> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**核心代码流程：**</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/20180619114938052cc891-3d4d-4113-8fe0-695acfc2e82d.png)</span><br></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其原理是延迟消息会被保存到<code>Mnesia</code>表，在<code>Exchange</code>中根据每个<code>message</code>头设置的延迟时间<code>x-delay</code>，消息过期后才路由到对应队列。</p>
<p><strong>实例操作:</strong></p>
<ol>
<li><p>下载插件<br><a href="https://bintray.com/rabbitmq/community-plugins/download_file?file_path=rabbitmq_delayed_message_exchange-0.0.1.ez" target="_blank" rel="noopener">https://bintray.com/rabbitmq/community-plugins/download_file?file_path=rabbitmq_delayed_message_exchange-0.0.1.ez</a></p>
</li>
<li><p>安装插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker-compose.xml(将插件安装到容器中)</span><br><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    hostname: rabbitmq</span><br><span class="line">    image: rabbitmq:3.6.8-management</span><br><span class="line">    mem_limit: 200m</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5672:5672&quot;</span><br><span class="line">      - &quot;15672:15672&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ~/dockermapping/rabbitmq/lib:/var/lib/rabbitmq/</span><br><span class="line">      - /Users/oldlu/workspace/document/docker-compose/rabbitmq/rabbitmq_delayed_message_exchange-0.0.1.ez:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.8/plugins/rabbitmq_delayed_message_exchange-0.0.1.ez</span><br><span class="line">   </span><br><span class="line">启用插件</span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建类型为<code>x-delayed-message</code>的路由</p>
</li>
<li><p>创建就绪队列</p>
</li>
<li><p>绑定队列和路由</p>
</li>
<li><p>发布延迟消息(设置<code>x-delay</code>=延迟的毫秒数)</p>
</li>
</ol>
<p><strong>源码分析</strong><br><a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/blob/master/src/rabbit_delayed_message.erl" target="_blank" rel="noopener">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/blob/master/src/rabbit_delayed_message.erl</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">核心函数</span><br><span class="line">消息入队：internal_delay_message</span><br><span class="line">启动Timer：maybe_delay_first</span><br><span class="line">消息处理：handle_info</span><br></pre></td></tr></table></figure>
<p><strong>优点：</strong></p>
<ul>
<li>一个消息比其他消息提前过期，提前过期的消息会被提前路由到队列，<strong>不需要为不同延迟的消息创建单独的消息队列</strong>。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>不支持对已发送的消息进行管理</strong></li>
<li><strong>集群中只有一个数据副本(保存在当前节点下的<code>Mnesia</code>表中)，如果节点不可用或关闭插件会丢失消息</strong>。</li>
<li>目前该插件只支持<code>disk</code>节点，不支持<code>RAM</code>节点</li>
<li>性能比原生差一点(普通的<code>Exchange</code>收到消息后直接路由到队列，而延迟队列需要判断消息是否过期，未过期的需要保存在表中，时间到了再捞出来路由)</li>
</ul>
<h3 id="Redis实现"><a href="#Redis实现" class="headerlink" title="Redis实现"></a>Redis实现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有序集合(<code>Sorted Set</code>)是<code>Redis</code>提供的一种数据结构，具有<code>set</code>和hash的特点。其中每个元素都关联一个<code>score</code>，并以这个<code>score</code>来排序。其内部实现用到了两个数据结构:<code>hash table</code>和 <code>skip list</code>(跳跃表)</p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191150012c8a5c96-316e-4b4e-b912-a1e7bafa5b47.png" alt="img"> </p>
<p><strong>skip list的特点</strong></p>
<ul>
<li>由很多层结构组成，<code>level</code>是通过一定的概率随机产生的</li>
<li>每一层都是一个有序的链表，默认是升序</li>
<li>最底层的链表包含所有元素</li>
<li>如果一个元素出现在<code>Level i</code>的链表中，则它在<code>Level i</code>之下的链表也都会出现</li>
<li>每个节点包含两个指针，一个指向同一链表中的下一个元素，一个指向下面一层的元素</li>
<li>插入和删除的时间复杂度是<code>O(logn)</code>，当达到了一定的数据规模之后，它的效率与红黑树差不多</li>
</ul>
<p><strong>主要命令</strong></p>
<ul>
<li><code>zadd</code>:  向<code>Sorted Set</code>中添加元素</li>
<li><code>zrem</code>:  删除<code>Sorted Set</code>中的指定元素</li>
<li><code>zrange</code>:  按照从小到大的顺序返回指定区间内的元素</li>
</ul>
<p><strong>实现延迟队列</strong></p>
<ol>
<li>将延迟任务加到<code>Sorted Set</code>，将延迟时间设为<code>score</code></li>
<li><strong>启动一个线程不断判断Sorted Set中第一个元素的score是否大于当前时间</strong></li>
<li>如果大于，从<code>Sorted Set</code>中移除任务并添加到执行队列中</li>
<li>如果小于，进行短暂休眠后重试</li>
</ol>
<p><strong>实例操作</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@redis:/usr/local/bin# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; zadd delayqueue 1 task1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd delayqueue 2 task2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd delayqueue 4 task4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd delayqueue 3 task3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt;</span><br><span class="line">127.0.0.1:6379&gt; zrange delayqueue 0 0 withscores</span><br><span class="line">1) &quot;task1&quot;</span><br></pre></td></tr></table></figure>
<p><strong>优点：</strong></p>
<ul>
<li>实现简单</li>
<li><strong>任务可管理（可删除、修改任务）</strong></li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>需要有短轮询线程不断判断第一个元素是否过期，造成CPU空耗</strong>   =》 无法解决</li>
<li>分布式场景中，<strong>容易引起多个节点读取到相同任务</strong>  =》<strong>lua脚本加锁，保证同一时刻只有一个进程去取集合中的元素</strong></li>
</ul>
<h3 id="DelayQueue实现"><a href="#DelayQueue实现" class="headerlink" title="DelayQueue实现"></a>DelayQueue实现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>DelayQueue</code>是一个使用优先队列实现的<code>BlockingQueue</code>，优先队列比较的是时间，内部存储的是实现<code>Delayed</code>接口的对象。 只有在对象过期后才能从队列中获取对象。</p>
<p><strong>内部结构</strong></p>
<ul>
<li>可重入锁</li>
<li>用于根据<code>delay</code>时间排序的优先级队列</li>
<li>用于优化阻塞通知的线程<code>leader</code></li>
<li>用于实现阻塞和通知的<code>Condition</code>对象</li>
</ul>
<p><strong>Leader/Followers</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Leader/Followers</code>是多个工作线程轮流进行事件监听、分发、处理的一种模式。 该模式最大的优点在于，它是自己监听事件并处理客户请求，从接收到处理都是在同一线程中完成， 所以不需要在线程之间传递数据，解决线程频繁切换带来的开销。</p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191150242c3be524-44af-47e3-b28e-2fddbacc57a2.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该模式工作的任何时间点，只有一个线程成为<code>Leader</code> ，负责事件监听，而其他线程都是<code>Follower</code>，在休眠中等待成为<code>Leader</code>。 该模式的工作线程存在三种状态，工作线程同一时间只能处于一种状态，这三种状态为：</p>
<ul>
<li><code>Leading</code>: 线程处于领导者状态，负责事件监听。<code>Leader</code>监听到事件后，有两种处理方式:<ul>
<li>可以转移至<code>Processing</code>状态，自己处理该事件，并调用方法推选新领导者。</li>
<li>也可以指定其他<code>Follower</code>来处理事件，此时<code>Leader</code>状态不变。</li>
</ul>
</li>
<li><code>Processing</code>: 线程正在处理事件，处理完事件如果当前线程集中没有领导者，它将成为新领导者，否则转为追随者。</li>
<li><code>Following</code>: 线程处于追随者状态，等待成为新的领导者也可能被领导者指定来处理新的事件。</li>
</ul>
<p><strong>核心源码分析：</strong></p>
<ul>
<li><p>入队</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  lock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      q.offer(e);</span><br><span class="line">      <span class="keyword">if</span> (q.peek() == e) &#123;<span class="comment">//入队对象延迟时间是队列中最短的</span></span><br><span class="line">          leader = <span class="keyword">null</span>;<span class="comment">//重置leader</span></span><br><span class="line">          available.signal();<span class="comment">//唤醒一个线程去监听新加入的对象</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>出队</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">  lock.lockInterruptibly();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">          E first = q.peek();</span><br><span class="line">          <span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">              available.await();<span class="comment">//队列为空，无限等待</span></span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">long</span> delay = first.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">              <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)<span class="comment">//延迟时间已过，直接返回</span></span><br><span class="line">                  <span class="keyword">return</span> q.poll();</span><br><span class="line">              <span class="keyword">else</span> <span class="keyword">if</span> (leader != <span class="keyword">null</span>)<span class="comment">//已有leader在监听了，无限等待</span></span><br><span class="line">                  available.await();</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                  Thread thisThread = Thread.currentThread();</span><br><span class="line">                  leader = thisThread;<span class="comment">//当前线程成为leader</span></span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      available.awaitNanos(delay);<span class="comment">//在delay纳秒后唤醒</span></span><br><span class="line">                  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (leader == thisThread)<span class="comment">// 入队一个最小延迟时间的对象时leader会被清空</span></span><br><span class="line">                          leader = <span class="keyword">null</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; q.peek() != <span class="keyword">null</span>)<span class="comment">//leader不存在且队列不为空，唤醒一个follower去成为leader去监听</span></span><br><span class="line">          available.signal();</span><br><span class="line">      lock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li><strong>效率高，任务触发时间延迟低</strong></li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>数据是保存在内存，需要自己实现持久化</strong></li>
<li><strong>不具备分布式能力，需要自己实现高可用</strong></li>
</ul>
<h3 id="时间轮实现"><a href="#时间轮实现" class="headerlink" title="时间轮实现"></a>时间轮实现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>时间轮是一种环形的数据结构，分成多个格</strong>。<strong>每个格代表一段时间，时间越短，精度越高</strong>。<strong>每个格上用一个链表保存在该格的过期任务</strong>。<strong>指针随着时间一格一格转动，并执行相应格子中的到期任务</strong>。</p>
<p><strong>名词解释：</strong></p>
<ul>
<li><strong>时间格</strong>：环形结构中用于存放延迟任务的区块</li>
<li><strong>指针</strong>：指向当前操作的时间格，代表当前时间</li>
<li><strong>格数</strong>：时间轮中时间格的个数</li>
<li><strong>间隔</strong>：每个时间格之间的间隔，代表时间轮能达到的精度</li>
<li><strong>总间隔</strong>：当前时间轮总间隔，等于格数*间隔，代表时间轮能表达的时间范围</li>
</ul>
<h4 id="单表时间轮"><a href="#单表时间轮" class="headerlink" title="单表时间轮"></a>单表时间轮</h4><p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/20180619115045d49ed7cf-54e2-47e0-bde2-61ba30259daa.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上图为例，假设一个格子是1秒，则整个时间轮能表示的时间段为8s， 如果当前指针指向2，此时需要调度一个3s后执行的任务，需要放到第5个格子(2+3)中，指针再转3次就可以执行了。</p>
<p><strong>单表时间轮存在的问题是：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;格子的数量有限,所能代表的时间有限,当要存放一个10s后到期的任务怎么办？这会引起<strong>时间轮溢出</strong>。有个办法是<strong>把轮次信息也保存到时间格链表的任务上</strong>。</p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191150588df84d64-ffd2-4170-b5f8-bdefe5e56384.jpg" alt="img"> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;如果任务要在10s后执行，算出轮次10/8 round等1，格子10%8等于2，所以放入第二格。**检查过期任务时应当只执行round为0的任务，链表中其他任务的round减1**。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**带轮次单表时间轮存在的问题是：**</span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;**如果任务的时间跨度很大，数量很大，单层时间轮会造成任务的`round`很大，单个格子的链表很长，每次检查的量很大，会做很多无效的检查**。怎么办?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 分层时间轮</span><br><span class="line"></span><br><span class="line">![](延迟任务调度系统（技术选型与设计）/201806191151122ea9ea70-02be-4b55-966e-60ddb8b90afa.jpg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;**过期任务一定是在底层轮中被执行的，其他时间轮中的任务在接近过期时会不断的降级进入低一层的时间轮中**。</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;分层时间轮中每个轮都有自己的格数和间隔设置，**当最低层的时间轮转一轮时，高一层的时间轮就转一个格子**。</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;分层时间轮大大增加了可表示的时间范围，同时减少了空间占用。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**举个例子：**</span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;上图的分层时间轮可表达8 *8* 8=512s的时间范围，如果用单表时间轮可能需要512个格子， 而分层时间轮只要8+8+8=24个格子，**如果要设计一个时间范围是1天的分层时间轮，三个轮的格子分别用24、60、60即可**。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**工作原理：**</span><br><span class="line"></span><br><span class="line">时间轮指针转动有两种方式：</span><br><span class="line"></span><br><span class="line">- 根据自己的间隔转动（秒钟轮1秒转1格；分钟轮1分钟转1格；时钟轮1小时转1格）</span><br><span class="line">- 通过下层时间轮推动（秒钟轮转1圈，分钟轮转1格；分钟轮转1圈，时钟轮转1格）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">指针转到特定格子时有两种处理方式：</span><br><span class="line"></span><br><span class="line">- 如果是底层轮，指针指向格子中链表上的元素均表示过期</span><br><span class="line">- 如果是其他轮，将格子上的任务移动到精度细一级的时间轮上，比如时钟轮的任务移动到分钟轮上</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**举个例子：**</span><br><span class="line"></span><br><span class="line">- 添加1个5s后执行的任务</span><br><span class="line"></span><br><span class="line">  1. **算出任务应该放在秒钟轮的第5个格子**</span><br><span class="line">  2. **在秒钟轮指针进行5次转动后任务会被执行**</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- 添加一个50s后执行的任务</span><br><span class="line"></span><br><span class="line">  1. 算出该任务的延迟时间已经**溢出秒钟轮**</span><br><span class="line">  2. 50/8=6,所以该任务会被**保存在分钟轮的第6个格子**</span><br><span class="line">  3. 在**秒钟轮走了6圈(6*8s=48s)**之后，**分钟轮的指针指向第6个格子**</span><br><span class="line">  4. 此时**该格子中的任务会被降级到秒钟轮，并根据50%8=2，任务会被移动到秒钟轮的第2个格子**</span><br><span class="line">  5. **在秒钟轮指针又进行2次转动后(50s)任务会被执行**</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- 添加一个250s后执行的任务</span><br><span class="line"></span><br><span class="line">  1. 算出该任务的延迟时间已经溢出分钟轮</span><br><span class="line">  2. 250/8/8=3,所以该任务会被保存在时钟轮的第3个格子</span><br><span class="line">  3. 在分钟轮走了3圈(3*64s=192s)之后，时钟轮的指针指向第3个格子</span><br><span class="line">  4. 此时该格子中的任务会被降级到分钟轮，并根据(250-192)/8=7，任务会被移动到分钟轮的第7个格子</span><br><span class="line">  5. 在秒钟轮走了7圈(7*8s=56s)之后，分钟轮的指针指向第7个格子</span><br><span class="line">  6. 此时该格子中的任务会被降级到秒钟轮，并根据(250-192-56)=2，任务会被移动到秒钟轮的第2个格子</span><br><span class="line">  7. 在秒钟轮指针又进行2次转动后任务会被执行</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**优点：**</span><br><span class="line"></span><br><span class="line">- 高性能（插入任务、删除任务的时间复杂度均为O(1)，`DelayQueue`由于涉及到排序，插入和移除的复杂度是`O(logn)`）</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">**缺点：**</span><br><span class="line"></span><br><span class="line">- **数据是保存在内存，需要自己实现持久化**</span><br><span class="line">- **不具备分布式能力，需要自己实现高可用**</span><br><span class="line">- 延迟任务过期时间受时间轮总间隔限制</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;**对于超出范围的任务可放在一个缓冲区中(可用队列、`redis`或数据库实现)，等最高时间轮转到下一格子就从缓冲中取出符合范围的任务落到时间轮中**。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**比如：**</span><br><span class="line"></span><br><span class="line">添加一个600s后执行的任务A</span><br><span class="line"></span><br><span class="line">1. 算出该任务的延迟时间已经溢出时间轮</span><br><span class="line">2. 所以任务被保存到缓冲队列中</span><br><span class="line">3. 在时钟轮走了1格之后，会从缓冲队列中取满足范围的任务落到时间轮中</span><br><span class="line">4. 缓冲队列中的所有任务延迟时间均需减去64s，任务A减去64s后是536s，依然大于时间轮范围，所以不会被移出队列</span><br><span class="line">5. 在时钟轮又走了1格之后，任务A减去64s是536-64=472s，在时间轮范围内，会被落入时钟轮</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 之前的设计（DB/DelayQueue/ZooKeeper）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;**调度系统提供任务操作接口供业务系统提交任务、取消任务、反馈执行结果**等。针对`dubbo`调用,将任务抽象成`JobCallbackService`接口，由业务系统实现并注册成服务。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**整体架构**</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/20180619115131fc33ea6e-0220-4dcb-9dc7-c976bf60ff55.png)</span><br><span class="line"></span><br><span class="line">**注：这里的分片可以理解为job的一个集合（编号1……n），数据分片指的是编号为n的任务集合可以在那台机器上运行，job归属的集合不会发生变化，只是运行集合中的任务的机器会发生变化**</span><br><span class="line"></span><br><span class="line">&gt; 5台任务处理机器</span><br><span class="line">&gt;</span><br><span class="line">&gt; 集合1、2 =》机器1</span><br><span class="line">&gt;</span><br><span class="line">&gt; 集合3、4 =》机器2</span><br><span class="line">&gt;</span><br><span class="line">&gt; 集合5、6 =》机器3</span><br><span class="line">&gt;</span><br><span class="line">&gt; 集合7、8 =》机器4</span><br><span class="line">&gt;</span><br><span class="line">&gt; 集合9、10 =》机器5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**数据库：**</span><br><span class="line"></span><br><span class="line">- 负责保存所有的任务数据</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**内存队列：**</span><br><span class="line"></span><br><span class="line">- **实际为`DelayQueue`，延迟任务精确触发的机制由它保证**</span><br><span class="line">- **只存储未来N分钟内过期且最多1000个任务**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**`ZooKeeper`：**</span><br><span class="line"></span><br><span class="line">- 管理整个调度集群</span><br><span class="line">- 存储调度节点信息</span><br><span class="line">- 存储节点分片信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**主节点：**</span><br><span class="line"></span><br><span class="line">- **有新的节点上下线时对数据重新分片**</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">**调度节点：**</span><br><span class="line"></span><br><span class="line">- 提供`dubbo`、`http`接口供业务系统调用，用于提交任务、取消任务、反馈执行结果等</span><br><span class="line">- **从ZK注册中心获取当前节点的分片信息，再从数据库拉取即将过期的数据放到`DelayQueue`**</span><br><span class="line">- **调用业务系统注册的回调服务接口，发起调度请求**</span><br><span class="line">- **接收业务系统的反馈结果，更新执行结果，移除任务或发起重试**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**业务系统：**</span><br><span class="line"></span><br><span class="line">- **作为被调度的服务需要实现回调接口`JobCallbackService`**，并注册为dubbo服务提供者</span><br><span class="line">- **在需要延迟任务的场景调用调度系统接口操作任务**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**数据库设计**</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/20180619115147092011e0-d728-4022-9e7b-c5bdf2a65d48.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**表说明**</span><br><span class="line"></span><br><span class="line">- `job_callback_service`:   服务配置表，配置业务回调服务，包括服务协议、回调服务、重试次数</span><br><span class="line">- `job_delay_task`:   延迟任务表，用于存储延迟任务，包括任务分片号、回调服务、调用总次数、失败数、任务状态、回调参数等</span><br><span class="line">- `job_delay_task_execlog`:  延迟任务执行表，**记录调度系统发起的每一次回调**</span><br><span class="line">- `job_delay_task_backlog`: 延迟任务调度结果表，记录任务最终状态等信息，**因为一个失败任务可以重试，所以会存在多次调用，这里仅仅记录最终结果**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**主从切换**</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;**利用`ZooKeeper`临时序列节点特性，序号最小的节点为主节点，其他节点为从节点**。主节点监听集群状态，集群状态发生变化时重新分片。从节点监听序号比它小的兄弟节点，兄弟节点发生变化重新寻找和建立监听关系。</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/20180619115205c6d4c487-183e-4a61-8279-f73f2bb8c703.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**数据分片**</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/201806191152239d5a38d7-660e-4a2b-8232-9b0cdd220bab.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**任务状态**</span><br><span class="line"></span><br><span class="line">![img](延迟任务调度系统（技术选型与设计）/2018061911523364efa8c1-5389-4352-8e53-5e6e5145dbc8.png)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>delay</code>：延迟任务提交后的初始状态</li>
<li><code>ready</code>：过期时间已到，消息推入就绪队列的状态</li>
<li><code>running</code>：业务订阅消息，收到消息开始处理的状态</li>
<li><code>finished</code>：业务处理成功</li>
<li><code>failed</code>：业务处理失败</li>
</ul>
<p><strong>主要流程</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/2018061911524730429514-e606-4be6-bf0d-b8a8c5c47d91.png" alt="img"></p>
<p><strong>服务加载</strong></p>
<ol>
<li>从<code>DB</code>读取服务配置</li>
<li>根据配置动态构造<code>Consumer</code>对象并添加到<code>Spring</code>容器中</li>
</ol>
<p><strong>提交任务</strong></p>
<ol>
<li>业务系统通过<code>dubbo</code>或<code>http</code>接口提交任务</li>
<li><strong>判断任务过期时间是否在一个扫描周期内</strong></li>
<li>如果是，<ol>
<li>设置分片号(从当前节点所负责的分片随机获取)</li>
<li><strong>添加到内存队列</strong></li>
<li><strong>任务保存到<code>job_delay_task</code>表</strong></li>
</ol>
</li>
<li>如果否,<ol>
<li>设置分片号(根据分片总数和随机算法算出分片号)</li>
<li>任务保存到<code>delay_task</code>表</li>
</ol>
</li>
</ol>
<p><strong>定时器</strong></p>
<ol>
<li>由一个线程管理</li>
<li>根据配置的扫描间隔设置定时器的执行周期</li>
<li>根据当前时间和扫描间隔算出该时段的过期时间<code>X-Delay</code></li>
<li>从<code>DB</code>获取过期时间在<code>X-Delay</code>之前的所有任务，并放到<code>DelayQueue</code></li>
</ol>
<p><strong>调度任务</strong></p>
<ol>
<li>由一个线程池管理</li>
<li>所有线程都阻塞在<code>DelayQueue</code>的方法<code>take</code></li>
<li><code>take</code>到任务，从<code>DB</code>中获取任务，判断是否存在</li>
<li>如果不在，什么也不做(任务已执行成功或已被删除)</li>
<li>如果存在，判断调用次数是否超过设置</li>
<li>如果不超<ol>
<li>调用业务回调服务<ol>
<li>从任务中取出调用的服务配置</li>
<li>从容器中获取对应的<code>Consumer</code>对象</li>
<li>异步调用业务回调服务</li>
</ol>
</li>
<li>设置下次重试时间，记录调用日志<code>job_delay_task_execlog</code></li>
</ol>
</li>
<li>如果超过，将任务转移到<code>job_delay_task_backlog</code></li>
</ol>
<p><strong>任务反馈</strong></p>
<ol>
<li>更新任务调用结果</li>
</ol>
<p><strong>优点</strong></p>
<ul>
<li>功能全面，高可用、易伸缩、可重试</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>略微复杂<ul>
<li>需要将服务配置动态生成为<code>Consumer</code>对象</li>
<li>增加新的服务需要通知所有调度节点刷新</li>
<li>存在一定的耦合性(直接调用业务服务，协议耦合)，如果接入系统是<code>thrift</code>协议呢？</li>
</ul>
</li>
<li>需要处理任务的重试</li>
<li><strong>调度系统直接回调业务服务，如果业务服务不可用可能会造成盲目重试，不能很好的控制流量(调度系统不知道业务服务的处理能力)</strong></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果<strong>引入MQ，使用MQ来解耦服务调用的协议，保证任务的重试，并由消费方根据自己的处理能力控制流量</strong>会不会更好呢？</p>
<h3 id="另一种方案（DB-DelayQueue-ZooKeeper-MQ）"><a href="#另一种方案（DB-DelayQueue-ZooKeeper-MQ）" class="headerlink" title="另一种方案（DB/DelayQueue/ZooKeeper/MQ）"></a>另一种方案（DB/DelayQueue/ZooKeeper/MQ）</h3><p><strong>整体架构</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191153073c0ef18b-7054-4deb-9135-c8d92da26cc2.png" alt="img"></p>
<p><strong>数据库设计</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/201806191153246fb613b8-9b78-4ef0-aa15-56dc80099dce.png" alt="img"></p>
<p><strong>主要流程</strong></p>
<p><img src="//blog.com/2019/04/30/延迟任务调度系统（技术选型与设计）/20180619115341e53da381-2e0a-49cd-803d-00fcd0112eaf.png" alt="img"></p>
<p><strong>调度任务</strong></p>
<ol>
<li>由一个线程池管理</li>
<li>所有线程都阻塞在<code>DelayQueue</code>的<code>take</code>方法</li>
<li><code>take</code>到任务，从<code>DB</code>中获取任务，判断是否存在</li>
<li>如果不在，什么也不做(任务已执行成功或已被删除)</li>
<li>如果存在，将任务转移到<code>job_delay_task_execlog</code>；往消息队列投递消息</li>
</ol>
<p><strong>缺点</strong></p>
<p>需要业务系统依赖于<code>MQ</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/30/访问者模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/访问者模式/" itemprop="url">访问者模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T12:12:57+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/访问者模式/" itemprop="url" rel="index">
                    <span itemprop="name">访问者模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>访问者</strong>模式是一种<strong>行为设计</strong>模式。访问者模式被用在针对一组<strong>相同类型对象</strong>的操作。优点是，可以<strong>把针对此对象的操作逻辑转移到另外一个类上</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>访问者模式就是表示一个作用于某对象结构中的各元素的操作。它使你可以在不改变各元素的类的前提下定义作用于这些元素的新操作</strong>。</p>
<h2 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例如，思考一下添加不同类型商品的购物车，当点击结算的时候，它计算出所有不同商品需付的费用。现在，计算逻辑即为计算这些不同类型商品的价格。或者说通过<strong>访问者模式</strong>我们把此逻辑转移到了另外一个类上面。让我们实现这个访问者模式的例子。</p>
<h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="//blog.com/2019/04/30/访问者模式/visitor-pattern.png" alt=""></p>
<p>(1) 创建能够被添加到购物车中代表不同类型商品(itemElement)的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) 不同商品的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">	<span class="keyword">private</span> String isbnNumber;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(<span class="keyword">int</span> cost, String isbn)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.price=cost;</span><br><span class="line">		<span class="keyword">this</span>.isbnNumber=isbn;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getIsbnNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isbnNumber;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Fruit</span> <span class="keyword">implements</span> <span class="title">ItemElement</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> pricePerKg;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Fruit</span><span class="params">(<span class="keyword">int</span> priceKg, <span class="keyword">int</span> wt, String nm)</span></span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.pricePerKg=priceKg;</span><br><span class="line">		<span class="keyword">this</span>.weight=wt;</span><br><span class="line">		<span class="keyword">this</span>.name = nm;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPricePerKg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> pricePerKg;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getWeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> weight;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">accept</span><span class="params">(ShoppingCartVisitor visitor)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，<em>accept()</em>方法的实现是在实体类中，它调用访问者的<em>visit()</em>方法传递当前类对象作为自己的参数。</p>
<p>(3) 访问者接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ShoppingCartVisitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">visit</span><span class="params">(Book book)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">visit</span><span class="params">(Fruit fruit)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(4) 访问者实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShoppingCartVisitorImpl</span> <span class="keyword">implements</span> <span class="title">ShoppingCartVisitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">visit</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cost=<span class="number">0</span>;</span><br><span class="line">		<span class="comment">//apply 5$ discount if book price is greater than 50</span></span><br><span class="line">		<span class="keyword">if</span>(book.getPrice() &gt; <span class="number">50</span>)&#123;</span><br><span class="line">			cost = book.getPrice()-<span class="number">5</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span> cost = book.getPrice();</span><br><span class="line">		System.out.println(<span class="string">"Book ISBN::"</span>+book.getIsbnNumber() + <span class="string">" cost ="</span>+cost);</span><br><span class="line">		<span class="keyword">return</span> cost;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">visit</span><span class="params">(Fruit fruit)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> cost = fruit.getPricePerKg()*fruit.getWeight();</span><br><span class="line">		System.out.println(fruit.getName() + <span class="string">" cost = "</span>+cost);</span><br><span class="line">		<span class="keyword">return</span> cost;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(5) 使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.journaldev.design.visitor;</span><br><span class="line"></span><br><span class="line">public class ShoppingCartClient &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		ItemElement[] items = new ItemElement[]&#123;new Book(20, &quot;1234&quot;),new Book(100, &quot;5678&quot;),</span><br><span class="line">				new Fruit(10, 2, &quot;Banana&quot;), new Fruit(5, 5, &quot;Apple&quot;)&#125;;</span><br><span class="line"></span><br><span class="line">		int total = calculatePrice(items);</span><br><span class="line">		System.out.println(&quot;Total Cost = &quot;+total);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static int calculatePrice(ItemElement[] items) &#123;</span><br><span class="line">		ShoppingCartVisitor visitor = new ShoppingCartVisitorImpl();</span><br><span class="line">		int sum=0;</span><br><span class="line">		for(ItemElement item : items)&#123;</span><br><span class="line">			sum = sum + item.accept(visitor);</span><br><span class="line">		&#125;</span><br><span class="line">		return sum;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当运行上述程序是，我们得到如下输出：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; Book ISBN::1234 cost =20</span><br><span class="line">&gt; Book ISBN::5678 cost =95</span><br><span class="line">&gt; Banana cost = 20</span><br><span class="line">&gt; Apple cost = 25</span><br><span class="line">&gt; Total Cost = 160</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h2><blockquote>
<p>我们去银行柜台办业务，一般情况下会开几个个人业务柜台的，你去其中任何一个柜台办理都是可以的。我们的访问者模式可以很好付诸在这个场景中：对于银行柜台来说，他们是不用变化的，就是说今天和明天提供个人业务的柜台是不需要有变化的。而我们作为访问者，今天来银行可能是取消费流水，明天来银行可能是去办理手机银行业务，这些是我们访问者的操作，一直是在变化的</p>
</blockquote>
<h3 id="UML类图-1"><a href="#UML类图-1" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="//blog.com/2019/04/30/访问者模式/Visitor-Design-Pattern-Uml.png" alt=""></p>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a><strong>示例代码</strong></h3><h4 id="RoleVisitorInterface-php"><a href="#RoleVisitorInterface-php" class="headerlink" title="RoleVisitorInterface.php"></a><strong>RoleVisitorInterface.php</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace DesignPatterns\Behavioral\Visitor;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 访问者接口</span><br><span class="line"> */</span><br><span class="line">interface RoleVisitorInterface</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 访问 User 对象</span><br><span class="line">     *</span><br><span class="line">     * @param \DesignPatterns\Behavioral\Visitor\User $role</span><br><span class="line">     */</span><br><span class="line">    public function visitUser(User $role);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 访问 Group 对象</span><br><span class="line">     *</span><br><span class="line">     * @param \DesignPatterns\Behavioral\Visitor\Group $role</span><br><span class="line">     */</span><br><span class="line">    public function visitGroup(Group $role);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RolePrintVisitor-php"><a href="#RolePrintVisitor-php" class="headerlink" title="RolePrintVisitor.php"></a><strong>RolePrintVisitor.php</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Visitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Visitor接口的具体实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RolePrintVisitor</span> <span class="keyword">implements</span> <span class="title">RoleVisitorInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitGroup</span><span class="params">(Group $role)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Role: "</span> . $role-&gt;getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitUser</span><span class="params">(User $role)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Role: "</span> . $role-&gt;getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Role-php"><a href="#Role-php" class="headerlink" title="Role.php"></a><strong>Role.php</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Visitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Role 类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该方法基于Visitor的类名判断调用Visitor的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 如果必须调用其它方法，重写本方法即可</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \DesignPatterns\Behavioral\Visitor\RoleVisitorInterface $visitor</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \InvalidArgumentException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(RoleVisitorInterface $visitor)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $klass = get_called_class();</span><br><span class="line">        preg_match(<span class="string">'#([^\\\\]+)$#'</span>, $klass, $extract);</span><br><span class="line">        $visitingMethod = <span class="string">'visit'</span> . $extract[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!method_exists(<span class="keyword">__NAMESPACE__</span> . <span class="string">'\RoleVisitorInterface'</span>, $visitingMethod)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \InvalidArgumentException(<span class="string">"The visitor you provide cannot visit a $klass instance"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        call_user_func(<span class="keyword">array</span>($visitor, $visitingMethod), <span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="User-php"><a href="#User-php" class="headerlink" title="User.php"></a><strong>User.php</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Visitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Role</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = (string) $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User "</span> . <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Group-php"><a href="#Group-php" class="headerlink" title="Group.php"></a><strong>Group.php</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Visitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Group</span> <span class="keyword">extends</span> <span class="title">Role</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = (string) $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Group: "</span> . <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><strong>测试代码</strong></h3><h4 id="Tests-VisitorTest-php"><a href="#Tests-VisitorTest-php" class="headerlink" title="Tests/VisitorTest.php"></a><strong>Tests/VisitorTest.php</strong></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Tests</span>\<span class="title">Visitor</span>\<span class="title">Tests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Visitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VisitorTest 用于测试访问者模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitorTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $visitor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setUp</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;visitor = <span class="keyword">new</span> Visitor\RolePrintVisitor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRole</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">            <span class="keyword">array</span>(<span class="keyword">new</span> Visitor\User(<span class="string">"Dominik"</span>), <span class="string">'Role: User Dominik'</span>),</span><br><span class="line">            <span class="keyword">array</span>(<span class="keyword">new</span> Visitor\Group(<span class="string">"Administrators"</span>), <span class="string">'Role: Group: Administrators'</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dataProvider</span> getRole</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testVisitSomeRole</span><span class="params">(Visitor\Role $role, $expect)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expectOutputString($expect);</span><br><span class="line">        $role-&gt;accept(<span class="keyword">$this</span>-&gt;visitor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedException</span> \InvalidArgumentException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@expectedExceptionMessage</span> Mock</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUnknownObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $mock = <span class="keyword">$this</span>-&gt;getMockForAbstractClass(<span class="string">'DesignPatterns\Behavioral\Visitor\Role'</span>);</span><br><span class="line">        $mock-&gt;accept(<span class="keyword">$this</span>-&gt;visitor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此模式的优点就是，如果操作的逻辑改变，我们只需要改变访问者的实现就够了，而不用去修改其他所有的商品类。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另一个好处是，添加新类别的商品到系统变得容易。只需要改变一下访问者接口以及其实现。已经存在的商品类别不会被干扰影响。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，访问者模式的缺点也需要知道，<strong>visit()方法的参数类型在设计系统式就需要明确。不然，就需要修改访问者的接口以及所有接口实现</strong>。另外如果访问者接口的实现太多，系统的扩展性就会下降。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>访问者模式适用于数据结构相对稳定的系统</strong>，它把数据结构和作用于结构之上的操作之间的耦合解脱开，使得操作集合可以相对自由的演化。在本例中，User、Group 是数据结构，而 RolePrintVisitor 是访问者（用于结构之上的操作）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当实现访问者模式时，要将尽可能多的将对象浏览逻辑放在 Visitor 类中，而不是放在它的子类中，这样的话，ConcreteVisitor 类所访问的对象结构依赖较少，从而使维护较为容易</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/30/规格模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/规格模式/" itemprop="url">规格模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T12:12:57+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/规格模式/" itemprop="url" rel="index">
                    <span itemprop="name">规格模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="规格模式"><a href="#规格模式" class="headerlink" title="规格模式"></a>规格模式</h1><h2 id="1、模式定义"><a href="#1、模式定义" class="headerlink" title="1、模式定义"></a><strong>1、模式定义</strong></h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规格模式（Specification）可以认为是组合模式的一种扩展。有时项目中某些条件决定了业务逻辑，这些条件就可以抽离出来以某种关系（与、或、非）进行组合，从而灵活地对业务逻辑进行定制。另外，在查询、过滤等应用场合中，<strong>通过预定义多个条件，然后使用这些条件的组合来处理查询或过滤，而不是使用逻辑判断语句来处理，可以简化整个实现逻辑</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里的每个条件就是一个规格，多个规格/条件通过串联的方式以某种逻辑关系形成一个组合式的规格。</p>
<h2 id="2、UML类图"><a href="#2、UML类图" class="headerlink" title="2、UML类图"></a><strong>2、UML类图</strong></h2><p><img src="//blog.com/2019/04/30/规格模式/Specification-Design-Pattern-Uml.png" alt="Specification-Design-Pattern-Uml"></p>
<h2 id="3、示例代码"><a href="#3、示例代码" class="headerlink" title="3、示例代码"></a><strong>3、示例代码</strong></h2><h3 id="Item-php"><a href="#Item-php" class="headerlink" title="Item.php"></a><strong>Item.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * An item must have a price</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $price</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($price)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;price = $price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the items price</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrice</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SpecificationInterface-php"><a href="#SpecificationInterface-php" class="headerlink" title="SpecificationInterface.php"></a><strong>SpecificationInterface.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规格接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SpecificationInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断对象是否满足规格</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个逻辑与规格（AND）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $spec</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">plus</span><span class="params">(SpecificationInterface $spec)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个逻辑或规格（OR）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $spec</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">either</span><span class="params">(SpecificationInterface $spec)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个逻辑非规格（NOT）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">not</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractSpecification-php"><a href="#AbstractSpecification-php" class="headerlink" title="AbstractSpecification.php"></a><strong>AbstractSpecification.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规格抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSpecification</span> <span class="keyword">implements</span> <span class="title">SpecificationInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查给定Item是否满足所有规则</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个新的逻辑与规格（AND）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $spec</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SpecificationInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">plus</span><span class="params">(SpecificationInterface $spec)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Plus(<span class="keyword">$this</span>, $spec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个新的逻辑或组合规格（OR）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $spec</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SpecificationInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">either</span><span class="params">(SpecificationInterface $spec)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Either(<span class="keyword">$this</span>, $spec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个新的逻辑非规格（NOT）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SpecificationInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">not</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Not(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Plus-php"><a href="#Plus-php" class="headerlink" title="Plus.php"></a><strong>Plus.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逻辑与规格（AND）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plus</span> <span class="keyword">extends</span> <span class="title">AbstractSpecification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $left;</span><br><span class="line">    <span class="keyword">protected</span> $right;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在构造函数中传入两种规格</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $left</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $right</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface $left, SpecificationInterface $right)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;left = $left;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;right = $right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回两种规格的逻辑与评估</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;left-&gt;isSatisfiedBy($item) &amp;&amp; <span class="keyword">$this</span>-&gt;right-&gt;isSatisfiedBy($item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Either-php"><a href="#Either-php" class="headerlink" title="Either.php"></a><strong>Either.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逻辑或规格</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Either</span> <span class="keyword">extends</span> <span class="title">AbstractSpecification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $left;</span><br><span class="line">    <span class="keyword">protected</span> $right;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 两种规格的组合</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $left</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $right</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface $left, SpecificationInterface $right)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;left = $left;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;right = $right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回两种规格的逻辑或评估</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;left-&gt;isSatisfiedBy($item) || <span class="keyword">$this</span>-&gt;right-&gt;isSatisfiedBy($item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Not-php"><a href="#Not-php" class="headerlink" title="Not.php"></a><strong>Not.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逻辑非规格</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Not</span> <span class="keyword">extends</span> <span class="title">AbstractSpecification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $spec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在构造函数中传入指定规格</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> SpecificationInterface $spec</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SpecificationInterface $spec)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;spec = $spec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回规格的相反结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">$this</span>-&gt;spec-&gt;isSatisfiedBy($item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PriceSpecification-php"><a href="#PriceSpecification-php" class="headerlink" title="PriceSpecification.php"></a><strong>PriceSpecification.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断给定Item的价格是否介于最小值和最大值之间的规格</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PriceSpecification</span> <span class="keyword">extends</span> <span class="title">AbstractSpecification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $maxPrice;</span><br><span class="line">    <span class="keyword">protected</span> $minPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置最大值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $maxPrice</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setMaxPrice</span><span class="params">($maxPrice)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;maxPrice = $maxPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置最小值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $minPrice</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setMinPrice</span><span class="params">($minPrice)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;minPrice = $minPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断给定Item的定价是否在最小值和最大值之间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Item $item</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(Item $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;maxPrice) &amp;&amp; $item-&gt;getPrice() &gt; <span class="keyword">$this</span>-&gt;maxPrice) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;minPrice) &amp;&amp; $item-&gt;getPrice() &lt; <span class="keyword">$this</span>-&gt;minPrice) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4、测试代码"><a href="#4、测试代码" class="headerlink" title="4、测试代码"></a><strong>4、测试代码</strong></h2><h3 id="Tests-SpecificationTest-php"><a href="#Tests-SpecificationTest-php" class="headerlink" title="Tests/SpecificationTest.php"></a><strong>Tests/SpecificationTest.php</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">Tests</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">PriceSpecification</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DesignPatterns</span>\<span class="title">Behavioral</span>\<span class="title">Specification</span>\<span class="title">Item</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpecificationTest 用于测试规格模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpecificationTest</span> <span class="keyword">extends</span> \<span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testSimpleSpecification</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $item = <span class="keyword">new</span> Item(<span class="number">100</span>);</span><br><span class="line">        $spec = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($spec-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMaxPrice(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($spec-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($spec-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMinPrice(<span class="number">101</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($spec-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMinPrice(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($spec-&gt;isSatisfiedBy($item));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testNotSpecification</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $item = <span class="keyword">new</span> Item(<span class="number">100</span>);</span><br><span class="line">        $spec = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line">        $not = $spec-&gt;not();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($not-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMaxPrice(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($not-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($not-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMinPrice(<span class="number">101</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($not-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec-&gt;setMinPrice(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($not-&gt;isSatisfiedBy($item));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPlusSpecification</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $spec1 = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line">        $spec2 = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line">        $plus = $spec1-&gt;plus($spec2);</span><br><span class="line"></span><br><span class="line">        $item = <span class="keyword">new</span> Item(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($plus-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        $spec2-&gt;setMinPrice(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($plus-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        $spec2-&gt;setMinPrice(<span class="number">101</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($plus-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">99</span>);</span><br><span class="line">        $spec2-&gt;setMinPrice(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($plus-&gt;isSatisfiedBy($item));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testEitherSpecification</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $spec1 = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line">        $spec2 = <span class="keyword">new</span> PriceSpecification();</span><br><span class="line">        $either = $spec1-&gt;either($spec2);</span><br><span class="line"></span><br><span class="line">        $item = <span class="keyword">new</span> Item(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($either-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        $spec2-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($either-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        $spec2-&gt;setMaxPrice(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($either-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">0</span>);</span><br><span class="line">        $spec2-&gt;setMaxPrice(<span class="number">150</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertTrue($either-&gt;isSatisfiedBy($item));</span><br><span class="line"></span><br><span class="line">        $spec1-&gt;setMaxPrice(<span class="number">99</span>);</span><br><span class="line">        $spec2-&gt;setMaxPrice(<span class="number">99</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertFalse($either-&gt;isSatisfiedBy($item));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/30/装饰器模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/装饰器模式/" itemprop="url">装饰器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T12:12:57+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/装饰器模式/" itemprop="url" rel="index">
                    <span itemprop="name">装饰器模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="装饰器模式"><a href="#装饰器模式" class="headerlink" title="装饰器模式"></a>装饰器模式</h1><h2 id="1-认识装饰器模式"><a href="#1-认识装饰器模式" class="headerlink" title="1.认识装饰器模式"></a>1.认识装饰器模式</h2><p>​    <strong>装饰模式能够实现动态的为对象添加功能，是从一个对象外部来给对象添加功能</strong>。通常给对象添加功能，要么直接修改对象添加相应的功能，要么派生对应的子类来扩展，抑或是使用对象组合的方式。显然，直接修改对应的类这种方式并不可取。在面向对象的设计中，而我们也应该尽量使用对象组合，而不是对象继承来扩展和复用功能。<strong>装饰器模式就是基于对象组合的方式，可以很灵活的给对象添加所需要的功能。装饰器模式的本质就是动态组合。动态是手段，组合才是目的</strong>。总之，<strong>装饰模式是通过把复杂的功能简单化，分散化，然后再运行期间，根据需要来动态组合的这样一个模式</strong>。</p>
<h2 id="2-模式结构和说明"><a href="#2-模式结构和说明" class="headerlink" title="2.模式结构和说明"></a>2.模式结构和说明</h2><p>​    装饰模式的结构如下图所示。</p>
<p>​         <img src="//blog.com/2019/04/30/装饰器模式/1345385564_5334.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Component：组件对象的接口，可以给这些对象动态的添加职责；</span><br><span class="line"></span><br><span class="line">ConcreteComponent：具体的组件对象，实现了组件接口。该对象通常就是被装饰器装饰的原始对象，可以给这个对象添加职责；</span><br><span class="line"></span><br><span class="line">Decorator：所有装饰器的父类，需要定义一个与组件接口一致的接口(主要是为了实现装饰器功能的复用，即具体的装饰器A可以装饰另外一个具体的装饰器B，因为装饰器类也是一个Component)，并持有一个Component对象，该对象其实就是被装饰的对象。如果不继承组件接口类，则只能为某个组件添加单一的功能，即装饰器对象不能在装饰其他的装饰器对象。</span><br><span class="line"></span><br><span class="line">ConcreteDecorator：具体的装饰器类，实现具体要向被装饰对象添加的功能。用来装饰具体的组件对象或者另外一个具体的装饰器对象。</span><br></pre></td></tr></table></figure>
<p>​    </p>
<h2 id="3-装饰器示例"><a href="#3-装饰器示例" class="headerlink" title="3.装饰器示例"></a>3.装饰器示例</h2><p>装饰器模式的示例代码如下(Java语言描述)：</p>
<p>(1)组件对象的接口，可以给这些对象动态的添加职责</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2)具体实现组件对象接口的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteComponent</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//相应的功能处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3)装饰器接口，维持一个指向组件对象的接口对象， 并定义一个与组件接口一致的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">    - 持有组件对象</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> Component component;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造方法，传入组件对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> component 组件对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.component = component;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//转发请求给组件对象，可以在转发前后执行一些附加动作</span></span><br><span class="line">        component.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    (4)装饰器的具体实现对象，向组件对象添加职责，operationFirst()，operationLast()为前后需要添加的功能。具体的装饰器类ConcreteDecoratorB代码相似，不在给出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteDecoratorA</span> <span class="keyword">extends</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">ConcreteDecoratorA</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(component);</span><br><span class="line">   &#125;</span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">operationFirst</span><span class="params">()</span></span>&#123; &#125; <span class="comment">//在调用父类的operation方法之前需要执行的操作</span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">operationLast</span><span class="params">()</span></span>&#123; &#125; <span class="comment">//在调用父类的operation方法之后需要执行的操作</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">//调用父类的方法，可以在调用前后执行一些附加动作</span></span><br><span class="line">           operationFirst(); <span class="comment">//添加的功能</span></span><br><span class="line">           <span class="keyword">super</span>.operation();  <span class="comment">//这里可以选择性的调用父类的方法，如果不调用则相当于完全改写了方法，实现了新的功能</span></span><br><span class="line">           operationLast(); <span class="comment">//添加的功能</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    (5) 客户端使用装饰器的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    Component c1 = <span class="keyword">new</span> ConcreteComponent (); <span class="comment">//首先创建需要被装饰的原始对象(即要被装饰的对象)</span></span><br><span class="line">    Decorator decoratorA = <span class="keyword">new</span> ConcreteDecoratorA(c1); <span class="comment">//给对象透明的增加功能A并调用</span></span><br><span class="line">    decoratorA .operation();</span><br><span class="line">    Decorator decoratorB = <span class="keyword">new</span> ConcreteDecoratorB(c1); <span class="comment">//给对象透明的增加功能B并调用</span></span><br><span class="line">    decoratorB .operation();</span><br><span class="line">    Decorator decoratorBandA = <span class="keyword">new</span> ConcreteDecoratorB(decoratorA);<span class="comment">//装饰器也可以装饰具体的装饰对象，此时相当于给对象在增加A的功能基础上在添加功能B</span></span><br><span class="line">    decoratorBandA.operation();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-jdk应用"><a href="#4-jdk应用" class="headerlink" title="4.jdk应用"></a>4.jdk应用</h2><p>​    Java中的IO是明显的装饰器模式的运用。FilterInputStream，FilterOutputStream，FilterRead，FilterWriter分别为具体装饰器的父类，相当于Decorator类，它们分别实现了InputStream，OutputStream，Reader，Writer类(这些类相当于Component，是其他组件类的父类，也是Decorator类的父类)。继承自InputStream，OutputStream，Reader，Writer这四个类的其他类是具体的组件类，每个都有相应的功能，相当于ConcreteComponent类。而继承自FilterInputStream，FilterOutputStream，FilterRead，FilterWriter这四个类的其他类就是具体的装饰器对象类，即ConcreteDecorator类。通过这些装饰器类，可以给我们提供更加具体的有用的功能。如FileInputStream是InputStream的一个子类，从文件中读取数据流，BufferedInputStream是继承自FilterInputStream的具体的装饰器类，该类提供一个内存的缓冲区类保存输入流中的数据。我们使用如下的代码来使用BufferedInputStream装饰FileInputStream，就可以提供一个内存缓冲区来保存从文件中读取的输入流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedInputStream bis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file)); <span class="comment">//其中file为某个具体文件的File或者FileDescription对象</span></span><br></pre></td></tr></table></figure>
<h2 id="5-应用场景"><a href="#5-应用场景" class="headerlink" title="5.应用场景"></a>5.应用场景</h2><p>在以下两种情况下可以考虑使用装饰器模式：</p>
<p>(1)需要在不影响其他对象的情况下，以动态、透明的方式给对象添加职责。</p>
<p>(2)如果不适合使用子类来进行扩展的时候，可以考虑使用装饰器模式。</p>
<h2 id="具体例子"><a href="#具体例子" class="headerlink" title="具体例子"></a>具体例子</h2><p>以销售咖啡为例，为咖啡店设计实现饮料售价的类结构，假设存在： 咖啡种类：美式咖啡(American coffee)、英式咖啡(English coffee)、拿铁(Latte),售价分别为每杯15，16，17元。 配料种类：蒸奶(Milk)、豆浆(Soy)、摩卡(Mocha),售价为每份3，1，2元。</p>
<h3 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h3><p><img src="https://user-gold-cdn.xitu.io/2018/12/8/1678e0b14af45047?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p><strong>Beverage(对应抽象组件Component)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface Beverage &#123;</span><br><span class="line">	float cost();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Coffee(对应具体组件Concrete component)：</strong></p>
<p>美式咖啡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class AmericanCoffee implements Beverage&#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return 15;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>英式咖啡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class EnglishCoffee implements Beverage&#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return 16;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿铁：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class Latte implements Beverage&#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return 17;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调料(对应抽象装饰者Decorator)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Decorator implements Beverage&#123;</span><br><span class="line">	</span><br><span class="line">	Beverage beverage;</span><br><span class="line">	public Decorator(Beverage beverage) &#123;</span><br><span class="line">		this.beverage = beverage;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>具体调料(对应具体装饰者Concrete Decorator)：</strong></p>
<p>蒸奶：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Milk extends Decorator&#123;</span><br><span class="line"></span><br><span class="line">	public Milk(Beverage beverage) &#123;</span><br><span class="line">		super(beverage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return beverage.cost() + 3;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>豆浆：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Soy extends Decorator&#123;</span><br><span class="line"></span><br><span class="line">	public Soy(Beverage beverage) &#123;</span><br><span class="line">		super(beverage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return beverage.cost() + 1;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>摩卡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Mocha extends Decorator&#123;</span><br><span class="line"></span><br><span class="line">	public Mocha(Beverage beverage) &#123;</span><br><span class="line">		super(beverage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public float cost() &#123;</span><br><span class="line">		return beverage.cost() + 2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="客户端调用"><a href="#客户端调用" class="headerlink" title="客户端调用"></a>客户端调用</h3><p>点一杯美式咖啡加蒸奶、豆浆 ， 以及一杯英式咖啡加蒸奶、双份摩卡，各自计算总价：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//计算美式咖啡加蒸奶、豆浆的总价</span><br><span class="line">Beverage americanCoffee = new AmericanCoffee();</span><br><span class="line">float cost = new Soy(new Milk(americanCoffee)).cost();</span><br><span class="line">System.out.println(cost + &quot;&quot;);</span><br><span class="line"></span><br><span class="line">//计算美式咖啡加蒸奶、双份摩卡的总价</span><br><span class="line">Beverage englishCoffee = new EnglishCoffee();</span><br><span class="line">cost = new Mocha(new Mocha(new Milk(englishCoffee))).cost();</span><br><span class="line">System.out.println(cost + &quot;&quot;);</span><br></pre></td></tr></table></figure>
<h2 id="假设不使用装饰者模式"><a href="#假设不使用装饰者模式" class="headerlink" title="假设不使用装饰者模式"></a>假设不使用装饰者模式</h2><p>不使用装饰者模式，而是都统一采用继承的方式来解决的话，会导致类数量上呈现爆炸式增加，如下uml图所示(只列出部分)，并且这还是未考虑全部添加混合调料或者多份重复调料的情况下的一种类图结构，数量明显多于上面的装饰者模式。 一旦新增加一种coffee或者新增加一种具体调料、或者修改价钱，则维护是致命的，涉及到要修改或者新增太多的类。</p>
<p><img src="//blog.com/2019/04/30/装饰器模式/1678e0b14af45047.png" alt="img"></p>
<p>假设使用如下解决方法:</p>
<p><img src="//blog.com/2019/04/30/装饰器模式/1678e0be5eaea964.png" alt="img"></p>
<p>这种方案一旦增加一种新的调理，可能会导致所有的子类cost都需要跟着修改。并且单设增加一种产品比如”tea”是不允许添加mocha调料的，这种方案就无法避免，会引入不必要的信息。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>一种动态扩展的方式，比继承更加具有灵活性。</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li>比继承更灵活，动态、灵活的向对象添加删除职责，相比之下继承要求使用前静态创建类对象，类数量暴涨、复杂度增大</li>
<li>同一特性支持复用，比如用同一装饰者多次装饰(例如用”边框”装饰者装饰2次就可以达到”双边框”的效果)</li>
<li>将特性有装饰者实现，避免基础类需要维护太多的特性，导致职责过于复杂</li>
</ol>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>可能产生许多小对象，对不理解该结构的人来讲，有点难以学习</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>在不影响其他对象的情况下，以动态、透明的方式给单个对象添加职责，避免因为组合而需要创建大量的之类。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/91/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/91/">91</a><span class="page-number current">92</span><a class="page-number" href="/page/93/">93</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/93/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
