<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/79/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/79/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/" itemprop="url">分布式开放消息系统RocketMQ的原理与实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T12:12:57+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/消息队列/" itemprop="url" rel="index">
                    <span itemprop="name">消息队列</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/消息队列/RocketMQ/" itemprop="url" rel="index">
                    <span itemprop="name">RocketMQ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分布式开放消息系统RocketMQ的原理与实践"><a href="#分布式开放消息系统RocketMQ的原理与实践" class="headerlink" title="分布式开放消息系统RocketMQ的原理与实践"></a>分布式开放消息系统RocketMQ的原理与实践</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://www.jianshu.com/p/453c6e7ff81c" target="_blank" rel="noopener">https://www.jianshu.com/p/453c6e7ff81c</a></p>
</blockquote>
<p><br></p>
<p>分布式消息系统作为实现分布式系统可扩展、可伸缩性的关键组件，需要具有高吞吐量、高可用等特点。而谈到消息系统的设计，就回避不了两个问题：</p>
<blockquote>
<ol>
<li>消息的顺序问题</li>
<li>消息的重复问题</li>
</ol>
</blockquote>
<p>RocketMQ作为阿里开源的一款高性能、高吞吐量的消息中间件，它是怎样来解决这两个问题的？RocketMQ 有哪些关键特性？其实现原理是怎样的？</p>
<h4 id="关键特性以及其实现原理"><a href="#关键特性以及其实现原理" class="headerlink" title="关键特性以及其实现原理"></a>关键特性以及其实现原理</h4><h5 id="一、顺序消息"><a href="#一、顺序消息" class="headerlink" title="一、顺序消息"></a>一、顺序消息</h5><p>消息有序指的是可以按照消息的发送顺序来消费。例如：一笔订单产生了 3 条消息，分别是订单创建、订单付款、订单完成。消费时，要按照顺序依次消费才有意义。与此同时多笔订单之间又是可以并行消费的。首先来看如下示例：</p>
<p>假如生产者产生了2条消息：M1、M2，要保证这两条消息的顺序，应该怎样做？你脑中想到的可能是这样：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-303b6e1322576021.webp" alt="img"></p>
<p>你可能会采用这种方式保证消息顺序</p>
<p>假定M1发送到S1，M2发送到S2，如果要保证M1先于M2被消费，那么需要M1到达消费端被消费后，通知S2，然后S2再将M2发送到消费端。</p>
<p>这个模型存在的问题是，如果M1和M2分别发送到两台Server上，就不能保证M1先达到MQ集群，也不能保证M1被先消费。换个角度看，如果M2先于M1达到MQ集群，甚至M2被消费后，M1才达到消费端，这时消息也就乱序了，说明以上模型是不能保证消息的顺序的。如何才能在MQ集群保证消息的顺序？一种简单的方式就是将M1、M2发送到同一个Server上：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-886b25d2ced8e641.webp" alt="img"></p>
<p>保证消息顺序，你改进后的方法</p>
<p>这样可以保证M1先于M2到达MQServer（生产者等待M1发送成功后再发送M2），根据先达到先被消费的原则，M1会先于M2被消费，这样就保证了消息的顺序。</p>
<p>这个模型也仅仅是理论上可以保证消息的顺序，在实际场景中可能会遇到下面的问题：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-34c5c00c2490136b.webp" alt="img"></p>
<p>网络延迟问题</p>
<p>只要将消息从一台服务器发往另一台服务器，就会存在网络延迟问题。如上图所示，如果发送M1耗时大于发送M2的耗时，那么M2就仍将被先消费，仍然不能保证消息的顺序。即使M1和M2同时到达消费端，由于不清楚消费端1和消费端2的负载情况，仍然有可能出现M2先于M1被消费的情况。</p>
<p>那如何解决这个问题？将M1和M2发往同一个消费者，且发送M1后，需要消费端响应成功后才能发送M2。</p>
<p>聪明的你可能已经想到另外的问题：如果M1被发送到消费端后，消费端1没有响应，那是继续发送M2呢，还是重新发送M1？一般为了保证消息一定被消费，肯定会选择重发M1到另外一个消费端2，就如下图所示。</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-78a8706b4614440e.webp" alt="img"></p>
<p>保证消息顺序的正确姿势</p>
<p>这样的模型就严格保证消息的顺序，细心的你仍然会发现问题，消费端1没有响应Server时有两种情况，一种是M1确实没有到达(数据在网络传送中丢失)，另外一种消费端已经消费M1且已经发送响应消息，只是MQ Server端没有收到。如果是第二种情况，重发M1，就会造成M1被重复消费。也就引入了我们要说的第二个问题，消息重复问题，这个后文会详细讲解。</p>
<p>回过头来看消息顺序问题，严格的顺序消息非常容易理解，也可以通过文中所描述的方式来简单处理。总结起来，要实现严格的顺序消息，简单且可行的办法就是：</p>
<blockquote>
<p>保证<code>生产者 - MQServer - 消费者</code>是一对一对一的关系</p>
</blockquote>
<p>这样的设计虽然简单易行，但也会存在一些很严重的问题，比如：</p>
<blockquote>
<ol>
<li>并行度就会成为消息系统的瓶颈（吞吐量不够）</li>
<li>更多的异常处理，比如：只要消费端出现问题，就会导致整个处理流程阻塞，我们不得不花费更多的精力来解决阻塞的问题。</li>
</ol>
</blockquote>
<p>但我们的最终目标是要集群的高容错性和高吞吐量。这似乎是一对不可调和的矛盾，那么阿里是如何解决的？</p>
<blockquote>
<p>世界上解决一个计算机问题最简单的方法：“恰好”不需要解决它！—— <a href="http://i.youku.com/u/UMTcwMTg3NDc1Mg==?from=113-2-1-2" target="_blank" rel="noopener">沈询</a></p>
</blockquote>
<p>有些问题，看起来很重要，但实际上我们可以通过<strong>合理的设计</strong>或者<strong>将问题分解</strong>来规避。如果硬要把时间花在解决问题本身，实际上不仅效率低下，而且也是一种浪费。从这个角度来看消息的顺序问题，我们可以得出两个结论：</p>
<blockquote>
<ol>
<li>不关注乱序的应用实际大量存在</li>
<li>队列无序并不意味着消息无序</li>
</ol>
</blockquote>
<p>所以从业务层面来保证消息的顺序而不仅仅是依赖于消息系统，是不是我们应该寻求的一种更合理的方式？</p>
<p>最后我们从源码角度分析RocketMQ怎么实现发送顺序消息。</p>
<p>RocketMQ通过轮询所有队列的方式来确定消息被发送到哪一个队列（负载均衡策略）。比如下面的示例中，订单号相同的消息会被先后发送到同一个队列中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// RocketMQ通过MessageQueueSelector中实现的算法来确定消息发送到哪一个队列上</span><br><span class="line">// RocketMQ默认提供了两种MessageQueueSelector实现：随机/Hash</span><br><span class="line">// 当然你可以根据业务实现自己的MessageQueueSelector来决定消息按照何种策略发送到消息队列中</span><br><span class="line">SendResult sendResult = producer.send(msg, new MessageQueueSelector() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) &#123;</span><br><span class="line">        Integer id = (Integer) arg;</span><br><span class="line">        int index = id % mqs.size();</span><br><span class="line">        return mqs.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, orderId);</span><br></pre></td></tr></table></figure>
<p>在获取到路由信息以后，会根据<code>MessageQueueSelector</code>实现的算法来选择一个队列，同一个OrderId获取到的肯定是同一个队列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private SendResult send()  &#123;</span><br><span class="line">    // 获取topic路由信息</span><br><span class="line">    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">    if (topicPublishInfo != null &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">        MessageQueue mq = null;</span><br><span class="line">        // 根据我们的算法，选择一个发送队列</span><br><span class="line">        // 这里的arg = orderId</span><br><span class="line">        mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</span><br><span class="line">        if (mq != null) &#123;</span><br><span class="line">            return this.sendKernelImpl(msg, mq, communicationMode, sendCallback, timeout);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="二、消息重复"><a href="#二、消息重复" class="headerlink" title="二、消息重复"></a>二、消息重复</h5><p>上面在解决消息顺序问题时，引入了一个新的问题，就是消息重复。那么RocketMQ是怎样解决消息重复的问题呢？还是“恰好”不解决。</p>
<p>造成消息重复的根本原因是：网络不可达。只要通过网络交换数据，就无法避免这个问题。所以解决这个问题的办法就是绕过这个问题。那么问题就变成了：如果消费端收到两条一样的消息，应该怎样处理？</p>
<blockquote>
<ol>
<li>消费端处理消息的业务逻辑保持幂等性</li>
<li>保证每条消息都有唯一编号且保证消息处理成功与去重表的日志同时出现</li>
</ol>
</blockquote>
<p>第1条很好理解，只要保持幂等性，不管来多少条重复消息，最后处理的结果都一样。第2条原理就是利用一张日志表来记录已经处理成功的消息的ID，如果新到的消息ID已经在日志表中，那么就不再处理这条消息。</p>
<p>第1条解决方案，很明显应该在消费端实现，不属于消息系统要实现的功能。第2条可以消息系统实现，也可以业务端实现。正常情况下出现重复消息的概率其实很小，如果由消息系统来实现的话，肯定会对消息系统的吞吐量和高可用有影响，所以最好还是由业务端自己处理消息重复的问题，这也是RocketMQ不解决消息重复的问题的原因。</p>
<p><strong>RocketMQ不保证消息不重复，如果你的业务需要保证严格的不重复消息，需要你自己在业务端去重。</strong></p>
<h5 id="三、事务消息"><a href="#三、事务消息" class="headerlink" title="三、事务消息"></a>三、事务消息</h5><p>RocketMQ除了支持普通消息，顺序消息，另外还支持事务消息。首先讨论一下什么是事务消息以及支持事务消息的必要性。我们以一个转帐的场景为例来说明这个问题：Bob向Smith转账100块。</p>
<p>在单机环境下，执行事务的情况，大概是下面这个样子：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-13a6d80b21345f45.webp" alt="img"></p>
<p>单机环境下转账事务示意图</p>
<p>当用户增长到一定程度，Bob和Smith的账户及余额信息已经不在同一台服务器上了，那么上面的流程就变成了这样：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-69101aad0122572b.webp" alt="img"></p>
<p>集群环境下转账事务示意图</p>
<p>这时候你会发现，同样是一个转账的业务，在集群环境下，耗时居然成倍的增长，这显然是不能够接受的。那如何来规避这个问题？</p>
<blockquote>
<p><strong>大事务 = 小事务 + 异步</strong></p>
</blockquote>
<p>将大事务拆分成多个小事务异步执行。这样基本上能够将跨机事务的执行效率优化到与单机一致。转账的事务就可以分解成如下两个小事务：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-92abb226f288ff9c.webp" alt="img"></p>
<p>小事务+异步消息</p>
<p>图中执行本地事务（Bob账户扣款）和发送异步消息应该保证同时成功或者同时失败，也就是扣款成功了，发送消息一定要成功，如果扣款失败了，就不能再发送消息。那问题是：我们是先扣款还是先发送消息呢？</p>
<p>首先看下先发送消息的情况，大致的示意图如下：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-1927b8f3d14ef823.webp" alt="img"></p>
<p>事务消息：先发送消息</p>
<p>存在的问题是：如果消息发送成功，但是扣款失败，消费端就会消费此消息，进而向Smith账户加钱。</p>
<p>先发消息不行，那就先扣款吧，大致的示意图如下：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-367b5cf60cbdfa16.webp" alt="img"></p>
<p>事务消息-先扣款</p>
<p>存在的问题跟上面类似：如果扣款成功，发送消息失败，就会出现Bob扣钱了，但是Smith账户未加钱。</p>
<p>可能大家会有很多的方法来解决这个问题，比如：直接将发消息放到Bob扣款的事务中去，如果发送失败，抛出异常，事务回滚。这样的处理方式也符合“恰好”不需要解决的原则。</p>
<blockquote>
<p>这里需要说明一下：如果使用Spring来管理事物的话，大可以将发送消息的逻辑放到本地事物中去，发送消息失败抛出异常，Spring捕捉到异常后就会回滚此事物，以此来保证本地事物与发送消息的原子性。</p>
</blockquote>
<p>RocketMQ支持事务消息，下面来看看RocketMQ是怎样来实现的。</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-ab0085543c6d02d6.webp" alt="img"></p>
<p>RocketMQ实现发送事务消息</p>
<p>RocketMQ第一阶段发送<code>Prepared消息</code>时，会拿到消息的地址，第二阶段执行本地事物，第三阶段通过第一阶段拿到的地址去访问消息，并修改消息的状态。</p>
<p>细心的你可能又发现问题了，如果确认消息发送失败了怎么办？RocketMQ会定期扫描消息集群中的事物消息，如果发现了<code>Prepared消息</code>，它会向消息发送端(生产者)确认，Bob的钱到底是减了还是没减呢？如果减了是回滚还是继续发送确认消息呢？RocketMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。</p>
<p>那我们来看下RocketMQ源码，是如何处理事务消息的。客户端发送事务消息的部分（完整代码请查看：<code>rocketmq-example</code>工程下的<code>com.alibaba.rocketmq.example.transaction.TransactionProducer</code>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// =============================发送事务消息的一系列准备工作========================================</span><br><span class="line">// 未决事务，MQ服务器回查客户端</span><br><span class="line">// 也就是上文所说的，当RocketMQ发现`Prepared消息`时，会根据这个Listener实现的策略来决断事务</span><br><span class="line">TransactionCheckListener transactionCheckListener = new TransactionCheckListenerImpl();</span><br><span class="line">// 构造事务消息的生产者</span><br><span class="line">TransactionMQProducer producer = new TransactionMQProducer(&quot;groupName&quot;);</span><br><span class="line">// 设置事务决断处理类</span><br><span class="line">producer.setTransactionCheckListener(transactionCheckListener);</span><br><span class="line">// 本地事务的处理逻辑，相当于示例中检查Bob账户并扣钱的逻辑</span><br><span class="line">TransactionExecuterImpl tranExecuter = new TransactionExecuterImpl();</span><br><span class="line">producer.start()</span><br><span class="line">// 构造MSG，省略构造参数</span><br><span class="line">Message msg = new Message(......);</span><br><span class="line">// 发送消息</span><br><span class="line">SendResult sendResult = producer.sendMessageInTransaction(msg, tranExecuter, null);</span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure>
<p>接着查看<code>sendMessageInTransaction</code>方法的源码，总共分为3个阶段：发送<code>Prepared消息</code>、执行本地事务、发送确认消息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//  ================================事务消息的发送过程=============================================</span><br><span class="line">public TransactionSendResult sendMessageInTransaction(.....)  &#123;</span><br><span class="line">    // 逻辑代码，非实际代码</span><br><span class="line">    // 1.发送消息</span><br><span class="line">    sendResult = this.send(msg);</span><br><span class="line">    // sendResult.getSendStatus() == SEND_OK</span><br><span class="line">    // 2.如果消息发送成功，处理与消息关联的本地事务单元</span><br><span class="line">    LocalTransactionState localTransactionState = tranExecuter.executeLocalTransactionBranch(msg, arg);</span><br><span class="line">    // 3.结束事务</span><br><span class="line">    this.endTransaction(sendResult, localTransactionState, localException);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>endTransaction</code>方法会将请求发往<code>broker(mq server)</code>去更新事务消息的最终状态：</p>
<ol>
<li>根据<code>sendResult</code>找到<code>Prepared消息</code> ，<code>sendResult</code>包含事务消息的ID</li>
<li>根据<code>localTransaction</code>更新消息的最终状态</li>
</ol>
<p>如果<code>endTransaction</code>方法执行失败，数据没有发送到<code>broker</code>，导致事务消息的 状态更新失败，<code>broker</code>会有回查线程定时（默认1分钟）扫描每个存储事务状态的表格文件，如果是已经提交或者回滚的消息直接跳过，如果是<code>prepared状态</code>则会向<code>Producer</code>发起<code>CheckTransaction</code>请求，<code>Producer</code>会调用<code>DefaultMQProducerImpl.checkTransactionState()</code>方法来处理<code>broker</code>的定时回调请求，而<code>checkTransactionState</code>会调用我们的事务设置的决断方法来决定是回滚事务还是继续执行，最后调用<code>endTransactionOneway</code>让<code>broker</code>来更新消息的最终状态。</p>
<p>再回到转账的例子，如果Bob的账户的余额已经减少，且消息已经发送成功，Smith端开始消费这条消息，这个时候就会出现消费失败和消费超时两个问题，解决超时问题的思路就是一直重试，直到消费端消费消息成功，整个过程中有可能会出现消息重复的问题，按照前面的思路解决即可。</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-1d9ba7bcd230e0dc.webp" alt="img"></p>
<p>消费事务消息</p>
<p>这样基本上可以解决消费端超时问题，但是如果消费失败怎么办？阿里提供给我们的解决方法是：<strong>人工解决</strong>。大家可以考虑一下，按照事务的流程，因为某种原因Smith加款失败，那么需要回滚整个流程。如果消息系统要实现这个回滚流程的话，系统复杂度将大大提升，且很容易出现Bug，估计出现Bug的概率会比消费失败的概率大很多。这也是RocketMQ目前暂时没有解决这个问题的原因，在设计实现消息系统时，我们需要衡量是否值得花这么大的代价来解决这样一个出现概率非常小的问题，这也是大家在解决疑难问题时需要多多思考的地方。</p>
<blockquote>
<p>20160321补充：在3.2.6版本中移除了事务消息的实现，所以此版本不支持事务消息，具体情况请参考rocketmq的issues(已失效)：<br><del><a href="https://github.com/alibaba/RocketMQ/issues/65" target="_blank" rel="noopener">https://github.com/alibaba/RocketMQ/issues/65</a></del><br><del><a href="https://github.com/alibaba/RocketMQ/issues/138" target="_blank" rel="noopener">https://github.com/alibaba/RocketMQ/issues/138</a></del><br><del><a href="https://github.com/alibaba/RocketMQ/issues/156" target="_blank" rel="noopener">https://github.com/alibaba/RocketMQ/issues/156</a></del></p>
</blockquote>
<p><a href="https://github.com/ld140319/Blog_ReConstruct/blob/master/%E6%9E%B6%E6%9E%84/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%E5%AE%9E%E9%99%85%E7%94%9F%E4%BA%A7%E4%B8%AD99.99%25%E9%AB%98%E5%8F%AF%E7%94%A8.md" target="_blank" rel="noopener">最终一致性分布式事务如何保障实际生产中99.99%高可用？</a></p>
<h5 id="四、Producer如何发送消息"><a href="#四、Producer如何发送消息" class="headerlink" title="四、Producer如何发送消息"></a>四、Producer如何发送消息</h5><p><code>Producer</code>轮询某topic下的所有队列的方式来实现发送方的负载均衡，如下图所示：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-9eac93e29d0e06ef.webp" alt="img"></p>
<p>producer发送消息负载均衡</p>
<p> 首先分析一下RocketMQ的客户端发送消息的源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 构造Producer</span><br><span class="line">DefaultMQProducer producer = new DefaultMQProducer(&quot;ProducerGroupName&quot;);</span><br><span class="line">// 初始化Producer，整个应用生命周期内，只需要初始化1次</span><br><span class="line">producer.start();</span><br><span class="line">// 构造Message</span><br><span class="line">Message msg = new Message(&quot;TopicTest1&quot;,// topic</span><br><span class="line">                        &quot;TagA&quot;,// tag：给消息打标签,用于区分一类消息，可为null</span><br><span class="line">                        &quot;OrderID188&quot;,// key：自定义Key，可以用于去重，可为null</span><br><span class="line">                        (&quot;Hello MetaQ&quot;).getBytes());// body：消息内容</span><br><span class="line">// 发送消息并返回结果</span><br><span class="line">SendResult sendResult = producer.send(msg);</span><br><span class="line">// 清理资源，关闭网络连接，注销自己</span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure>
<p>在整个应用生命周期内，生产者需要调用一次start方法来初始化，初始化主要完成的任务有：</p>
<blockquote>
<ol>
<li>如果没有指定<code>namesrv</code>地址，将会自动寻址</li>
<li>启动定时任务：更新namesrv地址、从namsrv更新topic路由信息、清理已经挂掉的broker、向所有broker发送心跳…</li>
<li>启动负载均衡的服务</li>
</ol>
</blockquote>
<p>初始化完成后，开始发送消息，发送消息的主要代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">private SendResult sendDefaultImpl(Message msg,......) &#123;</span><br><span class="line">    // 检查Producer的状态是否是RUNNING</span><br><span class="line">    this.makeSureStateOK();</span><br><span class="line">    // 检查msg是否合法：是否为null、topic,body是否为空、body是否超长</span><br><span class="line">    Validators.checkMessage(msg, this.defaultMQProducer);</span><br><span class="line">    // 获取topic路由信息</span><br><span class="line">    TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">    // 从路由信息中选择一个消息队列</span><br><span class="line">    MessageQueue mq = topicPublishInfo.selectOneMessageQueue(lastBrokerName);</span><br><span class="line">    // 将消息发送到该队列上去</span><br><span class="line">    sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中需要关注的两个方法<code>tryToFindTopicPublishInfo</code>和<code>selectOneMessageQueue</code>。前面说过在producer初始化时，会启动定时任务获取路由信息并更新到本地缓存，所以<code>tryToFindTopicPublishInfo</code>会首先从缓存中获取topic路由信息，如果没有获取到，则会自己去<code>namesrv</code>获取路由信息。<code>selectOneMessageQueue</code>方法通过轮询的方式，返回一个队列，以达到负载均衡的目的。</p>
<p>如果Producer发送消息失败，会自动重试，重试的策略：</p>
<ol>
<li>重试次数 &lt; retryTimesWhenSendFailed（可配置）</li>
<li>总的耗时（包含重试n次的耗时） &lt; sendMsgTimeout（发送消息时传入的参数）</li>
<li>同时满足上面两个条件后，Producer会选择另外一个队列发送消息</li>
</ol>
<h5 id="五、消息存储"><a href="#五、消息存储" class="headerlink" title="五、消息存储"></a>五、消息存储</h5><p>RocketMQ的消息存储是由<code>consume queue</code>和<code>commit log</code>配合完成的。</p>
<h6 id="1、Consume-Queue"><a href="#1、Consume-Queue" class="headerlink" title="1、Consume Queue"></a>1、Consume Queue</h6><p><code>consume queue</code>是消息的逻辑队列，相当于字典的目录，用来指定消息在物理文件<code>commit log</code>上的位置。</p>
<p>我们可以在配置中指定<code>consumequeue</code>与<code>commitlog</code>存储的目录<br> 每个<code>topic</code>下的每个<code>queue</code>都有一个对应的<code>consumequeue</code>文件，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;rocketmq.home&#125;/store/consumequeue/$&#123;topicName&#125;/$&#123;queueId&#125;/$&#123;fileName&#125;</span><br></pre></td></tr></table></figure>
<p>Consume Queue文件组织，如图所示：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-d1b4318d77a96950.webp" alt="img"></p>
<p>Consume Queue文件组织示意图</p>
<ol>
<li>根据<code>topic</code>和<code>queueId</code>来组织文件，图中TopicA有两个队列0,1，那么TopicA和QueueId=0组成一个ConsumeQueue，TopicA和QueueId=1组成另一个ConsumeQueue。</li>
<li>按照消费端的<code>GroupName</code>来分组重试队列，如果消费端消费失败，消息将被发往重试队列中，比如图中的<code>%RETRY%ConsumerGroupA</code>。</li>
<li>按照消费端的<code>GroupName</code>来分组死信队列，如果消费端消费失败，并重试指定次数后，仍然失败，则发往死信队列，比如图中的<code>%DLQ%ConsumerGroupA</code>。</li>
</ol>
<blockquote>
<p>死信队列（Dead Letter Queue）一般用于存放由于某种原因无法传递的消息，比如处理失败或者已经过期的消息。</p>
</blockquote>
<p>Consume Queue中存储单元是一个20字节定长的二进制数据，顺序写顺序读，如下图所示：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-7212acc81b91c086.webp" alt="img"></p>
<p>consumequeue文件存储单元格式</p>
<ol>
<li>CommitLog Offset是指这条消息在Commit Log文件中的实际偏移量</li>
<li>Size存储中消息的大小</li>
<li>Message Tag HashCode存储消息的Tag的哈希值：主要用于订阅时消息过滤（订阅时如果指定了Tag，会根据HashCode来快速查找到订阅的消息）</li>
</ol>
<h6 id="2、Commit-Log"><a href="#2、Commit-Log" class="headerlink" title="2、Commit Log"></a>2、Commit Log</h6><p>CommitLog：消息存放的物理文件，每台<code>broker</code>上的<code>commitlog</code>被本机所有的<code>queue</code>共享，不做任何区分。<br> 文件的默认位置如下，仍然可通过配置文件修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;user.home&#125; \store\$&#123;commitlog&#125;\$&#123;fileName&#125;</span><br></pre></td></tr></table></figure>
<p>CommitLog的消息存储单元长度不固定，文件顺序写，随机读。消息的存储结构如下表所示，按照编号顺序以及编号对应的内容依次存储。</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-96ed677eb504abfe.webp" alt="img"></p>
<p>Commit Log存储单元结构图</p>
<h6 id="3、消息存储实现"><a href="#3、消息存储实现" class="headerlink" title="3、消息存储实现"></a>3、消息存储实现</h6><p>消息存储实现，比较复杂，也值得大家深入了解，后面会单独成文来分析(目前正在收集素材)，这小节只以代码说明一下具体的流程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// Set the storage time</span><br><span class="line">msg.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">// Set the message body BODY CRC (consider the most appropriate setting</span><br><span class="line">msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</span><br><span class="line">StoreStatsService storeStatsService = this.defaultMessageStore.getStoreStatsService();</span><br><span class="line">synchronized (this) &#123;</span><br><span class="line">    long beginLockTimestamp = this.defaultMessageStore.getSystemClock().now();</span><br><span class="line">    // Here settings are stored timestamp, in order to ensure an orderly global</span><br><span class="line">    msg.setStoreTimestamp(beginLockTimestamp);</span><br><span class="line">    // MapedFile：操作物理文件在内存中的映射以及将内存数据持久化到物理文件中</span><br><span class="line">    MapedFile mapedFile = this.mapedFileQueue.getLastMapedFile();</span><br><span class="line">    // 将Message追加到文件commitlog</span><br><span class="line">    result = mapedFile.appendMessage(msg, this.appendMessageCallback);</span><br><span class="line">    switch (result.getStatus()) &#123;</span><br><span class="line">    case PUT_OK:break;</span><br><span class="line">    case END_OF_FILE:</span><br><span class="line">         // Create a new file, re-write the message</span><br><span class="line">         mapedFile = this.mapedFileQueue.getLastMapedFile();</span><br><span class="line">         result = mapedFile.appendMessage(msg, this.appendMessageCallback);</span><br><span class="line">     break;</span><br><span class="line">     DispatchRequest dispatchRequest = new DispatchRequest(</span><br><span class="line">                topic,// 1</span><br><span class="line">                queueId,// 2</span><br><span class="line">                result.getWroteOffset(),// 3</span><br><span class="line">                result.getWroteBytes(),// 4</span><br><span class="line">                tagsCode,// 5</span><br><span class="line">                msg.getStoreTimestamp(),// 6</span><br><span class="line">                result.getLogicsOffset(),// 7</span><br><span class="line">                msg.getKeys(),// 8</span><br><span class="line">                /**</span><br><span class="line">                 * Transaction</span><br><span class="line">                 */</span><br><span class="line">                msg.getSysFlag(),// 9</span><br><span class="line">                msg.getPreparedTransactionOffset());// 10</span><br><span class="line">    // 1.分发消息位置到ConsumeQueue</span><br><span class="line">    // 2.分发到IndexService建立索引</span><br><span class="line">    this.defaultMessageStore.putDispatchRequest(dispatchRequest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4、消息的索引文件"><a href="#4、消息的索引文件" class="headerlink" title="4、消息的索引文件"></a>4、消息的索引文件</h6><p>如果一个消息包含key值的话，会使用IndexFile存储消息索引，文件的内容结构如图：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-4deee0fb9d08e02d.webp" alt="img"></p>
<p>消息索引</p>
<p>索引文件主要用于根据key来查询消息的，流程主要是：</p>
<ol>
<li>根据查询的 key 的 hashcode%slotNum 得到具体的槽的位置(slotNum 是一个索引文件里面包含的最大槽的数目，例如图中所示 slotNum=5000000)</li>
<li>根据 slotValue(slot 位置对应的值)查找到索引项列表的最后一项(倒序排列,slotValue 总是指向最新的一个索引项)</li>
<li>遍历索引项列表返回查询时间范围内的结果集(默认一次最大返回的 32 条记录)</li>
</ol>
<h5 id="六、消息订阅"><a href="#六、消息订阅" class="headerlink" title="六、消息订阅"></a>六、消息订阅</h5><p>RocketMQ消息订阅有两种模式，一种是Push模式，即MQServer主动向消费端推送；另外一种是Pull模式，即消费端在需要时，主动到MQServer拉取。但在具体实现时，Push和Pull模式都是采用消费端主动拉取的方式。</p>
<p>首先看下消费端的负载均衡：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-fdbb184a5d9bd022.webp" alt="img"></p>
<p>消费端负载均衡</p>
<p>消费端会通过RebalanceService线程，10秒钟做一次基于topic下的所有队列负载：</p>
<ol>
<li>遍历Consumer下的所有topic，然后根据topic订阅所有的消息</li>
<li>获取同一topic和Consumer Group下的所有Consumer</li>
<li>然后根据具体的分配策略来分配消费队列，分配的策略包含：平均分配、消费端配置等</li>
</ol>
<p>如同上图所示：如果有 5 个队列，2 个 consumer，那么第一个 Consumer 消费 3 个队列，第二 consumer 消费 2 个队列。这里采用的就是平均分配策略，它类似于分页的过程，TOPIC下面的所有queue就是记录，Consumer的个数就相当于总的页数，那么每页有多少条记录，就类似于某个Consumer会消费哪些队列。</p>
<p>通过这样的策略来达到大体上的平均消费，这样的设计也可以很方面的水平扩展Consumer来提高消费能力。</p>
<p>消费端的Push模式是通过长轮询的模式来实现的，就如同下图：</p>
<p><img src="//blog.com/2019/05/10/分布式开放消息系统RocketMQ的原理与实践/175724-f2e2ee205d49a05f.webp" alt="img"></p>
<p>Push模式示意图</p>
<p>Consumer端每隔一段时间主动向broker发送拉消息请求，broker在收到Pull请求后，如果有消息就立即返回数据，Consumer端收到返回的消息后，再回调消费者设置的Listener方法。如果broker在收到Pull请求时，消息队列里没有数据，broker端会阻塞请求直到有数据传递或超时才返回。</p>
<p>当然，Consumer端是通过一个线程将阻塞队列<code>LinkedBlockingQueue&lt;PullRequest&gt;</code>中的<code>PullRequest</code>发送到broker拉取消息，以防止Consumer一致被阻塞。而Broker端，在接收到Consumer的<code>PullRequest</code>时，如果发现没有消息，就会把<code>PullRequest</code>扔到ConcurrentHashMap中缓存起来。broker在启动时，会启动一个线程不停的从ConcurrentHashMap取出<code>PullRequest</code>检查，直到有数据返回。</p>
<h5 id="七、RocketMQ的其他特性"><a href="#七、RocketMQ的其他特性" class="headerlink" title="七、RocketMQ的其他特性"></a>七、RocketMQ的其他特性</h5><p>前面的6个特性都是基本上都是点到为止，想要深入了解，还需要大家多多查看源码，多多在实际中运用。当然除了已经提到的特性外，RocketMQ还支持：</p>
<ol>
<li>定时消息</li>
<li>消息的刷盘策略</li>
<li>主动同步策略：同步双写、异步复制</li>
<li>海量消息堆积能力</li>
<li>高效通信</li>
<li>…….</li>
</ol>
<p>其中涉及到的很多设计思路和解决方法都值得我们深入研究：</p>
<ol>
<li>消息的存储设计：既要满足海量消息的堆积能力，又要满足极快的查询效率，还要保证写入的效率。</li>
<li>高效的通信组件设计：高吞吐量，毫秒级的消息投递能力都离不开高效的通信。</li>
<li>…….</li>
</ol>
<h4 id="RocketMQ最佳实践"><a href="#RocketMQ最佳实践" class="headerlink" title="RocketMQ最佳实践"></a>RocketMQ最佳实践</h4><h5 id="一、Producer最佳实践"><a href="#一、Producer最佳实践" class="headerlink" title="一、Producer最佳实践"></a>一、Producer最佳实践</h5><p>1、一个应用尽可能用一个 Topic，消息子类型用 tags 来标识，tags 可以由应用自由设置。只有发送消息设置了tags，消费方在订阅消息时，才可以利用 tags 在 broker 做消息过滤。<br> 2、每个消息在业务层面的唯一标识码，要设置到 keys 字段，方便将来定位消息丢失问题。由于是哈希索引，请务必保证 key 尽可能唯一，这样可以避免潜在的哈希冲突。<br> 3、消息发送成功或者失败，要打印消息日志，务必要打印 sendresult 和 key 字段。<br> 4、对于消息不可丢失应用，务必要有消息重发机制。例如：消息发送失败，存储到数据库，能有定时程序尝试重发或者人工触发重发。<br> 5、某些应用如果不关注消息是否发送成功，请直接使用<code>sendOneWay</code>方法发送消息。</p>
<h5 id="二、Consumer最佳实践"><a href="#二、Consumer最佳实践" class="headerlink" title="二、Consumer最佳实践"></a>二、Consumer最佳实践</h5><p>1、消费过程要做到幂等（即消费端去重）<br> 2、尽量使用批量方式消费方式，可以很大程度上提高消费吞吐量。<br> 3、优化每条消息消费过程</p>
<h5 id="三、其他配置"><a href="#三、其他配置" class="headerlink" title="三、其他配置"></a>三、其他配置</h5><p>线上应该关闭<code>autoCreateTopicEnable</code>，即在配置文件中将其设置为<code>false</code>。</p>
<p>RocketMQ在发送消息时，会首先获取路由信息。如果是新的消息，由于MQServer上面还没有创建对应的<code>Topic</code>，这个时候，如果上面的配置打开的话，会返回默认TOPIC的（RocketMQ会在每台<code>broker</code>上面创建名为<code>TBW102</code>的TOPIC）路由信息，然后<code>Producer</code>会选择一台<code>Broker</code>发送消息，选中的<code>broker</code>在存储消息时，发现消息的<code>topic</code>还没有创建，就会自动创建<code>topic</code>。后果就是：以后所有该TOPIC的消息，都将发送到这台<code>broker</code>上，达不到负载均衡的目的。</p>
<p>所以基于目前RocketMQ的设计，建议关闭自动创建TOPIC的功能，然后根据消息量的大小，手动创建TOPIC。</p>
<h4 id="RocketMQ设计相关"><a href="#RocketMQ设计相关" class="headerlink" title="RocketMQ设计相关"></a>RocketMQ设计相关</h4><p>RocketMQ的设计假定：</p>
<blockquote>
<p>每台PC机器都可能宕机不可服务<br>任意集群都有可能处理能力不足<br>最坏的情况一定会发生<br>内网环境需要低延迟来提供最佳用户体验</p>
</blockquote>
<p>RocketMQ的关键设计：</p>
<blockquote>
<p>分布式集群化<br>强数据安全<br>海量数据堆积<br>毫秒级投递延迟（推拉模式）</p>
</blockquote>
<p>这是RocketMQ在设计时的假定前提以及需要到达的效果。我想这些假定适用于所有的系统设计。随着我们系统的服务的增多，每位开发者都要注意自己的程序是否存在单点故障，如果挂了应该怎么恢复、能不能很好的水平扩展、对外的接口是否足够高效、自己管理的数据是否足够安全…… 多多规范自己的设计，才能开发出高效健壮的程序。</p>
<h5 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h5><ol>
<li><a href="http://pan.baidu.com/s/1kTWsE8J" target="_blank" rel="noopener">RocketMQ用户指南</a></li>
<li><a href="http://pan.baidu.com/s/1bogcpgN" target="_blank" rel="noopener">RocketMQ原理简介</a></li>
<li><a href="http://pan.baidu.com/s/1kTXE4PD" target="_blank" rel="noopener">RocketMQ最佳实践</a></li>
<li><a href="http://v.youku.com/v_show/id_XODY4ODE3OTY0.html?from=s1.8-1-1.2" target="_blank" rel="noopener">阿里分布式开放消息服务(ONS)原理与实践2</a></li>
<li><a href="http://v.youku.com/v_show/id_XODY5ODcxNjI0.html?from=s1.8-1-1.2" target="_blank" rel="noopener">阿里分布式开放消息服务(ONS)原理与实践3</a></li>
<li><a href="http://blog.csdn.net/column/details/learningrocketmq.html" target="_blank" rel="noopener">RocketMQ原理解析</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/10/6个实例详解如何把 if-else 代码重构成高质量代码/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/6个实例详解如何把 if-else 代码重构成高质量代码/" itemprop="url">6个实例详解如何把 if-else 代码重构成高质量代码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T12:12:57+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码规范与技巧/" itemprop="url" rel="index">
                    <span itemprop="name">代码规范与技巧</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/代码规范与技巧/代码技巧/" itemprop="url" rel="index">
                    <span itemprop="name">代码技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="6个实例详解如何把-if-else-代码重构成高质量代码"><a href="#6个实例详解如何把-if-else-代码重构成高质量代码" class="headerlink" title="6个实例详解如何把 if-else 代码重构成高质量代码"></a>6个实例详解如何把 if-else 代码重构成高质量代码</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/bMbtlyGmrrL9OxNz7LeZ-w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/bMbtlyGmrrL9OxNz7LeZ-w</a></p>
</blockquote>
<h2 id="为什么我们写的代码都是if-else？"><a href="#为什么我们写的代码都是if-else？" class="headerlink" title="为什么我们写的代码都是if-else？"></a>为什么我们写的代码都是if-else？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;程序员想必都经历过这样的场景：刚开始自己写的代码很简洁，逻辑清晰，函数精简，没有一个<code>if-else</code>，</p>
<p>可随着代码逻辑不断完善和业务的瞬息万变:比如需要对入参进行类型和值进行判断；这里要判断下对象是否为<code>null</code>；不同类型执行不同的流程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;落地到具体实现只能不停地加<code>if-else</code>来处理，渐渐地，代码变得越来越庞大，函数越来越长，文件行数也迅速突破上千行，维护难度也越来越大，到后期基本达到一种难以维护的状态。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽然我们都很不情愿写出满屏<code>if-else</code>的代码，可逻辑上就是需要特殊判断，很绝望，可也没办法避免啊。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实回头看看自己的代码，<strong>写<code>if-else</code>不外乎两种场景：异常逻辑处理和不同状态处理</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>两者最主要的区别是：异常逻辑处理说明只能一个分支是正常流程，而不同状态处理都所有分支都是正常流程</strong>。</p>
<p>怎么理解？举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//举例一：异常逻辑处理例子</span><br><span class="line">Object obj = getObj();</span><br><span class="line">if (obj != null)</span><br><span class="line">&#123;</span><br><span class="line">   //do something</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   //do something</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//举例二：状态处理例子</span><br><span class="line">Object obj = getObj();</span><br><span class="line">if (obj.getType == 1)</span><br><span class="line">&#123;</span><br><span class="line">  //do something</span><br><span class="line">&#125; else if (obj.getType == 2) &#123;</span><br><span class="line">  //do something</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  //do something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一个例子 <code>if(obj!=null)</code> 是异常处理，是代码健壮性判断，只有 if 里面才是正常的处理流程， <code>else</code> 分支是出错处理流程；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而第二个例子不管 <code>type</code>等于 1，2 还是其他情况，都属于业务的正常流程。对于这两种情况重构的方法也不一样。</p>
<hr>
<h2 id="代码if-else代码太多有什么缺点？"><a href="#代码if-else代码太多有什么缺点？" class="headerlink" title="代码if-else代码太多有什么缺点？"></a>代码if-else代码太多有什么缺点？</h2><p><strong>缺点相当明显了：</strong></p>
<ol>
<li><strong>最大的问题是代码逻辑复杂，维护性差，极容易引发<code>bug</code></strong>。</li>
<li><strong>如果使用<code>if-else</code>，说明 <code>if</code>分支和 <code>else</code>分支的重视是同等的，但大多数情况并非如此，容易引起误解和理解困难</strong>。</li>
</ol>
<h2 id="是否有好的方法优化？如何重构？"><a href="#是否有好的方法优化？如何重构？" class="headerlink" title="是否有好的方法优化？如何重构？"></a>是否有好的方法优化？如何重构？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;方法肯定是有的。重构 <code>if-else</code> 时，心中无时无刻把握一个原则：</p>
<blockquote>
<p><strong>尽可能地维持正常流程代码在最外层</strong>。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;意思是说，可以写 <code>if-else</code> 语句时一定要尽量保持主干代码是正常流程，避免嵌套过深。</p>
<p>实现的手段有：<strong>减少嵌套、移除临时变量、条件取反判断、合并条件表达式等。</strong></p>
<h3 id="异常逻辑处理型重构方法实例一"><a href="#异常逻辑处理型重构方法实例一" class="headerlink" title="异常逻辑处理型重构方法实例一"></a>异常逻辑处理型重构方法实例一</h3><p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">double disablityAmount ()</span><br><span class="line">&#123;</span><br><span class="line">   if (_seniority &lt; 2)</span><br><span class="line">     return 0;</span><br><span class="line">   if (_monthsDisabled &gt; 12)</span><br><span class="line">     return 0;</span><br><span class="line">   if (_isPartTime)</span><br><span class="line">     return 0;</span><br><span class="line">            </span><br><span class="line">     //do somethig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">double disablityAmount()</span><br><span class="line">&#123;</span><br><span class="line">   if (_seniority &lt; 2 || _monthsDisabled &gt; 12 || _isPartTime)</span><br><span class="line">      return 0;</span><br><span class="line">        </span><br><span class="line">      //do somethig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里的重构手法叫<strong>合并条件表达式</strong>：如果有一系列条件测试都得到相同结果，将这些结果测试合并为一个条件表达式。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个重构手法简单易懂，带来的效果也非常明显，能有效地较少if语句，减少代码量逻辑上也更加易懂。</p>
<h3 id="异常逻辑处理型重构方法实例二"><a href="#异常逻辑处理型重构方法实例二" class="headerlink" title="异常逻辑处理型重构方法实例二"></a>异常逻辑处理型重构方法实例二</h3><p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">double getPayAmount()</span><br><span class="line">&#123;</span><br><span class="line">  double result;</span><br><span class="line">  if (_isDead)</span><br><span class="line">  &#123;</span><br><span class="line">      result = deadAmount();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">      if (_isSeparated) &#123;</span><br><span class="line">         result = separatedAmount();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">         if (_isRetired) &#123;</span><br><span class="line">              result = retiredAmount();</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">              result = normalPayAmount();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">double getPayAmount()</span><br><span class="line">&#123;</span><br><span class="line">   if (_isDead)</span><br><span class="line">      return deadAmount();</span><br><span class="line">   if (_isSeparated)</span><br><span class="line">       return separatedAmount();</span><br><span class="line">   if (_isRetired)</span><br><span class="line">       return retiredAmount();</span><br><span class="line">   return normalPayAmount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;怎么样？比对两个版本，会发现重构后的版本逻辑清晰，简洁易懂。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;和重构前到底有什么区别呢？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最大的区别是<strong>减少<code>if-else</code> 嵌套</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以看到，最初的版本<code>if-else</code>最深的嵌套有三层，看上去逻辑分支非常多，进到里面基本都要被绕晕。其实，仔细想想嵌套内的<code>if-else</code> 和最外层并没有关联性的，完全可以提取最顶层。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>改为平行关系，而非包含关系，<code>if-else</code>数量没有变化，但是逻辑清晰明了，一目了然。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另一个重构点是<strong>废除了 <code>result</code> 临时变量，直接 return 返回</strong>。好处也显而易见直接结束流程，缩短异常分支流程。原来的做法先赋值给 <code>result</code>最后统一 <code>return</code> ，那么对于最后 <code>return</code> 的值到底是那个函数返回的结果不明确，增加了一层理解难度。</p>
<blockquote>
<p>总结重构的要点：</p>
<p><strong>如果 if-else 嵌套没有关联性，直接提取到第一层，一定要避免逻辑嵌套太深</strong>。</p>
<p><strong>尽量减少临时变量改用return直接返回</strong>。</p>
</blockquote>
<h3 id="异常逻辑处理型重构方法实例三"><a href="#异常逻辑处理型重构方法实例三" class="headerlink" title="异常逻辑处理型重构方法实例三"></a>异常逻辑处理型重构方法实例三</h3><p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">double getAdjustedCapital()</span><br><span class="line">&#123;</span><br><span class="line">   double result = 0.0;</span><br><span class="line">   if (_capital &gt; 0.0)&#123;</span><br><span class="line">      if (_intRate &gt; 0 &amp;&amp; _duration &gt; 0) &#123;</span><br><span class="line">           resutl = (_income / _duration) * ADJ_FACTOR;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一步，运用第一招:<strong>减少嵌套和移除临时变量</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public double getAdjustedCapital()&#123;</span><br><span class="line">   if (_capital &lt;= 0.0)&#123;</span><br><span class="line">        return 0.0;</span><br><span class="line">   &#125;</span><br><span class="line">   if (_intRate &gt; 0 &amp;&amp; _duration &gt; 0) &#123;</span><br><span class="line">        return (_income / _duration) * ADJ_FACTOR;</span><br><span class="line">   &#125;</span><br><span class="line">   return 0.0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样重构后，还不够，因为主要的语句 <code>_(_income/_duration)*ADJ_FACTOR;_</code>在 if 内部，并非在最外层，根据优化原则（<strong>尽可能地维持正常流程代码在最外层</strong>），可以再继续重构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public double getAdjustedCapital()&#123;</span><br><span class="line">    if (_capital &lt;= 0.0)&#123;</span><br><span class="line">       return 0.0;</span><br><span class="line">    &#125;</span><br><span class="line">    if (_intRate &lt;= 0 || _duration &lt;= 0)&#123;</span><br><span class="line">       return 0.0;</span><br><span class="line">    &#125;</span><br><span class="line">    return (_income / _duration) * ADJ_FACTOR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这才是好的代码风格，逻辑清晰，一目了然，没有<code>if-else</code> 嵌套难以理解的流程。</p>
<blockquote>
<p>这里用到的重构方法是：<strong>将条件反转使异常情况先退出，让正常流程维持在主干流程</strong>。</p>
</blockquote>
<h3 id="异常逻辑处理型重构方法实例四"><a href="#异常逻辑处理型重构方法实例四" class="headerlink" title="异常逻辑处理型重构方法实例四"></a>异常逻辑处理型重构方法实例四</h3><p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/* 查找年龄大于18岁且为男性的学生列表 */</span><br><span class="line"></span><br><span class="line">    public ArrayList&lt;Student&gt; getStudents(int uid) &#123;</span><br><span class="line">        ArrayList&lt;Student&gt; result = new ArrayList&lt;Student&gt;();</span><br><span class="line"></span><br><span class="line">        Student stu = getStudentByUid(uid);</span><br><span class="line"></span><br><span class="line">        if (stu != null) &#123;</span><br><span class="line">            Teacher teacher = stu.getTeacher();</span><br><span class="line"></span><br><span class="line">            if (teacher != null) &#123;</span><br><span class="line"></span><br><span class="line">                ArrayList&lt;Student&gt; students = teacher.getStudents();</span><br><span class="line"></span><br><span class="line">                if (students != null) &#123;</span><br><span class="line"></span><br><span class="line">                    for (Student student : students) &#123;</span><br><span class="line">                        if (student.getAge() &gt;= 18 &amp;&amp; student.getGender() == MALE) &#123;</span><br><span class="line">                            result.add(student);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    logger.error(&quot;获取学生列表失败&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                logger.error(&quot;获取老师信息失败&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            logger.error(&quot;获取学生信息失败&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;典型的”箭头型”代码，最大的问题是<strong>嵌套过深，解决方法是异常条件先退出，保持主干流程是核心流程</strong>：</p>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/* 查找年龄大于18岁且为男性的学生列表 */</span><br><span class="line">    public ArrayList&lt;Student&gt; getStudents(int uid) &#123;</span><br><span class="line">        ArrayList&lt;Student&gt; result = new ArrayList&lt;Student&gt;();</span><br><span class="line">        Student stu = getStudentByUid(uid);</span><br><span class="line">        if (stu == null) &#123;</span><br><span class="line">            logger.error(&quot;获取学生信息失败&quot;);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        Teacher teacher = stu.getTeacher();</span><br><span class="line">        if (teacher == null) &#123;</span><br><span class="line">            logger.error(&quot;获取老师信息失败&quot;);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;Student&gt; students = teacher.getStudents();</span><br><span class="line">        if (students == null) &#123;</span><br><span class="line">            logger.error(&quot;获取学生列表失败&quot;);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        for (Student student : students) &#123;</span><br><span class="line">            if (student.getAge() &gt; 18 &amp;&amp; student.getGender() == MALE) &#123;</span><br><span class="line">                result.add(student);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="状态处理型重构方法实例五"><a href="#状态处理型重构方法实例五" class="headerlink" title="状态处理型重构方法实例五"></a>状态处理型重构方法实例五</h3><p>重构前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public double getPayAmount() &#123;</span><br><span class="line">    Object obj = getObj();</span><br><span class="line">    double money = 0;</span><br><span class="line">    if (obj.getType == 1) &#123;</span><br><span class="line">        ObjectA objA = obj.getObjectA();</span><br><span class="line">        money = objA.getMoney() * obj.getNormalMoneryA();</span><br><span class="line">    &#125; else if (obj.getType == 2) &#123;</span><br><span class="line">        ObjectB objB = obj.getObjectB();</span><br><span class="line">        money = objB.getMoney() * obj.getNormalMoneryB() + 1000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public double getPayAmount() &#123;</span><br><span class="line">    Object obj = getObj();</span><br><span class="line">    if (obj.getType == 1) &#123;</span><br><span class="line">        return getType1Money(obj);</span><br><span class="line">    &#125; else if (obj.getType == 2) &#123;</span><br><span class="line">        return getType2Money(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double getType1Money(Object obj) &#123;</span><br><span class="line">    ObjectA objA = obj.getObjectA();</span><br><span class="line">    return objA.getMoney() * obj.getNormalMoneryA();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">double getType2Money(Object obj) &#123;</span><br><span class="line">    ObjectB objB = obj.getObjectB();</span><br><span class="line">    return objB.getMoney() * obj.getNormalMoneryB() + 1000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里使用的重构方法是：<strong>把<code>if-else</code> 内的代码都封装成一个公共函数</strong>。函数的好处是<strong>屏蔽内部实现，缩短 <code>if-else</code> 分支的代码</strong>。代码结构和逻辑上清晰，能一下看出来每一个条件内做的功能。</p>
</blockquote>
<h3 id="状态处理型重构方法实例六"><a href="#状态处理型重构方法实例六" class="headerlink" title="状态处理型重构方法实例六"></a>状态处理型重构方法实例六</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对状态处理的代码，一种优雅的做法是<strong>用多态取代条件表达式(《重构》推荐做法)</strong>。</p>
<blockquote>
<p>你手上有个条件表达式，它根据对象类型的不同而选择不同的行为。<strong>将这个表达式的每个分支放进一个子类内的覆写函数中，然后将原始函数声明为抽象函数</strong>。</p>
</blockquote>
<p>重构前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public double getSpeed() &#123;</span><br><span class="line">    switch (_type) &#123;</span><br><span class="line">        case EUROPEAN:</span><br><span class="line">            return getBaseSpeed();</span><br><span class="line">        case AFRICAN:</span><br><span class="line">            return getBaseSpeed() - getLoadFactor() * _numberOfCoconuts;</span><br><span class="line">        case NORWEGIAN_BLUE:</span><br><span class="line">            return (_isNailed) ? 0 : getBaseSpeed(_voltage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重构后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Bird &#123;</span><br><span class="line">        abstract double getSpeed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class European extends Bird &#123;</span><br><span class="line">        double getSpeed() &#123;</span><br><span class="line">            return getBaseSpeed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class African extends Bird &#123;</span><br><span class="line">        double getSpeed() &#123;</span><br><span class="line">            return getBaseSpeed() - getLoadFactor() * _numberOfCoconuts;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class NorwegianBlue extends Bird &#123;</span><br><span class="line">        double getSpeed() &#123;</span><br><span class="line">            return (_isNailed) ? 0 : getBaseSpeed(_voltage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以看到，使用多态后直接没有了 <code>if-else</code>，但使用多态对原来代码修改过大，需要一番功夫才行。最好在设计之初就使用多态方式。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>if-else</code>代码是每一个程序员最容易写出的代码，同时也是最容易被写烂的代码，稍不注意，就产生一堆难以维护和逻辑混乱的代码。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对条件型代码重构把握一个原则：</p>
<blockquote>
<p><strong>尽可能地维持正常流程代码在最外层，保持主干流程是正常核心流程</strong>。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为维持这个原则：</p>
<ol>
<li><strong>合并条件表达式可以有效地减少if语句数目</strong>；</li>
<li><strong>减少嵌套能减少深层次逻辑</strong>；</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>异常条件先退出自然而然主干流程就是正常流程</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对状态处理型重构方法有两种：</p>
<ol>
<li><p><strong>把不同状态的操作封装成函数，简短<code>if-else</code>内代码行数</strong></p>
</li>
<li><p><strong>利用面向对象多态特性直接干掉了条件判断</strong></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/10/冗余数据一致性，到底如何保证？/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/冗余数据一致性，到底如何保证？/" itemprop="url">冗余数据一致性，到底如何保证？</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T12:12:57+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据一致性问题/" itemprop="url" rel="index">
                    <span itemprop="name">数据一致性问题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="冗余数据一致性，到底如何保证？"><a href="#冗余数据一致性，到底如何保证？" class="headerlink" title="冗余数据一致性，到底如何保证？"></a>冗余数据一致性，到底如何保证？</h1><blockquote>
<p>整理自【架构师之路】</p>
</blockquote>
<h2 id="为什么要冗余数据"><a href="#为什么要冗余数据" class="headerlink" title="为什么要冗余数据"></a>为什么要冗余数据</h2><p>水平切分 =&gt; 降低单库数据量</p>
<p>垂直切分 =&gt; 降低单表数据量</p>
<p>互联网数据量很大的业务场景，往往数据库需要进行水平切分来降低单库数据量。</p>
<p>水平切分会有一个patition key，通过patition key的查询能够直接定位到库，但是非patition key上的查询可能就需要扫描多个库了。</p>
<p>此时常见的架构设计方案，是使用数据冗余这种反范式设计来满足分库后不同维度的查询需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">例如：订单业务，对用户和商家都有查询需求：</span><br><span class="line"></span><br><span class="line">Order(oid, info_detail);</span><br><span class="line"></span><br><span class="line">T(buyer_id, seller_id, oid);</span><br><span class="line"></span><br><span class="line">如果用buyer_id来分库，seller_id的查询就需要扫描多库。</span><br><span class="line"></span><br><span class="line">如果用seller_id来分库，buyer_id的查询就需要扫描多库。</span><br><span class="line"></span><br><span class="line">此时可以使用数据冗余来分别满足buyer_id和seller_id上的查询需求：</span><br><span class="line"></span><br><span class="line">T1(buyer_id, seller_id, oid)</span><br><span class="line"></span><br><span class="line">T2(seller_id, buyer_id, oid)</span><br><span class="line"></span><br><span class="line">同一个数据，冗余两份，一份以buyer_id来分库，满足买家的查询需求；一份以seller_id来分库，满足卖家的查询需求。</span><br></pre></td></tr></table></figure>
<h2 id="如何进行数据冗余"><a href="#如何进行数据冗余" class="headerlink" title="如何进行数据冗余"></a>如何进行数据冗余</h2><h3 id="（1）服务同步双写-两次写库"><a href="#（1）服务同步双写-两次写库" class="headerlink" title="（1）服务同步双写(两次写库)"></a>（1）服务同步双写(两次写库)</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;顾名思义，由服务层同步写冗余数据，如下图：</p>
<p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/服务同步双写.webp" alt="服务同步双写"></p>
<ul>
<li>业务方调用服务，新增数据</li>
<li>服务先插入T1数据</li>
<li>服务再插入T2数据</li>
<li>服务返回业务方新增数据成功</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>不复杂，服务层由单次写，变两次写</li>
<li>数据一致性相对较高（因为双写成功才返回）</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>请求的处理时间增加（要插入两次，时间加倍）</li>
<li>数据仍可能不一致，例如第二步写入T1完成后服务重启，则数据不会写入T2</li>
</ul>
<p>如果系统对处理时间比较敏感，引出常用的第二种方案。</p>
<h3 id="（2）服务异步双写-消息队列解耦"><a href="#（2）服务异步双写-消息队列解耦" class="headerlink" title="（2）服务异步双写(消息队列解耦)"></a>（2）服务异步双写(消息队列解耦)</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;数据的双写并不再由服务来完成，服务层异步发出一个消息，通过消息总线发送给一个专门的数据复制服务来写入冗余数据，如下图：</p>
<p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/服务异步双写.webp" alt="服务异步双写"></p>
<ul>
<li>业务方调用服务，新增数据</li>
<li>服务先插入T1数据</li>
<li>服务向消息总线发送一个异步消息（发出即可，不用等返回，通常很快就能完成）</li>
<li>服务返回业务方新增数据成功</li>
<li>消息总线将消息投递给数据同步中心</li>
<li>数据同步中心插入T2数据</li>
</ul>
<p><strong>这里的消息总线指的是消息队列, 服务为消息生产者，数据同步中心为消息消费者</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>请求处理时间短（只插入1次）</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>系统的复杂性增加了，多引入了一个组件（消息总线）和一个服务（专用的数据复制服务）</li>
<li>因为返回业务线数据插入成功时，数据还不一定插入到T2中，因此数据有一个不一致时间窗口（这个窗口很短，最终是一致的）</li>
<li>在消息总线丢失消息时，冗余表数据会不一致</li>
</ul>
<p>不管是服务同步双写，还是服务异步双写，服务都需要关注“冗余数据”带来的复杂性。如果想解除“数据冗余”对系统的耦合，引出常用的第三种方案。</p>
<h3 id="（3）线下异步双写-binlog监听"><a href="#（3）线下异步双写-binlog监听" class="headerlink" title="（3）线下异步双写(binlog监听)"></a>（3）线下异步双写(binlog监听)</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;为了屏蔽“冗余数据”对服务带来的复杂性，数据的双写不再由服务层来完成，而是由线下的一个服务或者任务来完成，如下图所示：</p>
<p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/线下异步双写.webp" alt="服务异步双写"></p>
<ul>
<li>业务方调用服务，新增数据</li>
<li>服务先插入T1数据</li>
<li>服务返回业务方新增数据成功</li>
<li>数据会被写入到数据库的log中</li>
<li>线下服务或者任务读取数据库的log</li>
<li>线下服务或者任务插入T2数据</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>数据双写与业务完全解耦</li>
<li>请求处理时间短（只插入1次）</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>返回业务线数据插入成功时，数据还不一定插入到T2中，因此数据有一个不一致时间窗口（这个窗口很短，最终是一致的）</li>
<li>数据的一致性依赖于线下服务或者任务的可靠性</li>
</ul>
<h3 id="（4）数据冗余方案总结"><a href="#（4）数据冗余方案总结" class="headerlink" title="（4）数据冗余方案总结"></a>（4）数据冗余方案总结</h3><p>不管哪种方案，毕竟不是分布式事务，万一出现数据不一致，怎么办呢？</p>
<p><strong>高并发的情况下，实时一致性很难，方法论是：最终一致性。</strong></p>
<p>实现方式是：<strong>异步检测，异步修复。</strong></p>
<h2 id="如何保证数据的一致性"><a href="#如何保证数据的一致性" class="headerlink" title="如何保证数据的一致性"></a>如何保证数据的一致性</h2><h3 id="（1）线下扫描全量数据法"><a href="#（1）线下扫描全量数据法" class="headerlink" title="（1）线下扫描全量数据法"></a>（1）线下扫描全量数据法</h3><p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/线下扫描全量数据法.webp" alt="线下扫描全量数据法"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;线下启动一个离线的扫描工具，不停的比对正表T1和反表T2，如果发现数据不一致，就进行补偿修复。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>比较简单，开发代价小</li>
<li>线上服务无需修改，修复工具与线上服务解耦</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>扫描效率低，会扫描大量的“已经能够保证一致”的数据</li>
<li>由于扫描的数据量大，扫描一轮的时间比较长，即数据如果不一致，不一致的时间窗口比较长</li>
</ul>
<h3 id="（2）线下扫描增量数据法"><a href="#（2）线下扫描增量数据法" class="headerlink" title="（2）线下扫描增量数据法"></a>（2）线下扫描增量数据法</h3><p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/线下扫描增量数据法.webp" alt="线下扫描增量数据法"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;每次只扫描增量的日志数据，就能够极大提高效率，缩短数据不一致的时间窗口，如下图所示：</p>
<ul>
<li>写入正表T1</li>
<li>第一步成功后，写入日志log1</li>
<li>写入反表T2</li>
<li>第二步成功后，写入日志log2</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;当然，我们还是需要一个离线的扫描工具，不停的比对日志log1和日志log2，如果发现数据不一致，就进行补偿修复</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>虽比方法一复杂，但仍然是比较简单的</li>
<li>数据扫描效率高，只扫描增量数据</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>线上服务略有修改（代价不高，多写了2条日志）</li>
<li>虽然比方法一更实时，但时效性还是不高，不一致窗口取决于扫描的周期</li>
</ul>
<h3 id="（3）线上实时检测“消息对”法"><a href="#（3）线上实时检测“消息对”法" class="headerlink" title="（3）线上实时检测“消息对”法"></a>（3）线上实时检测“消息对”法</h3><p><img src="//blog.com/2019/05/10/冗余数据一致性，到底如何保证？/线上实时检测“消息对”法.webp" alt="线上实时检测“消息对”法"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这次不是写日志了，而是向消息总线发送消息，如下图所示：</p>
<ul>
<li>写入正表T1</li>
<li>第一步成功后，发送消息msg1</li>
<li>写入反表T2</li>
<li>第二步成功后，发送消息msg2</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这次不是需要一个周期扫描的离线工具了，而是一个<strong>实时订阅消息的服务不停的收消息。</strong></p>
<p><strong>假设正常情况下，msg1和msg2的接收时间应该在3s以内，如果检测服务在收到msg1后没有收到msg2，就尝试检测数据的一致性，不一致时进行补偿修复。</strong></p>
<p>具体实现逻辑:</p>
<ul>
<li>1.第一步成功后，发送消息msg1 写入队列queue1</li>
<li>2.第二步成功后，发送消息msg2写入队列queue2 </li>
<li>3.queue2的消费程序 将成功的关键数据标识写入success表</li>
<li>4.queue1的消费程序收到消息后 延迟3秒后 读success表有没有相应记录 没有则异步修复</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优点：</p>
<ul>
<li>效率高</li>
<li>实时性高</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;缺点：</p>
<ul>
<li>方案比较复杂，上线引入了消息总线这个组件</li>
<li>线下多了一个订阅总线的检测服务</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>互联网数据量大的业务场景，常常:</p>
<p>使用水平切分来降低单库数据量</p>
<p>使用数据冗余的反范式设计来满足不同维度的查询需求</p>
<p><strong>冗余数据三种方案：</strong></p>
<ul>
<li>(1)服务同步双写法能够很容易的实现数据冗余</li>
<li>(2)为了降低时延，可以优化为服务异步双写法</li>
<li>(3)为了屏蔽“冗余数据”对服务带来的复杂性，可以优化为线下异步双写法</li>
</ul>
<p><strong>保证数据一致性的方案：</strong></p>
<ul>
<li>(1)最简单的方式，线下脚本扫全量数据比对</li>
<li>(2)提高效率的方式，线下脚本扫增量数据比对</li>
<li>(3)最实时的方式，线上检测“消息对”</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/10/前后端分离实践详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/前后端分离实践详解/" itemprop="url">前后端分离实践详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T12:12:57+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/前后端分离/" itemprop="url" rel="index">
                    <span itemprop="name">前后端分离</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前后端分离实践详解"><a href="#前后端分离实践详解" class="headerlink" title="前后端分离实践详解"></a>前后端分离实践详解</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://segmentfault.com/a/1190000009329474#articleHeader2" target="_blank" rel="noopener">https://segmentfault.com/a/1190000009329474#articleHeader2</a></p>
</blockquote>
<p><br></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最近这一段时间由于<code>Node js</code>的逐渐成熟和日趋稳定，越来越多的公司中的前端团队开始尝试使用<code>Node js</code>来练一下手，尝一尝鲜。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般的做法都是将原本属于后端的一部分相对于业务不是很重要的功能迁移到<code>Node js</code>上面来，也有一些公司将<code>Node JS</code>作为前后端分离的一个解决方案去施行。而像淘宝网这类的大型网站也很早的完成了前后端的分离，给我们这样的后来者提供了宝贵的经验。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同样，我们的大网盘团队也早在去年早早就开始了紧锣密布的准备工作，这目前工作也做的差不多了，现在我就来总结一下在过程中遇到的坑点以及注意事项。</p>
<h2 id="认识前后端分离"><a href="#认识前后端分离" class="headerlink" title="认识前后端分离"></a>认识前后端分离</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在传统的web应用开发中，大多数的程序员会将浏览器作为前后端的分界线</strong>。<strong>将浏览器中为用户进行页面展示的部分称之为前端，而将运行在服务器，为前端提供业务逻辑和数据准备的所有代码统称为后端</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于前后端分离这个概念相对来说刚出现不久，很多人都是只闻其声，不见其形，所以可能会对它产生一些误解，误以为前后端分离只是一种web应用开发模式，只要在web应用的开发期进行了前后端开发工作的分工就是前后端分离。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实<strong><code>前后端分离并不只是开发模式，而是web应用的一种架构模式</code></strong>。</p>
<blockquote>
<p>在开发阶段，前后端工程师约定好数据交互接口，实现并行开发和测试；</p>
<p>在运行阶段前后端分离模式需要对web应用进行分离部署，前后端之前使用HTTP或者其他协议进行交互请求；</p>
</blockquote>
<p>前后端分离大概可以从四个方面来理解：</p>
<ol>
<li>交互形式</li>
<li>代码组织方式</li>
<li>开发模式</li>
<li>数据接口规范流程</li>
</ol>
<h3 id="一、交互形式"><a href="#一、交互形式" class="headerlink" title="一、交互形式"></a>一、交互形式</h3><p><img src="//blog.com/2019/05/10/前后端分离实践详解/1505148931-590fe33b182bc_articlex.jpg" alt="架构图"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在前后端分离架构中，<strong>后端只需要负责按照约定的数据格式向前端提供可调用的API服务即可</strong>。前后端之间通过HTTP请求进行交互，前端获取到数据后，进行页面的组装和渲染，最终返回给浏览器。</p>
<h3 id="二、代码组织方式"><a href="#二、代码组织方式" class="headerlink" title="二、代码组织方式"></a>二、代码组织方式</h3><p><img src="//blog.com/2019/05/10/前后端分离实践详解/2730095214-590fe36e8c596_articlex.jpg" alt="图片描述"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在传统架构模式中，前后端代码存放于同一个代码库中，甚至是同一工程目录下</strong>。<strong>页面中还夹杂着后端代码</strong>。<strong>前后端工程师进行开发时，都必须把整个项目导入到开发工具中</strong>。</p>
<p>而前后端分离模式在代码组织形式上有以下两种:</p>
<ul>
<li><strong>半分离</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端共用一个代码库，但是代码分别存放在两个工程中。后端不关心或很少关心前端元素的输出情况，前端不能独立进行开发和测试，项目中缺乏前后端 交互的测试用例。</li>
<li><strong>分离</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>前后端代码库分离，前端代码中有可以进行Mock测试</strong>(通过构造虚拟测试对象以简化测试环境的方法)<strong>的伪后端，能支持前端的独立开发和测试</strong>。而后端代码中除了功能实现外，还有着详细的测试用例，以保证API的可用性，降低 集成风险。</li>
</ul>
<h3 id="三、开发模式"><a href="#三、开发模式" class="headerlink" title="三、开发模式"></a>三、开发模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们之前的架构属于传统的MVC架构，整体没有进行前后端分离，在项目的开发阶段，前端工程师负责编写HTML，完成前端的页面设计并套页面，然后再<strong>使用模板技术将写好的前端代码转换为Smarty脚本，同时内嵌一些后端提供的模板变量和一些逻辑操作</strong>。应用运行期，将全部代码进行打包，和后端代码部署到同一服务器上，同时会进行简单的动静态分离部署。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此时，应用的开发流程如下图所示。</p>
<p><img src="//blog.com/2019/05/10/前后端分离实践详解/190338060-590fe381db31b_articlex.jpg" alt="流程"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而在<strong>实现前后端分离架构之后，前端工程师只需要编写HTML、js、CSS等前端资源，然后通过HTTP请求调用后端提供的服务即可</strong>。<strong>除了开发期的分离，在运行期前后端资源也会进行分离部署</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离之后，开发流程将如下图所示。</p>
<p><img src="//blog.com/2019/05/10/前后端分离实践详解/2243725575-590fe39f9ff25_articlex.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过上面的两幅流程图，不难发现，在开发模式上，前后段分离不仅仅只是工程师的分工开发，更重要的意义在于<strong><code>实现了前后端的并行开发，简化了开发流程</code></strong>。</p>
<h3 id="四、数据接口规范流程"><a href="#四、数据接口规范流程" class="headerlink" title="四、数据接口规范流程"></a>四、数据接口规范流程</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在开发期间前后端共同商定好数据接口的交互形式和数据格式</strong>。<strong>然后实现前后端的并行开发，其中前端工程师再开发完成之后可以独自进行mock测试，而后端也可以使用接口测试平台进行接口自测，然后前后端一起进行功能联调并校验格式，最终进行自动化测试</strong>。</p>
<p><img src="//blog.com/2019/05/10/前后端分离实践详解/1801428871-590fe3b9d72de_articlex.jpg" alt="img"></p>
<h2 id="分离的四个好处"><a href="#分离的四个好处" class="headerlink" title="分离的四个好处"></a>分离的四个好处</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离模式和传统的web应用架构相比有很大的不同，到底分还是不分，这还真是个问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从目前应用软件开发的发展趋势来看，主要有两方面需要注意：</p>
<ol>
<li>越来越注重用户体验，随着互联网的发展，开始<strong>多终端化</strong>。</li>
<li>大型应用架构模式正在<strong>向云化、微服务化发展</strong>。</li>
</ol>
<p>我们主要通过前后端分离架构，为我们带来以下四个方面的提升：</p>
<ul>
<li><p><strong>为优质产品打造精益团队</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过将开发团队前后端分离化，<strong>让前后端工程师只需要专注于前端或后端的开发工作</strong>，是的前后端工程师实现自治，培养其独特的技术特性，然后构建出一个全栈式的精益开发团队。</p>
</li>
<li><p><strong>提升开发效率</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离以后，可以实现前后端代码的解耦，<strong>只要前后端沟通约定好应用所需接口以及接口参数，便可以开始并行开发，无需等待对方的开发工作结束</strong>。与此同时，即使需求发生变更，只要接口与数据格式不变，后端开发人员就不需要修改代码，只要前端进行变动即可。如此一来整个应用的开发效率必然会有质的提升。</p>
</li>
<li><p><strong>完美应对复杂多变的前端需求</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果开发团队能完成前后端分离的转型，打造优秀的前后端团队，开发独立化，让开发人员做到专注专精，开发能力必然会有所提升，能够完美应对各种复杂多变的前端需求。</p>
</li>
<li><p><strong>增强代码可维护性</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离后，应用的代码不再是前后端混合，只有在运行期才会有调用依赖关系。</p>
</li>
</ul>
<p>应用代码将会变得整洁清晰，不论是代码阅读还是代码维护都会比以前轻松。</p>
<h2 id="需要进行前后端分离的场景"><a href="#需要进行前后端分离的场景" class="headerlink" title="需要进行前后端分离的场景"></a>需要进行前后端分离的场景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;任何一项技术以及架构都不是适用于任何场景，前后端分离同样也是如此。虽然前后端分离架构能带来许多的好处，但前提是建立在开发团队合适的基础上的。</p>
<p>而我们百度网盘就属于那种：</p>
<ol>
<li>页面布局复杂，使用了主题和样式。</li>
<li>需要有较高的页面渲染效果</li>
<li>前端页面中包含复杂业务逻辑</li>
<li>页面需要渲染的数据量较大</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;像这种<code>重前端</code>的应用我们综合考虑了各种情况，最终决定采用前后端分离架构。</p>
<h2 id="部署方案"><a href="#部署方案" class="headerlink" title="部署方案"></a>部署方案</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离之后，应用在部署时也需要进行前后端分离。在进行前后端分离方案选择时，需要结合项目的实际情况和用户来考虑。</p>
<h3 id="分离之前的架构"><a href="#分离之前的架构" class="headerlink" title="分离之前的架构"></a>分离之前的架构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离之前，网盘的后端架构是Nginx服务和后端的PHP服务以及前端的静态资源都是部署在同一台服务器上。当浏览器发起访问请求时，如何请求的是静态资源，Nginx直接把静态资源返回给服务器；如果请求的是页面或后端服务，则经Nginx将请求转发到后端的PHP服务器，完成响应后经Nginx返回到浏览器。</p>
<p><img src="//blog.com/2019/05/10/前后端分离实践详解/482376308-590fe3e0736bc_articlex.png" alt="图片描述"></p>
<p><em>注：此图中的Nginx属于后端机，主要针对前端机Nginx转发过来的请求进行识别弄转发给本机的PHP服务；前端机和后端机各有一个Nginx服务。</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个方案比较简单，易于实现，而且能到达前后端解耦的目的。而且很多公司目前都是基于这种架构或者一定的变形来实现的web应用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是<strong>对于页面量比较大，需要有良好SEO的应用来说，此方案缺点也较为明显</strong>。因为 <strong>Nginx只是向浏览器返回页面静态资源，而国内的搜索引擎爬虫只会抓取静态数据， 不会解析页面中的js，这使得应用得不到良好的搜索引擎支持</strong>。同时<strong>因为Nginx不会进行页面的组装渲染，需要把静态页面返回到浏览器，然后完成渲染工作，这加重了浏览器的渲染负担</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;另外，<strong>由于这种架构使得前端工程师的工作范围只局限在了浏览器一侧，导致在进行一些特殊的性能优化时，前端工程师无法独立完成，还需要后端开发人员的配合，这也一定程度上影响了双方的进度</strong>。</p>
<h3 id="分离之后的架构"><a href="#分离之后的架构" class="headerlink" title="分离之后的架构"></a>分离之后的架构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离之后，我们在原先的架构只上再单独增加了一个<code>Node Server</code>作为中间层，将前端资源部署到<code>Node Server</code>中。<code>Node Server</code>还实现了一层数据代理服务，负责与提供数据的后端服务进行通信。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;并且还在这个基础上增加并使用了前端机<em>（前端机是对所有的请求进行预处理和负载均衡，然后再转发给后端机。）</em>的<code>Nginx</code>服务，<strong>浏览器发起的请求经过前端机的Nginx进行分发，URL请求统一分发到<code>Node Server</code>，在<code>Node Server</code>中根据请求类型从后端服务器上通过RPC服务请求页面的模板数据，然后进行页面的组装和渲染</strong>；<strong>API请求则直接转发到后端服务器，完成响应</strong>。</p>
<p><img src="//blog.com/2019/05/10/前后端分离实践详解/4147062273-590fe428498fc_articlex.jpg" alt="图片描述"></p>
<p><em>注：此图中的<code>Nginx</code>属于前端机。</em></p>
<h3 id="前后端分离方案对比"><a href="#前后端分离方案对比" class="headerlink" title="前后端分离方案对比"></a>前后端分离方案对比</h3><p><img src="//blog.com/2019/05/10/前后端分离实践详解/678651370-590fe43e30134_articlex.png" alt="图片描述"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前后端分离并非仅仅只是前后端开发的分工，而是在开发期进行代码存放分离、前后端开发职责分离，前后端能够独立进行开发测试;在运行期进行应用部署分离，前后端之间通过HTTP请求进行通讯。<strong>前后端分离的开发模式与传统模式相比，能为我们 提升开发效率、增强代码可维护性，让我们有规划地打造一个前后端并重的精益开发 团队，更好地应对越来越复杂多变的Web应用开发需求</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/10/Microsoft REST API Guidelines/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/Microsoft REST API Guidelines/" itemprop="url">Microsoft REST API Guidelines</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-10T12:12:57+08:00">
                2019-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/API设计/" itemprop="url" rel="index">
                    <span itemprop="name">API设计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Microsoft-REST-API-Guidelines"><a href="#Microsoft-REST-API-Guidelines" class="headerlink" title="Microsoft REST API Guidelines"></a>Microsoft REST API Guidelines</h1><h2 id="Microsoft-REST-API-Guidelines-Working-Group"><a href="#Microsoft-REST-API-Guidelines-Working-Group" class="headerlink" title="Microsoft REST API Guidelines Working Group"></a>Microsoft REST API Guidelines Working Group</h2><table>
<thead>
<tr>
<th>Name</th>
<th>Name</th>
<th>Name</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Dave Campbell (CTO C+E)</td>
<td>Rick Rashid (CTO ASG)</td>
<td>John Shewchuk (Technical Fellow, TED HQ)</td>
<td></td>
</tr>
<tr>
<td>Mark Russinovich (CTO Azure)</td>
<td>Steve Lucco (Technical Fellow, DevDiv)</td>
<td>Murali Krishnaprasad (Azure App Plat)</td>
<td></td>
</tr>
<tr>
<td>Rob Howard (ASG)</td>
<td>Peter Torr  (OSG)</td>
<td>Chris Mullins (ASG)</td>
</tr>
</tbody>
</table>
<div style="font-size:150%"><br>Document editors: John Gossman (C+E), Chris Mullins (ASG), Gareth Jones (ASG), Rob Dolin (C+E), Mark Stafford (C+E)<br><br></div>

<h1 id="Microsoft-REST-API-Guidelines-1"><a href="#Microsoft-REST-API-Guidelines-1" class="headerlink" title="Microsoft REST API Guidelines"></a>Microsoft REST API Guidelines</h1><h2 id="1-Abstract"><a href="#1-Abstract" class="headerlink" title="1. Abstract"></a>1. Abstract</h2><p>The Microsoft REST API Guidelines, as a design principle, encourages application developers to have resources accessible to them via a RESTful HTTP interface.<br>To provide the smoothest possible experience for developers on platforms following the Microsoft REST API Guidelines, REST APIs SHOULD follow consistent design guidelines to make using them easy and intuitive.</p>
<p>This document establishes the guidelines Microsoft REST APIs SHOULD follow so RESTful interfaces are developed consistently.</p>
<h2 id="2-Table-of-contents"><a href="#2-Table-of-contents" class="headerlink" title="2. Table of contents"></a>2. Table of contents</h2><!-- TOC depthFrom:2 depthTo:4 orderedList:false updateOnSave:false withLinks:true -->
<ul>
<li><a href="#microsoft-rest-api-guidelines-working-group">Microsoft REST API Guidelines Working Group</a></li>
<li><a href="#1-abstract">1. Abstract</a></li>
<li><a href="#2-table-of-contents">2. Table of contents</a></li>
<li><a href="#3-introduction">3. Introduction</a><ul>
<li><a href="#31-recommended-reading">3.1. Recommended reading</a></li>
</ul>
</li>
<li><a href="#4-interpreting-the-guidelines">4. Interpreting the guidelines</a><ul>
<li><a href="#41-application-of-the-guidelines">4.1. Application of the guidelines</a></li>
<li><a href="#42-guidelines-for-existing-services-and-versioning-of-services">4.2. Guidelines for existing services and versioning of services</a></li>
<li><a href="#43-requirements-language">4.3. Requirements language</a></li>
<li><a href="#44-license">4.4. License</a></li>
</ul>
</li>
<li><a href="#5-taxonomy">5. Taxonomy</a><ul>
<li><a href="#51-errors">5.1. Errors</a></li>
<li><a href="#52-faults">5.2. Faults</a></li>
<li><a href="#53-latency">5.3. Latency</a></li>
<li><a href="#54-time-to-complete">5.4. Time to complete</a></li>
<li><a href="#55-long-running-api-faults">5.5. Long running API faults</a></li>
</ul>
</li>
<li><a href="#6-client-guidance">6. Client guidance</a><ul>
<li><a href="#61-ignore-rule">6.1. Ignore rule</a></li>
<li><a href="#62-variable-order-rule">6.2. Variable order rule</a></li>
<li><a href="#63-silent-fail-rule">6.3. Silent fail rule</a></li>
</ul>
</li>
<li><a href="#7-consistency-fundamentals">7. Consistency fundamentals</a><ul>
<li><a href="#71-url-structure">7.1. URL structure</a></li>
<li><a href="#72-url-length">7.2. URL length</a></li>
<li><a href="#73-canonical-identifier">7.3. Canonical identifier</a></li>
<li><a href="#74-supported-methods">7.4. Supported methods</a><ul>
<li><a href="#741-post">7.4.1. POST</a></li>
<li><a href="#742-patch">7.4.2. PATCH</a></li>
<li><a href="#743-creating-resources-via-patch-upsert-semantics">7.4.3. Creating resources via PATCH (UPSERT semantics)</a></li>
<li><a href="#744-options-and-link-headers">7.4.4. Options and link headers</a></li>
</ul>
</li>
<li><a href="#75-standard-request-headers">7.5. Standard request headers</a></li>
<li><a href="#76-standard-response-headers">7.6. Standard response headers</a></li>
<li><a href="#77-custom-headers">7.7. Custom headers</a></li>
<li><a href="#78-specifying-headers-as-query-parameters">7.8. Specifying headers as query parameters</a></li>
<li><a href="#79-pii-parameters">7.9. PII parameters</a></li>
<li><a href="#710-response-formats">7.10. Response formats</a><ul>
<li><a href="#7101-clients-specified-response-format">7.10.1. Clients-specified response format</a></li>
<li><a href="#7102-error-condition-responses">7.10.2. Error condition responses</a></li>
</ul>
</li>
<li><a href="#711-http-status-codes">7.11. HTTP Status Codes</a></li>
<li><a href="#712-client-library-optional">7.12. Client library optional</a></li>
</ul>
</li>
<li><a href="#8-cors">8. CORS</a><ul>
<li><a href="#81-client-guidance">8.1. Client guidance</a><ul>
<li><a href="#811-avoiding-preflight">8.1.1. Avoiding preflight</a></li>
</ul>
</li>
<li><a href="#82-service-guidance">8.2. Service guidance</a></li>
</ul>
</li>
<li><a href="#9-collections">9. Collections</a><ul>
<li><a href="#91-item-keys">9.1. Item keys</a></li>
<li><a href="#92-serialization">9.2. Serialization</a></li>
<li><a href="#93-collection-url-patterns">9.3. Collection URL patterns</a><ul>
<li><a href="#931-nested-collections-and-properties">9.3.1. Nested collections and properties</a></li>
</ul>
</li>
<li><a href="#94-big-collections">9.4. Big collections</a></li>
<li><a href="#95-changing-collections">9.5. Changing collections</a></li>
<li><a href="#96-sorting-collections">9.6. Sorting collections</a><ul>
<li><a href="#961-interpreting-a-sorting-expression">9.6.1. Interpreting a sorting expression</a></li>
</ul>
</li>
<li><a href="#97-filtering">9.7. Filtering</a><ul>
<li><a href="#971-filter-operations">9.7.1. Filter operations</a></li>
<li><a href="#972-operator-examples">9.7.2. Operator examples</a></li>
<li><a href="#973-operator-precedence">9.7.3. Operator precedence</a></li>
</ul>
</li>
<li><a href="#98-pagination">9.8. Pagination</a><ul>
<li><a href="#981-server-driven-paging">9.8.1. Server-driven paging</a></li>
<li><a href="#982-client-driven-paging">9.8.2. Client-driven paging</a></li>
<li><a href="#983-additional-considerations">9.8.3. Additional considerations</a></li>
</ul>
</li>
<li><a href="#99-compound-collection-operations">9.9. Compound collection operations</a></li>
</ul>
</li>
<li><a href="#10-delta-queries">10. Delta queries</a><ul>
<li><a href="#101-delta-links">10.1. Delta links</a></li>
<li><a href="#102-entity-representation">10.2. Entity representation</a></li>
<li><a href="#103-obtaining-a-delta-link">10.3. Obtaining a delta link</a></li>
<li><a href="#104-contents-of-a-delta-link-response">10.4. Contents of a delta link response</a></li>
<li><a href="#105-using-a-delta-link">10.5. Using a delta link</a></li>
</ul>
</li>
<li><a href="#11-json-standardizations">11. JSON standardizations</a><ul>
<li><a href="#111-json-formatting-standardization-for-primitive-types">11.1. JSON formatting standardization for primitive types</a></li>
<li><a href="#112-guidelines-for-dates-and-times">11.2. Guidelines for dates and times</a><ul>
<li><a href="#1121-producing-dates">11.2.1. Producing dates</a></li>
<li><a href="#1122-consuming-dates">11.2.2. Consuming dates</a></li>
<li><a href="#1123-compatibility">11.2.3. Compatibility</a></li>
</ul>
</li>
<li><a href="#113-json-serialization-of-dates-and-times">11.3. JSON serialization of dates and times</a><ul>
<li><a href="#1131-the-dateliteral-format">11.3.1. The <code>DateLiteral</code> format</a></li>
<li><a href="#1132-commentary-on-date-formatting">11.3.2. Commentary on date formatting</a></li>
</ul>
</li>
<li><a href="#114-durations">11.4. Durations</a></li>
<li><a href="#115-intervals">11.5. Intervals</a></li>
<li><a href="#116-repeating-intervals">11.6. Repeating intervals</a></li>
</ul>
</li>
<li><a href="#12-versioning">12. Versioning</a><ul>
<li><a href="#121-versioning-formats">12.1. Versioning formats</a><ul>
<li><a href="#1211-group-versioning">12.1.1. Group versioning</a></li>
</ul>
</li>
<li><a href="#122-when-to-version">12.2. When to version</a></li>
<li><a href="#123-definition-of-a-breaking-change">12.3. Definition of a breaking change</a></li>
</ul>
</li>
<li><a href="#13-long-running-operations">13. Long running operations</a><ul>
<li><a href="#131-resource-based-long-running-operations-relo">13.1. Resource based long running operations (RELO)</a></li>
<li><a href="#132-stepwise-long-running-operations">13.2. Stepwise long running operations</a><ul>
<li><a href="#1321-put">13.2.1. PUT</a></li>
<li><a href="#1322-post">13.2.2. POST</a></li>
<li><a href="#1323-post-hybrid-model">13.2.3. POST, hybrid model</a></li>
<li><a href="#1324-operations-resource">13.2.4. Operations resource</a></li>
<li><a href="#1325-operation-resource">13.2.5. Operation resource</a></li>
<li><a href="#1326-operation-tombstones">13.2.6. Operation tombstones</a></li>
<li><a href="#1327-the-typical-flow-polling">13.2.7. The typical flow, polling</a></li>
<li><a href="#1328-the-typical-flow-push-notifications">13.2.8. The typical flow, push notifications</a></li>
<li><a href="#1329-retry-after">13.2.9. Retry-After</a></li>
</ul>
</li>
<li><a href="#133-retention-policy-for-operation-results">13.3. Retention policy for operation results</a></li>
</ul>
</li>
<li><a href="#14-throttling-quotas-and-limits">14. Throttling, Quotas, and Limits</a><ul>
<li><a href="#141-principles">14.1. Principles</a></li>
<li><a href="#142-return-codes-429-vs-503">14.2. Return Codes (429 vs 503)</a></li>
<li><a href="#143-retry-after-and-ratelimit-headers">14.3. Retry-After and RateLimit Headers</a></li>
<li><a href="#144-service-guidance">14.4. Service Guidance</a><ul>
<li><a href="#1441-responsiveness">14.4.1. Responsiveness</a></li>
<li><a href="#1442-rate-limits-and-quotas">14.4.2. Rate Limits and Quotas</a></li>
<li><a href="#1443-overloaded-services">14.4.3. Overloaded services</a></li>
<li><a href="#1444-example-response">14.4.4. Example Response</a></li>
</ul>
</li>
<li><a href="#145-caller-guidance">14.5. Caller Guidance</a></li>
<li><a href="#146-handling-callers-that-ignore-retry-after-headers">14.6. Handling callers that ignore Retry-After headers</a></li>
</ul>
</li>
<li><a href="#15-push-notifications-via-webhooks">15. Push notifications via webhooks</a><ul>
<li><a href="#151-scope">15.1. Scope</a></li>
<li><a href="#152-principles">15.2. Principles</a></li>
<li><a href="#153-types-of-subscriptions">15.3. Types of subscriptions</a></li>
<li><a href="#154-call-sequences">15.4. Call sequences</a></li>
<li><a href="#155-verifying-subscriptions">15.5. Verifying subscriptions</a></li>
<li><a href="#156-receiving-notifications">15.6. Receiving notifications</a><ul>
<li><a href="#1561-notification-payload">15.6.1. Notification payload</a></li>
</ul>
</li>
<li><a href="#157-managing-subscriptions-programmatically">15.7. Managing subscriptions programmatically</a><ul>
<li><a href="#1571-creating-subscriptions">15.7.1. Creating subscriptions</a></li>
<li><a href="#1572-updating-subscriptions">15.7.2. Updating subscriptions</a></li>
<li><a href="#1573-deleting-subscriptions">15.7.3. Deleting subscriptions</a></li>
<li><a href="#1574-enumerating-subscriptions">15.7.4. Enumerating subscriptions</a></li>
</ul>
</li>
<li><a href="#158-security">15.8. Security</a></li>
</ul>
</li>
<li><a href="#16-unsupported-requests">16. Unsupported requests</a><ul>
<li><a href="#161-essential-guidance">16.1. Essential guidance</a></li>
<li><a href="#162-feature-allow-list">16.2. Feature allow list</a><ul>
<li><a href="#1621-error-response">16.2.1. Error response</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#17-naming-guidelines">17. Naming guidelines</a><ul>
<li><a href="#171-approach">17.1. Approach</a></li>
<li><a href="#172-casing">17.2. Casing</a></li>
<li><a href="#173-names-to-avoid">17.3. Names to avoid</a></li>
<li><a href="#174-forming-compound-names">17.4. Forming compound names</a></li>
<li><a href="#175-identity-properties">17.5. Identity properties</a></li>
<li><a href="#176-date-and-time-properties">17.6. Date and time properties</a></li>
<li><a href="#177-name-properties">17.7. Name properties</a></li>
<li><a href="#178-collections-and-counts">17.8. Collections and counts</a></li>
<li><a href="#179-common-property-names">17.9. Common property names</a></li>
</ul>
</li>
<li><a href="#18-appendix">18. Appendix</a><ul>
<li><a href="#181-sequence-diagram-notes">18.1. Sequence diagram notes</a><ul>
<li><a href="#1811-push-notifications-per-user-flow">18.1.1. Push notifications, per user flow</a></li>
<li><a href="#1812-push-notifications-firehose-flow">18.1.2. Push notifications, firehose flow</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="3-Introduction"><a href="#3-Introduction" class="headerlink" title="3. Introduction"></a>3. Introduction</h2><p>Developers access most Microsoft Cloud Platform resources via HTTP interfaces.<br>Although each service typically provides language-specific frameworks to wrap their APIs, all of their operations eventually boil down to HTTP requests.<br>Microsoft must support a wide range of clients and services and cannot rely on rich frameworks being available for every development environment.<br>Thus, a goal of these guidelines is to ensure Microsoft REST APIs can be easily and consistently consumed by any client with basic HTTP support.</p>
<p>To provide the smoothest possible experience for developers, it’s important to have these APIs follow consistent design guidelines, thus making using them easy and intuitive.<br>This document establishes the guidelines to be followed by Microsoft REST API developers for developing such APIs consistently.</p>
<p>The benefits of consistency accrue in aggregate as well; consistency allows teams to leverage common code, patterns, documentation and design decisions.</p>
<p>These guidelines aim to achieve the following:</p>
<ul>
<li>Define consistent practices and patterns for all API endpoints across Microsoft.</li>
<li>Adhere as closely as possible to accepted REST/HTTP best practices in the industry at-large. [*]</li>
<li>Make accessing Microsoft Services via REST interfaces easy for all application developers.</li>
<li>Allow service developers to leverage the prior work of other services to implement, test and document REST endpoints defined consistently.</li>
<li>Allow for partners (e.g., non-Microsoft entities) to use these guidelines for their own REST endpoint design.</li>
</ul>
<p>[*] Note: The guidelines are designed to align with building services which comply with the REST architectural style, though they do not address or require building services that follow the REST constraints.<br>The term “REST” is used throughout this document to mean services that are in the spirit of REST rather than adhering to REST by the book.*</p>
<h3 id="3-1-Recommended-reading"><a href="#3-1-Recommended-reading" class="headerlink" title="3.1. Recommended reading"></a>3.1. Recommended reading</h3><p>Understanding the philosophy behind the REST Architectural Style is recommended for developing good HTTP-based services.<br>If you are new to RESTful design, here are some good resources:</p>
<p><a href="http://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="noopener">REST on Wikipedia</a> – Overview of common definitions and core ideas behind REST.</p>
<p><a href="https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm" target="_blank" rel="noopener">REST Dissertation</a> – The chapter on REST in Roy Fielding’s dissertation on Network Architecture, “Architectural Styles and the Design of Network-based Software Architectures”</p>
<p><a href="https://tools.ietf.org/html/rfc7231" target="_blank" rel="noopener">RFC 7231</a> – Defines the specification for HTTP/1.1 semantics, and is considered the authoritative resource.</p>
<p><a href="http://www.amazon.com/REST-Practice-Hypermedia-Systems-Architecture/dp/0596805829/" target="_blank" rel="noopener">REST in Practice</a> – Book on the fundamentals of REST.</p>
<h2 id="4-Interpreting-the-guidelines"><a href="#4-Interpreting-the-guidelines" class="headerlink" title="4. Interpreting the guidelines"></a>4. Interpreting the guidelines</h2><h3 id="4-1-Application-of-the-guidelines"><a href="#4-1-Application-of-the-guidelines" class="headerlink" title="4.1. Application of the guidelines"></a>4.1. Application of the guidelines</h3><p>These guidelines are applicable to any REST API exposed publicly by Microsoft or any partner service.<br>Private or internal APIs SHOULD also try to follow these guidelines because internal services tend to eventually be exposed publicly.<br> Consistency is valuable to not only external customers but also internal service consumers, and these guidelines offer best practices useful for any service.</p>
<p>There are legitimate reasons for exemption from these guidelines.<br>Obviously, a REST service that implements or must interoperate with some externally defined REST API must be compatible with that API and not necessarily these guidelines.<br>Some services MAY also have special performance needs that require a different format, such as a binary protocol.</p>
<h3 id="4-2-Guidelines-for-existing-services-and-versioning-of-services"><a href="#4-2-Guidelines-for-existing-services-and-versioning-of-services" class="headerlink" title="4.2. Guidelines for existing services and versioning of services"></a>4.2. Guidelines for existing services and versioning of services</h3><p>We do not recommend making a breaking change to a service that predates these guidelines simply for the sake of compliance.<br>The service SHOULD try to become compliant at the next version release when compatibility is being broken anyway.<br>When a service adds a new API, that API SHOULD be consistent with the other APIs of the same version.<br>So if a service was written against version 1.0 of the guidelines, new APIs added incrementally to the service SHOULD also follow version 1.0. The service can then upgrade to align with the latest version of the guidelines at the service’s next major release.</p>
<h3 id="4-3-Requirements-language"><a href="#4-3-Requirements-language" class="headerlink" title="4.3. Requirements language"></a>4.3. Requirements language</h3><p>The keywords “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt" target="_blank" rel="noopener">RFC 2119</a>.</p>
<h3 id="4-4-License"><a href="#4-4-License" class="headerlink" title="4.4. License"></a>4.4. License</h3><p>This work is licensed under the Creative Commons Attribution 4.0 International License.<br>To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">http://creativecommons.org/licenses/by/4.0/</a> or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.</p>
<h2 id="5-Taxonomy"><a href="#5-Taxonomy" class="headerlink" title="5. Taxonomy"></a>5. Taxonomy</h2><p>As part of onboarding to Microsoft REST API Guidelines, services MUST comply with the taxonomy defined below.</p>
<h3 id="5-1-Errors"><a href="#5-1-Errors" class="headerlink" title="5.1. Errors"></a>5.1. Errors</h3><p>Errors, or more specifically Service Errors, are defined as a client passing invalid data to the service and the service <em>correctly</em>  rejecting that data.<br>Examples include invalid credentials, incorrect parameters, unknown version IDs, or similar.<br>These are generally “4xx” HTTP error codes and are the result of a client passing incorrect or invalid data.</p>
<p>Errors do <em>not</em> contribute to overall API availability.</p>
<h3 id="5-2-Faults"><a href="#5-2-Faults" class="headerlink" title="5.2. Faults"></a>5.2. Faults</h3><p>Faults, or more specifically Service Faults, are defined as the service failing to correctly return in response to a valid client request.<br>These are generally “5xx” HTTP error codes.</p>
<p>Faults _do_ contribute to the overall API availability.</p>
<p>Calls that fail due to rate limiting or quota failures MUST NOT count as faults.<br>Calls that fail as the result of a service fast-failing requests (often for its own protection) do count as faults.</p>
<h3 id="5-3-Latency"><a href="#5-3-Latency" class="headerlink" title="5.3. Latency"></a>5.3. Latency</h3><p>Latency is defined as how long a particular API call takes to complete, measured as closely to the client as possible.<br>This metric applies to both synchronous and asynchronous APIs in the same way.<br>For long running calls, the latency is measured on the initial request and measures how long that call (not the overall operation) takes to complete.</p>
<h3 id="5-4-Time-to-complete"><a href="#5-4-Time-to-complete" class="headerlink" title="5.4. Time to complete"></a>5.4. Time to complete</h3><p>Services that expose long operations MUST track “Time to Complete” metrics around those operations.</p>
<h3 id="5-5-Long-running-API-faults"><a href="#5-5-Long-running-API-faults" class="headerlink" title="5.5. Long running API faults"></a>5.5. Long running API faults</h3><p>For a Long Running API, it’s possible for both the initial request which begins the operation and the request which retrieves the results to technically work (each passing back a 200) but for the underlying operation to have failed.<br>Long Running faults MUST roll up as faults into the overall Availability metrics.</p>
<h2 id="6-Client-guidance"><a href="#6-Client-guidance" class="headerlink" title="6. Client guidance"></a>6. Client guidance</h2><p>To ensure the best possible experience for clients talking to a REST service, clients SHOULD adhere to the following best practices:</p>
<h3 id="6-1-Ignore-rule"><a href="#6-1-Ignore-rule" class="headerlink" title="6.1. Ignore rule"></a>6.1. Ignore rule</h3><p>For loosely coupled clients where the exact shape of the data is not known before the call, if the server returns something the client wasn’t expecting, the client MUST safely ignore it.</p>
<p>Some services MAY add fields to responses without changing versions numbers.<br>Services that do so MUST make this clear in their documentation and clients MUST ignore unknown fields.</p>
<h3 id="6-2-Variable-order-rule"><a href="#6-2-Variable-order-rule" class="headerlink" title="6.2. Variable order rule"></a>6.2. Variable order rule</h3><p>Clients MUST NOT rely on the order in which data appears in JSON service responses.<br>For example, clients SHOULD be resilient to the reordering of fields within a JSON object.<br>When supported by the service, clients MAY request that data be returned in a specific order.<br>For example, services MAY support the use of the <em>$orderBy</em> querystring parameter to specify the order of elements within a JSON array.<br>Services MAY also explicitly specify the ordering of some elements as part of the service contract.<br>For example, a service MAY always return a JSON object’s “type” information as the first field in an object to simplify response parsing on the client.<br>Clients MAY rely on ordering behavior explicitly identified by the service.</p>
<h3 id="6-3-Silent-fail-rule"><a href="#6-3-Silent-fail-rule" class="headerlink" title="6.3. Silent fail rule"></a>6.3. Silent fail rule</h3><p>Clients requesting OPTIONAL server functionality (such as optional headers) MUST be resilient to the server ignoring that particular functionality.</p>
<h2 id="7-Consistency-fundamentals"><a href="#7-Consistency-fundamentals" class="headerlink" title="7. Consistency fundamentals"></a>7. Consistency fundamentals</h2><h3 id="7-1-URL-structure"><a href="#7-1-URL-structure" class="headerlink" title="7.1. URL structure"></a>7.1. URL structure</h3><p>Humans SHOULD be able to easily read and construct URLs.</p>
<p>This facilitates discovery and eases adoption on platforms without a well-supported client library.</p>
<p>An example of a well-structured URL is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.contoso.com/v1.0/people/jdoe@contoso.com/inbox</span><br></pre></td></tr></table></figure>
<p>An example URL that is not friendly is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.contoso.com/EWS/OData/Users(&apos;jdoe@microsoft.com&apos;)/Folders(&apos;AAMkADdiYzI1MjUzLTk4MjQtNDQ1Yy05YjJkLWNlMzMzYmIzNTY0MwAuAAAAAACzMsPHYH6HQoSwfdpDx-2bAQCXhUk6PC1dS7AERFluCgBfAAABo58UAAA=&apos;)</span><br></pre></td></tr></table></figure>
<p>A frequent pattern that comes up is the use of URLs as values.<br>Services MAY use URLs as values.<br>For example, the following is acceptable:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.contoso.com/v1.0/items?url=https://resources.contoso.com/shoes/fancy</span><br></pre></td></tr></table></figure>
<h3 id="7-2-URL-length"><a href="#7-2-URL-length" class="headerlink" title="7.2. URL length"></a>7.2. URL length</h3><p>The HTTP 1.1 message format, defined in RFC 7230, in section <a href="https://tools.ietf.org/html/rfc7230#section-3.1.1" target="_blank" rel="noopener">3.1.1</a>, defines no length limit on the Request Line, which includes the target URL.<br>From the RFC:</p>
<blockquote>
<p>HTTP does not place a predefined limit on the length of a<br>   request-line. […] A server that receives a request-target longer than any URI it wishes to parse MUST respond<br>   with a 414 (URI Too Long) status code.</p>
</blockquote>
<p>Services that can generate URLs longer than 2,083 characters MUST make accommodations for the clients they wish to support.<br>Here are some sources for determining what target clients support:</p>
<ul>
<li><a href="http://stackoverflow.com/a/417184" target="_blank" rel="noopener">http://stackoverflow.com/a/417184</a></li>
<li><a href="https://blogs.msdn.microsoft.com/ieinternals/2014/08/13/url-length-limits/" target="_blank" rel="noopener">https://blogs.msdn.microsoft.com/ieinternals/2014/08/13/url-length-limits/</a></li>
</ul>
<p>Also note that some technology stacks have hard and adjustable URL limits, so keep this in mind as you design your services.</p>
<h3 id="7-3-Canonical-identifier"><a href="#7-3-Canonical-identifier" class="headerlink" title="7.3. Canonical identifier"></a>7.3. Canonical identifier</h3><p>In addition to friendly URLs, resources that can be moved or be renamed SHOULD expose a URL that contains a unique stable identifier.<br>It MAY be necessary to interact with the service to obtain a stable URL from the friendly name for the resource, as in the case of the “/my” shortcut used by some services.</p>
<p>The stable identifier is not required to be a GUID.</p>
<p>An example of a URL containing a canonical identifier is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.contoso.com/v1.0/people/7011042402/inbox</span><br></pre></td></tr></table></figure>
<h3 id="7-4-Supported-methods"><a href="#7-4-Supported-methods" class="headerlink" title="7.4. Supported methods"></a>7.4. Supported methods</h3><p>Operations MUST use the proper HTTP methods whenever possible, and operation idempotency MUST be respected.<br>HTTP methods are frequently referred to as the HTTP verbs.<br>The terms are synonymous in this context, however the HTTP specification uses the term method.</p>
<p>Below is a list of methods that Microsoft REST services SHOULD support.<br>Not all resources will support all methods, but all resources using the methods below MUST conform to their usage.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
<th>Is Idempotent</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Return the current value of an object</td>
<td>True</td>
</tr>
<tr>
<td>PUT</td>
<td>Replace an object, or create a named object, when applicable</td>
<td>True</td>
</tr>
<tr>
<td>DELETE</td>
<td>Delete an object</td>
<td>True</td>
</tr>
<tr>
<td>POST</td>
<td>Create a new object based on the data provided, or submit a command</td>
<td>False</td>
</tr>
<tr>
<td>HEAD</td>
<td>Return metadata of an object for a GET response. Resources that support the GET method MAY support the HEAD method as well</td>
<td>True</td>
</tr>
<tr>
<td>PATCH</td>
<td>Apply a partial update to an object</td>
<td>False</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>Get information about a request; see below for details.</td>
<td>True</td>
</tr>
</tbody>
</table>
<p><small>Table 1</small></p>
<h4 id="7-4-1-POST"><a href="#7-4-1-POST" class="headerlink" title="7.4.1. POST"></a>7.4.1. POST</h4><p>POST operations SHOULD support the Location response header to specify the location of any created resource that was not explicitly named, via the Location header.</p>
<p>As an example, imagine a service that allows creation of hosted servers, which will be named by the service:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST http://api.contoso.com/account1/servers</span><br></pre></td></tr></table></figure>
<p>The response would be something like:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">201 Created</span><br><span class="line"><span class="attribute">Location</span>: http://api.contoso.com/account1/servers/server321</span><br></pre></td></tr></table></figure>
<p>Where “server321” is the service-allocated server name.</p>
<p>Services MAY also return the full metadata for the created item in the response.</p>
<h4 id="7-4-2-PATCH"><a href="#7-4-2-PATCH" class="headerlink" title="7.4.2. PATCH"></a>7.4.2. PATCH</h4><p>PATCH has been standardized by IETF as the method to be used for updating an existing object incrementally (see <a href="http://tools.ietf.org/html/rfc5789" target="_blank" rel="noopener">RFC 5789</a>).<br>Microsoft REST API Guidelines compliant APIs SHOULD support PATCH.</p>
<h4 id="7-4-3-Creating-resources-via-PATCH-UPSERT-semantics"><a href="#7-4-3-Creating-resources-via-PATCH-UPSERT-semantics" class="headerlink" title="7.4.3. Creating resources via PATCH (UPSERT semantics)"></a>7.4.3. Creating resources via PATCH (UPSERT semantics)</h4><p>Services that allow callers to specify key values on create SHOULD support UPSERT semantics, and those that do MUST support creating resources using PATCH.<br>Because PUT is defined as a complete replacement of the content, it is dangerous for clients to use PUT to modify data.<br>Clients that do not understand (and hence ignore) properties on a resource are not likely to provide them on a PUT when trying to update a resource, hence such properties could be inadvertently removed.<br>Services MAY optionally support PUT to update existing resources, but if they do they MUST use replacement semantics (that is, after the PUT, the resource’s properties MUST match what was provided in the request, including deleting any server properties that were not provided).</p>
<p>Under UPSERT semantics, a PATCH call to a nonexistent resource is handled by the server as a “create,” and a PATCH call to an existing resource is handled as an “update.” To ensure that an update request is not treated as a create or vice versa, the client MAY specify precondition HTTP headers in the request.<br>The service MUST NOT treat a PATCH request as an insert if it contains an If-Match header and MUST NOT treat a PATCH request as an update if it contains an If-None-Match header with a value of “*”.</p>
<p>If a service does not support UPSERT, then a PATCH call against a resource that does not exist MUST result in an HTTP “409 Conflict” error.</p>
<h4 id="7-4-4-Options-and-link-headers"><a href="#7-4-4-Options-and-link-headers" class="headerlink" title="7.4.4. Options and link headers"></a>7.4.4. Options and link headers</h4><p>OPTIONS allows a client to retrieve information about a resource, at a minimum by returning the Allow header denoting the valid methods for this resource.</p>
<p>In addition, services SHOULD include a Link header (see <a href="http://tools.ietf.org/html/rfc5988" target="_blank" rel="noopener">RFC 5988</a>) to point to documentation for the resource in question:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Link</span>: &lt;&#123;help&#125;&gt;; rel="help"</span><br></pre></td></tr></table></figure>
<p>Where {help} is the URL to a documentation resource.</p>
<p>For examples on use of OPTIONS, see <a href="http://www.w3.org/TR/cors/#resource-preflight-requests" target="_blank" rel="noopener">preflighting CORS cross-domain calls</a>.</p>
<h3 id="7-5-Standard-request-headers"><a href="#7-5-Standard-request-headers" class="headerlink" title="7.5. Standard request headers"></a>7.5. Standard request headers</h3><p>The table of request headers below SHOULD be used by Microsoft REST API Guidelines services.<br>Using these headers is not mandated, but if used they MUST be used consistently.</p>
<p>All header values MUST follow the syntax rules set forth in the specification where the header field is defined.<br>Many HTTP headers are defined in <a href="https://tools.ietf.org/html/rfc7231" target="_blank" rel="noopener">RFC7231</a>, however a complete list of approved headers can be found in the <a href="http://www.iana.org/assignments/message-headers/message-headers.xhtml" target="_blank" rel="noopener">IANA Header Registry</a>.”</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authorization</td>
<td>String</td>
<td>Authorization header for the request</td>
</tr>
<tr>
<td>Date</td>
<td>Date</td>
<td>Timestamp of the request, based on the client’s clock, in <a href="https://tools.ietf.org/html/rfc5322#section-3.3" target="_blank" rel="noopener">RFC 5322</a> date and time format.  The server SHOULD NOT make any assumptions about the accuracy of the client’s clock.  This header MAY be included in the request, but MUST be in this format when supplied.  Greenwich Mean Time (GMT) MUST be used as the time zone reference for this header when it is provided.  For example: <code>Wed, 24 Aug 2016 18:41:30 GMT</code>.  Note that GMT is exactly equal to UTC (Coordinated Universal Time) for this purpose.</td>
</tr>
<tr>
<td>Accept</td>
<td>Content type</td>
<td>The requested content type for the response such as: <ul><li>application/xml</li><li>text/xml</li><li>application/json</li><li>text/javascript (for JSONP)</li></ul>Per the HTTP guidelines, this is just a hint and responses MAY have a different content type, such as a blob fetch where a successful response will just be the blob stream as the payload. For services following OData, the preference order specified in OData SHOULD be followed.</td>
</tr>
<tr>
<td>Accept-Encoding</td>
<td>Gzip, deflate</td>
<td>REST endpoints SHOULD support GZIP and DEFLATE encoding, when applicable. For very large resources, services MAY ignore and return uncompressed data.</td>
</tr>
<tr>
<td>Accept-Language</td>
<td>“en”, “es”, etc.</td>
<td>Specifies the preferred language for the response. Services are not required to support this, but if a service supports localization it MUST do so through the Accept-Language header.</td>
</tr>
<tr>
<td>Accept-Charset</td>
<td>Charset type like “UTF-8”</td>
<td>Default is UTF-8, but services SHOULD be able to handle ISO-8859-1.</td>
</tr>
<tr>
<td>Content-Type</td>
<td>Content type</td>
<td>Mime type of request body (PUT/POST/PATCH)</td>
</tr>
<tr>
<td>Prefer</td>
<td>return=minimal, return=representation</td>
<td>If the return=minimal preference is specified, services SHOULD return an empty body in response to a successful insert or update. If return=representation is specified, services SHOULD return the created or updated resource in the response. Services SHOULD support this header if they have scenarios where clients would sometimes benefit from responses, but sometimes the response would impose too much of a hit on bandwidth.</td>
</tr>
<tr>
<td>If-Match, If-None-Match, If-Range</td>
<td>String</td>
<td>Services that support updates to resources using optimistic concurrency control MUST support the If-Match header to do so. Services MAY also use other headers related to ETags as long as they follow the HTTP specification.</td>
</tr>
</tbody>
</table>
<h3 id="7-6-Standard-response-headers"><a href="#7-6-Standard-response-headers" class="headerlink" title="7.6. Standard response headers"></a>7.6. Standard response headers</h3><p>Services SHOULD return the following response headers, except where noted in the “required” column.</p>
<table>
<thead>
<tr>
<th>Response Header</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Date</td>
<td>All responses</td>
<td>Timestamp the response was processed, based on the server’s clock, in <a href="https://tools.ietf.org/html/rfc5322#section-3.3" target="_blank" rel="noopener">RFC 5322</a> date and time format.  This header MUST be included in the response.  Greenwich Mean Time (GMT) MUST be used as the time zone reference for this header.  For example: <code>Wed, 24 Aug 2016 18:41:30 GMT</code>. Note that GMT is exactly equal to UTC (Coordinated Universal Time) for this purpose.</td>
</tr>
<tr>
<td>Content-Type</td>
<td>All responses</td>
<td>The content type</td>
</tr>
<tr>
<td>Content-Encoding</td>
<td>All responses</td>
<td>GZIP or DEFLATE, as appropriate</td>
</tr>
<tr>
<td>Preference-Applied</td>
<td>When specified in request</td>
<td>Whether a preference indicated in the Prefer request header was applied</td>
</tr>
<tr>
<td>ETag</td>
<td>When the requested resource has an entity tag</td>
<td>The ETag response-header field provides the current value of the entity tag for the requested variant. Used with If-Match, If-None-Match and If-Range to implement optimistic concurrency control.</td>
</tr>
</tbody>
</table>
<h3 id="7-7-Custom-headers"><a href="#7-7-Custom-headers" class="headerlink" title="7.7. Custom headers"></a>7.7. Custom headers</h3><p>Custom headers MUST NOT be required for the basic operation of a given API.</p>
<p>Some of the guidelines in this document prescribe the use of nonstandard HTTP headers.<br>In addition, some services MAY need to add extra functionality, which is exposed via HTTP headers.<br>The following guidelines help maintain consistency across usage of custom headers.</p>
<p>Headers that are not standard HTTP headers MUST have one of two formats:</p>
<ol>
<li>A generic format for headers that are registered as “provisional” with IANA (<a href="http://www.ietf.org/rfc/rfc3864.txt" target="_blank" rel="noopener">RFC 3864</a>)</li>
<li>A scoped format for headers that are too usage-specific for registration</li>
</ol>
<p>These two formats are described below.</p>
<h3 id="7-8-Specifying-headers-as-query-parameters"><a href="#7-8-Specifying-headers-as-query-parameters" class="headerlink" title="7.8. Specifying headers as query parameters"></a>7.8. Specifying headers as query parameters</h3><p>Some headers pose challenges for some scenarios such as AJAX clients, especially when making cross-domain calls where adding headers MAY not be supported.<br>As such, some headers MAY be accepted as Query Parameters in addition to headers, with the same naming as the header:</p>
<p>Not all headers make sense as query parameters, including most standard HTTP headers.</p>
<p>The criteria for considering when to accept headers as parameters are:</p>
<ol>
<li>Any custom headers MUST be also accepted as parameters.</li>
<li>Required standard headers MAY be accepted as parameters.</li>
<li>Required headers with security sensitivity (e.g., Authorization header) MIGHT NOT be appropriate as parameters; the service owner SHOULD evaluate these on a case-by-case basis.</li>
</ol>
<p>The one exception to this rule is the Accept header.<br>It’s common practice to use a scheme with simple names instead of the full functionality described in the HTTP specification for Accept.</p>
<h3 id="7-9-PII-parameters"><a href="#7-9-PII-parameters" class="headerlink" title="7.9. PII parameters"></a>7.9. PII parameters</h3><p>Consistent with their organization’s privacy policy, clients SHOULD NOT transmit personally identifiable information (PII) parameters in the URL (as part of path or query string) because this information can be inadvertently exposed via client, network, and server logs and other mechanisms.</p>
<p>Consequently, a service SHOULD accept PII parameters transmitted as headers.</p>
<p>However, there are many scenarios where the above recommendations cannot be followed due to client or software limitations.<br>To address these limitations, services SHOULD also accept these PII parameters as part of the URL consistent with the rest of these guidelines.</p>
<p>Services that accept PII parameters – whether in the URL or as headers – SHOULD be compliant with privacy policy specified by their organization’s engineering leadership.<br>This will typically include recommending that clients prefer headers for transmission and implementations adhere to special precautions to ensure that logs and other service data collection are properly handled.</p>
<h3 id="7-10-Response-formats"><a href="#7-10-Response-formats" class="headerlink" title="7.10. Response formats"></a>7.10. Response formats</h3><p>For organizations to have a successful platform, they must serve data in formats developers are accustomed to using, and in consistent ways that allow developers to handle responses with common code.</p>
<p>Web-based communication, especially when a mobile or other low-bandwidth client is involved, has moved quickly in the direction of JSON for a variety of reasons, including its tendency to be lighter weight and its ease of consumption with JavaScript-based clients.</p>
<p>JSON property names SHOULD be camelCased.</p>
<p>Services SHOULD provide JSON as the default encoding.</p>
<h4 id="7-10-1-Clients-specified-response-format"><a href="#7-10-1-Clients-specified-response-format" class="headerlink" title="7.10.1. Clients-specified response format"></a>7.10.1. Clients-specified response format</h4><p>In HTTP, response format SHOULD be requested by the client using the Accept header.<br>This is a hint, and the server MAY ignore it if it chooses to, even if this isn’t typical of well-behaved servers.<br>Clients MAY send multiple Accept headers and the service MAY choose one of them.</p>
<p>The default response format (no Accept header provided) SHOULD be application/json, and all services MUST support application/json.</p>
<table>
<thead>
<tr>
<th>Accept Header</th>
<th>Response type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>application/json</td>
<td>Payload SHOULD be returned as JSON</td>
<td>Also accept text/javascript for JSONP cases</td>
</tr>
</tbody>
</table>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products/user</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br></pre></td></tr></table></figure>
<h4 id="7-10-2-Error-condition-responses"><a href="#7-10-2-Error-condition-responses" class="headerlink" title="7.10.2. Error condition responses"></a>7.10.2. Error condition responses</h4><p>For non-success conditions, developers SHOULD be able to write one piece of code that handles errors consistently across different Microsoft REST API Guidelines services.<br>This allows building of simple and reliable infrastructure to handle exceptions as a separate flow from successful responses.<br>The following is based on the OData v4 JSON spec.<br>However, it is very generic and does not require specific OData constructs.<br>APIs SHOULD use this format even if they are not using other OData constructs.</p>
<p>The error response MUST be a single JSON object.<br>This object MUST have a name/value pair named “error.” The value MUST be a JSON object.</p>
<p>This object MUST contain name/value pairs with the names “code” and “message,” and it MAY contain name/value pairs with the names “target,” “details” and “innererror.”</p>
<p>The value for the “code” name/value pair is a language-independent string.<br>Its value is a service-defined error code that SHOULD be human-readable.<br>This code serves as a more specific indicator of the error than the HTTP error code specified in the response.<br>Services SHOULD have a relatively small number (about 20) of possible values for “code,” and all clients MUST be capable of handling all of them.<br>Most services will require a much larger number of more specific error codes, which are not interesting to all clients.<br>These error codes SHOULD be exposed in the “innererror” name/value pair as described below.<br>Introducing a new value for “code” that is visible to existing clients is a breaking change and requires a version increase.<br>Services can avoid breaking changes by adding new error codes to “innererror” instead.</p>
<p>The value for the “message” name/value pair MUST be a human-readable representation of the error.<br>It is intended as an aid to developers and is not suitable for exposure to end users.<br>Services wanting to expose a suitable message for end users MUST do so through an <a href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/os/odata-json-format-v4.0-os.html#_Instance_Annotations" target="_blank" rel="noopener">annotation</a> or custom property.<br>Services SHOULD NOT localize “message” for the end user, because doing so might make the value unreadable to the app developer who may be logging the value, as well as make the value less searchable on the Internet.</p>
<p>The value for the “target” name/value pair is the target of the particular error (e.g., the name of the property in error).</p>
<p>The value for the “details” name/value pair MUST be an array of JSON objects that MUST contain name/value pairs for “code” and “message,” and MAY contain a name/value pair for “target,” as described above.<br>The objects in the “details” array usually represent distinct, related errors that occurred during the request.<br>See example below.</p>
<p>The value for the “innererror” name/value pair MUST be an object.<br>The contents of this object are service-defined.<br>Services wanting to return more specific errors than the root-level code MUST do so by including a name/value pair for “code” and a nested “innererror.” Each nested “innererror” object represents a higher level of detail than its parent.<br>When evaluating errors, clients MUST traverse through all of the nested “innererrors” and choose the deepest one that they understand.<br>This scheme allows services to introduce new error codes anywhere in the hierarchy without breaking backwards compatibility, so long as old error codes still appear.<br>The service MAY return different levels of depth and detail to different callers.<br>For example, in development environments, the deepest “innererror” MAY contain internal information that can help debug the service.<br>To guard against potential security concerns around information disclosure, services SHOULD take care not to expose too much detail unintentionally.<br>Error objects MAY also include custom server-defined name/value pairs that MAY be specific to the code.<br>Error types with custom server-defined properties SHOULD be declared in the service’s metadata document.<br>See example below.</p>
<p>Error responses MAY contain <a href="http://docs.oasis-open.org/odata/odata-json-format/v4.0/os/odata-json-format-v4.0-os.html#_Instance_Annotations" target="_blank" rel="noopener">annotations</a> in any of their JSON objects.</p>
<p>We recommend that for any transient errors that may be retried, services SHOULD include a Retry-After HTTP header indicating the minimum number of seconds that clients SHOULD wait before attempting the operation again.</p>
<h5 id="ErrorResponse-Object"><a href="#ErrorResponse-Object" class="headerlink" title="ErrorResponse : Object"></a>ErrorResponse : Object</h5><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>error</code></td>
<td>Error</td>
<td>✔</td>
<td>The error object.</td>
</tr>
</tbody>
</table>
<h5 id="Error-Object"><a href="#Error-Object" class="headerlink" title="Error : Object"></a>Error : Object</h5><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>code</code></td>
<td>String (enumerated)</td>
<td>✔</td>
<td>One of a server-defined set of error codes.</td>
</tr>
<tr>
<td><code>message</code></td>
<td>String</td>
<td>✔</td>
<td>A human-readable representation of the error.</td>
</tr>
<tr>
<td><code>target</code></td>
<td>String</td>
<td></td>
<td>The target of the error.</td>
</tr>
<tr>
<td><code>details</code></td>
<td>Error[]</td>
<td></td>
<td>An array of details about specific errors that led to this reported error.</td>
</tr>
<tr>
<td><code>innererror</code></td>
<td>InnerError</td>
<td></td>
<td>An object containing more specific information than the current object about the error.</td>
</tr>
</tbody>
</table>
<h5 id="InnerError-Object"><a href="#InnerError-Object" class="headerlink" title="InnerError : Object"></a>InnerError : Object</h5><table>
<thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>code</code></td>
<td>String</td>
<td></td>
<td>A more specific error code than was provided by the containing error.</td>
</tr>
<tr>
<td><code>innererror</code></td>
<td>InnerError</td>
<td></td>
<td>An object containing more specific information than the current object about the error.</td>
</tr>
</tbody>
</table>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h5><p>Example of “innererror”:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"error"</span>: &#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"BadArgument"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Previous passwords may not be reused"</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"password"</span>,</span><br><span class="line">    <span class="attr">"innererror"</span>: &#123;</span><br><span class="line">      <span class="attr">"code"</span>: <span class="string">"PasswordError"</span>,</span><br><span class="line">      <span class="attr">"innererror"</span>: &#123;</span><br><span class="line">        <span class="attr">"code"</span>: <span class="string">"PasswordDoesNotMeetPolicy"</span>,</span><br><span class="line">        <span class="attr">"minLength"</span>: <span class="string">"6"</span>,</span><br><span class="line">        <span class="attr">"maxLength"</span>: <span class="string">"64"</span>,</span><br><span class="line">        <span class="attr">"characterTypes"</span>: [<span class="string">"lowerCase"</span>,<span class="string">"upperCase"</span>,<span class="string">"number"</span>,<span class="string">"symbol"</span>],</span><br><span class="line">        <span class="attr">"minDistinctCharacterTypes"</span>: <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"innererror"</span>: &#123;</span><br><span class="line">          <span class="attr">"code"</span>: <span class="string">"PasswordReuseNotAllowed"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example, the most basic error code is “BadArgument,” but for clients that are interested, there are more specific error codes in “innererror.”<br>The “PasswordReuseNotAllowed” code may have been added by the service at a later date, having previously only returned “PasswordDoesNotMeetPolicy.”<br>Existing clients do not break when the new error code is added, but new clients MAY take advantage of it.<br>The “PasswordDoesNotMeetPolicy” error also includes additional name/value pairs that allow the client to determine the server’s configuration, validate the user’s input programmatically, or present the server’s constraints to the user within the client’s own localized messaging.</p>
<p>Example of “details”:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"error"</span>: &#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"BadArgument"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"Multiple errors in ContactInfo data"</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"ContactInfo"</span>,</span><br><span class="line">    <span class="attr">"details"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"code"</span>: <span class="string">"NullValue"</span>,</span><br><span class="line">        <span class="attr">"target"</span>: <span class="string">"PhoneNumber"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"Phone number must not be null"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"code"</span>: <span class="string">"NullValue"</span>,</span><br><span class="line">        <span class="attr">"target"</span>: <span class="string">"LastName"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"Last name must not be null"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"code"</span>: <span class="string">"MalformedValue"</span>,</span><br><span class="line">        <span class="attr">"target"</span>: <span class="string">"Address"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"Address is not valid"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example there were multiple problems with the request, with each individual error listed in “details.”</p>
<h3 id="7-11-HTTP-Status-Codes"><a href="#7-11-HTTP-Status-Codes" class="headerlink" title="7.11. HTTP Status Codes"></a>7.11. HTTP Status Codes</h3><p>Standard HTTP Status Codes SHOULD be used; see the HTTP Status Code definitions for more information.</p>
<h3 id="7-12-Client-library-optional"><a href="#7-12-Client-library-optional" class="headerlink" title="7.12. Client library optional"></a>7.12. Client library optional</h3><p>Developers MUST be able to develop on a wide variety of platforms and languages, such as Windows, macOS, Linux, C#, Python, Node.js, and Ruby.</p>
<p>Services SHOULD be able to be accessed from simple HTTP tools such as curl without significant effort.</p>
<p>Service developer portals SHOULD provide the equivalent of “Get Developer Token” to facilitate experimentation and curl support.</p>
<h2 id="8-CORS"><a href="#8-CORS" class="headerlink" title="8. CORS"></a>8. CORS</h2><p>Services compliant with the Microsoft REST API Guidelines MUST support <a href="http://www.w3.org/TR/access-control/" target="_blank" rel="noopener">CORS (Cross Origin Resource Sharing)</a>.<br>Services SHOULD support an allowed origin of CORS * and enforce authorization through valid OAuth tokens.<br>Services SHOULD NOT support user credentials with origin validation.<br>There MAY be exceptions for special cases.</p>
<h3 id="8-1-Client-guidance"><a href="#8-1-Client-guidance" class="headerlink" title="8.1. Client guidance"></a>8.1. Client guidance</h3><p>Web developers usually don’t need to do anything special to take advantage of CORS.<br>All of the handshake steps happen invisibly as part of the standard XMLHttpRequest calls they make.</p>
<p>Many other platforms, such as .NET, have integrated support for CORS.</p>
<h4 id="8-1-1-Avoiding-preflight"><a href="#8-1-1-Avoiding-preflight" class="headerlink" title="8.1.1. Avoiding preflight"></a>8.1.1. Avoiding preflight</h4><p>Because the CORS protocol can trigger preflight requests that add additional round trips to the server, performance-critical apps might be interested in avoiding them.<br>The spirit behind CORS is to avoid preflight for any simple cross-domain requests that old non-CORS-capable browsers were able to make.<br>All other requests require preflight.</p>
<p>A request is “simple” and avoids preflight if its method is GET, HEAD or POST, and if it doesn’t contain any request headers besides Accept, Accept-Language and Content-Language.<br>For POST requests, the Content-Type header is also allowed, but only if its value is “application/x-www-form-urlencoded,” “multipart/form-data” or “text/plain.”<br>For any other headers or values, a preflight request will happen.</p>
<h3 id="8-2-Service-guidance"><a href="#8-2-Service-guidance" class="headerlink" title="8.2. Service guidance"></a>8.2. Service guidance</h3><p> At minimum, services MUST:</p>
<ul>
<li>Understand the Origin request header that browsers send on cross-domain requests, and the Access-Control-Request-Method request header that they send on preflight OPTIONS requests that check for access.</li>
<li>If the Origin header is present in a request:<ul>
<li>If the request uses the OPTIONS method and contains the Access-Control-Request-Method header, then it is a preflight request intended to probe for access before the actual request. Otherwise, it is an actual request. For preflight requests, beyond performing the steps below to add headers, services MUST perform no additional processing and MUST return a 200 OK. For non-preflight requests, the headers below are added in addition to the request’s regular processing.</li>
<li>Add an Access-Control-Allow-Origin header to the response, containing the same value as the Origin request header. Note that this requires services to dynamically generate the header value. Resources that do not require cookies or any other form of <a href="http://www.w3.org/TR/access-control/#user-credentials" target="_blank" rel="noopener">user credentials</a> MAY respond with a wildcard asterisk (*) instead. Note that the wildcard is acceptable here only, and not for any of the other headers described below.</li>
<li>If the caller requires access to a response header that is not in the set of <a href="http://www.w3.org/TR/access-control/#simple-header" target="_blank" rel="noopener">simple response headers</a> (Cache-Control, Content-Language, Content-Type, Expires, Last-Modified, Pragma), then add an Access-Control-Expose-Headers header containing the list of additional response header names the client should have access to.</li>
<li>If the request requires cookies, then add an Access-Control-Allow-Credentials header set to “true.”</li>
<li>If the request was a preflight request (see first bullet), then the service MUST:<ul>
<li>Add an Access-Control-Allow-Headers response header containing the list of request header names the client is permitted to use. This list need only contain headers that are not in the set of <a href="http://www.w3.org/TR/access-control/#simple-header" target="_blank" rel="noopener">simple request headers</a> (Accept, Accept-Language, Content-Language). If there are no restrictions on headers the service accepts, the service MAY simply return the same value as the Access-Control-Request-Headers header sent by the client.</li>
<li>Add an Access-Control-Allow-Methods response header containing the list of HTTP methods the caller is permitted to use.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Add an Access-Control-Max-Age pref response header containing the number of seconds for which this preflight response is valid (and hence can be avoided before subsequent actual requests). Note that while it is customary to use a large value like 2592000 (30 days), many browsers self-impose a much lower limit (e.g., five minutes).</p>
<p>Because browser preflight response caches are notoriously weak, the additional round trip from a preflight response hurts performance.<br>Services used by interactive Web clients where performance is critical SHOULD avoid patterns that cause a preflight request</p>
<ul>
<li>For GET and HEAD calls, avoid requiring request headers that are not part of the simple set above. Allow them to be provided as query parameters instead.<ul>
<li>The Authorization header is not part of the simple set, so the authentication token MUST be sent through the “access_token” query parameter instead, for resources requiring authentication. Note that passing authentication tokens in the URL is not recommended, because it can lead to the token getting recorded in server logs and exposed to anyone with access to those logs. Services that accept authentication tokens through the URL MUST take steps to mitigate the security risks, such as using short-lived authentication tokens, suppressing the auth token from getting logged, and controlling access to server logs.</li>
</ul>
</li>
<li>Avoid requiring cookies. XmlHttpRequest will only send cookies on cross-domain requests if the “withCredentials” attribute is set; this also causes a preflight request.<ul>
<li>Services that require cookie-based authentication MUST use a “dynamic canary” to secure all APIs that accept cookies.</li>
</ul>
</li>
<li>For POST calls, prefer simple Content-Types in the set of (“application/x-www-form-urlencoded,” “multipart/form-data,” “text/plain”) where applicable. Any other Content-Type will induce a preflight request.<ul>
<li>Services MUST NOT contravene other API recommendations in the name of avoiding CORS preflight requests. In particular, in accordance with recommendations, most POST requests will actually require a preflight request due to the Content-Type.</li>
<li>If eliminating preflight is critical, then a service MAY support alternative mechanisms for data transfer, but the RECOMMENDED approach MUST also be supported.</li>
</ul>
</li>
</ul>
<p>In addition, when appropriate services MAY support the JSONP pattern for simple, GET-only cross-domain access.<br>In JSONP, services take a parameter indicating the format (<em>$format=json</em>) and a parameter indicating a callback (<em>$callback=someFunc</em>), and return a text/javascript document containing the JSON response wrapped in a function call with the indicated name.<br>More on JSONP at Wikipedia: <a href="https://en.wikipedia.org/wiki/JSONP" target="_blank" rel="noopener">JSONP</a>.</p>
<h2 id="9-Collections"><a href="#9-Collections" class="headerlink" title="9. Collections"></a>9. Collections</h2><h3 id="9-1-Item-keys"><a href="#9-1-Item-keys" class="headerlink" title="9.1. Item keys"></a>9.1. Item keys</h3><p>Services MAY support durable identifiers for each item in the collection, and that identifier SHOULD be represented in JSON as “id”. These durable identifiers are often used as item keys.</p>
<p>Collections that support durable identifiers MAY support delta queries.</p>
<h3 id="9-2-Serialization"><a href="#9-2-Serialization" class="headerlink" title="9.2. Serialization"></a>9.2. Serialization</h3><p>Collections are represented in JSON using standard array notation.</p>
<h3 id="9-3-Collection-URL-patterns"><a href="#9-3-Collection-URL-patterns" class="headerlink" title="9.3. Collection URL patterns"></a>9.3. Collection URL patterns</h3><p>Collections are located directly under the service root when they are top level, or as a segment under another resource when scoped to that resource.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people</span><br></pre></td></tr></table></figure>
<p>Whenever possible, services MUST support the “/“ pattern.<br>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://&#123;serviceRoot&#125;/&#123;collection&#125;/&#123;id&#125;</span><br></pre></td></tr></table></figure>
<p>Where:</p>
<ul>
<li>{serviceRoot} – the combination of host (site URL) + the root path to the service</li>
<li>{collection} – the name of the collection, unabbreviated, pluralized</li>
<li>{id} – the value of the unique id property. When using the “/“ pattern this MUST be the raw string/number/guid value with no quoting but properly escaped to fit in a URL segment.</li>
</ul>
<h4 id="9-3-1-Nested-collections-and-properties"><a href="#9-3-1-Nested-collections-and-properties" class="headerlink" title="9.3.1. Nested collections and properties"></a>9.3.1. Nested collections and properties</h4><p>Collection items MAY contain other collections.<br>For example, a user collection MAY contain user resources that have multiple addresses:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people/123/addresses</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>: [</span><br><span class="line">    &#123; <span class="attr">"street"</span>: <span class="string">"1st Avenue"</span>, <span class="attr">"city"</span>: <span class="string">"Seattle"</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">"street"</span>: <span class="string">"124th Ave NE"</span>, <span class="attr">"city"</span>: <span class="string">"Redmond"</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-4-Big-collections"><a href="#9-4-Big-collections" class="headerlink" title="9.4. Big collections"></a>9.4. Big collections</h3><p>As data grows, so do collections.<br>Planning for pagination is important for all services.<br>Therefore, when multiple pages are available, the serialization payload MUST contain the opaque URL for the next page as appropriate.<br>Refer to the paging guidance for more details.</p>
<p>Clients MUST be resilient to collection data being either paged or nonpaged for any given request.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>:[</span><br><span class="line">    &#123; <span class="attr">"id"</span>: <span class="string">"Item 1"</span>,<span class="attr">"price"</span>: <span class="number">99.95</span>,<span class="attr">"sizes"</span>: <span class="literal">null</span>&#125;,</span><br><span class="line">    &#123; … &#125;,</span><br><span class="line">    &#123; … &#125;,</span><br><span class="line">    &#123; <span class="attr">"id"</span>: <span class="string">"Item 99"</span>,<span class="attr">"price"</span>: <span class="number">59.99</span>,<span class="attr">"sizes"</span>: <span class="literal">null</span>&#125;</span><br><span class="line">  ],</span><br><span class="line">  "@nextLink": "&#123;opaqueUrl&#125;"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-5-Changing-collections"><a href="#9-5-Changing-collections" class="headerlink" title="9.5. Changing collections"></a>9.5. Changing collections</h3><p>POST requests are not idempotent.<br>This means that two POST requests sent to a collection resource with exactly the same payload MAY lead to multiple items being created in that collection.<br>This is often the case for insert operations on items with a server-side generated id.</p>
<p>For example, the following request:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST https://api.contoso.com/v1.0/people</span><br></pre></td></tr></table></figure>
<p>Would lead to a response indicating the location of the new collection item:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">201 Created</span><br><span class="line"><span class="attribute">Location</span>: https://api.contoso.com/v1.0/people/123</span><br></pre></td></tr></table></figure>
<p>And once executed again, would likely lead to another resource:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">201 Created</span><br><span class="line"><span class="attribute">Location</span>: https://api.contoso.com/v1.0/people/124</span><br></pre></td></tr></table></figure>
<p>While a PUT request would require the indication of the collection item with the corresponding key instead:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT https://api.contoso.com/v1.0/people/123</span><br></pre></td></tr></table></figure>
<h3 id="9-6-Sorting-collections"><a href="#9-6-Sorting-collections" class="headerlink" title="9.6. Sorting collections"></a>9.6. Sorting collections</h3><p>The results of a collection query MAY be sorted based on property values.<br>The property is determined by the value of the <em>$orderBy</em> query parameter.</p>
<p>The value of the <em>$orderBy</em> parameter contains a comma-separated list of expressions used to sort the items.<br>A special case of such an expression is a property path terminating on a primitive property.</p>
<p>The expression MAY include the suffix “asc” for ascending or “desc” for descending, separated from the property name by one or more spaces.<br>If “asc” or “desc” is not specified, the service MUST order by the specified property in ascending order.</p>
<p>NULL values MUST sort as “less than” non-NULL values.</p>
<p>Items MUST be sorted by the result values of the first expression, and then items with the same value for the first expression are sorted by the result value of the second expression, and so on.<br>The sort order is the inherent order for the type of the property.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people?$orderBy=name</span><br></pre></td></tr></table></figure>
<p>Will return all people sorted by name in ascending order.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people?$orderBy=name desc</span><br></pre></td></tr></table></figure>
<p>Will return all people sorted by name in descending order.</p>
<p>Sub-sorts can be specified by a comma-separated list of property names with OPTIONAL direction qualifier.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people?$orderBy=name desc,hireDate</span><br></pre></td></tr></table></figure>
<p>Will return all people sorted by name in descending order and a secondary sort order of hireDate in ascending order.</p>
<p>Sorting MUST compose with filtering such that:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people?$filter=name eq 'david'&amp;$orderBy=hireDate</span><br></pre></td></tr></table></figure>
<p>Will return all people whose name is David sorted in ascending order by hireDate.</p>
<h4 id="9-6-1-Interpreting-a-sorting-expression"><a href="#9-6-1-Interpreting-a-sorting-expression" class="headerlink" title="9.6.1. Interpreting a sorting expression"></a>9.6.1. Interpreting a sorting expression</h4><p>Sorting parameters MUST be consistent across pages, as both client and server-side paging is fully compatible with sorting.</p>
<p>If a service does not support sorting by a property named in a <em>$orderBy</em> expression, the service MUST respond with an error message as defined in the Responding to Unsupported Requests section.</p>
<h3 id="9-7-Filtering"><a href="#9-7-Filtering" class="headerlink" title="9.7. Filtering"></a>9.7. Filtering</h3><p>The <em>$filter</em> querystring parameter allows clients to filter a collection of resources that are addressed by a request URL.<br>The expression specified with <em>$filter</em> is evaluated for each resource in the collection, and only items where the expression evaluates to true are included in the response.<br>Resources for which the expression evaluates to false or to null, or which reference properties that are unavailable due to permissions, are omitted from the response.</p>
<p>Example: return all Products whose Price is less than $10.00</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=price lt 10.00</span><br></pre></td></tr></table></figure>
<p>The value of the <em>$filter</em> option is a Boolean expression.</p>
<h4 id="9-7-1-Filter-operations"><a href="#9-7-1-Filter-operations" class="headerlink" title="9.7.1. Filter operations"></a>9.7.1. Filter operations</h4><p>Services that support <em>$filter</em> SHOULD support the following minimal set of operations.</p>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Comparison Operators</td>
<td></td>
<td></td>
</tr>
<tr>
<td>eq</td>
<td>Equal</td>
<td>city eq ‘Redmond’</td>
</tr>
<tr>
<td>ne</td>
<td>Not equal</td>
<td>city ne ‘London’</td>
</tr>
<tr>
<td>gt</td>
<td>Greater than</td>
<td>price gt 20</td>
</tr>
<tr>
<td>ge</td>
<td>Greater than or equal</td>
<td>price ge 10</td>
</tr>
<tr>
<td>lt</td>
<td>Less than</td>
<td>price lt 20</td>
</tr>
<tr>
<td>le</td>
<td>Less than or equal</td>
<td>price le 100</td>
</tr>
<tr>
<td>Logical Operators</td>
<td></td>
<td></td>
</tr>
<tr>
<td>and</td>
<td>Logical and</td>
<td>price le 200 and price gt 3.5</td>
</tr>
<tr>
<td>or</td>
<td>Logical or</td>
<td>price le 3.5 or price gt 200</td>
</tr>
<tr>
<td>not</td>
<td>Logical negation</td>
<td>not price le 3.5</td>
</tr>
<tr>
<td>Grouping Operators</td>
<td></td>
<td></td>
</tr>
<tr>
<td>( )</td>
<td>Precedence grouping</td>
<td>(priority eq 1 or city eq ‘Redmond’) and price gt 100</td>
</tr>
</tbody>
</table>
<h4 id="9-7-2-Operator-examples"><a href="#9-7-2-Operator-examples" class="headerlink" title="9.7.2. Operator examples"></a>9.7.2. Operator examples</h4><p>The following examples illustrate the use and semantics of each of the logical operators.</p>
<p>Example: all products with a name equal to ‘Milk’</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=name eq 'Milk'</span><br></pre></td></tr></table></figure>
<p>Example: all products with a name not equal to ‘Milk’</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=name ne 'Milk'</span><br></pre></td></tr></table></figure>
<p>Example: all products with the name ‘Milk’ that also have a price less than 2.55:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=name eq 'Milk' and price lt 2.55</span><br></pre></td></tr></table></figure>
<p>Example: all products that either have the name ‘Milk’ or have a price less than 2.55:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=name eq 'Milk' or price lt 2.55</span><br></pre></td></tr></table></figure>
<p>Example 54: all products that have the name ‘Milk’ or ‘Eggs’ and have a price less than 2.55:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/products?$filter=(name eq 'Milk' or name eq 'Eggs') and price lt 2.55</span><br></pre></td></tr></table></figure>
<h4 id="9-7-3-Operator-precedence"><a href="#9-7-3-Operator-precedence" class="headerlink" title="9.7.3. Operator precedence"></a>9.7.3. Operator precedence</h4><p>Services MUST use the following operator precedence for supported operators when evaluating <em>$filter</em> expressions.<br>Operators are listed by category in order of precedence from highest to lowest.<br>Operators in the same category have equal precedence:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Group</th>
<th style="text-align:left">Operator</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Grouping</td>
<td style="text-align:left">( )</td>
<td style="text-align:left">Precedence grouping</td>
</tr>
<tr>
<td style="text-align:left">Unary</td>
<td style="text-align:left">not</td>
<td style="text-align:left">Logical Negation</td>
</tr>
<tr>
<td style="text-align:left">Relational</td>
<td style="text-align:left">gt</td>
<td style="text-align:left">Greater Than</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ge</td>
<td style="text-align:left">Greater than or Equal</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">lt</td>
<td style="text-align:left">Less Than</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">le</td>
<td style="text-align:left">Less than or Equal</td>
</tr>
<tr>
<td style="text-align:left">Equality</td>
<td style="text-align:left">eq</td>
<td style="text-align:left">Equal</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ne</td>
<td style="text-align:left">Not Equal</td>
</tr>
<tr>
<td style="text-align:left">Conditional AND</td>
<td style="text-align:left">and</td>
<td style="text-align:left">Logical And</td>
</tr>
<tr>
<td style="text-align:left">Conditional OR</td>
<td style="text-align:left">or</td>
<td style="text-align:left">Logical Or</td>
</tr>
</tbody>
</table>
<h3 id="9-8-Pagination"><a href="#9-8-Pagination" class="headerlink" title="9.8. Pagination"></a>9.8. Pagination</h3><p>RESTful APIs that return collections MAY return partial sets.<br>Consumers of these services MUST expect partial result sets and correctly page through to retrieve an entire set.</p>
<p>There are two forms of pagination that MAY be supported by RESTful APIs.<br>Server-driven paging mitigates against denial-of-service attacks by forcibly paginating a request over multiple response payloads.<br>Client-driven paging enables clients to request only the number of resources that it can use at a given time.</p>
<p>Sorting and Filtering parameters MUST be consistent across pages, because both client- and server-side paging is fully compatible with both filtering and sorting.</p>
<h4 id="9-8-1-Server-driven-paging"><a href="#9-8-1-Server-driven-paging" class="headerlink" title="9.8.1. Server-driven paging"></a>9.8.1. Server-driven paging</h4><p>Paginated responses MUST indicate a partial result by including a continuation token in the response.<br>The absence of a continuation token means that no additional pages are available.</p>
<p>Clients MUST treat the continuation URL as opaque, which means that query options may not be changed while iterating over a set of partial results.</p>
<p>Example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">http://api.contoso.com/v1.0/people</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  "value": [...],</span><br><span class="line">  "@nextLink": "&#123;opaqueUrl&#125;"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9-8-2-Client-driven-paging"><a href="#9-8-2-Client-driven-paging" class="headerlink" title="9.8.2. Client-driven paging"></a>9.8.2. Client-driven paging</h4><p>Clients MAY use <em>$top</em> and <em>$skip</em> query parameters to specify a number of results to return and an offset into the collection.</p>
<p>The server SHOULD honor the values specified by the client; however, clients MUST be prepared to handle responses that contain a different page size or contain a continuation token.</p>
<p>When both <em>$top</em> and <em>$skip</em> are given by a client, the server SHOULD first apply <em>$skip</em> and then <em>$top</em> on the collection.</p>
<p>Note: If the server can’t honor <em>$top</em> and/or <em>$skip</em>, the server MUST return an error to the client informing about it instead of just ignoring the query options.<br>This will avoid the risk of the client making assumptions about the data returned.</p>
<p>Example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">http://api.contoso.com/v1.0/people?$top=5&amp;$skip=2</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ...,</span><br><span class="line">  "value": [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="9-8-3-Additional-considerations"><a href="#9-8-3-Additional-considerations" class="headerlink" title="9.8.3. Additional considerations"></a>9.8.3. Additional considerations</h4><p><strong>Stable order prerequisite:</strong> Both forms of paging depend on the collection of items having a stable order.<br>The server MUST supplement any specified order criteria with additional sorts (typically by key) to ensure that items are always ordered consistently.</p>
<p><strong>Missing/repeated results:</strong> Even if the server enforces a consistent sort order, results MAY be missing or repeated based on creation or deletion of other resources.<br>Clients MUST be prepared to deal with these discrepancies.<br>The server SHOULD always encode the record ID of the last read record, helping the client in the process of managing repeated/missing results.</p>
<p><strong>Combining client- and server-driven paging:</strong> Note that client-driven paging does not preclude server-driven paging.<br>If the page size requested by the client is larger than the default page size supported by the server, the expected response would be the number of results specified by the client, paginated as specified by the server paging settings.</p>
<p><strong>Page Size:</strong> Clients MAY request server-driven paging with a specific page size by specifying a <em>$maxpagesize</em> preference.<br>The server SHOULD honor this preference if the specified page size is smaller than the server’s default page size.</p>
<p><strong>Paginating embedded collections:</strong> It is possible for both client-driven paging and server-driven paging to be applied to embedded collections.<br>If a server paginates an embedded collection, it MUST include additional continuation tokens as appropriate.</p>
<p><strong>Recordset count:</strong> Developers who want to know the full number of records across all pages, MAY include the query parameter <em>$count=true</em> to tell the server to include the count of items in the response.</p>
<h3 id="9-9-Compound-collection-operations"><a href="#9-9-Compound-collection-operations" class="headerlink" title="9.9. Compound collection operations"></a>9.9. Compound collection operations</h3><p>Filtering, Sorting and Pagination operations MAY all be performed against a given collection.<br>When these operations are performed together, the evaluation order MUST be:</p>
<ol>
<li><strong>Filtering</strong>. This includes all range expressions performed as an AND operation.</li>
<li><strong>Sorting</strong>. The potentially filtered list is sorted according to the sort criteria.</li>
<li><strong>Pagination</strong>. The materialized paginated view is presented over the filtered, sorted list. This applies to both server-driven pagination and client-driven pagination.</li>
</ol>
<h2 id="10-Delta-queries"><a href="#10-Delta-queries" class="headerlink" title="10. Delta queries"></a>10. Delta queries</h2><p>Services MAY choose to support delta queries.</p>
<h3 id="10-1-Delta-links"><a href="#10-1-Delta-links" class="headerlink" title="10.1. Delta links"></a>10.1. Delta links</h3><p>Delta links are opaque, service-generated links that the client uses to retrieve subsequent changes to a result.</p>
<p>At a conceptual level delta links are based on a defining query that describes the set of results for which changes are being tracked.<br>The delta link encodes the collection of entities for which changes are being tracked, along with a starting point from which to track changes.</p>
<p>If the query contains a filter, the response MUST include only changes to entities matching the specified criteria.<br>The key principles of the Delta Query are:</p>
<ul>
<li>Every item in the set MUST have a persistent identifier. That identifier SHOULD be represented as “id”. This identifier is a service defined opaque string that MAY be used by the client to track object across calls.</li>
<li>The delta MUST contain an entry for each entity that newly matches the specified criteria, and MUST contain a “@removed” entry for each entity that no longer matches the criteria.</li>
<li>Re-evaluate the query and compare it to original set of results; every entry uniquely in the current set MUST be returned as an Add operation, and every entry uniquely in the original set MUST be returned as a “remove” operation.</li>
<li>Each entity that previously did not match the criteria but matches it now MUST be returned as an “add”; conversely, each entity that previously matched the query but no longer does MUST be returned as a “@removed” entry.</li>
<li>Entities that have changed MUST be included in the set using their standard representation.</li>
<li>Services MAY add additional metadata to the “@removed” node, such as a reason for removal, or a “removed at” timestamp. We recommend teams coordinate with the Microsoft REST API Guidelines Working Group on extensions to help maintain consistency.</li>
</ul>
<p>The delta link MUST NOT encode any client top or skip value.</p>
<h3 id="10-2-Entity-representation"><a href="#10-2-Entity-representation" class="headerlink" title="10.2. Entity representation"></a>10.2. Entity representation</h3><p>Added and updated entities are represented in the entity set using their standard representation.<br>From the perspective of the set, there is no difference between an added or updated entity.</p>
<p>Removed entities are represented using only their “id” and an “@removed” node.<br>The presence of an “@removed” node MUST represent the removal of the entry from the set.</p>
<h3 id="10-3-Obtaining-a-delta-link"><a href="#10-3-Obtaining-a-delta-link" class="headerlink" title="10.3. Obtaining a delta link"></a>10.3. Obtaining a delta link</h3><p>A delta link is obtained by querying a collection or entity and appending a $delta query string parameter.<br>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/people?$delta</span><br><span class="line">HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "value":[</span><br><span class="line">    &#123; "id": "1", "name": "Matt"&#125;,</span><br><span class="line">    &#123; "id": "2", "name": "Mark"&#125;,</span><br><span class="line">    &#123; "id": "3", "name": "John"&#125;</span><br><span class="line">  ],</span><br><span class="line">  "@deltaLink": "&#123;opaqueUrl&#125;"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note: If the collection is paginated the deltaLink will only be present on the final page but MUST reflect any changes to the data returned across all pages.</p>
<h3 id="10-4-Contents-of-a-delta-link-response"><a href="#10-4-Contents-of-a-delta-link-response" class="headerlink" title="10.4. Contents of a delta link response"></a>10.4. Contents of a delta link response</h3><p>Added/Updated entries MUST appear as regular JSON objects, with regular item properties.<br>Returning the added/modified items in their regular representation allows the client to merge them into their existing “cache” using standard merge concepts based on the “id” field.</p>
<p>Entries removed from the defined collection MUST be included in the response.<br>Items removed from the set MUST be represented using only their “id” and an “@removed” node.</p>
<h3 id="10-5-Using-a-delta-link"><a href="#10-5-Using-a-delta-link" class="headerlink" title="10.5. Using a delta link"></a>10.5. Using a delta link</h3><p>The client requests changes by invoking the GET method on the delta link.<br>The client MUST use the delta URL as is – in other words the client MUST NOT modify the URL in any way (e.g., parsing it and adding additional query string parameters).<br>In this example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">https://&#123;opaqueUrl&#125;</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "value":[</span><br><span class="line">    &#123; "id": "1", "name": "Mat"&#125;,</span><br><span class="line">    &#123; "id": "2", "name": "Marc"&#125;,</span><br><span class="line">    &#123; "id": "3", "@removed": &#123;&#125; &#125;,</span><br><span class="line">    &#123; "id": "4", "name": "Luc"&#125;</span><br><span class="line">  ],</span><br><span class="line">  "@deltaLink": "&#123;opaqueUrl&#125;"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The results of a request against the delta link may span multiple pages but MUST be ordered by the service across all pages in such a way as to ensure a deterministic result when applied in order to the response that contained the delta link.</p>
<p>If no changes have occurred, the response is an empty collection that contains a delta link for subsequent changes if requested.<br>This delta link MAY be identical to the delta link resulting in the empty collection of changes.</p>
<p>If the delta link is no longer valid, the service MUST respond with <em>410 Gone</em>. The response SHOULD include a Location header that the client can use to retrieve a new baseline set of results.</p>
<h2 id="11-JSON-standardizations"><a href="#11-JSON-standardizations" class="headerlink" title="11. JSON standardizations"></a>11. JSON standardizations</h2><h3 id="11-1-JSON-formatting-standardization-for-primitive-types"><a href="#11-1-JSON-formatting-standardization-for-primitive-types" class="headerlink" title="11.1. JSON formatting standardization for primitive types"></a>11.1. JSON formatting standardization for primitive types</h3><p>Primitive values MUST be serialized to JSON following the rules of [RFC8259][rfc-8259]. </p>
<p><strong>Important note for 64bit integers:</strong> JavaScript will silently truncate integers larger than <code>Number.MAX_SAFE_INTEGER</code> (2^53-1) or numbers smaller than <code>Number.MIN_SAFE_INTEGER</code> (-2^53+1). If the service is expected to return integer values outside the range of safe values, strongly consider returning the value as a string in order to maximize interoperability adn avoid data loss.</p>
<h3 id="11-2-Guidelines-for-dates-and-times"><a href="#11-2-Guidelines-for-dates-and-times" class="headerlink" title="11.2. Guidelines for dates and times"></a>11.2. Guidelines for dates and times</h3><h4 id="11-2-1-Producing-dates"><a href="#11-2-1-Producing-dates" class="headerlink" title="11.2.1. Producing dates"></a>11.2.1. Producing dates</h4><p>Services MUST produce dates using the <code>DateLiteral</code> format, and SHOULD use the <code>Iso8601Literal</code> format unless there are compelling reasons to do otherwise.<br>Services that do use the <code>StructuredDateLiteral</code> format MUST NOT produce dates using the <code>T</code> kind unless BOTH the additional precision is REQUIRED, and ECMAScript clients are explicitly unsupported.<br>(Non-Normative statement: When deciding which particular <code>DateKind</code> to standardize on, the approximate order of preference is <code>E, C, U, W, O, X, I, T</code>.<br>This optimizes for ECMAScript, .NET, and C++ programmers, in that order.)</p>
<h4 id="11-2-2-Consuming-dates"><a href="#11-2-2-Consuming-dates" class="headerlink" title="11.2.2. Consuming dates"></a>11.2.2. Consuming dates</h4><p>Services MUST accept dates from clients that use the same <code>DateLiteral</code> format (including the <code>DateKind</code>, if applicable) that they produce, and SHOULD accept dates using any <code>DateLiteral</code> format.</p>
<h4 id="11-2-3-Compatibility"><a href="#11-2-3-Compatibility" class="headerlink" title="11.2.3. Compatibility"></a>11.2.3. Compatibility</h4><p>Services MUST use the same <code>DateLiteral</code> format (including the same <code>DateKind</code>, if applicable) for all resources of the same type, and SHOULD use the same <code>DateLiteral</code> format (and <code>DateKind</code>, if applicable) for all resources across the entire service.</p>
<p>Any change to the <code>DateLiteral</code> format produced by the service (including the <code>DateKind</code>, if applicable) and any reductions in the <code>DateLiteral</code> formats (and <code>DateKind</code>, if applicable) accepted by the service MUST be treated as a breaking change.<br>Any widening of the <code>DateLiteral</code> formats accepted by the service is NOT considered a breaking change.</p>
<h3 id="11-3-JSON-serialization-of-dates-and-times"><a href="#11-3-JSON-serialization-of-dates-and-times" class="headerlink" title="11.3. JSON serialization of dates and times"></a>11.3. JSON serialization of dates and times</h3><p>Round-tripping serialized dates with JSON is a hard problem.<br>Although ECMAScript supports literals for most built-in types, it does not define a literal format for dates.<br>The Web has coalesced around the <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.15" target="_blank" rel="noopener">ECMAScript subset of ISO 8601 date formats (ISO 8601)</a>, but there are situations where this format is not desirable.<br>For those cases, this document defines a JSON serialization format that can be used to unambiguously represent dates in different formats.<br>Other serialization formats (such as XML) could be derived from this format.</p>
<h4 id="11-3-1-The-DateLiteral-format"><a href="#11-3-1-The-DateLiteral-format" class="headerlink" title="11.3.1. The DateLiteral format"></a>11.3.1. The <code>DateLiteral</code> format</h4><p>Dates represented in JSON are serialized using the following grammar.<br>Informally, a <code>DateValue</code> is either an ISO 8601-formatted string or a JSON object containing two properties named <code>kind</code> and <code>value</code> that together define a point in time.<br>The following is not a context-free grammar; in particular, the interpretation of <code>DateValue</code> depends on the value of <code>DateKind</code>, but this minimizes the number of productions required to describe the format.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">DateLiteral:</span><br><span class="line">  Iso8601Literal</span><br><span class="line">  StructuredDateLiteral</span><br><span class="line"></span><br><span class="line">Iso8601Literal:</span><br><span class="line">  A string literal as defined in http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.15. Note that the full grammar for ISO 8601 (such as &quot;basic format&quot; without separators) is not supported.</span><br><span class="line">  All dates default to UTC unless specified otherwise.</span><br><span class="line"></span><br><span class="line">StructuredDateLiteral:</span><br><span class="line">  &#123; DateKindProperty , DateValueProperty &#125;</span><br><span class="line">  &#123; DateValueProperty , DateKindProperty &#125;</span><br><span class="line"></span><br><span class="line">DateKindProperty</span><br><span class="line">  &quot;kind&quot; : DateKind</span><br><span class="line"></span><br><span class="line">DateKind:</span><br><span class="line">  &quot;C&quot;            ; see below</span><br><span class="line">  &quot;E&quot;            ; see below</span><br><span class="line">  &quot;I&quot;            ; see below</span><br><span class="line">  &quot;O&quot;            ; see below</span><br><span class="line">  &quot;T&quot;            ; see below</span><br><span class="line">  &quot;U&quot;            ; see below</span><br><span class="line">  &quot;W&quot;            ; see below</span><br><span class="line">  &quot;X&quot;            ; see below</span><br><span class="line"></span><br><span class="line">DateValueProperty:</span><br><span class="line">  &quot;value&quot; : DateValue</span><br><span class="line"></span><br><span class="line">DateValue:</span><br><span class="line">  UnsignedInteger        ; not defined here</span><br><span class="line">  SignedInteger        ; not defined here</span><br><span class="line">  RealNumber        ; not defined here</span><br><span class="line">  Iso8601Literal        ; as above</span><br></pre></td></tr></table></figure>
<h4 id="11-3-2-Commentary-on-date-formatting"><a href="#11-3-2-Commentary-on-date-formatting" class="headerlink" title="11.3.2. Commentary on date formatting"></a>11.3.2. Commentary on date formatting</h4><p>A <code>DateLiteral</code> using the <code>Iso8601Literal</code> production is relatively straightforward.<br>Here is an example of an object with a property named <code>creationDate</code> that is set to February 13, 2015, at 1:15 p.m. UTC:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">"creationDate"</span> : <span class="string">"2015-02-13T13:15Z"</span> &#125;</span><br></pre></td></tr></table></figure>
<p>The <code>StructuredDateLiteral</code> consists of a <code>DateKind</code> and an accompanying <code>DateValue</code> whose valid values (and their interpretation) depend on the <code>DateKind</code>. The following table describes the valid combinations and their meaning:</p>
<table>
<thead>
<tr>
<th>DateKind</th>
<th>DateValue</th>
<th>Colloquial Name &amp; Interpretation</th>
<th>More Info</th>
</tr>
</thead>
<tbody>
<tr>
<td>C</td>
<td>UnsignedInteger</td>
<td>“CLR”; number of milliseconds since midnight January 1, 0001; negative values are not allowed. <em>See note below.</em></td>
<td><a href="https://msdn.microsoft.com/en-us/library/System.DateTime(v=vs.110).aspx" target="_blank" rel="noopener">MSDN</a></td>
</tr>
<tr>
<td>E</td>
<td>SignedInteger</td>
<td>“ECMAScript”; number of milliseconds since midnight, January 1, 1970.</td>
<td><a href="http://www.ecma-international.org/ecma-262/5.1/#sec-15.9.1.1" target="_blank" rel="noopener">ECMA International</a></td>
</tr>
<tr>
<td>I</td>
<td>Iso8601Literal</td>
<td>“ISO 8601”; a string limited to the ECMAScript subset.</td>
<td></td>
</tr>
<tr>
<td>O</td>
<td>RealNumber</td>
<td>“OLE Date”; integral part is the number of days since midnight, December 31, 1899, and fractional part is the time within the day (0.5 = midday).</td>
<td><a href="https://docs.microsoft.com/en-us/windows/desktop/api/oleauto/nf-oleauto-varianttimetosystemtime" target="_blank" rel="noopener">MSDN</a></td>
</tr>
<tr>
<td>T</td>
<td>SignedInteger</td>
<td>“Ticks”; number of ticks (100-nanosecond intervals) since midnight January 1, 1601. <em>See note below.</em></td>
<td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724290(v=vs.85).aspx" target="_blank" rel="noopener">MSDN</a></td>
</tr>
<tr>
<td>U</td>
<td>SignedInteger</td>
<td>“UNIX”; number of seconds since midnight, January 1, 1970.</td>
<td><a href="https://msdn.microsoft.com/en-us/library/1f4c8f33.aspx" target="_blank" rel="noopener">MSDN</a></td>
</tr>
<tr>
<td>W</td>
<td>SignedInteger</td>
<td>“Windows”; number of milliseconds since midnight January 1, 1601. <em>See note below.</em></td>
<td><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724290(v=vs.85).aspx" target="_blank" rel="noopener">MSDN</a></td>
</tr>
<tr>
<td>X</td>
<td>RealNumber</td>
<td>“Excel”; as for <code>O</code> but the year 1900 is incorrectly treated as a leap year, and day 0 is “January 0 (zero).”</td>
<td><a href="http://support.microsoft.com/kb/214326?wa=wsignin1.0" target="_blank" rel="noopener">Microsoft Support</a></td>
</tr>
</tbody>
</table>
<p><strong>Important note for <code>C</code> and <code>W</code> kinds:</strong> The native CLR and Windows times are represented by 100-nanosecond “tick” values.<br>To interoperate with ECMAScript clients that have limited precision, <em>these values MUST be converted to and from milliseconds</em> when (de)serialized as a <code>DateLiteral</code>.<br>One millisecond is equivalent to 10,000 ticks.</p>
<p><strong>Important note for <code>T</code> kind:</strong> This kind preserves the full fidelity of the Windows native time formats (and is trivially convertible to and from the native CLR format) but is incompatible with ECMAScript clients.<br>Therefore, its use SHOULD be limited to only those scenarios that both require the additional precision and do not need to interoperate with ECMAScript clients.</p>
<p>Here is the same example of an object with a property named creationDate that is set to February 13, 2015, at 1:15 p.m. UTC, using several formats:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">"creationDate"</span> : &#123; <span class="attr">"kind"</span> : <span class="string">"O"</span>, <span class="attr">"value"</span> : <span class="number">42048.55</span> &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">"creationDate"</span> : &#123; <span class="attr">"kind"</span> : <span class="string">"E"</span>, <span class="attr">"value"</span> : <span class="number">1423862100000</span> &#125; &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>One of the benefits of separating the kind from the value is that once a client knows the kind used by a particular service, it can interpret the value without requiring any additional parsing.<br>In the common case of the value being a number, this makes coding easier for developers:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// We know this service always gives out ECMAScript-format dates</span></span><br><span class="line"><span class="keyword">var</span> date = <span class="keyword">new</span> Date(serverResponse.someObject.creationDate.<span class="keyword">value</span>);</span><br></pre></td></tr></table></figure>
<h3 id="11-4-Durations"><a href="#11-4-Durations" class="headerlink" title="11.4. Durations"></a>11.4. Durations</h3><p><a href="http://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener">Durations</a> need to be serialized in conformance with <a href="http://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener">ISO 8601</a>.<br>Durations are “represented by the format <code>P[n]Y[n]M[n]DT[n]H[n]M[n]S</code>.”<br>From the standard:</p>
<ul>
<li>P is the duration designator (historically called “period”) placed at the start of the duration representation.</li>
<li>Y is the year designator that follows the value for the number of years.</li>
<li>M is the month designator that follows the value for the number of months.</li>
<li>W is the week designator that follows the value for the number of weeks.</li>
<li>D is the day designator that follows the value for the number of days.</li>
<li>T is the time designator that precedes the time components of the representation.</li>
<li>H is the hour designator that follows the value for the number of hours.</li>
<li>M is the minute designator that follows the value for the number of minutes.</li>
<li>S is the second designator that follows the value for the number of seconds.</li>
</ul>
<p>For example, “P3Y6M4DT12H30M5S” represents a duration of “three years, six months, four days, twelve hours, thirty minutes, and five seconds.”</p>
<h3 id="11-5-Intervals"><a href="#11-5-Intervals" class="headerlink" title="11.5. Intervals"></a>11.5. Intervals</h3><p><a href="http://en.wikipedia.org/wiki/ISO_8601#Time_intervals" target="_blank" rel="noopener">Intervals</a> are defined as part of <a href="http://en.wikipedia.org/wiki/ISO_8601#Time_intervals" target="_blank" rel="noopener">ISO 8601</a>.</p>
<ul>
<li>Start and end, such as “2007-03-01T13:00:00Z/2008-05-11T15:30:00Z”</li>
<li>Start and duration, such as “2007-03-01T13:00:00Z/P1Y2M10DT2H30M”</li>
<li>Duration and end, such as “P1Y2M10DT2H30M/2008-05-11T15:30:00Z”</li>
<li>Duration only, such as “P1Y2M10DT2H30M,” with additional context information</li>
</ul>
<h3 id="11-6-Repeating-intervals"><a href="#11-6-Repeating-intervals" class="headerlink" title="11.6. Repeating intervals"></a>11.6. Repeating intervals</h3><p><a href="http://en.wikipedia.org/wiki/ISO_8601#Repeating_intervals" target="_blank" rel="noopener">Repeating Intervals</a>, as per <a href="http://en.wikipedia.org/wiki/ISO_8601#Repeating_intervals" target="_blank" rel="noopener">ISO 8601</a>, are:</p>
<blockquote>
<p>Formed by adding “R[n]/“ to the beginning of an interval expression, where R is used as the letter itself and [n] is replaced by the number of repetitions.<br>Leaving out the value for [n] means an unbounded number of repetitions.</p>
</blockquote>
<p>For example, to repeat the interval of “P1Y2M10DT2H30M” five times starting at “2008-03-01T13:00:00Z,” use “R5/2008-03-01T13:00:00Z/P1Y2M10DT2H30M.”</p>
<h2 id="12-Versioning"><a href="#12-Versioning" class="headerlink" title="12. Versioning"></a>12. Versioning</h2><p><strong>All APIs compliant with the Microsoft REST API Guidelines MUST support explicit versioning.</strong> It’s critical that clients can count on services to be stable over time, and it’s critical that services can add features and make changes.</p>
<h3 id="12-1-Versioning-formats"><a href="#12-1-Versioning-formats" class="headerlink" title="12.1. Versioning formats"></a>12.1. Versioning formats</h3><p>Services are versioned using a Major.Minor versioning scheme.<br>Services MAY opt for a “Major” only version scheme in which case the “.0” is implied and all other rules in this section apply.<br>Two options for specifying the version of a REST API request are supported:</p>
<ul>
<li>Embedded in the path of the request URL, at the end of the service root: <code>https://api.contoso.com/v1.0/products/users</code></li>
<li>As a query string parameter of the URL: <code>https://api.contoso.com/products/users?api-version=1.0</code></li>
</ul>
<p>Guidance for choosing between the two options is as follows:</p>
<ol>
<li>Services co-located behind a DNS endpoint MUST use the same versioning mechanism.</li>
<li>In this scenario, a consistent user experience across the endpoint is paramount. The Microsoft REST API Guidelines Working Group recommends that new top-level DNS endpoints are not created without explicit conversations with your organization’s leadership team.</li>
<li>Services that guarantee the stability of their REST API’s URL paths, even through future versions of the API, MAY adopt the query string parameter mechanism. This means the naming and structure of the relationships described in the API cannot evolve after the API ships, even across versions with breaking changes.</li>
<li>Services that cannot ensure URL path stability across future versions MUST embed the version in the URL path.</li>
</ol>
<p>Certain bedrock services such as Microsoft’s Azure Active Directory may be exposed behind multiple endpoints.<br>Such services MUST support the versioning mechanisms of each endpoint, even if that means supporting multiple versioning mechanisms.</p>
<h4 id="12-1-1-Group-versioning"><a href="#12-1-1-Group-versioning" class="headerlink" title="12.1.1. Group versioning"></a>12.1.1. Group versioning</h4><p>Group versioning is an OPTIONAL feature that MAY be offered on services using the query string parameter mechanism.<br>Group versions allow for logical grouping of API endpoints under a common versioning moniker.<br>This allows developers to look up a single version number and use it across multiple endpoints.<br>Group version numbers are well known, and services SHOULD reject any unrecognized values.</p>
<p>Internally, services will take a Group Version and map it to the appropriate Major.Minor version.</p>
<p>The Group Version format is defined as YYYY-MM-DD, for example 2012-12-07 for December 7, 2012. This Date versioning format applies only to Group Versions and SHOULD NOT be used as an alternative to Major.Minor versioning.</p>
<h5 id="Examples-of-group-versioning"><a href="#Examples-of-group-versioning" class="headerlink" title="Examples of group versioning"></a>Examples of group versioning</h5><table>
<thead>
<tr>
<th style="text-align:left">Group</th>
<th style="text-align:left">Major.Minor</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">2012-12-01</td>
<td style="text-align:left">1.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">1.1</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">1.2</td>
</tr>
<tr>
<td style="text-align:left">2013-03-21</td>
<td style="text-align:left">1.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">2.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">3.0</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">3.1</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">3.2</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">3.3</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Version Format</th>
<th>Example</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td>{groupVersion}</td>
<td>2013-03-21, 2012-12-01</td>
<td>3.3, 1.2</td>
</tr>
<tr>
<td>{majorVersion}</td>
<td>3</td>
<td>3.0</td>
</tr>
<tr>
<td>{majorVersion}.{minorVersion}</td>
<td>1.2</td>
<td>1.2</td>
</tr>
</tbody>
</table>
<p>Clients can specify either the group version or the Major.Minor version:</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http://api.contoso.com/acct1/c1/blob2?api-version=1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT http://api.contoso.com/acct1/c1/b2?api-version=2011-12-07</span><br></pre></td></tr></table></figure>
<h3 id="12-2-When-to-version"><a href="#12-2-When-to-version" class="headerlink" title="12.2. When to version"></a>12.2. When to version</h3><p>Services MUST increment their version number in response to any breaking API change.<br>See the following section for a detailed discussion of what constitutes a breaking change.<br>Services MAY increment their version number for nonbreaking changes as well, if desired.</p>
<p>Use a new major version number to signal that support for existing clients will be deprecated in the future.<br>When introducing a new major version, services MUST provide a clear upgrade path for existing clients and develop a plan for deprecation that is consistent with their business group’s policies.<br>Services SHOULD use a new minor version number for all other changes.</p>
<p>Online documentation of versioned services MUST indicate the current support status of each previous API version and provide a path to the latest version.</p>
<h3 id="12-3-Definition-of-a-breaking-change"><a href="#12-3-Definition-of-a-breaking-change" class="headerlink" title="12.3. Definition of a breaking change"></a>12.3. Definition of a breaking change</h3><p>Changes to the contract of an API are considered a breaking change.<br>Changes that impact the backwards compatibility of an API are a breaking change.</p>
<p>Teams MAY define backwards compatibility as their business needs require.<br>For example, Azure defines the addition of a new JSON field in a response to be not backwards compatible.<br>Office 365 has a looser definition of backwards compatibility and allows JSON fields to be added to responses.</p>
<p>Clear examples of breaking changes:</p>
<ol>
<li>Removing or renaming APIs or API parameters</li>
<li>Changes in behavior for an existing API</li>
<li>Changes in Error Codes and Fault Contracts</li>
<li>Anything that would violate the <a href="http://en.wikipedia.org/wiki/Principle_of_least_astonishment" target="_blank" rel="noopener">Principle of Least Astonishment</a></li>
</ol>
<p>Services MUST explicitly define their definition of a breaking change, especially with regard to adding new fields to JSON responses and adding new API arguments with default fields.<br>Services that are co-located behind a DNS Endpoint with other services MUST be consistent in defining contract extensibility.</p>
<p>The applicable changes described <a href="http://docs.oasis-open.org/odata/odata/v4.0/errata02/os/complete/part1-protocol/odata-v4.0-errata02-os-part1-protocol-complete.html#_Toc406398209" target="_blank" rel="noopener">in this section of the OData V4 spec</a> SHOULD be considered part of the minimum bar that all services MUST consider a breaking change.</p>
<h2 id="13-Long-running-operations"><a href="#13-Long-running-operations" class="headerlink" title="13. Long running operations"></a>13. Long running operations</h2><p>Long running operations, sometimes called async operations, tend to mean different things to different people.<br>This section sets forth guidance around different types of long running operations, and describes the wire protocols and best practices for these types of operations.</p>
<ol>
<li>One or more clients MUST be able to monitor and operate on the same resource at the same time.</li>
<li>The state of the system SHOULD be discoverable and testable at all times. Clients SHOULD be able to determine the system state even if the operation tracking resource is no longer active. The act of querying the state of a long running operation should itself leverage principles of the web. i.e. well-defined resources with uniform interface semantics. Clients MAY issue a GET on some resource to determine the state of a long running operation</li>
<li>Long running operations SHOULD work for clients looking to “Fire and Forget” and for clients looking to actively monitor and act upon results.</li>
<li>Cancellation does not explicitly mean rollback. On a per-API defined case it may mean rollback, or compensation, or completion, or partial completion, etc. Following a cancelled operation, It SHOULD NOT be a client’s responsibility to return the service to a consistent state which allows continued service.</li>
</ol>
<h3 id="13-1-Resource-based-long-running-operations-RELO"><a href="#13-1-Resource-based-long-running-operations-RELO" class="headerlink" title="13.1. Resource based long running operations (RELO)"></a>13.1. Resource based long running operations (RELO)</h3><p>Resource based modeling is where the status of an operation is encoded in the resource and the wire protocol used is the standard synchronous protocol.<br>In this model state transitions are well defined and goal states are similarly defined.</p>
<p><em>This is the preferred model for long running operations and should be used wherever possible.</em> Avoiding the complexity and mechanics of the LRO Wire Protocol makes things simpler for our users and tooling chain.</p>
<p>An example may be a machine reboot, where the operation itself completes synchronously but the GET operation on the virtual machine resource would have a “state: Rebooting”, “state: Running” that could be queried at any time.</p>
<p>This model MAY integrate Push Notifications.</p>
<p>While most operations are likely to be POST semantics, in addition to POST semantics, services MAY support PUT semantics via routing to simplify their APIs.<br>For example, a user that wants to create a database named “db1” could call:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT https://api.contoso.com/v1.0/databases/db1</span><br></pre></td></tr></table></figure>
<p>In this scenario the databases segment is processing the PUT operation.</p>
<p>Services MAY also use the hybrid defined below.</p>
<h3 id="13-2-Stepwise-long-running-operations"><a href="#13-2-Stepwise-long-running-operations" class="headerlink" title="13.2. Stepwise long running operations"></a>13.2. Stepwise long running operations</h3><p>A stepwise operation is one that takes a long, and often unpredictable, length of time to complete, and doesn’t offer state transition modeled in the resource.<br>This section outlines the approach that services should use to expose such long running operations.</p>
<p>Service MAY expose stepwise operations.</p>
<blockquote>
<p>Stepwise Long Running Operations are sometimes called “Async” operations.<br>This causes confusion, as it mixes elements of platforms (“Async / await”, “promises”, “futures”) with elements of API operation.<br>This document uses the term “Stepwise Long Running Operation” or often just “Stepwise Operation” to avoid confusion over the word “Async”.</p>
</blockquote>
<p>Services MUST perform as much synchronous validation as practical on stepwise requests.<br>Services MUST prioritize returning errors in a synchronous way, with the goal of having only “Valid” operations processed using the long running operation wire protocol.</p>
<p>For an API that’s defined as a Stepwise Long Running Operation the service MUST go through the Stepwise Long Running Operation flow even if the operation can be completed immediately.<br>In other words, APIs must adopt and stick with an LRO pattern and not change patterns based on circumstance.</p>
<h4 id="13-2-1-PUT"><a href="#13-2-1-PUT" class="headerlink" title="13.2.1. PUT"></a>13.2.1. PUT</h4><p>Services MAY enable PUT requests for entity creation.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT https://api.contoso.com/v1.0/databases/db1</span><br></pre></td></tr></table></figure>
<p>In this scenario the <em>databases</em> segment is processing the PUT operation.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">Operation-Location</span>: https://api.contoso.com/v1.0/operations/123</span><br></pre></td></tr></table></figure>
<p>For services that need to return a 201 Created here, use the hybrid flow described below.</p>
<p>The 202 Accepted should return no body.<br>The 201 Created case should return the body of the target resource.</p>
<h4 id="13-2-2-POST"><a href="#13-2-2-POST" class="headerlink" title="13.2.2. POST"></a>13.2.2. POST</h4><p>Services MAY enable POST requests for entity creation.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST https://api.contoso.com/v1.0/databases/</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "fileName": "someFile.db",</span><br><span class="line">  "color": "red"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">Operation-Location</span>: https://api.contoso.com/v1.0/operations/123</span><br></pre></td></tr></table></figure>
<h4 id="13-2-3-POST-hybrid-model"><a href="#13-2-3-POST-hybrid-model" class="headerlink" title="13.2.3. POST, hybrid model"></a>13.2.3. POST, hybrid model</h4><p>Services MAY respond synchronously to POST requests to collections that create a resource even if the resources aren’t fully created when the response is generated.<br>In order to use this pattern, the response MUST include a representation of the incomplete resource and an indication that it is incomplete.</p>
<p>For example:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">https://api.contoso.com/v1.0/databases/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: api.contoso.com</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "fileName": "someFile.db",</span><br><span class="line">  "color": "red"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service response says the database has been created, but indicates the request is not completed by including the Operation-Location header.<br>In this case the status property in the response payload also indicates the operation has not fully completed.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">201</span> Created</span><br><span class="line"><span class="attribute">Location</span>: https://api.contoso.com/v1.0/databases/db1</span><br><span class="line"><span class="attribute">Operation-Location</span>: https://api.contoso.com/v1.0/operations/123</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "databaseName": "db1",</span><br><span class="line">  "color": "red",</span><br><span class="line">  "Status": "Provisioning",</span><br><span class="line">  [ … other fields for "database" …]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13-2-4-Operations-resource"><a href="#13-2-4-Operations-resource" class="headerlink" title="13.2.4. Operations resource"></a>13.2.4. Operations resource</h4><p>Services MAY provide a “/operations” resource at the tenant level.</p>
<p>Services that provide the “/operations” resource MUST provide GET semantics.<br>GET MUST enumerate the set of operations, following standard pagination, sorting, and filtering semantics.<br>The default sort order for this operation MUST be:</p>
<table>
<thead>
<tr>
<th>Primary Sort</th>
<th>Secondary Sort</th>
</tr>
</thead>
<tbody>
<tr>
<td>Not Started Operations</td>
<td>Operation Creation Time</td>
</tr>
<tr>
<td>Running Operations</td>
<td>Operation Creation Time</td>
</tr>
<tr>
<td>Completed Operations</td>
<td>Operation Creation Time</td>
</tr>
</tbody>
</table>
<p>Note that “Completed Operations” is a goal state (see below), and may actually be any of several different states such as “successful”, “cancelled”, “failed” and so forth.</p>
<h4 id="13-2-5-Operation-resource"><a href="#13-2-5-Operation-resource" class="headerlink" title="13.2.5. Operation resource"></a>13.2.5. Operation resource</h4><p>An operation is a user addressable resource that tracks a stepwise long running operation.<br>Operations MUST support GET semantics.<br>The GET operation against an operation MUST return:</p>
<ol>
<li>The operation resource, it’s state, and any extended state relevant to the particular API.</li>
<li>200 OK as the response code.</li>
</ol>
<p>Services MAY support operation cancellation by exposing DELETE on the operation.<br>If supported DELETE operations MUST be idempotent.</p>
<blockquote>
<p>Note: From an API design perspective, cancellation does not explicitly mean rollback.<br>On a per-API defined case it may mean rollback, or compensation, or completion, or partial completion, etc.<br>Following a cancelled operation, It SHOULD NOT be a client’s responsibility to return the service to a consistent state which allows continued service.</p>
</blockquote>
<p>Services that do not support operation cancellation MUST return a 405 Method Not Allowed in the event of a DELETE.</p>
<p>Operations MUST support the following states:</p>
<ol>
<li>NotStarted</li>
<li>Running</li>
<li>Succeeded. Terminal State.</li>
<li>Failed. Terminal State.</li>
</ol>
<p>Services MAY add additional states, such as “Cancelled” or “Partially Completed”. Services that support cancellation MUST sufficiently describe their cancellation such that the state of the system can be accurately determined, and any compensating actions may be run.</p>
<p>Services that support additional states should consider this list of canonical names and avoid creating new names if possible: Cancelling, Cancelled, Aborting, Aborted, Tombstone, Deleting, Deleted.</p>
<p>An operation MUST contain, and provide in the GET response, the following information:</p>
<ol>
<li>The timestamp when the operation was created.</li>
<li>A timestamp for when the current state was entered.</li>
<li>The operation state (notstarted / running / completed).</li>
</ol>
<p>Services MAY add additional, API specific, fields into the operation.<br>The operation status JSON returned looks like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"createdDateTime"</span>: <span class="string">"2015-06-19T12-01-03.45Z"</span>,</span><br><span class="line">  <span class="attr">"lastActionDateTime"</span>: <span class="string">"2015-06-19T12-01-03.45Z"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"notstarted | running | succeeded | failed"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Percent-complete"><a href="#Percent-complete" class="headerlink" title="Percent complete"></a>Percent complete</h5><p>Sometimes it is impossible for services to know with any accuracy when an operation will complete.<br>Which makes using the Retry-After header problematic.<br>In that case, services MAY include, in the operationStatus JSON, a percent complete field.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"createdDateTime"</span>: <span class="string">"2015-06-19T12-01-03.45Z"</span>,</span><br><span class="line">  <span class="attr">"percentComplete"</span>: <span class="string">"50"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"running"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this example the server has indicated to the client that the long running operation is 50% complete.</p>
<h5 id="Target-resource-location"><a href="#Target-resource-location" class="headerlink" title="Target resource location"></a>Target resource location</h5><p>For operations that result in, or manipulate, a resource the service MUST include the target resource location in the status upon operation completion.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"createdDateTime"</span>: <span class="string">"2015-06-19T12-01-03.45Z"</span>,</span><br><span class="line">  <span class="attr">"lastActionDateTime"</span>: <span class="string">"2015-06-19T12-06-03.0024Z"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"succeeded"</span>,</span><br><span class="line">  <span class="attr">"resourceLocation"</span>: <span class="string">"https://api.contoso.com/v1.0/databases/db1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13-2-6-Operation-tombstones"><a href="#13-2-6-Operation-tombstones" class="headerlink" title="13.2.6. Operation tombstones"></a>13.2.6. Operation tombstones</h4><p>Services MAY choose to support tombstoned operations.<br>Services MAY choose to delete tombstones after a service defined period of time.</p>
<h4 id="13-2-7-The-typical-flow-polling"><a href="#13-2-7-The-typical-flow-polling" class="headerlink" title="13.2.7. The typical flow, polling"></a>13.2.7. The typical flow, polling</h4><ul>
<li>Client invokes a stepwise operation by invoking an action using POST</li>
<li>The server MUST indicate the request has been started by responding with a 202 Accepted status code. The response SHOULD include the location header containing a URL that the client should poll for the results after waiting the number of seconds specified in the Retry-After header.</li>
<li>Client polls the location until receiving a 200 response with a terminal operation state. </li>
</ul>
<h5 id="Example-of-the-typical-flow-polling"><a href="#Example-of-the-typical-flow-polling" class="headerlink" title="Example of the typical flow, polling"></a>Example of the typical flow, polling</h5><p>Client invokes the restart action:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">https://api.contoso.com/v1.0/databases</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "fromFile": "myFile.db",</span><br><span class="line">  "color": "red"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The server response indicates the request has been created.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">Operation-Location</span>: https://api.contoso.com/v1.0/operations/123</span><br></pre></td></tr></table></figure>
<p>Client waits for a period of time then invokes another request to try to get the operation status.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/operations/123</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br></pre></td></tr></table></figure>
<p>Server responds that results are still not ready and optionally provides a recommendation to wait 30 seconds.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Retry-After</span>: 30</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "createdDateTime": "2015-06-19T12-01-03.4Z",</span><br><span class="line">  "status": "running"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client waits the recommended 30 seconds and then invokes another request to get the results of the operation.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/v1.0/operations/123</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br></pre></td></tr></table></figure>
<p>Server responds with a “status:succeeded” operation that includes the resource location.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "createdDateTime": "2015-06-19T12-01-03.45Z",</span><br><span class="line">  "lastActionDateTime": "2015-06-19T12-06-03.0024Z",</span><br><span class="line">  "status": "succeeded",</span><br><span class="line">  "resourceLocation": "https://api.contoso.com/v1.0/databases/db1"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13-2-8-The-typical-flow-push-notifications"><a href="#13-2-8-The-typical-flow-push-notifications" class="headerlink" title="13.2.8. The typical flow, push notifications"></a>13.2.8. The typical flow, push notifications</h4><ol>
<li>Client invokes a long running operation by invoking an action using POST. The client has a push notification already setup on the parent resource.</li>
<li>The service indicates the request has been started by responding with a 202 Accepted status code. The client ignores everything else.</li>
<li>Upon completion of the overall operation the service pushes a notification via the subscription on the parent resource.</li>
<li>The client retrieves the operation result via the resource URL.</li>
</ol>
<h5 id="Example-of-the-typical-flow-push-notifications-existing-subscription"><a href="#Example-of-the-typical-flow-push-notifications-existing-subscription" class="headerlink" title="Example of the typical flow, push notifications existing subscription"></a>Example of the typical flow, push notifications existing subscription</h5><p>Client invokes the backup action.<br>The client already has a push notification subscription setup for db1.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">https://api.contoso.com/v1.0/databases/db1?backup</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br></pre></td></tr></table></figure>
<p>The server response indicates the request has been accepted.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">Operation-Location</span>: https://api.contoso.com/v1.0/operations/123</span><br></pre></td></tr></table></figure>
<p>The caller ignores all the headers in the return.</p>
<p>The target URL receives a push notification when the operation is complete.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "value": [</span><br><span class="line">    &#123;</span><br><span class="line">      "subscriptionId": "1234-5678-1111-2222",</span><br><span class="line">      "context": "subscription context that was specified at setup",</span><br><span class="line">      "resourceUrl": "https://api.contoso.com/v1.0/databases/db1",</span><br><span class="line">      "userId" : "contoso.com/user@contoso.com",</span><br><span class="line">      "tenantId" : "contoso.com"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="13-2-9-Retry-After"><a href="#13-2-9-Retry-After" class="headerlink" title="13.2.9. Retry-After"></a>13.2.9. Retry-After</h4><p>In the examples above the Retry-After header indicates the number of seconds that the client should wait before trying to get the result from the URL identified by the location header.</p>
<p>The HTTP specification allows the Retry-After header to alternatively specify a HTTP date, so clients should be prepared to handle this as well.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">Operation-Location</span>: http://api.contoso.com/v1.0/operations/123</span><br><span class="line"><span class="attribute">Retry-After</span>: 60</span><br></pre></td></tr></table></figure>
<p>Note: The use of the HTTP Date is inconsistent with the use of ISO 8601 Date Format used throughout this document, but is explicitly defined by the HTTP standard in [RFC 7231][rfc-7231-7-1-1-1]. Services SHOULD prefer the integer number of seconds (in decimal) format over the HTTP date format.</p>
<h3 id="13-3-Retention-policy-for-operation-results"><a href="#13-3-Retention-policy-for-operation-results" class="headerlink" title="13.3. Retention policy for operation results"></a>13.3. Retention policy for operation results</h3><p>In some situations, the result of a long running operation is not a resource that can be addressed.<br>For example, if you invoke a long running Action that returns a Boolean (rather than a resource).<br>In these situations, the Location header points to a place where the Boolean result can be retrieved.</p>
<p>Which begs the question: “How long should operation results be retained?”</p>
<p>A recommended minimum retention time is 24 hours.</p>
<p>Operations SHOULD transition to “tombstone” for an additional period of time prior to being purged from the system.</p>
<h2 id="14-Throttling-Quotas-and-Limits"><a href="#14-Throttling-Quotas-and-Limits" class="headerlink" title="14. Throttling, Quotas, and Limits"></a>14. Throttling, Quotas, and Limits</h2><h3 id="14-1-Principles"><a href="#14-1-Principles" class="headerlink" title="14.1. Principles"></a>14.1. Principles</h3><p>Services should be as responsive as possible, so as not to block callers.<br>As a rule of thumb any API call that is expected to take longer than 0.5 seconds in the 99th percentile, should consider using the Long-running Operations pattern for those calls.<br>Obviously, services cannot guarantee these response times in the face of potentially unlimited load from callers. Services should therefore design and document call request limits for clients, and respond with appropriate, actionable errors and error messages if these limits are exceeded.<br>Services should respond quickly with an error when they are generally overloaded, rather than simply respond slowly.<br>Finally, many services will have quotas on calls, perhaps a number of operations per hour or day, usually related to a service plan or price.<br>When these quotas are exceeded services must also provide immediate, actionable errors.<br>Quotas and Limits should be scoped to a customer unit: a subscription, a tenant, an application, a plan, or without any other identification a range of ip addresses…as appropriate to the service goals so that the load is properly shared and one unit is not interfering with another.</p>
<h3 id="14-2-Return-Codes-429-vs-503"><a href="#14-2-Return-Codes-429-vs-503" class="headerlink" title="14.2. Return Codes (429 vs 503)"></a>14.2. Return Codes (429 vs 503)</h3><p>HTTP specifies two return codes for these scenarios: ‘429 Too Many Requests’ and ‘503 Service Unavailable’.<br>Services should use 429 for cases where clients are making too many calls and can fix the situation by changing their call pattern.<br>Services should respond with 503 in cases where general load or other problems outside the control of the individual callers is responsible for the service becoming slow.<br>In all cases, services should also provide information suggesting how long the callers should wait before trying in again.<br>Clients should respect these headers and also implement other transient fault handling techniques.<br>However, there may be clients that simply retry immediately upon failure, potentially increasing the load on the service.<br>To handle this, services should design so that returning 429 or 503 is as inexpensive as possible, either by putting in special fastpath code, or ideally by depending on a common frontdoor or load balancer that provides this functionality.</p>
<h3 id="14-3-Retry-After-and-RateLimit-Headers"><a href="#14-3-Retry-After-and-RateLimit-Headers" class="headerlink" title="14.3. Retry-After and RateLimit Headers"></a>14.3. Retry-After and RateLimit Headers</h3><p>The Retry-After header is the standard way for responding to clients who are being throttled.<br>It is also common, but optional, in the case of limits and quotas (but not overall system load) to respond with header describing the limit that was exceeded.<br>However, services across Microsoft and the industry use a wide range of different headers for this purpose.<br>We recommend using three headers to describe the limit, the number of calls remaining under the limit, and the time when the limit will reset.<br>However, other headers may be appropriate for specific types of limits. In all cases these must be documented. </p>
<h3 id="14-4-Service-Guidance"><a href="#14-4-Service-Guidance" class="headerlink" title="14.4. Service Guidance"></a>14.4. Service Guidance</h3><p>Services should choose time windows as appropriate for the SLAs or business objectives.<br>In the case of Quotas, the Retry-After time and time window may be very long (hours, days, weeks, even months. Services use 429 to indicate the specific caller has made too many calls, and 503 to indicate that the service is load shedding but that it is not the caller’s responsibility.</p>
<h4 id="14-4-1-Responsiveness"><a href="#14-4-1-Responsiveness" class="headerlink" title="14.4.1. Responsiveness"></a>14.4.1. Responsiveness</h4><ol>
<li>Services MUST respond quickly in all circumstances, even when under load.</li>
<li>Calls that take longer than 1s to respond in the 99th percentile SHOULD use the Long-Running Operation pattern</li>
<li>Calls that take longer than 0.5s to respond in the 99th percentile should strongly consider the LRO pattern</li>
<li>Services SHOULD NOT introduce sleeps, pauses, etc. that block callers or are not actionable (“tar-pitting”).</li>
</ol>
<h4 id="14-4-2-Rate-Limits-and-Quotas"><a href="#14-4-2-Rate-Limits-and-Quotas" class="headerlink" title="14.4.2. Rate Limits and Quotas"></a>14.4.2. Rate Limits and Quotas</h4><p>When a caller has made too many calls</p>
<ol>
<li>Services MUST return a 429 code</li>
<li>Services MUST return a standard error response describing the specifics so that a programmer can make appropriate changes</li>
<li>Services MUST return a Retry-After header that indicates how long clients should wait before retrying</li>
<li>Services MAY return RateLimit headers that document the limit or quota that has been exceeded</li>
<li>Services MAY return RateLimit-Limit: the number of calls the client is allowed to make in a time window</li>
<li>Services MAY return RateLimit-Remaining: the number of calls remaining in the time window</li>
<li>Services MAY return RateLimit-Reset: the time at which the window resets in UTC epoch seconds</li>
<li>Services MAY return other service specific RateLimit headers as appropriate for more detailed information or specific limits or quotas</li>
</ol>
<h4 id="14-4-3-Overloaded-services"><a href="#14-4-3-Overloaded-services" class="headerlink" title="14.4.3. Overloaded services"></a>14.4.3. Overloaded services</h4><p>When services are generally overloaded and  load shedding</p>
<ol>
<li>Services MUST Return a 503 code</li>
<li>Services MUST Return a standard error response (see 7.10.2) describing the specifics so that a programmer can make appropriate changes</li>
<li>Services MUST Return a Retry-After header that indicates how long clients should wait before retrying</li>
<li>In the 503 case, the service SHOULD NOT return RateLimit headers</li>
</ol>
<h4 id="14-4-4-Example-Response"><a href="#14-4-4-Example-Response" class="headerlink" title="14.4.4. Example Response"></a>14.4.4. Example Response</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">429</span> Too Many Requests</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="attribute">Retry-After</span>: 5</span><br><span class="line"><span class="attribute">RateLimit-Limit</span>: 1000</span><br><span class="line"><span class="attribute">RateLimit-Remaining</span>: 0</span><br><span class="line"><span class="attribute">RateLimit-Reset</span>: 1538152773</span><br><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "code": "requestLimitExceeded",</span><br><span class="line">    "message": "The caller has made too many requests in the time period.",</span><br><span class="line">    "details": &#123;</span><br><span class="line">      "code": "RateLimit",</span><br><span class="line">       "limit": "1000",</span><br><span class="line">       "remaining": "0",</span><br><span class="line">       "reset": "1538152773",</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-5-Caller-Guidance"><a href="#14-5-Caller-Guidance" class="headerlink" title="14.5. Caller Guidance"></a>14.5. Caller Guidance</h3><p>Callers include all users of the API: tools, portals, other services, not just user clients</p>
<ol>
<li>Callers MUST wait for a minimum of time indicated in a response with a Retry-After before retrying a request.</li>
<li>Callers MAY assume that request is retriable after receiving a response with a Retry-After header without making any changes to the request.</li>
<li>Clients SHOULD use shared SDKs and common transient fault libraries to implement the proper behavior</li>
</ol>
<p>See: <a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/transient-faults" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/azure/architecture/best-practices/transient-faults</a></p>
<h3 id="14-6-Handling-callers-that-ignore-Retry-After-headers"><a href="#14-6-Handling-callers-that-ignore-Retry-After-headers" class="headerlink" title="14.6. Handling callers that ignore Retry-After headers"></a>14.6. Handling callers that ignore Retry-After headers</h3><p>Ideally, 429 and 503 returns are so low cost that even clients that retry immediately can be handled.<br>In these cases, if possible the service team should make an effort to contact or fix the client.<br>If it is a known partner, a bug or incident should be filed.<br>In extreme cases it may be necessary to use DoS style protections such as blocking the caller. </p>
<h2 id="15-Push-notifications-via-webhooks"><a href="#15-Push-notifications-via-webhooks" class="headerlink" title="15. Push notifications via webhooks"></a>15. Push notifications via webhooks</h2><h3 id="15-1-Scope"><a href="#15-1-Scope" class="headerlink" title="15.1. Scope"></a>15.1. Scope</h3><p>Services MAY implement push notifications via web hooks.<br>This section addresses the following key scenario:</p>
<blockquote>
<p>Push notification via HTTP Callbacks, often called Web Hooks, to publicly-addressable servers.</p>
</blockquote>
<p>The approach set forth is chosen due to its simplicity, broad applicability, and low barrier to entry for service subscribers.<br>It’s intended as a minimal set of requirements and as a starting point for additional functionality.</p>
<h3 id="15-2-Principles"><a href="#15-2-Principles" class="headerlink" title="15.2. Principles"></a>15.2. Principles</h3><p>The core principles for services that support web hooks are:</p>
<ol>
<li>Services MUST implement at least a poke/pull model. In the poke/pull model, a notification is sent to a client, and clients then send a request to get the current state or the record of change since their last notification. This approach avoids complexities around message ordering, missed messages, and change sets.  Services MAY add more data to provide rich notifications.</li>
<li>Services MUST implement the challenge/response protocol for configuring callback URLs.</li>
<li>Services SHOULD have a recommended age-out period, with flexibility for services to vary based on scenario.</li>
<li>Services SHOULD allow subscriptions that are raising successful notifications to live forever and SHOULD be tolerant of reasonable outage periods.</li>
<li>Firehose subscriptions MUST be delivered only over HTTPS. Services SHOULD require other subscription types to be HTTPS. See the “Security” section for more details.</li>
</ol>
<h3 id="15-3-Types-of-subscriptions"><a href="#15-3-Types-of-subscriptions" class="headerlink" title="15.3. Types of subscriptions"></a>15.3. Types of subscriptions</h3><p>There are two subscription types, and services MAY implement either, both, or none.<br>The supported subscription types are:</p>
<ol>
<li>Firehose subscriptions – a subscription is manually created for the subscribing application, typically in an app registration portal.  Notifications of activity that any users have consented to the app receiving are sent to this single subscription.</li>
<li>Per-resource subscriptions – the subscribing application uses code to programmatically create a subscription at runtime for some user-specific entity(s).</li>
</ol>
<p>Services that support both subscription types SHOULD provide differentiated developer experiences for the two types:</p>
<ol>
<li>Firehose – Services MUST NOT require developers to create code except to directly verify and respond to notifications.  Services MUST provide administrative UI for subscription management.  Services SHOULD NOT assume that end users are aware of the subscription, only the subscribing application’s functionality.</li>
<li>Per-user – Services MUST provide an API for developers to create and manage subscriptions as part of their app as well as verifying and responding to notifications.  Services MAY expect end users to be aware of subscriptions and MUST allow end users to revoke subscriptions where they were created directly in response to user actions.</li>
</ol>
<h3 id="15-4-Call-sequences"><a href="#15-4-Call-sequences" class="headerlink" title="15.4. Call sequences"></a>15.4. Call sequences</h3><p>The call sequence for a firehose subscription MUST follow the diagram below.<br>It shows manual registration of application and subscription, and then the end user making use of one of the service’s APIs.<br>At this part of the flow, two things MUST be stored:</p>
<ol>
<li>The service MUST store the end user’s act of consent to receiving notifications from this specific application (typically a background usage OAUTH scope.)</li>
<li>The subscribing application MUST store the end user’s tokens in order to call back for details once notified of changes.</li>
</ol>
<p>The final part of the sequence is the notification flow itself.</p>
<p>Non-normative implementation guidance:  A resource in the service changes and the service needs to run the following logic:</p>
<ol>
<li>Determine the set of users who have access to the resource, and could thus expect apps to receive notifications about it on their behalf.</li>
<li>See which of those users have consented to receiving notifications and from which apps.</li>
<li>See which apps have registered a firehose subscription.</li>
<li>Join 1, 2, 3 to produce the concrete set of notifications that must be sent to apps.</li>
</ol>
<p>It should be noted that the act of user consent and the act of setting up a firehose subscription could arrive in either order.<br>Services SHOULD send notifications with setup processed in either order.</p>
<p><img src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=bm90ZSBvdmVyIERldmVsb3BlciwgQXV0b21hdGlvbiwgQXBwIFNlcnZlcjogCiAgICAgQW4AEAUAJwkgbGlrZSBNb3ZpZU1ha2VyACAGV2FudHMgdG8gaW50ZWdyYXRlIHdpdGggcHJpbWFyeSBzZXJ2aWNlADcGRHJvcGJveAplbmQgbm90ZQoAgQwLQiBQb3J0YWwsIERCAIEJBVJlZ2lzdHIAgRkHREIgTm90aWZpYwCBLAVzACEGdXRoACsFUwBgBjogVGhlAF0eAIF_CkNsaWVudAAtBmVuZCB1c2VycycgYnJvd3NlciBvciBpbnN0YWxsZWQgYXBwCgCBIQwAgiQgAIFABQCBIS8AgQoGIDogTWFudWFsAIFzEQoKCgCDAgo8LS0-AIIqCiA6IExvZ2luIGludG8Agj8JAII1ECBVWCAKACoKLT4gKwCCWBM6AIQGBU5hbWUgZXRjLgCDFQ4AGxJDb25maXJtAIEBCEFjY2VzcyBUb2tlbgoKAIM3EyAtPiAtAINkCQBnBklEAIEMCwCBVQUAhQIMAIR3CmNvcGllcwArCACCIHAAhHMMAIMKDwCDABg6IHdlYmhvb2sgcgCCeg4AgnUSAIVQDToAhXYHZXIAgwgGAIcTBgBECVVSTCwgU2NvcGUAhzIGSUQKTgCGPQwAhhwNIACDBh4AHhEAgxEPbgCBagwAgxwNAIMaDiAAgx0MbWF5IGNvcHkALREAhVtqAIZHB0F1dGhvcml6AIY7BwCGXQctPiArAIEuDVJlcXVlc3QgYQCFOQZ0byBEQiBwcm90ZWN0ZWQgaW5mb3IAiiQGCgCDBQstPiAtAIctCVJlZGlyZWN0ADYHAGwNIGVuZHBvaW50AIoWBmEADw1yAHYGAIEQDACJVAcASwtlZAAYHgCICAgAMAcAcA4AhGoGAE0FAIEdFmJhY2sgdG8AhF8NaXRoIGNvZGUAghoaaQCBagcAgToHAD0JAII-B3MAPgsAglEHAEsFAIIzDgCBXw0Agn8GdG9rZW5zACcSAI0_BXJpZ2h0IG9mAItpDUNhY2hlIHRoYXQgdGhpcyBVc2VyIElEIHByb3ZpZGVkAINNCwCIZgoAggcJAIN7D3Nwb25zAI0_BwCECgYsIHJlZnJlc2gsIGFuZCBJRACBHAcAgQMPAIYADQCBDAcAgUUGYnkAjFkFIElEAIQkG3R1cm4AhF4MIHRvIGMAjR8FAIwRagCJVw1GbG93AIYqCQCMaQgAgmoKaGFuZ2UAj3YFAIFXBWRhdGEgLSB0eXBpY2FsIHZpYQCQDgVyYWN0aW5nAJAPBgCJQQt2aWEAjnsHCgCPNgogAIhDEACKZw0AkFMFAIkBDwCDDAUAgkYWKwBNCwCHWApjAIEyBQCHRg0AhWUHYWNoAIQeDACEfwVhbmQgInNpbmNlIgCFEQYAkSQOAIR3CgCNfwcAhHQFAIpQEACBUgsAhFAcAII8BWFuZCBuZXcAYRQAhFUTOiBVcGRhdGUgc3RhdHUAgSkGAIFDBQAxEwoKCg&amp;s=mscgen" alt="Firehose subscription setup"></p>
<p>For a per-user subscription, app registration is either manual or automated.<br>The call flow for a per-user subscription MUST follow the diagram below.<br>It shows the end user making use of one of the service’s APIs, and again, the same two things MUST be stored:</p>
<ol>
<li>The service MUST store the end user’s act of consent to receiving notifications from this specific application (typically a background usage OAUTH scope).   </li>
<li>The subscribing application MUST store the end user’s tokens in order to call back for details once notified of changes.  </li>
</ol>
<p>In this case, the subscription is set up programmatically using the end-user’s token from the subscribing application.<br>The app MUST store the ID of the registered subscription alongside the user tokens.</p>
<p>Non normative implementation guidance: In the final part of the sequence, when an item of data in the service changes and the service needs to run the following logic:</p>
<ol>
<li>Find the set of subscriptions that correspond via resource to the data that changed.</li>
<li>For subscriptions created under an app+user token, send a notification to the app per subscription with the subscription ID and user id of the subscription-creator.</li>
</ol>
<ul>
<li><p>For subscriptions created with an app only token, check that the owner of the changed data or any user that has visibility of the changed data has consented to notifications to the application, and if so send a set of notifications per user id to the app per subscription with the subscription ID.</p>
<p><img src="http://www.websequencediagrams.com/cgi-bin/cdraw?lz=bm90ZSBvdmVyIERldmVsb3BlciwgQXV0b21hdGlvbiwgQXBwIFNlcnZlcjogCiAgICAgQW4AEAUAJwkgbGlrZSBNb3ZpZU1ha2VyACAGV2FudHMgdG8gaW50ZWdyYXRlIHdpdGggcHJpbWFyeSBzZXJ2aWNlADcGRHJvcGJveAplbmQgbm90ZQoAgQwLQiBQb3J0YWwsIERCAIEJBVJlZ2lzdHIAgRkHREIgTm90aWZpYwCBLAVzACEGdXRoACsFUwBgBjogVGhlAF0eAIF_CkNsaWVudAAtBmVuZCB1c2VycycgYnJvd3NlciBvciBpbnN0YWxsZWQgYXBwCgCBIQwAgiQgAIFABQCBIS8AgQoGIDoAgWwRCgphbHQAgyUIAIEHBiByABQMICAAgxsLPC0tPgCDTws6IENvbmZpZ3VyZQogIACDaAsgLT4gKwCCWBMAegZOYW1lIGV0Yy4AhAgFAIMaDQAfEgBdBXJtAIQ_BUFjY2VzcyBUb2tlAIETBgCDOxIgLT4gLQCBFgxBcHAgSUQAhHwIY3JldACBGxAtPgCFFgsgOiBFbWJlZAAkFGVsc2UgTWFudWFsAIIEJACEbQkgOiBMb2dpbiBpbnRvAIUBCQCBKRFVWACGGAUALQoAgh8mAIIZKwCBCAcAgjoNAIIsHACGLwkAgj8IAIESDgCECAYAh1ELAIdFCmNvcGllcwAuCGVuZACEeGoAhWQHQXV0aG9yaXoAhV8HAIV6By0-ICsAg2ANUmVxdWVzdCBhAIRVBnRvIERCIHByb3RlY3RlZCBpbmZvcgCJQQYKAIQaCy0-IC0AhkoJUmVkaXJlY3QANgcAbA0gZW5kcG9pbnQAiTMGYQAPDXIAdgYAgRAMAIhxBwBLC2VkABgeAIRjCAAwB0EAcQxVWAoASQgAgRwWYmFjayB0bwCFdAwAilwFY29kZQCCGRppAIFpBwCBOQcAPQkAgj0HcwA-CwCCUAcASwUAgjIOAIFeDQCCfgZ0b2tlbnMAJxIAjFsFcmlnaHQgb2YAiwUNQ2FjaGUgdGhhdCB0aGlzIFVzZXIgSUQgcHJvdmlkZWQAg0wLAIU6BwCCBAwAg3oPc3BvbnMAjFsHAIQJBiwgcmVmcmVzaCwgYW5kIElEAIEcBwCBAw8AiDENAIEMBwCBRQZieQCLdQUgSUQAhCMbdHVybgCEXQwgdG8gYwCMOwUKCgCLL2oAjXUMAIwTDwCPNQotPisAjhwQOgCORQdlcgCMVwYAg3YIZWJob29rIFVSTCwgU2NvcGUAkAEGSUQAjwoOAI5rDSAAi2UKAINFBQCLYw0AHBEAgzUOOiBuAIE2DABgCACDCB1oZQCBaQ5JRACDYwUAahIAghB4RmxvdwCJMwkAjE0IAIV0CmhhbmdlAJIcBQCEYQVkYXRhIC0gdHlwaWNhbCB2aWEAkjQFcmFjdGluZwCSNQYAjV8LdmlhAJEhBwoAkVwKIACNfhAAhAsNAJJ5BQCCWQ8AhhYFAIVQFisATQsAimEKYwCBMgUAik8NAIhvB2FjaACHKAwAiAkFYW5kICJzaW5jZSIAiBsGAJNKDgCIAQoAhB0cAIFSCwCHWhwAgjwFYW5kIG5ldwBhFACHXxM6IFVwZGF0ZSBzdGF0dQCBKQYAgUMFADETCgoK&amp;s=mscgen" alt="User subscription setup"></p>
</li>
</ul>
<h3 id="15-5-Verifying-subscriptions"><a href="#15-5-Verifying-subscriptions" class="headerlink" title="15.5. Verifying subscriptions"></a>15.5. Verifying subscriptions</h3><p>When subscriptions change either programmatically or in response to change via administrative UI portals, the subscribing service needs to be protected from malicious or unexpected calls from services pushing potentially large volumes of notification traffic.</p>
<p>For all subscriptions, whether firehose or per-user, services MUST send a verification request as part of creation or modification via portal UI or API request, before sending any other notifications.</p>
<p>Verification requests MUST be of the following format as an HTTP/HTTPS POST to the subscription’s <em>notificationUrl</em>.</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST https://&#123;notificationUrl&#125;?validationToken=&#123;randomString&#125;</span><br><span class="line"><span class="attribute">ClientState</span>: clientOriginatedOpaqueToken (if provided by client on subscription-creation)</span><br><span class="line"><span class="attribute">Content-Length</span>: 0</span><br></pre></td></tr></table></figure>
<p>For the subscription to be set up, the application MUST respond with 200 OK to this request, with the <em>validationToken</em> value as the sole entity body.<br>Note that if the <em>notificationUrl</em> contains query parameters, the <em>validationToken</em> parameter must be appended with an <code>&amp;</code>.</p>
<p>If any challenge request does not receive the prescribed response within 5 seconds of sending the request, the service MUST return an error, MUST NOT create the subscription, and MUST NOT send further requests or notifications to <em>notificationUrl</em>.</p>
<p>Services MAY perform additional validations on URL ownership.</p>
<h3 id="15-6-Receiving-notifications"><a href="#15-6-Receiving-notifications" class="headerlink" title="15.6. Receiving notifications"></a>15.6. Receiving notifications</h3><p>Services SHOULD send notifications in response to service data changes that do not include details of the changes themselves, but include enough information for the subscribing application to respond appropriately to the following process:</p>
<ol>
<li>Applications MUST identify the correct cached OAuth token to use for a callback</li>
<li>Applications MAY look up any previous delta token for the relevant scope of change</li>
<li>Applications MUST determine the URL to call to perform the relevant query for the new state of the service, which MAY be a delta query.</li>
</ol>
<p>Services that are providing notifications that will be relayed to end users MAY choose to add more detail to notification packets in order to reduce incoming call load on their service.<br> Such services MUST be clear that notifications are not guaranteed to be delivered and may be lossy or out of order.</p>
<p>Notifications MAY be aggregated and sent in batches.<br>Applications MUST be prepared to receive multiple events inside a single push notification.</p>
<p>The service MUST send all Web Hook data notifications as POST requests.</p>
<p>Services MUST allow for a 30-second timeout for notifications.<br>If a timeout occurs or the application responds with a 5xx response, then the service SHOULD retry the notification with exponential back-off.<br>All other responses will be ignored.</p>
<p>The service MUST NOT follow 301/302 redirect requests.</p>
<h4 id="15-6-1-Notification-payload"><a href="#15-6-1-Notification-payload" class="headerlink" title="15.6.1. Notification payload"></a>15.6.1. Notification payload</h4><p>The basic format for notification payloads is a list of events, each containing the id of the subscription whose referenced resources have changed, the type of change, the resource that should be consumed to identify the exact details of the change and sufficient identity information to look up the token required to call that resource.</p>
<p>For a firehose subscription, a concrete example of this may look like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"subscriptionId"</span>: <span class="string">"32b8cbd6174ab18b"</span>,</span><br><span class="line">      <span class="attr">"resource"</span>: <span class="string">"https://api.contoso.com/v1.0/users/user@contoso.com/files?$delta"</span>,</span><br><span class="line">      <span class="attr">"userId"</span> : <span class="string">"&lt;User GUID&gt;"</span>,</span><br><span class="line">      <span class="attr">"tenantId"</span> : <span class="string">"&lt;Tenant Id&gt;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For a per-user subscription, a concrete example of this may look like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"subscriptionId"</span>: <span class="string">"32b8cbd6174ab183"</span>,</span><br><span class="line">      <span class="attr">"clientState"</span>: <span class="string">"clientOriginatedOpaqueToken"</span>,</span><br><span class="line">      <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span>,</span><br><span class="line">      <span class="attr">"resource"</span>: <span class="string">"https://api.contoso.com/v1.0/users/user@contoso.com/files/$delta"</span>,</span><br><span class="line">      <span class="attr">"userId"</span> : <span class="string">"&lt;User GUID&gt;"</span>,</span><br><span class="line">      <span class="attr">"tenantId"</span> : <span class="string">"&lt;Tenant Id&gt;"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"subscriptionId"</span>: <span class="string">"97b391179fa22"</span>,</span><br><span class="line">      <span class="attr">"clientState "</span>: <span class="string">"clientOriginatedOpaqueToken"</span>,</span><br><span class="line">      <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span>,</span><br><span class="line">      <span class="attr">"resource"</span>: <span class="string">"https://api.contoso.com/v1.0/users/user@contoso.com/files/$delta"</span>,</span><br><span class="line">      <span class="attr">"userId"</span> : <span class="string">"&lt;User GUID&gt;"</span>,</span><br><span class="line">      <span class="attr">"tenantId"</span> : <span class="string">"&lt;Tenant Id&gt;"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Following is a detailed description of the JSON payload.</p>
<p>A notification item consists a top-level object that contains an array of events, each of which identified the subscription due to which this notification is being sent.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>value</td>
<td>Array of events that have been raised within the subscription’s scope since the last notification.</td>
</tr>
</tbody>
</table>
<p>Each item of the events array contains the following properties:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>subscriptionId</td>
<td>The id of the subscription due to which this notification has been sent.<br>Services MUST provide the <em>subscriptionId</em> field.</td>
</tr>
<tr>
<td>clientState</td>
<td>Services MUST provide the <em>clientState</em> field if it was provided at subscription creation time.</td>
</tr>
<tr>
<td>expirationDateTime</td>
<td>Services MUST provide the <em>expirationDateTime</em> field if the subscription has one.</td>
</tr>
<tr>
<td>resource</td>
<td>Services MUST provide the resource field. This URL MUST be considered opaque by the subscribing application.  In the case of a richer notification it MAY be subsumed by message content that implicitly contains the resource URL to avoid duplication.<br>If a service is providing this data as part of a more detailed data packet, then it need not be duplicated.</td>
</tr>
<tr>
<td>userId</td>
<td>Services MUST provide this field for user-scoped resources.  In the case of user-scoped resources, the unique identifier for the user should be used.<br>In the case of resources shared between a specific set of users, multiple notifications must be sent, passing the unique identifier of each user.<br>For tenant-scoped resources, the user id of the subscription should be used.</td>
</tr>
<tr>
<td>tenantId</td>
<td>Services that wish to support cross-tenant requests SHOULD provide this field. Services that provide notifications on tenant-scoped data MUST send this field.</td>
</tr>
</tbody>
</table>
<h3 id="15-7-Managing-subscriptions-programmatically"><a href="#15-7-Managing-subscriptions-programmatically" class="headerlink" title="15.7. Managing subscriptions programmatically"></a>15.7. Managing subscriptions programmatically</h3><p>For per-user subscriptions, an API MUST be provided to create and manage subscriptions.<br>The API must support at least the operations described here.</p>
<h4 id="15-7-1-Creating-subscriptions"><a href="#15-7-1-Creating-subscriptions" class="headerlink" title="15.7.1. Creating subscriptions"></a>15.7.1. Creating subscriptions</h4><p>A client creates a subscription by issuing a POST request against the subscriptions resource.<br>The subscription namespace is client-defined via the POST operation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.contoso.com/apiVersion/$subscriptions</span><br></pre></td></tr></table></figure>
<p>The POST request contains a single subscription object to be created.<br>That subscription object has the following properties:</p>
<table>
<thead>
<tr>
<th>Property Name</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>resource</td>
<td>Yes</td>
<td>Resource path to watch.</td>
</tr>
<tr>
<td>notificationUrl</td>
<td>Yes</td>
<td>The target web hook URL.</td>
</tr>
<tr>
<td>clientState</td>
<td>No</td>
<td>Opaque string passed back to the client on all notifications. Callers may choose to use this to provide tagging mechanisms.</td>
</tr>
</tbody>
</table>
<p>If the subscription was successfully created, the service MUST respond with the status code 201 CREATED and a body containing at least the following properties:</p>
<table>
<thead>
<tr>
<th>Property Name</th>
<th>Required</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>Yes</td>
<td>Unique ID of the new subscription that can be used later to update/delete the subscription.</td>
</tr>
<tr>
<td>expirationDateTime</td>
<td>No</td>
<td>Uses existing Microsoft REST API Guidelines defined time formats.</td>
</tr>
</tbody>
</table>
<p>Creation of subscriptions SHOULD be idempotent.<br>The combination of properties scoped to the auth token, provides a uniqueness constraint.</p>
<p>Below is an example request using a User + Application principal to subscribe to notifications from a file:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST https://api.contoso.com/files/v1.0/$subscriptions HTTP 1.1</span><br><span class="line"><span class="attribute">Authorization</span>: Bearer &#123;UserPrincipalBearerToken&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "resource": "http://api.service.com/v1.0/files/file1.txt",</span><br><span class="line">  "notificationUrl": "https://contoso.com/myCallbacks",</span><br><span class="line">  "clientState": "clientOriginatedOpaqueToken"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The service SHOULD respond to such a message with a response format minimally like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"32b8cbd6174ab18b"</span>,</span><br><span class="line">  <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Below is an example using an Application-Only principal where the application is watching all files to which it’s authorized:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST https://api.contoso.com/files/v1.0/$subscriptions HTTP 1.1</span><br><span class="line"><span class="attribute">Authorization</span>: Bearer &#123;ApplicationPrincipalBearerToken&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "resource": "All.Files",</span><br><span class="line">  "notificationUrl": "https://contoso.com/myCallbacks",</span><br><span class="line">  "clientState": "clientOriginatedOpaqueToken"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The service SHOULD respond to such a message with a response format minimally like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"8cbd6174abb391179"</span>,</span><br><span class="line">  <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="15-7-2-Updating-subscriptions"><a href="#15-7-2-Updating-subscriptions" class="headerlink" title="15.7.2. Updating subscriptions"></a>15.7.2. Updating subscriptions</h4><p>Services MAY support amending subscriptions.<br> To update the properties of an existing subscription, clients use PATCH requests providing the ID and the properties that need to change.<br>Omitted properties will retain their values.<br>To delete a property, assign a value of JSON null to it.</p>
<p>As with creation, subscriptions are individually managed.</p>
<p>The following request changes the notification URL of an existing subscription:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PATCH https://api.contoso.com/files/v1.0/$subscriptions/&#123;id&#125; HTTP 1.1</span><br><span class="line"><span class="attribute">Authorization</span>: Bearer &#123;UserPrincipalBearerToken&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "notificationUrl": "https://contoso.com/myNewCallback"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If the PATCH request contains a new <em>notificationUrl</em>, the server MUST perform validation on it as described above.<br>If the new URL fails to validate, the service MUST fail the PATCH request and leave the subscription in its previous state.</p>
<p>The service MUST return an empty body and <code>204 No Content</code> to indicate a successful patch.</p>
<p>The service MUST return an error body and status code if the patch failed.</p>
<p>The operation MUST succeed or fail atomically.</p>
<h4 id="15-7-3-Deleting-subscriptions"><a href="#15-7-3-Deleting-subscriptions" class="headerlink" title="15.7.3. Deleting subscriptions"></a>15.7.3. Deleting subscriptions</h4><p>Services MUST support deleting subscriptions.<br>Existing subscriptions can be deleted by making a DELETE request against the subscription resource:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETE https://api.contoso.com/files/v1.0/$subscriptions/&#123;id&#125; HTTP 1.1</span><br><span class="line"><span class="attribute">Authorization</span>: Bearer &#123;UserPrincipalBearerToken&#125;</span><br></pre></td></tr></table></figure>
<p>As with update, the service MUST return <code>204 No Content</code> for a successful delete, or an error body and status code to indicate failure.</p>
<h4 id="15-7-4-Enumerating-subscriptions"><a href="#15-7-4-Enumerating-subscriptions" class="headerlink" title="15.7.4. Enumerating subscriptions"></a>15.7.4. Enumerating subscriptions</h4><p>To get a list of active subscriptions, clients issue a GET request against the subscriptions resource using a User + Application or Application-Only bearer token:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.contoso.com/files/v1.0/$subscriptions HTTP 1.1</span><br><span class="line"><span class="attribute">Authorization</span>: Bearer &#123;UserPrincipalBearerToken&#125;</span><br></pre></td></tr></table></figure>
<p>The service MUST return a format as below using a User + Application principal bearer token:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"32b8cbd6174ab18b"</span>,</span><br><span class="line">      <span class="attr">"resource"</span>: <span class="string">" http://api.contoso.com/v1.0/files/file1.txt"</span>,</span><br><span class="line">      <span class="attr">"notificationUrl"</span>: <span class="string">"https://contoso.com/myCallbacks"</span>,</span><br><span class="line">      <span class="attr">"clientState"</span>: <span class="string">"clientOriginatedOpaqueToken"</span>,</span><br><span class="line">      <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>An example that may be returned using Application-Only principal bearer token:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"value"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"6174ab18bfa22"</span>,</span><br><span class="line">      <span class="attr">"resource"</span>: <span class="string">"All.Files "</span>,</span><br><span class="line">      <span class="attr">"notificationUrl"</span>: <span class="string">"https://contoso.com/myCallbacks"</span>,</span><br><span class="line">      <span class="attr">"clientState"</span>: <span class="string">"clientOriginatedOpaqueToken"</span>,</span><br><span class="line">      <span class="attr">"expirationDateTime"</span>: <span class="string">"2016-02-04T11:23Z"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="15-8-Security"><a href="#15-8-Security" class="headerlink" title="15.8. Security"></a>15.8. Security</h3><p>All service URLs must be HTTPS (that is, all inbound calls MUST be HTTPS). Services that deal with Web Hooks MUST accept HTTPS.</p>
<p>We recommend that services that allow client defined Web Hook Callback URLs SHOULD NOT transmit data over HTTP.<br>This is because information can be inadvertently exposed via client, network, server logs and other mechanisms.</p>
<p>However, there are scenarios where the above recommendations cannot be followed due to client endpoint or software limitations.<br>Consequently, services MAY allow web hook URLs that are HTTP.</p>
<p>Furthermore, services that allow client defined HTTP web hooks callback URLs SHOULD be compliant with privacy policy specified by engineering leadership.<br>This will typically include recommending that clients prefer SSL connections and adhere to special precautions to ensure that logs and other service data collection are properly handled.</p>
<p>For example, services may not want to require developers to generate certificates to onboard.<br>Services might only enable this on test accounts.</p>
<h2 id="16-Unsupported-requests"><a href="#16-Unsupported-requests" class="headerlink" title="16. Unsupported requests"></a>16. Unsupported requests</h2><p>RESTful API clients MAY request functionality that is currently unsupported.<br>RESTful APIs MUST respond to valid but unsupported requests consistent with this section.</p>
<h3 id="16-1-Essential-guidance"><a href="#16-1-Essential-guidance" class="headerlink" title="16.1. Essential guidance"></a>16.1. Essential guidance</h3><p>RESTful APIs will often choose to limit functionality that can be performed by clients.<br>For instance, auditing systems allow records to be created but not modified or deleted.<br>Similarly, some APIs will expose collections but require or otherwise limit filtering and ordering criteria, or MAY not support client-driven pagination.</p>
<h3 id="16-2-Feature-allow-list"><a href="#16-2-Feature-allow-list" class="headerlink" title="16.2. Feature allow list"></a>16.2. Feature allow list</h3><p>If a service does not support any of the below API features, then an error response MUST be provided if the feature is requested by a caller.<br>The features are:</p>
<ul>
<li>Key Addressing in a collection, such as: <code>https://api.contoso.com/v1.0/people/user1@contoso.com</code></li>
<li>Filtering a collection by a property value, such as: <code>https://api.contoso.com/v1.0/people?$filter=name eq &#39;david&#39;</code></li>
<li>Filtering a collection by range, such as: <code>http://api.contoso.com/v1.0/people?$filter=hireDate ge 2014-01-01 and hireDate le 2014-12-31</code></li>
<li>Client-driven pagination via $top and $skip, such as: <code>http://api.contoso.com/v1.0/people?$top=5&amp;$skip=2</code></li>
<li>Sorting by $orderBy, such as: <code>https://api.contoso.com/v1.0/people?$orderBy=name desc</code></li>
<li>Providing $delta tokens, such as: <code>https://api.contoso.com/v1.0/people?$delta</code></li>
</ul>
<h4 id="16-2-1-Error-response"><a href="#16-2-1-Error-response" class="headerlink" title="16.2.1. Error response"></a>16.2.1. Error response</h4><p>Services MUST provide an error response if a caller requests an unsupported feature found in the feature allow list.<br>The error response MUST be an HTTP status code from the 4xx series, indicating that the request cannot be fulfilled.<br>Unless a more specific error status is appropriate for the given request, services SHOULD return “400 Bad Request” and an error payload conforming to the error response guidance provided in the Microsoft REST API Guidelines.<br>Services SHOULD include enough detail in the response message for a developer to determine exactly what portion of the request is not supported.</p>
<p>Example:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">https://api.contoso.com/v1.0/people?$orderBy=name</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Accept</span>: application/json</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">400</span> Bad Request</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "code": "ErrorUnsupportedOrderBy",</span><br><span class="line">    "message": "Ordering by name is not supported."</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="17-Naming-guidelines"><a href="#17-Naming-guidelines" class="headerlink" title="17. Naming guidelines"></a>17. Naming guidelines</h2><h3 id="17-1-Approach"><a href="#17-1-Approach" class="headerlink" title="17.1. Approach"></a>17.1. Approach</h3><p>Naming policies should aid developers in discovering functionality without having to constantly refer to documentation.<br>Use of common patterns and standard conventions greatly aids developers in correctly guessing common property names and meanings.<br>Services SHOULD use verbose naming patterns and SHOULD NOT use abbreviations other than acronyms that are the dominant mode of expression in the domain being represented by the API, (e.g. Url).</p>
<h3 id="17-2-Casing"><a href="#17-2-Casing" class="headerlink" title="17.2. Casing"></a>17.2. Casing</h3><ul>
<li>Acronyms SHOULD follow the casing conventions as though they were regular words (e.g. Url).</li>
<li>All identifiers including namespaces, entityTypes, entitySets, properties, actions, functions and enumeration values SHOULD use lowerCamelCase.</li>
<li>HTTP headers are the exception and SHOULD use standard HTTP convention of Capitalized-Hyphenated-Terms.</li>
</ul>
<h3 id="17-3-Names-to-avoid"><a href="#17-3-Names-to-avoid" class="headerlink" title="17.3. Names to avoid"></a>17.3. Names to avoid</h3><p>Certain names are so overloaded in API domains that they lose all meaning or clash with other common usages in domains that cannot be avoided when using REST APIs, such as OAUTH.<br>Services SHOULD NOT use the following names:</p>
<ul>
<li>Context</li>
<li>Scope</li>
<li>Resource</li>
</ul>
<h3 id="17-4-Forming-compound-names"><a href="#17-4-Forming-compound-names" class="headerlink" title="17.4. Forming compound names"></a>17.4. Forming compound names</h3><ul>
<li>Services SHOULD avoid using articles such as ‘a’, ‘the’, ‘of’ unless needed to convey meaning.<ul>
<li>e.g. names such as aUser, theAccount, countOfBooks SHOULD NOT be used, rather user, account, bookCount SHOULD be preferred.</li>
</ul>
</li>
<li>Services SHOULD add a type to a property name when not doing so would cause ambiguity about how the data is represented or would cause the service not to use a common property name.</li>
<li>When adding a type to a property name, services MUST add the type at the end, e.g. createdDateTime.</li>
</ul>
<h3 id="17-5-Identity-properties"><a href="#17-5-Identity-properties" class="headerlink" title="17.5. Identity properties"></a>17.5. Identity properties</h3><ul>
<li>Services MUST use string types for identity properties.</li>
<li>For OData services, the service MUST use the OData @id property to represent the canonical identifier of the resource.</li>
<li>Services MAY use the simple ‘id’ property to represent a local or legacy primary key value for a resource.</li>
<li>Services SHOULD use the name of the relationship postfixed with ‘Id’ to represent a foreign key to another resource, e.g. subscriptionId.<ul>
<li>The content of this property SHOULD be the canonical ID of the referenced resource.</li>
</ul>
</li>
</ul>
<h3 id="17-6-Date-and-time-properties"><a href="#17-6-Date-and-time-properties" class="headerlink" title="17.6. Date and time properties"></a>17.6. Date and time properties</h3><ul>
<li>For properties requiring both date and time, services MUST use the suffix ‘DateTime’.</li>
<li>For properties requiring only date information without specifying time, services MUST use the suffix ‘Date’, e.g. birthDate.</li>
<li>For properties requiring only time information without specifying date, services MUST use the suffix ‘Time’, e.g. appointmentStartTime.</li>
</ul>
<h3 id="17-7-Name-properties"><a href="#17-7-Name-properties" class="headerlink" title="17.7. Name properties"></a>17.7. Name properties</h3><ul>
<li>For the overall name of a resource typically shown to users, services MUST use the property name ‘displayName’.</li>
<li>Services MAY use other common naming properties, e.g. givenName, surname, signInName.</li>
</ul>
<h3 id="17-8-Collections-and-counts"><a href="#17-8-Collections-and-counts" class="headerlink" title="17.8. Collections and counts"></a>17.8. Collections and counts</h3><ul>
<li>Services MUST name collections as plural nouns or plural noun phrases using correct English.</li>
<li>Services MAY use simplified English for nouns that have plurals not in common verbal usage.<ul>
<li>e.g. schemas MAY be used instead of schemata.</li>
</ul>
</li>
<li>Services MUST name counts of resources with a noun or noun phrase suffixed with ‘Count’.</li>
</ul>
<h3 id="17-9-Common-property-names"><a href="#17-9-Common-property-names" class="headerlink" title="17.9. Common property names"></a>17.9. Common property names</h3><p>Where services have a property, whose data matches the names below, the service MUST use the name from this table.<br>This table will grow as services add terms that will be more commonly used.<br>Service owners adding such terms SHOULD propose additions to this document.</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p> attendees     |<br> body          |<br> createdDateTime |<br> childCount    |<br> children      |<br> contentUrl    |<br> country       |<br> createdBy     |<br> displayName   |<br> errorUrl      |<br> eTag          |<br> event         |<br> expirationDateTime |<br> givenName     |<br> jobTitle      |<br> kind          |<br> id            |<br> lastModifiedDateTime |<br> location      |<br> memberOf      |<br> message       |<br> name          |<br> owner         |<br> people        |<br> person        |<br> postalCode    |<br> photo         |<br> preferredLanguage |<br> properties    |<br> signInName    |<br> surname       |<br> tags          |<br> userPrincipalName |<br> webUrl        |</p>
<h2 id="18-Appendix"><a href="#18-Appendix" class="headerlink" title="18. Appendix"></a>18. Appendix</h2><h3 id="18-1-Sequence-diagram-notes"><a href="#18-1-Sequence-diagram-notes" class="headerlink" title="18.1. Sequence diagram notes"></a>18.1. Sequence diagram notes</h3><p>All sequence diagrams in this document are generated using the WebSequenceDiagrams.com web site. To generate them, paste the text below into the web tool.</p>
<h4 id="18-1-1-Push-notifications-per-user-flow"><a href="#18-1-1-Push-notifications-per-user-flow" class="headerlink" title="18.1.1. Push notifications, per user flow"></a>18.1.1. Push notifications, per user flow</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">=== Begin Text ===</span><br><span class="line">note over Developer, Automation, App Server:</span><br><span class="line">     An App Developer like MovieMaker</span><br><span class="line">     Wants to integrate with primary service like Dropbox</span><br><span class="line">end note</span><br><span class="line">note over DB Portal, DB App Registration, DB Notifications, DB Auth, DB Service: The primary service like Dropbox</span><br><span class="line">note over Client: The end users&apos; browser or installed app</span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Manual App Registration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Developer &lt;--&gt; DB Portal : Login into Portal, App Registration UX</span><br><span class="line">DB Portal -&gt; +DB App Registration: App Name etc.</span><br><span class="line">note over DB App Registration: Confirm Portal Access Token</span><br><span class="line"></span><br><span class="line">DB App Registration -&gt; -DB Portal: App ID</span><br><span class="line">DB Portal &lt;--&gt; App Server: Developer copies App ID</span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Manual Notification Registration</span><br><span class="line"></span><br><span class="line">Developer &lt;--&gt; DB Portal: webhook registration UX</span><br><span class="line">DB Portal -&gt; +DB Notifications: Register: App Server webhook URL, Scope, App ID</span><br><span class="line">Note over DB Notifications : Confirm Portal Access Token</span><br><span class="line">DB Notifications -&gt; -DB Portal: notification ID</span><br><span class="line">DB Portal --&gt; App Server : Developer may copy notification ID</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Client Authorization</span><br><span class="line"></span><br><span class="line">Client -&gt; +App Server : Request access to DB protected information</span><br><span class="line">App Server -&gt; -Client : Redirect to DB Authorization endpoint with authorization request</span><br><span class="line">Client -&gt; +DB Auth : Redirected authorization request</span><br><span class="line">Client &lt;--&gt; DB Auth : Authorization UX</span><br><span class="line">DB Auth -&gt; -Client : Redirect back to App Server with code</span><br><span class="line">Client -&gt; +App Server : Redirect request back to access server with access code</span><br><span class="line">App Server -&gt; +DB Auth : Request tokens with access code</span><br><span class="line">note right of DB Service: Cache that this User ID provided access to App ID</span><br><span class="line">DB Auth -&gt; -App Server : Response with access, refresh, and ID tokens</span><br><span class="line">note right of App Server : Cache tokens by user ID</span><br><span class="line">App Server -&gt; -Client : Return information to client</span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Notification Flow</span><br><span class="line"></span><br><span class="line">Client &lt;--&gt; DB Service: Changes to user data - typical via interacting with App Server via Client</span><br><span class="line">DB Service -&gt; App Server : Notification with notification ID and user ID</span><br><span class="line">App Server -&gt; +DB Service : Request changed information with cached access tokens and &quot;since&quot; token</span><br><span class="line">note over DB Service: Confirm User Access Token</span><br><span class="line">DB Service -&gt; -App Server : Response with data and new &quot;since&quot; token</span><br><span class="line">note right of App Server: Update status and cache new &quot;since&quot; token</span><br><span class="line">=== End Text ===</span><br></pre></td></tr></table></figure>
<h4 id="18-1-2-Push-notifications-firehose-flow"><a href="#18-1-2-Push-notifications-firehose-flow" class="headerlink" title="18.1.2. Push notifications, firehose flow"></a>18.1.2. Push notifications, firehose flow</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">=== Begin Text ===</span><br><span class="line">note over Developer, Automation, App Server:</span><br><span class="line">     An App Developer like MovieMaker</span><br><span class="line">     Wants to integrate with primary service like Dropbox</span><br><span class="line">end note</span><br><span class="line">note over DB Portal, DB App Registration, DB Notifications, DB Auth, DB Service: The primary service like Dropbox</span><br><span class="line">note over Client: The end users&apos; browser or installed app</span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : App Registration</span><br><span class="line"></span><br><span class="line">alt Automated app registration</span><br><span class="line">   Developer &lt;--&gt; Automation: Configure</span><br><span class="line">   Automation -&gt; +DB App Registration: App Name etc.</span><br><span class="line">   note over DB App Registration: Confirm App Access Token</span><br><span class="line">   DB App Registration -&gt; -Automation: App ID, App Secret</span><br><span class="line">   Automation --&gt; App Server : Embed App ID, App Secret</span><br><span class="line">else Manual app registration</span><br><span class="line">   Developer &lt;--&gt; DB Portal : Login into Portal, App Registration UX</span><br><span class="line">   DB Portal -&gt; +DB App Registration: App Name etc.</span><br><span class="line">   note over DB App Registration: Confirm Portal Access Token</span><br><span class="line"></span><br><span class="line">   DB App Registration -&gt; -DB Portal: App ID</span><br><span class="line">   DB Portal &lt;--&gt; App Server: Developer copies App ID</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Client Authorization</span><br><span class="line"></span><br><span class="line">Client -&gt; +App Server : Request access to DB protected information</span><br><span class="line">App Server -&gt; -Client : Redirect to DB Authorization endpoint with authorization request</span><br><span class="line">Client -&gt; +DB Auth : Redirected authorization request</span><br><span class="line">Client &lt;--&gt; DB Auth : Authorization UX</span><br><span class="line">DB Auth -&gt; -Client : Redirect back to App Server with code</span><br><span class="line">Client -&gt; +App Server : Redirect request back to access server with access code</span><br><span class="line">App Server -&gt; +DB Auth : Request tokens with access code</span><br><span class="line">note right of DB Service: Cache that this User ID provided access to App ID</span><br><span class="line">DB Auth -&gt; -App Server : Response with access, refresh, and ID tokens</span><br><span class="line">note right of App Server : Cache tokens by user ID</span><br><span class="line">App Server -&gt; -Client : Return information to client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Notification Registration</span><br><span class="line"></span><br><span class="line">App Server-&gt;+DB Notifications: Register: App server webhook URL, Scope, App ID</span><br><span class="line">note over DB Notifications : Confirm User Access Token</span><br><span class="line">DB Notifications -&gt; -App Server: notification ID</span><br><span class="line">note right of App Server : Cache the Notification ID and User Access Token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">note over Developer, Automation, App Server, DB Portal, DB App Registration, DB Notifications, Client : Notification Flow</span><br><span class="line"></span><br><span class="line">Client &lt;--&gt; DB Service: Changes to user data - typical via interacting with App Server via Client</span><br><span class="line">DB Service -&gt; App Server : Notification with notification ID and user ID</span><br><span class="line">App Server -&gt; +DB Service : Request changed information with cached access tokens and &quot;since&quot; token</span><br><span class="line">note over DB Service: Confirm User Access Token</span><br><span class="line">DB Service -&gt; -App Server : Response with data and new &quot;since&quot; token</span><br><span class="line">note right of App Server: Update status and cache new &quot;since&quot; token</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== End Text ===</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/78/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/78/">78</a><span class="page-number current">79</span><a class="page-number" href="/page/80/">80</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/80/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
