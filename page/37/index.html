<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/37/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/37/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/23/PHP-FPM架构存在的问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/23/PHP-FPM架构存在的问题/" itemprop="url">PHP-FPM架构存在的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-23T12:12:57+08:00">
                2019-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/" itemprop="url" rel="index">
                    <span itemprop="name">异步与同步</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/" itemprop="url" rel="index">
                    <span itemprop="name">IO</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/" itemprop="url" rel="index">
                    <span itemprop="name">Reactor</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/" itemprop="url" rel="index">
                    <span itemprop="name">事件模型</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/网络编程/" itemprop="url" rel="index">
                    <span itemprop="name">网络编程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP-FPM架构存在的问题"><a href="#PHP-FPM架构存在的问题" class="headerlink" title="PHP-FPM架构存在的问题"></a>PHP-FPM架构存在的问题</h1><h2 id="传统架构"><a href="#传统架构" class="headerlink" title="传统架构"></a>传统架构</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 <code>Nginx</code> + <code>PHP-Fpm</code> 模式下开发非常简单 不用担心 内存泄露。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>php</code>的<code>fastcgi</code>进程管理器<code>php-fpm</code>和<code>nginx</code>的配合已经运行得足够好，但是由于<code>php-fpm</code>本身是<strong>同步阻塞进程模型</strong>，在请求结束后释放所有的资源（包括框架初始化创建的一系列对象，导致<code>PHP</code>进程<strong>空转</strong>（创建<-->销毁<-->创建）消耗大量的<code>CPU</code>资源，从而导致单机的吞吐能力有限。请求夯住，会导致 <code>CPU</code> 不能释放资源， 大大浪费了 <code>CPU</code> 使用率。</--></--></p>
<h3 id="php-fpm"><a href="#php-fpm" class="headerlink" title="php-fpm"></a>php-fpm</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>php-fpm</code>进程模型也非常简单的，是 属于<a href="https://www.swoft.org/docs/2.x/zh-CN/ready/tradition.html#预派生子进程模式" target="_blank" rel="noopener">预派生子进程模式</a> 大家想必知道早期的 <code>Apache</code> 就是采用该模式 来一个请求就 <code>fork</code> 一个进程，进程的开销是非常大的。这会大大降低吞吐率，并发数由进程数决定。</p>
<p> <img src="//blog.com/2019/06/23/PHP-FPM架构存在的问题/fpm.png" alt="fpm"></p>
<h3 id="预派生子进程模式"><a href="#预派生子进程模式" class="headerlink" title="预派生子进程模式"></a>预派生子进程模式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;程序启动后就会创建<code>N</code>个进程。每个子进程进入<code>Accept</code>，等待新的连接进入。当客户端连接到服务器时，其中一个子进程会被唤醒，开始处理客户端请求，并且不再接受新的<code>TCP连接</code>。当此连接关闭时，子进程会释放，重新进入<code>Accept</code>，参与处理新的连接。</p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个模型的优势是完全<strong>可以复用进程，不需要太多的上下文切换</strong>。</p>
<h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这种模型<strong>严重依赖进程的数量解决并发问题，一个客户端连接就需要占用一个进程，工作进程的数量有多少，并发处理能力就有多少</strong>。<strong>操作系统可以创建的进程数量是有限的</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>PHP</code>框架初始化会占用大量的计算资源，每个请求都需要初始化。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;启动大量进程会带来额外的<strong>进程调度消耗</strong>。数百个进程时可能进程上下文切换调度消耗占CPU不到1%可以忽略不计，如果启动数千甚至数万个进程，消耗就会直线上升。调度消耗可能占到 CPU 的百分之几十甚至 100%。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果请求一个第三方请求非常慢，请求过程中会一直占用 <code>CPU</code> 资源，浪费了昂贵的硬件资源</p>
<blockquote>
<p>例如：即时聊天程序，一台服务器可能要维持数十万的连接，那么就要启动数十万的进程来持。这显然不可能</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有没有一种技术可以在一个进程内处理所有并发<code>IO</code>呢？答案是有，这就是<a href="https://www.swoft.org/docs/2.x/zh-CN/ready/io.html" target="_blank" rel="noopener">IO复用</a>技术。</p>
<h3 id="php-fpm工作模式的问题"><a href="#php-fpm工作模式的问题" class="headerlink" title="php-fpm工作模式的问题"></a>php-fpm工作模式的问题</h3><p><img src="//blog.com/2019/06/23/PHP-FPM架构存在的问题/lnpm.png" alt="模型"></p>
<ul>
<li><code>nginx</code>基于<code>epoll</code>事件模型，一个<code>worker</code>同时可处理多个请求</li>
<li><strong><code>fpm-worker</code>在同一时刻可处理一个请求</strong></li>
<li><strong><code>fpm-worker</code>每次处理请求前需要重新初始化<code>mvc</code>框架，然后再释放资源</strong></li>
<li><strong>高并发请求时，<code>fpm-worker</code>不够用，<code>nginx</code>直接响应502</strong></li>
<li><strong><code>fpm-worker</code>进程间切换消耗大</strong></li>
</ul>
<h2 id="那我们还有什么解决方案-？"><a href="#那我们还有什么解决方案-？" class="headerlink" title="那我们还有什么解决方案 ？"></a>那我们还有什么解决方案 ？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们分析我们的业务不难发现，<code>90%</code>以上的业务都是<strong>IO密集性业务</strong>，我们只需要提高<code>IO</code>复用的能力就可以提升单机吞吐能力，另外需要将<code>php-fpm</code><strong>同步阻塞模式</strong>替换为<strong>异步非阻塞模式</strong>，异步开启模式比较复杂不易维护，当然不一定使用<code>php-fpm</code>，就可以解决我们的核心问题——性能。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 <strong>IO密集性业务</strong> 中我们需要频繁的上下文切换，采用线程模式开发太过复杂。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个进程中能开的线程数也有限，线程太多也会增加 <code>CPU</code> 的负荷和内存资源，线程没有<strong>阻塞态</strong>，IO 阻塞也不能主动让出 <code>CPU</code>资源，属于<strong>抢占式调度模型</strong>。不太适合 <code>php</code>开发。</p>
<h2 id="IO-多路复用"><a href="#IO-多路复用" class="headerlink" title="IO 多路复用"></a>IO 多路复用</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这的复用指的是复用的<code>线程</code>，其实<code>IO</code>复用的历史和多进程一样长。</p>
<h3 id="select-poll"><a href="#select-poll" class="headerlink" title="select/poll"></a>select/poll</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Linux</code>很早就提供了<strong><code>select</code>系统调用，可以在一个进程内维持1024个连接</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来又加入了<code>poll</code>系统调用，<code>poll</code>做了一些改进，解决了 1024 限制的问题，可以维持任意数量的连接。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但<strong><code>select/poll</code>还有一个问题就是，它需要循环检测连接是否有事件</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样问题就来了，如果服务器有100万个连接，在某一时间只有一个连接向服务器发送了数据，<code>select/poll</code>需要做循环100万次，其中只有1次是命中的，剩下的99万9999次都是无效的，白白浪费了<code>CPU</code>资源。</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;直到<code>Linux 2.6</code>内核提供了新的<code>epoll</code>系统调用，<strong>可以维持无限数量的连接，而且无需轮询，这才真正解决了 <code>C10K</code> 问题</strong>。现在各种高并发异步IO的服务器程序都是基于<code>epoll</code>实现的，比如<code>Nginx、Node.js、Erlang、Golang</code>。像 <code>Node.js</code>，<code>Redis</code> 这样单进程单线程的程序，都可以维持超过1百万<code>TCP</code>连接，全部归功于<code>epoll</code>技术。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这就不得不提，<strong>基于 <code>epoll</code> 实现的 <code>Reactor</code> 模型，<code>IO复用</code>异步非阻塞程序使用经典的<code>Reactor</code>模型，<code>Reactor</code>顾名思义就是<code>反应堆</code>的意思，它本身不处理任何数据收发。只是可以监视一个<code>socket句柄</code>的事件变化</strong>。</p>
<p><img src="//blog.com/2019/06/23/PHP-FPM架构存在的问题/eventloop.png" alt="模型"></p>
<h2 id="高效的事件处理模式Reactor-模式"><a href="#高效的事件处理模式Reactor-模式" class="headerlink" title="高效的事件处理模式Reactor 模式"></a>高效的事件处理模式Reactor 模式</h2><ul>
<li>主进程/线程往<code>epoll内核事件</code>中注册<code>socket</code>上的读就绪亊件。</li>
<li>主进程/线程调用<code>epoll_wait</code>等待<code>socket</code>上有数据可读。</li>
<li>当<code>socket</code>上有数据可读时，<code>epoll_wait</code>通知主进程/线程。主进程/线程则将<code>socket</code>可读事件放入请求队列。</li>
<li>睡眠在请求队列上的某个工作线程被唤醒，它从<code>socket</code>读取数据，并处理客户请求， 然后往<code>epoll</code>内核事件表中注册该<code>socket</code>上的写就绪事件。</li>
<li>主线程调用<code>epoll_wait</code>等待<code>socket</code>可写。</li>
<li>当<code>socket</code>可写时，<code>epoll_wait</code>通知主进程/线程主进程/线程将<code>socket</code>可写事件放入请求队列。</li>
<li>睡眠在请求队列上的某个工作线程被唤醒，它往<code>socket</code>上写入服务器处理客户请求</li>
</ul>
<p><code>swoole</code> 的 <code>Reactor</code> 线程 也是基于 <code>Reactor</code> 模型实现的</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/" itemprop="url">MySQL InnoDB MVCC 机制的原理及实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-23T12:12:57+08:00">
                2019-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/Innodb/" itemprop="url" rel="index">
                    <span itemprop="name">Innodb</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/Innodb/MVCC/" itemprop="url" rel="index">
                    <span itemprop="name">MVCC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL-InnoDB-MVCC-机制的原理及实现"><a href="#MySQL-InnoDB-MVCC-机制的原理及实现" class="headerlink" title="MySQL InnoDB MVCC 机制的原理及实现"></a>MySQL InnoDB MVCC 机制的原理及实现</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://chenjiayang.me/2019/06/22/mysql-innodb-mvcc/" target="_blank" rel="noopener">https://chenjiayang.me/2019/06/22/mysql-innodb-mvcc/</a></p>
</blockquote>
<p><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>多版本并发控制，是现代数据库引擎实现中常用的处理读写冲突的手段，目的在于提高数据库高并发场景下的吞吐性能</strong>。</p>
<h2 id="什么是-MVCC"><a href="#什么是-MVCC" class="headerlink" title="什么是 MVCC"></a>什么是 MVCC</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>MVCC (Multiversion Concurrency Control)</code> 中文全程叫<strong>多版本并发控制</strong>，是现代数据库（包括 <code>MySQL</code>、<code>Oracle</code>、<code>PostgreSQL</code> 等）引擎实现中常用的处理读写冲突的手段，<strong>目的在于提高数据库高并发场景下的吞吐性能</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如此一来不同的事务在并发过程中，<code>SELECT</code> 操作可以不加锁而是通过 <code>MVCC</code> 机制读取指定的版本历史记录，并通过一些手段保证保证读取的记录值符合事务所处的隔离级别，从而解决并发场景下的读写冲突。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面举一个多版本读的例子，例如两个事务 <code>A</code> 和 <code>B</code> 按照如下顺序进行更新和读取操作</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895gy1g2lrq1k5r0j20iy0hkt9l.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在事务 <code>A</code> 提交前后，事务 <code>B</code> 读取到的 <code>x</code> 的值是什么呢？答案是：事务 <code>B</code> 在不同的隔离级别下，读取到的值不一样。</p>
<ol>
<li>如果事务 <code>B</code> 的隔离级别是读未提交（<code>RU</code>），那么两次读取均读取到 <code>x</code> 的最新值，即 <code>20</code>。</li>
<li>如果事务 <code>B</code> 的隔离级别是读已提交（<code>RC</code>），那么第一次读取到旧值 <code>10</code>，第二次因为事务 <code>A</code> 已经提交，则读取到新值 20。</li>
<li>如果事务 <code>B</code> 的隔离级别是可重复读或者串行（<code>RR，S</code>），则两次均读到旧值 <code>10</code>，不论事务 <code>A</code> 是否已经提交。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可见在不同的隔离级别下，数据库通过 <code>MVCC</code> 和隔离级别，让事务之间并行操作遵循了某种规则，来保证单个事务内前后数据的一致性。</p>
<h2 id="为什么需要-MVCC"><a href="#为什么需要-MVCC" class="headerlink" title="为什么需要 MVCC"></a>为什么需要 MVCC</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>InnoDB</code> 相比 <code>MyISAM</code> 有两大特点，一是支持<strong>事务</strong>、二是支持<strong>行级锁</strong>，事务的引入带来了一些新的挑战。相对于串行处理来说，并发事务处理能大大增加数据库资源的利用率，提高数据库系统的事务吞吐量，从而可以支持可以支持更多的用户。但并发事务处理也会带来一些问题，主要包括以下几种情况：</p>
<ol>
<li><p><strong>更新丢失</strong>（<code>Lost Update</code>）：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题 —— 最后的更新覆盖了其他事务所做的更新。<strong>如何避免这个问题呢，最好在一个事务对数据进行更改但还未提交时，其他事务不能访问修改同一个数据</strong>。</p>
</li>
<li><p><strong>脏读</strong>（<code>Dirty Reads</code>）：一个事务正在对一条记录做修改，在这个事务并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些尚未提交的脏数据，并据此做进一步的处理，就会<strong>产生未提交的数据依赖关系</strong>。这种现象被形象地叫做 <strong>“脏读”</strong>。</p>
</li>
<li><p><strong>不可重复读</strong>（<code>Non-Repeatable Reads</code>）：<strong>一个事务在读取某些数据已经发生了改变、或某些记录已经被删除了！</strong>这种现象叫做<strong>“不可重复读”</strong>。</p>
</li>
<li><p><strong>幻读</strong>（<code>Phantom Reads</code>）：<strong>一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据</strong>，这种现象就称为 <strong>“幻读”</strong>。</p>
</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上是并发事务过程中会存在的问题，解决更新丢失可以交给应用，但是后三者需要数据库提供事务间的隔离机制来解决。实现隔离机制的方法主要有两种：</p>
<ol>
<li><strong>加读写锁</strong></li>
<li><strong>一致性快照读</strong>，即 <code>MVCC</code></li>
</ol>
<p>但本质上，<strong>隔离级别是一种在并发性能和并发产生的副作用间的妥协</strong>，通常数据库均倾向于采用 <code>Weak Isolation</code>（弱隔离）。</p>
<h2 id="InnoDB-中的-MVCC"><a href="#InnoDB-中的-MVCC" class="headerlink" title="InnoDB 中的 MVCC"></a>InnoDB 中的 MVCC</h2><p>本文聚焦于 <code>MySQL</code> 中的 <code>MVCC</code> 实现，从 <code>《高性能 MySQL》</code>一书中对 <code>MVCC</code> 的介绍可知：</p>
<ol>
<li><strong><code>MySQL</code> 中 <code>InnoDB</code> 引擎支持 <code>MVCC</code></strong></li>
<li><strong>应对高并发事务, <code>MVCC</code> 比单纯的加行锁更有效, 开销更小</strong></li>
<li><strong><code>MVCC</code> 在读已提交<code>（Read Committed）</code>和可重复读<code>（Repeatable Read）</code>隔离级别下起作用</strong></li>
<li><code>MVCC</code> 既可以基于<strong>乐观锁</strong>又可以基于<strong>悲观锁</strong>来实现</li>
</ol>
<h2 id="InnoDB-MVCC-实现原理"><a href="#InnoDB-MVCC-实现原理" class="headerlink" title="InnoDB MVCC 实现原理"></a>InnoDB MVCC 实现原理</h2><h3 id="增加两个隐藏列"><a href="#增加两个隐藏列" class="headerlink" title="增加两个隐藏列"></a>增加两个隐藏列</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>InnoDB</code> 中 <code>MVCC</code> 的实现方式为：每一行记录都有两个隐藏列：<code>DATA_TRX_ID</code>、<code>DATA_ROLL_PTR</code>（如果没有主键，则还会多一个隐藏的主键列）。</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895gy1g2ls3vmt1zj20lg03ewej.jpg" alt="img"></p>
<p><strong>DATA_TRX_ID</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;记录最近更新这条行记录的<strong><code>事务 ID</code></strong>，大小为 <code>6</code> 个字节</p>
<p><strong>DATA_ROLL_PTR</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;表示指向该行<strong>回滚段<code>（rollback segment）</code>的指针</strong>，大小为 <code>7</code> 个字节，<code>InnoDB</code> 便是通过这个指针找到之前版本的数据。该行记录上所有旧版本，在 <code>undo</code> 中都通过链表的形式组织。</p>
<p><strong>DB_ROW_ID</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>行标识</strong>（隐藏单调自增 <code>ID</code>），大小为 <code>6</code> 字节，如果表没有主键，<code>InnoDB</code> 会自动生成一个隐藏主键，因此会出现这个列。另外，<strong>每条记录的头信息（<code>record header</code>）里都有一个专门的 <code>bit</code>（<code>deleted_flag</code>）来表示当前记录是否已经被删除</strong>。</p>
<h3 id="如何组织-Undo-Log-链"><a href="#如何组织-Undo-Log-链" class="headerlink" title="如何组织 Undo Log 链"></a>如何组织 Undo Log 链</h3><blockquote>
<p>关于 Redo Log 和 Undo Log 的相关概念可见之前的文章 <a href="https://chenjiayang.me/2019/04/13/mysql-innodb-redo-undo/" target="_blank" rel="noopener">InnoDB 中的 redo 和 undo log</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上文提到，在多个事务并行操作某行数据的情况下，不同事务对该行数据的 UPDATE 会产生多个版本，然后通过回滚指针组织成一条 <code>Undo Log</code> 链，这节我们通过一个简单的例子来看一下 <code>Undo Log</code> 链是如何组织的，<code>DATA_TRX_ID</code> 和 <code>DATA_ROLL_PTR</code> 两个参数在其中又起到什么样的作用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还是以上文 <code>MVCC</code> 的例子，事务 <code>A</code> 对值 <code>x</code> 进行更新之后，该行即产生一个新版本和旧版本。假设之前插入该行的事务 <code>ID</code> 为 <code>100</code>，事务 <code>A</code> 的 <code>ID</code> 为 <code>200</code>，该行的隐藏主键为 <code>1</code>。</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895gy1g2lsdooktaj20o808odg5.jpg" alt="img"></p>
<p>事务 <code>A</code> 的操作过程为：</p>
<ol>
<li>对 <code>DB_ROW_ID = 1</code> 的这行记录加排他锁</li>
<li>把该行原本的值拷贝到 <code>undo log</code> 中，<code>DB_TRX_ID</code> 和 <code>DB_ROLL_PTR</code> 都不动</li>
<li>修改该行的值这时产生一个新版本，更新 <code>DATA_TRX_ID</code> 为修改记录的事务 <code>ID</code>，将 <code>DATA_ROLL_PTR</code> 指向刚刚拷贝到 <code>undo log</code> 链中的旧版本记录，这样就能通过 <code>DB_ROLL_PTR</code> 找到这条记录的历史版本。如果对同一行记录执行连续的 <code>UPDATE</code>，<code>Undo Log</code> 会组成一个链表，遍历这个链表可以看到这条记录的变迁</li>
<li>记录 <code>redo log</code>，包括 <code>undo log</code> 中的修改</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那么 <code>INSERT</code> 和 <code>DELETE</code> 会怎么做呢？其实相比 <code>UPDATE</code> 这二者很简单，<code>INSERT</code> 会产生一条新纪录，它的 <code>DATA_TRX_ID</code> 为当前插入记录的事务 <code>ID</code>；<code>DELETE</code> 某条记录时可看成是一种特殊的 <code>UPDATE</code>，其实是软删，真正执行删除操作会在 <code>commit</code> 时，<code>DATA_TRX_ID</code>则记录下删除该记录的事务 <code>ID</code>。</p>
<h3 id="如何实现一致性读-——-ReadView"><a href="#如何实现一致性读-——-ReadView" class="headerlink" title="如何实现一致性读 —— ReadView"></a>如何实现一致性读 —— ReadView</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 <code>RU</code> 隔离级别下，直接读取版本的最新记录就 OK，对于 <code>SERIALIZABLE</code> 隔离级别，则是通过加锁互斥来访问数据，因此不需要 <code>MVCC</code> 的帮助。因此<strong><code>MVCC</code> 运行在 <code>RC</code> 和 <code>RR</code> 这两个隔离级别下，当 <code>InnoDB</code> 隔离级别设置为二者其一时，在 <code>SELECT</code> 数据时就会用到版本链</strong></p>
<blockquote>
<p>核心问题是版本链中哪些版本对当前事务可见？</p>
</blockquote>
<p><code>InnoDB</code> 为了解决这个问题，设计了 <code>ReadView</code>（可读视图）的概念。</p>
<h4 id="RR-下的-ReadView-生成"><a href="#RR-下的-ReadView-生成" class="headerlink" title="RR 下的 ReadView 生成"></a>RR 下的 ReadView 生成</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 <code>RR</code> 隔离级别下，每个事务 <code>touch first read</code> 时（本质上就是<strong>执行第一个 <code>SELECT</code> 语句时，后续所有的 <code>SELECT</code> 都是复用这个 <code>ReadView</code>，其它 <code>update</code>, <code>delete</code>, <code>insert</code> 语句和一致性读 <code>snapshot</code> 的建立没有关系</strong>），会将当前系统中的所有的活跃事务拷贝到一个列表生成<code>ReadView</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下图中事务 <code>A</code> 第一条 <code>SELECT</code> 语句在事务 <code>B</code> 更新数据前，因此生成的 <code>ReadView</code> 在事务 <code>A</code> 过程中不发生变化，即使事务 <code>B</code> 在事务 <code>A</code> 之前提交，但是事务 <code>A</code> 第二条查询语句依旧无法读到事务 <code>B</code> 的修改。</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895ly1g49zfpi9jqj20h90gz0tp.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下图中，事务 <code>A</code> 的第一条 <code>SELECT</code> 语句在事务 <code>B</code> 的修改提交之后，因此可以读到事务 <code>B</code>的修改。<strong>但是注意，如果事务 A 的第一条 SELECT 语句查询时，事务 B 还未提交，那么事务 A 也查不到事务 B 的修改。</strong></p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895ly1g49zqz1t94j20h90gz755.jpg" alt="img"></p>
<h4 id="RC-下的-ReadView-生成"><a href="#RC-下的-ReadView-生成" class="headerlink" title="RC 下的 ReadView 生成"></a>RC 下的 ReadView 生成</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在 <code>RC</code> 隔离级别下，每个 <code>SELECT</code> 语句开始时，都会重新将当前系统中的所有的活跃事务拷贝到一个列表生成 <code>ReadView</code></strong>。二者的区别就在于<strong>生成 <code>ReadView</code> 的时间点不同，一个是事务之后第一个 <code>SELECT</code> 语句开始、一个是事务中每条 <code>SELECT</code> 语句开始</strong>。</p>
<h3 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h3><blockquote>
<p>ReadView主要结构</p>
<ul>
<li><p>m_low_limit_id。 事务ID大于等于该值的数据修改不可见</p>
</li>
<li><p>m_up_limit_id. 事务ID小于该值的数据修改可见。</p>
</li>
<li><p>m_creator_trx_id。创建该ReadView的事务，该事务ID的数据修改可见。</p>
</li>
<li><p>m_ids。当快照创建时的活跃读写事务列表。</p>
</li>
<li><p>m_low_limit_no。事务number，上一节介绍Undo log时候，事务提交时候获取同时写入Undo log中的值。事务number小于该值的对该ReadView不可见。利用该信息可以Purge不需要的Undo。</p>
</li>
<li><p>m_closed。 标记该ReadView closed，用于优化减少trx_sys-&gt;mutex这把大锁的使用。</p>
<p>可以看到在view_close的时候如果是在不持有trx_sys-&gt;mutex锁的情况下，会仅将ReadView标记为closed，并不会把ReadView从m_views的list中移除。</p>
</li>
</ul>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>ReadView</code> 中是当前活跃的事务 <code>ID</code> 列表，称之为 <code>m_ids</code>，其中最小值为 <code>m_up_limit_id</code>，最大值为 <code>m_low_limit_id</code>，事务 <code>ID</code> 是事务开启时 <code>InnoDB</code> 分配的，其大小决定了事务开启的先后顺序，因此我们可以通过 <code>ID</code> 的大小关系来决定版本记录的可见性</strong>。</p>
<p>具体判断流程如下：</p>
<ol>
<li>如果被访问版本的 <code>trx_id</code> 小于 <code>m_ids</code> 中的最小值 <code>m_up_limit_id</code>，说明生成该版本的事务在 <code>ReadView</code> 生成前就已经提交了，所以该版本可以被当前事务访问。</li>
<li>如果被访问版本的 <code>trx_id</code> 大于 <code>m_ids</code> 列表中的最大值 <code>m_low_limit_id</code>，说明生成该版本的事务在生成 <code>ReadView</code> 后才生成，所以该版本不可以被当前事务访问。需要根据 <code>Undo Log</code> 链找到前一个版本，然后根据该版本的 <code>DB_TRX_ID</code>重新判断可见性。</li>
<li>如果被访问版本的 <code>trx_id</code> 属性值在 <code>m_ids</code> 列表中最大值和最小值之间（包含），那就需要判断一下 <code>trx_id</code> 的值是不是在 <code>m_ids</code> 列表中。如果在，说明创建 <code>ReadView</code>时生成该版本所属事务还是活跃的，因此该版本不可以被访问，需要查找 Undo Log 链得到上一个版本，然后根据该版本的 <code>DB_TRX_ID</code> 再从头计算一次可见性；如果不在，说明创建 <code>ReadView</code> 时生成该版本的事务已经被提交，该版本可以被访问。</li>
<li>此时经过一系列判断我们已经得到了这条记录相对 <code>ReadView</code> 来说的可见结果。此时，如果这条记录的 <code>delete_flag</code> 为 <code>true</code>，说明这条记录已被删除，不返回。否则说明此记录可以安全返回给客户端。</li>
</ol>
<p><img src="https://liuzhengyang.github.io/images/readview-visible.jpg" alt="img"></p>
<h3 id="举个例子"><a href="#举个例子" class="headerlink" title="举个例子"></a>举个例子</h3><p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895gy1g2lrq1k5r0j20iy0hkt9l.jpg" alt="img"></p>
<h5 id="RC-下的-MVCC-判断流程"><a href="#RC-下的-MVCC-判断流程" class="headerlink" title="RC 下的 MVCC 判断流程"></a>RC 下的 MVCC 判断流程</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们现在回看刚刚的查询过程，为什么事务 <code>B</code> 在 <code>RC</code> 隔离级别下，两次查询的 <code>x</code> 值不同。<code>RC</code> 下 <code>ReadView</code> 是在语句粒度上生成的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当事务 <code>A</code> 未提交时，事务 <code>B</code> 进行查询，假设事务 <code>B</code> 的事务 <code>ID</code> 为 <code>300</code>，此时生成 <code>ReadView</code> 的 <code>m_ids</code> 为 [200，300]，而最新版本的 <code>trx_id</code> 为 <code>200</code>，处于 <code>m_ids</code> 中，则该版本记录不可被访问，查询版本链得到上一条记录的 trx_id 为 <code>100</code>，小于 <code>m_ids</code> 的最小值 <code>200</code>，因此可以被访问，此时事务 <code>B</code> 就查询到值 <code>10</code> 而非 <code>20</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;待事务 <code>A</code> 提交之后，事务 <code>B</code> 进行查询，此时生成的 <code>ReadView</code> 的 <code>m_ids</code> 为 [300]，而最新的版本记录中 <code>trx_id</code> 为 <code>200</code>，小于 <code>m_ids</code> 的最小值 <code>300</code>，因此可以被访问到，此时事务 <code>B</code> 就查询到 <code>20</code>。</p>
<h5 id="RR-下的-MVCC-判断流程"><a href="#RR-下的-MVCC-判断流程" class="headerlink" title="RR 下的 MVCC 判断流程"></a>RR 下的 MVCC 判断流程</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果在 <code>RR</code> 隔离级别下，为什么事务 <code>B</code> 前后两次均查询到 <code>10</code> 呢？<code>RR</code> 下生成 <code>ReadView</code>是在事务开始时，m_ids 为 [200,300]，后面不发生变化，因此即使事务 <code>A</code> 提交了，<code>trx_id</code> 为 <code>200</code> 的记录依旧处于 <code>m_ids</code> 中，不能被访问，只能访问版本链中的记录 <code>10</code>。</p>
<h3 id="一个争论点"><a href="#一个争论点" class="headerlink" title="一个争论点"></a>一个争论点</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;其实并非所有的情况都能套用 <code>MVCC</code> 读的判断流程，<strong>特别是针对在事务进行过程中，另一个事务已经提交修改的情况下</strong>，这时不论是 <code>RC</code> 还是 <code>RR</code>，直接套用 <code>MVCC</code> 判断都会有问题，例如 <code>RC</code> 下：</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895ly1g49yvo88rsj20h90gzwf4.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;事务 <code>A</code> 的 <code>trx_id = 200</code>，事务 <code>B</code> 的 <code>trx_id = 300</code>，且事务 <code>B</code> 修改了数据之后在事务 <code>A</code> 之前提交，此时 <code>RC</code> 下事务 <code>A</code> 读到的数据为事务 <code>B</code> 修改后的值，这是很显然的。下面我们套用下 <code>MVCC</code> 的判断流程，考虑到事务 <code>A</code> 第二次 <code>SELECT</code> 时，<code>m_ids</code> 应该为 [200]，此时该行数据最新的版本 <code>DATA_TRX_ID = 300</code> 比 <code>200</code> 大，照理应该不能被访问，但实际上事务 <code>A</code> 选取了这条记录返回。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里其实应该结合 <code>RC</code> 的本质来看，<strong><code>RC</code> 的本质就是事务中每一条 <code>SELECT</code> 语句均可以看到其他已提交事务对数据的修改，那么只要该事物已经提交其结果就是可见的，与这两个事务开始的先后顺序无关</strong>，<strong>不完全适用于 MVCC 读</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RR</code> 级别下还是用之前那张图：</p>
<p><img src="//blog.com/2019/06/23/MySQL InnoDB MVCC 机制的原理及实现/c3beb895ly1g49zqz1t94j20h90gz755.jpg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这张图的流程中，事务 <code>B</code> 的 <code>trx_id = 300</code> 比事务 <code>A</code> <code>200</code> 大，且事务 <code>B</code> 先于事务 <code>A</code> 提交，按照 <code>MVCC</code> 的判断流程，事务 <code>A</code> 生成的 <code>ReadView</code> 为 [200]，最新版本的行记录 <code>DATA_TRX_ID = 300</code> 比 <code>200</code> 大，照理不能访问到，但是事务 <code>A</code> 实际上读到了事务 <code>B</code> 已经提交的修改。这里还是结合 <code>RR</code> 本质进行解释，<strong><code>RR</code> 的本质是从第一个 <code>SELECT</code> 语句生成 <code>ReadView</code> 开始，任何已经提交过的事务的修改均可见</strong>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RC</code>、<code>RR</code> 两种隔离级别的事务在执行普通的读操作时，通过访问版本链的方法，使得事务间的读写操作得以并发执行，从而提升系统性能。<strong><code>RC</code>、<code>RR</code> 这两个隔离级别的一个很大不同就是生成 <code>ReadView</code> 的时间点不同。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>RC</code> 在每一次 <code>SELECT</code> 语句前都会生成一个 <code>ReadView</code>，事务期间会更新，因此在其他事务提交前后所得到的 <code>m_ids</code> 列表可能发生变化，使得先前不可见的版本后续又突然可见了</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>RR</code> 只在事务的第一个 <code>SELECT</code> 语句时生成一个 <code>ReadView</code>，事务操作期间不更新</strong>。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>《高性能 MySQL》</li>
<li><a href="http://ronaldbradford.com/blog/understanding-innodb-mvcc-2009-07-15/" target="_blank" rel="noopener">Understanding InnoDB MVCC</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-multi-versioning.html" target="_blank" rel="noopener">15.3 InnoDB Multi-Versioning</a></li>
<li><a href="http://mysql.taobao.org/monthly/2018/11/04/" target="_blank" rel="noopener">MySQL · 引擎特性 · InnoDB MVCC 相关实现</a></li>
<li><a href="https://juejin.im/post/5c9b1b7df265da60e21c0b57" target="_blank" rel="noopener">MySQL事务隔离级别和MVCC</a></li>
<li><a href="https://juejin.im/entry/58f86815ac502e00638e1c97" target="_blank" rel="noopener">MVCC 原理探究及 MySQL 源码实现分析</a></li>
<li><a href="https://wenku.baidu.com/view/69d5c129192e45361066f5fb.html" target="_blank" rel="noopener">深入浅出INNODB MVCC机制与原理</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/22/PHP实现一致性哈希算法并运用到分库分表中/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/PHP实现一致性哈希算法并运用到分库分表中/" itemprop="url">PHP实现一致性哈希算法并运用到分库分表中</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T12:12:57+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据分片/" itemprop="url" rel="index">
                    <span itemprop="name">数据分片</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据分片/一致性哈希算法/" itemprop="url" rel="index">
                    <span itemprop="name">一致性哈希算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP实现一致性哈希算法并运用到分库分表中"><a href="#PHP实现一致性哈希算法并运用到分库分表中" class="headerlink" title="PHP实现一致性哈希算法并运用到分库分表中"></a>PHP实现一致性哈希算法并运用到分库分表中</h1><h2 id="水平分表的常见做法"><a href="#水平分表的常见做法" class="headerlink" title="水平分表的常见做法"></a>水平分表的常见做法</h2><ol>
<li>针对业务唯一id <strong>hash取余</strong></li>
<li>业务唯一id范围或时间范围 <strong>根据范围判断落到那个表</strong></li>
</ol>
<p><strong>弊端</strong>：<strong>不利于后期扩展，数据迁移成本高，数据需要大量移动</strong></p>
<h2 id="我们的方案"><a href="#我们的方案" class="headerlink" title="我们的方案"></a>我们的方案</h2><p>采用<strong>一致性hash算法【虚节点】</strong> ，保证数据的均匀分布</p>
<h2 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现"></a>如何实现</h2><p>如何在不借助其它中间件的情况下，实现分表？</p>
<p>方案：<strong>将分表键全局保存，修改模型对应的表名，在model的__construct中通过得出一致性哈希算法表名，然后setTable</strong>，几乎不用修改其它任何东西。</p>
<p><strong>全局保存的存储载体是session或缓存</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( session(<span class="string">'分表键保存key'</span>) &amp;&amp; config(<span class="string">'表配置'</span>) )&#123;</span><br><span class="line">        $consistHash = <span class="keyword">new</span> \ConsistHashingHelper(config(<span class="string">'表配置'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;table = $consistHash-&gt;allocate(session(<span class="string">'分表键保存key'</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setTable(<span class="keyword">$this</span>-&gt;table);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一致性哈希算法实现"><a href="#一致性哈希算法实现" class="headerlink" title="一致性哈希算法实现"></a>一致性哈希算法实现</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: liuzeming</span></span><br><span class="line"><span class="comment"> * Email：2550705721<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> * Date: 2019/2/1</span></span><br><span class="line"><span class="comment"> * Time: 10:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsistHashingHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//物理节点</span></span><br><span class="line">    <span class="keyword">private</span> $resourceAddress = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一致性哈希环</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $hashRing = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//虚拟节点数目</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $VIRTUAL_NODE_COUNT = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ConsistHashingHelper constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $resourceAddress 物理节点（数据库表名或服务器地址……）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $need_virtual_node 是否需要开启虚节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $virtual_node_number 虚节点个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($resourceAddress, $need_virtual_node=true, $virtual_node_number=<span class="number">128</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( ! is_array($resourceAddress) )&#123;</span><br><span class="line">            $resourceAddress = (<span class="keyword">array</span>)$resourceAddress;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>::$VIRTUAL_NODE_COUNT = $virtual_node_number;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;resourceAddress = $resourceAddress;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">self</span>::$hashRing)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($need_virtual_node &amp;&amp; $virtual_node_number) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;initHashRingWithVirtualNode();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;initHashRingWithoutVirtualNode();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化哈希环，没有虚拟节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initHashRingWithoutVirtualNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;resourceAddress <span class="keyword">as</span> $resource_item) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$hashRing[<span class="keyword">self</span>::hash($resource_item)] = $resource_item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化哈希环，有虚拟节点</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initHashRingWithVirtualNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;resourceAddress <span class="keyword">as</span> $resource_item) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;addResource($resource_item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">hash</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// hash(i) = hash(i-1) * 33 + str[i]</span></span><br><span class="line">        $hash = <span class="number">0</span>;</span><br><span class="line">        $s    = md5($str);</span><br><span class="line">        $seed = <span class="number">5</span>;</span><br><span class="line">        $len  = <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">            <span class="comment">// (hash &lt;&lt; 5) + hash 相当于 hash * 33</span></span><br><span class="line">            <span class="comment">//$hash = sprintf("%u", $hash * 33) + ord($s&#123;$i&#125;);</span></span><br><span class="line">            <span class="comment">//$hash = ($hash * 33 + ord($s&#123;$i&#125;)) &amp; 0x7FFFFFFF;</span></span><br><span class="line">            $hash = ($hash &lt;&lt; $seed) + $hash + ord($s&#123;$i&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $hash &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public static function hash($key)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $str = md5($key);</span></span><br><span class="line"><span class="comment">        return sprintf('%u', crc32($str));</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据虚节点获取对应物理节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealNode</span><span class="params">($virtualNode)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos($virtualNode, <span class="string">'#'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $virtualNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> explode(<span class="string">'#'</span>, $virtualNode)[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为key分配resource(真实物理节点)</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">allocate</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $hashValue = <span class="keyword">self</span>::hash($key);</span><br><span class="line">        $node = <span class="keyword">$this</span>-&gt;getBelongNode($hashValue);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRealNode($node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对应的物理节点或虚节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $findKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="function"><span class="keyword">function</span>  <span class="title">getBelongNode</span><span class="params">($findKey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 对hash环上的值进行排序</span></span><br><span class="line">        ksort(<span class="keyword">self</span>::$hashRing, SORT_NUMERIC);</span><br><span class="line"></span><br><span class="line">        $len  = count(<span class="keyword">self</span>::$hashRing);</span><br><span class="line">        <span class="keyword">if</span> ($len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"分配节点出错"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 虚节点hash值或物理节点hash</span></span><br><span class="line">        $keys   = array_keys(<span class="keyword">self</span>::$hashRing);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 虚节点或物理节点</span></span><br><span class="line">        $values = array_values(<span class="keyword">self</span>::$hashRing);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 所属节点</span></span><br><span class="line">        $node = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不在区间内，则返回最后一个物理节点</span></span><br><span class="line">        <span class="keyword">if</span> ($findKey &lt;= $keys[<span class="number">0</span>] || $findKey &gt;= $keys[$len - <span class="number">1</span>]) &#123;</span><br><span class="line">            $node = $values[$len - <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span> $node;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历虚节点hash值或物理节点hash</span></span><br><span class="line">        <span class="keyword">foreach</span> ($keys <span class="keyword">as</span> $key  =&gt; $pos) &#123;</span><br><span class="line">            $next_pos = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 是否是最后一个虚节点</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($keys[$key + <span class="number">1</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                $next_pos = $keys[$key + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 最后一个节点还没有匹配到所属节点，就分配环上最后一个虚节点（理论上不存在这种情况，因为首先对$findKey的值做了判断，不会进入循环）</span></span><br><span class="line">            <span class="keyword">if</span> (is_null($next_pos)) &#123;</span><br><span class="line">                $node = $values[$key];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 区间判断</span></span><br><span class="line">            <span class="keyword">if</span> ($findKey &gt;= $pos &amp;&amp; $findKey &lt; $next_pos) &#123;</span><br><span class="line">                $node = $values[$key];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHashRing</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$hashRing;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $resource_item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addResource</span><span class="params">($resource_item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! in_array($resource_item, <span class="keyword">$this</span>-&gt;resourceAddress)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;resourceAddress[] = $resource_item;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt;<span class="keyword">self</span>::$VIRTUAL_NODE_COUNT; $i++) &#123;</span><br><span class="line">            $virtualServer = $resource_item .<span class="string">"#virtual"</span> .$i;</span><br><span class="line">            <span class="keyword">self</span>::$hashRing[<span class="keyword">self</span>::hash($virtualServer)] = $virtualServer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除服务器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $resource_item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dropResource</span><span class="params">($resource_item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $index = array_search($resource_item, <span class="keyword">$this</span>-&gt;resourceAddress);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($index === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">"服务器不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 物理节点是相等 存在虚节点时，是以对应物理存储地址开头</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$hashRing <span class="keyword">as</span> $hash =&gt; $resource_item_address) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">"/^$resource_item/"</span>, $resource_item_address)) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">self</span>::$hashRing[$hash]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;resourceAddress[$index]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/22/编程中的幂等性 —— HTTP幂等性/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/编程中的幂等性 —— HTTP幂等性/" itemprop="url">高并发下接口幂等性解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T12:12:57+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/幂等性/" itemprop="url" rel="index">
                    <span itemprop="name">幂等性</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="编程中的幂等性-——-HTTP幂等性"><a href="#编程中的幂等性-——-HTTP幂等性" class="headerlink" title="编程中的幂等性 —— HTTP幂等性"></a>编程中的幂等性 —— HTTP幂等性</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://www.i3geek.com/archives/841" target="_blank" rel="noopener">https://www.i3geek.com/archives/841</a></p>
</blockquote>
<p><br></p>
<blockquote>
<p>幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。</p>
<p>在编程中.<strong>一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同</strong>。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“getUsername()和setTrue()”函数就是一个幂等函数.更复杂的操作幂等保证是利用唯一交易号(流水号)实现.</p>
<p>——百度百科</p>
</blockquote>
<h2 id="什么是幂等性-Idempotence-？"><a href="#什么是幂等性-Idempotence-？" class="headerlink" title="什么是幂等性(Idempotence)？"></a>什么是幂等性(Idempotence)？</h2><blockquote>
<p>Methods can also have the property of “idempotence” in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request.</p>
<p>——HTTP/1.1规范中幂等性的定义</p>
</blockquote>
<p>从定义上看，HTTP方法的幂等性是指一次和多次请求某一个资源应该具有同样的副作用。说白了就是，<strong>同一个请求，发送一次和发送N次效果是一样的！</strong>幂等性是分布式系统设计中十分重要的概念，而HTTP的分布式本质也决定了它在HTTP中具有重要地位。下面将以HTTP中的幂等性做例子加以介绍。</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>假设有一个从账户取钱的远程API（可以是HTTP的，也可以不是），我们暂时用类函数的方式记为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bool withdraw(account_id, amount)</span><br></pre></td></tr></table></figure>
<p>withdraw的语义是从account_id对应的账户中扣除amount数额的钱；如果扣除成功则返回true，账户余额减少amount；如果扣除失败则返回false，账户余额不变。</p>
<p>值得注意的是：和本地环境相比，<strong>我们不能轻易假设分布式环境的可靠性</strong>。</p>
<p>所以问题来了，一种典型的情况是withdraw请求已经被服务器端正确处理，但服务器端的返回结果由于网络等原因被掉丢了，导致客户端无法得知处理结果。如果是在网页上，一些不恰当的设计可能会使用户认为上一次操作失败了，然后刷新页面，这就导致了withdraw被调用两次，账户也被多扣了一次钱。如图所示：</p>
<p><img src="//blog.com/2019/06/22/编程中的幂等性 —— HTTP幂等性/033717ZKv.png" alt="non-idempotent"></p>
<p>解决方案一：采用分布式事务，通过引入支持分布式事务的中间件来保证withdraw功能的事务性。分布式事务的优点是对于调用者很简单，复杂性都交给了中间件来管理。缺点则是一方面架构太重量级，容易被绑在特定的中间件上，不利于异构系统的集成；另一方面分布式事务虽然能保证事务的ACID性质，而但却无法提供性能和可用性的保证。</p>
<p>解决方案二：幂等设计。我们可以通过一些技巧把withdraw变成幂等的，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int create_ticket() </span><br><span class="line">bool idempotent_withdraw(ticket_id, account_id, amount)</span><br></pre></td></tr></table></figure>
<p>create_ticket的语义是<strong>获取一个服务器端生成的唯一的处理号ticket_id，它将用于标识后续的操作</strong>。idempotent_withdraw和withdraw的区别在于关联了一个ticket_id，一个ticket_id表示的操作至多只会被处理一次，每次调用都将返回第一次调用时的处理结果。这样，idempotent_withdraw就符合幂等性了，客户端就可以放心地多次调用。</p>
<p>基于幂等性的解决方案中一个完整的取钱流程被分解成了两个步骤：1.调用create_ticket()获取ticket_id；2.调用idempotent_withdraw(ticket_id, account_id, amount)。虽然create_ticket不是幂等的，但在这种设计下，它对系统状态的影响可以忽略，加上idempotent_withdraw是幂等的，所以任何一步由于网络等原因失败或超时，客户端都可以重试，直到获得结果。如图所示：</p>
<p><img src="//blog.com/2019/06/22/编程中的幂等性 —— HTTP幂等性/033718EYW.png" alt="idempotent"></p>
<p>和分布式事务相比，幂等设计的优势在于它的轻量级，容易适应异构环境，以及性能和可用性方面。在某些性能要求比较高的应用，幂等设计往往是唯一的选择。</p>
<h2 id="HTTP的幂等性"><a href="#HTTP的幂等性" class="headerlink" title="HTTP的幂等性"></a>HTTP的幂等性</h2><p>本文主要以HTTP GET、DELETE、PUT、POST四种方法为主进行语义和幂等性的介绍。</p>
<p><strong>HTTP GET方法用于获取资源，不应有副作用，所以是幂等的。</strong>比如：GET <a href="http://www.bank.com/account/123456，不会改变资源的状态，不论调用一次还是N次都没有副作用。请注意，这里强调的是一次和N次具有相同的副作用，而不是每次GET的结果相同。GET" target="_blank" rel="noopener">http://www.bank.com/account/123456，不会改变资源的状态，不论调用一次还是N次都没有副作用。请注意，这里强调的是一次和N次具有相同的副作用，而不是每次GET的结果相同。GET</a> <a href="http://www.news.com/latest-news这个HTTP请求可能会每次得到不同的结果，但它本身并没有产生任何副作用，因而是满足幂等性的。" target="_blank" rel="noopener">http://www.news.com/latest-news这个HTTP请求可能会每次得到不同的结果，但它本身并没有产生任何副作用，因而是满足幂等性的。</a></p>
<p><strong>HTTP DELETE方法用于删除资源，有副作用，但它应该满足幂等性。</strong>比如：DELETE <a href="http://www.forum.com/article/4231，调用一次和N次对系统产生的副作用是相同的，即删掉id为4231的帖子；因此，调用者可以多次调用或刷新页面而不必担心引起错误。" target="_blank" rel="noopener">http://www.forum.com/article/4231，调用一次和N次对系统产生的副作用是相同的，即删掉id为4231的帖子；因此，调用者可以多次调用或刷新页面而不必担心引起错误。</a></p>
<p><strong>HTTP POST方法用于创建资源，所对应的URI并非创建的资源本身，而是去执行创建动作的操作者，有副作用，不满足幂等性。</strong>比如：POST <a href="http://www.forum.com/articles的语义是在http://www.forum.com/articles下创建一篇帖子，HTTP响应中应包含帖子的创建状态以及帖子的URI。两次相同的POST请求会在服务器端创建两份资源，它们具有不同的URI；所以，POST方法不具备幂等性。" target="_blank" rel="noopener">http://www.forum.com/articles的语义是在http://www.forum.com/articles下创建一篇帖子，HTTP响应中应包含帖子的创建状态以及帖子的URI。两次相同的POST请求会在服务器端创建两份资源，它们具有不同的URI；所以，POST方法不具备幂等性。</a></p>
<p><strong>HTTP PUT方法用于创建或更新操作，所对应的URI是要创建或更新的资源本身，有副作用，它应该满足幂等性。</strong>比如：PUT <a href="http://www.forum/articles/4231的语义是创建或更新ID为4231的帖子。对同一URI进行多次PUT的副作用和一次PUT是相同的；因此，PUT方法具有幂等性。" target="_blank" rel="noopener">http://www.forum/articles/4231的语义是创建或更新ID为4231的帖子。对同一URI进行多次PUT的副作用和一次PUT是相同的；因此，PUT方法具有幂等性。</a></p>
<h3 id="对前文示例进行改进"><a href="#对前文示例进行改进" class="headerlink" title="对前文示例进行改进"></a>对前文示例进行改进</h3><p>利用Web API的形式实现前面所提到的取款功能。</p>
<p>1、用POST /tickets来实现create_ticket；</p>
<p>2、用PUT /accounts/account_id/ticket_id&amp;amount=xxx来实现idempotent_withdraw。</p>
<p>值得注意的是严格来讲amount参数不应该作为URI的一部分，真正的URI应该是/accounts/account_id/ticket_id，而amount应该放在请求的body中。这种模式可以应用于很多场合，比如：论坛网站中防止意外的重复发帖。</p>
<h2 id="电商中遇到的问题"><a href="#电商中遇到的问题" class="headerlink" title="电商中遇到的问题"></a>电商中遇到的问题</h2><h3 id="如何防范-POST-重复提交"><a href="#如何防范-POST-重复提交" class="headerlink" title="如何防范 POST 重复提交"></a>如何防范 POST 重复提交</h3><p>HTTP POST 操作既不是安全的，也不是幂等的（至少在HTTP规范里没有保证）。当我们因为反复刷新浏览器导致多次提交表单，多次发出同样的POST请求，导致远端服务器重复创建出了资源。</p>
<p>所以，对于电商应用来说，第一对应的后端 WebService 一定要做到<strong>幂等性</strong>，第二服务器端收到 POST 请求，在操作成功后<strong>必须302跳转到另外一个页面</strong>，这样即使用户刷新页面，也不会重复提交表单。</p>
<h3 id="把分布式事务分解为具有幂等性的异步消息处理"><a href="#把分布式事务分解为具有幂等性的异步消息处理" class="headerlink" title="把分布式事务分解为具有幂等性的异步消息处理"></a>把分布式事务分解为具有幂等性的异步消息处理</h3><p>电商的很多业务，考虑更多的是 BASE（即Basically Available、Soft state、和Eventually consistent），而不是 ACID（Atomicity、Consistency、Isolation和 Durability）。即为了满足高负载的用户访问，我们可以容忍短暂的数据不一致。那怎么做呢？</p>
<p>第一，不做分布式事务，代价太大。<br>第二，不一定需要实时一致性，只需要保证最终的一致性即可。<br>第三，“通过状态机和严格的有序操作，来最大限度地降低不一致性”。<br>第四，最终一致性（Eventually Consistent）通过异步事件做到。</p>
<p>如果消息具有操作幂等性，也就是一个消息被应用多次与应用一次产生的效果是一样的话，那么把不需要同步执行的事务交给异步消息推送和订阅者集群来处理即可。假如消息处理失败，那么就消息重播，由于幂等性，应用多次也能产生正确的结果。</p>
<p>实际情况下，消息很难具有幂等性，解决方法是使用另一个表记录已经被成功应用的消息，即消息队列和消息应用状态表一起来解决问题。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面简单介绍了幂等性的概念，用幂等设计取代分布式事务的方法，以及HTTP主要方法的语义和幂等性特征。其实，如果要追根溯源，幂等性是数学中的一个概念，表达的是N次变换与1次变换的结果相同，有兴趣的读者可以从Wikipedia上进一步了解。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/" itemprop="url">分布式缓存中数据分片、数据迁移、客户端路由的解决方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-22T12:12:57+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/Redis/数据分片/" itemprop="url" rel="index">
                    <span itemprop="name">数据分片</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="分布式缓存中【数据分片、数据迁移、客户端路由】的解决方案"><a href="#分布式缓存中【数据分片、数据迁移、客户端路由】的解决方案" class="headerlink" title="分布式缓存中【数据分片、数据迁移、客户端路由】的解决方案"></a>分布式缓存中【数据分片、数据迁移、客户端路由】的解决方案</h2><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/tMsQryUhBJsPUFVYgpVJ3w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/tMsQryUhBJsPUFVYgpVJ3w</a></p>
</blockquote>
<p><br></p>
<h2 id="Redis-集群简介"><a href="#Redis-集群简介" class="headerlink" title="Redis 集群简介"></a>Redis 集群简介</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Redis Cluster</code> 是 <code>Redis</code>的分布式解决方案，在 3.0 版本正式推出，有效地解决了 <code>Redis</code>分布式方面的需求。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Redis Cluster</code>一般由多个节点组成，节点数量至少为 6 个才能保证组成完整高可用的集群，其中三个为主节点，三个为从节点。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;三个主节点会分配槽，处理客户端的命令请求，而从节点可用在主节点故障后，顶替主节点。如下图：</p>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZTJTwC59L1ymHBLVVoLhFslvET0rfIZBlEFMGDncv2pic2qMfvTVMIBtQ.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图所示，该集群中包含 6 个 <code>Redis</code> 节点，3主3从，分别为<code>M1，M2，M3，S1，S2，S3</code>。除了主从 <code>Redis</code> 节点之间进行数据复制外，所有 <code>Redis</code>节点之间采用<code>Gossip</code>协议进行通信，交换维护节点元数据信息。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般来说，主 <code>Redis</code> 节点会处理<code>Clients</code>的读写操作，而从节点只处理读操作。</p>
<h2 id="数据分片策略"><a href="#数据分片策略" class="headerlink" title="数据分片策略"></a>数据分片策略</h2><blockquote>
<p>分布式数据存储方案中最为重要的一点就是数据分片，也就是所谓的 Sharding。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了使得集群能够水平扩展，首要解决的问题就是如何将整个数据集按照一定的规则分配到多个节点上</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;常用的数据分片的方法有：<strong>范围分片，哈希分片，一致性哈希算法和虚拟哈希槽</strong>等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;范围分片假设数据集是有序，将顺序相临近的数据放在一起，可以很好的支持遍历操作。范围分片的缺点是面对顺序写时，会存在热点。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如日志类型的写入，一般日志的顺序都是和时间相关的，时间是单调递增的，因此写入的热点永远在最后一个分片。</p>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZTsFEN89VZIMCcrw6V2oI3BITHRZawgV43xGwiaj57KGkAicXL3ygSq4nw.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于关系型的数据库，因为经常性的需要表扫描或者索引扫描，基本上都会使用范围的分片策略。</p>
<h2 id="Redis-虚拟哈希槽"><a href="#Redis-虚拟哈希槽" class="headerlink" title="Redis  虚拟哈希槽"></a>Redis  虚拟哈希槽</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们接下来主要来看<code>Redis Cluster</code> 的虚拟哈希槽策略。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>Redis Cluster</code>采用虚拟哈希槽分区，所有的键根据哈希函数映射到<code>0 ~ 16383</code> 整数槽内</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;计算公式：<strong><code>slot = CRC16(key) &amp; 16383</code>，每一个节点负责维护一部分槽以及槽所映射的键值数据</strong>。</p>
<h3 id="Redis-虚拟槽分区的特点"><a href="#Redis-虚拟槽分区的特点" class="headerlink" title="Redis 虚拟槽分区的特点"></a>Redis 虚拟槽分区的特点</h3><ul>
<li><strong>解耦数据和节点之间的关系，简化了节点扩容和收缩难度</strong>。</li>
<li><strong>节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据</strong></li>
<li><strong>支持节点、槽和键之间的映射查询，用于数据路由，在线集群伸缩等场景</strong>。</li>
</ul>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZT2FGA4dRgicLiaNjVAWN2l5ibCziaWRBE5PgDyGF13LC7IosgiaVzdrY8yCw.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Redis</code> 集群提供了灵活的节点扩容和收缩方案，在不影响集群对外服务的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以说，<strong>槽是 Redis 集群管理数据的基本单位</strong>，集群伸缩就是槽和数据在节点之间的移动。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面我们就先来看一下<code>Redis</code>集群伸缩的原理。然后再了解当 <code>Redis</code> 节点数据迁移过程中或者故障恢复时如何保证集群可用。</p>
<h3 id="扩容集群"><a href="#扩容集群" class="headerlink" title="扩容集群"></a>扩容集群</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了让读者更好的理解上线节点时的扩容操作，我们通过 <code>Redis Cluster</code> 的命令来模拟整个过程。</p>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZTaoibVQuHKcDuibVX5C8NGJFnlz4GD74I7LjedK4vty0Jyhz4GRzibnickw.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当一个<code>Redis</code>新节点运行并加入现有集群后，我们需要为其迁移槽和数据。首先要为新节点指定槽的迁移计划，确保迁移后每个节点负责相似数量的槽，从而保证这些节点的数据均匀。</p>
<p><strong>1)</strong> 首先启动一个 <code>Redis</code> 节点，记为<code>M4</code>。 </p>
<p><strong>2)</strong> 使用<code>cluster meet</code>命令，让新 <code>Redis</code>节点加入到集群中。新节点刚开始都是主节点状态，由于没有负责的槽，所以不能接受任何读写操作，后续我们就给他迁移槽和填充数据。 </p>
<p><strong>3)</strong> 对<code>M4</code> 节点发送 <code>cluster setslot { slot } importing { sourceNodeId }</code> 命令，让目标节点准备导入槽的数据。 </p>
<p><strong>4)</strong> 对源节点，也就是 <code>M1，M2，M3</code>节点发送 <code>cluster setslot { slot } migrating { targetNodeId }</code>命令，让源节点准备迁出槽的数据。 </p>
<p><strong>5)</strong> 源节点执行 <code>cluster getkeysinslot { slot } { count }</code>命令，获取<code>count</code> 个属于槽<code>{ slot }</code>的键，然后执行步骤六的操作进行迁移键值数据。 </p>
<p><strong>6)</strong> 在源节点上执行 <code>migrate { targetNodeIp} &quot; &quot; 0 { timeout } keys { key... }</code>命令，把获取的键通过 pipeline 机制批量迁移到目标节点，批量迁移版本的 <code>migrate</code>命令在 <code>Redis 3.0.6</code> 以上版本提供。 </p>
<p><strong>7)</strong> 重复执行步骤 5 和步骤 6 直到槽下所有的键值数据迁移到目标节点。 </p>
<p><strong>8)</strong> 向集群内所有主节点发送 <code>cluster setslot { slot } node { targetNodeId }</code>命令，通知槽分配给目标节点。为了保证槽节点映射变更及时传播，需要遍历发送给所有主节点更新被迁移的槽执行新节点。</p>
<h3 id="收缩集群"><a href="#收缩集群" class="headerlink" title="收缩集群"></a>收缩集群</h3><p>收缩节点就是将 <code>Redis</code> 节点下线，整个流程需要如下操作流程。</p>
<p><strong>1)</strong> 首先需要确认下线节点是否有负责的槽，如果是，需要把槽迁移到其他节点，保证节点下线后整个集群槽节点映射的完整性。 </p>
<p><strong>2)</strong> 当下线节点不再负责槽或者本身是从节点时，就可以通知集群内其他节点忘记下线节点，当所有的节点忘记改节点后可以正常关闭。</p>
<p>下线节点需要将节点自己负责的槽迁移到其他节点，原理与之前节点扩容的迁移槽过程一致。</p>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZTy4ia0qKdHy1sjagMMcan6MuTmf0SIPdiboWUnT1WypOnAuvcib0ytib4sQ.png" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;迁移完槽后，还需要通知集群内所有节点忘记下线的节点，也就是说让其他节点不再与要下线的节点进行 <code>Gossip</code>消息交换。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Redis</code>集群使用 <code>cluster forget { downNodeId }</code>命令来讲指定的节点加入到禁用列表中，在禁用列表内的节点不再发送 <code>Gossip</code>消息。</p>
<h3 id="客户端路由"><a href="#客户端路由" class="headerlink" title="客户端路由"></a>客户端路由</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在集群模式下，<code>Redis</code> 节点接收任何键相关命令时首先计算键对应的槽，在根据槽找出所对应的节点，如果节点是自身，则处理键命令；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;否则回复 <strong><code>MOVED</code> 重定向错误，通知客户端请求正确的节点</strong>。这个过程称为 <code>MOVED</code> 重定向。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>需要注意的是 Redis 计算槽时并非只简单的计算键值内容，当键值内容包括大括号时，则只计算括号内的内容。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;比如说，<code>key</code> 为 <code>user:{10000}:books</code>时，计算哈希值只计算10000。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>MOVED</code> 错误示例显示的信息如下，<strong>键 <code>x</code> 所属的哈希槽 <code>3999</code> ，以及负责处理这个槽的节点的 IP 和端口号 <code>127.0.0.1:6381</code></strong> 。 </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;客户端需要根据这个 <code>IP</code> 和端口号， <strong>向所属的节点重新发送一次<code>GET</code>命令请求</strong>。</p>
<ul>
<li><code>GET x-MOVED 3999 127.0.0.1:6381</code></li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于请求重定向会增加 <code>IO</code>开销，这不是 <code>Redis</code>集群高效的使用方式，而是要使用 <code>Smart</code>集群客户端。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>Smart</code> 客户端通过在内部维护<code>slot</code> 到<code>Redis</code> 节点的映射关系，本地就可以实现键到节点的查找，从而保证 <code>IO</code> 效率的最大化，而 <code>MOVED</code> 重定向负责协助客户端更新映射关系</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>Redis</code> 集群支持在线迁移槽( <code>slot</code> ) 和数据来完成水平伸缩，当 <code>slot</code>对应的数据从源节点到目标节点迁移过程中，客户端需要做到智能迁移，保证键命令可正常执行</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例如当 <code>slot</code> 数据从源节点迁移到目标节点时，期间可能出现一部分数据在源节点，而另一部分在目标节点。如下图所示：</p>
<p><img src="//blog.com/2019/06/22/分布式缓存中数据分片、数据迁移、客户端路由的解决方案/q3blumn0btAr9XcewRE2EMia6rVEgm8ZTFicjtPVNzoMiaBF4FWKZtWLT5roUf6b5PPXWqWuqWZtpJMXe8XiavXFtg.png" alt="img"></p>
<p>所以，综合上述情况，客户端命令执行流程如下所示：</p>
<ul>
<li>客户端根据本地 <code>slot</code> 缓存发送命令到源节点，如果存在键对应则直接执行并返回结果给客户端。</li>
<li>如果节点返回<code>MOVED</code>错误，更新本地的<code>slot</code>到<code>Redis</code> 节点的映射关系，然后重新发起请求。</li>
<li>如果数据正在迁移中，节点会回复<code>ASK</code> 重定向异常。格式如下: <code>( error ) ASK { slot } { targetIP } : { targetPort }</code></li>
<li>客户端从 <code>ASK</code> 重定向异常提取出目标节点信息，发送<code>asking</code>命令到目标节点打开客户端连接标识，再执行键命令。</li>
</ul>
<p><code>ASK</code> 和 <code>MOVED</code> 虽然都是对客户端的重定向控制，但是有着本质区别。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>ASK</code> 重定向说明集群正在进行 <code>slot</code> 数据迁移，客户端无法知道什么时候迁移完成，因此只能是临时性的重定向，客户端不会更新 <code>slot</code> 到<code>Redis</code> 节点的映射缓存</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是<strong><code>MOVED</code> 重定向说明键对应的槽已经明确指定到新的节点，因此需要更新<code>slot</code> 到<code>Redis</code> 节点的映射缓存</strong>。</p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当<code>Redis</code>集群内少量节点出现故障时通过自动故障转移保证集群可以正常对外提供服务。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当某一个<code>Redis</code>节点客观下线时，<code>Redis</code> 集群会从其从节点中通过选主选出一个替代它，从而保证集群的高可用性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，有一点要注意。默认情况下，当集群 <code>16384</code> 个槽任何一个没有指派到节点时整个集群不可用。执行任何键命令返回 <code>CLUSTERDOWN Hash slot not served</code> 命令。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当持有槽的主节点下线时，从故障发现到自动完成转移期间整个集群是不可用状态，对于大多数业务无法忍受这情况</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>因此建议将参数 cluster-require-full-coverage 配置为 no ，当主节点故障时只影响它负责槽的相关命令执行，不会影响其他主节点的可用性</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/36/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/36/">36</a><span class="page-number current">37</span><a class="page-number" href="/page/38/">38</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/38/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
