<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/68/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/68/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/从JDK中，我们能学到哪些设计模式/" itemprop="url">从JDK中，我们能学到哪些设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-17T12:12:57+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/设计模式应用/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式应用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="从JDK中，我们能学到哪些设计模式"><a href="#从JDK中，我们能学到哪些设计模式" class="headerlink" title="从JDK中，我们能学到哪些设计模式"></a>从JDK中，我们能学到哪些设计模式</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://juejin.im/post/5cd842d56fb9a0323070efc0" target="_blank" rel="noopener">https://juejin.im/post/5cd842d56fb9a0323070efc0</a></p>
</blockquote>
<p><br></p>
<h2 id="结构性模式"><a href="#结构性模式" class="headerlink" title="结构性模式"></a>结构性模式</h2><h3 id="适配器模式"><a href="#适配器模式" class="headerlink" title="适配器模式"></a>适配器模式</h3><blockquote>
<p>常用于将一个新接口适配旧接口</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacc9edbb3d4d7.png" alt="img"></p>
<p>肥朝小声逼逼：在我们业务代码中经常有<strong>新旧接口适配需求</strong>，可以采用该模式。</p>
<h3 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h3><blockquote>
<p>将抽象和抽象的具体实现进行解耦，这样可以使得抽象和抽象的具体实现可以独立进行变化。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacca43b3a3353.png" alt="img"></p>
<p>肥朝小声逼逼：这个模式，其实我们每天都在用到，但是你可能却浑然不知。只要你用到面向接口编程，其实都是在用桥接模式。</p>
<h3 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h3><blockquote>
<p>让客户端看起来在处理单个对象和对象的组合是平等的，换句话说，某个类型的方法同时也接受自身类型作为参数。（So in other words methods on a type accepting the same type）</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacca862ac15ca.png" alt="img"></p>
<p>肥朝小声逼逼：从上面那句英文我们就可以得知，<strong>组合模式常用于递归操作的优化</strong>上，比如每个公司都有个boss系统，都会有什么菜单的功能。比如一级菜单下有二级菜单，二级菜单又有三级菜单。删除一级菜单的时候需要不断删除子菜单，那么这个设计模式你可以试试。总之，凡是有级联操作的，你都可以尝试这个设计模式。</p>
<h3 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h3><blockquote>
<p>动态的给一个对象附加额外的功能，因此它也是子类化的一种替代方法。该设计模式在JDK中广泛运用，以下只是列举一小部分</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccac00a1ed0f.png" alt="img"></p>
<p>肥朝小声逼逼：这个模式使用就太广了，我们常用的<strong>AOP</strong>，既有动态代理，也有装饰者的味道。</p>
<h3 id="门面模式"><a href="#门面模式" class="headerlink" title="门面模式"></a>门面模式</h3><blockquote>
<p>为一组组件，接口，抽象或子系统提供简化的接口。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccaf0fb0208b.png" alt="img"></p>
<p>肥朝小声逼逼：我们每天使用的SLFJ日志就是<strong>门面日志</strong>，比如我们使用Dubbo，向外提供的服务就尽量采用门面模式，然后服务在调用各种service做聚合。</p>
<h3 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h3><blockquote>
<p>使用缓存来减少对小对象的访问时间</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccb2e24ff2d0.png" alt="img"></p>
<p>肥朝小声逼逼：<strong>只要用到了缓存，基本都是在使用享元模式</strong>。很多同学都说自己的项目太low了，都没有用到什么设计模式，这不是开玩笑吗，你用个map缓存几个对象，基本上都运用了享元的思想。</p>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><blockquote>
<p>代理模式用于向较简单的对象代替创建复杂或耗时的对象。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccb5bbc5020e.png" alt="img"></p>
<p>肥朝小声逼逼：代理模式用得很广泛，基本所有大家知道的开源框架，都用到了动态代理。</p>
<h2 id="创建模式"><a href="#创建模式" class="headerlink" title="创建模式"></a>创建模式</h2><h3 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h3><blockquote>
<p>抽象工厂模式提供了一个协议来生成一系列的相关或者独立的对象，而不用指定具体对象的类型。它使得应用程序能够和使用的框架的具体实现进行解耦。在JDK和许多开源框架，比如Spring中随处可见，它们很容易被发现。任何用于创建对象但返回接口或抽象类的，就是抽象工厂模式了。（any method that is used to create an object but still returns a interface or abstract class）</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccb887eb823e.png" alt="img"></p>
<p>肥朝小声逼逼：从英文就可以得出，该模式可以与策略模式结合使用。</p>
<h3 id="建造者模式"><a href="#建造者模式" class="headerlink" title="建造者模式"></a>建造者模式</h3><blockquote>
<p>用于通过定义一个类来简化复杂对象的创建，该类的目的是构建另一个类的实例。构建器模式还允许实现Fluent接口。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccbb90cdbe6e.png" alt="img"></p>
<p>肥朝小声逼逼：这个在我们业务代码中使用的场景太广泛了。比如订单系统大部分项目都有，订单对象就是一个复杂对象，我们就可以采用建造者模式来做。</p>
<h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><blockquote>
<p>只是一个返回实际类型的方法。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccbf1ce53a3e.png" alt="img"></p>
<p>肥朝小声逼逼：这个属于大家都会的设计模式，不多过介绍。</p>
<h3 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h3><blockquote>
<p>使得类的实例能够生成自身的拷贝。如果创建一个对象的实例非常复杂且耗时时，就可以使用这种模式，而不重新创建一个新的实例，你可以拷贝一个对象并直接修改它。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccc23450b06e.png" alt="img"></p>
<p>肥朝小声逼逼：这个你以为是冷门的设计模式，其实错了，这个是大热门的设计模式。比如我们业务代码，经常要各种DTO、BO、DO、VO转换，其实就可以参考原型设计模式的思想来做。</p>
<h3 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h3><blockquote>
<p>用来确保类只有一个实例。Joshua Bloch在Effetive Java中建议到，还有一种方法就是使用枚举。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccc55cc0fcb3.png" alt="img"></p>
<p>肥朝小声逼逼：在平时开发中，单例是我们用得最多的了，因为<strong>Spring的bean</strong>，默认就是单例级别的。单例属于大家基本都会的设计模式。</p>
<h2 id="行为模式"><a href="#行为模式" class="headerlink" title="行为模式"></a>行为模式</h2><h3 id="责任链"><a href="#责任链" class="headerlink" title="责任链"></a>责任链</h3><blockquote>
<p>通过把请求从一个对象传递到链条中下一个对象的方式来解除对象之间的耦合，直到请求被处理完毕。链中的对象是同一接口或抽象类的不同实现。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccc90a62e5f3.png" alt="img"></p>
<p>肥朝小声逼逼：凡是带有<code>Filter</code>关键词的，基本都在用这个设计模式。在业务代码使用的场景实在是太多了，用到拦截器的地方基本都在用这个设计模式。</p>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><blockquote>
<p>将命令包装在对象中，以便可以将其存储，传递到方法中，并像任何其他对象一样返回。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacccc4a9be297.png" alt="img"></p>
<p>肥朝小声逼逼：命令模式使用频率较高，和策略模式比较像，具体区别可以搜索一下。如果用过<code>Activiti</code>工作流引擎的朋友可以看一下里面的源码，很多地方都用到了命令模式。</p>
<h3 id="解释器模式"><a href="#解释器模式" class="headerlink" title="解释器模式"></a>解释器模式</h3><blockquote>
<p>此模式通常描述为该语言定义语法并使用该语法来解释该格式的语句。（This pattern generally describes defining a grammar for that language and using that grammar to interpret statements in that format.）</p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/13/16aacccfd61a5cb3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>肥朝小声逼逼：这个比较冷门，肥朝没怎么用过，你用过的话可以留言告诉肥朝。</p>
<h3 id="迭代器模式"><a href="#迭代器模式" class="headerlink" title="迭代器模式"></a>迭代器模式</h3><blockquote>
<p>提供一个统一的方式来访问集合中的对象。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccd2313d6e16.png" alt="img"></p>
<p>肥朝小声逼逼：这个中间件和基础框架组的同学可能用得比较多，业务代码的话用得不多，不过JDK中的这种使用很经典，可以看看。</p>
<h3 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h3><blockquote>
<p>通过使用一个中间对象来进行消息分发以及减少类之间的直接依赖。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccd5f3c0c5c2.png" alt="img"></p>
<p>肥朝小声逼逼：看到这个描述不用我多说什么，业务代码使用的场景太多了。比如你们<strong>用MQ，其实就是在用中介者模式</strong>。所以肥朝一再强调，即使是每天CRUD，关注肥朝一起学习，也能给你的CRUD项目，加上美颜+滤镜（设计模式）的加强效果。</p>
<h3 id="备忘录模式"><a href="#备忘录模式" class="headerlink" title="备忘录模式"></a>备忘录模式</h3><blockquote>
<p>生成对象状态的一个快照，以便对象可以恢复原始状态而不用暴露自身的内容。比如Date对象通过自身内部的一个long值来实现备忘录模式。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccda27fb9933.png" alt="img"></p>
<p>肥朝小声逼逼：这个在业务中使用得不多，据肥朝了解其中一种场景是，你要把数据丢到MQ，但是MQ暂时不可用，那么你把数据暂存到DB，后面再轮询丢到MQ。如果你有更好的场景，留言告诉肥朝。</p>
<h3 id="空对象模式"><a href="#空对象模式" class="headerlink" title="空对象模式"></a>空对象模式</h3><blockquote>
<p>它允许您抽象空对象的处理。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccddcbd13e7e.png" alt="img"></p>
<p>肥朝小声逼逼：这个业务代码用得不多，但是JDK中的这几个方法我们倒是挺常用的。</p>
<h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><blockquote>
<p>用于为组件提供一种灵活地向感兴趣的接收者广播消息的方式。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacce02d370428.png" alt="img"></p>
<p>肥朝小声逼逼：我们业务代码一般是基于Zookeeper来做观察者的。基本上用到ZK的地方，都是在用观察者模式，比如分布式锁，比如服务发现等。</p>
<h3 id="状态模式"><a href="#状态模式" class="headerlink" title="状态模式"></a>状态模式</h3><blockquote>
<p>允许您在运行时根据内部状态轻松更改对象的行为。</p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/13/16aacce527a82fdc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>肥朝小声逼逼：这个在业务代码用得就太广泛了，我就不信你们系统还没有“状态”了。比如我们常见的订单状态或者各种XX状态，都可以用得上。</p>
<h3 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h3><blockquote>
<p>使用这个模式来将一组算法封装成一系列对象。通过调用这些对象可以灵活的改变程序的功能。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aacce9ceb66a5b.png" alt="img"></p>
<p>肥朝小声逼逼：这个太高频了，常用于优化大量的<code>if-else</code>,如果这个设计模式都不会，出去不要说关注过肥朝的公众号！</p>
<h3 id="模板方法模式"><a href="#模板方法模式" class="headerlink" title="模板方法模式"></a>模板方法模式</h3><blockquote>
<p>让子类可以重写方法的一部分，而不是整个重写，你可以控制子类需要重写那些操作。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccee3d41a4bb.png" alt="img"></p>
<p>肥朝小声逼逼：这个模式也是非常高频的模式。业务代码中经常遇到有很多相同的部分，我们可以<strong>做一个抽象类，子类来实现差异化</strong>，如果还不知道的，赶紧搜索一下，再次强调，非常高频。</p>
<h3 id="访问者模式"><a href="#访问者模式" class="headerlink" title="访问者模式"></a>访问者模式</h3><blockquote>
<p>提供一个方便的可维护的方式来操作一组对象。它使得你在不改变操作的对象前提下，可以修改或者扩展对象的行为。</p>
</blockquote>
<p><img src="//blog.com/2019/05/17/从JDK中，我们能学到哪些设计模式/16aaccf1839da02f.png" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/17/Service Container 核心概念/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/Service Container 核心概念/" itemprop="url">Service Container 核心概念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-17T12:12:57+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Service-Container-核心概念"><a href="#Service-Container-核心概念" class="headerlink" title="Service Container 核心概念"></a>Service Container 核心概念</h1><ul>
<li>正文<ul>
<li><a href="#%E4%B8%80%E4%B8%AA%E5%9F%BA%E7%A1%80%E7%89%88%E7%9A%84-IOC-Container">一个基础版的 IOC Container</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%90%86%E8%A7%A3-IOC-Container-%E5%AF%B9%E4%BA%8E%E7%90%86%E8%A7%A3-Laravel-%E6%9E%B6%E6%9E%84%E6%98%AF%E5%A6%82%E6%AD%A4%E7%9A%84%E9%87%8D%E8%A6%81%EF%BC%9F">为什么理解 IOC Container 对于理解 Laravel 架构是如此的重要？</a></li>
<li><a href="#%E8%AF%A5%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-Laravel-%E7%9A%84-IOC-Container%EF%BC%88-Service-Container-%EF%BC%89%EF%BC%9F">该如何使用 Laravel 的 IOC Container（ Service Container ）？</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%B8%8D%E9%80%9A%E8%BF%87-Service-Provider-%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8-IOC-Container%EF%BC%9F">如何不通过 Service Provider 直接使用 IOC Container？</a></li>
<li><a href="#%E4%B8%BA%E4%BD%95%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%E9%83%BD%E9%80%9A%E8%BF%87-Service-Provider-%E6%9D%A5%E4%BD%BF%E7%94%A8-IOC-Container%EF%BC%9F">为何大多数情况都通过 Service Provider 来使用 IOC Container？</a></li>
<li>如何通过 Service Provider 来使用 IOC Container？<ul>
<li><a href="#Laravel-%E7%9A%84%E5%8F%91%E6%98%8E%E8%80%85%E6%98%AF%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87-Service-Provider-%E6%9D%A5%E4%BD%BF%E7%94%A8-IOC-Container-%E4%B8%BA-Laravel-%E6%A1%86%E6%9E%B6%E6%B7%BB%E5%8A%A0%E7%89%B9%E6%80%A7%E5%92%8C%E5%8A%9F%E8%83%BD%E7%9A%84%EF%BC%9F">Laravel 的发明者是如何通过 Service Provider 来使用 IOC Container 为 Laravel</a></li>
<li><a href="#Facade-%E6%98%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%9A%84%EF%BC%9F">Facade 是如何使用的？</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%B0%86%E6%9F%90%E4%B8%AA%E7%B1%BB%E9%80%9A%E8%BF%87-Service-Provider-%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C-bind-%E5%88%B0-Laravel-%E7%9A%84-IOC-Container-%E4%B8%AD%EF%BC%9F">如何将某个类通过 Service Provider 的方式， bind 到 Laravel 的 IOC Container 中？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
<li><a href="#%E5%90%8E%E7%BB%AD">后续</a></li>
<li><a href="#%E6%83%B3%E7%9F%A5%E9%81%93%E6%9B%B4%E5%A4%9A">想知道更多</a></li>
</ul>
<h3 id="一个基础版的-IOC-Container"><a href="#一个基础版的-IOC-Container" class="headerlink" title="一个基础版的 IOC Container"></a>一个基础版的 IOC Container</h3><p>也许你以前就知道什么是 IOC， 也许你是从上面那篇文章才开始对 IOC 有懵懂的认识。</p>
<p>现在我们都从同一个起点出发. 就是再来重新再来写一个基础版的 IOC Container.</p>
<p>为什么要写这个基础版的 IOC Container 出来呢， 因为 Laravel 框架的 IOC Container 原理上跟上面的这个基础版是一模一样的, 包括方法的名字, 参数的传入方式等.</p>
<p>而且在下文，当我使用 <code>bind</code> 和 <code>make</code> 2个词的时候，我指的就是 Container 中的这2个方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $binds;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> $instances;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">Todo:</span> 向 container 添加一种对象的的生产方式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//$abstract: 第一个参数 $abstract, 一般为一个字符串(有时候也会是一个接口), 当你需要 make 这个类的对象的时候, 传入这个字符串(或者接口), 这样make 就知道制造什么样的对象了</span></span><br><span class="line">    <span class="comment">//$concrete: 第二个参数 $concrete, 一般为一个 Closure 或者 一个单例对象, 用于说明制造这个对象的方式</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($concrete <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;binds[$abstract] = $concrete;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;instances[$abstract] = $concrete;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, $parameters = [])</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">Todo:</span> 生产一种对象</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//$abstract: 在bind方法中已经介绍过</span></span><br><span class="line">    <span class="comment">//$parameters: 生产这种对象所需要的参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;instances[$abstract])) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;instances[$abstract];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    array_unshift($parameters, <span class="keyword">$this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;binds[$abstract], $parameters);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="为什么理解-IOC-Container-对于理解-Laravel-架构是如此的重要？"><a href="#为什么理解-IOC-Container-对于理解-Laravel-架构是如此的重要？" class="headerlink" title="为什么理解 IOC Container 对于理解 Laravel 架构是如此的重要？"></a>为什么理解 IOC Container 对于理解 Laravel 架构是如此的重要？</h3><p>因为在 Laravel 中，你所能使用到的 Laravel 的特性和功能几乎全部是由 IOC Container 实现的。</p>
<p>比如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cache::get(<span class="string">'key'</span>); </span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="string">'HomeController@index'</span>);</span><br></pre></td></tr></table></figure>
<p>Cache 和 Route 都是通过把他们各自的实现类 <code>bind</code> 到某个 Laravel 的 Container 后，那个 Container 所 <code>make</code> 出的一个实例。</p>
<p>也许你现在有些疑问：到底是在哪进行 <code>bind</code> 操作的，又是 <code>bind</code> 到哪一个 Container 了，这个 Container 又是在什么地方 <code>make</code> 了他们？</p>
<p>这些问题现在你都不需要知道，看到后面你会有答案。现在你只需要知道</p>
<p><strong>IOC Container 组成了 Laravel 的架构，是 Laravel 的核心机制。</strong></p>
<p>在 Laravel 中，他们把这个叫做 Laravel 的 Service Container</p>
<p>Service Container 是今天的第一个角色，主角。</p>
<h3 id="该如何使用-Laravel-的-IOC-Container（-Service-Container-）？"><a href="#该如何使用-Laravel-的-IOC-Container（-Service-Container-）？" class="headerlink" title="该如何使用 Laravel 的 IOC Container（ Service Container ）？"></a>该如何使用 Laravel 的 IOC Container（ Service Container ）？</h3><p>如果想要使用 Laravel 的 IOC Container，也就是说想要用 IOC 的机制去 <code>make</code> 某种对象, 那么你就必须先 <code>bind</code> 这个对象的类到 Laravel 的 IOC Container 中, 才能把这种对象 <code>make</code> 出来。</p>
<p>至此，可以请出今天第二个角色了，Service Provider</p>
<p>为啥 Service Provider 突然蹦出来了呢，因为在 Laravel 中，我们大体可以上有2种方式去使用 IOC Container：</p>
<ol>
<li>通过 Service Provider 来使用IOC Container</li>
<li>不通过 Service Provider 直接使用 IOC Container</li>
</ol>
<p>大多数情况下，我们使用第一种方式。为什么呢，我们先从第二种开始说起。</p>
<h4 id="如何不通过-Service-Provider-直接使用-IOC-Container？"><a href="#如何不通过-Service-Provider-直接使用-IOC-Container？" class="headerlink" title="如何不通过 Service Provider 直接使用 IOC Container？"></a>如何不通过 Service Provider 直接使用 IOC Container？</h4><p>Laravel 有一个核心类，叫做 Application，这个继承了 Container，所以很显然，这个类是一个 IOC Container</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该类的命名空间</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 该类的声明</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Container</span> <span class="keyword">implements</span> <span class="title">ApplicationContract</span>, <span class="title">HttpKernelInterface</span></span></span><br></pre></td></tr></table></figure>
<p>在 Laravel 程序启动的时, 在 bootstrap/app.php 里面实例化了这个类，并把这个类的实例交给了 $app 。如果你了解 <a href="https://laravel-china.org/topics/3343" target="_blank" rel="noopener">Laravel 请求的生命周期</a>，那你就会对这里的程序流程更清楚一些，不过不了解也没有大碍。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 bootstrap/app.php 中实例化了该类</span></span><br><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>比如我们现在需要不通过 Service Provider 直接使用 IOC Container ，就是要使用上面的这个 IOC Container， 也就是 $app 。</p>
<p>很简单， 我们要做的第一件事就是 <code>bind</code>， 第二件事就是 <code>make</code></p>
<p>新建一个 Post 类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $d = <span class="string">"123"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后 <code>bind</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">App::bind(<span class="string">'post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> App::make(<span class="string">'App\Post'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>最后 <code>make</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$post = App::make(<span class="string">'post'</span>);</span><br><span class="line"><span class="keyword">return</span> $post-&gt;d; <span class="comment">//将会返回 "123"</span></span><br></pre></td></tr></table></figure>
<p>就像这样，完全不使用 service provider，我们也完成了对 Laravel IOC Container 的使用。</p>
<p>也许你会问，为什么我们直接用了 App 而不是 $app，这是因为 Laravel 使用了 Facades 的特性，来让你在程序的各处都能方便的得到 $app，或者说 Application 类的这个实例。</p>
<p>也许你又会问，Facades 又是个啥？回答你，现在先别管，等下就知道。不过提前告诉你，Facades 也是今天的角色之一。</p>
<h4 id="为何大多数情况都通过-Service-Provider-来使用-IOC-Container？"><a href="#为何大多数情况都通过-Service-Provider-来使用-IOC-Container？" class="headerlink" title="为何大多数情况都通过 Service Provider 来使用 IOC Container？"></a>为何大多数情况都通过 Service Provider 来使用 IOC Container？</h4><p>我们知道，有时候我们的类、模块会有需要其他类和组件的情况，为了保证初始化阶段不会出现所需要的模块和组件没有注册的情况，laravel 将注册和初始化行为进行拆分，注册的时候就只能注册，初始化的时候就是初始化。拆分后的产物就是现在的 服务提供者。</p>
<p>可以想象这样一个场景, 你要绑定3个类 A B C 到 IOC Container 中。 A，B，C 都是非常复杂的类。在 <code>bind</code> A 时, 引用了一个类 B 的实例, 那么想要获得类 B 的实例，就需要 B 已经被 <code>bind</code>，只有这样，我们的 IOC Container 才有能力 <code>make</code> 出一个 B 的实例。 而在 <code>bind</code> B 时, 恰好又需要 C 的实例.</p>
<p>如果是这样的逻辑, 那么在 <code>bind</code> A B C时, 就必须手动的严格安排 <code>bind</code> 的次序, 而且这只是3个类的情况, 如果有几十个类的话, 人工已经无法完成了.</p>
<p>而这时就需要 Service Provider 的作用了。</p>
<p>引用一段<a href="https://laravel-china.org/topics/789" target="_blank" rel="noopener">别人</a>的话</p>
<blockquote>
<p>我们知道，有时候我们的类、模块会有需要其他类和组件的情况，为了保证初始化阶段不会出现所需要的模块和组件没有注册的情况，laravel 将注册和初始化行为进行拆<br>分，注册的时候就只能注册，初始化的时候就是初始化。拆分后的产物就是现在的 Service Provider。</p>
</blockquote>
<h4 id="如何通过-Service-Provider-来使用-IOC-Container？"><a href="#如何通过-Service-Provider-来使用-IOC-Container？" class="headerlink" title="如何通过 Service Provider 来使用 IOC Container？"></a>如何通过 Service Provider 来使用 IOC Container？</h4><p>关于如何通过 Service Provider 来使用 IOC Container，我通过下面的例子来说明</p>
<h5 id="Laravel-的发明者是如何通过-Service-Provider-来使用-IOC-Container-为-Laravel-框架添加特性和功能的？"><a href="#Laravel-的发明者是如何通过-Service-Provider-来使用-IOC-Container-为-Laravel-框架添加特性和功能的？" class="headerlink" title="Laravel 的发明者是如何通过 Service Provider 来使用 IOC Container 为 Laravel 框架添加特性和功能的？"></a>Laravel 的发明者是如何通过 Service Provider 来使用 IOC Container 为 Laravel 框架添加特性和功能的？</h5><p>我们从这行代码说起，这里终于是标题中提到的那 <strong>1</strong> 行代码啦。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">'/'</span>, <span class="string">'HomeController@index'</span>);</span><br></pre></td></tr></table></figure>
<p>你是无法找到对 Route 类的声明的，为啥呢，因为使用了别名。别名是 PHP 的一个特性（ class_alias 方法 ）。</p>
<p>Route 是如何配置成为别名的呢， 在 <code>app/config/app.php</code> 中， 我们可以看到 Laravel 把所有的别名配置都放在了这个数组中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'aliases'</span> =&gt; [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'Route'</span> =&gt; Illuminate\Support\Facades\Route::class,</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>更细节的，关于 Laravel 是如何把这个数组里的别名都配置好的，本文就不再提及，在源代码中搜索 class_alias 就可以看到相关内容。</p>
<p>继续往下说，我们看到 Route 实际上是代表了 <code>Illuminate\Support\Facades\Route::class</code> 这个类， 我们找到这个类</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> \Illuminate\Routing\Router</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'router'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这个类之后，并没有找到之前 Route 调用的 <code>get</code> 方法，此时我们再看里面的这行注释，<code>@see \Illuminate\Routing\Router</code>，他提示我们去找这个位置，那我们就去找一下，我们又发现了一个 Router 类，而这个 Router 类中，是有 <code>get</code> 方法的，看起来这里似乎就是 Route 的真实身份了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register a new GET route with the router.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $uri</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure|array|string|null  $action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Routing\Route</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($uri, $action = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addRoute([<span class="string">'GET'</span>, <span class="string">'HEAD'</span>], $uri, $action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那 Laravel 是如何为 <code>Illuminate\Support\Facades\Route::class</code> 这个类找到他的真实身份的呢？</p>
<p>此时，正式请出我们今天的三号角色，Facades。</p>
<p><em>先纠正一下大家的读音，有的人可能会把这个词读做 fei kei de，其实这个词读作 [fə’sɑd]，拼音差不多是 fo sa de</em><br><em>词典中，facade 是一个名词。翻译为: 正面；表面；外观</em><br><em>读音: 英 [fə’sɑːd] ；美 [fə’sɑd]</em></p>
<p><strong>Facade 的作用是用一个简单易记的语法，让你从 Laravel 的 IOC Container 中方便的 make 出你想要的类的对象。</strong></p>
<p>之前我们看到 <code>class Route extends Facade</code>，说明 Route 也是一个 Facade，那这个 Route 的作用就是：</p>
<p>让我们通过这种简单的语法 Route::get(…)，去 Laravel 的 IOC Container 中方便的 <code>make</code> 出上面的 Route 的真实身份 <code>Router</code>。</p>
<h5 id="Facade-是如何使用的？"><a href="#Facade-是如何使用的？" class="headerlink" title="Facade 是如何使用的？"></a>Facade 是如何使用的？</h5><p>Facade 是如何做到上面所描述的事情的呢？ 下面进行讲解。</p>
<p>首先， <code>class Route extends Facade</code>， Route 继承自 Facade 类，Route 类又调用了静态的 <code>get</code> 方法，我们在 Route 类，或者是他的父类 Facade 中都是无法找到这个 <code>get</code> 方法的。 但是在 Facade 类中，我们可以发现有一个 <code>__callStatic()</code> <a href="http://blog.csdn.net/liutingxu1/article/details/17655049" target="_blank" rel="noopener">魔术方法</a>，这个方法的作用就是：如果你想要调用的静态方法在类的定义中并没有声明，那么就会执行 <code>__callStatic()</code>。在我们当前的情景中，静态方法 <code>get</code> 并没有被声明，那么当然，我们的类就会转而调用 <code>__callStatic()</code> 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $instance = <span class="keyword">static</span>::getFacadeRoot();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! $instance) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'A facade root has not been set.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (count($args)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method($args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method($args[<span class="number">0</span>], $args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method($args[<span class="number">0</span>], $args[<span class="number">1</span>], $args[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method($args[<span class="number">0</span>], $args[<span class="number">1</span>], $args[<span class="number">2</span>], $args[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array([$instance, $method], $args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们看 <code>__callStatic()</code> 的执行过程。首先看 <code>getFacadeRoot()</code> 是如何执行的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeRoot</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::resolveFacadeInstance(<span class="keyword">static</span>::getFacadeAccessor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在最初，定义 Route 类时，我们只实现了一个方法 <code>getFacadeAccessor()</code>，这时我们当初定义的字符串，就会在此处用到了，所以上面这个函数，实际上返回的内容就是 <code>static::resolveFacadeInstance(&quot;router&quot;);</code></p>
<p>我们继续看 <code>resolveFacadeInstance</code> 这个函数的执行过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFacadeInstance</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="comment">//判断是否为对象，当然不是了，$name 是字符串</span></span><br><span class="line">    <span class="keyword">if</span> (is_object($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断 resolvedInstance 这个数组中是否存了 $name 相关的信息，当然也没有，因为我们假设程序是第一次执行这里</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">static</span>::$resolvedInstance[$name])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 static::$app[$name]，同时把得到的结果保存到上面验证的数组中</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::$resolvedInstance[$name] = <span class="keyword">static</span>::$app[$name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们的程序执行了最后的一个 return， 返回了 static::$app[‘router’] 这个值。<br>还记得 $app 吗，他就是前面说过的 Laravel Application 类的实例化对象，这个类是一个 IOC Container，实例化过程发生在 Laravel 最开始的时候。</p>
<p>在 Facade 初始化的时候，也让自己有了一个 <code>static::$app</code> 这个就是 Application 类的实例化对象</p>
<p>而 $app 其实并没有 ‘router’ 这个属性，那为什么可以这样调用呢？ 是因为 Application 继承了 Container， 而 Container 又继承了 ArrayAccess 这个类。正是由于 ArrayAccess 的存在，以及 Container 实现了 ArrayAccess 的下面这个方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，当我们使用 $app[‘router’] 时，实际上是执行了 $app-&gt;make(‘router’)，到这里已经比较明显了，这里就是从 $app 这个 IOC Container 中，<code>make</code> 了一个 router 的实例。</p>
<p>已经绕的有点远了，不过还好，我们终于要回去了。到最初的 <code>__callStatic()</code> 中的</p>
<p>$instance = static::getFacadeRoot();</p>
<p>也就相当于</p>
<p>$instance = $app-&gt;make(‘router’)</p>
<p><code>__callStatic()</code> 继续往下执行，想一下我们最初的那条代码</p>
<p><code>Route::get(&#39;/&#39;, &#39;HomeController@index&#39;);</code>， 有2个参数，所以会执行到 case 2 这条语句，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> $instance-&gt;$method($args[<span class="number">0</span>], $args[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>到这里，我们的 $instance 就是我们的 IOC Container <code>make</code> 出的具有实际功能的实例，这个实例将会执行这个实例的类所声明过的 <code>get</code> 方法，并使用这两个参数：’/‘ 和 ‘HomeController@index’。</p>
<h5 id="如何将某个类通过-Service-Provider-的方式，-bind-到-Laravel-的-IOC-Container-中？"><a href="#如何将某个类通过-Service-Provider-的方式，-bind-到-Laravel-的-IOC-Container-中？" class="headerlink" title="如何将某个类通过 Service Provider 的方式， bind 到 Laravel 的 IOC Container 中？"></a>如何将某个类通过 Service Provider 的方式， <code>bind</code> 到 Laravel 的 IOC Container 中？</h5><p>上面通过 <code>Route::get(&#39;/&#39;, &#39;HomeController@index&#39;);</code> 这行代码背后的故事，让我们知道了 Facade 是用来帮我们从 IOC Container 中 <code>make</code> 实例的。</p>
<p>文章一开始就讲了，既然你要 <code>make</code>， 必定要先 <code>bind</code>。<br>上面还讲过，为什么通常情况下都是通过 Service Provider 来 <code>bind</code>。</p>
<p>那么我们现在就还是以 Route 为例子，来看看 Laravel 的开发者是如何通过 Service Provider 来 <code>bind</code> 类的。</p>
<p>在之前的 基础版 IOC Container 中, 我们看到 不论是 <code>bind</code> 还是 <code>make</code> 都有一个 key，用来查找和保存我们 <code>bind</code>过的类。<br>上文说过，代码实际执行了 $app-&gt;make(‘router’)，那显然，这个 key 此时就是 ‘router’。我们可以肯定，在之前进行 <code>bind</code> 操作的时候，也一定用到了这个个字符串 ‘router’。</p>
<p><a href="https://laravel-china.org/docs/laravel/5.3/providers" target="_blank" rel="noopener">官方文档</a>的 Service Provider 这一章中描述了 如何注册一个 Service Provider（这里就不做过多介绍），</p>
<p>以及所有的 Service Provider 都在 <code>config/app.php</code> 中被注册，</p>
<p>在 <code>config/app.php</code> 中，很容易就能找到跟我们的 Route 相关的， 也就是 <code>App\Providers\RoutingServiceProvider::class,</code></p>
<p>按照这个路径我们找到这个 Service Provider</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoutingServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register the service provider.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerRouter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerUrlGenerator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerRedirector();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPsrRequest();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPsrResponse();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerResponseFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register the router instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app[<span class="string">'router'</span>] = <span class="keyword">$this</span>-&gt;app-&gt;share(<span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Router($app[<span class="string">'events'</span>], $app);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>就像我们预计的那样，和官方文档中说的一样，在这个 Serivce Provider 的 <code>register()</code> 方法中，完成了 <code>bind</code> 的动作, 而 <code>make</code> 实例的方法也写在了里面， 也就是</p>
<p><code>new Router</code>， 这个 Router 类去提供实际的功能。</p>
<p>既然说到 Router 类了，那就不得不提一下我们的4号角色 Contract。</p>
<p>Router 类是为他人提供服务的功能类，比如说上文的 <code>get</code> 方法，这就是一个功能，看一下 Router 类的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Routing</span>\<span class="title">Registrar</span> <span class="title">as</span> <span class="title">RegistrarContract</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> <span class="keyword">implements</span> <span class="title">RegistrarContract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Macroable</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到 Router 类实现了 RegistrarContract 这个接口，这个接口的命名空间位于 Illuminate\Contracts 之下，而这种接口在 Laravel 中就被称为 Contract。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Routing</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Registrar</span></span></span><br></pre></td></tr></table></figure>
<p>那这种接口有啥好处呢， 跟普通的 interface 有什么不同？</p>
<p>答案可能让大家失望了，并没有什么不同。那为什么要叫俩名呢，我觉得你可以这样理解：</p>
<p>interface 这个词，在编程领域的有太广泛的应用了。但在 Laravel 框架中，特别是在框架的 Illuminate\Contracts 这个命名空间下的这些 Laravel 框架自带的接口们，我们把这些接口特指为 Contrast。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://laravel-china.org/topics/789" target="_blank" rel="noopener">Laravel 学习笔记 —— 神奇的服务容器</a></p>
<p><a href="http://stackoverflow.com/questions/33873675/differences-between-contracts-and-facades-laravel" target="_blank" rel="noopener">Stackoverflow 上的问答：Differences between contracts and facades laravel?</a></p>
<p><a href="http://ju.outofmemory.cn/entry/136407" target="_blank" rel="noopener">Laravel-Facade 实现原理</a></p>
<p><a href="https://segmentfault.com/a/1190000004946198" target="_blank" rel="noopener">想对 Contracts 了解更多可以看这里：Laravel 之 Contracts 和 Facades</a></p>
<p><a href="http://larabase.com/collection/1/post/49" target="_blank" rel="noopener">Laravel 5.1 文档攻略 ——Facades</a></p>
<p><a href="http://blog.11010.net/laravel-help-understand" target="_blank" rel="noopener">Laravel 核心要点的个人理解帮助</a></p>
<p><a href="https://vimeo.com/88888213" target="_blank" rel="noopener">vimeo 上的视频教程：Laravel Architecture - Part 1: The IoC Container</a></p>
<p><a href="https://laravel-china.org/docs/laravel/5.3" target="_blank" rel="noopener">Laravel 官方文档</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/17/代码结构设计/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/代码结构设计/" itemprop="url">代码结构设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-17T12:12:57+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="代码结构设计"><a href="#代码结构设计" class="headerlink" title="代码结构设计"></a>代码结构设计</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>这个类要写到哪儿？这是一个在用框架写应用程序时十分常见的问题</strong>。大量的开发人员都有这个疑问。他们被灌输“Model”就是“Database”，在控制器里面处理HTTP请求，在模型里操作数据库，视图里包含了要显示的HTML。不过，发送电子邮件的类要写到哪儿？数据验证的类要写到哪儿？调用外部API的类要写到哪儿？</p>
<h2 id="MVC是慢性谋杀"><a href="#MVC是慢性谋杀" class="headerlink" title="MVC是慢性谋杀"></a>MVC是慢性谋杀</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为了做出好的程序设计，最大的拦路虎就是一个简单的缩写词：M-V-C。模型、视图、控制器主宰了Web框架的思想已经好多年了。这种思想的流行某种程度上是托了Ruby on Rails愈加流行的福。然而，如果你问一个开发人员“模型”的定义是什么。通常你会听到他嘟哝着什么“数据库”之类的东西。这么说，模型<em>就是</em>数据库了。不管这意味着什么，模型里包含了关于数据库的<em>一切</em>。但是，你很快就会知道，你的应用程序需要的不仅仅是一个简单的数据库访问类。他需要更多的逻辑如：数据验证、调用外部服务、发送电子邮件，等等更多。</p>
<blockquote>
<p><strong>模型是啥？</strong></p>
<p>单词”model”的含义太模糊了，很难说明白准确的含义。更具体来讲，模型是用来将我们的应用划分成更小、更清晰的类，使得各代码部分有着明确的权责。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所以怎么解决这个问题（译者注：上文中“更多的业务逻辑”）呢？很多<strong>开发者开始将业务逻辑包装到控制器里面</strong>。当控制器庞大到一定规模，他们将会需要重用业务逻辑。大部分开发人员没有将这些业务逻辑提取到别的类里面，而是错误的臆想他们<em>需要</em>在控制器里面调用别的控制器。这种模式通常被称为“HMVC”。不幸的是，这种模式通常也预示着糟糕的程序设计，并且控制器已经太复杂了。</p>
<blockquote>
<p><strong>HMVC（通常）预示着糟糕的设计</strong></p>
<p>你觉得需要在控制器里面调用其他的控制器？这通常预示着糟糕的程序设计并且你的控制器里面业务逻辑太多了。把业务逻辑抽出来放到一个新的类里面，这样你就可以在其他任何控制器里面调用了。</p>
</blockquote>
<h2 id="再见，模型"><a href="#再见，模型" class="headerlink" title="再见，模型"></a>再见，模型</h2><blockquote>
<h3 id="注意使用场景"><a href="#注意使用场景" class="headerlink" title="注意使用场景"></a>注意使用场景</h3><p>记住，如果你在写一个很小的Laravel应用，那在<code>models</code>目录下写几个Eloquent模型其实挺合适的。</p>
</blockquote>
<p>拆分为一下几个目录：</p>
<ul>
<li>Models                       继承自 Eloquent 的模型类</li>
<li>Repositorys               对数据的访问功能</li>
<li>Services                      业务逻辑处理</li>
<li>util                               工具类 如：校验、发起访问</li>
<li>Events                          事件</li>
<li>Validations                  数据验证类</li>
<li>Providers                     服务提供者</li>
<li>Exceptions                  自定义异常</li>
<li>Listeners                     监听器</li>
</ul>
<h2 id="Validation-数据验证怎么办？"><a href="#Validation-数据验证怎么办？" class="headerlink" title="Validation 数据验证怎么办？"></a>Validation 数据验证怎么办？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在哪儿进行数据验证常常困扰着开发人员。可以考虑将数据验证方法写进你的“实体”类里面（好比<code>User.php</code>和<code>Payment.php</code>）。方法名可以设为<code>validForCreation</code>或<code>hasValidDomain</code>。或者你也可以专门创建个验证器类<code>UserValidator</code>，放到<code>Validation</code>命名空间下，然后将这个验证器类注入到你的repository类里面。两种方式你都可以试试，看哪个你更喜欢！</p>
<h2 id="分层思想"><a href="#分层思想" class="headerlink" title="分层思想"></a>分层思想</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;优化应用的设计结构的关键就是<strong>责任划分</strong>，或者说是创建不同的责任层次。控制器只负责接收和响应HTTP请求然后调用合适的业务逻辑层的类。你的业务逻辑/领域逻辑层<em>才是</em>你真正的程序。你的程序包含了读取数据，验证数据，执行支付，发送电子邮件，还有你程序里任何其他的功能。事实上你的领域逻辑层不需要知道任何关于“网络”的事情！网络仅仅是个访问你程序的传输机制，关于网络和HTTP请求的一切不应该超出路由和控制器层。做出好的设计的确很有挑战性，但好的设计也会带来可持续发展的清晰的好代码。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子。与其在你业务逻辑类里面直接获取网络请求，不如你直接把网络请求从控制器传给你的业务逻辑类。这个简单的改动将你的业务逻辑类和“网络”分离开了，并且不必担心怎么去模拟网络请求，你的业务逻辑类就可以简单的测试了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- lang:php --&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;biller = $biller;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postCharge</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;biller-&gt;chargeAccount(Auth::user(), Input::get(<span class="string">'amount'</span>));</span><br><span class="line">        <span class="keyword">return</span> View::make(<span class="string">'charge.success'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在<code>chargeAccount</code> 方法更容易测试了。 我们把<code>Request</code>和<code>Input</code>从<code>BillingInterface</code>里提出来，然后在控制器里把方法需要的支付金额直接传过去。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;编写拥有高可维护性应用程序的关键之一，就是责任分割。要时常检查一个类是否管得太宽。你要常常问自己“<strong>这个类需不需要关心XXX呢</strong>？”如果答案是否定的，那么<strong>把这块逻辑抽出来放到另一个类里面，然后用依赖注入的方式进行处理</strong>。（依赖注入的不同方式：调用方法传参、构造函数传参、从IoC容器获取等等。）</p>
<blockquote>
<p>如何判断一个类是否管得太宽，有一个有用的方法就是检查你为什么要改这块儿代码。举个例子：当我们想调整通知逻辑的时候，我们需要修改<code>Biller</code>的实现代码么？当然不需要，<code>Biller</code>的实现仅仅需要考虑支付，它与通知逻辑应当仅通过约定来进行交互。使用这种思路过一遍代码，会让你很快找出应用中需要改进的地方。</p>
</blockquote>
<h2 id="目录拆分"><a href="#目录拆分" class="headerlink" title="目录拆分"></a>目录拆分</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;摆脱了<code>models</code>目录后，你通常就能克服心理障碍，实现好的设计。使得你能创建一个更合适的目录结构来为你的应用服务。当然，你建立的每一个应用程序都会有一定的相似之处，因为每个复杂的应用程序都需要一个数据访问（repository）层，一些外部服务层等等。</p>
<blockquote>
<p><strong>别害怕目录</strong></p>
<p>不要惧怕建立目录来管理应用。要常常将你的应用切割成小组件，每一个组件都要有十分专注的职责。跳出“模型”的框框来思考。比如我们之前就说过，你可以创建个<code>Repositories</code>目录来存放你所有的数据访问类。</p>
</blockquote>
<h2 id="辅助函数"><a href="#辅助函数" class="headerlink" title="辅助函数"></a>辅助函数</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Laravel 有一个文件<code>helpers.php</code>里面都是辅助函数。你或许希望创建一个类似的文件来存储你自己的辅助函数。“start”文件是个不错的入口，该文件会在应用的每一次请求时被访问。在<code>index.php</code>里，你可以引入你自己写的<code>helpers.php</code>文件，就像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- lang:php --&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../helpers.php'</span>;</span><br></pre></td></tr></table></figure>
<p>方案二：</p>
<p><strong>自定义为一个PHP文件，然后通过composer.json配置实现自动加载 </strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">"autoload": &#123;</span><br><span class="line">        "classmap": [</span><br><span class="line">            <span class="string">"database"</span></span><br><span class="line">        ],</span><br><span class="line">        "psr-4": &#123;</span><br><span class="line">            "App\\": "app/"</span><br><span class="line">        &#125;,</span><br><span class="line">        "files":&#123;</span><br><span class="line">            xxx</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>composer dumpautoload</strong>，重新注册自动加载映射关系</p>
<p>我们可以在 <code>app</code> 目录下创建一个 <code>helpers.php</code> 文件，然后将自定义的辅助函数都放到这个文件中。当然，由于这个文件里面包含的不是类，不适合通过命名空间引用其中的函数，需要在 <code>composer.json</code> 中全局注册它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;autoload&quot;: &#123;</span><br><span class="line">    ...</span><br><span class="line">    &quot;files&quot;: [</span><br><span class="line">        &quot;app/helpers.php&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>然后运行 <code>composer dump-auto</code> 重新注册自动加载映射关系。然后就可以在应用中使用 <code>app/helpers.php</code> 中定义的辅助函数了。</p>
<h2 id="Event-Listeners-事件监听器"><a href="#Event-Listeners-事件监听器" class="headerlink" title="Event Listeners 事件监听器"></a>Event Listeners 事件监听器</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>事件监听器当然不该放到 <code>routes.php</code> 文件里面，所以我们要找另外的地方来存放。事实上，在 Laravel 5.* 中，当我们通过 <code>php artisan make:listener</code> 命令创建时间监听器时，系统会自动在 <code>app</code> 目录下创建 <code>Listeners</code> 子目录，并将生成的监听器类放到该目录下。所以我们对于自定义的事件监听器类，放到该目录下即可</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务提供者可不仅仅是用来做依赖注入绑定，还可以干其他事儿。可以将事件监听器用服务提供者来管理起来，让代码更整洁，不至于影响到你应用的主要逻辑代码。视图组件其实和事件差不多，也可以类似的放到服务提供者里面。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例如使用服务提供者进行事件注册可以这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- lang:php --&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">QuickBill</span>\<span class="title">Providers</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BillingEventsProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Event::listen(<span class="string">'billing.failed'</span>, <span class="function"><span class="keyword">function</span><span class="params">($bill)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">// Handle failed billing event...</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;创建好服务提供者后，就可以将它加入到<code>config/app.php</code> 配置文件的<code>providers</code>数组里。</p>
<blockquote>
<p><strong>注意启动流程</strong></p>
<p><code>register</code>方法<strong>只能</strong>用来进行依赖注入绑定</p>
</blockquote>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果你的应用里面有很多自定义的错误处理方法，那你的“启动”文件可能会很臃肿。和刚才的事件监听器一样，错误处理方法也最好放到服务提供者里面。这种服务提供者可以命名为像<code>ErrorProvider</code>这种。然后你在<code>boot</code>方法里想注册多少错误处理方法都可以了。重申一下精神：让呆板的代码离你应用的业务逻辑越远越好。下方展示了这种服务提供者的一种可能的书写方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- lang:php --&gt;</span><br><span class="line">Illuminate\Support\ServiceProvider;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;    </span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        App::error(<span class="function"><span class="keyword">function</span><span class="params">(FailedException $e)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// Handle failed billing exceptions ...</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在 Laravel 5.* 版本中，默认情况下所有的异常都是通过 <code>App\Exceptions\Handler</code> 来处理的，你也可以通过自定义的异常类来处理，自定义异常类可以放到 <code>app/Exceptions</code> 目录下。</strong></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>遵循 PSR-0（译者注：或 PSR-4）就可以保持类的整洁</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/17/选择合适的数据类型/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/选择合适的数据类型/" itemprop="url">选择合适的数据类型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-17T12:12:57+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/数据库设计/" itemprop="url" rel="index">
                    <span itemprop="name">数据库设计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="选择合适的数据类型"><a href="#选择合适的数据类型" class="headerlink" title="选择合适的数据类型"></a>选择合适的数据类型</h1><p><strong>前提: 使用适合存储引擎。</strong></p>
<h2 id="选择原则"><a href="#选择原则" class="headerlink" title="选择原则"></a>选择原则</h2><ol>
<li><strong>根据选定的存储引擎,确定如何选择合适的数据类型</strong></li>
<li><strong>更小的通常更好</strong>：一般情况下选择可以正确存储数据的最小数据类型。越小的数据类型通常更快，占用磁盘，内存和CPU缓存更小。</li>
<li><strong>简单就好</strong>：简单的数据类型的操作通常需要更少的CPU周期。例如：整型比字符操作代价要小得多，因为字符集和校对规则(排序规则)使字符比整型比较更加复杂。</li>
<li><strong>尽量避免NULL</strong>:尽量制定列为NOT NULL，除非真的需要NULL类型的值。因为可能为NULL列使得索引，索引统计和值比较都更复杂。可为NULL的列会使用更多的存储空间，在MySQL里也需要特殊处理。</li>
<li><strong>在选择列的数据类型时需要先选定合适的大类型</strong>,如：数字，字符串，时间等。</li>
</ol>
<h2 id="选择方法按存储引擎分类"><a href="#选择方法按存储引擎分类" class="headerlink" title="选择方法按存储引擎分类"></a>选择方法按存储引擎分类</h2><ol>
<li>MyISAM 数据存储引擎和数据列</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyISAM数据表，最好使用固定长度的数据列代替可变长度的数据列。</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>InnoDB 存储引擎和数据列</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 建议使用 VARCHAR类型</span><br><span class="line"> </span><br><span class="line">对于InnoDB数据表，内部的行存储格式没有区分固定长度和可变长度列（所有数据行</span><br><span class="line">都使用指向数据列值的头指针），因此在本质上，使用固定长度的 CHAR列不一定比使</span><br><span class="line">用可变长度VARCHAR列简单。因而，主要的性能因素是数据行使用的存储总量。由于CHAR</span><br><span class="line">平均占用的空间多于VARCHAR，因 此使用VARCHAR来最小化需要处理的数据行的存储总</span><br><span class="line">量和磁盘I/O是比较好的。</span><br></pre></td></tr></table></figure>
<h2 id="数据类型差异"><a href="#数据类型差异" class="headerlink" title="数据类型差异"></a>数据类型差异</h2><h3 id="1-固定长度数据列与可变长度的数据列"><a href="#1-固定长度数据列与可变长度的数据列" class="headerlink" title="1. 固定长度数据列与可变长度的数据列"></a>1. 固定长度数据列与可变长度的数据列</h3><p><strong>CHAR 和 VARCHAR 类型类似，但它们保存和检索的方式不同。它们的最大长度和是否尾<br>部空格被保留等方面也不同。在存储或检索过程中不进行大小写转换。</strong></p>
<p><strong>CHAR(4)和 VARCHAR(4)列检索的值并不总是相同，因为检索时从 CHAR 列删除了尾部的空<br>格</strong></p>
<p><strong>VARCHAR类型在数据长度不够的时候，会被截断，仅仅保存前面一部分</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE vc (v VARCHAR(4), c CHAR(4));</span><br><span class="line"></span><br><span class="line">INSERT INTO vc VALUES (&apos;ab &apos;, &apos;ab &apos;);</span><br><span class="line"></span><br><span class="line">SELECT CONCAT(v, &apos;+&apos;), CONCAT(c, &apos;+&apos;) FROM vc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+---------------+---------------+</span><br><span class="line">| CONCAT(v, &apos;+&apos;) | CONCAT(c, &apos;+&apos;) |</span><br><span class="line">+---------------+---------------+</span><br><span class="line">| ab +          | ab+           |</span><br><span class="line">+---------------+---------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CHAR:CHAR是定长字符串类型，MySQL总是根据定义的类型进行分配足够的空间。当存储CHAR时MySQL会默认删除行尾空格。因为CHAR值通常需要用空格进行填充以方便比较。</span><br><span class="line"></span><br><span class="line">CHAR适合存储很短的字符串，或者所有长度都接近一个长度。</span><br><span class="line"></span><br><span class="line">对于经常变更的数据CHAR比较VARCHAR要好，因为定长的CHAR类型不容易产生碎片。</span><br><span class="line"></span><br><span class="line">对于更短的列CHAR比VARCHAR要更加节省空间，因为VARCHAR总是需要一个额外的字节来存储长度。</span><br><span class="line"></span><br><span class="line">VARCHAR:适用于存储变长的字符串，是最常见的字符串数据类型。它比定常更加节省空间，因为它仅需要使用必要的额外空间（如果MySQL表使用ROW_FORMAT=FIXED创建的话，会使用定长）。</span><br><span class="line"></span><br><span class="line">适合使用该类型的情况：字符串列的最大长度比平均长度大很多；列的更新很少，所以碎片不是问题；使用了UTF-8这样复杂的字符集，每个字符的使用不同字节数进行存储。</span><br></pre></td></tr></table></figure>
<h3 id="2-text-和-blob"><a href="#2-text-和-blob" class="headerlink" title="2. text 和 blob"></a>2. text 和 blob</h3><ol>
<li><strong>BLOB和TEXT值也会引起自己的一些问题，特别是执行了大量的删除或更新操作的时候。</strong><br>删除这种值会在数据表中留下很大的<strong>“空洞”</strong>，以后填入这些”空洞”的记录可能长度不<br>同,为了提高性能,建议<strong>定期使用 OPTIMIZE TABLE 功能对这类表进行碎片整理</strong>.</li>
<li><strong>使用合成的（synthetic）索引。合成的索引列在某些时候是有用的。一种办法是根据<br>其它的列的内容建立一个散列值，并把这个值存储在单独的数据列中。接下来你就可以<br>  通过检索散列值找到数据行了。但是，我们要注意这种技术只能用于精确匹配的查询(散<br>  列值对于类似&lt;或&gt;=等范围搜索操作符 是没有用处的)</strong>。我们可以使用MD5()函数生成散<br>  列值，也可以使用SHA1()或CRC32()，或者使用自己的应用程序逻辑来计算散列值。请<br>  记住数值型散列值可以很高效率地存储。同样，如果散列算法生成的字符串带有尾部空<br>  格，就不要把它们存储在CHAR或VARCHAR列中，它们会受到尾部空格去除的影响。</li>
<li><strong>在不必要的时候避免检索大型的 BLOB 或 TEXT 值</strong>。例如，SELECT * 查询就不是很好的想<br>法，除非你能够确定作为约束条件的WHERE子句只会找到所需要的数据行。否则，你可能<strong>毫无目的地在网络上传输大量的值</strong>这也是 BLOB或TEXT标识符信息存储在合成的索<br>引列中对我们有所帮助的例子。你可以搜索索引列，决定那些需要的数据行，然后从合<br>格的数据行中检索BLOB或 TEXT值。</li>
<li><strong>把BLOB 或 TEXT 列分离到单独的表中</strong>, 在某些环境中，如果把这些数据列移动到第二张数<br>据表中，可以让你把原数据表中 的数据列转换为固定长度的数据行格式，那么它就是<br>  有意义的。<strong>这会减少主表中的碎片，使你得到固定长度数据行的性能优势。它还使你在<br>  主数据表上运行 SELECT *查询的时候不会通过网络传输大量的BLOB或TEXT值。</strong></li>
<li><strong>建立索引时取前缀部分</strong>,  避免索引占用过多的存储空间，<strong>使用 count(distinct left( 列名, 索引长度 )) / count( * ) 的区分度 来确定。</strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```mysql</span><br><span class="line">BLOB和TEXT的仅有的区别在于BLOB类型存储的时二进制数据，没有排序规则或字符集，而TEXT类型有字符集和排序规则。</span><br><span class="line"></span><br><span class="line">MySQL对BLOB和TEXT列进行排序时与其他类型时不同的，它只对每个列的最前max_sort_length字节而不是整个字符串做排序。</span><br><span class="line"></span><br><span class="line">MySQL不能将BLOB和TEXT列全部长度进行字符串进行索引，也不能使用这些索引消除排序。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">### 3. 浮点数与定点数</span><br><span class="line"></span><br><span class="line">​```mysql</span><br><span class="line">CREATE TABLE test (c1 float(10,2),c2 decimal(10,2));</span><br><span class="line"></span><br><span class="line">insert into test values(131072.32,131072.32);</span><br><span class="line"></span><br><span class="line">select * from test;</span><br><span class="line"></span><br><span class="line"># c1 列的值由 131072.32 变成了 131072.31，这就是浮点数的不精确性造成的。</span><br></pre></td></tr></table></figure>
<p>在 mysql 中 float、double（或 real）是浮点数，decimal（或 numberic）是定点数。<br><strong>浮点数相对于定点数的优点是在长度一定的情况下，浮点数能够表示更大的数据范围；<br>它的缺点是会引起精度问题。</strong></p>
<p>浮点数能够表示更大的数据范围的原因:</p>
<p><strong>定点数有一定的小数位, decimal(12, 2)表示整数最多10位, 小数点固定2位</strong></p>
<p>记住以下几点：</p>
<p><strong>1、浮点数存在误差问题；</strong></p>
<p><strong>2、对货币等对精度敏感的数据，应该用定点数表示或存储；</strong></p>
<p><strong>3、编程中，如果用到浮点数，要特别注意误差问题，并尽量避免做浮点数比较；</strong></p>
<p><strong>4、要注意浮点数中一些特殊值的处理。</strong></p>
<h3 id="4-DATETIME和TIMESTAMP"><a href="#4-DATETIME和TIMESTAMP" class="headerlink" title="4. DATETIME和TIMESTAMP"></a>4. DATETIME和TIMESTAMP</h3><p><strong>DATETIME</strong></p>
<p>能保存1001到9999年，精度为秒。格式为YYYY-MM-DD HH:MM:SS与时区无关，使用八个字节的存储空间。</p>
<p><strong>TIMESTAMP</strong></p>
<p>时间戳，正如名字一样。它能保存从1970年1月1号午夜（格林尼治标准时间）。它只使用四个字节的存储空间只能表示1970到2038年。</p>
<p>TIMESTAMP显示的值依赖于时区。MYSQL服务器，操作系统，以及客户端连接都有时区设置。因此存储值为0时在不同的时区显示值会有差别。</p>
<p>注：通常情况下应尽量使用TIMESTAMP，因为它比DATETIME效率更高。如果需要存储更小粒度的时间，可以用BIGINGT或者转换成DOUBLE类型来进行存储。</p>
<h3 id="5-枚举"><a href="#5-枚举" class="headerlink" title="5.枚举"></a>5.枚举</h3><ol>
<li><p>枚举数据类型在内存中非常紧凑，会根据列表值的数量压缩到一个或两个字节。MySQL自身会维护一个查找表</p>
</li>
<li><p>枚举时按照内部的数字而不是定义的字符串进行排序的</p>
</li>
<li><p>在很多情况下我们可以使用ENUM类型来替代字符串类型。但是如果不宜使用数字类型作为枚举常量，这种双重性容易导致混乱。<strong>枚举最不好的地方就是，字符串列表是固定的，添加或删除字符串必须使用ALTER TABLE</strong></p>
<p>说明: laravel5.3好像对枚举处理有bug</p>
</li>
</ol>
<h2 id="5-数据类型优化"><a href="#5-数据类型优化" class="headerlink" title="5. 数据类型优化"></a>5. 数据类型优化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(1)  使用long来存储ip</span><br><span class="line"></span><br><span class="line">	   &amp;nbsp; &amp;nbsp;&amp;nbsp;ip2long($ip) 将ip转为int</span><br><span class="line"></span><br><span class="line">    (2)  使用tinyint(1)来存储状态值</span><br><span class="line"></span><br><span class="line">(3)  在确定应用不会存储负数时，使用unsigned限制非负数，扩大存储量</span><br><span class="line"></span><br><span class="line">(4)  使用timestamp来存储日期，节约存储空间</span><br><span class="line"></span><br><span class="line">(5)  小数类型为 decimal ，禁止使用 float 和 double 。存储金额的字段统一使用 DECIMAL(12,4)</span><br><span class="line"></span><br><span class="line">(6)  如果存储的字符串长度几乎相等，使用 char 定长字符串类型。因为在大致相等时，char更节约存储空间</span><br><span class="line"></span><br><span class="line">(6)  表必备三字段： id , gmt _ create , gmt _ modified</span><br><span class="line"></span><br><span class="line">(7) 使用id 做为表的主键, 主键必须声明 auto_increment，使用INT数据类型作为主键和外键，它们也必须是UNSIGNED（我们可以获得两倍的空间）。</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/05/17/构建复杂的Eloquent搜索过滤/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/17/构建复杂的Eloquent搜索过滤/" itemprop="url">构建复杂的Eloquent搜索过滤</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-17T12:12:57+08:00">
                2019-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="构建复杂的Eloquent搜索过滤"><a href="#构建复杂的Eloquent搜索过滤" class="headerlink" title="构建复杂的Eloquent搜索过滤"></a>构建复杂的Eloquent搜索过滤</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://learnku.com/laravel/t/25818" target="_blank" rel="noopener">https://learnku.com/laravel/t/25818</a></p>
</blockquote>
<p><br></p>
<p>最近，我需要在开发的事件管理系统中实现搜索功能。 一开始只是简单的几个选项 （通过名称，邮箱等搜索），到后面参数变得越来越多。</p>
<p>今天，我会介绍整个过程以及如何构建灵活且可扩展的搜索系统。如果你想查看代码，请访问 <a href="https://github.com/drawmyattention/advanced-eloquent-search-filters/tree/master/app/UserSearch" target="_blank" rel="noopener">Git 仓库</a> 。</p>
<h4 id="我们将创造什么"><a href="#我们将创造什么" class="headerlink" title="我们将创造什么"></a>我们将创造什么</h4><p>我们公司需要一种跟踪我们与世界各地客户举办的各种活动和会议的方式。我们目前的唯一方法是让每位员工在 Outlook 日程表上存储会议的详细信息。可拓展性较差！</p>
<p>我们需要公司的每个人都可以访问，来查看我们客户的被邀请的详细信息以及他们的 RSVP（国际缩用语：请回复）状态。</p>
<p>这样，我们可以通过上次与他们互动的数据来确定哪些用户可以邀请来参加未来的活动。</p>
<p><img src="//blog.com/2019/05/17/构建复杂的Eloquent搜索过滤/y0cjgSpo11.png" alt=""></p>
<h4 id="查找用户"><a href="#查找用户" class="headerlink" title="查找用户"></a>查找用户</h4><p>常用过滤用户的方法：</p>
<ul>
<li>通过姓名，电子邮件，位置</li>
<li>通过用户工作的公司</li>
<li>被邀请参加特定活动的用户</li>
<li>参加过特定活动的用户</li>
<li>邀请及已参加活动的用户</li>
<li>邀请但尚未回复的用户</li>
<li>答应参加但未出席的用户</li>
<li>分配给销售经理的用户</li>
</ul>
<p>虽然这个列表不算完整，但可以让我们知道需要多少个过滤器。这将是个挑战！</p>
<p><img src="//blog.com/2019/05/17/构建复杂的Eloquent搜索过滤/syxZjWexkD.png" alt=""></p>
<h4 id="模型及模型关联"><a href="#模型及模型关联" class="headerlink" title="模型及模型关联"></a>模型及模型关联</h4><p>在这个例子中我们回用到很多模型:</p>
<ul>
<li>User —  代表被邀请参加活动的用户。一个用户可以参加很多活动。</li>
<li>Event — 代表我公司举办的活动。活动可以有多个。</li>
<li>Rsvp —  代表用户对活动邀请的回复。一个用户对一个活动的回复是一对一的。</li>
<li>Manager —  一个用户可以对应多个我公司的销售经理.</li>
</ul>
<h4 id="搜索的需求"><a href="#搜索的需求" class="headerlink" title="搜索的需求"></a>搜索的需求</h4><p>在开始代码之前，我想先把搜索的需求明确一下。也就是说我要很清楚地知道我要对哪些数据做搜索功能。</p>
<p>下面就是一个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Billy"</span>,</span><br><span class="line">    <span class="string">"company"</span>: <span class="string">"Google"</span>,</span><br><span class="line">    <span class="string">"city"</span>: <span class="string">"London"</span>,</span><br><span class="line">    <span class="string">"event"</span>: <span class="string">"key-note-presentation-new-york-05-2016"</span>,</span><br><span class="line">    <span class="string">"responded"</span>: <span class="keyword">true</span>,</span><br><span class="line">    <span class="string">"response"</span>: <span class="string">"I will be attending"</span>,</span><br><span class="line">    <span class="string">"managers"</span>: [</span><br><span class="line">        <span class="string">"Tom Jones"</span>,</span><br><span class="line">        <span class="string">"Joe Bloggs"</span></span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下上面数据想表达的搜索的条件:</p>
<blockquote>
<p>客人的名字是 ‘Billy’，来自 ‘Google’ 公司，目前居住在 ‘London’，已经对 ‘key-note-presentation-new-york-05–2016’ 的活动邀请做出了回复，并且回复的内容是 ‘I will be attending’，负责跟进这位客人的销售经理是 ‘Tom Jones’ 或者 ‘Joe Bloggs’。</p>
</blockquote>
<h4 id="开始-—-最佳实践"><a href="#开始-—-最佳实践" class="headerlink" title="开始 — 最佳实践"></a>开始 — 最佳实践</h4><p>我是一个坚定不移的极简主义者，我坚信少即是多。下面就让我们以最简单的方式探索出解决这个需求的最佳实践。</p>
<p>首先，在  <code>routes.php</code> 文件中添加如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Route::post(<span class="string">'/search'</span>, <span class="string">'SearchController@filter'</span>);</span><br></pre></td></tr></table></figure>
<p>接下来，创建  <code>SearchController</code>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:controller SearchController</span><br></pre></td></tr></table></figure>
<p>添加前面路由中明确的 <code>filter()</code> 方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">(Request $request, User $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们需要在 filter 方法中处理请求提交的数据，所以我把 Request 类做了依赖注入。<a href="https://learnku.com/docs/laravel/5.2/container#resolving" target="_blank" rel="noopener">Laravel 的服务容器</a> 会解析这个依赖，我们可以在方法中直接使用 Request 的实例，也就是 $request。User 类也是同样道理，我们需要从中检索一些数据。</p>
<p>这个搜索需求有一点比较麻烦的是，每个参数都是可选的。所以我们要先写一系列的条件语句来判断每个参数是否存在：</p>
<p>这是我初步写出来的代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">(Request $request, User $user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 根据姓名查找用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $user-&gt;where(<span class="string">'name'</span>, $request-&gt;input(<span class="string">'name'</span>))-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据公司名查找用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'company'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $user-&gt;where(<span class="string">'company'</span>, $request-&gt;input(<span class="string">'company'</span>))</span><br><span class="line">            -&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据城市查找用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $user-&gt;where(<span class="string">'city'</span>, $request-&gt;input(<span class="string">'city'</span>))-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续根据其他条件查找</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再无其他条件，</span></span><br><span class="line">    <span class="comment">// 返回所有符合条件的用户。</span></span><br><span class="line">    <span class="comment">// 在实际项目中需要做分页处理。</span></span><br><span class="line">    <span class="keyword">return</span> User::all();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，上面的代码逻辑是错误的。</p>
<p>首先，它只会根据一个条件去检索用户表，然后就返回了。所以，通过上面的代码逻辑，我们根本无法获得姓名为 ‘Billy’， 而且住在 ‘London’ 的用户。</p>
<p>实现这种目的的一种方式是嵌套条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据用户名搜索用户</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">    <span class="comment">// 是否还提供了 'city' 搜索参数</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">        <span class="comment">// 基于用户名及城市搜索用户</span></span><br><span class="line">        <span class="keyword">return</span> $user-&gt;where(<span class="string">'name'</span>, $request-&gt;input(<span class="string">'name'</span>))</span><br><span class="line">            -&gt;where(<span class="string">'city'</span>, $request-&gt;input(<span class="string">'city'</span>))</span><br><span class="line">            -&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $user-&gt;where(<span class="string">'name'</span>, $request-&gt;input(<span class="string">'name'</span>))-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我确信你可以看到这在两个或者三个参数的时候起作用，但是一旦我们添加更多选项，这将会难以管理。</p>
<h4 id="改进我们的搜索-api"><a href="#改进我们的搜索-api" class="headerlink" title="改进我们的搜索 api"></a>改进我们的搜索 api</h4><p>所以我们如何让这个生效，而同时不会因为嵌套条件而变得疯狂？</p>
<p>我们可以使用 User 模型继续重构，来使用 <a href="https://laravel.com/api/5.2/Illuminate/Database/Eloquent/Builder.html" target="_blank" rel="noopener">builder</a> 而不是直接返回模型。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">(Request $request, User $user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = $user-&gt;newQuery();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据用户名搜索用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">        $user-&gt;where(<span class="string">'name'</span>, $request-&gt;input(<span class="string">'name'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据用户公司信息搜索用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'company'</span>)) &#123;</span><br><span class="line">        $user-&gt;where(<span class="string">'company'</span>, $request-&gt;input(<span class="string">'company'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据用户城市信息搜索用户</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">        $user-&gt;where(<span class="string">'city'</span>, $request-&gt;input(<span class="string">'city'</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续执行其他过滤</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得并返回结果</span></span><br><span class="line">    <span class="keyword">return</span> $user-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好多了！我们现在可以将每个搜索参数做为修饰符添加到从  <em>$user-&gt;newQuery()</em> 返回的查询实例中。</p>
<p>我们现在可以根据所有的参数来做搜索了，再多参数都不怕.</p>
<p>一起来实践吧:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$user = $user-&gt;newQuery();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据姓名查找用户</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">    $user-&gt;where(<span class="string">'name'</span>, $request-&gt;input(<span class="string">'name'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据公司名查找用户</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'company'</span>)) &#123;</span><br><span class="line">    $user-&gt;where(<span class="string">'company'</span>, $request-&gt;input(<span class="string">'company'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据城市查找用户</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">    $user-&gt;where(<span class="string">'city'</span>, $request-&gt;input(<span class="string">'city'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只查找有对接我公司销售经理的用户</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'managers'</span>)) &#123;</span><br><span class="line">    $user-&gt;whereHas(<span class="string">'managers'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        $query-&gt;whereIn(<span class="string">'managers.name'</span>, $request-&gt;input(<span class="string">'managers'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有 'event' 参数</span></span><br><span class="line"><span class="keyword">if</span> ($request-&gt;has(<span class="string">'event'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只查找被邀请的用户</span></span><br><span class="line">    $user-&gt;whereHas(<span class="string">'rsvp.event'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        $query-&gt;where(<span class="string">'event.slug'</span>, $request-&gt;input(<span class="string">'event'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只查找回复邀请的用户( 以任何形式回复都可以 )</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'responded'</span>)) &#123;</span><br><span class="line">        $user-&gt;whereHas(<span class="string">'rsvp'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            $query-&gt;whereNotNull(<span class="string">'responded_at'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只查找回复邀请的用户( 限制回复的具体内容 )</span></span><br><span class="line">    <span class="keyword">if</span> ($request-&gt;has(<span class="string">'response'</span>)) &#123;</span><br><span class="line">        $user-&gt;whereHas(<span class="string">'rsvp'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            $query-&gt;where(<span class="string">'response'</span>, <span class="string">'I will be attending'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终获取对象并返回</span></span><br><span class="line"><span class="keyword">return</span> $user-&gt;get();</span><br></pre></td></tr></table></figure>
<p>搞定，棒极了！</p>
<h4 id="是否还需要重构？"><a href="#是否还需要重构？" class="headerlink" title="是否还需要重构？"></a>是否还需要重构？</h4><p>通过上面的代码我们实现了业务需求，可以根据搜索条件返回正确的用户信息。但是我们能说这是最佳实践吗？显然是不能。</p>
<p>现在是通过一系列条件判断的嵌套来实现业务逻辑，而且所有的逻辑都在控制器里，这样做真的合适吗？</p>
<p>这可能是一个见仁见智的问题，最好还是结合自己的项目，具体问题具体分析。如果你的项目比较小，逻辑相对简单，而且只是一个短期需求的项目，那么就不必纠结这个问题了，直接照上面的逻辑写就好了。　</p>
<p>然而，如果你是在构建一个比较复杂的项目，那么我们还是需要更加优雅且扩展性好的解决方案。</p>
<h4 id="编写新的搜索-api"><a href="#编写新的搜索-api" class="headerlink" title="编写新的搜索 api"></a>编写新的搜索 api</h4><p>当我要写一个功能接口的时候，我不会立刻去写核心代码，我通常会先想想我要怎么用这个接口。这可能就是俗称的「面向结果编程」（或者说是「结果导向思维」）。</p>
<blockquote>
<p>「在你写一个组件之前，建议你先写一些要用这个组件的测试代码。通过这种方式，你会更加清晰地知道你究竟要写哪些函数，以及传哪些必要的参数，这样你才能写出真正好用的接口。</p>
<p>因为写接口的目的是简化使用组件的代码，而不是简化接口自身的代码。」 ( 摘自： <a href="http://c2.com/cgi/wiki?WishfulThinking" target="_blank" rel="noopener">c2.com</a>）</p>
</blockquote>
<p>根据我的经验，这个方法能帮助我写出可读性更强，更加优雅的程序。还有一个很大的额外收获就是，通过这种阶段性的验收测试，我能更好地抓住商业需求。因此，我可以很自信地说我写的程序可以很好地满足市场的需求，具有很高商业价值。</p>
<p>以下添加到搜索功能的代码中，我希望我的搜索 api 是这样写的:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> UserSearch::apply($filters);</span><br></pre></td></tr></table></figure>
<p>这样有着很好的可读性。 根据经验，如果我查阅代码能想看文章的句子一样，那会非常美妙。像刚刚的情况下：</p>
<blockquote>
<p>搜索用户时加上一个过滤器再返回搜索结果。</p>
</blockquote>
<p>这对技术人员和非技术人员都有意义。</p>
<p>我想我需要新建一个 UserSearch 类，还需要一个静态的 apply 函数来接收过滤条件。让我开始吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Search</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSearch</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Request $filters)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 返回搜索结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最简单的方式，让我们把控制器中的代码复制到 apply 函数中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSearch</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Request $filters)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = (<span class="keyword">new</span> User)-&gt;newQuery();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于用户名搜索</span></span><br><span class="line">        <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">            $user-&gt;where(<span class="string">'name'</span>, $filters-&gt;input(<span class="string">'name'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于用户的公司名搜索</span></span><br><span class="line">        <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'company'</span>)) &#123;</span><br><span class="line">            $user-&gt;where(<span class="string">'company'</span>, $filters-&gt;input(<span class="string">'company'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于用户的城市名搜索</span></span><br><span class="line">        <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">            $user-&gt;where(<span class="string">'city'</span>, $filters-&gt;input(<span class="string">'city'</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 只返回分配了销售经理的用户</span></span><br><span class="line">        <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'managers'</span>)) &#123;</span><br><span class="line">            $user-&gt;whereHas(<span class="string">'managers'</span>, </span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($filters)</span> </span>&#123;</span><br><span class="line">                    $query-&gt;whereIn(<span class="string">'managers.name'</span>, </span><br><span class="line">                        $filters-&gt;input(<span class="string">'managers'</span>));</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 搜索条件中是否包含 'event’ ？</span></span><br><span class="line">        <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'event'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 只返回被邀请参加了活动的用户</span></span><br><span class="line">            $user-&gt;whereHas(<span class="string">'rsvp.event'</span>, </span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($filters)</span> </span>&#123;</span><br><span class="line">                    $query-&gt;where(<span class="string">'event.slug'</span>, </span><br><span class="line">                        $filters-&gt;input(<span class="string">'event'</span>));</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 只返回以任何形式答复了邀请的用户</span></span><br><span class="line">            <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'responded'</span>)) &#123;</span><br><span class="line">                $user-&gt;whereHas(<span class="string">'rsvp'</span>, </span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($filters)</span> </span>&#123;</span><br><span class="line">                        $query-&gt;whereNotNull(<span class="string">'responded_at'</span>);</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 只返回以某种方式答复了邀请的用户</span></span><br><span class="line">            <span class="keyword">if</span> ($filters-&gt;has(<span class="string">'response'</span>)) &#123;</span><br><span class="line">                $user-&gt;whereHas(<span class="string">'rsvp'</span>, </span><br><span class="line">                    <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($filters)</span> </span>&#123;</span><br><span class="line">                        $query-&gt;where(<span class="string">'response'</span>, </span><br><span class="line">                            <span class="string">'I will be attending'</span>);</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回搜索结果</span></span><br><span class="line">        <span class="keyword">return</span> $user-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们做了一系列的改变。 首先，我们将在控制器中的 <em>$request</em> 变量更名为 <em>filters</em> 来提高可读性。</p>
<p>其次，由于 <code>newQuery()</code> 方法不是静态方法，无法通过 User 类静态调用，所以我们需要先创建一个 User 对象，再调用这个方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user = (<span class="keyword">new</span> User)-&gt;newQuery();</span><br></pre></td></tr></table></figure>
<p>调用上面的 UserSearch 接口，对控制器的代码进行重构：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Search</span>\<span class="title">UserSearch</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UserSearch::apply($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好多了，是不是？把一系列的条件判断交给专门的类处理，使控制器的代码简介清新。</p>
<h4 id="下面进入见证奇迹的时刻"><a href="#下面进入见证奇迹的时刻" class="headerlink" title="下面进入见证奇迹的时刻"></a>下面进入见证奇迹的时刻</h4><p>在这篇文章的例子中，一共有 7 个过滤条件，但是现实的情况是更多更多。所以在这种情况下，只用一个文件来处理所有的过滤逻辑，就显得差强人意了。扩展性不好，而且也不符合 <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod" target="_blank" rel="noopener">S.O.L.I.D. principles</a> 原则。目前，<code>apply()</code> 方法需要处理这些逻辑：</p>
<ul>
<li>检查参数是否存在</li>
<li>把参数转成查询条件</li>
<li>执行查询</li>
</ul>
<p>如果我想增加一个新的过滤条件，或者修改一下现有的某个过滤条件的逻辑，我都要不停地修改 UserSearch 类，因为所有过滤条件的处理都在这一个类里，随着业务逻辑的增加，会有点尾大不掉的感觉。所以对每个过滤条件单独建个类文件是非常有必要的。</p>
<p>先从 <code>Name</code> 条件开始吧。但是，就像我们前面讲的，还是想一下我们需要怎样使用这种单一条件过滤的接口。</p>
<p>我希望可以这样调用这个接口:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$user = (<span class="keyword">new</span> User)-&gt;newQuery();</span><br><span class="line">$user = <span class="keyword">static</span>::applyFiltersToQuery($filters, $user);</span><br><span class="line"><span class="keyword">return</span> $user-&gt;get();</span><br></pre></td></tr></table></figure>
<p>不过这里再使用 <code>$user</code> 这个变量名就不合适了，应该用 <code>$query</code> 更有意义。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Request $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $query = (<span class="keyword">new</span> User)-&gt;newQuery();</span><br><span class="line"></span><br><span class="line">    $query = <span class="keyword">static</span>::applyFiltersToQuery($filters, $query);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $query-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后把所有条件过滤的逻辑都放到 <code>applyFiltersToQuery()</code> 这个新接口里。</p>
<p>下面开始创建第一个条件过滤类：Name.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>\<span class="title">Filters</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">($builder, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $builder-&gt;where(<span class="string">'name'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个类里定义一个静态方法 <code>apply()</code>，这个方法接收两个参数，一个是 Builder 实例，另一个是过滤条件的值（ 在这个例子中，这个值是 ‘Billy’ )。然后带着这个过滤条件返回一个新的 Builder 实例。</p>
<p>接下来是 City 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>\<span class="title">Filters</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">City</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">($builder, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $builder-&gt;where(<span class="string">'city'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，City 类的代码逻辑跟 Name 类相同，只是过滤条件变成了 ‘city’。让每个条件过滤类都只有一个简单的 <code>apply()</code> 方法，而且方法接收的参数和处理的逻辑都相同，我们可以把这看成一个协议，这一点很重要，下面我会具体说明。</p>
<p>为了确保每个条件过滤类都能遵循这个协议，我决定写一个接口，让每个类都实现这个接口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>\<span class="title">Filters</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Filter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把过滤条件附加到 builder 的实例上</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Builder $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Builder $builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Builder $builder, $value)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我为这个接口的方法写了详细的注释，这样做的好处是，对于每一个实现这个接口的类，我都可以利用我的 IDE (PHPStorm) 自动生成同样的注释。</p>
<p>下面，分别在 Name 和 City 类中实现这个 Filter 接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>\<span class="title">Filters</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span> <span class="keyword">implements</span> <span class="title">Filter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把过滤条件附加到 builder 的实例上</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Builder $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Builder $builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Builder $builder, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $builder-&gt;where(<span class="string">'name'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>\<span class="title">Filters</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">City</span> <span class="keyword">implements</span> <span class="title">Filter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把过滤条件附加到 builder 的实例上</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Builder $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Builder $builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Builder $builder, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $builder-&gt;where(<span class="string">'city'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完美。现在已经有两个条件过滤类完美地遵循了这个协议。把我的目录结构附在下面给大家参考一下：</p>
<p><img src="//blog.com/2019/05/17/构建复杂的Eloquent搜索过滤/ryUJIPa0YL.png" alt=""></p>
<p>我把所有的条件过滤类的文件放在一个单独的文件夹里，这让我对已有的过滤条件一目了然。</p>
<h4 id="使用新的过滤器"><a href="#使用新的过滤器" class="headerlink" title="使用新的过滤器"></a>使用新的过滤器</h4><p>现在回过头来看 UserSearch 类的 applyFiltersToQuery () 方法，发现我们可以再做一些优化了。</p>
<p>首先，把每个条件判断里构建查询语句的工作，交给对应的过滤类去做。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据姓名搜索用户</span></span><br><span class="line"><span class="keyword">if</span> ($filters-&gt;has(<span class="string">'name'</span>)) &#123;</span><br><span class="line">    $query = Name::apply($query, $filters-&gt;input(<span class="string">'name'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据城市搜索用户</span></span><br><span class="line"><span class="keyword">if</span> ($filters-&gt;has(<span class="string">'city'</span>)) &#123;</span><br><span class="line">    $query = City::apply($query, $filters-&gt;input(<span class="string">'city'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在根据过滤条件构建查询语句的工作已经转给各个相应的过滤类了，但是判断每个过滤条件是否存在的工作，还是通过一系列的条件判断语句完成的。而且条件判断的参数都是写死的，一个参数对应一个过滤类。这样我每增加一个新的过滤条件，我都要重新修改 <code>UserSearch</code> 类的代码。这显然是一个需要解决的问题。</p>
<p>其实，根据我们前面介绍的命名规则， 我们很容易把这段条件判断的代码改成动态的：</p>
<blockquote>
<p>App\UserSearch\Filters\Name</p>
<p>App\UserSearch\Filters\City</p>
</blockquote>
<p>就是结合命名空间和过滤条件的名称，动态地创建过滤类（当然，要对接收到的过滤条件参数做适当的处理）。</p>
<p>大概就是这个思路，下面是具体实现:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">applyFiltersToQuery</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                           Request $filters, Builder $query)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($filters-&gt;all() <span class="keyword">as</span> $filterName =&gt; $value) &#123;</span><br><span class="line"></span><br><span class="line">        $decorator =</span><br><span class="line">            <span class="keyword">__NAMESPACE__</span> . <span class="string">'\\Filters\\'</span> . </span><br><span class="line">                str_replace(<span class="string">' '</span>, <span class="string">''</span>, ucwords(</span><br><span class="line">                    str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, $filterName)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (class_exists($decorator)) &#123;</span><br><span class="line">            $query = $decorator::apply($query, $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面逐行分析这段代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($filters-&gt;all() <span class="keyword">as</span> $filterName =&gt; $value) &#123;</span><br></pre></td></tr></table></figure>
<p>遍历所有的过滤参数，把参数名（比如 <code>city</code>）赋值给变量 <code>$filterName</code>，参数值（比如 <code>London</code>）复制给变量 <code>$value</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$decorator =</span><br><span class="line">            <span class="keyword">__NAMESPACE__</span> . <span class="string">'\\Filters\\'</span> . </span><br><span class="line">                str_replace(<span class="string">' '</span>, <span class="string">''</span>, ucwords(</span><br><span class="line">                    str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, $filterName)));</span><br></pre></td></tr></table></figure>
<p>这里是对参数名进行处理，将下划线改成空格，让每个单词都首字母大写，然后去掉空格，如下例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"name"</span>            =&gt; App\UserSearch\Filters\Name,\</span><br><span class="line"><span class="string">"company"</span>         =&gt; App\UserSearch\Filters\Company,\</span><br><span class="line"><span class="string">"city"</span>            =&gt; App\UserSearch\Filters\City,\</span><br><span class="line"><span class="string">"event"</span>           =&gt; App\UserSearch\Filters\Event,\</span><br><span class="line"><span class="string">"responded"</span>       =&gt; App\UserSearch\Filters\Responded,\</span><br><span class="line"><span class="string">"response"</span>        =&gt; App\UserSearch\Filters\Response,\</span><br><span class="line"><span class="string">"managers"</span>        =&gt; App\UserSearch\Filters\Managers</span><br></pre></td></tr></table></figure>
<p>如果有参数名是带下划线的，比如 <code>has_responded</code>，根据上面的规则，它将被处理成 <code>HasResponded</code>，因此，其相应的过滤类的名字也要是这个。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (class_exists($decorator)) &#123;</span><br></pre></td></tr></table></figure>
<p>这里就是要先确定这个过滤类是存在的，再执行下面的操作，否则在客户端报错就尴尬了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$query = $decorator::apply($query, $value);</span><br></pre></td></tr></table></figure>
<p>这里就是神奇的地方了，PHP 允许把变量 <code>$decorator</code> 作为类，并调用其方法（在这里就是 apply () 方法了）。现在再看这个接口的代码，发现我们再次实力证明了磨刀不误砍柴工。现在我们可以确保每个过滤类对外响应一致，内部又可以分别处理各自的逻辑。</p>
<h4 id="最后的优化"><a href="#最后的优化" class="headerlink" title="最后的优化"></a>最后的优化</h4><p>现在 <code>UserSearch</code> 类的代码应该已经比之前好多了，但是，我觉得还可以更好，所以我又做了些改动，这是最终版本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">UserSearch</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSearch</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Request $filters)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $query = </span><br><span class="line">            <span class="keyword">static</span>::applyDecoratorsFromRequest(</span><br><span class="line">                $filters, (<span class="keyword">new</span> User)-&gt;newQuery()</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::getResults($query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">applyDecoratorsFromRequest</span><span class="params">(Request $request, Builder $query)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($request-&gt;all() <span class="keyword">as</span> $filterName =&gt; $value) &#123;</span><br><span class="line"></span><br><span class="line">            $decorator = <span class="keyword">static</span>::createFilterDecorator($filterName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">static</span>::isValidDecorator($decorator)) &#123;</span><br><span class="line">                $query = $decorator::apply($query, $value);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $query;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFilterDecorator</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">return</span> <span class="keyword">__NAMESPACE__</span> . <span class="string">'\\Filters\\'</span> . </span><br><span class="line">            str_replace(<span class="string">' '</span>, <span class="string">''</span>, </span><br><span class="line">                ucwords(str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, $name)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidDecorator</span><span class="params">($decorator)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> class_exists($decorator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getResults</span><span class="params">(Builder $query)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $query-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我最后决定去掉 <code>applyFiltersToQuery()</code> 方法，是因为感觉跟接口的主要方法名 <code>apply()</code> 有点冲突了。</p>
<p>而且，为了贯彻执行单一职责原则，我把原来 <code>applyFiltersToQuery()</code> 方法里比较复杂的逻辑又做了拆分，为动态创建过滤类名称，和确认过滤类是否存在的判断，都写了单独的方法。</p>
<p>这样，即便要扩展搜索接口，我也不需要再去反复修改 <code>UserSearch</code> 类里的代码了。需要增加新的过滤条件吗？简单，只要在 <code>App\UserSearch\Filters</code> 目录下创建一个过滤类，并使之实现 <code>Filter</code> 接口就 OK 了。</p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>我们已经把一个拥有所有搜索逻辑的巨大控制器方法保存成一个允许打开过滤器的模块化过滤系统，而不需要添加修改核心代码。 像评论里 <a href="http://twitter.com/rockroxx" target="_blank" rel="noopener">@rockroxx</a> 所建议的，另一个重构的方案是把所有方法提取到 <em>trait</em> 并将 <em>User</em>  设置成  <em>const</em>  然后由 <em>Interface</em> 实现。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSearch</span> <span class="keyword">implements</span> <span class="title">Searchable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> MODEL = App\User;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SearchableTrait</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你很好的理解了这个设计模式，你可以 <a href="https://sourcemaking.com/refactoring/replace-conditional-with-polymorphism" target="_blank" rel="noopener">利用多态代替多条件</a>。</p>
<p>代码会提交到 <a href="https://github.com/drawmyattention/advanced-eloquent-search-filters/tree/master/app/UserSearch" target="_blank" rel="noopener">GitHub</a> 你可以 fork，测试和实验。</p>
<p>如何解决多条件高级搜索，我希望你能留下你的想法、建议和评论。</p>
<blockquote>
<p>原文地址：<a href="https://m.dotdev.co/writing-advanced-eloquent-search-query-filters-de8b6c2598db" target="_blank" rel="noopener">https://m.dotdev.co/writing-advanced-elo…</a></p>
<p>译文地址：<a href="https://learnku.com/laravel/t/25818" target="_blank" rel="noopener">https://learnku.com/laravel/t/25818</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/67/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/67/">67</a><span class="page-number current">68</span><a class="page-number" href="/page/69/">69</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/69/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
