<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/50/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/50/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/mysql binlog应用场景与原理深度剖析/" itemprop="url">mysql binlog应用场景与原理深度剖析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T12:12:57+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据一致性问题/" itemprop="url" rel="index">
                    <span itemprop="name">数据一致性问题</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据一致性问题/数据库与缓存/" itemprop="url" rel="index">
                    <span itemprop="name">数据库与缓存</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据一致性问题/数据库与缓存/binlog/" itemprop="url" rel="index">
                    <span itemprop="name">binlog</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/数据一致性问题/数据库与缓存/binlog/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="mysql-binlog应用场景与原理深度剖析"><a href="#mysql-binlog应用场景与原理深度剖析" class="headerlink" title="mysql binlog应用场景与原理深度剖析"></a>mysql binlog应用场景与原理深度剖析</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/-CXTVPkUdMkT-6PB3lHLRw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/-CXTVPkUdMkT-6PB3lHLRw</a></p>
</blockquote>
<p><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文深入介绍<code>Mysql Binlog</code>的应用场景，以及如何与<code>MQ、elasticsearch、redis</code>等组件的保持数据最终一致。最后通过案例深入分析<code>binlog</code>中几乎所有<code>event</code>是如何产生的，作用是什么。</p>
<h2 id="基于binlog的主从复制"><a href="#基于binlog的主从复制" class="headerlink" title="基于binlog的主从复制"></a>基于binlog的主从复制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Mysql 5.0</code>以后，支持通过<code>binary log</code>(二进制日志)以支持主从复制。复制允许将来自一个<code>MySQL</code>数据库服务器（<code>master</code>) 的数据复制到一个或多个其他<code>MySQL</code>数据库服务器（<code>slave</code>)，以实现灾难恢复、水平扩展、统计分析、远程数据分发等功能。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>二进制日志中存储的内容称之为事件，每一个数据库更新操作(Insert、Update、Delete，不包括Select)等都对应一个事件。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注意：本文不是讲解mysql主从复制，而是讲解<code>binlog</code>的应用场景，<code>binlog</code>中包含哪些类型的<code>event</code>，这些<code>event</code>的作用是什么。你可以理解为，是对主从复制中关于<code>binlog</code>解析的细节进行深度剖析。而讲解主从复制主要是为了理解<code>binlog</code>的工作流程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面以<code>mysql</code>主从复制为例，讲解一个从库是如何从主库拉取<code>binlog</code>，并回放其中的<code>event</code>的完整流程。<code>mysql</code>主从复制的流程如下图所示：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/1.webp" alt="img"></p>
<p>主要分为3个步骤：</p>
<ul>
<li><p><strong>第一步：</strong><code>master</code>在每次准备提交事务完成数据更新前，将改变记录到二进制日志(<code>binary log</code>)中（这些记录叫做二进制日志事件，<code>binary log event</code>，简称<code>event</code>)</p>
</li>
<li><p><strong>第二步：</strong><code>slave</code>启动一个<code>I/O</code>线程来读取主库<code>binary log</code>中的事件，并记录到<code>slave</code>自己的中继日志(<code>relay log</code>)中。 </p>
</li>
<li><p><strong>第三步：</strong><code>slave</code>还会起动一个<code>SQL</code>线程，该线程从<code>relay log</code>中读取事件并在备库执行，从而实现备库数据的更新。</p>
</li>
</ul>
<h2 id="binlog的应用场景"><a href="#binlog的应用场景" class="headerlink" title="binlog的应用场景"></a>binlog的应用场景</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>binlog</code>本身就像一个螺丝刀，它能发挥什么样的作用，完全取决你怎么使用。就像你可以使用螺丝刀来修电器，也可以用其来固定家具。</p>
<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最典型的场景就是通过<code>Mysql</code>主从之间通过<code>binlog</code>复制来实现横向扩展，来实现读写分离。如下图所示：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/2.webp" alt="img"></p>
<p>   在这种场景下：</p>
<ul>
<li><p>有一个主库<code>Master</code>，所有的更新操作都在<code>master</code>上进行</p>
</li>
<li><p>同时会有多个<code>Slave</code>，每个<code>Slave</code>都连接到<code>Master</code>上，获取<code>binlog</code>在本地回放，实现数据复制。</p>
</li>
<li><p>在应用层面，需要对执行的<code>sql</code>进行判断。所有的更新操作都通过<code>Master</code>(<code>Insert、Update、Delete</code>等)，而查询操作(<code>Select</code>等)都在<code>Slave</code>上进行。由于存在多个<code>slave</code>，所以我们可以在<code>slave</code>之间做负载均衡。通常业务都会借助一些数据库中间件，如<code>tddl、sharding-jdbc</code>等来完成读写分离功能。</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为工作性质的原因，笔者见过最多的一个业务，一个<code>master</code>，后面挂了20多个<code>slave</code>。笔者之前写过一篇关于数据库中间件实现原理的文章，感兴趣的读者可以参考：<a href="http://mp.weixin.qq.com/s?__biz=MzA5MDA5Njk0NQ==&amp;mid=2456618601&amp;idx=1&amp;sn=c10839f1797e7be1ea41f005b57432df&amp;chksm=87897237b0fefb215dd74c28cf5b524984b8f50d2ef13293e37919774f1c51e36642e489ee38&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">数据库中间件详解</a></p>
<h3 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一些同学可能有误删除数据库记录的经历，或者因为误操作导致数据库存在大量脏数据的情况。例如笔者，曾经因为误操作污染了业务方几十万数据记录。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如何将脏数据恢复成原来的样子？如果恢复已经被删除的记录？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这些都可以通过反解<code>binlog</code>来完成，笔者也是通过这个手段，来恢复业务方的记录。</p>
<h3 id="数据最终一致性"><a href="#数据最终一致性" class="headerlink" title="数据最终一致性"></a>数据最终一致性</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在实际开发中，我们经常会遇到一些需求，在数据库操作成功后，需要进行一些其他操作，如：发送一条消息到<code>MQ</code>中、更新缓存或者更新搜索引擎中的索引等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如何保证数据库操作与这些行为的一致性，就成为一个难题</strong>。以数据库与<code>redis</code>缓存的一致性为例：操作数据库成功了，可能会更新<code>redis</code>失败；反之亦然。很难保证二者的完全一致。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>遇到这种看似无解的问题，最好的办法是换一种思路去解决它：</strong>不要同时去更新数据库和其他组件，只是简单的更新数据库即可。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果数据库操作成功，必然会产生<code>binlog</code>。之后，我们通过一个组件，来模拟的<code>mysql</code>的<code>slave</code>，拉取并解析<code>binlog</code>中的信息。<strong>通过解析binlog的信息，去异步的更新缓存、索引或者发送MQ消息，保证数据库与其他组件中数据的最终一致。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这里，我们将模拟<code>slave</code>的组件，统一称之为<strong>binlog同步组件</strong>。你并不需要自己编写这样的一个组件，已经有很多开源的实现，例如<code>linkedin</code>的<code>databus</code>，阿里巴巴的<code>canal</code>，美团点评的<code>puma</code>等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们通过<code>binlog</code>同步组件完成数据一致性时，此时架构可能如下图所示：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/3.webp" alt="img"></p>
<h4 id="增量索引"><a href="#增量索引" class="headerlink" title="增量索引"></a>增量索引</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通常索引分为全量索引和增量索引。对于增量索引的部分，可以通过监听<code>binlog</code>变化，根据<code>binlog</code>中包含的信息，转换成<code>es</code>语法，进行实时索引更新。当然，你可能并没有使用<code>es</code>，而是<code>solr</code>，这里只是以<code>es</code>举例。</p>
<h4 id="可靠消息"><a href="#可靠消息" class="headerlink" title="可靠消息"></a>可靠消息</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可靠消息是指的是：保证本地事务与发送消息到<code>MQ</code>行为的一致性。一些业务使用<strong>本地事务表</strong>或者<strong>独立消息服务</strong>，来保证二者的最终一致。<code>Apache RocketMQ</code>在4.3版本开源了<strong>事务消息</strong>，也是用于完成此功能。事实上，这两种方案，都有一定侵入性，对业务不透明。通过订阅binlog来发送可靠消息，则是一种解耦、无侵入的方案。关于可靠消息，笔者最近写了一篇文章， 感兴趣的读者可以参考：<a href="http://mp.weixin.qq.com/s?__biz=MzA5MDA5Njk0NQ==&amp;mid=2456618733&amp;idx=1&amp;sn=2ffda081c7ba696f45d3bb392d4285b7&amp;chksm=878972b3b0fefba5ddad677032e5b2250df5ade97baed09d19a05de08500a284c9135dcfe1ea&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">可靠消息一致性的奇淫技巧</a>。</p>
<h4 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业务经常遇到的一个问题是，如何保证数据库中记录和缓存中数据的一致性。不妨换一种思路，只更新数据库，数据库更新成功后，通过拉取<code>binlog</code>来异步的更新缓存(通常是删除，让业务回源到数据库)。如果数据库更新失败，没有对应<code>binlog</code>，那么也不会去更新缓存，从而实现最终一致性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>可以看到，binlog是一把利器，可以保证数据库与与其他任何组件(es、mq、redis等)的最终一致。这是一种优雅的、通用的、无业务入侵的、彻底的解决方案</strong>。我们没有必要再单独的研究某一种其他组件如何与数据库保持最终一致，可以通过<code>binlog</code>来实现统一的解决方案。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在实际开发中，你可以简单的像上图那样，<strong>每个应用场景都模拟一个<code>slave</code></strong>，各自连接到<code>Mysql</code>上去拉取<code>binlog</code>，<code>master</code>会给每个连接上来的<code>slave</code>一份完整的<code>binlog</code>拷贝，业务拿到各自的<code>binlog</code>之后进行消费，彼此之间互不影响。但是这样，有一些弊端，多个<code>slave</code>会给<code>master</code>带来一些额外<strong>管理上的开销，网卡流量也将翻倍的增长</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>我们可以进行一些优化，之所以不同场景模拟多个slave来连接master获取同一份binlog，本质上要满足的是：一份binlog数据，同时提供给多个不同业务场景使用，彼此之间互不影响</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;显然，消息中间件是一个很好的解决方案。现在很多主流的消息中间件，都支持<strong>consumer group</strong>的概念，如<code>kafka、rocketmq</code>等。同一个<code>topic</code>中的数据，可以由多个不同<code>consumer group`</code>来消费，且不同的consumer group<code>之间是相互隔离的，例如：当前消费到的位置(</code>offset`)。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因此，我们完全可以将<code>binlog</code>，统一都发送到<code>MQ</code>中，不同的应用场景使用不同的<code>consumer grou</code>来消费，彼此之间互不影响。此时架构如下图所示：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/4.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过这样方式，我们巧妙的达到了一份数据多个应用场景来使用。一般，<strong>一个<code>Mysql</code>实例中可能会创建多个库(<code>Database</code>)，通常我们会将一个库的<code>binlog</code>放到一个对应的<code>MQ</code>中的<code>Topic</code>中</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当将<code>binlog</code>发送到<code>MQ</code>中后，我们就可以利用<code>MQ</code>的一些高级特性了。例如<code>binlog</code>发送到<code>MQ</code>过快，消费方来不及消费，可以利用<code>MQ</code>的消息堆积能力进行流量削峰。还可以利用<code>MQ</code>的消息回溯功能，例如一个业务需要消费历史的<code>binlog</code>，此时<code>MQ</code>中如果还有保存，那么就可以直接进行回溯。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，有一些<code>binlog</code>同步组件可能实现了类似于<code>MQ</code>的功能，此时你就无序再单独的使用<code>MQ</code>。</p>
<h3 id="异地多活"><a href="#异地多活" class="headerlink" title="异地多活"></a>异地多活</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一个更大的应用场景，异地多活场景下，跨数据中心之间的数据同步。这种场景的下，多个数据中心都需要写入数据，并且往对方同步。以下是一个简化的示意图：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/5.webp" alt="img"></p>
<p>这里有一些特殊的问题需要处理。典型的包括：</p>
<ul>
<li><p><strong>数据冲突：</strong>双方同时插入了一个相同主键的值，那么往对方同步时，就会出现主键冲突的错误。</p>
</li>
<li><p><strong>数据回环：</strong>一个库A中插入的数据，通过<code>binlog</code>同步到另外一个库B中，依然会产生<code>binlo</code>g。此时库B的数据再次同步回库A，如此反复，就形成了一个死循环。</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如何解决数据冲突、数据回环，就变成了<code>binlog</code>同步组件要解决的问题。同样，业界也有了成熟的实现，比较知名的有阿里开源的<code>otter</code>，以及摩拜(已经属于美团)的<code>DRC</code>等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;笔者之前写过一篇文章，介绍如何在多机房进行数据同步，感兴趣的读者可以参考以下文章：<a href="http://mp.weixin.qq.com/s?__biz=MzA5MDA5Njk0NQ==&amp;mid=2456618627&amp;idx=1&amp;sn=fce8115fd8f125cd7f2402c19b57c20a&amp;chksm=878972ddb0fefbcb2895570a5c8f5a4d73f6b79681f96ebb2c303810b06d6887963c07204459&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">异地多活场景下的数据同步之道</a></p>
<h2 id="binlog事件详解"><a href="#binlog事件详解" class="headerlink" title="binlog事件详解"></a>binlog事件详解</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Mysql</code>已经经历了多个版本的发布，最新已经到<code>8.x</code>，然而目前企业中主流使用的还是<code>Mysql 5.6</code>或<code>5.7</code>。不同版本的<code>Mysql</code>中，<code>binlog</code>的格式和事件类型可能会有些细微的变化，不过暂时我们并不讨论这些细节。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总的来说，<code>binlog</code>文件中存储的内容称之为二进制事件，简称事件。我们的每一个数据库更新操作(<code>Insert、Update、Delete</code>等)，都会对应的一个事件。</p>
<p>从大的方面来说，<code>binlog</code>主要分为2种格式：</p>
<ul>
<li><p><strong>Statement模式：</strong><code>binlog</code>中记录的就是我们执行的<code>SQL</code>；</p>
</li>
<li><p><strong>Row模式：</strong><code>binlog</code>记录的是每一行记录的每个字段变化前后得到值。</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;熟悉主从复制的同学，应该知道，还有第三种模式<strong>Mixed</strong>(即混合模式)，从严格意义上来说，这并不是一种新的<code>binlog</code>格式，只是结合了Statement和<code>Row</code>两种模式而已。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当我们选择不同的<code>binlog</code>模式时，在<code>binlog</code>文件包含的事件类型也不相同，如:</p>
<p> <strong>1)</strong>在<code>Statement</code>模式下，我们就看不到<code>Row</code>模式下独有的事件类型。</p>
<p><strong>2)</strong>有一些类型的<code>event</code>，必须在我们开启某些特定配置的情况下，才会出现；</p>
<p><strong>3)</strong>当然也会有一些公共的<code>event</code>类型，在任何模式下都会出现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mysql中定义了30多个<code>event</code>类型，这里并不打算将所有的事件类型提前列出，这样没有意义，只会让读者茫然不知所措。笔者将会在必要的地方，介绍遇到的每一种<code>event</code>类型的作用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目前我们先从宏观的角度对<code>binlog</code>有一个感性的认知。</p>
<h3 id="多文件存储"><a href="#多文件存储" class="headerlink" title="多文件存储"></a>多文件存储</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>mysql</code>将数据库更新操作对应的<code>event</code>记录到本地的<code>binlog</code>文件中，显然在一个文件中记录所有的<code>event</code>是不可能的，过大的文件会给我们的运维带来麻烦，如删除一个大文件，在<code>I/O</code>调度方面会给我们带来不可忽视的资源开销。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因此，目前基本上所有支持本地文件存储的组件，如<code>MQ、Mysql</code>等，都会控制一个文件的大小。在数据量较多的情况下，就分配到多个文件进行存储。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在<code>mysql</code>中，我们可以通过”<code>show binary logs</code>“语句，来查看当前有多少个<code>binlog</code>文件，以及每个<code>binlog</code>文件的大小，如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/6.webp" alt="img"></p>
<p>另外，<code>mysql</code>提供了：</p>
<ul>
<li><p><strong>max_binlog_size</strong>配置项，用于控制一个<code>binlog</code>文件的大小，默认是<code>1G</code></p>
</li>
<li><p><strong>expire_logs_days</strong>配置项，可以控制<code>binlog</code>文件保留天数，默认是<code>0</code>，也就是永久保留。</p>
</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在实际生产环境中，一般无法保留所有的历史<code>binlog</code>。因为一条记录可能会变更多次，记录依然是一条，但是对应的<code>binlog</code>事件就会有多个。在数据变更比较频繁的情况下，就会产生大量的<code>binlog</code>文件。此时，则无法保留所有的历史<code>binlog</code>文件。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在mysql的percona分支上，还提供了<strong>max_binlog_files</strong>配置项，用于设置可以保留的<code>binlog</code>文件数量，以便我们更精确的控制<code>binlog</code>文件占用的磁盘空间。这是一个非常有用的配置，笔者曾经遇到一个库，大约10分钟就会产生一个<code>binlog</code>文件，也就是1G，按照这种增长速度，1天下来产生的<code>binlog</code>文件，就会占用大概144G左右的空间，磁盘空间可能很快就会被使用完。通过此配置，我们可以显示的控制<code>binlog</code>文件的数量，例如指定50，<code>binlog</code>文件最多只会占用50G左右的磁盘空间。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在更高版本的<code>mysql</code>中，支持按照秒级精度，来控制<code>binlog</code>文件的保留时间。下面我们将对<code>binlog</code>文件中的内容进行详细的讲解。</p>
<h3 id="binlog管理事件"><a href="#binlog管理事件" class="headerlink" title="binlog管理事件"></a>binlog管理事件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<code>binlog</code>管理事件，官方称之为<code>binlog managent events</code>，你可以认为是一些在任何模式下都有可能会出现的事件，不管你的配置<code>binlog_format</code>是<code>Row、Statement</code>还是<code>Mixed</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以下通过<strong>“show binlog events”</strong>语法进行查看一个空的<code>binlog</code>文件，也就是只包含(部分)管理事件，没有其他数据更新操作对应的事件。如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/7.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在当前<code>binlog v4</code>版本中，每个<code>binlog</code>文件总是以<strong>Format Description Event</strong>作为开始，以<strong>Rotate Event</strong>结束作为结束。如果你使用的是很古老的<code>Mysql</code>版本中，开始事件也有可能是<strong>START EVENT V3，</strong>而结束事件是<strong>Stop Event</strong>。在开始和结束之间，穿插着其他各种事件。</p>
<p>在Event_Type列中，我们看到了三个事件类型：</p>
<ul>
<li><p><strong>Format_desc：</strong>也就是我们所说的<code>Format Description Event</code>，是<code>binlog</code>文件的第一个事件。在<code>Info</code>列，我们可以看到，其标明了<code>Mysql Server</code>的版本是<code>5.7.10</code>，<code>Binlog</code>版本是4。</p>
</li>
<li><p><strong>Previous_gtids：</strong>该事件完整名称为，<code>PREVIOUS_GTIDS_LOG_EVENT</code>。熟悉<code>Mysql</code> 基于<code>GTID</code>复制的同学应该知道，这是表示之前的<code>binlog</code>文件中，已经执行过的<code>GTID</code>。需要我们开启<code>GTID</code>选项，这个事件才会有值，在后文中，将会详细的进行介绍。</p>
</li>
<li><p><strong>Rotate：</strong><code>Rotate Event</code>是每个<code>binlog</code>文件的结束事件。在<code>Info</code>列中，我们看到了其指定了下一个<code>binlog</code>文件的名称是<code>mysql-bin.000004</code>。</p>
</li>
</ul>
<p>关于<strong>“show binlog events”</strong>语法显示的每一列的作用说明如下：</p>
<ul>
<li><p><code>Log_name</code>：当前事件所在的<code>binlog</code>文件名称</p>
</li>
<li><p><code>Pos</code>：当前事件的开始位置，每个事件都占用固定的字节大小，结束位置(<code>End_log_position</code>)减去<code>Pos</code>，就是这个事件占用的字节数。细心的读者可以看到了，第一个事件位置并不是从0开始，而是从4。<code>Mysql</code>通过文件中的前4个字节，来判断这是不是一个<code>binlog</code>文件。这种方式很常见，很多格式的文件，如<code>pdf、doc、jpg</code>等，都会通常前几个特定字符判断是否是合法文件。`</p>
</li>
<li><p><code>Event_type</code>：表示事件的类型</p>
</li>
<li><p><code>Server_id</code>：表示产生这个事件的<code>mysql server_id</code>，通过设置<code>my.cnf</code>中的<strong>server-id</strong>选项进行配置。</p>
</li>
<li><p><code>End_log_position</code>：下一个事件的开始位置</p>
</li>
<li><p><code>Info</code>：当前事件的描述信息</p>
</li>
</ul>
<h3 id="Statement模式下的事件"><a href="#Statement模式下的事件" class="headerlink" title="Statement模式下的事件"></a>Statement模式下的事件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>mysql5.0</code>及之前的版本只支持基于语句的复制，也称之为逻辑复制，也就是<code>binary log</code>文件中，直接记录的就是数据更新对应的<code>sql</code>。</p>
<p>假设有名为<code>test</code>库中有一张<code>user</code>表，如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/8.webp" alt="img"></p>
<p>现在，我们往<code>user</code>表中插入一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into user(name) values(&quot;tianbowen&quot;);</span><br></pre></td></tr></table></figure>
<p>之后，可以使用”<strong>show binlog events</strong>“ 语法查看<code>binary log</code>中的内容，如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/9.webp" alt="img"></p>
<p>​       红色框架中Event，是我们执行上面<code>Insert</code>语句产生的4个<code>Event</code>。</p>
<p>下面进行详细的说明：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(划重点)首先，需要说明的是，每个事务都是以<strong>Query Event</strong>作为开始，其<code>INFO</code>列内容为”<code>BEGIN</code>“，以<strong>Xid Event</strong>表示结束，其<code>INFO</code>列内容为<code>COMMIT</code>。即使对于单条更新<code>SQL</code>我们没有开启事务，<code>Mysql</code>也会默认的帮我们开启事务。因此在上面的红色框中，尽管我们只是执行了一个<code>INSERT</code>语句，没有开启事务，但是<code>Mysql</code>默认帮我们开启了事务，所以第一个<code>Event</code>是<code>Query Event</code>，最后一个是<code>Xid Event</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着，是一个<strong>Intvar Event</strong>，因为我们的<code>Insert</code>语句插入的表中，主键是自增的(<code>AUTO_INCREMENT</code>)列，<code>Mysql</code>首先会自增一个值，这就是<code>Intvar Event</code>的作用，这里我们看到<code>INFO</code>列的值为<code>INSERT_ID=1</code>，也就是说，这次的自增主键id为1。需要注意的是，这个事件，只会在<code>Statement</code>模式下出现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后，还是一个<code>Query Event</code>，这里记录的就是我们插入的<code>SQL</code>。这也体现了<code>Statement</code>模式的作用，就是记录我们执行的<code>SQL</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Statement模式下还有一些不常用的<code>Event</code>，如<strong>USER_VAR_EVENT</strong>，这是用于记录用户设置的变量，仅仅在<code>Statement</code>模式起作用。如：</p>
<p>执行以下<code>SQL</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set @name = &apos;tianshouzhi&apos;;insert into user(name) values(@name);</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里，我们插入<code>sql</code>的时候，通过引用一个变量。此时查看<code>binlog</code>变化，这里为了易于观察，在执行<code>show binlog events</code>时，指定了<code>binlog</code>文件和<code>from</code>的位置，即只查看指定<code>binlog</code>文件中从指定位置开始的<code>event</code>。如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/10.webp" alt="img"></p>
<p>可以看到，依然符合我们所说的，对于这个插入语句，依然默认开启了事务。主键自曾值<code>INSERT_ID=2</code>。</p>
<p>当然，我们也看到了<code>User var</code>这个事件，其记录了我们的设置的变量值，只不过以16进制显示。</p>
<h3 id="Row模式下的事件"><a href="#Row模式下的事件" class="headerlink" title="Row模式下的事件"></a>Row模式下的事件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>mysql5.1</code>开始支持基于行的复制，这种方式记录的某条sql影响的所有行记录<strong>变更前</strong>和<strong>变更后</strong>的值。<code>Row</code>模式下主要有以下10个事件：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/11.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很直观的，我们看到了<code>INSERT、DELETE、UPDATE</code>操作都有3个版本(<code>v0、v1、v2</code>)，v0和v1已经过时，我们只需要关注V2版本。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此外，还有一个<strong>TABLE_MAP_EVENT</strong>，这个<code>event</code>我们需要特别关注，可以理解其作用就是记录了<code>INSERT、DELETE、UPDATE</code>操作的表结构。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下面，我们通过案例演示，<code>ROW</code>模式是如何记录变更前后记录的值，而不是记录<code>SQL</code>。这里只演示<code>UPDATE，INSERT和DELETE</code>也是类似。</p>
<p>在前面的操作步骤中，我们已经插入了2条记录，如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/12.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在需要从<code>Statement</code>模式切换到<code>Row</code>模式，重启<code>Mysql</code>之后，执行以下<code>SQL</code>更新这两条记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set name=&apos;wangxiaoxiao&apos;;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在<code>binary log</code>中，会把这2条记录变更前后的值都记录下来，以下是一个逻辑示意图：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/13.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该逻辑示意图显示了，在默认情况下，受到影响的记录行，每个字段变更前的和变更后的值，都会被记录下来，即使这个字段的值没有发生变化<strong>。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着，我们还是通过”<code>show binlog events</code>“语法来验证：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/14.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先我们可以看到的是，在<code>Row</code>模式下，单条<code>SQL</code>依然会默认开启事务，通过<code>Query Event</code>(值为BEGIN)开始，以<code>Xid Event</code>结束。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着，我们看到了一个<code>Table_map</code>事件，就是前面提到的<code>TABLE_MAP_EVENT</code>，在INFO列，我们可以看到其记录table_id为108，操作的是test库中user表。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后，是一个<strong>Update_rows</strong>事件，然而其<code>INFO</code>，并没有像<code>Statement</code>模式那样，显示一条SQL，我们无法直接看到其变更前后的值是什么。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于存储的都是二进制内容，直接vim无法查看，我们需要借助另外一个工具<strong>mysqlbinlog</strong>来查看其内容。如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/15.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;截图中显示了2个<code>event</code>，第一个红色框就是<code>Table_map</code>事件，第二个是<code>Update_rows</code>事件。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在第二个红色框架中，显示了两个<code>Update sql</code>，这是只是<code>mysqlbinlog</code>工具为了方便我们查看，反解成<code>SQL</code>而已。我们看到了<code>WHERE</code>以及<code>SET</code>子句中，并没有直接列出字段名，而是以<strong>@1</strong>、<strong>@2</strong>这样的表示字段位于数据库表中的顺序。<strong>事实上，这里显示的内容，WHERE部分就是每个字段修改前的值，而SET部分，则是每个字段修改后的值，</strong>也就是变更前后的值都会记录。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里我们思考以下<code>mysqlbinlog</code>工具的工作原理，其可以将二进制数据反解成SQL进行展示。那么，<strong>如果我们可以自己解析binlog，就可以做数据恢复，这并非是什么难事</strong>。例如用户误删除的数据，执行的是<code>DETELE</code>语句，由于Row模式下会记录变更之前的字段的值，我们可以将其反解成一个<code>INSERT</code>语句，重新插入，从而实现数据恢复。</p>
<h3 id="binlog-row-image参数"><a href="#binlog-row-image参数" class="headerlink" title="binlog_row_image参数"></a>binlog_row_image参数</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我们经常会看到一些<code>Row</code>模式和<code>Statement</code>模式的比较。<code>ROW</code>模式下，即使我们只更新了一条记录的其中某个字段，也会记录每个字段变更前后的值，<code>binlog</code>日志就会变大，带来磁盘<code>IO</code>上的开销，以及网络开销。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;事实上，这个行为可以通过<strong>binlog_row_image</strong>控制其有3个值，默认为<code>FULL</code>： </p>
<ul>
<li><p><code>FULL</code> : 记录列的所有修改，即使字段没有发生变更也会记录。 </p>
</li>
<li><p><code>MINIMAL</code>：只记录修改的列。 </p>
</li>
<li><p><code>NOBLOB</code> :如果是text类型或clob字段，不记录这些日志。 </p>
</li>
</ul>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/16.webp" alt="img"></p>
<p>我们可以将其修改为<code>MINIMAL</code>，则可以只记录修改的列的值。</p>
<h3 id="binlog-rows-query-log-events参数"><a href="#binlog-rows-query-log-events参数" class="headerlink" title="binlog_rows_query_log_events参数"></a>binlog_rows_query_log_events参数</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在<code>Statement</code>模式下，直接记录<code>SQL</code>比较直观，事实上，在<code>Row</code>模式下，也可以记录。<code>mysql</code>提供了一个<strong>binlog_rows_query_log_events</strong>参数，默认为值为<code>FALSE</code>，如果为<code>true</code>的情况下，会通过<strong>Rows Query Event</strong>来记录<code>SQL</code>。</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/17.webp" alt="img"></p>
<p> 可以在<code>my.cnf</code>中添加以下配置，来开启<code>row</code>模式下的原始<code>sql</code>记录(需要重启)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog-rows-query-log_events=1</span><br></pre></td></tr></table></figure>
<p>之后，再插入数据数据时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into user(name) values(&quot;maoxinyi&quot;);</span><br></pre></td></tr></table></figure>
<p>在binlog文件中，我们将看到<strong>Rows Query Event</strong></p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/18.webp" alt="img"></p>
<h3 id="GTID相关事件"><a href="#GTID相关事件" class="headerlink" title="GTID相关事件"></a>GTID相关事件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从<code>MySQL 5.6</code>开始支持<code>GTID</code>复制。要开启<code>GTID</code>，修改<code>my.cnf</code>文件，添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gtid-mode=onenforce-gtid-consistency=true</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这种情况下，每当我们执行一个事务之前，都会记录一个<strong>GTID Event</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into user(&quot;name&quot;) values(&quot;zhuyihan&quot;);</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此时<code>binlog</code>内容如下：</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/19.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而当我们切换到下一个<code>binlog</code>文件时，会记录之前的已经执行过的<code>GTID</code>。这里我们通过执行以下sql手工切换到一个新的<code>binlog</code>文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;之后在新的<code>binlog</code>文件中，我们看到之前执行过的<code>GTID</code>在下一个文件中出现了。</p>
<p><img src="//blog.com/2019/06/07/mysql binlog应用场景与原理深度剖析/20.webp" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/07/epoll的本质是什么/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/epoll的本质是什么/" itemprop="url">epoll的本质是什么</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T12:12:57+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/" itemprop="url" rel="index">
                    <span itemprop="name">异步与同步</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/" itemprop="url" rel="index">
                    <span itemprop="name">IO</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/" itemprop="url" rel="index">
                    <span itemprop="name">Reactor</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/" itemprop="url" rel="index">
                    <span itemprop="name">事件模型</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/网络编程/" itemprop="url" rel="index">
                    <span itemprop="name">网络编程</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/网络编程/epoll/" itemprop="url" rel="index">
                    <span itemprop="name">epoll</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/异步与同步/IO/Reactor/事件模型/网络编程/epoll/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="epoll的本质是什么"><a href="#epoll的本质是什么" class="headerlink" title="epoll的本质是什么"></a>epoll的本质是什么</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://my.oschina.net/editorial-story/blog/3052308" target="_blank" rel="noopener">https://my.oschina.net/editorial-story/blog/3052308</a></p>
</blockquote>
<p><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从事服务端开发，少不了要接触网络编程。<code>epoll</code>作为 <code>Linux</code>下高性能网络服务器的必备技术至关重要，<code>nginx、Redis、Skynet</code> 和大部分游戏服务器都使用到这一多路复用技术。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>epoll</code> 很重要，但是 <code>epoll</code> 与<code>select</code> 的区别是什么呢？<code>epoll</code> 高效的原因是什么？</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/dcab45cdf583afdb6454136423d8715dea8.jpg" alt="img"></p>
<h2 id="一、从网卡接收数据说起"><a href="#一、从网卡接收数据说起" class="headerlink" title="一、从网卡接收数据说起"></a>一、从网卡接收数据说起</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下边是一个典型的计算机结构图，计算机由 <code>CPU</code>、存储器（内存）与网络接口等部件组成，了解<code>epoll</code>本质的第一步，要从硬件的角度看计算机怎样接收网络数据。</p>
<p> <img src="//blog.com/2019/06/07/epoll的本质是什么/b6b74290f1b19e5b896e1b87b6e0bf7b0ed.jpg" alt="img"></p>
<p><em>计算机结构图（图片来源：Linux内核完全注释之微型计算机组成结构）</em></p>
<p>下图展示了网卡接收数据的过程。</p>
<ul>
<li>在 ① 阶段，网卡收到网线传来的数据；</li>
<li>经过 ② 阶段的硬件电路的传输；</li>
<li>最终 ③ 阶段将数据写入到内存中的某个地址上。</li>
</ul>
<p>这个过程涉及到 <code>DMA</code>传输、<code>IO</code>通路选择等硬件有关的知识，但我们只需知道：<strong>网卡会把接收到的数据写入内存</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/d34b8536eac6c7b3f4e0121ee12108c948b.jpg" alt="img"></p>
<p><em>网卡接收数据的过程</em></p>
<p>通过硬件传输，网卡接收的数据存放到内存中，操作系统就可以去读取它们。</p>
<h2 id="二、如何知道接收了数据？"><a href="#二、如何知道接收了数据？" class="headerlink" title="二、如何知道接收了数据？"></a>二、如何知道接收了数据？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;了解<code>epoll</code>本质的第二步，要从<code>CPU</code>的角度来看数据接收。理解这个问题，要先了解一个概念——中断。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;计算机执行程序时，会有优先级的需求。比如，当计算机收到断电信号时，它应立即去保存数据，保存数据的程序具有较高的优先级（电容可以保存少许电量，供 <code>CPU</code> 运行很短的一小段时间）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般而言，由硬件产生的信号需要<code>CPU</code> 立马做出回应，不然数据可能就丢失了，所以它的优先级很高。<code>CPU</code>理应中断掉正在执行的程序，去做出响应；当 <code>CPU</code>完成对硬件的响应后，再重新执行用户程序。中断的过程如下图，它和函数调用差不多，只不过函数调用是事先定好位置，而中断的位置由“信号”决定。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/ca86ebe62fc1c55d2989592824ffe07fde2.jpg" alt="img"></p>
<p><em>中断程序调用</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以键盘为例，当用户按下键盘某个按键时，键盘会给<code>CPU</code> 的中断引脚发出一个高电平，<code>CPU</code>能够捕获这个信号，然后执行键盘中断程序。下图展示了各种硬件通过中断与<code>CPU</code> 交互的过程。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/d51575f1d1b65b6b5c3ef9f46aac5bc4a2a.jpg" alt="img"><br><em>CPU 中断（图片来源：net.pku.edu.cn）</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在可以回答“<strong>如何知道接收了数据？</strong>”这个问题了：<strong>当网卡把数据写入到内存后，网卡向 <code>CPU</code> 发出一个中断信号，操作系统便能得知有新数据到来，再通过网卡中断程序去处理数据</strong>。</p>
<h2 id="三、进程阻塞为什么不占用-CPU-资源？"><a href="#三、进程阻塞为什么不占用-CPU-资源？" class="headerlink" title="三、进程阻塞为什么不占用 CPU 资源？"></a>三、进程阻塞为什么不占用 CPU 资源？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;了解<code>epoll</code>本质的第三步，要从操作系统进程调度的角度来看数据接收。<strong>阻塞是进程调度的关键一环，指的是进程在等待某事件（如接收到网络数据）发生之前的等待状态，<code>recv、select 和 epoll</code>都是阻塞方法</strong>。下边分析一下进程阻塞为什么不占用 <code>CPU</code> 资源？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为简单起见，我们从普通的<code>recv</code> 接收开始分析，先看看下面代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建socket</span></span><br><span class="line"><span class="keyword">int</span> s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);   </span><br><span class="line"><span class="comment">//绑定</span></span><br><span class="line">bind(s, ...)</span><br><span class="line"><span class="comment">//监听</span></span><br><span class="line">listen(s, ...)</span><br><span class="line"><span class="comment">//接受客户端连接</span></span><br><span class="line"><span class="keyword">int</span> c = accept(s, ...)</span><br><span class="line"><span class="comment">//接收客户端数据</span></span><br><span class="line">recv(c, ...);</span><br><span class="line"><span class="comment">//将数据打印出来</span></span><br><span class="line"><span class="built_in">printf</span>(...)</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这是一段最基础的网络编程代码，先新建<code>socket</code>对象，依次调用<code>bind、listen</code> 与 <code>accept</code>，最后调用<code>recv</code>接收数据。<code>recv</code> 是个阻塞方法，当程序运行到 <code>recv</code> 时，它会一直等待，直到接收到数据才往下执行。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那么阻塞的原理是什么？</p>
<h3 id="工作队列"><a href="#工作队列" class="headerlink" title="工作队列"></a>工作队列</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;操作系统为了支持多任务，实现了进程调度的功能，会把进程分为“运行”和“等待”等几种状态。运行状态是进程获得 <code>CPU</code> 使用权，正在执行代码的状态；等待状态是阻塞状态，比如上述程序运行到<code>recv</code>时，程序会从运行状态变为等待状态，接收到数据后又变回运行状态。操作系统会分时执行各个运行状态的进程，由于速度很快，看上去就像是同时执行多个任务。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下图的计算机中运行着 A、B 与 C 三个进程，其中进程 A 执行着上述基础网络程序，一开始，这 3 个进程都被操作系统的工作队列所引用，处于运行状态，会<strong>分时执行</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/1a5418e9c98fca59261ba1b60b85192aef1.jpg" alt="img"></p>
<p><em>工作队列中有 A、B 和 C 三个进程</em></p>
<h3 id="等待队列"><a href="#等待队列" class="headerlink" title="等待队列"></a>等待队列</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当进程 A 执行到创建 <code>socket</code> 的语句时，操作系统会创建一个由文件系统管理的 <code>socket</code> 对象（如下图）。这个<code>socket</code> 对象包含了发送缓冲区、接收缓冲区与等待队列等成员。<strong>等待队列是个非常重要的结构，它指向所有需要等待该 <code>socket</code>事件的进程</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/b69ec1091258a28ef5e5e6173e0d110a51c.jpg" alt="img"></p>
<p><em>创建 socket</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当程序执行到 <code>recv</code>时，操作系统会将进程 A 从工作队列移动到该 <code>socket</code> 的等待队列中（如下图）。由于工作队列只剩下了进程 B 和 C，依据进程调度，<code>CPU</code>会轮流执行这两个进程的程序，不会执行进程 A 的程序。所以进程 A 被阻塞，不会往下执行代码，也不会占用 <code>CPU</code> 资源。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/09494eced300dc6610aa8bc3544e196f54e.jpg" alt="img"></p>
<p><em>socket 的等待队列</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：操作系统添加等待队列只是添加了对这个“等待中”进程的引用，以便在接收到数据时获取进程对象、将其唤醒，而非直接将进程管理纳入自己之下。上图为了方便说明，直接将进程挂到等待队列之下。</p>
<h3 id="唤醒进程"><a href="#唤醒进程" class="headerlink" title="唤醒进程"></a>唤醒进程</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当 <code>socket</code> 接收到数据后，操作系统将该<code>socket</code>等待队列上的进程重新放回到工作队列，该进程变成运行状态，继续执行代码。同时由于<code>socket</code> 的接收缓冲区已经有了数据，<code>recv</code>可以返回接收到的数据。</p>
<h2 id="四、内核接收网络数据全过程"><a href="#四、内核接收网络数据全过程" class="headerlink" title="四、内核接收网络数据全过程"></a>四、内核接收网络数据全过程</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这一步，贯穿网卡、中断与进程调度的知识，叙述阻塞<code>recv</code>下，内核接收数据的全过程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如下图所示，进程在<code>recv</code> 阻塞期间，计算机收到了对端传送的数据（步骤①），数据经由网卡传送到内存（步骤②），然后网卡通过中断信号通知 <code>CPU</code> 有数据到达，<code>CPU</code>执行中断程序（步骤③）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此处的<strong>中断程序主要有两项功能，先将网络数据写入到对应 <code>socket</code>的接收缓冲区里面（步骤④），再唤醒进程 A（步骤⑤），重新将进程 A 放入工作队列中</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/a0ad9bdc62ad4670365301d8c39ae476e0b.jpg" alt="img"></p>
<p><em>内核接收数据全过程</em></p>
<p>唤醒进程的过程如下图所示：</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/19da1395842a5a5eaf7c1fa70bf72c84c6a.jpg" alt="img"></p>
<p><em>唤醒进程</em></p>
<p>以上是内核接收数据全过程，这里我们可能会思考两个问题：</p>
<ul>
<li>其一，<strong>操作系统如何知道网络数据对应于哪个 socket</strong>？</li>
<li>其二，<strong>如何同时监视多个 socket 的数据</strong>？</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一个问题：<strong>因为一个 socket 对应着一个端口号，而网络数据包中包含了 ip 和端口的信息，内核可以通过端口号找到对应的 socket</strong>。当然，为了提高处理速度，操作系统会维护端口号到 <code>socket</code> 的索引结构，以快速读取。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二个问题是多路复用的重中之重，也正是本文后半部分的重点。</p>
<h2 id="五、同时监视多个-socket-的简单方法"><a href="#五、同时监视多个-socket-的简单方法" class="headerlink" title="五、同时监视多个 socket 的简单方法"></a>五、同时监视多个 socket 的简单方法</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>服务端需要管理多个客户端连接，而 <code>recv</code>只能监视单个 <code>socket</code></strong>，这种矛盾下，人们开始寻找监视多个 <code>socket</code> 的方法。<strong>epoll 的要义就是高效地监视多个 socket</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从历史发展角度看，必然先出现一种不太高效的方法，人们再加以改进，正如 <code>select</code>之于 <code>epoll</code>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先理解不太高效的 <code>select</code>，才能够更好地理解<code>epoll</code>的本质。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;假如能够<strong>预先传入一个 <code>socket</code>列表，如果列表中的 <code>socket</code>都没有数据，挂起进程，直到有一个 <code>socket</code>收到数据，唤醒进程</strong>。这种方法很直接，也是 <code>select</code>的设计思想。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为方便理解，我们先复习 <code>select</code>的用法。在下边的代码中，先准备一个数组<code>fds</code>，让<code>fds</code>存放着所有需要监视的<code>socket</code>。然后调用 <code>select</code>，如果<code>fds</code> 中的所有 <code>socket</code>都没有数据，<code>select</code>会阻塞，直到有一个 <code>socket</code> 接收到数据，<code>select</code> 返回，唤醒进程。用户可以遍历 <code>fds</code>，通过 <code>FD_ISSET</code>判断具体哪个 <code>socket</code> 收到数据，然后做出处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);  </span><br><span class="line">bind(s, ...);</span><br><span class="line">listen(s, ...);</span><br><span class="line"><span class="keyword">int</span> fds[] =  存放需要监听的socket;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">int</span> n = select(..., fds, ...)</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; fds.count; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(FD_ISSET(fds[i], ...))&#123;</span><br><span class="line">            <span class="comment">//fds[i]的数据处理</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>select 的流程</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>select</code> 的实现思路很直接，假如程序同时监视如下图的 <code>sock1、sock2</code>和 <code>sock3</code> 三个 <code>socket</code>，那么在<strong>调用 <code>select</code>之后，操作系统把进程 A 分别加入这三个 <code>socket</code> 的等待队列中</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/b86e3ee49616e773a967648e69278bb2e74.jpg" alt="img"></p>
<p><em>操作系统把进程 A 分别加入这三个 socket 的等待队列中</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当任何一个<code>socket</code> 收到数据后，中断程序将唤起进程</strong>。下图展示了 <code>sock2</code>接收到了数据的处理流程：</p>
<p>注：<code>recv</code>和<code>select</code> 的中断回调可以设置成不同的内容。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/e553196c24b162263fe98c8754407eabc98.jpg" alt="img"></p>
<p><em>sock2 接收到了数据，中断程序唤起进程 A</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<strong>唤起进程，就是将进程从所有的等待队列中移除，加入到工作队列里面</strong>，如下图所示：</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/060b95ed33c31e140e0e8409de559d855c5.jpg" alt="img"></p>
<p><em>将进程 A 从所有等待队列中移除，再加入到工作队列里面</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;经由这些步骤，<strong>当进程 A 被唤醒后，它知道至少有一个<code>socket</code>接收了数据。程序只需遍历一遍 <code>socket</code>列表，就可以得到就绪的 <code>socket</code></strong>。这种简单方式行之有效，在几乎所有操作系统都有对应的实现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是简单的方法往往有缺点，主要是：</p>
<p>其一，<strong>每次调用 <code>select</code> 都需要将进程加入到所有监视 <code>socket</code>的等待队列，每次唤醒都需要从每个队列中移除</strong>。这里涉及了两次遍历，而且每次都要将整个 <code>fds</code>列表传递给内核，有一定的开销。正是因为遍历操作开销大，出于效率的考量，才会规定<code>select</code> 的最大监视数量，默认只能监视 <code>1024</code>个 <code>socket</code>。</p>
<p>其二，<strong>进程被唤醒后，程序并不知道哪些<code>socket</code> 收到数据，还需要遍历一次</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那么，<strong>有没有减少遍历的方法？有没有保存就绪 socket 的方法？这两个问题便是 epoll 技术要解决的</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;补充说明： 本节只解释了 <code>select</code>的一种情形。当程序调用 <code>select</code> 时，内核会先遍历一遍<code>socket</code>，如果有一个以上的<code>socket</code>接收缓冲区有数据，那么<code>select</code>直接返回，不会阻塞。这也是为什么<code>select</code> 的返回值有可能大于 1 的原因之一。如果没有 <code>socket</code>有数据，进程才会阻塞。</p>
<h2 id="六、epoll-的设计思路"><a href="#六、epoll-的设计思路" class="headerlink" title="六、epoll 的设计思路"></a>六、epoll 的设计思路</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>epoll</code>是在<code>select</code> 出现 N 多年后才被发明的，是<code>select</code> 和 <code>poll</code>（<code>poll</code> 和 <code>select</code> 基本一样，有少量改进）的增强版本。<code>epoll</code>通过以下一些措施来改进效率：</p>
<h3 id="措施一：功能分离"><a href="#措施一：功能分离" class="headerlink" title="措施一：功能分离"></a>措施一：功能分离</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select 低效的原因之一是将“维护等待队列”和“阻塞进程”两个步骤合二为一。如下图所示，每次调用 <code>select</code> 都需要这两步操作，然而大多数应用场景中，<strong>需要监视的 <code>socket</code>相对固定，并不需要每次都修改</strong>。<strong><code>epoll</code>将这两个操作分开，先用 <code>epoll_ctl</code>维护等待队列，再调用 <code>epoll_wait</code> 阻塞进程</strong>。显而易见地，效率就能得到提升。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/0ddba276b2f74f2706d029a4268529d8554.jpg" alt="img"></p>
<p><em>相比 select，epoll 拆分了功能</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;为方便理解后续的内容，我们先了解一下 <code>epoll</code>的用法。如下的代码中，先用 <code>epoll_create</code>创建一个<code>epoll</code>对象 <code>epfd</code>，再通过 <code>epoll_ctl</code>将需要监视的<code>socket</code>添加到 <code>epfd</code>中，最后调用<code>epoll_wait</code>等待数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> s = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);   </span><br><span class="line">bind(s, ...)</span><br><span class="line">listen(s, ...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> epfd = epoll_create(...);</span><br><span class="line">epoll_ctl(epfd, ...); <span class="comment">//将所有需要监听的socket添加到epfd中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">int</span> n = epoll_wait(...)</span><br><span class="line">    <span class="keyword">for</span>(接收到数据的socket)&#123;</span><br><span class="line">        <span class="comment">//处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>功能分离，使得 <code>epoll</code>有了优化的可能。</p>
<h3 id="措施二：就绪列表"><a href="#措施二：就绪列表" class="headerlink" title="措施二：就绪列表"></a>措施二：就绪列表</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>select</code>低效的另一个原因在于程序不知道哪些 <code>socke</code>t 收到数据，只能一个个遍历。<strong>如果内核维护一个“就绪列表”，引用收到数据的<code>socket</code>，就能避免遍历</strong>。如下图所示，计算机共有三个 <code>socket</code>，收到数据的<code>sock2</code> 和 <code>sock3</code>被就绪列表 <code>rdlist</code> 所引用。<strong>当进程被唤醒后，只要获取 <code>rdlist</code>的内容，就能够知道哪些<code>socket</code>收到数据</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/97e948290e77771ac70add4f0945f315021.jpg" alt="img"></p>
<p><em>就绪列表示意图</em></p>
<h2 id="七、epoll-的原理与工作流程"><a href="#七、epoll-的原理与工作流程" class="headerlink" title="七、epoll 的原理与工作流程"></a>七、epoll 的原理与工作流程</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本节会以示例和图表来讲解 <code>epoll</code> 的原理和工作流程。</p>
<h3 id="创建-epoll-对象"><a href="#创建-epoll-对象" class="headerlink" title="创建 epoll 对象"></a>创建 epoll 对象</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如下图所示，当某个进程调用 <code>epoll_create</code> 方法时，<strong>内核会创建一个<code>eventpoll</code>对象（也就是程序中 <code>epfd</code>所代表的对象）</strong>。<code>eventpoll</code>对象也是文件系统中的一员，和 <code>socket</code>一样，它也会有<strong>等待队列</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/30b27df072206fea5639252ad7fadc63bb2.jpg" alt="img"></p>
<p><em>内核创建 eventpoll 对象</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>创建一个代表该 <code>epoll</code>的 <code>eventpoll</code>对象是必须的，因为内核要维护“就绪列表”等数据，“就绪列表”可以作为 <code>eventpoll</code>的成员</strong>。</p>
<h3 id="维护监视列表"><a href="#维护监视列表" class="headerlink" title="维护监视列表"></a>维护监视列表</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;创建 <code>epoll</code> 对象后，可以用<code>epoll_ctl</code> 添加或删除所要监听的<code>socket</code>。以添加<code>socket</code>为例，如下图，如果通过 <code>epoll_ctl</code> 添加 <code>sock1、sock2</code> 和<code>sock3</code> 的监视，<strong>内核会将<code>eventpoll</code>添加到这三个 <code>socket</code> 的等待队列中</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/7747ffcc54ec6d4f0385a7f34af7e1d9a94.jpg" alt="img"></p>
<p><em>添加所要监听的 socket</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当 <code>socket</code>收到数据后，中断程序会操作 <code>eventpoll</code>对象，而不是直接操作进程</strong>。</p>
<h3 id="接收数据"><a href="#接收数据" class="headerlink" title="接收数据"></a>接收数据</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当 <code>socket</code> 收到数据后，中断程序会给 <code>eventpoll</code>的“就绪列表”添加<code>socket</code>引用</strong>。如下图展示的是 <code>sock2</code> 和 <code>sock3</code>收到数据后，中断程序让 <code>rdlist</code> 引用这两个 <code>socket</code>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/cfb2eb13b21262f8182536a4bae270e766f.jpg" alt="img"></p>
<p><em>给就绪列表添加引用</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>eventpoll</code> 对象相当于<code>socket</code> 和进程之间的中介，<code>socket</code>的数据接收并不直接影响进程，而是通过改变 <code>eventpoll</code> 的就绪列表来改变进程状态</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当程序执行到 <code>epoll_wait</code> 时，如果<code>rdlist</code>已经引用了 <code>socket</code>，那么 <code>epoll_wait</code>直接返回，如果<code>rdlist</code>为空，阻塞进程。</p>
<h3 id="阻塞和唤醒进程"><a href="#阻塞和唤醒进程" class="headerlink" title="阻塞和唤醒进程"></a>阻塞和唤醒进程</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;假设计算机中正在运行进程 A 和进程 B，在某时刻进程 A 运行到了 <code>epoll_wait</code> 语句。如下图所示，<strong>内核会将进程 A 放入 eventpoll 的等待队列中，阻塞进程</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/e5dc0eb74081450fc5a38814733c0a6c6cd.jpg" alt="img"></p>
<p><em>epoll_wait 阻塞进程</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当 <code>socket</code> 接收到数据，中断程序一方面修改 <code>rdlist</code>，另一方面唤醒 <code>eventpoll</code> 等待队列中的进程，进程 A 再次进入运行状态</strong>（如下图）。也<strong>因为 <code>rdlist</code> 的存在，进程 A 可以知道哪些 <code>socket</code>发生了变化</strong>。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/b6366aa6286134dde88d2e722629dd2d68a.jpg" alt="img"></p>
<p><em>epoll 唤醒进程</em></p>
<h2 id="八、epoll-的实现细节"><a href="#八、epoll-的实现细节" class="headerlink" title="八、epoll 的实现细节"></a>八、epoll 的实现细节</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至此，相信读者对<code>epoll</code>的本质已经有一定的了解。但我们还需要知道<code>eventpoll</code> 的数据结构是什么样子？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;此外，就绪队列应该应使用什么数据结构？<code>eventpoll</code>应使用什么数据结构来管理通过<code>epoll_ctl</code>添加或删除的<code>socket</code>？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如下图所示，<code>eventpoll</code>包含了<code>lock、mtx、wq</code>（等待队列）与<code>rdlist</code>等成员，其中 <code>rdlist</code> 和<code>rbr</code>是我们所关心的。</p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/a74286896bfc4ef63e06209dbe8c3556311.jpg" alt="img"></p>
<p><em>epoll 原理示意图，图片来源：《深入理解Nginx：模块开发与架构解析(第二版)》，陶辉</em></p>
<h3 id="就绪列表的数据结构"><a href="#就绪列表的数据结构" class="headerlink" title="就绪列表的数据结构"></a>就绪列表的数据结构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;就绪列表引用着就绪的<code>socket</code>，所以它应能够快速的插入数据。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;程序可能随时调用 <code>epoll_ctl</code>添加监视 <code>socket</code>，也可能随时删除。当删除时，若该 <code>socket</code>已经存放在就绪列表中，它也应该被移除。所以<strong>就绪列表应是一种能够快速插入和删除的数据结构</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>双向链表就是这样一种数据结构，epoll 使用双向链表来实现就绪队列</strong>（对应上图的 <code>rdllist</code>）。</p>
<h3 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;既然 <code>epoll</code>将“维护监视队列”和“进程阻塞”分离，也意味着需要<strong>有个数据结构来保存监视的<code>socket</code>，至少要方便地添加和移除，还要便于搜索，以避免重复添加</strong>。红黑树是一种自平衡二叉查找树，搜索、插入和删除时间复杂度都是<code>O(log(N))</code>，效率较好，<strong><code>epoll</code>使用了红黑树作为索引结构</strong>（对应上图的<code>rbr</code>）。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：因为操作系统要兼顾多种功能，以及由更多需要保存的数据，<code>rdlist</code> 并非直接引用 <code>socket</code>，而是通过<code>epitem</code> 间接引用，红黑树的节点也是 <code>epitem</code> 对象。同样，文件系统也并非直接引用着<code>socket</code>。为方便理解，本文中省略了一些间接结构。</p>
<h2 id="九、小结"><a href="#九、小结" class="headerlink" title="九、小结"></a>九、小结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>epoll</code> 在 <code>select</code> 和<code>poll</code>的基础上引入了<code>eventpoll</code>作为中间层，使用了先进的数据结构，是一种高效的<strong>多路复用技术</strong>。这里也以表格形式简单对比一下 <code>select、poll 与 epoll</code>，结束此文。希望读者能有所收获。 </p>
<p><img src="//blog.com/2019/06/07/epoll的本质是什么/7159631494c57f93396e1876dfd56d499ba.jpg" alt="img"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/07/超级有用的15个mysqlbinlog命令/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/超级有用的15个mysqlbinlog命令/" itemprop="url">超级有用的15个mysqlbinlog命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T12:12:57+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/binlog/" itemprop="url" rel="index">
                    <span itemprop="name">binlog</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/binlog/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="超级有用的15个mysqlbinlog命令"><a href="#超级有用的15个mysqlbinlog命令" class="headerlink" title="超级有用的15个mysqlbinlog命令"></a>超级有用的15个mysqlbinlog命令</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="http://www.ttlsa.com/mysql/super-useful-mysqlbinlog-command/" target="_blank" rel="noopener">http://www.ttlsa.com/mysql/super-useful-mysqlbinlog-command/</a></p>
</blockquote>
<p><br></p>
<h2 id="获取当前二进制日志列表"><a href="#获取当前二进制日志列表" class="headerlink" title="获取当前二进制日志列表"></a>获取当前二进制日志列表</h2><p>在<code>mysql</code>中执行以下命令，即可查看二进制日志文件的列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW BINARY LOGS;</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| Log_name              | File_size |</span><br><span class="line">+--------------------------+------------+</span><br><span class="line">| mysqld-bin.000001 |     15740 |</span><br><span class="line">| mysqld-bin.000002 |       3319 |</span><br><span class="line">..</span><br><span class="line">..</span><br></pre></td></tr></table></figure>
<p>如果熊没有开启此功能，则会显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW BINARY LOGS;</span><br><span class="line">ERROR 1381 (HY000): You are not using binary logging</span><br></pre></td></tr></table></figure>
<p>二进制日志文件默认会存放在 <code>/var/lib/mysql</code>目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls -l /var/lib/mysql/</span></span><br><span class="line">-rw-rw----. 1 mysql mysql 15740 Aug 28 14:57 mysqld-bin.000001</span><br><span class="line">-rw-rw----. 1 mysql mysql  3319 Aug 28 14:57 mysqld-bin.000002</span><br><span class="line">..</span><br><span class="line">..</span><br></pre></td></tr></table></figure>
<h2 id="mysqlbinlog-默认行为"><a href="#mysqlbinlog-默认行为" class="headerlink" title="mysqlbinlog 默认行为"></a>mysqlbinlog 默认行为</h2><p>下面将以一种用户友好的格式显示指定的二进制日志文件（例如:<code>mysqld.000001</code>）的内容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p><code>mysqlbinlog</code>默认会显示为以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/; DELIMITER /*!*/;# at 4#170726 14:57:37 server id 1  end_log_pos 106   Start: binlog v 4, server v 5.1.73-log created 170726 14:57:37 at startup# Warning: this binlog is either in use or was not closed properly.</span><br><span class="line">ROLLBACK/*!*/;</span><br><span class="line">BINLOG &apos; IeZ4WQ8BAAAAZgAAAGoAAAABAAQANS4xLjczLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAh5nhZEzgNAAgAEgAEBAQEEgAAUwAEGggAAAAICAgC &apos;/*!*/;</span><br><span class="line"># at 106</span><br><span class="line">#170726 14:59:31 server id 1  end_log_pos 182   Query   thread_id=2     exec_time=0     error_code=0</span><br><span class="line">SET TIMESTAMP=1501095571/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=2/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=1, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=0/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;</span><br><span class="line">/*!\C latin1 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=8,@@session.collation_connection=8,@@session.collation_server=8/*!*/;</span><br><span class="line">..</span><br><span class="line">..</span><br><span class="line">..</span><br><span class="line"># at 14191</span><br><span class="line">#170726 15:20:38 server id 1  end_log_pos 14311         Query   thread_id=4     exec_time=0     error_code=0SET TIMESTAMP=1501096838/*!*/;</span><br><span class="line">insert into salary(name,dept) values(&apos;Ritu&apos;, &apos;Accounting&apos;)/*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*</span><br></pre></td></tr></table></figure>
<p>上面的命令将会显示出，在该系统上数据库发生的所有改变事件。</p>
<h2 id="获取特定数据库条目"><a href="#获取特定数据库条目" class="headerlink" title="获取特定数据库条目"></a>获取特定数据库条目</h2><p>默认情况下，<code>mysqlbinlog</code>会显示所有的内容，太过于杂乱。使用 <code>-d</code> 选项，可以指定一个数据库名称，将只显示在该数据库上所发生的事件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -d crm mysqld-bin.000001 &gt; crm-events.txt</span></span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>--database</code> 命令，效果相同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -database crm mysqld-bin.000001 &gt; crm-events.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="禁止恢复过程产生日志"><a href="#禁止恢复过程产生日志" class="headerlink" title="禁止恢复过程产生日志"></a>禁止恢复过程产生日志</h2><p>在使用二进制日志文件进行数据库恢复时，该过程中也会产生日志文件，就会进入一个循环状态，继续恢复该过程中的数据。因此，当使用<code>mysqlbinlog</code>命令时，要禁用二进制日志，请使用下面所示的<code>-D</code>选项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -D mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>--disable-log-bin</code>命令，效果相同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --<span class="built_in">disable</span>-log-bin mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>备注：在输出中，当指定<code>-D</code>选项时，将看到输出中的第二行。也就是<code>SQL_LOG_BIN=0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!32316 SET @OLD_SQL_LOG_BIN=@@SQL_LOG_BIN, SQL_LOG_BIN=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br></pre></td></tr></table></figure>
<p>当使用<code>-to-last-log</code>选项时，这个选项也会有所帮助。另外，请记住，该命令需要<code>root</code>权限来执行。</p>
<h2 id="在输出中控制base-64-BINLOG"><a href="#在输出中控制base-64-BINLOG" class="headerlink" title="在输出中控制base-64 BINLOG"></a>在输出中控制base-64 BINLOG</h2><p>使用<code>base64-output</code>选项，可以控制输出语句何时是输出<code>base64</code>编码的<code>BINLOG</code>语句。以下是<code>base64</code>输出设置的可能值：</p>
<ul>
<li>never</li>
<li>always</li>
<li>decode-rows</li>
<li>auto（默认）</li>
</ul>
<p><code>never</code>：当指定如下所示的“<code>never</code>”时，它将在输出中显示<code>base64</code>编码的<code>BINLOG</code>语句。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --base64-output=never mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>将不会有任何与下面类似的行，它具有<code>base64</code>编码的<code>BINLOG</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BINLOG &apos; IeZ4WQ8BAAAAZgAAABAAQANS4xLjczLWxvZwAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAh5nhZEzgNAAgAEgAEBAQEEgAAUwAEGggAAAAICAgC</span><br></pre></td></tr></table></figure>
<p><code>always</code>：当指定<code>“always”</code>选项时，只要有可能，它将只显示<code>BINLOG</code>项。因此，只有在专门调试一些问题时才使用它。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --base64-output=always mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>下面是<code>“always”</code>的输出，它只显示了<code>BINLOG</code>项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BINLOG &apos; IeZ4WQ8BAAAAZgAAAGoAAAABAAQANS4xLjczLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAh5nhZEzgNAAgAEgAEBAQEEgAAUwAEGggAAAAICAgC &apos;/*!*/;</span><br><span class="line"># at 106</span><br><span class="line">#170726 14:59:31 server id 1  end_log_pos 182</span><br><span class="line">BINLOG &apos; k+Z4WQIBAAAATAAAALYAAAAIAAIAAAAAAAAADAAAGgAAAEAAAAEAAAAAAAAAAAYDc3RkBAgACAAI AHRoZWdlZWtzdHVmZgBCRUdJTg== &apos;/*!*/;</span><br><span class="line"># at 182</span><br><span class="line">#170726 14:59:30 server id 1  end_log_pos 291</span><br><span class="line">BINLOG &apos; kuZ4WQIBAAAAbQAAACMBAAAAAAIAAAAAAAAADAAAGgAAAEAAAAEAAAAAAAAAAAYDc3RkBAgACAAI AHRoZWdlZWtzdHVmZgBJTlNFUlQgSU5UTyB0IFZBTFVFUygxLCAnYXBwbGUnLCBOVUxMKQ== &apos;/*!*/;</span><br><span class="line"># at 291</span><br><span class="line">#170726 14:59:30 server id 1  end_log_pos 422</span><br><span class="line">BINLOG &apos; kuZ4WQIBAAAAgwAAAKYBAAAAAAIAAAAAAAAADAAAGgAAAEAAAAEAAAAAAAAAAAYDc3RkBAgACAAI AHRoZWdlZWtzdHVmZgBVUERBVEUgdCBTRVQgbmFtZSA9ICdwZWFyJywgZGF0ZSA9ICcyMDA5LTAx LTAxJyBXSEVSRSBpZCA9IDE=</span><br></pre></td></tr></table></figure>
<p><code>decode-rows</code>：这个选项将把基于行的事件解码成一个<code>SQL</code>语句，特别是当指定<code>-verbose</code>选项时，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --base64-output=decode-rows --verbose mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p><code>auto</code>：这是默认选项。当没有指定任何<code>base64</code>解码选项时，它将使用<code>auto</code>。在这种情况下，<code>mysqlbinlog</code>将仅为某些事件类型打印<code>BINLOG</code>项，例如基于行的事件和格式描述事件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --base64-output=auto mysqld-bin.000001</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<h2 id="mysqlbinlog输出调试信息"><a href="#mysqlbinlog输出调试信息" class="headerlink" title="mysqlbinlog输出调试信息"></a>mysqlbinlog输出调试信息</h2><p>下面的调试选项，在完成处理给定的二进制日志文件之后，将检查文件打开和内存使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --debug-check mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>如下所示，在完成处理给定的二进制日志文件之后，下面的调试信息选项将显示额外的调试信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --debug-info mysqld-bin.000001 &gt; /tmp/m.di</span></span><br><span class="line">User time 0.00, System time 0.00</span><br><span class="line">Maximum resident set size 2848, Integral resident set size 0</span><br><span class="line">Non-physical pagefaults 863, Physical pagefaults 0, Swaps 0</span><br><span class="line">Blocks in 0 out 48, Messages in 0 out 0, Signals 0</span><br><span class="line">Voluntary context switches 1, Involuntary context switches 2</span><br></pre></td></tr></table></figure>
<h2 id="跳过前N个条目"><a href="#跳过前N个条目" class="headerlink" title="跳过前N个条目"></a>跳过前N个条目</h2><p>除了读取整个<code>mysql</code>二进制日志文件外，也可以通过指定偏移量来读取它的特定部分。可以使用<code>-o</code>选项。<code>o</code>代表偏移。</p>
<p>下面将跳过指定的<code>mysql bin</code>日志中的前10个条目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -o 10 mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>为了确保它正常工作，给偏移量提供一个巨大的数字，将看不到任何条目。下面的内容将从日志中跳过10,000个条目(事件)。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -o 10000 mysqld-bin.000001</span></span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/; .. ..</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of <span class="built_in">log</span> file</span></span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br></pre></td></tr></table></figure>
<p>在本例中，由于这个特定的日志文件没有<code>10,000</code>个条目，所以在输出中没有显示任何数据库事件。</p>
<h2 id="保存输出到文件"><a href="#保存输出到文件" class="headerlink" title="保存输出到文件"></a>保存输出到文件</h2><p>也可以使用简单的<a href="http://www.ttlsa.com/linux/" target="_blank" rel="noopener">Linux</a>重定向命令，将输出存储到一个文件中，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog mysqld-bin.000001 &gt; output.log</span></span><br></pre></td></tr></table></figure>
<p>或者也可以使用 <code>-r</code>（结果文件）选项，如下所示，将输出存储到一个文件中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -r output.log mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p> 备注：还可以使用 <code>-server-id</code>指定<code>mysql</code>服务器，确保是由给定服务器id的<code>mysql</code>服务器所生成的日志。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --server-id=1 -r output.log mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<h2 id="从一个特定位置提取条目"><a href="#从一个特定位置提取条目" class="headerlink" title="从一个特定位置提取条目"></a>从一个特定位置提取条目</h2><blockquote>
<p>-j, –start-position=#</p>
</blockquote>
<p>通常在<code>mysql</code>二进制日志文件中，你将看到如下所示的位置号。下面是<code>mysqlbinlog</code>的部分输出，你可以看到“<code>15028</code>”是一个位置编号。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#170726 15:38:14 server id 1  end_log_pos 15028         Query   thread_id=5     exec_time=0     error_code=0</span><br><span class="line">SET TIMESTAMP=1501097894/*!*/;</span><br><span class="line">insert into salary values(400,&apos;Nisha&apos;,&apos;Marketing&apos;,9500)</span><br><span class="line">/*!*/;</span><br><span class="line"># at 15028</span><br><span class="line">#170726 15:38:14 server id 1  end_log_pos 15146         Query   thread_id=5     exec_time=0     error_code=0</span><br><span class="line">SET TIMESTAMP=1501097894/*!*/;</span><br><span class="line">insert into salary values(500,&apos;Randy&apos;,&apos;Technology&apos;,6000)</span><br></pre></td></tr></table></figure>
<p>下面的命令将从位置编号为<code>15028</code>的二进制日志条目处开始读取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -j 15028 mysqld-bin.000001 &gt; from-15028.out</span></span><br></pre></td></tr></table></figure>
<p>当在命令行中指定多个二进制日志文件时，开始位置选项将仅应用于给定列表中的第一个二进制日志文件。还可以使用 <code>-H</code>选项来获得给定的二进制日志文件的十六进制转储，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -H mysqld-bin.000001 &gt; binlog-hex-dump.out</span></span><br></pre></td></tr></table></figure>
<h2 id="将条目截止到一个特定的位置"><a href="#将条目截止到一个特定的位置" class="headerlink" title="将条目截止到一个特定的位置"></a>将条目截止到一个特定的位置</h2><p>就像前面的例子一样，你也可以从<code>mysql</code>二进制日志中截止到一个特定位置的条目，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --stop-position=15028 mysqld-bin.000001 &gt; upto-15028.out</span></span><br></pre></td></tr></table></figure>
<p>上面的示例将在<code>15028</code>的位置上停止<code>binlog</code>。当在命令行中指定多个二进制日志文件时，停止位置将仅应用于给定列表中的最后一个二进制日志文件。</p>
<h2 id="刷新日志以清除Binlog输出"><a href="#刷新日志以清除Binlog输出" class="headerlink" title="刷新日志以清除Binlog输出"></a>刷新日志以清除Binlog输出</h2><p>当二进制日志文件没有被正确地关闭时，将在输出中看到一个警告消息，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog mysqld-bin.000001 &gt; output.out</span></span><br></pre></td></tr></table></figure>
<p>如下所示，报告中提示<code>binlog</code>文件没有正确地关闭。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># head output.log</span><br><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">.. ..</span><br><span class="line"># Warning: this binlog is either in use or was not closed properly.</span><br><span class="line">..</span><br><span class="line">.. .. BINLOG &apos; IeZ4WQ8BAAAAZgAAAGoAAAABAAQANS4xLjczLWxvZwAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAh5nhZEzgNAAgAEgAEBAQEEgAAUwAEGggAAAAICAgC</span><br></pre></td></tr></table></figure>
<p>当看到这个提示时，需要连接到<code>mysql</code>并刷新日志，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush logs;</span><br></pre></td></tr></table></figure>
<p>刷新日志之后，再次执行<code>mysqlbinlog</code>命令，将不会看到在<code>mysqlbinlog</code>输出中<code>binlog</code>未正确关闭的警告消息。</p>
<h2 id="在输出中只显示语句"><a href="#在输出中只显示语句" class="headerlink" title="在输出中只显示语句"></a>在输出中只显示语句</h2><p>默认情况下，正如在前面的示例输出中看到的一样，除了<code>SQL</code>语句之外，在<code>mysqlbinlog</code>输出中还会有一些附加信息。如果只想查看常规的<code>SQL</code>语句，而不需要其他内容，那么可以使用<code>-s</code>选项，如下所示。</p>
<p>也可以使用<code>--short-form</code> 选项，效果相同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -s mysqld-bin.000001</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --short-form mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>下面是上述命令的部分输出。在这里，它将只显示来自给定二进制日志文件的<code>SQL</code>语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET TIMESTAMP=1501096106/*!*/;</span><br><span class="line">insert into employee values(400,&apos;Nisha&apos;,&apos;Marketing&apos;,9500)/*!*/;</span><br><span class="line">SET TIMESTAMP=1501096106/*!*/;</span><br><span class="line">insert into employee values(500,&apos;Randy&apos;,&apos;Technology&apos;,6000)</span><br><span class="line">..</span><br><span class="line">..</span><br></pre></td></tr></table></figure>
<p>不会显示像下面这样的条目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># at 1201</span><br><span class="line">#170726 15:08:26 server id 1  end_log_pos 1329  Query   thread_id=3     exec_time=0     error_code=0</span><br></pre></td></tr></table></figure>
<h2 id="查看特定开始时间的条目"><a href="#查看特定开始时间的条目" class="headerlink" title="查看特定开始时间的条目"></a>查看特定开始时间的条目</h2><p>下面将只提取从指定时间开始的条目。在此之前的任何条目都将被忽略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqlbinlog --start-datetime=&quot;2017-08-16 10:00:00&quot; mysqld-bin.000001</span><br></pre></td></tr></table></figure>
<p>当你想要从一个二进制文件中提取数据时，这是非常有用的，因为你希望使用它来恢复或重构在某个时间段内发生的某些数据库活动。时间戳的格式可以是<code>MySQL</code>服务器所理解的<code>DATETIME</code>和<code>timestamp</code>中的任何类型。</p>
<h2 id="查看特定结束时间的条目"><a href="#查看特定结束时间的条目" class="headerlink" title="查看特定结束时间的条目"></a>查看特定结束时间的条目</h2><p>与前面的开始时间示例一样，这里也可以指定结束时间，如下所示。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --stop-datetime=<span class="string">"2017-08-16 15:00:00"</span> mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>上面的命令将读取到给定结束时间的条目。任何来自于超过给定结束时间的<code>mysql</code>二进制日志文件的条目都不会被处理。</p>
<h2 id="从远程服务器获取二进制日志"><a href="#从远程服务器获取二进制日志" class="headerlink" title="从远程服务器获取二进制日志"></a>从远程服务器获取二进制日志</h2><p>在本地机器上，还可以读取位于远程服务器上的<code>mysql</code>二进制日志文件。为此，需要指定远程服务器的<code>ip</code>地址、用户名和密码，如下所示。</p>
<p>此处使用<code>-R</code>选项。<code>-R</code>选项与<code>-read-from-remote-server</code>相同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -R -h 192.168.101.2 -p mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>在上面命令中：</p>
<ul>
<li><code>-R</code> 选项指示<code>mysqlbinlog</code>命令从远程服务器读取日志文件</li>
<li><code>-h</code> 指定远程服务器的ip地址</li>
<li><code>-p</code>将提示输入密码。默认情况下，它将使用“root”作为用户名。也可以使用<code>-u</code>选项指定用户名。</li>
<li><code>mysqld-bin.000001</code> 这是在这里读到的远程服务器的二进制日志文件的名称。</li>
</ul>
<p>下面命令与上面的命令完全相同：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog --<span class="built_in">read</span>-from-remote-server --host=192.168.101.2 -p mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<p>如果只指定<code>-h</code> 选项，将会得到下面的错误消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -h 192.168.101.2 mysqld-bin.000001</span></span><br><span class="line">mysqlbinlog: File 'mysqld-bin.000001' not found (Errcode: 2)</span><br></pre></td></tr></table></figure>
<p>当你在远程数据库上没有足够的特权时，将得到以下“不允许连接”错误消息。在这种情况下，确保在远程数据库上为本地客户机授予适当的特权。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -R --host=192.168.101.2 mysqld-bin.000001</span></span><br><span class="line">ERROR: Failed on connect: Host '216.172.166.27' is not allowed to connect</span><br><span class="line">to this MySQL server</span><br></pre></td></tr></table></figure>
<p>如果没有使用<code>-p</code>选项指定正确的密码，那么将得到以下“访问拒绝”错误消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -R --host=192.168.101.2 mysqld-bin.000001</span></span><br><span class="line">ERROR: Failed on connect: Access denied for user 'root'@'216.172.166.27' (using password: YES)</span><br></pre></td></tr></table></figure>
<p>下面的示例显示，还可以使用<code>-u</code>选项指定<code>mysqlbinlog</code>应该用于连接到远程<code>MySQL</code>数据库的用户名。请注意，这个用户是<code>mysql</code>用户（不是<code>Linux</code>服务器用户）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysqlbinlog -R --host=192.168.101.2 -u root -p mysqld-bin.000001</span></span><br></pre></td></tr></table></figure>
<h2 id="row-format下如何获取SQL语句"><a href="#row-format下如何获取SQL语句" class="headerlink" title="row format下如何获取SQL语句"></a>row format下如何获取SQL语句</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=decode-rows /usr/local/mysql/data/mysql-bin.000002</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=1</span><br><span class="line">###   @2=&apos;商品&apos;</span><br><span class="line">###   @3=1</span><br><span class="line">###   @4=26</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=2</span><br><span class="line">###   @2=&apos;化妆品&apos;</span><br><span class="line">###   @3=2</span><br><span class="line">###   @4=7</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=3</span><br><span class="line">###   @2=&apos;食品&apos;</span><br><span class="line">###   @3=8</span><br><span class="line">###   @4=9</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=4</span><br><span class="line">###   @2=&apos;酒&apos;</span><br><span class="line">###   @3=10</span><br><span class="line">###   @4=15</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=5</span><br><span class="line">###   @2=&apos;服装&apos;</span><br><span class="line">###   @3=16</span><br><span class="line">###   @4=17</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=6</span><br><span class="line">###   @2=&apos;家电&apos;</span><br><span class="line">###   @3=18</span><br><span class="line">###   @4=23</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=7</span><br><span class="line">###   @2=&apos;鞋帽&apos;</span><br><span class="line">###   @3=24</span><br><span class="line">###   @4=25</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=8</span><br><span class="line">###   @2=&apos;面霜&apos;</span><br><span class="line">###   @3=3</span><br><span class="line">###   @4=4</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=9</span><br><span class="line">###   @2=&apos;面膜&apos;</span><br><span class="line">###   @3=5</span><br><span class="line">###   @4=6</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=10</span><br><span class="line">###   @2=&apos;白酒&apos;</span><br><span class="line">###   @3=11</span><br><span class="line">###   @4=12</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=11</span><br><span class="line">###   @2=&apos;红酒&apos;</span><br><span class="line">###   @3=13</span><br><span class="line">###   @4=14</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=12</span><br><span class="line">###   @2=&apos;冰箱&apos;</span><br><span class="line">###   @3=19</span><br><span class="line">###   @4=20</span><br><span class="line">### INSERT INTO `test`.`nested_category`</span><br><span class="line">### SET</span><br><span class="line">###   @1=13</span><br><span class="line">###   @2=&apos;空调&apos;</span><br><span class="line">###   @3=21</span><br><span class="line">###   @4=22</span><br></pre></td></tr></table></figure>
<h2 id="binlog-rows-query-log-events-row模式下记录sql原始语句"><a href="#binlog-rows-query-log-events-row模式下记录sql原始语句" class="headerlink" title="binlog_rows_query_log_events row模式下记录sql原始语句"></a>binlog_rows_query_log_events row模式下记录sql原始语句</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;  set global binlog_rows_query_log_events=on;</span><br><span class="line">mysql&gt; show binlog events in &quot;mysql-bin.000002&quot;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global binlog_rows_query_log_events=on;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name         | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |       573 |</span><br><span class="line">| mysql-bin.000002 |      2021 |</span><br><span class="line">| mysql-bin.000003 |       154 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &quot;mysql-bin.000002&quot;;</span><br><span class="line">+------------------+------+----------------+-----------+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info                                                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">+------------------+------+----------------+-----------+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000002 |    4 | Format_desc    |         1 |         123 | Server ver: 5.7.18-log, Binlog ver: 4                                                                                                                                                                                                                                                                                                                                    |</span><br><span class="line">| mysql-bin.000002 |  123 | Previous_gtids |         1 |         154 |                                                                                                                                                                                                                                                                                                                                                                          |</span><br><span class="line">| mysql-bin.000002 |  154 | Anonymous_Gtid |         1 |         219 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 |  219 | Query          |         1 |         313 | create database test                                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 |  313 | Anonymous_Gtid |         1 |         378 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 |  378 | Query          |         1 |         800 | use `test`; CREATE TABLE `nested_category` (   `category_id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;自增ID&apos;,   `name` varchar(18) COLLATE utf8_unicode_ci NOT NULL DEFAULT &apos;&apos; COMMENT &apos;名称&apos;,   `lft` int(4) NOT NULL,   `rgt` int(4) NOT NULL,   KEY `category_id` (`category_id`) ) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci     |</span><br><span class="line">| mysql-bin.000002 |  800 | Anonymous_Gtid |         1 |         865 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 |  865 | Query          |         1 |         937 | BEGIN                                                                                                                                                                                                                                                                                                                                                                    |</span><br><span class="line">| mysql-bin.000002 |  937 | Rows_query     |         1 |        1252 | # INSERT INTO `nested_category` VALUES </span><br><span class="line">(1,&apos;商品&apos;,1,26),</span><br><span class="line">(2,&apos;化妆品&apos;,2,7),</span><br><span class="line">(3,&apos;食品&apos;,8,9),</span><br><span class="line">(4,&apos;酒&apos;,10,15),</span><br><span class="line">(5,&apos;服装&apos;,16,17),</span><br><span class="line">(6,&apos;家电&apos;,18,23),</span><br><span class="line">(7,&apos;鞋帽&apos;,24,25),</span><br><span class="line">(8,&apos;面霜&apos;,3,4),</span><br><span class="line">(9,&apos;面膜&apos;,5,6),</span><br><span class="line">(10,&apos;白酒&apos;,11,12),</span><br><span class="line">(11,&apos;红酒&apos;,13,14),</span><br><span class="line">(12,&apos;冰箱&apos;,19,20),</span><br><span class="line">(13,&apos;空调&apos;,21,22)                                                                                              |</span><br><span class="line">| mysql-bin.000002 | 1252 | Table_map      |         1 |        1315 | table_id: 219 (test.nested_category)                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 | 1315 | Write_rows     |         1 |        1610 | table_id: 219 flags: STMT_END_F                                                                                                                                                                                                                                                                                                                                          |</span><br><span class="line">| mysql-bin.000002 | 1610 | Xid            |         1 |        1641 | COMMIT /* xid=15 */                                                                                                                                                                                                                                                                                                                                                      |</span><br><span class="line">| mysql-bin.000002 | 1641 | Anonymous_Gtid |         1 |        1706 | SET @@SESSION.GTID_NEXT= &apos;ANONYMOUS&apos;                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 | 1706 | Query          |         1 |        1778 | BEGIN                                                                                                                                                                                                                                                                                                                                                                    |</span><br><span class="line">| mysql-bin.000002 | 1778 | Rows_query     |         1 |        1849 | # delete from nested_category where category_id=1                                                                                                                                                                                                                                                                                                                        |</span><br><span class="line">| mysql-bin.000002 | 1849 | Table_map      |         1 |        1912 | table_id: 219 (test.nested_category)                                                                                                                                                                                                                                                                                                                                     |</span><br><span class="line">| mysql-bin.000002 | 1912 | Delete_rows    |         1 |        1967 | table_id: 219 flags: STMT_END_F                                                                                                                                                                                                                                                                                                                                          |</span><br><span class="line">| mysql-bin.000002 | 1967 | Xid            |         1 |        1998 | COMMIT /* xid=36 */                                                                                                                                                                                                                                                                                                                                                      |</span><br><span class="line">| mysql-bin.000002 | 1998 | Stop           |         1 |        2021 |                                                                                                                                                                                                                                                                                                                                                                          |</span><br><span class="line">+------------------+------+----------------+-----------+-------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">19 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/04/PHP通过_call模拟多继承/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/04/PHP通过_call模拟多继承/" itemprop="url">PHP通过_call模拟多继承</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-04T12:12:57+08:00">
                2019-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP通过-call模拟多继承"><a href="#PHP通过-call模拟多继承" class="headerlink" title="PHP通过_call模拟多继承"></a>PHP通过_call模拟多继承</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">One</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">method_1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'11&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">method_2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'22&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Two</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">method_3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'33&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">method_4</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'44&lt;br/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticDemo</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $Class = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $class = array<span class="params">()</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Class = $class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;Class <span class="keyword">as</span> $v)&#123;</span><br><span class="line">            <span class="keyword">if</span> (is_callable(<span class="keyword">array</span>($v, $name))) &#123; <span class="comment">//method_exists</span></span><br><span class="line">                <span class="keyword">return</span> call_user_func_array(<span class="keyword">array</span>($v, $name), $arguments);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, $name), $arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> StaticDemo(<span class="keyword">array</span>(<span class="keyword">new</span> One(), <span class="keyword">new</span> Two()));</span><br><span class="line">$obj-&gt;method_1();</span><br><span class="line">$obj-&gt;method_3();</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/04/PHPSTORM中使用sftp/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/04/PHPSTORM中使用sftp/" itemprop="url">PHPSTORM中使用sftp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-04T12:12:57+08:00">
                2019-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/sftp/" itemprop="url" rel="index">
                    <span itemprop="name">sftp</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHPSTORM中使用sftp"><a href="#PHPSTORM中使用sftp" class="headerlink" title="PHPSTORM中使用sftp"></a>PHPSTORM中使用sftp</h1><h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/新增.png" alt=""></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/配置1.png" alt=""></p>
<p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/配置2.png" alt=""></p>
<p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/配置3.png" alt=""></p>
<p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/配置4.png" alt=""></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="//blog.com/2019/06/04/PHPSTORM中使用sftp/测试.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/49/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/49/">49</a><span class="page-number current">50</span><a class="page-number" href="/page/51/">51</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/51/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
