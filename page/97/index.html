<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/97/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/97/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/MySQL字符集和校对规则（Collation）/" itemprop="url">MySQL字符集和校对规则（Collation）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySql字符集/" itemprop="url" rel="index">
                    <span itemprop="name">MySql字符集</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL字符集和校对规则（Collation）"><a href="#MySQL字符集和校对规则（Collation）" class="headerlink" title="MySQL字符集和校对规则（Collation）"></a>MySQL字符集和校对规则（Collation）</h1><blockquote>
<p>原文地址：<a href="https://yq.aliyun.com/articles/283374" target="_blank" rel="noopener">https://yq.aliyun.com/articles/283374</a></p>
</blockquote>
<h2 id="一、字符集-Character-set"><a href="#一、字符集-Character-set" class="headerlink" title="一、字符集(Character set)"></a>一、字符集(Character set)</h2><p>　　是多个字符(英文字符，汉字字符，或者其他国家语言字符)的集合，字符集种类较多，<strong>每个字符集包含的字符个数不同</strong>。</p>
<p>特点：</p>
<p>　　①<strong>字符编码方式是用一个或多个字节表示字符集中的一个字符</strong></p>
<p>　　②每种字符集都有自己特有的编码方式，因此<strong>同一个字符，在不同字符集的编码方式下，会产生不同的二进制</strong></p>
<p>常见字符集：</p>
<blockquote>
<p>　　ASCII字符集：基于罗马字母表的一套字符集，它采用1个字节的低7位表示字符，高位始终为0。</p>
<p>​    GBK2312：主要包括简体中文字符及常用符号，对于中文字符采用双字节编码的格式，也就是说一个汉字字符在存储占两个字节。</p>
<p>　　LATIN1字符集：相对于ASCII字符集做了扩展，仍然使用一个字节表示字符，但启用了高位，扩展了字符集的表示范围。</p>
<p>　   GBK：包括有中、日、韩字符的大字符集，GB2312也是GBK的一个子集，就是说GB2312中的所有字符，GBK中全有，在这种情况下，我们也会将GBK称为GB2312的超集，GBK也是双字节编码的格式，将子集中的字符转换成超集中保存不会丢失信息（出现乱码）；但反之则不一定。字符有一字节编码和两字节编码方式。</p>
<p>　　UTF8字符集：Unicode字符集的一种，是计算机科学领域里的一项业界标准，支持了所有国家的文字字符，采用1-4个字节表示字符。它对于英文字符集使用一个字节编码，而对于多字节符（如中文）则使用3个字节编码，UTF-8能够支持大部分常见的字符，包括西、中、日、韩、法、俄等各种文字。</p>
<p>​    UTF-8MB4：它是UTF-8的超集，是MySQL5.5版本才引进的，其引进是为了处理像emoji这类表情字符，一个字符使用4个字节编码，能支持的字符最广，但是相应占用的空间也最大。</p>
</blockquote>
<h3 id="1、MySQL与字符集"><a href="#1、MySQL与字符集" class="headerlink" title="1、MySQL与字符集"></a>1、MySQL与字符集</h3><p>　　只要涉及到文字的地方，就会存在字符集和编码方式。MySQL系统变量值：</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/img_5507530cc5e8e6983a0911ef4a319c1d.png" alt="img"> </p>
<h3 id="2、正确使用字符集"><a href="#2、正确使用字符集" class="headerlink" title="2、正确使用字符集"></a>2、正确使用字符集</h3><p>　　数据库服务端的字符集具体要看存储什么字符</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/img_bc04697fcf94310a23467a12a88e8f9b.png" alt="img"></p>
<p>以上这些参数如何起作用：</p>
<h4 id="1-库、表、列字符集的由来"><a href="#1-库、表、列字符集的由来" class="headerlink" title="1.库、表、列字符集的由来"></a>1.库、表、列字符集的由来</h4><p>　　①   建库时，若未明确指定字符集，则采用character_set_server指定的字符集。</p>
<p>　　②   建表时，若未明确指定字符集，则采用当前库所采用的字符集。</p>
<p>　　③   新增时，修改表字段时，若未明确指定字符集，则采用当前表所采用的字符集。</p>
<h4 id="2-更新、查询涉及到得字符集变量"><a href="#2-更新、查询涉及到得字符集变量" class="headerlink" title="2.更新、查询涉及到得字符集变量"></a>2.更新、查询涉及到得字符集变量</h4><p>　　更新流程字符集转换过程：character_set_client–&gt;character_set_connection–&gt;表字符集。</p>
<p>　　查询流程字符集转换过程：表字符集–&gt;character_set_result</p>
<h4 id="3-character-set-database"><a href="#3-character-set-database" class="headerlink" title="3.character_set_database"></a>3.character_set_database</h4><p>　　当前默认数据库的字符集，比如执行use xxx后，当前数据库变为xxx，若xxx的字符集为utf8，那么此变量值就变为utf8(供系统设置，无需人工设置)。</p>
<h3 id="3、MySQL客户端与字符集"><a href="#3、MySQL客户端与字符集" class="headerlink" title="3、MySQL客户端与字符集"></a>3、MySQL客户端与字符集</h3><h4 id="1-对于输入来说："><a href="#1-对于输入来说：" class="headerlink" title="1.对于输入来说："></a>1.对于输入来说：</h4><p>　　<strong>客户端使用的字符集必须通过character_set_client、character_set_connection体现出来</strong>：</p>
<p>　　　　①   在客户端对数据进行编码（Linux：utf8、windows：gbk）</p>
<p>　　　　②   MySQL接到SQL语句后(比如insert)，发现有字符，询问客户端通过什么方式对字符编码：客户端通过character_set_client参数告知MySQL客户端的编码方式(所以此参数需要正确反映客户端对应的编码)</p>
<p>　　　　③   当MySQL发现客户端的client所传输的字符集与自己的connection不一样时，会将client的字符集转换为connection的字符集</p>
<p>　　　　④   MySQL将转换后的编码存储到MySQL表的列上，在存储的时候再判断编码是否与内部存储字符集（按照优先级判断字符集类型）上的编码一致，如果不一致需要再次转换</p>
<h4 id="2-对于查询来说："><a href="#2-对于查询来说：" class="headerlink" title="2.对于查询来说："></a>2.对于查询来说：</h4><p>　　<strong>客户端使用的字符集必须通过character_set_results来体现，服务器询问客户端字符集，通过character_set_results将结果转换为与客户端相同的字符集传递给客户端。(character_set_results默认等于character_set_client)</strong></p>
<h3 id="4、MySQL字符编码转换原理："><a href="#4、MySQL字符编码转换原理：" class="headerlink" title="4、MySQL字符编码转换原理："></a>4、MySQL字符编码转换原理：</h3><p>　　问：若character_set_client为UTF8，而character_set_database为GBK，则会出现需要进行编码转换的情况，字符集转换的原理是什么？</p>
<p>　　答：假设gbk字符集的字符串“你好”，需要转为utf8字符集存储，实际就是对于“你好”字符串中的每个汉字去utf8编码表里面查询对应的二进制，然后存储。</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/img_c76fb58fc8d0653a94e8e69384d4447d.png" alt="img"> </p>
<p>图解字符集转换过程：</p>
<p>　　①  MySQL Server收到请求时将请求数据从character_set_client转换为character_set_connection;</p>
<p>　　②  进行内部操作前将请求数据从character_set_connection转换为内部操作字符集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">确定步骤：</span><br><span class="line"></span><br><span class="line">-- 使用每个数据字段的CHARACTER SET设定值；</span><br><span class="line"></span><br><span class="line">-- 若上述值不存在，则使用对应数据表的DEFAULT CHARACTER SET设定值；</span><br><span class="line"></span><br><span class="line">-- 若上述值不存在，则使用对应数据库的DEFAULT CHARACTER SET设定值；</span><br><span class="line"></span><br><span class="line">-- 若上述值不存在，则使用character_set_server设定值；</span><br></pre></td></tr></table></figure>
<p>　　③  将操作结果从内部操作字符集转换为character_set_results。</p>
<h3 id="5、字符集常见处理操作"><a href="#5、字符集常见处理操作" class="headerlink" title="5、字符集常见处理操作"></a>5、字符集常见处理操作</h3><blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/alter-table.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/alter-table.html</a></p>
</blockquote>
<h4 id="1-查看字符集编码设"><a href="#1-查看字符集编码设" class="headerlink" title="1.查看字符集编码设　"></a>1.查看字符集编码设　</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%character%&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="2-设置字符集编码"><a href="#2-设置字符集编码" class="headerlink" title="2.设置字符集编码"></a>2.设置字符集编码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set names &apos;utf8&apos;;</span><br></pre></td></tr></table></figure>
<p>相当于同时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set character_set_client = utf8;</span><br><span class="line"></span><br><span class="line">set character_set_results = utf8;</span><br><span class="line"></span><br><span class="line">set character_set_connection = utf8;</span><br></pre></td></tr></table></figure>
<h4 id="3-修改数据库字符集"><a href="#3-修改数据库字符集" class="headerlink" title="3.修改数据库字符集"></a>3.修改数据库字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter database database_name character set xxx;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>只修改库的字符集，影响后续创建的表的默认定义；对于已创建的表的字符集不受影响</strong>。（一般在数据库实现字符集即可，表和列都默认采用数据库的字符集）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>使用convert to character set charset_name,如果转换后的数据类型不能存储全部数据，会发生数据类型变化。</strong></p>
<blockquote>
<p>​    比如text最多可以存储65535个字节，latin1字符集下，一个字符占用一个字节，所以也就是65535个字符，转换为utf8，一个字符至多可以占用3个字节，所以，最坏的情况，转换后就需要65535*3个字节，超出text容量，Mysql会自动将数据类型转为mediumtext</p>
</blockquote>
<h4 id="4-修改表的字符集"><a href="#4-修改表的字符集" class="headerlink" title="4.修改表的字符集"></a>4.修改表的字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table table_name character set xxx；</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>只修改表的字符集，影响后续该表新增列的默认定义，已有列的字符集不受影响</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table table_name convert to character set xxx;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>同时修改表字符集和已有列字符集，并将已有数据进行字符集编码转换</strong>。</p>
<h4 id="5-修改列字符集"><a href="#5-修改列字符集" class="headerlink" title="5.修改列字符集"></a>5.修改列字符集</h4><p>格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name MODIFY</span><br><span class="line"></span><br><span class="line">column_name &#123;CHAR | VARCHAR | TEXT&#125; (column_length)</span><br><span class="line"></span><br><span class="line">   [CHARACTER SET charset_name]</span><br><span class="line"></span><br><span class="line">   [COLLATE collation_name]</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table table_name modify col_name varchar(col_length) character set xxx;</span><br></pre></td></tr></table></figure>
<h3 id="6、字符集的正确实践："><a href="#6、字符集的正确实践：" class="headerlink" title="6、字符集的正确实践："></a>6、字符集的正确实践：</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL软件工具本身是没有字符集的，主要是因为工具所在的OS的字符集（Windows：gbk、Linux：utf8），所以字符集的正确实践非常重要：</p>
<p>　　1. <strong>对于insert来说，character_set_client、character_set_connection相同，而且正确反映客户端使用的字符集</strong></p>
<p>　　2. <strong>对于select来说，character_set_results正确反映客户端字符集</strong></p>
<p>　　3. 数据库字符集取决于我们要存储的字符类型</p>
<p>　　4. 字符集转换最多发生一次，这就<strong>要求character_set_client、character_set_connection相同</strong></p>
<p>　　5. 所有的字符集转换都发生在数据库端</p>
<p>综述：</p>
<p>　　1、建立数据库的时候注意字符集（gbk、utf8）；</p>
<p>　　2、连接数据库以后，无论是执行dml还是select，只要涉及到varchar、char列，就需要设置正确的字符集参数。</p>
<h2 id="二、校对规则collation校对"><a href="#二、校对规则collation校对" class="headerlink" title="二、校对规则collation校对"></a>二、校对规则collation校对</h2><blockquote>
<p><a href="https://dev.mysql.com/doc/refman/5.1/zh/charset.html#charset-connection" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.1/zh/charset.html#charset-connection</a></p>
</blockquote>
<p>校对规则(collation)：</p>
<p>　　<strong>是在字符集内用于字符比较和排序的一套规则，比如有的规则区分大小写，有的则无视</strong>。</p>
<p>​    <strong>校对规则是在字符集内用于比较字符的一套规则,可以控制 select 查询时where 条件大小写是否敏感的规则</strong>.如字段 col 在表中的值为 ‘abc’,’ABC’,’AbC’ 在不同的校对规则下,where col=’ABC’会有不同的结果。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>列&gt;表&gt;数据库&gt;服务器,  缺省情况下会继承当前字符集所对应默认的字符集校对规则，对于想要在查询的时候区分大小写情况而使用校对规则的话,最好创建数据库和表的时候 就指定好期望的字符校对规则</strong></p>
<blockquote>
<p> mysql&gt; show collation;  #查看数据库支持的所有校对规则</p>
</blockquote>
<blockquote>
<p> mysql&gt; show variables like ‘collation_%’;  #查看当前字符集和校对规则设置</p>
</blockquote>
<p><img src="//blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/img_cf1a3e376d04c460d295749c7d38c242.png" alt="img"></p>
<p>校对规则特征：</p>
<p>　　①<strong>两个不同的字符集不能有相同的校对规则</strong>；</p>
<p>　　②<strong>每个字符集有一个默认校对规则</strong>；</p>
<p>　　③<strong>存在校对规则命名约定</strong>：以其相关的字符集名开始，中间包括一个语言名，并且以_ci（大小写不敏感）、_cs（大小写敏感）或_bin（二元）结束。</p>
<blockquote>
<p>_ci：全称为case insensitive，这表示大小写不敏感的规则<br>_cs:全称为case sensitive，这表示大小写敏感的规则<br>_bin :即binary，表示这是一个二元校对规则，话说二元规则也是一定是大小写敏感规则</p>
</blockquote>
<p>提示:</p>
<p>​    <strong>官方文档上说是有 cs(大小写敏感) 但是show collation like ‘utf8%’; 并没有cs结尾的校对规则</strong>。</p>
<p>注意：</p>
<p>　　<strong>系统使用utf8字符集，若使用utf8_bin校对规则执行SQL查询时区分大小写，使用utf8_general_ci不区分大小写(默认的utf8字符集对应的校对规则是utf8_general_ci)</strong>。</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create table t2(</span><br><span class="line">	id int,name varchar(20)</span><br><span class="line">) character set=gbk collate=gbk_bin;    #t2建表指定校对规则（区分大小写）</span><br></pre></td></tr></table></figure>
<p><img src="//blog.com/2019/04/20/MySQL字符集和校对规则（Collation）/img_b35775635ce88400e6a46efb84c43452.png" alt="img"></p>
<h3 id="如何使用字符校对规则"><a href="#如何使用字符校对规则" class="headerlink" title="如何使用字符校对规则"></a>如何使用字符校对规则</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL 提供四种默认级别的字符集和校验规则:服务器级、数据库级、表级,和连接级,一般字段级别的不常用。</p>
<h4 id="2-1-服务器级"><a href="#2-1-服务器级" class="headerlink" title="2.1 服务器级"></a>2.1 服务器级</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL服务器有一个服务器字符集和一个服务器校对规则,collationserver的默认字符集是在编译mysql的时候编译好的,比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; ./configure --with-charset=utf8</span><br><span class="line"></span><br><span class="line">或者：</span><br><span class="line"></span><br><span class="line">shell&gt; ./configure --with-charset=utf8  --with-collation=utf8generalci</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如要要修改默认的字符校对规则,我们可以通过以下几种方式:</p>
<p>a . 在/etc/my.cnf 的[mysqld]中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collationserver = utf8bin</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;修改之后必须重启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@rac2 [(none)]&gt; show variables like &apos;collation%&apos;;</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| Variablename | Value |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| collationconnection | utf8generalci |</span><br><span class="line"></span><br><span class="line">| collationdatabase | utf8bin |</span><br><span class="line"></span><br><span class="line">| collationserver | utf8bin |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br></pre></td></tr></table></figure>
<p>b. 通过mysqld 命令行添加 –character-set-server=utf8 –collation-server=utf8generalci</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/mysqld --defaults-file=/etc/my.cnf --basedir=/usr --datadir=/home/mysql/data3306/data --log-error=/home/mysql/data3306/log/master-error.log --pid-file=/home/mysql/data3306/data/rac3.pid --socket=/tmp/mysql.sock --port=3306 --character-set-server=utf8 --collation-server=utf8generalci &amp;</span><br></pre></td></tr></table></figure>
<p>注意：这篇文章描述的并不准确</p>
<p><a href="https://dev.mysql.com/doc/refman/5.1/zh/charset.html#charset-column" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.1/zh/charset.html#charset-column</a></p>
<p>通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysqld --default-character-set=utf8  --default-collation=utf8generalci</span><br></pre></td></tr></table></figure>
<p>方式启动会报错</p>
<blockquote>
<p>140430 9:34:56 InnoDB: 1.1.8 started; log sequence number 1628178</p>
<p>140430 9:34:56 [ERROR] /usr/sbin/mysqld: unknown variable ‘default-character-set=utf8’</p>
<p>140430 9:34:56 [ERROR] Aborting</p>
</blockquote>
<p>服务器级别字符集校对规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">root@rac2 [(none)]&gt; show variables like &apos;collation%&apos;;</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| Variablename | Value |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| collationconnection | utf8generalci |</span><br><span class="line"></span><br><span class="line">| collationdatabase | utf8bin |</span><br><span class="line"></span><br><span class="line">| collationserver | utf8_bin |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; create table t1(col varchar(5)) engine=innodb ;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.10 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; insert into t1 values(&apos;abc&apos;),(&apos;ABC&apos;),(&apos;AbC&apos;);</span><br><span class="line"></span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Records: 3 Duplicates: 0 Warnings: 0</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; select * from t1 where col=&apos;ABC&apos;;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| ABC |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; create table t2(col varchar(5)) engine=innodb default charset=utf8;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; insert into t2 values(&apos;abc&apos;),(&apos;ABC&apos;),(&apos;AbC&apos;); </span><br><span class="line"></span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Records: 3 Duplicates: 0 Warnings: 0</span><br><span class="line"></span><br><span class="line">root@rac2 [dba]&gt; select * from t2 where col=&apos;ABC&apos;;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| abc |</span><br><span class="line"></span><br><span class="line">| ABC |</span><br><span class="line"></span><br><span class="line">| AbC |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-数据库级别字符校对规则"><a href="#2-2-数据库级别字符校对规则" class="headerlink" title="2.2 数据库级别字符校对规则"></a>2.2 数据库级别字符校对规则</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;每一个数据库有一个数据库字符集和一个数据库校对规则。CREATE DATABASE和ALTER DATABASE语句有一个可选的子句来指定数据库字符集和校对规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE dbname</span><br><span class="line"></span><br><span class="line">[[DEFAULT] CHARACTER SET charsetname]</span><br><span class="line"></span><br><span class="line">[[DEFAULT] COLLATE collation_name]</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>通常如果创建数据库的时候不指定db的字符集和校对规则,则使用服务器级别默认的校对规则</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如何修改数据库级别的字符校对规则:</p>
<ol>
<li><p>通过在创建数据库时指定 collationdatabase 字符集。</p>
</li>
<li><p>通过ALTER DATABASE dbname [[DEFAULT] CHARACTER SET charsetname] [[DEFAULT] COLLATE collationname]</p>
</li>
</ol>
<p><strong>注意 在my.cnf 中的[mysql]或者[mysqld]中配置</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">collationdatabase=utf8_bin</span><br></pre></td></tr></table></figure>
<p>会分别报错：</p>
<blockquote>
<p>mysql: unknown variable ‘collationdatabase=utf8_bin’ </p>
<p>140430 13:56:19 [ERROR] /usr/sbin/mysqld: unknown variable ‘collation_database=utf8_bin’</p>
<p>140430 13:56:19 [ERROR] Aborting</p>
</blockquote>
<p>例子 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">root@rac2 [(none)]&gt; show variables like &apos;collation%&apos;;</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| Variablename | Value |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">| collationconnection | utf8generalci |</span><br><span class="line"></span><br><span class="line">| collationdatabase | utf8bin |</span><br><span class="line"></span><br><span class="line">| collationserver | utf8_bin |</span><br><span class="line"></span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [(none)]&gt; create database dba01;</span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [(none)]&gt; use dba01</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">root@rac2 [dba01]&gt; CREATE TABLE t1(col varchar(5)) ;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [dba01]&gt; insert into t1 values(&apos;abc&apos;),(&apos;ABC&apos;),(&apos;AbC&apos;);</span><br><span class="line"></span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Records: 3 Duplicates: 0 Warnings: 0</span><br><span class="line"></span><br><span class="line">root@rac2 [dba01]&gt; select * from t1;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| abc |</span><br><span class="line"></span><br><span class="line">| ABC |</span><br><span class="line"></span><br><span class="line">| AbC |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@rac2 [dba01]&gt; select * from t1 where col=&apos;abc&apos;;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| abc |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><strong>MySQL这样选择数据库字符集和数据库校对规则</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果指定了CHARACTER SET X和COLLATE Y,那么采用字符集X和校对规则Y。</span><br><span class="line"></span><br><span class="line">如果指定了CHARACTER SET X而没有指定COLLATE Y,那么采用CHARACTER SET X和CHARACTER SET X的默认校对规则。否则,采用服务器字符集和服务器校对规则。</span><br></pre></td></tr></table></figure>
<h4 id="2-3-表级别的校对规则"><a href="#2-3-表级别的校对规则" class="headerlink" title="2.3 表级别的校对规则"></a>2.3 表级别的校对规则</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;每一个表有一个表字符集和一个校对规则,为指定表字符集和校对规则,CREATE TABLE 和ALTER TABLE语句有一个可选的子句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tblname (columnlist)</span><br><span class="line"></span><br><span class="line">[DEFAULT CHARACTER SET charsetname [COLLATE collationname]]</span><br><span class="line"></span><br><span class="line">ALTER TABLE tblname</span><br><span class="line"></span><br><span class="line">[DEFAULT CHARACTER SET charsetname] [COLLATE collationname]</span><br></pre></td></tr></table></figure>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t3(</span><br><span class="line">	col varchar(5)</span><br><span class="line">) DEFAULT CHARACTER SET utf8 COLLATE utf8bin ;</span><br><span class="line"></span><br><span class="line">insert into t3 values(&apos;abc&apos;),(&apos;ABC&apos;),(&apos;AbC&apos;);</span><br><span class="line"></span><br><span class="line">select * from t3;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| abc |</span><br><span class="line"></span><br><span class="line">| ABC |</span><br><span class="line"></span><br><span class="line">| AbC |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select * from t3 where col=&apos;abc&apos;;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| col |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| abc |</span><br><span class="line"></span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>
<p><strong>MySQL按照下面的方式选择表字符集和 校对规则</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果指定了CHARACTER SET X和COLLATE Y,那么采用CHARACTER SET X和COLLATE Y。</span><br><span class="line"></span><br><span class="line">如果指定了CHARACTER SET X而没有指定COLLATE Y,那么采用CHARACTER SET X和CHARACTER SET X的默认校对规则。</span><br><span class="line"></span><br><span class="line">否则,采用服务器字符集和服务器校对规则。</span><br><span class="line"></span><br><span class="line">如果在列定义中没有指定列字符集和校对规则,则默认使用表字符集和校对规则。表字符集和校对规则是MySQL的扩展;在标准SQL中没有。</span><br></pre></td></tr></table></figure>
<h2 id="MySQL服务响应客户端操作的字符的字符集和客户端信息处理过程"><a href="#MySQL服务响应客户端操作的字符的字符集和客户端信息处理过程" class="headerlink" title="MySQL服务响应客户端操作的字符的字符集和客户端信息处理过程"></a>MySQL服务响应客户端操作的字符的字符集和客户端信息处理过程</h2><p><strong>MySQL服务响应客户端操作的字符的字符集和客户端信息处理过程</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 客户端发出的SQL语句，所使用的字符集由系统变量character_set_client来指定</span><br><span class="line"></span><br><span class="line">2. MySQL服务端接收语句后，会用character_set_connection和collation_connection两个系统变量中的设置，并且会将客户端发送的语句字符集由character_set_client转到character_set_connection(除非用户执行语句时，已经对字符列明确指定了字符集）。对于语句中指定的字符串比较或排序，还需要应用collation_connection中指定的校对规则处理，而对于语句中指定的列的比较则无关collation_connection的设置了，因为对象的列表拥有自己的校对规则，他们拥有更高的优先级</span><br><span class="line"></span><br><span class="line">3. MySQL服务执行完语句后，会按照character_set_result系统变量设置的字符集返回结果集（或错误信息）到客户端。</span><br><span class="line">   </span><br><span class="line">可以用语句：show global variables like &apos;character_set_%&apos;;查看这些系统变量设置。</span><br></pre></td></tr></table></figure>
<h2 id="固化连接时的字符集设置"><a href="#固化连接时的字符集设置" class="headerlink" title="固化连接时的字符集设置"></a>固化连接时的字符集设置</h2><h4 id="临时生效"><a href="#临时生效" class="headerlink" title="临时生效"></a>临时生效</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>SET NAMES和SET CHARACTER SET命令都是基于会话设定的</strong>，也就是说，仅作用于当前会话，退出登录后所做设置也就失效。</p>
<h4 id="永久生效"><a href="#永久生效" class="headerlink" title="永久生效"></a>永久生效</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果希望设置长期有效，可以在启动MySQL服务时，通过设置相关系统变量，达到永久生效的目的，可以到参数文件my.conf增加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样，只要我们使用mysql命令行工具连接服务器后，连接的默认字符集就都会是设定好的GBK字符集。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--- 相当于执行以下三点：</span><br><span class="line">set character_set_client=gbk</span><br><span class="line">set character_set_connection=gbk</span><br><span class="line">set character_set_results=gbk</span><br></pre></td></tr></table></figure>
<h2 id="修改字符集和校对规则"><a href="#修改字符集和校对规则" class="headerlink" title="修改字符集和校对规则"></a>修改字符集和校对规则</h2><p>修改my.cnf<br>    <code>vi /etc/my.cnf</code><br>在[client]下添加<br>    <code>default-character-set=utf8</code><br>在[mysqld]下添加<br>    <code>default-character-set=utf8</code></p>
<p>​    <code>default-collation=utf8_general_ci</code></p>
<p><code>/etc/rc.d/init.d/mysql restart</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">show variables like &apos;collation_%&apos;;</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| Variable_name         | Value            |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| collation_connection | utf8_general_ci |</span><br><span class="line">| collation_database    | utf8_general_ci |</span><br><span class="line">| collation_server      | utf8_general_ci |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line"></span><br><span class="line">show variables like &apos;character_set_%&apos;;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name             | Value                       |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client      | utf8                        |</span><br><span class="line">| character_set_connection | utf8                        |</span><br><span class="line">| character_set_database    | utf8                        |</span><br><span class="line">| character_set_filesystem | binary                      |</span><br><span class="line">| character_set_results     | utf8                        |</span><br><span class="line">| character_set_server      | utf8                        |</span><br><span class="line">| character_set_system      | utf8                        |</span><br><span class="line">| character_sets_dir        | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line"></span><br><span class="line">use mydb;</span><br><span class="line"></span><br><span class="line">alter database mydb character set utf-8;</span><br><span class="line"></span><br><span class="line">create database mydb character set utf-8;</span><br><span class="line"></span><br><span class="line">set character_set_client=utf8;</span><br><span class="line">set character_set_connection=utf8;</span><br><span class="line">set character_set_database=utf8;</span><br><span class="line">set character_set_results=utf8;</span><br><span class="line">set character_set_server=utf8;</span><br><span class="line">set character_set_system=utf8;</span><br><span class="line"></span><br><span class="line">使用set names 字符集;命令来实现上述效果，等同于下面的命令：</span><br><span class="line">set character_set_client = 字符集</span><br><span class="line">set character_set_connection = 字符集</span><br><span class="line">set character_set_results = 字符集</span><br><span class="line"></span><br><span class="line">设置collation</span><br><span class="line">set collation_connection=utf8;</span><br><span class="line">set collation_database=utf8;</span><br><span class="line">set collation_server=utf8;</span><br></pre></td></tr></table></figure>
<h2 id="MySQL中涉及的几个字符集"><a href="#MySQL中涉及的几个字符集" class="headerlink" title="MySQL中涉及的几个字符集"></a>MySQL中涉及的几个字符集</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">character-set-server/default-character-set：服务器字符集，默认情况下所采用的</span><br><span class="line"></span><br><span class="line">character-set-database：数据库字符集</span><br><span class="line"></span><br><span class="line">character-set-table：数据库表字符集</span><br><span class="line">优先级依次增加。所以一般情况下只需要设置character-set-server，而在创建数据库和表时不特别指定字符集，这样统一采用character-set-server字符集</span><br><span class="line"></span><br><span class="line">character-set-client：客户端的字符集。客户端默认字符集。当客户端向服务器发送请求时，请求以该字符集进行编码</span><br><span class="line"></span><br><span class="line">character-set-results：结果字符集。服务器向客户端返回结果或者信息时，结果以该字符集进行编码。</span><br><span class="line">在客户端，如果没有定义character-set-results，则采用character-set-client字符集作为默认的字符集。所以只需要设置character-set-client字符集</span><br></pre></td></tr></table></figure>
<h2 id="MySQL默认字符集"><a href="#MySQL默认字符集" class="headerlink" title="MySQL默认字符集"></a>MySQL默认字符集</h2><h3 id="服务端相关"><a href="#服务端相关" class="headerlink" title="服务端相关"></a>服务端相关</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL对于字符集的指定可以细化到一个数据库，一张表，一列，应该用什么字符集。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，传统的程序在创建数据库和数据表时并没有使用那么复杂的配置，它们用的是默认的配置，那么，默认的配置从何而来呢？    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> (1)  编译MySQL 时，指定了一个默认的字符集，这个字符集是 latin1；</span><br><span class="line"> </span><br><span class="line"> (2)  安装MySQL 时，可以在配置文件 (my.ini) 中指定一个默认的的字符集，如果没指定，这个值继承自编译时指定的；</span><br><span class="line"> </span><br><span class="line">(3)  启动mysqld 时，可以在命令行参数中指定一个默认的的字符集，如果没指定，这个值继承自配置文件中的配置,此时 character_set_server 被设定为这个默认的字符集；</span><br><span class="line"></span><br><span class="line">(4)  当创建一个新的数据库时，除非明确指定，这个数据库的字符集被缺省设定为character_set_server；</span><br><span class="line"></span><br><span class="line"> (5)  当选定了一个数据库时，character_set_database 被设定为这个数据库默认的字符集；</span><br><span class="line"> </span><br><span class="line"> (6)  在这个数据库里创建一张表时，表默认的字符集被设定为 character_set_database，也就是这个数据库默认的字符集；</span><br><span class="line"> </span><br><span class="line"> (7)  当在表内设置一栏时，除非明确指定，否则此栏缺省的字符集就是表默认的字符集；</span><br></pre></td></tr></table></figure>
<h3 id="客户端相关"><a href="#客户端相关" class="headerlink" title="客户端相关"></a>客户端相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line">default-character-set=gbk</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样，只要我们使用mysql命令行工具连接服务器后，连接的默认字符集就都会是设定好的GBK字符集。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--- 相当于执行以下三点：</span><br><span class="line">set character_set_client=gbk</span><br><span class="line">set character_set_connection=gbk</span><br><span class="line">set character_set_results=gbk</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析/" itemprop="url">MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySql字符集/" itemprop="url" rel="index">
                    <span itemprop="name">MySql字符集</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析"><a href="#MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析" class="headerlink" title="MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析"></a>MySQL字符集相关变量介绍及binlog中字符集相关缺陷分析</h1><blockquote>
<p>原文地址：<a href="http://mysql.taobao.org/monthly/2018/01/07/?from=singlemessage" target="_blank" rel="noopener">http://mysql.taobao.org/monthly/2018/01/07/?from=singlemessage</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL支持多种字符集（character set）提供用户存储数据，同时允许用不同排序规则（collation）做比较。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文基于MySQL5.7介绍了字符集相关变量的使用，通过例子描述了这些变量具体意义。分析了MySQL binlog中字符集相关处理的缺陷，这些缺陷会导致复制中断或者主备不一致。最后给出了修复上述缺陷的建议。</p>
<h2 id="MySQL字符集相关基础知识介绍"><a href="#MySQL字符集相关基础知识介绍" class="headerlink" title="MySQL字符集相关基础知识介绍"></a>MySQL字符集相关基础知识介绍</h2><h3 id="character-set-system"><a href="#character-set-system" class="headerlink" title="character_set_system"></a>character_set_system</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>character_set_system</code>为元数据的字符集，即所有的元数据都使用同一个字符集</strong>。试想如果元数据采用不同字符集，INFORMATION_SCHEMA中的相关信息在不同行之间就很难展示。同时该字符集要能够支持多种语言，方便不同语言人群使用自己的语言命名database、table、column。MySQL选择UTF-8作为元数据编码，用源码固定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sql/mysqld.cc</span><br><span class="line">int mysqld_main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  system_charset_info= &amp;my_charset_utf8_general_ci;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; select @@global.character_set_system;</span><br><span class="line">+-------------------------------+</span><br><span class="line">| @@global.character_set_system |</span><br><span class="line">+-------------------------------+</span><br><span class="line">| utf8                          |</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure>
<p>MySQL会将identifier转换为system_charset_info(utf8)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">sql/sql_lex.cc</span><br><span class="line">static int lex_one_token(YYSTYPE *yylval, THD *thd)</span><br><span class="line">&#123;</span><br><span class="line"> case MY_LEX_IDENT:</span><br><span class="line">   ...</span><br><span class="line"> lip-&gt;body_utf8_append_literal</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void Lex_input_stream::body_utf8_append_literal(THD *thd,</span><br><span class="line">                                                const LEX_STRING *txt,</span><br><span class="line">                                                const CHARSET_INFO *txt_cs,</span><br><span class="line">                                                const char *end_ptr)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  if (!my_charset_same(txt_cs, &amp;my_charset_utf8_general_ci))</span><br><span class="line">  &#123;</span><br><span class="line">    thd-&gt;convert_string(&amp;utf_txt,</span><br><span class="line">                       &amp;my_charset_utf8_general_ci,</span><br><span class="line">                       txt-&gt;str, txt-&gt;length,</span><br><span class="line">                       txt_cs);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    utf_txt.str= txt-&gt;str;</span><br><span class="line">    utf_txt.length= txt-&gt;length;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sql/sql_yacc.yy</span><br><span class="line"></span><br><span class="line">IDENT_sys:</span><br><span class="line">IDENT &#123; $$= $1; &#125;</span><br><span class="line">| IDENT_QUOTED</span><br><span class="line">&#123;</span><br><span class="line">  THD *thd= YYTHD;</span><br><span class="line"></span><br><span class="line">  if (thd-&gt;charset_is_system_charset)</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    if (thd-&gt;convert_string(&amp;$$, system_charset_info,</span><br><span class="line">                        $1.str, $1.length, thd-&gt;charset()))</span><br><span class="line">      MYSQL_YYABORT;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<h3 id="character-set-server-collation-server"><a href="#character-set-server-collation-server" class="headerlink" title="character_set_server/collation_server"></a>character_set_server/collation_server</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当create database没有指定charset/collation就会用character_set_server/collation_server，这两个变量可以动态设置，有session/global级别</strong>。</p>
<blockquote>
<p>mysql&gt; select @@global.character_set_server;<br>+—————————–+<br>| @@global.character_set_server |<br>+—————————–+<br>| utf8                        |<br>+—————————–+<br>1 row in set (0.04 sec)</p>
<p>mysql&gt; select @@global.collation_server;<br>+————————+<br>| @@global.collation_server |<br>+————————+<br>| utf8_general_ci          |<br>+————————+<br>1 row in set (0.04 sec)</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>在源码中character_set_server/collation_server实际对应一个变量，因为一个collation对应着一个charset</strong>，所以源码中只记录CHARSET_INFO结构的collation_server即可。当修改character_set_server，会选择对应charset的默认collation。对于其他同时有charset和collation的变量，源码记录也都是记录collation。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static Sys_var_struct Sys_character_set_server(</span><br><span class="line">       &quot;character_set_server&quot;, &quot;The default character set&quot;,</span><br><span class="line">       SESSION_VAR(collation_server), NO_CMD_LINE,</span><br><span class="line">       offsetof(CHARSET_INFO, csname), DEFAULT(&amp;default_charset_info),</span><br><span class="line">       NO_MUTEX_GUARD, IN_BINLOG, ON_CHECK(check_charset_not_null));</span><br><span class="line"></span><br><span class="line">static Sys_var_struct Sys_collation_server(</span><br><span class="line">       &quot;collation_server&quot;, &quot;The server default collation&quot;,</span><br><span class="line">       SESSION_VAR(collation_server), NO_CMD_LINE,</span><br><span class="line">       offsetof(CHARSET_INFO, name), DEFAULT(&amp;default_charset_info),</span><br><span class="line">       NO_MUTEX_GUARD, IN_BINLOG, ON_CHECK(check_collation_not_null));</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过下面case可以看到通过设置session中不同的character_set_server使创建database的默认charset和collation不同。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; set character_set_server=&apos;utf8&apos;;</span><br><span class="line"></span><br><span class="line">&gt; create database cs_test1;</span><br><span class="line"></span><br><span class="line">&gt; select * from information_schema.SCHEMATA where SCHEMA_NAME=&apos;cs_test1&apos;;</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br><span class="line">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br><span class="line">| def          | cs_test1    | utf8                       | utf8_general_ci        | NULL     |</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br><span class="line"></span><br><span class="line">&gt; set character_set_server=&apos;latin1&apos;;</span><br><span class="line"></span><br><span class="line">&gt; create database cs_test2;</span><br><span class="line"></span><br><span class="line">&gt; select * from information_schema.SCHEMATA where SCHEMA_NAME=&apos;cs_test2&apos;;</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br><span class="line">| CATALOG_NAME | SCHEMA_NAME | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH |</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br><span class="line">| def          | cs_test2    | latin1                     | latin1_swedish_ci      | NULL     |</span><br><span class="line">+--------------+-------------+----------------------------+------------------------+----------+</span><br></pre></td></tr></table></figure>
<h3 id="character-set-database-collation-database"><a href="#character-set-database-collation-database" class="headerlink" title="character_set_database/collation_database"></a>character_set_database/collation_database</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>该变量值session级别表示当前database的charset/collation</strong>，在后面的源码版本中该变量可能修正为只读，不建议修改该值。其global级别变量后面也会移除。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; use cs_test1;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> @@character_set_database;</span><br><span class="line">+--------------------------+</span><br><span class="line">| @@character_set_database |</span><br><span class="line">+--------------------------+</span><br><span class="line">| utf8                     |</span><br><span class="line">+--------------------------+</span><br><span class="line"></span><br><span class="line">&gt; use cs_test2;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> @@character_set_database;</span><br><span class="line">+--------------------------+</span><br><span class="line">| @@character_set_database |</span><br><span class="line">+--------------------------+</span><br><span class="line">| latin1                   |</span><br><span class="line">+--------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="character-set-client"><a href="#character-set-client" class="headerlink" title="character_set_client"></a>character_set_client</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>客户端发送到server的字符串使用的字符集，server会按照该变量值来解析客户端发来的语句。如果指定值和语句实际编码字符集不符就会解析出错，报语法错误或者得到非预期结果</strong>，例如下面的两个case。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">case1:实际使用utf8编码且包含中文字符，但设置character_set_client为latin1。</span><br><span class="line"></span><br><span class="line">&gt; set character_set_client=<span class="string">'latin1'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table 字符集(c1 varchar(<span class="number">10</span>));</span><br><span class="line">ERROR <span class="number">1064</span> (<span class="number">42000</span>): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to use near <span class="string">'­—ç¬¦é›†(c1 varchar(10))'</span> at line <span class="number">1</span></span><br><span class="line"></span><br><span class="line">&gt; set character_set_client=<span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table 字符集(c1 varchar(<span class="number">10</span>));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.14</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">case2:实际使用utf8编码且包含中文字符，但设置character_set_client为gbk。</span><br><span class="line"></span><br><span class="line">&gt; create database cs_test;</span><br><span class="line"></span><br><span class="line">&gt; use cs_test;</span><br><span class="line"></span><br><span class="line">&gt; set character_set_client=<span class="string">'gbk'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table 收费(c1 varchar(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_cs_test |</span><br><span class="line">+-------------------+</span><br><span class="line">| 鏀惰垂            |</span><br><span class="line">+-------------------+</span><br><span class="line"></span><br><span class="line">&gt; set character_set_client=<span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table 收费(c1 varchar(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_cs_test |</span><br><span class="line">+-------------------+</span><br><span class="line">| 收费              |</span><br><span class="line">| 鏀惰垂            |</span><br><span class="line">+-------------------+</span><br><span class="line"><span class="number">2</span> rows in set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h3 id="character-set-connection-collation-connection"><a href="#character-set-connection-collation-connection" class="headerlink" title="character_set_connection/collation_connection"></a>character_set_connection/collation_connection</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>没有指定字符集的常量字符串使用时的字符集</strong>，例如下面两个case。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>case1中当设置为utf8_general_ci比较时候忽略大小写，导致’a’=’A’结果为1，如果设置为utf8_bin不忽略大小写，’a’ = ‘A’的结果就是0</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case2中当设置character_set_connection为’latin1’的时候，’你好’ = ‘我好’返回结果为1，如果设置为’utf8’，返回结果就是0。设置为’latin1’返回结果为1的原因是utf8编码的中文字符是无法转换为latin1字符的。这里MySQL就把’你好’和’我好’都转换成了’??’。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case3中character_set_connection的不同导致create table语句中column的实际default value不同。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">case1:设置collation_connection是否忽略大小写导致结果不一致。</span><br><span class="line"></span><br><span class="line">&gt; set collation_connection=utf8_general_ci;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'a'</span> = <span class="string">'A'</span>;</span><br><span class="line">+-----------+</span><br><span class="line">| <span class="string">'a'</span> = <span class="string">'A'</span> |</span><br><span class="line">+-----------+</span><br><span class="line">|         <span class="number">1</span> |</span><br><span class="line">+-----------+</span><br><span class="line"></span><br><span class="line">&gt; set collation_connection=utf8_bin;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'a'</span> = <span class="string">'A'</span>;</span><br><span class="line">+-----------+</span><br><span class="line">| <span class="string">'a'</span> = <span class="string">'A'</span> |</span><br><span class="line">+-----------+</span><br><span class="line">|         <span class="number">0</span> |</span><br><span class="line">+-----------+</span><br><span class="line"></span><br><span class="line">case2:设置character_set_connection不同导致结果不一致。</span><br><span class="line"></span><br><span class="line">&gt; set character_set_connection=<span class="string">'latin1'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'你好'</span> = <span class="string">'我好'</span>;</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="string">'你好'</span> = <span class="string">'我好'</span>     |</span><br><span class="line">+---------------------+</span><br><span class="line">|                   <span class="number">1</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row in set, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">&gt; set character_set_connection=<span class="string">'utf8'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'你好'</span> = <span class="string">'我好'</span>;</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="string">'你好'</span> = <span class="string">'我好'</span>     |</span><br><span class="line">+---------------------+</span><br><span class="line">|                   <span class="number">0</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; set character_set_connection=<span class="string">'latin1'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'你好'</span>;</span><br><span class="line">+----+</span><br><span class="line">| ?? |</span><br><span class="line">+----+</span><br><span class="line">| ?? |</span><br><span class="line">+----+</span><br><span class="line"></span><br><span class="line">case3:设置character_set_connection导致实际<span class="keyword">default</span> value不同。</span><br><span class="line"></span><br><span class="line">&gt; set character_set_connection=<span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table cs_t(c1 varchar(<span class="number">10</span>) <span class="keyword">default</span> <span class="string">'你好'</span>)charset=utf8;</span><br><span class="line"></span><br><span class="line">&gt; insert into cs_t values();</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> * from cs_t;</span><br><span class="line">+--------+</span><br><span class="line">| c1     |</span><br><span class="line">+--------+</span><br><span class="line">| 你好   |</span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line">&gt; set character_set_connection=<span class="string">'latin1'</span>;</span><br><span class="line"></span><br><span class="line">&gt; create table cs_t1(c1 varchar(<span class="number">10</span>) <span class="keyword">default</span> <span class="string">'你好'</span>)charset=utf8;</span><br><span class="line"></span><br><span class="line">&gt; insert into cs_t1 values();</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> * from cs_t1;</span><br><span class="line">+------+</span><br><span class="line">| c1   |</span><br><span class="line">+------+</span><br><span class="line">| ??   |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>
<h3 id="character-set-results"><a href="#character-set-results" class="headerlink" title="character_set_results"></a>character_set_results</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>查询结果和错误信息的字符集，server会把返回给客户端的结果转换为对应字符集</strong>。例如下面case，当设置character_set_results为’latin1’的时候，会导致返回的中文变成’?’。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&gt; set character_set_results=<span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'你好'</span>;</span><br><span class="line">+--------+</span><br><span class="line">| 你好   |</span><br><span class="line">+--------+</span><br><span class="line">| 你好   |</span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line">&gt; set character_set_results=<span class="string">'latin1'</span>;</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> <span class="string">'你好'</span>;</span><br><span class="line">+----+</span><br><span class="line">| ?? |</span><br><span class="line">+----+</span><br><span class="line">| ?? |</span><br><span class="line">+----+</span><br><span class="line"></span><br><span class="line">&gt; create table cs_test(c1 varchar(<span class="number">10</span>)) charset=utf8;</span><br><span class="line"></span><br><span class="line">&gt; insert into cs_test values(<span class="string">'你好'</span>),(<span class="string">'我好'</span>);</span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> * from cs_test;</span><br><span class="line">+------+</span><br><span class="line">| c1   |</span><br><span class="line">+------+</span><br><span class="line">| ??   |</span><br><span class="line">| ??   |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; set character_set_results=<span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; <span class="keyword">select</span> * from cs_test;</span><br><span class="line">+--------+</span><br><span class="line">| c1     |</span><br><span class="line">+--------+</span><br><span class="line">| 你好   |</span><br><span class="line">| 我好   |</span><br><span class="line">+--------+</span><br></pre></td></tr></table></figure>
<h2 id="binlog-中字符集相关缺陷"><a href="#binlog-中字符集相关缺陷" class="headerlink" title="binlog 中字符集相关缺陷"></a>binlog 中字符集相关缺陷</h2><h3 id="binlog当前字符集相关实现"><a href="#binlog当前字符集相关实现" class="headerlink" title="binlog当前字符集相关实现"></a>binlog当前字符集相关实现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于很多DDL语句，binlog都是直接记录客户端发来的字符串，对于这些语句只要记录语句执行时候的环境变量就可以在备库正确执行。binlog中Query_log_event记录了character_set_client、collation_connection和collation_server，代码如下。记录这三个变量的原因读者可以参考前面各个变量的介绍和case。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">int THD::binlog_query(THD::enum_binlog_query_type qtype, const char *query_arg,</span><br><span class="line">                      size_t query_len, bool is_trans, bool direct,</span><br><span class="line">                      bool suppress_use, int errcode)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  case THD::STMT_QUERY_TYPE:</span><br><span class="line">  /*</span><br><span class="line">    The MYSQL_BIN_LOG::write() function will set the STMT_END_F flag and</span><br><span class="line">    flush the pending rows event if necessary.</span><br><span class="line">  */</span><br><span class="line">  &#123;</span><br><span class="line">    Query_log_event qinfo(this, query_arg, query_len, is_trans, direct,</span><br><span class="line">                          suppress_use, errcode);</span><br><span class="line">    /*</span><br><span class="line">      Binlog table maps will be irrelevant after a Query_log_event</span><br><span class="line">      (they are just removed on the slave side) so after the query</span><br><span class="line">      log event is written to the binary log, we pretend that no</span><br><span class="line">      table maps were written.</span><br><span class="line">     */</span><br><span class="line">    int error= mysql_bin_log.write_event(&amp;qinfo);</span><br><span class="line">    binlog_table_maps= 0;</span><br><span class="line">    DBUG_RETURN(error);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Query_log_event::Query_log_event(THD* thd_arg, const char* query_arg,</span><br><span class="line">         size_t query_length, bool using_trans,</span><br><span class="line">         bool immediate, bool suppress_use,</span><br><span class="line">                                 int errcode, bool ignore_cmd_internals)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  int2store(charset, thd_arg-&gt;variables.character_set_client-&gt;number);</span><br><span class="line">  int2store(charset+2, thd_arg-&gt;variables.collation_connection-&gt;number);</span><br><span class="line">  int2store(charset+4, thd_arg-&gt;variables.collation_server-&gt;number);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如前面创建表cs_t1的case我们可以看到binlog如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; set character_set_connection=&apos;latin1&apos;;</span><br><span class="line">&gt; create table cs_t1(c1 varchar(10) default &apos;你好&apos;)charset=utf8;</span><br><span class="line"></span><br><span class="line">SET TIMESTAMP=1516089074/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=8,@@session.collation_server=8/*!*/;</span><br><span class="line">create table cs_t1(c1 varchar(10) default &apos;你好&apos;)charset=utf8</span><br></pre></td></tr></table></figure>
<h3 id="binlog字符集相关缺陷"><a href="#binlog字符集相关缺陷" class="headerlink" title="binlog字符集相关缺陷"></a>binlog字符集相关缺陷</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于Query_log_event如果记录的query仅仅是客户端的输入，上面记录字符集变量的方法没有问题。但<strong>如果query是server内部生成或者拼接成的，上面直接从thread中获取变量值得方法就可能导致错误</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例如下面的testcase，这里为便于观察和理解case没有使用mysql-test方式，后面有mysql-test。这里主库执行成功，成功创建了表t和视图’收费明细表’，但备库在创建视图的时候却报语法错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">用gbk编码写如下sql文本</span><br><span class="line">cs_test.sql</span><br><span class="line"></span><br><span class="line">use test;</span><br><span class="line">set @@session.character_set_client=gbk;</span><br><span class="line">set @@session.collation_connection=gbk_chinese_ci;</span><br><span class="line">create table t(c1 int);</span><br><span class="line">create view `收费明细表` as select * from t;</span><br><span class="line"></span><br><span class="line">在主库执行</span><br><span class="line">&gt; source path/cs_test.sql;</span><br><span class="line"></span><br><span class="line">&gt; set character_set_results=&apos;gbk&apos;;</span><br><span class="line"></span><br><span class="line">&gt; use test;</span><br><span class="line"></span><br><span class="line">&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| 收费明细表             |</span><br><span class="line">| t              |</span><br><span class="line">+----------------+</span><br><span class="line"></span><br><span class="line">备库</span><br><span class="line"></span><br><span class="line">&gt; show slave status\G</span><br><span class="line">...</span><br><span class="line">Last_SQL_Errno: 1064</span><br><span class="line">Last_SQL_Error: Error &apos;You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &apos;`閺鎯板瀭閺勫海绮忕悰鈺? AS select * from t&apos; at line 1&apos; on query. Default database: &apos;test&apos;. Query: &apos;CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `鏀惰垂鏄庣粏琛╜ AS select * from t&apos;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;缺陷分析，MySQL记录create view的binlog代码如下。由前面基础知识可以知道对于db、table这些元数据MySQL会先转换为system_charset_info(utf8)。因此在下面代码中append_identifier添加的table name为utf8编码的’收费明细表’，但是views-&gt;source.str又是client端原始的gbk编码方式，binlog_query记录的是thd中的character_set_client。即<strong>binlog中的query可能是由system_charset_info和character_set_client两种编码方式组成的字符串，记录的是当前character_set_client的值</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">sql/sql_view.cc</span><br><span class="line">bool mysql_create_view(THD *thd, TABLE_LIST *views,</span><br><span class="line">                       enum_view_create_mode mode)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  if (views-&gt;db &amp;&amp; views-&gt;db[0] &amp;&amp;</span><br><span class="line">    (thd-&gt;db().str == NULL || strcmp(views-&gt;db, thd-&gt;db().str)))</span><br><span class="line">  &#123;</span><br><span class="line">    append_identifier(thd, &amp;buff, views-&gt;db,</span><br><span class="line">                      views-&gt;db_length);</span><br><span class="line">                      buff.append(&apos;.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  append_identifier(thd, &amp;buff, views-&gt;table_name,</span><br><span class="line">                    views-&gt;table_name_length);</span><br><span class="line">  if (lex-&gt;view_list.elements)</span><br><span class="line">  &#123;</span><br><span class="line">    List_iterator_fast&lt;LEX_STRING&gt; names(lex-&gt;view_list);</span><br><span class="line">    LEX_STRING *name;</span><br><span class="line">    int i;</span><br><span class="line"></span><br><span class="line">    for (i= 0; (name= names++); i++)</span><br><span class="line">    &#123;</span><br><span class="line">      buff.append(i ? &quot;, &quot; : &quot;(&quot;);</span><br><span class="line">      append_identifier(thd, &amp;buff, name-&gt;str, name-&gt;length);</span><br><span class="line">    &#125;</span><br><span class="line">    buff.append(&apos;)&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">  buff.append(STRING_WITH_LEN(&quot; AS &quot;));</span><br><span class="line">  buff.append(views-&gt;source.str, views-&gt;source.length);</span><br><span class="line"></span><br><span class="line">  int errcode= query_error_code(thd, TRUE);</span><br><span class="line">  thd-&gt;add_to_binlog_accessed_dbs(views-&gt;db);</span><br><span class="line">  if (thd-&gt;binlog_query(THD::STMT_QUERY_TYPE,</span><br><span class="line">                        buff.ptr(), buff.length(), FALSE, FALSE, FALSE, errcode))</span><br><span class="line">    res= TRUE;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在MySQL源码中搜索binlog_query还可以找到多处类似的bug，可参考下面的testcase。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">--disable_warnings</span><br><span class="line">--source include/master-slave.inc</span><br><span class="line">--enable_warnings</span><br><span class="line"></span><br><span class="line"># case1:创建gbk编码中文名视图</span><br><span class="line"></span><br><span class="line">create table t(c1 int);</span><br><span class="line">SET @@session.character_set_client=gbk;</span><br><span class="line">set @@session.collation_connection=gbk_chinese_ci;</span><br><span class="line">set @@session.collation_server=utf8_general_ci;</span><br><span class="line">create view `收费明细` as select * from t;</span><br><span class="line">drop view `收费明细`;</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">--sync_slave_with_master</span><br><span class="line"></span><br><span class="line">connection slave;</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">connection master;</span><br><span class="line">drop table t;</span><br><span class="line"></span><br><span class="line"># case2:创建gbk编码中文名视图，且view body中包含中文</span><br><span class="line">connection master;</span><br><span class="line">SET @@session.character_set_client=gbk;</span><br><span class="line">create table 视图(c1 int);</span><br><span class="line">create view 视图信息 as select * from 视图;</span><br><span class="line">drop view 视图信息;</span><br><span class="line"></span><br><span class="line"># case3: drop table 语句会是generated by server.</span><br><span class="line">drop table 视图;</span><br><span class="line">--sync_slave_with_master</span><br><span class="line"></span><br><span class="line"># case4:内存表，重启后再次访问时会生成delete from tableName语句.</span><br><span class="line">connection master;</span><br><span class="line">SET @@session.character_set_client=utf8;</span><br><span class="line">set @@session.collation_connection=utf8_general_ci;</span><br><span class="line">set @@session.collation_server=utf8_general_ci;</span><br><span class="line">create table `收费明细表`(c1 int) engine=memory;</span><br><span class="line">create view tv as select * from `收费明细表`;</span><br><span class="line">--connection slave</span><br><span class="line">-- source include/stop_slave.inc</span><br><span class="line"></span><br><span class="line">--let $rpl_server_number= 1</span><br><span class="line">--source include/rpl_restart_server.inc</span><br><span class="line"># access memory table after restarting server cause binlog &apos;delete from tableName&apos;</span><br><span class="line">connection master;</span><br><span class="line">SET @@session.character_set_client=gbk;</span><br><span class="line">set @@session.collation_connection=gbk_chinese_ci;</span><br><span class="line">set @@session.collation_server=utf8_general_ci;</span><br><span class="line">select * from tv;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--connection slave</span><br><span class="line">-- source include/start_slave.inc</span><br><span class="line">connection master;</span><br><span class="line">--sync_slave_with_master</span><br><span class="line">connection slave;</span><br><span class="line"></span><br><span class="line"># case5:character_set_client为gbk时中文名的procedure</span><br><span class="line"></span><br><span class="line">connection master;</span><br><span class="line">delimiter $$;</span><br><span class="line">create procedure 收费明细()</span><br><span class="line">begin</span><br><span class="line">  select &apos;hello world&apos;;</span><br><span class="line">end $$</span><br><span class="line">delimiter ;$$</span><br><span class="line">drop procedure `收费明细`;</span><br><span class="line"></span><br><span class="line">connection master;</span><br><span class="line">SET @@session.character_set_client=utf8;</span><br><span class="line">set @@session.collation_connection=utf8_general_ci;</span><br><span class="line">set @@session.collation_server=utf8_general_ci;</span><br><span class="line">drop view tv;</span><br><span class="line">drop table `收费明细表`;</span><br><span class="line">--sync_slave_with_master</span><br><span class="line"></span><br><span class="line">connection slave;</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># case6: 不同环境变量下create table like/as 表中有中文default value的</span><br><span class="line"></span><br><span class="line">set character_set_client = utf8;</span><br><span class="line">set character_set_connection = utf8;</span><br><span class="line">set character_set_database = utf8;</span><br><span class="line">set character_set_results = utf8;</span><br><span class="line">set character_set_server = utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `t1` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `orderType` char(6) NOT NULL DEFAULT &apos;已创建&apos;,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">create temporary table `tm` (c1 varchar(10) default &apos;你好&apos;);</span><br><span class="line"></span><br><span class="line">show create table t1;</span><br><span class="line"></span><br><span class="line">## switch client charset</span><br><span class="line">set character_set_client = latin1;</span><br><span class="line">set character_set_connection = latin1;</span><br><span class="line">set collation_server = utf8_bin;</span><br><span class="line">CREATE TABLE t2 SELECT * FROM t1;</span><br><span class="line">create table t3 like tm;</span><br><span class="line">show create table t2;</span><br><span class="line">show create table t3;</span><br><span class="line"></span><br><span class="line">--sync_slave_with_master</span><br><span class="line"></span><br><span class="line">connection slave;</span><br><span class="line">show tables;</span><br><span class="line">set character_set_client = utf8;</span><br><span class="line">set character_set_connection = utf8;</span><br><span class="line">set character_set_database = utf8;</span><br><span class="line">set character_set_results = utf8;</span><br><span class="line">set character_set_server = utf8;</span><br><span class="line">show create table t1;</span><br><span class="line">show create table t2;</span><br><span class="line">show create table t3;</span><br><span class="line"></span><br><span class="line">connection master;</span><br><span class="line">drop table t1;</span><br><span class="line">drop table t2;</span><br><span class="line">drop table t3;</span><br><span class="line"></span><br><span class="line">--sync_slave_with_master</span><br><span class="line"></span><br><span class="line">--source include/rpl_end.inc</span><br></pre></td></tr></table></figure>
<h3 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>对于create view/create procedure等一个query包含两种编码的可以将system_charset_info的部分转换为thread中的character_set_client</strong>。<strong>这里的转换需要考虑当前thread中character_set_client不支持utf8字符的问题，当转换失败需要报错，否则主备会不一致</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于完全由server生成的query，例如delete from和drop table语句，其query实际可以理解为system_charset_info，这种语句可以直接使binlog中character_set_client部分记录system_charset_info，而不是thread中的变量值。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该bug在MariaDB中也存在，可以见<a href="https://jira.mariadb.org/browse/MDEV-14249?page=com.atlassian.jira.plugin.system.issuetabpanels%3Aall-tabpanel" target="_blank" rel="noopener">MDEV-14249</a>，参考链接中的fix diff或者MariaDB的修复。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/20/MySQL字符集详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/MySQL字符集详解/" itemprop="url">MySQL字符集详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T12:12:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/" itemprop="url" rel="index">
                    <span itemprop="name">MySql</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/MySql/MySql字符集/" itemprop="url" rel="index">
                    <span itemprop="name">MySql字符集</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL字符集详解"><a href="#MySQL字符集详解" class="headerlink" title="MySQL字符集详解"></a>MySQL字符集详解</h1><h3 id="一、字符集和校验规则"><a href="#一、字符集和校验规则" class="headerlink" title="一、字符集和校验规则"></a>一、字符集和校验规则</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>字符集是一套符合和编码，校验规则（collation）是在字符集内用于比较字符的一套规则，即字符集的排序规则。MySQL可以使用对种字符集和检验规则来组织字符</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL服务器可以支持多种字符集，在同一台服务器，同一个数据库，甚至同一个表的不同字段都可以指定使用不同的字符集，相比oracle等其他数据库管理系统，在同一个数据库只能使用相同的字符集，MySQL明显存在更大的灵活性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>每种字符集都可能有多种校对规则，并且都有一个默认的校对规则，并且每个校对规则只是针对某个字符集，和其他的字符集么有关系</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在MySQL中，字符集的概念和编码方案被看做是同义词，一个字符集是一个转换表和一个编码方案的组合。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Unicode（Universal Code）是一种在计算机上使用的字符编码</strong>。<strong>Unicode 是为了解决传统的字符编码方案的局限而产生的，它为每种语言中的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台进行文本转换、处理的要求</strong>。Unicode存在不同的编码方案，包括Utf-8，Utf-16和Utf-32。Utf表示Unicode Transformation Format。</p>
<h3 id="二、查看mysql字符集方法"><a href="#二、查看mysql字符集方法" class="headerlink" title="二、查看mysql字符集方法"></a>二、查看mysql字符集方法</h3><h4 id="1、查看mysql服务器支持的字符集"><a href="#1、查看mysql服务器支持的字符集" class="headerlink" title="1、查看mysql服务器支持的字符集"></a>1、查看mysql服务器支持的字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show character set;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from information_schema.character_sets;</span><br><span class="line"></span><br><span class="line">mysql&gt; select character_set_name, default_collate_name, description, maxlen from</span><br><span class="line"></span><br><span class="line">information_schema.character_sets;</span><br></pre></td></tr></table></figure>
<h4 id="2、查看字符集的校对规则"><a href="#2、查看字符集的校对规则" class="headerlink" title="2、查看字符集的校对规则"></a>2、查看字符集的校对规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show collation;</span><br><span class="line"></span><br><span class="line">mysql&gt; show collation like &apos;utf8&apos;;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from information_schema.collations where collation_name like &apos;utf8%&apos;;</span><br></pre></td></tr></table></figure>
<h4 id="3、查看当前数据库的字符集"><a href="#3、查看当前数据库的字符集" class="headerlink" title="3、查看当前数据库的字符集"></a>3、查看当前数据库的字符集</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;character%&apos;;</span><br><span class="line"></span><br><span class="line">+--------------------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">| Variable_name | Value |</span><br><span class="line"></span><br><span class="line">+--------------------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">| character_set_client | utf8 |</span><br><span class="line"></span><br><span class="line">| character_set_connection | utf8 |</span><br><span class="line"></span><br><span class="line">| character_set_database | latin1 |</span><br><span class="line"></span><br><span class="line">| character_set_filesystem | utf8 |</span><br><span class="line"></span><br><span class="line">| character_set_results | utf8 |</span><br><span class="line"></span><br><span class="line">| character_set_server | utf8 |</span><br><span class="line"></span><br><span class="line">| character_set_system | utf8 |</span><br><span class="line"></span><br><span class="line">| character_sets_dir | /usr/local/mysql/share/charsets/ |</span><br><span class="line"></span><br><span class="line">+--------------------------+----------------------------------+</span><br><span class="line"></span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>名词解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">character_set_client：客户端请求数据的字符集</span><br><span class="line"></span><br><span class="line">character_set_connection：客户机/服务器连接的字符集</span><br><span class="line"></span><br><span class="line">character_set_database：默认数据库的字符集，无论默认数据库如何改变，都是这个字符集；如果没有默认数据库，那就使用 character_set_server指定的字符集，这个变量建议由系统自己管理，不要人为定义。</span><br><span class="line"></span><br><span class="line">character_set_filesystem：把os上文件名转化成此字符集，即把 character_set_client转换</span><br><span class="line"></span><br><span class="line">character_set_filesystem， 默认binary是不做任何转换的</span><br><span class="line"></span><br><span class="line">character_set_results：结果集，返回给客户端的字符集</span><br><span class="line"></span><br><span class="line">character_set_server：数据库服务器的默认字符集</span><br><span class="line"></span><br><span class="line">character_set_system：系统字符集，这个值总是utf8，不需要设置。这个字符集用于数据库对象（如表和列）的名字，也用于存储在目录表中的函数的名字。</span><br></pre></td></tr></table></figure>
<h4 id="4、查看当前数据库的校对规则"><a href="#4、查看当前数据库的校对规则" class="headerlink" title="4、查看当前数据库的校对规则"></a>4、查看当前数据库的校对规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;collation%&apos;;</span><br><span class="line"></span><br><span class="line">+----------------------+-------------------+</span><br><span class="line"></span><br><span class="line">| Variable_name | Value |</span><br><span class="line"></span><br><span class="line">+----------------------+-------------------+</span><br><span class="line"></span><br><span class="line">| collation_connection | utf8_general_ci |</span><br><span class="line"></span><br><span class="line">| collation_database | latin1_swedish_ci |</span><br><span class="line"></span><br><span class="line">| collation_server | utf8_general_ci |</span><br><span class="line"></span><br><span class="line">+----------------------+-------------------+</span><br><span class="line"></span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>名词解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">collation_connection 当前连接的字符集</span><br><span class="line"></span><br><span class="line">collation_database    当前日期的默认校对。每次用USE语句来“跳转”到另一个数据库的时候，这个变量的值就会改变。如果没有当前数据库，这个变量的值就是collation_server变量的值</span><br><span class="line"></span><br><span class="line">collation_server 服务器的默认校对。</span><br></pre></td></tr></table></figure>
<p>排序方式的命名规则为：字符集名字_语言_后缀，其中各个典型后缀的含义如下：<br>1）_ci：不区分大小写的排序方式<br>2）_cs：区分大小写的排序方式<br>3）_bin：二进制排序方式，大小比较将根据字符编码，不涉及人类语言，因此_bin的排序方式不包含人类语言</p>
<h3 id="三、MySQL字符集的设置"><a href="#三、MySQL字符集的设置" class="headerlink" title="三、MySQL字符集的设置"></a>三、MySQL字符集的设置</h3><h4 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h4><p>MySQL字符集设置分为两类：</p>
<p>1）创建对象的默认值。</p>
<p>2）控制server和client端交互通信的配置。</p>
<h5 id="1、创建对象的默认值"><a href="#1、创建对象的默认值" class="headerlink" title="1、创建对象的默认值"></a>1、创建对象的默认值</h5><p>字符集合校对规则有4个级别的默认设置：</p>
<p>1）服务器级别；</p>
<p>2）数据库级别；</p>
<p>3）表级别、列级别；</p>
<p>4）连接级别。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更低级别的设置会集成高级别的设置。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这里有一个通用的规则：<strong>先为服务器或者数据库选择一个合理的字符集，然后根据不同的实际情况，让某个列选择自己的字符集</strong>。</p>
<h5 id="2、控制server和client端交互通信的配置"><a href="#2、控制server和client端交互通信的配置" class="headerlink" title="2、控制server和client端交互通信的配置"></a>2、控制server和client端交互通信的配置</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大部分MySQL客户端都不具备同时支持多种字符集的能力，每次都只能使用一种字符集。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;客户和服务器之间的字符集转换工作是由如下几个MySQL系统变量控制的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1）character_set_server：mysql server默认字符集。</span><br><span class="line"></span><br><span class="line">2）character_set_database：数据库默认字符集。</span><br><span class="line"></span><br><span class="line">3）character_set_client：MySQL server假定客户端发送的查询使用的字符集。</span><br><span class="line"></span><br><span class="line">4）character_set_connection：MySQL Server接收客户端发布的查询请求后，将其转换为character_set_connection变量指定的字符集。</span><br><span class="line"></span><br><span class="line">5）character_set_results：mysql server把结果集和错误信息转换为character_set_results指定的字符集，并发送给客户端。</span><br><span class="line"></span><br><span class="line">6）character_set_system：系统元数据(字段名等)字符集</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还有以<strong>collation_</strong>开头的同上面对应的变量，用来描述字符序。</p>
<p>注意事项：</p>
<p>•    <strong>my.cnf中的default_character_set设置只影响mysql命令连接服务器时的连接字符集</strong>，不会对使用libmysqlclient库的应用程序产生任何作用！</p>
<p>•    <strong>对字段进行的SQL函数操作通常都是以内部操作字符集进行的，不受连接字符集设置的影响</strong>。</p>
<p>•    SQL语句中的裸字符串会受到连接字符集或introducer设置的影响，对于比较之类的操作可能产生完全不同的结果，需要小心！</p>
<h5 id="3、默认情况下字符集选择规则"><a href="#3、默认情况下字符集选择规则" class="headerlink" title="3、默认情况下字符集选择规则"></a>3、默认情况下字符集选择规则</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(1) 编译MySQL 时，指定了一个默认的字符集，这个字符集是 latin1;</span><br><span class="line"></span><br><span class="line">(2) 安装MySQL 时，可以在配置文件 (my.cnf) 中指定一个默认的的字符集，如果没指定，这个值继承自编译时指定的;</span><br><span class="line"></span><br><span class="line">(3) 启动mysqld 时，可以在命令行参数中指定一个默认的的字符集，如果没指定，这个值继承自配置文件中的配置,此时character_set_server被设定为这个默认的字符集;</span><br><span class="line"></span><br><span class="line">(4) 当创建一个新的数据库时，除非明确指定，这个数据库的字符集被缺省设定为character_set_server;</span><br><span class="line"></span><br><span class="line">(5) 当选定了一个数据库时，character_set_database被设定为这个数据库默认的字符集;</span><br><span class="line"></span><br><span class="line">(6) 在这个数据库里创建一张表时，表默认的字符集被设定为character_set_database，也就是这个数据库默认的字符集;</span><br><span class="line"></span><br><span class="line">(7) 当在表内设置一栏时，除非明确指定，否则此栏缺省的字符集就是表默认的字符集;</span><br></pre></td></tr></table></figure>
<h4 id="2、分述"><a href="#2、分述" class="headerlink" title="2、分述"></a>2、分述</h4><h5 id="2-1、为列分配字符集"><a href="#2-1、为列分配字符集" class="headerlink" title="2.1、为列分配字符集"></a>2.1、为列分配字符集</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;属于同一个表的不同列可以有不同的字符集，如果没有为一个列显示的定义字符集就使用默认字符集。创建一个表的时候，若显示的为列指定字符集，则字符集作为数据类型选项包含在其中，要放在数据类型后面及空指定和主键前面。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">create table column_charset(</span><br><span class="line">    c1 char(<span class="number">10</span>) character set utf8 not null,</span><br><span class="line"></span><br><span class="line">    c2 char(<span class="number">10</span>) char set utf8,</span><br><span class="line"></span><br><span class="line">    c3 varchar(<span class="number">10</span>) charset utf8,</span><br><span class="line"></span><br><span class="line">    c4 varchar(<span class="number">10</span>)</span><br><span class="line">) engine=innodb;</span><br></pre></td></tr></table></figure>
<p>注意：<strong>character set可以简写为char set和charset</strong></p>
<p>使用<code>show create table table_name</code>;命令查看column_charset建表语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table column_charset\G;</span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"></span><br><span class="line">Table: column_charset</span><br><span class="line"></span><br><span class="line">Create Table: CREATE TABLE `column_charset` (</span><br><span class="line"></span><br><span class="line">    `c1` char(10) CHARACTER SET utf8 NOT NULL,</span><br><span class="line"></span><br><span class="line">    `c2` char(10) CHARACTER SET utf8 DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">    `c3` varchar(10) CHARACTER SET utf8 DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">    `c4` varchar(10) DEFAULT NULL</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1</span><br></pre></td></tr></table></figure>
<p>插入数据，感受一下效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into column_charset(c1,c2,c3,c4) value(&quot;图灵&quot;,&quot;图灵&quot;,&quot;图灵&quot;,&quot;chavin&quot;);</span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from column_charset;</span><br><span class="line"></span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line"></span><br><span class="line">| c1 | c2 | c3 | c4 |</span><br><span class="line"></span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line"></span><br><span class="line">| 图灵 | 图灵 | 图灵 | chavin |</span><br><span class="line"></span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h5 id="2-2、为表分配字符集"><a href="#2-2、为表分配字符集" class="headerlink" title="2.2、为表分配字符集"></a>2.2、为表分配字符集</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table table_charset(</span><br><span class="line">    c1 varchar(10),</span><br><span class="line"></span><br><span class="line">    c2 varchar(10)</span><br><span class="line">)engine=innodb default charset=utf8;</span><br></pre></td></tr></table></figure>
<p><strong>注意：为表指定字符集可以使用以下几种方式：</strong></p>
<p><strong>default charset=utf8;</strong></p>
<p><strong>charset=utf8;</strong></p>
<p><strong>default character set=utf8;</strong></p>
<p><strong>character set=utf8;</strong></p>
<p><strong>default char set=utf8;</strong></p>
<p><strong>char set=utf8;</strong></p>
<p>检查建表语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table table_charset\G;</span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"></span><br><span class="line">Table: table_charset</span><br><span class="line"></span><br><span class="line">Create Table: CREATE TABLE `table_charset` (</span><br><span class="line"></span><br><span class="line">    `c1` varchar(10) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">    `c2` varchar(10) DEFAULT NULL</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into table_charset(c1,c2) values(&apos;图灵&apos;,&apos;图灵&apos;);</span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from table_charset;</span><br><span class="line"></span><br><span class="line">+--------+--------+</span><br><span class="line"></span><br><span class="line">| c1 | c2 |</span><br><span class="line"></span><br><span class="line">+--------+--------+</span><br><span class="line"></span><br><span class="line">| 图灵 | 图灵 |</span><br><span class="line"></span><br><span class="line">+--------+--------+</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h5 id="2-3、为数据库指定字符集"><a href="#2-3、为数据库指定字符集" class="headerlink" title="2.3、为数据库指定字符集"></a>2.3、为数据库指定字符集</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;创建的每个数据库都有一个默认字符集，如果没有指定，就用latin1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database dbking charset=utf8;</span><br></pre></td></tr></table></figure>
<p><strong>注意：创建数据库分配字符集可以采用以下几种子句：</strong></p>
<p><strong>charset=utf8;</strong></p>
<p><strong>default charset=utf8;</strong></p>
<p><strong>charset utf8;</strong></p>
<p><strong>default charset utf8;</strong></p>
<p><strong>char set=utf8;</strong></p>
<p><strong>default char set=utf8;</strong></p>
<p><strong>char set utf8;</strong></p>
<p><strong>default char set utf8;</strong></p>
<p><strong>character set=utf8;</strong></p>
<p><strong>default character set=utf8;</strong></p>
<p><strong>character set utf8;</strong></p>
<p><strong>default character set utf8;</strong></p>
<p>使用<code>show create database db_name;</code>命令查看数据库创建语句：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create database dbking;</span><br><span class="line"></span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">| Database | Create Database |</span><br><span class="line"></span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">| dbking | CREATE DATABASE <span class="string">`dbking`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span> |</span><br><span class="line"></span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h5 id="2-4、为列分配校对规则"><a href="#2-4、为列分配校对规则" class="headerlink" title="2.4、为列分配校对规则"></a>2.4、为列分配校对规则</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>每个列都应该有一个校对，如果没有显示指定，MySQL就使用属于该字符集的默认校对</strong>。<strong>如果指定了一个字符集和一个校对，字符集应该放在前面</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table column_collate(</span><br><span class="line">    c1 varchar(10) charset utf8 collate utf8_romanian_ci not null,</span><br><span class="line"></span><br><span class="line">    c2 varchar(10) charset utf8 collate utf8_spanish_ci</span><br><span class="line">)engine=innodb;</span><br></pre></td></tr></table></figure>
<p>查看表的校验规则信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select table_name,column_name,collation_name</span><br><span class="line"></span><br><span class="line">from information_schema.columns</span><br><span class="line"></span><br><span class="line">where table_name=&apos;column_collate&apos;;</span><br><span class="line"></span><br><span class="line">+----------------+-------------+------------------+</span><br><span class="line"></span><br><span class="line">| table_name | column_name | collation_name |</span><br><span class="line"></span><br><span class="line">+----------------+-------------+------------------+</span><br><span class="line"></span><br><span class="line">| column_collate | c1 | utf8_romanian_ci |</span><br><span class="line"></span><br><span class="line">| column_collate | c2 | utf8_spanish_ci |</span><br><span class="line"></span><br><span class="line">+----------------+-------------+------------------+</span><br></pre></td></tr></table></figure>
<p>注意：字符集和校对在处理字符表达式的过程中扮演着重要角色。我们不能比较两个属于不同校对的不同字符值。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into column_collate(c1,c2) values(&apos;A&apos;,&apos;A&apos;);</span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.22 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from column_collate;</span><br><span class="line"></span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line">| c1 | c2 |</span><br><span class="line"></span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line">| A | A |</span><br><span class="line"></span><br><span class="line">+----+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from column_collate where c1=c2;</span><br><span class="line"></span><br><span class="line">ERROR 1267 (HY000): Illegal mix of collations (utf8_romanian_ci,IMPLICIT) and (utf8_spanish_ci,IMPLICIT) for operation &apos;=&apos;</span><br></pre></td></tr></table></figure>
<h5 id="2-5、为表指定校对规则"><a href="#2-5、为表指定校对规则" class="headerlink" title="2.5、为表指定校对规则"></a>2.5、为表指定校对规则</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table table_collate(</span><br><span class="line"></span><br><span class="line">    c1 varchar(10),</span><br><span class="line"></span><br><span class="line">    c2 varchar(10)</span><br><span class="line">)engine=innodb default charset utf8 collate utf8_romanian_ci;</span><br></pre></td></tr></table></figure>
<p>检查表的校对规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select table_name,column_name,collation_name from information_schema.columns where table_name=&apos;table_collate&apos;;</span><br><span class="line"></span><br><span class="line">+---------------+-------------+------------------+</span><br><span class="line"></span><br><span class="line">| table_name | column_name | collation_name |</span><br><span class="line"></span><br><span class="line">+---------------+-------------+------------------+</span><br><span class="line"></span><br><span class="line">| table_collate | c1 | utf8_romanian_ci |</span><br><span class="line"></span><br><span class="line">| table_collate | c2 | utf8_romanian_ci |</span><br><span class="line"></span><br><span class="line">+---------------+-------------+------------------+</span><br></pre></td></tr></table></figure>
<h5 id="2-6、为数据库指定校对规则"><a href="#2-6、为数据库指定校对规则" class="headerlink" title="2.6、为数据库指定校对规则"></a>2.6、为数据库指定校对规则</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database dbking102 default charset utf8 collate utf8_romanian_ci;</span><br></pre></td></tr></table></figure>
<p>查看数据库定义语句：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create database dbking102\G;</span><br><span class="line"></span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line"></span><br><span class="line">Database: dbking102</span><br><span class="line"></span><br><span class="line">Create Database: CREATE DATABASE <span class="string">`dbking102`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_romanian_ci */</span></span><br></pre></td></tr></table></figure>
<h5 id="2-7、字符直接量字符集"><a href="#2-7、字符直接量字符集" class="headerlink" title="2.7、字符直接量字符集"></a>2.7、字符直接量字符集</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如果没有显示指定，那么字符直接量的字符集就是数据库的默认字符集</strong>。<strong>如果要显示分配另一个字符集，需要把字符集的名字放在直接量前面，并且要在字符集前面加上下划线</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select _utf8&apos;语言 Language 言語 язык&apos;;</span><br><span class="line">+---------------------------------+</span><br><span class="line">| 语言 Language 言語 язык     |</span><br><span class="line">+---------------------------------+</span><br><span class="line">| 语言 Language 言語 язык     |</span><br><span class="line">+---------------------------------+</span><br></pre></td></tr></table></figure>
<h5 id="2-8、修改和设置MySQL服务器级别字符集"><a href="#2-8、修改和设置MySQL服务器级别字符集" class="headerlink" title="2.8、修改和设置MySQL服务器级别字符集"></a>2.8、修改和设置MySQL服务器级别字符集</h5><p>MySQL服务器支持众多不同的字符集，这类字符集可在编译时和运行时指定。</p>
<h6 id="1）-编译时指定"><a href="#1）-编译时指定" class="headerlink" title="1） 编译时指定"></a>1） 编译时指定</h6><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;编译时可指定默认字符集和默认校对规则，要想同时更改默认字符集和校对规则，要同时使用–with-charset和–with-collation选项。校对规则必须是字符集的合法校对规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure -- with-charset=CHARSET --with-collation=COLLATION</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过configure选项<code>--with-extra-charsets=LIST</code>，可以定义在服务器中再定义增加字符集。LIST 指下面任何一项：<br>    a.空格间隔的一系列字符集名<br>    b.complex -，以包括不能动态装载的所有字符集<br>    c.all –，以将所有字符集包括进二进制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure -- with-charset=CHARSET --with-collation=COLLATION --with-extra-charsets=all</span><br></pre></td></tr></table></figure>
<h6 id="2）-在参数文件my-cnf中指定"><a href="#2）-在参数文件my-cnf中指定" class="headerlink" title="2） 在参数文件my.cnf中指定"></a>2） 在参数文件my.cnf中指定</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">character_set_server=utf8</span><br></pre></td></tr></table></figure>
<p>​    –影响参数：<code>character_set_server 和 character_set_database</code></p>
<p>​    –注意：修改后要重启数据库才能生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"></span><br><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>
<p>​    –影响参数：<code>character_set_client，character_set_connection 和character_set_results</code>。</p>
<p>​    –注意：修改后无需重启数据库。<br>3） 在启动参数前指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysqld --character-set-server=utf8 &amp;</span><br></pre></td></tr></table></figure>
<p>​    –影响参数：<code>character_set_server 和 character_set_database</code><br>4）在mysql客户端登陆时通过–default-character-set指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pmysql --default-character-set=utf8</span><br></pre></td></tr></table></figure>
<p>–影响参数：<code>set character_set_client，set character_set_connection，set character_set_results</code>。</p>
<h6 id="5）临时指定"><a href="#5）临时指定" class="headerlink" title="5）临时指定"></a>5）临时指定</h6><p>a）分别指定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET character_set_client = utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; SET character_set_connection = utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; SET character_set_database = utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; SET character_set_results = utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; SET character_set_server = utf8;</span><br></pre></td></tr></table></figure>
<p>b）mysql客户端使用：set names utf8;</p>
<p>等同于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set character_set_client=utf8;</span><br><span class="line"></span><br><span class="line">set character_set_connection=utf8;</span><br><span class="line"></span><br><span class="line">set character_set_results=utf8;</span><br></pre></td></tr></table></figure>
<p>c）set character set utf8;</p>
<p>等同于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set character_set_client=utf8;</span><br><span class="line"></span><br><span class="line">set character_set_results=utf8;</span><br><span class="line"></span><br><span class="line">set collation_connection=@@collation_database;</span><br></pre></td></tr></table></figure>
<h4 id="3、总结"><a href="#3、总结" class="headerlink" title="3、总结"></a>3、总结</h4><blockquote>
<p>1）show character set;或show charset;     查看数据库支持的所有字符集</p>
<p>2）show variables like ‘char%’;                    查看系统字符集设置，包括所有的字符集设置</p>
<p>3）show table status from database_name like ‘%table_name%’;   查看database_name 数据库中表的字  符集设置</p>
<p>4）show full columns from table_name;<br>查看表列的字符集设置，关键是在同一个表中，每列可以设置成不同的字符集</p>
</blockquote>
<p>知道怎么查看字符集了，下面我来说下如何设置这些字符集</p>
<ol>
<li>修改服务器级<br>a. 临时更改：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SET GLOBAL character_set_server=utf8;</span><br></pre></td></tr></table></figure>
<p>​       b. 永久更改：</p>
<p>​           修改my.cnf文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>修改数据库级<br> a. 临时更改：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;SET GLOBAL character_set_database=utf8;</span><br></pre></td></tr></table></figure>
<p>​        b. 永久更改：<br>​        改了服务器级就可以了</p>
<ol start="3">
<li>修改表级</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;ALTER TABLE table_name DEFAULT CHARSET utf8;</span><br></pre></td></tr></table></figure>
<p>​    更改了后永久生效</p>
<ol start="4">
<li><p>更改连接字符集</p>
<p>a. 临时更改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set names utf8;</span><br></pre></td></tr></table></figure>
<p> b. 永久更改：<br>修改my.cnf文件<br>在[client]中增加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li><p>修改列级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;alter table `products` change `products_model` `products_model` varchar( 20 )</span><br><span class="line">        character set  utf8 collate utf8_general_ci null default null;</span><br></pre></td></tr></table></figure>
<p>更改了后永久生效</p>
</li>
</ol>
<p>执行SQL语句时信息的路径是这样的：</p>
<p><strong>信息输入路径：client→connection→server</strong>;</p>
<p><strong>信息输出路径：server→connection→results</strong>.</p>
<h3 id="四、MySQL数据库中字符集转换流程"><a href="#四、MySQL数据库中字符集转换流程" class="headerlink" title="四、MySQL数据库中字符集转换流程"></a>四、MySQL数据库中字符集转换流程</h3><p>1、MySQL Server收到请求时将请求数据从character_set_client转换为character_set_connection；</p>
<p>2、进行内部操作前将请求数据从character_set_connection转换为内部操作字符集，其确定方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用每个数据字段的CHARACTER SET设定值；</span><br><span class="line">	（1） 若上述值不存在，则使用对应数据表的DEFAULT CHARACTER SET设定值(MySQL扩展，非SQL标准)；</span><br><span class="line">	</span><br><span class="line">	（2） 若上述值不存在，则使用对应数据库的DEFAULT CHARACTER SET设定值；</span><br><span class="line">	</span><br><span class="line">	（3） 若上述值不存在，则使用character_set_server设定值。</span><br></pre></td></tr></table></figure>
<p>3、将操作结果从内部操作字符集转换为character_set_results；</p>
<p>下图源自于《高性能MySQL》中关于字符集转换的图解：</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集详解/669905-20170529003505047-1070819958.jpg" alt="clip_image002"></p>
<h3 id="五、MySQL数据库乱码原因解析及案例"><a href="#五、MySQL数据库乱码原因解析及案例" class="headerlink" title="五、MySQL数据库乱码原因解析及案例"></a>五、MySQL数据库乱码原因解析及案例</h3><h4 id="1、产生乱码的根本原因"><a href="#1、产生乱码的根本原因" class="headerlink" title="1、产生乱码的根本原因"></a>1、产生乱码的根本原因</h4><p>​    1）客户机没有正确地设置client字符集，导致原先的SQL语句被转换成connection所指字符集，而这种转换，是会丢失信息的，如果client是utf8格式，那么如果转换成gb2312格式，这其中必定会丢失信息，反之则不会丢失。一定要保证connection的字符集大于client字符集才能保证转换不丢失信息。</p>
<p>   2）数据库字体没有设置正确，如果数据库字体设置不正确，那么connection字符集转换成database字符集照样丢失编码，原因跟上面一样。</p>
<h4 id="2、乱码或数据丢失"><a href="#2、乱码或数据丢失" class="headerlink" title="2、乱码或数据丢失"></a>2、乱码或数据丢失</h4><p>​    character_set_client:我们要告诉服务器，我给你发送的数据是什么编码？</p>
<p>​    character_set_connection:告诉字符集转换器，转换成什么编码？</p>
<p>​    character_set_results:查询的结果用什么编码？</p>
<p>如果以上三者都为字符集N,可简写为set names ‘N’;</p>
<h5 id="2-1-乱码问题"><a href="#2-1-乱码问题" class="headerlink" title="2.1 乱码问题"></a>2.1 乱码问题</h5><p>模拟情景1：</p>
<p>向默认字符集为utf8的数据表插入utf8编码的数据前连接字符集设置为latin1，查询时设置连接字符集为utf8。</p>
<p>插入时根据MySQL服务器的默认设置，character_set_client、character_set_connection和character_set_results均为latin1；<br>插入操作的数据将经过latin1=&gt;latin1=&gt;utf8的字符集转换过程，这一过程中每个插入的汉字都会从原始的3个字节变成6个字节保存；<br>查询时的结果将经过utf8=&gt;utf8的字符集转换过程，将保存的6个字节原封不动返回，产生乱码……</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集详解/669905-20170529003507328-353636243.jpg" alt="clip_image004"></p>
<p><strong>例如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set names latin1;</span><br><span class="line"></span><br><span class="line">mysql&gt; create table temp(name varchar(10)) charset utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into temp values(&apos;中国&apos;);</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from temp;</span><br><span class="line"></span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line">| name |</span><br><span class="line"></span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line">| 中国 |</span><br><span class="line"></span><br><span class="line">+--------+</span><br><span class="line"></span><br><span class="line">mysql&gt; set names utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from temp;</span><br><span class="line"></span><br><span class="line">+---------------+</span><br><span class="line"></span><br><span class="line">| name |</span><br><span class="line"></span><br><span class="line">+---------------+</span><br><span class="line"></span><br><span class="line">| ä¸­å›½ |</span><br><span class="line"></span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure>
<p>注意：存储字符集编码比插入时字符集大时，如果原封不动返回数据会出现乱码，不过可通过修改查询字符集，避免乱码，即不会丢失数据。</p>
<h5 id="2-2-数据丢失问题"><a href="#2-2-数据丢失问题" class="headerlink" title="2.2 数据丢失问题"></a>2.2 数据丢失问题</h5><p>模拟情景1：</p>
<p>向默认字符集为latin1的数据表插入utf8编码的数据前设置了连接字符集为utf8<br>插入时根据连接字符集设置，character_set_client、character_set_connection和character_set_results均为utf8；<br>插入数据将经过utf8=&gt;utf8=&gt;latin1的字符集转换，若原始数据中含有\u0000~\u00ff范围以外的Unicode字 符，会因为无法在latin1字符集中表示而被转换为“?”(0×3F)符号，以后查询时不管连接字符集设置如何都无法恢复其内容了。</p>
<p><img src="//blog.com/2019/04/20/MySQL字符集详解/669905-20170529003509407-617465747.jpg" alt="clip_image006"></p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set names utf8;</span><br><span class="line"></span><br><span class="line">mysql&gt; create table temp(name varchar(10)) charset latin1;</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into temp values(&apos;中国&apos;);</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from temp;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| name |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| ?? |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; set names latin1;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from temp;</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| name |</span><br><span class="line"></span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">| ?? |</span><br><span class="line"></span><br><span class="line">+------+</span><br></pre></td></tr></table></figure>
<p>数据不完整了，且无法恢复。</p>
<h4 id="3、-乱码终极解决方案"><a href="#3、-乱码终极解决方案" class="headerlink" title="3、 乱码终极解决方案"></a>3、 乱码终极解决方案</h4><p>​        1）首先要明确你的客户端时候何种编码格式，这是最重要的（IE6一般用utf8，命令行一般是gbk，一般程序是gb2312)<br>​        2）确保你的数据库使用utf8格式，很简单，所有编码通吃。<br>​        3）一定要保证connection字符集大于等于client字符集，不然就会信息丢失，比如： latin1 &lt; gb2312 &lt; gbk &lt; utf8，若设置set character_set_client = gb2312，那么至少connection的字符集要大于等于gb2312，否则就会丢失信息<br>​        4）以上三步做正确的话，那么所有中文都被正确地转换成utf8格式存储进了数据库，为了适应不同的浏览器，不同的客户端，你可以修改character_set_results来以不同的编码显示中文字体，由于utf8是大方向，因此web应用是我还是倾向于使用utf8格式显示中文的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/各大厂分布式链路跟踪系统架构对比/" itemprop="url">各大厂分布式链路跟踪系统架构对比</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T12:12:57+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/分布式链路追踪/" itemprop="url" rel="index">
                    <span itemprop="name">分布式链路追踪</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="各大厂分布式链路跟踪系统架构对比"><a href="#各大厂分布式链路跟踪系统架构对比" class="headerlink" title="各大厂分布式链路跟踪系统架构对比"></a>各大厂分布式链路跟踪系统架构对比</h1><blockquote>
<p>原文地址：<a href="http://www.cnblogs.com/zhangs1986/p/8879744.html" target="_blank" rel="noopener">http://www.cnblogs.com/zhangs1986/p/8879744.html</a></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;随着互联网架构的扩张，分布式系统变得日趋复杂，越来越多的组件开始走向分布式化，如微服务、消息收发、分布式数据库、分布式缓存、分布式对象存储、跨域调用，这些组件共同构成了繁杂的分布式网络，那现在的问题是一个请求经过了这些服务后其中出现了一个调用失败的问题，只知道有异常，但具体的异常在哪个服务引起的就需要进入每一个服务里面看日志，这样的处理效率是非常低的。</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/1.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;分布式调用链其实就是将一次分布式请求还原成调用链路。显式的在后端查看一次分布式请求的调用情况，比如各个节点上的耗时、请求具体打到了哪台机器上、每个服务节点的请求状态等等。</p>
<h2 id="链路跟踪系统的功能"><a href="#链路跟踪系统的功能" class="headerlink" title="链路跟踪系统的功能"></a>链路跟踪系统的功能</h2><h3 id="故障快速定位"><a href="#故障快速定位" class="headerlink" title="故障快速定位"></a>故障快速定位</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;通过调用链跟踪，一次请求的逻辑轨迹可以用完整清晰的展示出来。开发中可以在业务日志中添加调用链ID，可以通过调用链结合业务日志快速定位错误信息。</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/2.webp" alt="img"></p>
<h3 id="各个调用环节的性能分析"><a href="#各个调用环节的性能分析" class="headerlink" title="各个调用环节的性能分析"></a>各个调用环节的性能分析</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;在调用链的各个环节分别添加调用时延，可以分析系统的性能瓶颈，进行针对性的优化。通过分析各个环节的平均时延，QPS等信息，可以找到系统的薄弱环节，对一些模块做调整，如数据冗余等。</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/3.webp" alt="img"></p>
<h3 id="数据分析等"><a href="#数据分析等" class="headerlink" title="数据分析等"></a>数据分析等</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;调用链绑定业务后查看具体每条业务数据对应的链路问题，可以得到用户的行为路径，经过了哪些服务器上的哪个服务，汇总分析应用在很多业务场景。</p>
<h3 id="生成服务调用拓扑图"><a href="#生成服务调用拓扑图" class="headerlink" title="生成服务调用拓扑图"></a>生成服务调用拓扑图</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;通过可视化分布式系统的模块和他们之间的相互联系来理解系统拓扑。点击某个节点会展示这个模块的详情，比如它当前的状态和请求数量。</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/4.webp" alt="img"></p>
<h2 id="分布式调用跟踪系统的设计"><a href="#分布式调用跟踪系统的设计" class="headerlink" title="分布式调用跟踪系统的设计"></a>分布式调用跟踪系统的设计</h2><h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><p><strong>低侵入性，应用透明</strong>：作为非业务组件，应当尽可能少侵入或者无侵入其他业务系统，对于使用方透明，减少开发人员的负担</p>
<p><strong>低损耗</strong>：服务调用埋点本身会带来性能损耗，这就需要调用跟踪的低损耗，实际中还会通过配置采样率的方式，选择一部分请求去分析请求路径</p>
<p><strong>大范围部署，扩展性</strong>：作为分布式系统的组件之一，一个优秀的调用跟踪系统必须支持分布式部署，具备良好的可扩展性</p>
<h3 id="埋点和生成日志"><a href="#埋点和生成日志" class="headerlink" title="埋点和生成日志"></a>埋点和生成日志</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;埋点即系统在当前节点的上下文信息，可以分为客户端埋点、服务端埋点，以及客户端和服务端双向型埋点。埋点日志通常要包含以下内容：</p>
<ol>
<li><p>TraceId、RPCId、调用的开始时间，调用类型，协议类型，调用方ip和端口，请求的服务名等信息；</p>
</li>
<li><p>调用耗时，调用结果，异常信息，消息报文等；</p>
</li>
<li><p>预留可扩展字段，为下一步扩展做准备；</p>
</li>
</ol>
<h3 id="抓取和存储日志"><a href="#抓取和存储日志" class="headerlink" title="抓取和存储日志"></a>抓取和存储日志</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;日志的采集和存储有许多开源的工具可以选择，一般来说，会使用离线+实时的方式去存储日志，主要是分布式日志采集的方式。典型的解决方案如Flume结合Kafka等MQ。</p>
<h3 id="分析和统计调用链数据"><a href="#分析和统计调用链数据" class="headerlink" title="分析和统计调用链数据"></a>分析和统计调用链数据</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;一条调用链的日志散落在调用经过的各个服务器上，首先需要按 TraceId 汇总日志，然后按照RpcId 对调用链进行顺序整理。用链数据不要求百分之百准确，可以允许中间的部分日志丢失。</p>
<h3 id="计算和展示"><a href="#计算和展示" class="headerlink" title="计算和展示"></a>计算和展示</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;汇总得到各个应用节点的调用链日志后，可以针对性的对各个业务线进行分析。需要对具体日志进行整理，进一步储存在HBase或者关系型数据库中，可以进行可视化的查询。</p>
<h2 id="链路跟踪Trace模型"><a href="#链路跟踪Trace模型" class="headerlink" title="链路跟踪Trace模型"></a>链路跟踪Trace模型</h2><p>一次典型的分布式调用过程，如下图所示：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/5.webp" alt="img"></p>
<p><strong>Trace调用模型，主要有以下概念：</strong></p>
<p>Trace：一次完整的分布式调用跟踪链路。</p>
<p>Span： 追踪服务调基本结构，表示跨服务的一次调用； 多span形成树形结构，组合成一次Trace追踪记录。</p>
<p>Annotation：在span中的标注点，记录整个span时间段内发生的事件。</p>
<p>BinaryAnnotation：可以认为是特殊的Annotation，用户自定义事件。</p>
<p>Annotation类型：保留类型</p>
<p>Cs CLIENT_SEND，客户端发起请求</p>
<p>Cr CLIENT_RECIEVE，客户端收到响应</p>
<p>Sr SERVER_RECIEVE，服务端收到请求</p>
<p>Ss SERVER_SEND，服务端发送结果</p>
<p><strong>用户自定义类型：</strong></p>
<p>Event 记录普通事件</p>
<p>Exception 记录异常事件</p>
<p>Client &amp;&amp; Server：对于跨服务的一次调用，请求发起方为client，服务提供方为server</p>
<p>各术语在一次分布式调用中，关系如下图所示：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/6.webp" alt="img"></p>
<h2 id="调用跟踪系统的选型"><a href="#调用跟踪系统的选型" class="headerlink" title="调用跟踪系统的选型"></a>调用跟踪系统的选型</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;大的互联网公司都有自己的分布式跟踪系统，比如Google的Dapper，Twitter的zipkin，淘宝的鹰眼，新浪的Watchman，京东的Hydra等，下面来简单分析。</p>
<h3 id="Google的Drapper"><a href="#Google的Drapper" class="headerlink" title="Google的Drapper"></a>Google的Drapper</h3><p>Dapper是Google生产环境下的分布式跟踪系统，Dapper有三个设计目标：</p>
<ol>
<li><p><strong>低消耗</strong>：跟踪系统对在线服务的影响应该做到足够小。</p>
</li>
<li><p><strong>应用级的透明</strong>：对于应用的程序员来说，是不需要知道有跟踪系统这回事的。如果一个跟踪系统想生效，就必须需要依赖应用的开发者主动配合，那么这个跟踪系统显然是侵入性太强的。</p>
</li>
<li><p><strong>延展性</strong>：Google至少在未来几年的服务和集群的规模，监控系统都应该能完全把控住。</p>
</li>
</ol>
<p>处理分为3个阶段：</p>
<p>① 各个服务将span数据写到<strong>本机日志</strong>上；</p>
<p>② dapper守护进程进行拉取，将数据读到<strong>dapper收集器</strong>里；</p>
<p>③ dapper收集器将结果写到<strong>bigtable</strong>中，<strong>一次跟踪被记录为一行</strong>。 </p>
<h3 id="阿里-鹰眼"><a href="#阿里-鹰眼" class="headerlink" title="阿里-鹰眼"></a>阿里-鹰眼</h3><p>关于淘宝的鹰眼系统，主要资料来自于内部分享：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/7.webp" alt="img"></p>
<p>鹰眼埋点和生成日志：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/8.webp" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如何抓取和存储日志，记录本地文件，使用额外的后台进程定期（时间间隔小）收集日志。这种方式的优势在于<strong>对应用的性能影响小，方便做消息堆积</strong>；但是<strong>需要在每台业务server上都部署并管理日志收集agent，运维量比较大</strong>。</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/9.webp" alt="img"></p>
<p>鹰眼的实现小结：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/10.webp" alt="img"></p>
<p><strong>注意Dapper与Eagle eye都不开源。</strong></p>
<h3 id="大众点评——CAT"><a href="#大众点评——CAT" class="headerlink" title="大众点评——CAT"></a>大众点评——CAT</h3><p>架构简单。可以实现一个Trace系统的所有功能。架构如下图所示：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/11.webp" alt="img"></p>
<h4 id="跟踪模型"><a href="#跟踪模型" class="headerlink" title="跟踪模型"></a>跟踪模型</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Transaction是最重要的事件消息类型，适合<strong>记录跨越系统边界的程序访问行为</strong>,比如远程调用，数据库调用，也适合执行时间较长的业务逻辑监控，记录次数与时间开销。Transaction可嵌套。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;跨服务的跟踪功能与点评内部的RPC框架集成，这部分未开源。</p>
<h4 id="客户端接入方式"><a href="#客户端接入方式" class="headerlink" title="客户端接入方式"></a>客户端接入方式</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;对于方法调用、sql、url请求等粒度较小的兴趣点，需要业务人员手写代码实现。</p>
<h4 id="日志收集方式"><a href="#日志收集方式" class="headerlink" title="日志收集方式"></a>日志收集方式</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;直接向日志收集器发异步请求（有本地内存缓存），一台客户端会连向几个服务端，当一个服务端出问题，数据不会丢失。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;当所有服务端都挂掉，消息会存入queue，当queue满了，就丢弃了，没有做数据存储本地等工作。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;全量采样，系统繁忙的时候对性能影响较大（可能达到10%的影响）</p>
<h3 id="京东-hydra"><a href="#京东-hydra" class="headerlink" title="京东-hydra"></a>京东-hydra</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;与dubbo框架集成。对于服务级别的跟踪统计，现有业务可以无缝接入。对于细粒度的兴趣点，需要业务人员手动添加。架构如下：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/12.webp" alt="img"></p>
<h4 id="Hydra中跟踪数据模型"><a href="#Hydra中跟踪数据模型" class="headerlink" title="Hydra中跟踪数据模型"></a>Hydra中跟踪数据模型</h4><p>Trace：一次服务调用追踪链路。</p>
<p>Span：追踪服务调基本结构，多span形成树形结构组合成一次Trace追踪记录。</p>
<p>Annotation：在span中的标注点，记录整个span时间段内发生的事件。</p>
<p>BinaryAnnotation：属于Annotation一种类型和普通Annotation区别，这键值对形式标注在span中发生的事件，和一些其他相关的信息。</p>
<h4 id="日志收集方式-1"><a href="#日志收集方式-1" class="headerlink" title="日志收集方式"></a>日志收集方式</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;与CAT类似。支持自适应采样，规则粗暴简单，对于每秒钟的请求次数进行统计，如果超过100，就按照10%的比率进行采样。</p>
<h3 id="Twitter—OpenZipkin"><a href="#Twitter—OpenZipkin" class="headerlink" title="Twitter—OpenZipkin"></a>Twitter—OpenZipkin</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;功能、数据跟踪模型与hydra类似。Zipkin本身不开源，开源社区的是另外一套scala实现，依托于finagle这个RPC框架。架构如下：</p>
<p><img src="//blog.com/2019/04/16/各大厂分布式链路跟踪系统架构对比/13.webp" alt="img"></p>
<p>Zipkin与其他Trace系统的不同之处在于：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Zipkin中针对 HttpClient、jax-rs2、jersey/jersey2等HTTP客户端封装了拦截器。可以在较小的代码侵入条件下实现URl请求的拦截、时间统计和日志记录等操作。</p>
<h4 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Cat是直接将日志发往消费集群；hydra是发给日志收集器，日志收集器推到消息队列；Zipkin的client将统计日志发往消息队列，日志收集器读取后落地存储；Dapper和Eagle eye是记录本地文件，后台进程定期扫描。</p>
<h2 id="Trace系统现状分析"><a href="#Trace系统现状分析" class="headerlink" title="Trace系统现状分析"></a><strong>Trace系统现状分析</strong></h2><p>&nbsp;&nbsp;&nbsp;&nbsp;以上几款链路跟踪系统都各自满足了请求链路追踪的功能，但落实到我们自己的生产环境中时，这些Trace系统存在诸多问题：Google和alibaba的Trace系统不开源，但现阶段来说阿里是做得最好的，如果用的是阿里的服务器，可考虑直接用阿里的追踪系统以节省开发代价；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;京东和点评的虽然开源，但是已经多年没有维护，项目依赖的jdk版本以及第三方框架过于陈旧等等，不适合用在生产环境中；</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Twitter的OpenZipkin使用scala开发，而且其实现基于twitter内部的RPC框架finagle，第三方依赖比较多，接入和运维的成本非常高。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果不是用阿里的服务，我们可以借鉴这些开源实现的思想, 自行开发Trace系统。那是自己从0开始开发还是基于开源方案二次开发？ 这里面也要考虑到跨平台，如NET和java环境，尽量减少原系统的侵入性或只需要更改少量的代码即可接入，在这里可以基于zipkin和pinpoint进行二次开发，功能可参考阿里的系统。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/16/Dapper，大规模分布式系统的跟踪系统/" itemprop="url">Dapper，大规模分布式系统的跟踪系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T12:12:57+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/分布式链路追踪/" itemprop="url" rel="index">
                    <span itemprop="name">分布式链路追踪</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Dapper，大规模分布式系统的跟踪系统"><a href="#Dapper，大规模分布式系统的跟踪系统" class="headerlink" title="Dapper，大规模分布式系统的跟踪系统"></a>Dapper，大规模分布式系统的跟踪系统</h1><blockquote>
<p>原文地址：<a href="http://bigbully.github.io/Dapper-translation/" target="_blank" rel="noopener">http://bigbully.github.io/Dapper-translation/</a></p>
</blockquote>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;当代的互联网的服务，通常都是用复杂的、大规模分布式集群来实现的。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper–Google生产环境下的分布式跟踪系统，应运而生。那么我们就来介绍一个大规模集群的跟踪系统，它是如何满足一个低损耗、应用透明的、大范围部署这三个需求的。当然Dapper设计之初，参考了一些其他分布式系统的理念，尤其是Magpie和X-Trace，但是我们之所以能成功应用在生产环境上，还需要一些画龙点睛之笔，例如采样率的使用以及把代码植入限制在一小部分公共库的改造上。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;自从Dapper发展成为一流的监控系统之后，给其他应用的开发者和运维团队帮了大忙，所以我们今天才发表这篇论文，来汇报一下这两年来，Dapper是怎么构建和部署的。Dapper最初只是作为一个自给自足的监控工具起步的，但最终进化成一个监控平台，这个监控平台促生出多种多样的监控工具，有些甚至已经不是由Dapper团队开发的了。下面我们会介绍一些使用Dapper搭建的分析工具，分享一下这些工具在google内部使用的统计数据，展现一些使用场景，最后会讨论一下我们迄今为止从Dapper收获了些什么。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;我们<strong>开发Dapper是为了收集更多的复杂分布式系统的行为信息，然后呈现给Google的开发者们</strong>。这样的分布式系统有一个特殊的好处，因为那些大规模的低端服务器，作为互联网服务的载体，是一个特殊的经济划算的平台。<strong>想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;下面举一个跟搜索相关的例子，这个例子阐述了Dapper可以应对哪些挑战。比如一个前段服务可能对上百台查询服务器发起了一个Web查询，每一个查询都有自己的Index。这个查询可能会被发送到多个的子系统，这些子系统分别用来处理广告、进行拼写检查或是查找一些像图片、视频或新闻这样的特殊结果。根据每个子系统的查询结果进行筛选，得到最终结果，最后汇总到页面上。我们把这种搜索模型称为“全局搜索”（universal search）。总的来说，这一次全局搜索有可能调用上千台服务器，涉及各种服务。而且，用户对搜索的耗时是很敏感的，而任何一个子系统的低效都导致导致最终的搜索耗时。如果一个工程师只能知道这个查询耗时不正常，但是他无从知晓这个问题到底是由哪个服务调用造成的，或者为什么这个调用性能差强人意。首先，这个工程师可能无法准确的定位到这次全局搜索是调用了哪些服务，因为新的服务、乃至服务上的某个片段，都有可能在任何时间上过线或修改过，有可能是面向用户功能，也有可能是一些例如针对性能或安全认证方面的功能改进。其次，你不能苛求这个工程师对所有参与这次全局搜索的服务都了如指掌，每一个服务都有可能是由不同的团队开发或维护的。再次，这些暴露出来的服务或服务器有可能同时还被其他客户端使用着，所以这次全局搜索的性能问题甚至有可能是由其他应用造成的。举个例子，一个后台服务可能要应付各种各样的请求类型，而一个使用效率很高的存储系统，比如Bigtable，有可能正被反复读写着，因为上面跑着各种各样的应用。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;上面这个案例中我们可以看到，<strong>对Dapper我们只有两点要求：无所不在的部署，持续的监控</strong>。无所不在的重要性不言而喻，因为在使用跟踪系统的进行监控时，即便只有一小部分没被监控到，那么人们对这个系统是不是值得信任都会产生巨大的质疑。另外，监控应该是7x24小时的，毕竟，系统异常或是那些重要的系统行为有可能出现过一次，就很难甚至不太可能重现。那么，根据这两个明确的需求，我们可以直接推出三个具体的设计目标：</p>
<ol>
<li><p><strong>低消耗</strong>：跟踪系统对在线服务的影响应该做到足够小。在一些高度优化过的服务，即使一点点损耗也会很容易察觉到，而且有可能迫使在线服务的部署团队不得不将跟踪系统关停。</p>
</li>
<li><p><strong>应用级的透明</strong>：对于应用的程序员来说，是不需要知道有跟踪系统这回事的。如果一个跟踪系统想生效，就必须需要依赖应用的开发者主动配合，那么这个跟踪系统也太脆弱了，往往由于跟踪系统在应用中植入代码的bug或疏忽导致应用出问题，这样才是无法满足对跟踪系统“无所不在的部署”这个需求。面对当下想Google这样的快节奏的开发环境来说，尤其重要。</p>
</li>
<li><p><strong>延展性</strong>：Google至少在未来几年的服务和集群的规模，监控系统都应该能完全把控住。</p>
</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>一个额外的设计目标是为跟踪数据产生之后，进行分析的速度要快，理想情况是数据存入跟踪仓库后一分钟内就能统计出来</strong>。尽管跟踪系统对一小时前的旧数据进行统计也是相当有价值的，但如果跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>做到真正的应用级别的透明，这应该是当下面临的最挑战性的设计目标，我们把核心跟踪代码做的很轻巧，然后把它植入到那些无所不在的公共组件种，比如线程调用、控制流以及RPC库</strong>。<strong>使用自适应的采样率可以使跟踪系统变得可伸缩，并降低性能损耗</strong>，这些内容将在第4.4节中提及。结果展示的相关系统也需要包含一些用来收集跟踪数据的代码，用来图形化的工具，以及用来分析大规模跟踪数据的库和API。虽然单独使用Dapper有时就足够让开发人员查明异常的来源，但是Dapper的初衷不是要取代所有其他监控的工具。我们发现，Dapper的数据往往侧重性能方面的调查，所以其他监控工具也有他们各自的用处。</p>
<h3 id="1-1-文献的总结"><a href="#1-1-文献的总结" class="headerlink" title="1.1 文献的总结"></a>1.1 文献的总结</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;分布式系统跟踪工具的设计空间已经被一些优秀文章探索过了，其中的Pinpoint[9]、Magpie[3]和X-Trace[12]和Dapper最为相近。这些系统在其发展过程的早期倾向于写入研究报告中，即便他们还没来得及清楚地评估系统当中一些设计的重要性。相比之下，由于Dapper已经在大规模生产环境中摸爬滚打了多年，经过这么多生产环境的验证之后，我们认为这篇论文最适合重点阐述在部署Dapper的过程中我们有那些收获，我们的设计思想是如何决定的，以及以什么样的方式实现它才会最有用。Dappe作为一个平台，承载基于Dapper开发的性能分析工具，以及Dapper自身的监测工具，它的价值在于我们可以在回顾评估中找出一些意想不到的结果。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;虽然Dapper在许多高阶的设计思想上吸取了Pinpoint和Magpie的研究成果，但在分布式跟踪这个领域中，Dapper的实现包含了许多新的贡献。例如，我们想实现低损耗的话，特别是在高度优化的而且趋于极端延迟敏感的Web服务中，采样率是很必要的。或许更令人惊讶的是，我们发现即便是1/1000的采样率，对于跟踪数据的通用使用层面上，也可以提供足够多的信息。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们的系统的另一个重要的特征，就是我们<strong>能实现的应用级的透明。我们的组件对应用的侵入被先限制在足够低的水平上</strong>，即使想Google网页搜索这么大规模的分布式系统，也可以直接进行跟踪而无需加入额外的标注(Annotation)。虽然由于我们的部署系统有幸是一定程度的同质化的，所以更容易做到对应用层的透明这点，但是我们证明了这是实现这种程度的透明性的充分条件。</p>
<h2 id="Dapper的分布式跟踪"><a href="#Dapper的分布式跟踪" class="headerlink" title="Dapper的分布式跟踪"></a>Dapper的分布式跟踪</h2><p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/1.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图1：这个路径由用户的X请求发起，穿过一个简单的服务系统。用字母标识的节点代表分布式系统中的不同处理过程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>分布式服务的跟踪系统需要记录在一次特定的请求后系统中完成的所有工作的信息</strong>。举个例子，图1展现的是一个和5台服务器相关的一个服务，包括：前端（A），两个中间层（B和C），以及两个后端（D和E）。当一个用户（这个用例的发起人）发起一个请求时，首先到达前端，然后发送两个RPC到服务器B和C。B会马上做出反应，但是C需要和后端的D和E交互之后再返还给A，由A来响应最初的请求。对于这样一个请求，简单实用的分布式跟踪的实现，就是为服务器上每一次你发送和接收动作来收集跟踪标识符(message identifiers)和时间戳(timestamped events)。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;为了将所有记录条目与一个给定的发起者（例如，图1中的RequestX）关联上并记录所有信息，现在有两种解决方案，黑盒(black-box)和基于标注(annotation-based)的监控方案。黑盒方案假定需要跟踪的除了上述信息之外没有额外的信息，这样使用统计回归技术来推断两者之间的关系。<strong>基于标注的方案依赖于应用程序或中间件明确地标记一个全局ID，从而连接每一条记录和发起者的请求</strong>。虽然黑盒方案比标注方案更轻便，他们需要更多的数据，以获得足够的精度，因为他们依赖于统计推论。<strong>基于标注的方案最主要的缺点是，很明显，需要代码植入</strong>。<strong>在我们的生产环境中，因为所有的应用程序都使用相同的线程模型，控制流和RPC系统，我们发现，可以把代码植入限制在一个很小的通用组件库中，从而实现了监测系统的应用对开发人员是有效地透明</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们倾向于认为，Dapper的跟踪架构像是内嵌在RPC调用的<strong>树形结构</strong>。然而，我们的核心数据模型不只局限于我们的特定的RPC框架，我们还能跟踪其他行为，例如Gmail的SMTP会话，外界的HTTP请求，和外部对SQL服务器的查询等。从形式上看，我们的Dapper跟踪模型使用的树形结构，Span以及Annotation。</p>
<h3 id="跟踪树和span"><a href="#跟踪树和span" class="headerlink" title="跟踪树和span"></a>跟踪树和span</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>在Dapper跟踪树结构中，树节点是整个架构的基本单元，而每一个节点又是对span的引用</strong>。<strong>节点之间的连线表示的span和它的父span直接的关系</strong>。虽然span在日志文件中只是简单的代表span的开始和结束时间，他们在整个树形结构中却是相对独立的，任何RPC相关的时间数据、零个或多个特定应用程序的Annotation的相关内容会在2.3节中讨论。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/2.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图2：5个span在Dapper跟踪树种短暂的关联关系</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在图2中说明了span在一个大的跟踪过程中是什么样的。</p>
<ol>
<li><p><strong>Dapper记录了span名称，以及每个span的ID和父ID，以重建在一次追踪过程中不同span之间的关系</strong>。</p>
</li>
<li><p><strong>如果一个span没有父ID被称为root span。所有span都挂在一个特定的跟踪上，也共用一个跟踪id</strong>（在图中未示出）。</p>
</li>
<li><p><strong>所有这些ID用全局唯一的64位整数标示</strong>。</p>
</li>
<li><p><strong>在一个典型的Dapper跟踪中，我们希望为每一个RPC对应到一个单一的span上，而且每一个额外的组件层都对应一个跟踪树型结构的层级</strong>。</p>
</li>
</ol>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/3.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图3：在图2中所示的一个单独的span的细节图</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图3给出了一个更详细的典型的Dapper跟踪span的记录点的视图。在图2中这种某个span表述了两个“Helper.Call”的RPC(分别为server端和client端)。</p>
<ol>
<li><strong>span的开始时间和结束时间，以及任何RPC的时间信息都通过Dapper在RPC组件库的植入记录下来</strong>。</li>
<li><strong>如果应用程序开发者选择在跟踪中增加他们自己的注释（如图中“foo”的注释）(业务数据)，这些信息也会和其他span信息一样记录下来</strong>。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;记住，<strong>任何一个span可以包含来自不同的主机信息，这些也要记录下来</strong>。事实上，每一个RPC span可以包含客户端和服务器两个过程的注释，使得链接两个主机的span会成为模型中所说的span。<strong>由于客户端和服务器上的时间戳来自不同的主机，我们必须考虑到时间偏差</strong>。在我们的分析工具，我们利用了这个事实：<strong>RPC客户端发送一个请求之后，服务器端才能接收到，对于响应也是一样的（服务器先响应，然后客户端才能接收到这个响应）</strong>。这样一来，<strong>服务器端的RPC就有一个时间戳的一个上限和下限</strong>。</p>
<h3 id="植入点"><a href="#植入点" class="headerlink" title="植入点"></a>植入点</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper可以以对应用开发者近乎零浸入的成本对分布式控制路径进行跟踪，几乎完全依赖于基于少量通用组件库的改造。如下：</p>
<ul>
<li>当一个线程在处理跟踪控制路径的过程中，Dapper把这次跟踪的上下文的在ThreadLocal中进行存储。追踪上下文是一个小而且容易复制的容器，其中承载了Scan的属性比如跟踪ID和span ID。</li>
<li>当计算过程是延迟调用的或是异步的，大多数Google开发者通过线程池或其他执行器，使用一个通用的控制流库来回调。Dapper确保所有这样的回调可以存储这次跟踪的上下文，而当回调函数被触发时，这次跟踪的上下文会与适当的线程关联上。在这种方式下，Dapper可以使用trace ID和span ID来辅助构建异步调用的路径。</li>
<li>几乎所有的Google的进程间通信是建立在一个用C++和Java开发的RPC框架上。我们把跟踪植入该框架来定义RPC中所有的span。span的ID和跟踪的ID会从客户端发送到服务端。像那样的基于RPC的系统被广泛使用在Google中，这是一个重要的植入点。当那些非RPC通信框架发展成熟并找到了自己的用户群之后，我们会计划对RPC通信框架进行植入。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Dapper的跟踪数据是独立于语言的</strong>，很多在生产环境中的跟踪结合了用C++和Java写的进程的数据。在3.2节中，我们讨论应用程序的透明度时我们会把这些理论的是如何实践的进行讨论。</p>
<h3 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h3><p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/4.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;上述植入点足够推导出复杂的分布式系统的跟踪细节，使得Dapper的核心功能在不改动Google应用的情况下可用。然而，<strong>Dapper还允许应用程序开发人员在Dapper跟踪的过程中添加额外的信息，以监控更高级别的系统行为，或帮助调试问题</strong>。<strong>我们允许用户通过一个简单的API定义带时间戳的Annotation</strong>，核心的示例代码入图4所示。<strong>这些Annotation可以添加任意内容。为了保护Dapper的用户意外的过分热衷于日志的记录，每一个跟踪span有一个可配置的总Annotation量的上限</strong>。但是，<strong>应用程序级的Annotation是不能替代用于表示span结构的信息和记录着RPC相关的信息</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>除了简单的文本Annotation，Dapper也支持的key-value映射的 Annotation，提供给开发人员更强的跟踪能力，如持续的计数器，二进制消息记录和在一个进程上跑着的任意的用户数据</strong>。<strong>键值对的Annotation方式用来在分布式追踪的上下文中定义某个特定应用程序的相关类型</strong>。</p>
<h3 id="采样率"><a href="#采样率" class="headerlink" title="采样率"></a>采样率</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;低损耗的是Dapper的一个关键的设计目标，因为如果这个工具价值未被证实但又对性能有影响的话，你可以理解服务运营人员为什么不愿意部署它。况且，我们想让开发人员使用Annotation的API，而不用担心额外的开销。我们还发现，某些类型的Web服务对植入带来的性能损耗确实非常敏感。因此，除了把Dapper的收集工作对基本组件的性能损耗限制的尽可能小之外，我们还有<strong>进一步控制损耗的办法，那就是遇到大量请求时只记录其中的一小部分</strong>。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/5.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图5：Dapper收集管道的总览</p>
<h3 id="跟踪的收集"><a href="#跟踪的收集" class="headerlink" title="跟踪的收集"></a>跟踪的收集</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dapper的跟踪记录和收集管道的过程分为三个阶段（参见图5）。</p>
<ol>
<li><p>首先，span数据写入（1）<strong>本地日志文件</strong>中。</p>
</li>
<li><p>Dapper的<strong>守护进程和收集组件把这些数据从生产环境的主机中拉出来</strong>（2）</p>
</li>
<li><p>最终写到（3）Dapper的<strong>Bigtable仓库</strong>中。<strong>一次跟踪被设计成Bigtable中的一行，每一列相当于一个span</strong>。Bigtable的支持稀疏表格布局正适合这种情况，因为每一次跟踪可以有任意多个span。</p>
</li>
</ol>
<p>   &nbsp;&nbsp;&nbsp;&nbsp;跟踪数据收集（即从应用中的二进制数据传输到中央仓库所花费的时间）的延迟中位数少于15秒。第98百分位的延迟(The 98th percentile latency)往往随着时间的推移呈现双峰型;大约75%的时间，第98百分位的延迟时间小于2分钟，但是另外大约25%的时间，它可以增涨到几个小时。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dapper还提供了一个API来简化访问我们仓库中的跟踪数据。 Google的开发人员用这个API，以构建通用和特定应用程序的分析工具。第5.1节包含更多如何使用它的信息。</p>
<h4 id="带外数据跟踪收集"><a href="#带外数据跟踪收集" class="headerlink" title="带外数据跟踪收集"></a>带外数据跟踪收集</h4><p>tip1:带外数据:传输层协议使用带外数据(out-of-band，OOB)来发送一些重要的数据,如果通信一方有重要的数据需要通知对方时,协议能够将这些数据快速地发送到对方。为了发送这些数据，协议一般不使用与普通数据相同的通道,而是使用另外的通道。</p>
<p>tip2:这里指的in-band策略是把跟踪数据随着调用链进行传送，out-of-band是通过其他的链路进行跟踪数据的收集，Dapper的写日志然后进行日志采集的方式就属于out-of-band策略</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper系统请求树树自身进行跟踪记录和收集带外数据。这样做是为两个不相关的原因。首先，带内收集方案–这里跟踪数据会以RPC响应头的形式被返回–会影响应用程序网络动态。在Google里的许多规模较大的系统中，一次跟踪成千上万的span并不少见。然而，RPC回应大小–甚至是接近大型分布式的跟踪的根节点的这种情况下– 仍然是比较小的：通常小于10K。在这种情况下，带内Dapper的跟踪数据会让应用程序数据和倾向于使用后续分析结果的数据量相形见绌。其次，带内收集方案假定所有的RPC是完美嵌套的。我们发现，在所有的后端的系统返回的最终结果之前，有许多中间件会把结果返回给他们的调用者。带内收集系统是无法解释这种非嵌套的分布式执行模式的。</p>
<h3 id="安全和隐私考虑"><a href="#安全和隐私考虑" class="headerlink" title="安全和隐私考虑"></a>安全和隐私考虑</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;记录一定量的RPC有效负载信息将丰富Dapper的跟踪能力，因为分析工具能够在<strong>有效载荷数据（方法传递的参数）</strong>中找到相关的样例，这些样例可以解释被监控系统的为何表现异常。然而，有些情况下，有效载荷数据可能包含的一些不应该透露给未经授权用户(包括正在debug的工程师)的内部信息。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由于安全和隐私问题是不可忽略的，<strong>dapper中的虽然存储RPC方法的名称，但在这个时候不记录任何有效载荷数据</strong>。<strong>相反，应用程序级别的Annotation提供了一个方便的可选机制：应用程序开发人员可以在span中选择关联那些为以后分析提供价值的数据</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper还提供了一些安全上的便利，是它的设计者事先没有预料到的。通过跟踪公开的安全协议参数，<strong>Dapper可以通过相应级别的认证或加密，来监视应用程序是否满足安全策略</strong>。例如。Dapper还可以提供信息，以基于策略的的隔离系统按预期执行，例如支撑敏感数据的应用程序不与未经授权的系统组件进行了交互。这样的测算提供了比源码审核更强大的保障。</p>
<h2 id="Dapper部署状况"><a href="#Dapper部署状况" class="headerlink" title="Dapper部署状况"></a>Dapper部署状况</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper作为我们生产环境下的跟踪系统已经超过两年。在本节中，我们会汇报系统状态，把重点放在Dapper如何满足了我们的目标——无处不在的部署和应用级的透明。</p>
<h3 id="Dapper运行库"><a href="#Dapper运行库" class="headerlink" title="Dapper运行库"></a>Dapper运行库</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;也许<strong>Dapper代码中中最关键的部分，就是对基础RPC、线程控制和流程控制的组件库的植入，其中包括span的创建，采样率的设置，以及把日志写入本地磁盘</strong>。除了做到轻量级，植入的代码更需要稳定和健壮，因为它与海量的应用对接，维护和bug修复变得困难。植入的核心代码是由未超过1000行的C++和不超过800行Java代码组成。为了支持键值对的Annotation还添加了额外的500行代码。</p>
<h3 id="生产环境下的涵盖面"><a href="#生产环境下的涵盖面" class="headerlink" title="生产环境下的涵盖面"></a>生产环境下的涵盖面</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Dapper的渗透可以总结为两个方面：一方面是可以创建Dapper跟踪的过程(与Dapper植入的组件库相关)，和生产环境下的服务器上在运行Dapper跟踪收集守护进程</strong>。Dapper的守护进程的分布相当于我们服务器的简单的拓扑图，它存在于Google几乎所有的服务器上。这很难确定精确的Dapper-ready进程部分，因为过程即便不产生跟踪信息Dapper也是无从知晓的。尽管如此，考虑到无处不在Dapper组件的植入库，我们估计几乎每一个Google的生产进程都是支持跟踪的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在某些情况下Dapper的是不能正确的跟踪控制路径的。这些通常源于使用非标准的控制流，或是Dapper的错误的把路径关联归到不相关的事件上。Dapper提供了一个简单的库来帮助开发者手动控制跟踪传播作为一种变通方法。目前有40个C++应用程序和33个Java应用程序需要一些手动控制的追踪传播，不过这只是上千个的跟踪中的一小部分。也有非常小的一部分程序使用的非组件性质的通信库（比如原生的TCP Socket或SOAP RPC），因此不能直接支持Dapper的跟踪。但是这些应用可以单独接入到Dapper中，如果需要的话。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;考虑到生产环境的安全，Dapper的跟踪也可以关闭。事实上，它在部署的早起就是默认关闭的，直到我们对Dapper的稳定性和低损耗有了足够的信心之后才把它开启。Dapper的团队偶尔会执行审查寻找跟踪配置的变化，来看看那些服务关闭了Dapper的跟踪。但这种情况不多见，而且通常是源于对监控对性能消耗的担忧。经过了对实际性能消耗的进一步调查和测量，所有这些关闭Dapper跟踪都已经恢复开启了，不过这些已经不重要了。</p>
<h3 id="跟踪Annotation的使用"><a href="#跟踪Annotation的使用" class="headerlink" title="跟踪Annotation的使用"></a>跟踪Annotation的使用</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;程序员倾向于使用特定应用程序的Annotation，无论是<strong>作为一种分布式调试日志文件</strong>，还是<strong>通过一些应用程序特定的功能对跟踪进行分类</strong>。例如，所有的Bigtable的请求会把被访问的表名也记录到Annotation中。目前，70％的Dapper span和90％的所有Dapper跟踪都至少有一个特殊应用的Annotation。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;41个Java应用和68个C++应用中都<strong>添加自定义的Annotation为了更好地理解应用程序中的span在他们的服务中的行为</strong>。值得注意的是，迄今为止我们的Java开发者比C++开发者更多的在每一个跟踪span上采用Annotation的API。这可能是因为我们的Java应用的作用域往往是更接近最终用户(C++偏底层);这些类型的应用程序经常处理更广泛的请求组合，因此具有比较复杂的控制路径。</p>
<h2 id="处理跟踪损耗"><a href="#处理跟踪损耗" class="headerlink" title="处理跟踪损耗"></a>处理跟踪损耗</h2><p>跟踪系统的成本由两部分组成：</p>
<ol>
<li><p><strong>正在被监控的系统在生成追踪和收集追踪数据的消耗导致系统性能下降</strong></p>
</li>
<li><p><strong>需要使用一部分资源来存储和分析跟踪数据</strong>。虽然你可以说一个有价值的组件植入跟踪带来一部分性能损耗是值得的，我们相信如果基本损耗能达到可以忽略的程度，那么对跟踪系统最初的推广会有极大的帮助。</p>
</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在本节中，我们会展现一下三个方面：Dapper组件操作的消耗，跟踪收集的消耗，以及Dapper对生产环境负载的影响。我们还介绍了Dapper可调节的采样率机制如何帮我们处理低损耗和跟踪代表性之间的平衡和取舍。</p>
<h3 id="生成跟踪的损耗"><a href="#生成跟踪的损耗" class="headerlink" title="生成跟踪的损耗"></a>生成跟踪的损耗</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;生成跟踪的开销是Dapper性能影响中最关键的部分，因为收集和分析可以更容易在紧急情况下被关闭。<strong>Dapper运行库中最重要的跟踪生成消耗在于创建和销毁span和annotation，并记录到本地磁盘供后续的收集</strong>。根span的创建和销毁需要损耗平均204纳秒的时间，而同样的操作在其他span上需要消耗176纳秒。时间上的差别主要在于需要在跟span上给这次跟踪分配一个全局唯一的ID。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果一个span没有被采样的话，那么这个额外的span下创建annotation的成本几乎可以忽略不计，他由在Dapper运行期对ThreadLocal查找操作构成，这平均只消耗9纳秒。如果这个span被计入采样的话，会用一个用字符串进行标注–在图4中有展现–平均需要消耗40纳秒。这些数据都是在2.2GHz的x86服务器上采集的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>在Dapper运行期写入到本地磁盘是最昂贵的操作，但是他们的可见损耗大大减少，因为写入日志文件和操作相对于被跟踪的应用系统来说都是异步的</strong>。不过，日志写入的操作如果在大流量的情况，尤其是每一个请求都被跟踪的情况下就会变得可以察觉到。我们记录了在4.3节展示了一次Web搜索的负载下的性能消耗。</p>
<h3 id="跟踪收集的消耗"><a href="#跟踪收集的消耗" class="headerlink" title="跟踪收集的消耗"></a>跟踪收集的消耗</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;读出跟踪数据也会对正在被监控的负载产生干扰。表1展示的是最坏情况下，Dapper收集日志的守护进程在高于实际情况的负载基准下进行测试时的cpu使用率。在生产环境下，跟踪数据处理中，这个守护进程从来没有超过0.3%的单核cpu使用率，而且只有很少量的内存使用（以及堆碎片的噪音）。我们还限制了Dapper守护进程为内核scheduler最低的优先级，以防在一台高负载的服务器上发生cpu竞争。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper也是一个带宽资源的轻量级的消费者，每一个span在我们的仓库中传输只占用了平均426的byte。作为网络行为中的极小部分，Dapper的数据收集在Google的生产环境中的只占用了0.01%的网络资源。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/6.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;表1：Dapper守护进程在负载测试时的CPU资源使用率</p>
<h3 id="在生产环境下对负载的影响"><a href="#在生产环境下对负载的影响" class="headerlink" title="在生产环境下对负载的影响"></a>在生产环境下对负载的影响</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;每个请求都会利用到大量的服务器的高吞吐量的线上服务，这是对有效跟踪最主要的需求之一；这种情况需要生成大量的跟踪数据，并且他们对性能的影响是最敏感的。在表2中我们用集群下的网络搜索服务作为例子，我们通过调整采样率，来衡量Dapper在延迟和吞吐量方面对性能的影响。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/7.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;表2：网络搜索集群中，对不同采样率对网络延迟和吞吐的影响。延迟和吞吐的实验误差分别是2.5%和0.15%。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们看到，虽然对吞吐量的影响不是很明显，但为了避免明显的延迟，跟踪的采样还是必要的。然而，延迟和吞吐量的带来的损失在把采样率调整到小于1/16之后就全部在实验误差范围内。在实践中，我们发现即便采样率调整到1/1024仍然是有足够量的跟踪数据的用来跟踪大量的服务。保持Dapper的性能损耗基线在一个非常低的水平是很重要的，因为它为那些应用提供了一个宽松的环境使用完整的Annotation API而无惧性能损失。<strong>使用较低的采样率还有额外的好处，可以让持久化到硬盘中的跟踪数据在垃圾回收机制处理之前保留更长的时间，这样为Dapper的收集组件给了更多的灵活性</strong>。</p>
<h2 id="可变采样"><a href="#可变采样" class="headerlink" title="可变采样"></a>可变采样</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>任何给定进程的Dapper的消耗和每个进程单位时间的跟踪的采样率成正比</strong>。Dapper的第一个生产版本在Google内部的所有进程上使用统一的采样率，为1/1024。这个简单的方案是对我们的高吞吐量的线上服务来说是非常有用，因为那些感兴趣的事件(在大吞吐量的情况下)仍然很有可能经常出现，并且通常足以被捕捉到。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;然而，在较低的采样率和较低的传输负载下可能会导致错过重要事件，而想用较高的采样率就需要能接受的性能损耗。对于这样的系统的解决方案就是覆盖默认的采样率，这需要手动干预的，这种情况是我们试图避免在dapper中出现的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们在部署可变采样的过程中，参数化配置采样率时，不是使用一个统一的采样方案，而是使用一个采样期望率来标识单位时间内采样的追踪。这样一来，<strong>低流量低负载自动提高采样率，而在高流量高负载的情况下会降低采样率，使损耗一直保持在控制之下</strong>。<strong>实际使用的采样率会随着跟踪本身记录下来，这有利于从Dapper的跟踪数据中准确的分析</strong>。</p>
<h3 id="应对积极采样-Coping-with-aggressive-sampling"><a href="#应对积极采样-Coping-with-aggressive-sampling" class="headerlink" title="应对积极采样(Coping with aggressive sampling)"></a>应对积极采样(Coping with aggressive sampling)</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;新的Dapper用户往往觉得低采样率–在高吞吐量的服务下经常低至0.01％–将会不利于他们的分析。我们在Google的经验使我们相信，对于高吞吐量服务，积极采样(aggressive sampling)并不妨碍最重要的分析。如果一个显着的操作在系统中出现一次，他就会出现上千次。低吞吐量的服务–也许是每秒请求几十次，而不是几十万–可以负担得起跟踪每一个请求，这是促使我们下决心使用自适应采样率的原因。</p>
<h3 id="在收集过程中额外的采样"><a href="#在收集过程中额外的采样" class="headerlink" title="在收集过程中额外的采样"></a>在收集过程中额外的采样</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;上述采样机制被设计为尽量减少与Dapper运行库协作的应用程序中明显的性能损耗。Dapper的团队还需要控制写入中央资料库的数据的总规模，因此为达到这个目的，我们结合了二级采样。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;目前我们的生产集群每天产生超过1TB的采样跟踪数据。Dapper的用户希望生产环境下的进程的跟踪数据从被记录之后能保存至少两周的时间。逐渐增长的追踪数据的密度必须和Dapper中央仓库所消耗的服务器及硬盘存储进行权衡。对请求的高采样率还使得Dapper收集器接近写入吞吐量的上限。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;为了维持物质资源的需求和渐增的Bigtable的吞吐之间的灵活性，我们在收集系统自身上增加了额外的采样率的支持。<strong>我们充分利用所有span都来自一个特定的跟踪并分享同一个跟踪ID这个事实，虽然这些span有可能横跨了数千个主机</strong>。<strong>对于在收集系统中的每一个span，我们用hash算法把跟踪ID转成一个标量Z，这里0&lt;=Z&lt;=1</strong>。如果Z比我们收集系统中的系数低的话，我们就保留这个span信息，并写入到Bigtable中。反之，我们就抛弃他。<strong>通过在采样决策中的跟踪ID，我们要么保存、要么抛弃整个跟踪，而不是单独处理跟踪内的span</strong>。我们发现，有了这个额外的配置参数使管理我们的收集管道变得简单多了，因为我们可以很容易地在配置文件中调整我们的全局写入率这个参数。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果整个跟踪过程和收集系统只使用一个采样率参数确实会简单一些，但是这就不能应对快速调整在所有部署的节点上的运行期采样率配置的这个要求。我们选择了运行期采样率，这样就可以优雅的去掉我们无法写入到仓库中的多余数据，我们还可以通过调节收集系统中的二级采样率系数来调整这个运行期采样率。Dapper的管道维护变得更容易，因为我们就可以通过修改我们的二级采样率的配置，直接增加或减少我们的全局覆盖率和写入速度。</p>
<h2 id="通用的Dapper工具"><a href="#通用的Dapper工具" class="headerlink" title="通用的Dapper工具"></a>通用的Dapper工具</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;几年前，当Dapper还只是个原型的时候，它只能在Dapper开发者耐心的支持下使用。从那时起，我们逐渐迭代的建立了收集组件，编程接口，和基于Web的交互式用户界面，帮助Dapper的用户独立解决自己的问题。在本节中，我们会总结一下哪些的方法有用，哪些用处不大，我们还提供关于这些通用的分析工具的基本的使用信息。</p>
<h3 id="Dapper-Depot-API"><a href="#Dapper-Depot-API" class="headerlink" title="Dapper Depot API"></a>Dapper Depot API</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper的“Depot API”或称作DAPI，提供在Dapper的区域仓库中对分布式跟踪数据一个直接访问。DAPI和Dapper跟踪仓库被设计成串联的，而且DAPI意味着对Dapper仓库中的元数据暴露一个干净和直观的的接口。我们使用了以下推荐的三种方式去暴露这样的接口：</p>
<ul>
<li><strong>通过跟踪ID来访问</strong>：DAPI可以通过他的全局唯一的跟踪ID读取任何一次跟踪信息。</li>
<li><strong>批量访问</strong>：DAPI可以利用的MapReduce提供对上亿条Dapper跟踪数据的并行读取。用户重写一个虚拟函数，它接受一个Dapper的跟踪信息作为其唯一的参数，该框架将在用户指定的时间窗口中调用每一次收集到的跟踪信息。</li>
<li><strong>索引访问</strong>：Dapper的仓库支持一个符合我们通用调用模板的唯一索引。该索引根据通用请求跟踪特性(commonly-requested trace features)进行绘制来识别Dapper的跟踪信息。因为跟踪ID是根据伪随机的规则创建的，这是最好的办法去访问跟某个服务或主机相关的跟踪数据。</li>
</ul>
<p>所&nbsp;&nbsp;&nbsp;&nbsp;有这三种访问模式把用户指向不同的Dapper跟踪记录。正如第2.1节所述的，Dapper的由span组成的跟踪数据是用树形结构建模的，因此，跟踪数据的数据结构，也是一个简单的由span组成遍历树。<strong>Span就相当于RPC调用，在这种情况下，RPC的时间信息是可用的。带时间戳的特殊的应用标注也是可以通过这个span结构来访问的</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;选择一个合适的自定义索引是DAPI设计中最具挑战性的部分。压缩存储要求在跟踪数据种建立一个索引的情况只比实际数据小26%，所以消耗是巨大的。最初，我们部署了两个索引：第一个是主机索引，另一个是服务名的索引。然而，我们并没有找到主机索引和存储成本之间的利害关系。当用户对每一台主机感兴趣的时候，他们也会对特定的服务感兴趣，所以我们最终选择把两者相结合，成为一个组合索引，它允许以服务名称，主机，和时间戳的顺序进行有效的查找。</p>
<h3 id="DAPI在Google内部的使用"><a href="#DAPI在Google内部的使用" class="headerlink" title="DAPI在Google内部的使用"></a>DAPI在Google内部的使用</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;DAPI在谷歌的使用有三类：使利用DAPI的持续的线上Web应用，维护良好的可以在控制台上调用的基于DAPI的工具，可以被写入，运行、不过大部分已经被忘记了的一次性分析工具。我们知道的有3个持久性的基于DAPI的应用程序，8个额外的按需定制的基于DAPI分析工具，以及使用DAPI框架构建的约15~20一次性的分析工具。在这之后的工具就这是很难说明了，因为开发者可以构建、运行和丢弃这些项目，而不需要Dapper团队的技术支持。</p>
<h3 id="Dapper的用户接口"><a href="#Dapper的用户接口" class="headerlink" title="Dapper的用户接口"></a>Dapper的用户接口</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;绝大多数用户使用发生在基于web的用户交互接口。篇幅有限，我们不能列出每一个特点，而只能把典型的用户工作流在图6中展示。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/8.png" alt=""></p>
<ol>
<li>用户描述的他们关心的服务和时间，和其他任何他们可以用来区分跟踪模板的信息（比如，span的名称）。他们还可以指定与他们的搜索最相关的成本度量(cost metric)(比如，服务响应时间)。</li>
<li>一个关于性能概要的大表格，对应确定的服务关联的所有分布式处理图表。用户可以把这些执行图标排序成他们想要的，并选择一种直方图去展现出更多的细节。</li>
<li>一旦某个单一的分布式执行部分被选中后，用户能看到关于执行部分的的图形化描述。被选中的服务被高亮展示在该图的中心。</li>
<li>在生成与步骤1中选中的成本度量(cost metric)维度相关的统计信息之后，Dapper的用户界面会提供了一个简单的直方图。在这个例子中，我们可以看到一个大致的所选中部分的分布式响应时间分布图。用户还会看到一个关于具体的跟踪信息的列表，展现跟踪信息在直方图中被划分为的不同区域。在这个例子中，用户点击列表种第二个跟踪信息实例时，会在下方看到这个跟踪信息的详细视图(步骤5)。</li>
<li>绝大多数Dapper的使用者最终的会检查某个跟踪的情况，希望能收集一些信息去了解系统行为的根源所在。我们没有足够的空间来做跟踪视图的审查，但我们使用由一个全局时间轴（在上方可以看到），并能够展开和折叠树形结构的交互方式，这也很有特点。分布式跟踪树的连续层用内嵌的不同颜色的矩形表示。每一个RPC的span被从时间上分解为一个服务器进程中的消耗（绿色部分）和在网络上的消耗（蓝色部分）。用户Annotation没有显示在这个截图中，但他们可以选择性的以span的形式包含在全局时间轴上。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;为了让用户查询实时数据，Dapper的用户界面能够直接与Dapper每一台生产环境下的服务器上的守护进程进行交互。在该模式下，不可能指望能看到上面所说的系统级的图表展示，但仍然可以很容易基于性能和网络特性选取一个特定的跟踪。在这种模式下，可在几秒钟内查到实时的数据。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;根据我们的记录，大约有200个不同的Google工程师在一天内使用的Dapper的UI;在一周的过程中，大约有750-1000不同的用户。这些用户数，在新功能的内部通告上，是按月连续的。通常用户会发送特定跟踪的连接，这将不可避免地在查询跟踪情况时中产生很多一次性的，持续时间较短的交互。</p>
<h2 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper在Google被广泛应用，一部分直接通过Dapper的用户界面，另一部分间接地通过对Dapper API的二次开发或者建立在基于api的应用上。在本节中，我们并不打算罗列出每一种已知的Dapper使用方式，而是试图覆盖Dapper使用方式的“基本向量”，并努力来说明什么样的应用是最成功的。</p>
<h3 id="在开发中使用Dapper"><a href="#在开发中使用Dapper" class="headerlink" title="在开发中使用Dapper"></a>在开发中使用Dapper</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Google AdWords系统是围绕一个大型的关键词定位准则和相关文字广告的数据库搭建的。当新的关键字或广告被插入或修改时，它们必须通过服务策略术语的检查（如检查不恰当的语言，这个过程如果使用自动复查系统来做的话会更加有效）。</p>
<p>当轮到从头重新设计一个广告审查服务时，这个团队迭代的从第一个系统原型开始使用Dapper，并且，最终用Dapper一直维护着他们的系统。Dapper帮助他们从以下几个方面改进了他们的服务：</p>
<ul>
<li>性能：开发人员针对请求延迟的目标进行跟踪，并对容易优化的地方进行定位。Dapper也被用来确定在关键路径上不必要的串行请求–通常来源于不是开发者自己开发的子系统–并促使团队持续修复他们。</li>
<li>正确性：广告审查服务围绕大型数据库系统搭建。系统同时具有只读副本策略（数据访问廉价）和读写的主策略（访问代价高）。Dapper被用来在很多种情况中确定，哪些查询是无需通过主策略访问而可以采用副本策略访问。Dapper现在可以负责监控哪些主策略被直接访问，并对重要的系统常量进行保障。</li>
<li>理解性：广告审查查询跨越了各种类型的系统，包括BigTable—之前提到的那个数据库，多维索引服务，以及其他各种C++和Java后端服务。Dapper的跟踪用来评估总查询成本，促进重新对业务的设计，用以在他们的系统依赖上减少负载。</li>
<li>测试：新的代码版本会经过一个使用Dapper进行跟踪的QA过程，用来验证正确的系统行为和性能。在跑测试的过程中能发现很多问题，这些问题来自广告审查系统自身的代码或是他的依赖包。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;广告审查团队广泛使用了Dapper Annotation API。Guice[13]开源的AOP框架用来在重要的软件组件上标注“@Traced”。这些跟踪信息可以进一步被标注，包含：重要子路径的输入输出大小、基础信息、其他调试信息，所有这些信息将会额外发送到日志文件中。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;同时，我们也发现了一些广告审查小组在使用方面的不足。比如：他们想根据他们所有跟踪的Annotation信息，在一个交互时间段内进行搜索，然而这就必须跑一个自定义的MapReduce或进行每一个跟踪的手动检查。另外，在Google还有一些其他的系统在也从通用调试日志中收集和集中信息，把那些系统的海量数据和Dapper仓库整合也是有价值的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;总的来说，即便如此，广告审查团队仍然对Dapper的作用进行了以下评估，通过使用Dapper的跟踪平台的数据分析，他们的服务延迟性已经优化了两个数量级。</p>
<h3 id="与异常监控的集成"><a href="#与异常监控的集成" class="headerlink" title="与异常监控的集成"></a>与异常监控的集成</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>Google维护了一个从运行进程中不断收集并集中异常信息报告的服务</strong>。<strong>如果这些异常发生在Dapper跟踪采样的上下文中，那么相应的跟踪ID和span的ID也会作为元数据记录在异常报告中</strong>。<strong>异常监测服务的前端会提供一个链接，从特定的异常信息的报告直接导向到他们各自的分布式跟踪</strong>。广告审查团队使用这个功能可以了解bug发生的更大范围的上下文。<strong>通过暴露基于简单的唯一ID构建的接口，Dapper平台被集成到其他事件监测系统会相对容易</strong>。</p>
<h3 id="解决延迟的长尾效应"><a href="#解决延迟的长尾效应" class="headerlink" title="解决延迟的长尾效应"></a>解决延迟的长尾效应</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;考虑到移动部件的数量、代码库的规模、部署的范围，调试一个像全文搜索那样服务（第1节里提到过）是非常具有挑战性的。在这节，我们描述了我们在减轻全文搜索的延迟分布的长尾效应上做的各种努力。Dapper能够验证端到端的延迟的假设，更具体地说，<strong>Dapper能够验证对于搜索请求的关键路径</strong>。<strong>当一个系统不仅涉及数个子系统，而是几十个开发团队的涉及到的系统的情况下，端到端性能较差的根本原因到底在哪，这个问题即使是我们最好的和最有经验的工程师也无法正确回答</strong>。<strong>在这种情况下，Dapper可以提供急需的数据，而且可以对许多重要的性能问题得出结论</strong>。</p>
<p><img src="//blog.com/2019/04/16/Dapper，大规模分布式系统的跟踪系统/9.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;图7：全局搜索的跟踪片段，在不常遇到高网络延迟的情况下，在沿着关键路径的端到端的请求延迟，如图所示。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在调试延迟长尾效应的过程中，工程师可以建立一个小型库，这个小型库可以根据DAPI跟踪对象来推断关键路径的层级结构。这些关键路径的结构可以被用来诊断问题，并且为全文搜索提供可优先处理的预期的性能改进。Dapper的这项工作导致了下列发现：</p>
<ul>
<li><p>在关键路径上的短暂的网络性能退化不影响系统的吞吐量，但它可能会对延迟异常值产生极大的影响。在图7中可以看出，大部分的全局搜索的缓慢的跟踪都来源于关键路径的网络性能退化。</p>
</li>
<li><p>许多问题和代价很高的查询模式来源于一些意想不到的服务之间的交互。一旦发现，往往容易纠正它们，但是Dapper出现之前想找出这些问题是相当困难的。</p>
</li>
<li><p>通用的查询从Dapper之外的安全日志仓库中收取，并使用Dapper唯一的跟踪ID，与Dapper的仓库做关联。然后，该映射用来建立关于在全局搜索中的每一个独立子系统都很慢的实例查询的列表。</p>
</li>
</ul>
<h3 id="推断服务依赖"><a href="#推断服务依赖" class="headerlink" title="推断服务依赖"></a>推断服务依赖</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;在任何给定的时间内，Google内部的一个典型的计算集群是一个汇集了成千上万个逻辑“任务”的主机，一套的处理器在执行一个通用的方法。Google维护着许多这样的集群，当然，事实上，我们发现在一个集群上计算着的这些任务通常依赖于其他的集群上的任务。由于任务们之间的依赖是动态改变的，所以不可能仅从配置信息上推断出所有这些服务之间的依赖关系。不过，除了其他方面的原因之外，在公司内部的各个流程需要准确的服务依赖关系信息，以确定瓶颈所在，以及计划服务的迁移。Google的可称为“Service Dependencies”的项目是通过使用跟踪Annotation和DAPI MapReduce接口来实现自动化确定服务依赖归属的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper核心组件与Dapper跟踪Annotation一并使用的情况下，“Service Dependencies”项目能够推算出任务各自之间的依赖，以及任务和其他软件组件之间的依赖。比如，所有的BigTable的操作会加上与受影响的表名称相关的标记。运用Dapper的平台，Service Dependencies团队就可以自动的推算出依赖于命名的不同资源的服务粒度。</p>
<h3 id="不同服务的网络使用率"><a href="#不同服务的网络使用率" class="headerlink" title="不同服务的网络使用率"></a>不同服务的网络使用率</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;Google投入了大量的人力和物力资源在他的网络结构上。从前网络管理员可能只关注独立的硬件信息、常用工具及以及搭建出的各种全局网络鸟瞰图的dashboard上的信息。网络管理员确实可以一览整个网络的健康状况，但是，当遇到问题时，他们很少有能够准确查找网络负载的工具，用来定位应用程序级别的罪魁祸首。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;虽然Dapper不是设计用来做链路级的监控的，但是我们发现，它是非常适合去做集群之间网络活动性的应用级任务的分析。<strong>Google能够利用Dapper这个平台，建立一个不断更新的控制台，来显示集群之间最活跃的网络流量的应用级的热点</strong>。此外，使用Dapper我们能够为昂贵的网络请求提供指出的构成原因的跟踪，而不是面对不同服务器之间的信息孤岛而无所适从。建立一个基于Dapper API的dashboard总共没花超过2周的时间。</p>
<h3 id="分层和共享存储系统"><a href="#分层和共享存储系统" class="headerlink" title="分层和共享存储系统"></a>分层和共享存储系统</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;在Google的许多存储系统是由多重独立复杂层级的分布式基础设备组成的。例如，Google的App Engine[5]就是搭建在一个可扩展的实体存储系统上的。该实体存储系统在基于BigTable上公开某些RDBMS功能。 BigTable的同时使用Chubby[7]（分布式锁系统）及GFS。再者，像BigTable这样的系统简化了部署，并更好的利用了计算资源。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在这种分层的系统，并不总是很容易确定最终用户资源的消费模式。例如，来自于一个给定的BigTable单元格的GFS大信息量主要来自于一个用户或是由多个用户产生，但是在GFS层面，这两种明显的使用场景是很难界定。而且，如果缺乏一个像Dapper一样的工具的情况下，对共享服务的竞争可能会同样难于调试。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;第5.2节中所示的Dapper的用户界面可以聚合那些调用任意公共服务的多个客户端的跟踪的性能信息。这就很容易让提供这些服务的源从多个维度给他们的用户排名。（例如，入站的网络负载，出站的网络负载，或服务请求的总时间）</p>
<h3 id="Dapper的救火能力-Firefighting"><a href="#Dapper的救火能力-Firefighting" class="headerlink" title="Dapper的救火能力(Firefighting)"></a>Dapper的救火能力(Firefighting)</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;对于一些“救火”任务，Dapper可以处理其中的一部分。“救火”任务在这里是指一些有风险很高的在分布式系统上的操作。通常情况下，Dapper用户当正在进行“救火”任务时需要使用新的数据，并且没有时间写新的DAPI代码或等待周期性的报告运行。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;对于那些高延迟，不，可能更糟糕的那些在正常负载下都会响应超时的服务，Dapper用户界面通常会把这些延迟瓶颈的位置隔离出来。通过与Dapper守护进程的直接通信，那些特定的高延迟的跟踪数据轻易的收集到。当出现灾难性故障时，通常是没有必要去看统计数据以确定根本原因，只查看示例跟踪就足够了(因为前文提到过从Dapper守护进程中几乎可以立即获得跟踪数据)。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;但是，如在6.5节中描述的共享的存储服务，要求当用户活动过程中突然中断时能尽可能快的汇总信息。对于事件发生之后，共享服务仍然可以利用汇总的的Dapper数据，但是，除非收集到的Dapper数据的批量分析能在问题出现10分钟之内完成，否则Dapper面对与共享存储服务相关的“救火”任务就很难按预想的那般顺利完成。</p>
<h2 id="其他收获"><a href="#其他收获" class="headerlink" title="其他收获"></a>其他收获</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;虽然迄今为止，我们在Dapper上的经验已经大致符合我们的预期，但是也出现了一些积极的方面是我们没有充分预料到的。首先，我们获得了超出预期的Dapper使用用例的数量，对此我们可谓欢心鼓舞。另外，在除了几个的在第6节使用经验中提到过的一些用例之外，还包括资源核算系统，对指定的通讯模式敏感的服务的检查工具，以及一种对RPC压缩策略的分析器，等等。我们认为这些意想不到的用例一定程度上是由于我们向开发者以一种简单的编程接口的方式开放了跟踪数据存储的缘故，这使得我们能够充分利用这个大的多的社区的创造力。除此之外，Dapper对旧的负载的支持也比预期的要简单，只需要在程序中引入一个用新版本的重新编译过的公共组件库(包含常规的线程使用，控制流和RPC框架)即可。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Dapper在Google内部的广泛使用还为我们在Dapper的局限性上提供了宝贵的反馈意见。下面我们将介绍一些我们已知的最重要的Dapper的不足：</p>
<ul>
<li>合并的影响：我们的模型隐含的前提是不同的子系统在处理的都是来自同一个被跟踪的请求。在某些情况下，缓冲一部分请求，然后一次性操作一个请求集会更加有效。（比如，磁盘上的一次合并写入操作）。在这种情况下，一个被跟踪的请求可以看似是一个大型工作单元。此外，当有多个追踪请求被收集在一起，他们当中只有一个会用来生成那个唯一的跟踪ID，用来给其他span使用，所以就无法跟踪下去了。我们正在考虑的解决方案，希望在可以识别这种情况的前提下，用尽可能少的记录来解决这个问题。</li>
<li>跟踪批处理负载：Dapper的设计，主要是针对在线服务系统，最初的目标是了解一个用户请求产生的系统行为。然而，离线的密集型负载，例如符合MapReduce[10]模型的情况，也可以受益于性能挖潜。在这种情况下，我们需要把跟踪ID与一些其他的有意义的工作单元做关联，诸如输入数据中的键值（或键值的范围），或是一个MapReduce shard。</li>
<li>寻找根源：Dapper可以有效地确定系统中的哪一部分致使系统整个速度变慢，但并不总是能够找出问题的根源。例如，一个请求很慢有可能不是因为它自己的行为，而是由于队列中其他排在它前面的(queued ahead of)请求还没处理完。程序可以使用应用级的annotation把队列的大小或过载情况写入跟踪系统。此外，如果这种情况屡见不鲜，那么在ProfileMe[11]中提到的成对的采样技术可以解决这个问题。它由两个时间重叠的采样率组成，并观察它们在整个系统中的相对延迟。</li>
<li>记录内核级的信息：一些内核可见的事件的详细信息有时对确定问题根源是很有用的。我们有一些工具，能够跟踪或以其他方式描述内核的执行，但是，想用通用的或是不那么突兀的方式，是很难把这些信息到捆绑到用户级别的跟踪上下文中。我们正在研究一种妥协的解决方案，我们在用户层面上把一些内核级的活动参数做快照，然后绑定他们到一个活动的span上。</li>
</ul>
<h2 id="相关产品"><a href="#相关产品" class="headerlink" title="相关产品"></a>相关产品</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;在分布式系统跟踪领域，有一套完整的体系，一部分系统主要关注定位到故障位置，其他的目标是针对性能进行优化。 Dapper确实被用于发现系统问题，但它更通常用于探查性能不足，以及提高全面大规模的工作负载下的系统行为的理解。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;与Dapper相关的黑盒监控系统，比如Project5[1]，WAP5[15]和Sherlock[2]，可以说不依赖运行库的情况下，黑盒监控系统能够实现更高的应用级透明。黑盒的缺点是一定程度上不够精确，并可能在统计推断关键路径时带来更大的系统损耗。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;对于分布式系统监控来说，基于Annotation的中间件或应用自身是一个可能是更受欢迎的解决办法.拿Pip[14]和Webmon[16]系统举例，他们更依赖于应用级的Annotation，而X-Trace[12]，Pinpoint[9]和Magpie[3]大多集中在对库和中间件的修改。Dapper更接近后者。像Pinpoint，X-Trace，和早期版本的Magpie一样，Dapper采用了全局标识符把分布式系统中各部分相关的事件联系在一起。和这些系统类似，Dapper尝试避免使用应用级Annotation，而是把的植入隐藏在通用组件模块内。Magpie放弃使用全局ID，仍然试图正确的完成请求的正确传播，他通过采用应用系统各自写入的事件策略，最终也能精确描述不同事件之间关系。但是目前还不清楚Magpie在实际环境中实现透明性这些策略到底多么有效。 X-Trace的核心Annotation比Dapper更有野心一些，因为X-Trace系统对于跟踪的收集，不仅在跟踪节点层面上，而且在节点内部不同的软件层也会进行跟踪。而我们对于组件的低性能损耗的要求迫使我们不能采用X-Trace这样的模型，而是朝着把一个请求连接起来完整跟踪所能做到的最小代价而努力。而Dapper的跟踪仍然可以从可选的应用级Annotation中获益。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;在本文中，我们介绍Dapper这个Google的生产环境下的分布式系统跟踪平台，并汇报了我们开发和使用它的相关经验。 Dapper几乎在部署在所有的Google系统上，并可以在不需要应用级修改的情况下进行跟踪，而且没有明显的性能影响。Dapper对于开发人员和运维团队带来的好处，可以从我们主要的跟踪用户界面的广泛使用上看出来，另外我们还列举了一些Dapper的使用用例来说明Dapper的作用，这些用例有些甚至都没有Dapper开发团队参与，而是被应用的开发者开发出来的。</p>
<p>据我们所知，这是第一篇汇报生产环境下分布式系统跟踪框架的论文。事实上，我们的主要贡献源于这个事实：论&nbsp;&nbsp;&nbsp;&nbsp;文中回顾的这个系统已经运行两年之久。我们发现，结合对开发人员提供简单API和对应用系统完全透明来增强跟踪的这个决定，是非常值得的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们相信，Dapper比以前的基于Annotation的分布式跟踪达到更高的应用透明度，这一点已经通过只需要少量人工干预的工作量得以证明。虽然一定程度上得益于我们的系统的同质性，但它本身仍然是一个重大的挑战。最重要的是，我们的设计提出了一些实现应用级透明性的充分条件，对此我们希望能够对更错杂环境下的解决方案的开发有所帮助。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;最后，通过开放Dapper跟踪仓库给内部开发者，我们促使更多的基于跟踪仓库的分析工具的产生，而仅仅由Dapper团队默默的在信息孤岛中埋头苦干的结果远达不到现在这么大的规模，这个决定促使了设计和实施的展开。</p>
<h3 id="Acknowledgments"><a href="#Acknowledgments" class="headerlink" title="Acknowledgments"></a>Acknowledgments</h3><p>We thank Mahesh Palekar, Cliff Biffle, Thomas Kotzmann, Kevin Gibbs, Yonatan Zunger, Michael Kleber, and Toby Smith for their experimental data and feedback about Dapper experiences. We also thank Silvius Rus for his assistance with load testing. Most importantly, though, we thank the outstanding team of engineers who have continued to develop and improve Dapper over the years; in order of appearance, Sharon Perl, Dick Sites, Rob von Behren, Tony DeWitt, Don Pazel, Ofer Zajicek, Anthony Zana, Hyang-Ah Kim, Joshua MacDonald, Dan Sturman, Glenn Willen, Alex Kehlenbeck, Brian McBarron, Michael Kleber, Chris Povirk, Bradley White, Toby Smith, Todd Derr, Michael De Rosa, and Athicha Muthitacharoen. They have all done a tremendous amount of work to make Dapper a day-to-day reality at Google.</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p>[1] M. K. Aguilera, J. C. Mogul, J. L. Wiener, P. Reynolds, and A. Muthitacharoen. Performance Debugging for Distributed Systems of Black Boxes. In Proceedings of the 19th ACM Symposium on Operating Systems Principles, December 2003.</p>
<p>[2] P. Bahl, R. Chandra, A. Greenberg, S. Kandula, D. A. Maltz, and M. Zhang. Towards Highly Reliable Enterprise Network Services Via Inference of Multi-level Dependencies. In Proceedings of SIGCOMM, 2007.</p>
<p>[3] P. Barham, R. Isaacs, R. Mortier, and D. Narayanan. Magpie: online modelling and performance-aware systems. In Proceedings of USENIX HotOS IX, 2003.</p>
<p>[4] L. A. Barroso, J. Dean, and U. Holzle. Web Search for a Planet: The Google Cluster Architecture. IEEE Micro, 23(2):22–28, March/April 2003.</p>
<p>[5] T. O. G. Blog. Developers, start your engines. <a href="http://googleblog.blogspot.com/2008/04/developers-start-your-engines.html,2007" target="_blank" rel="noopener">http://googleblog.blogspot.com/2008/04/developers-start-your-engines.html,2007</a>.</p>
<p>[6] T. O. G. Blog. Universal search: The best answer is still the best answer. <a href="http://googleblog.blogspot.com/2007/05/universal-search-best-answer-is-still.html" target="_blank" rel="noopener">http://googleblog.blogspot.com/2007/05/universal-search-best-answer-is-still.html</a>, 2007.</p>
<p>[7] M. Burrows. The Chubby lock service for loosely-coupled distributed systems. In Proceedings of the 7th USENIX Symposium on Operating Systems Design and Implementation, pages 335 – 350, 2006.</p>
<p>[8] F. Chang, J. Dean, S. Ghemawat, W. C. Hsieh, D. A. Wallach, M. Burrows, T. Chandra, A. Fikes, and R. E. Gruber. Bigtable: A Distributed Storage System for Structured Data. In Proceedings of the 7th USENIX Symposium on Operating Systems Design and Implementation (OSDI’06), November 2006.</p>
<p>[9] M. Y. Chen, E. Kiciman, E. Fratkin, A. fox, and E. Brewer. Pinpoint: Problem Determination in Large, Dynamic Internet Services. In Proceedings of ACM International Conference on Dependable Systems and Networks, 2002.</p>
<p>[10] J. Dean and S. Ghemawat. MapReduce: Simplified Data Processing on Large Clusters. In Proceedings of the 6th USENIX Symposium on Operating Systems Design and Implementation (OSDI’04), pages 137 – 150, December 2004.</p>
<p>[11] J. Dean, J. E. Hicks, C. A. Waldspurger, W. E. Weihl, and G. Chrysos. ProfileMe: Hardware Support for Instruction-Level Profiling on Out-of-Order Processors. In Proceedings of the IEEE/ACM International Symposium on Microarchitecture, 1997.</p>
<p>[12] R. Fonseca, G. Porter, R. H. Katz, S. Shenker, and I. Stoica. X-Trace: A Pervasive Network Tracing Framework. In Proceedings of USENIX NSDI, 2007.</p>
<p>[13] B. Lee and K. Bourrillion. The Guice Project Home Page. <a href="http://code.google.com/p/google-guice/" target="_blank" rel="noopener">http://code.google.com/p/google-guice/</a>, 2007.</p>
<p>[14] P. Reynolds, C. Killian, J. L. Wiener, J. C. Mogul, M. A. Shah, and A. Vahdat. Pip: Detecting the Unexpected in Distributed Systems. In Proceedings of USENIX NSDI, 2006.</p>
<p>[15] P. Reynolds, J. L. Wiener, J. C. Mogul, M. K. Aguilera, and A. Vahdat. WAP5: Black Box Performance Debugging for Wide-Area Systems. In Proceedings of the 15th International World Wide Web Conference, 2006.</p>
<p>[16] P. K. G. T. Gschwind, K. Eshghi and K. Wurster. WebMon: A Performance Profiler for Web Transactions. In E-Commerce Workshop, 2002.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/96/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/96/">96</a><span class="page-number current">97</span><a class="page-number" href="/page/98/">98</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/98/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
