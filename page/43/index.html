<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="搬运工 + 践行者" type="application/atom+xml">






<meta name="description" content="做一个懂业务的程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="搬运工 + 践行者">
<meta property="og:url" content="http://blog.com/page/43/index.html">
<meta property="og:site_name" content="搬运工 + 践行者">
<meta property="og:description" content="做一个懂业务的程序员">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="搬运工 + 践行者">
<meta name="twitter:description" content="做一个懂业务的程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.com/page/43/">





  <title>搬运工 + 践行者</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">搬运工 + 践行者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记录学习的技能和遇到的问题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/15/柔性事务-最大努力通知/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/柔性事务-最大努力通知/" itemprop="url">柔性事务-最大努力通知</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-15T12:12:57+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/分布式事务/" itemprop="url" rel="index">
                    <span itemprop="name">分布式事务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="柔性事务-最大努力通知"><a href="#柔性事务-最大努力通知" class="headerlink" title="柔性事务-最大努力通知"></a>柔性事务-最大努力通知</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="http://www.tianshouzhi.com/api/tutorials/distributed_transaction/387" target="_blank" rel="noopener">http://www.tianshouzhi.com/api/tutorials/distributed_transaction/387</a></p>
</blockquote>
<p><br></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 最大努力通知型(<code>Best-effort delivery</code>)是最简单的一种柔性事务，<strong>适用于一些最终一致性时间敏感度低的业务，且被动方处理结果 不影响主动方的处理结果</strong>。典型的使用场景：如银行通知、商户通知等。最大努力通知型的实现方案，一般符合以下特点：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1、<strong>不可靠消息</strong>：业务活动主动方，在完成业务处理之后，向业务活动的被动方发送消息，直到通知N次后不再通知，允许消息丢失(不可靠消息)。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2、<strong>定期校对</strong>：业务活动的被动方，根据定时策略，向业务活动主动方查询(主动方提供查询接口)，恢复丢失的业务消息。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举例来说：笔者曾经做过一个短信发送平台，背景是公司内部有多个业务都有发送短信的需求，如果每个业务独立实现短信发送功能，存在功能实现上的重复。因此专门做了一个短信平台项目，所有的业务方都接入这个短信平台，来实现发送短信的功能。简化后的架构如下所示： </p>
<p><img src="//blog.com/2019/06/15/柔性事务-最大努力通知/1517793734283093270.png" alt="E14FE394-01AF-45BE-A371-8B46611884BD.png"></p>
<p><strong>短信发送流程如下：</strong></p>
<p>1、业务方将短信发送请求提交给短信平台</p>
<p>2、短信平台接收到要发送的短信，记录到数据库中，并标记其状态为”已接收”</p>
<p>3、短信平台调用外部短信发送供应商的接口，发送短信。外部供应商的接口也是异步将短信发送到用户手机上，因此这个接口调用后，立即返回，进入第4步。</p>
<p>4、更新短信发送状态为”已发送”</p>
<p>5、<strong>短信发送供应商异步通知短信平台短信发送结果</strong>。<strong>而通知可能失败，因此最多只会通知N次</strong>。</p>
<p>6、短信平台接收到短信发送结果后，更新短信发送状态，可能是成功，也可能失败(如手机欠费)。到底是成功还是失败并不重要，重要的是我们知道了这调短信发送的最终结果</p>
<p>7、如果最多只通知N次，如果都失败了的话，那么短信平台将不知道短信到底有没有成功发送。因此<strong>短信发送供应商需要提供一个查询接口，以方便短信平台驱动的去查询，进行定期校对</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在这个案例中，短信发送供应商通知短信平台短信发送结果的过程中，就是最典型的最大努力通知型方案，通知了N次就不再通知。通过提供一个短信结果查询接口，让短信平台可以进行定期的校对。而由于短信发送业务的时间敏感度并不高，比较适合采用这个方案。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是，短信结果查询接口很重要，必须要进行定期校对。因为后期要进行对账，笔者在做这个项目的时候，一个月的短信发送总量在高峰期可以达到1亿条左右，即使一条短信只要5分钱，一个月就有500W。(这个5分钱是笔者估计的，在这么大的量的情况，一条短信到底需要多少钱我也不知道。因为商务对接过程，是没有我靓丽的身影的。总之短信发送要花很多钱，如果短信发送供应商说短信都发送成功了，而短信平台却一条成功的记录都没有，出现这种扯皮的情况就不好了)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后提一点：当当网开源数据库中间件<code>sharding-jdbc</code>使用了最大努力通知型来实现分库分表情况下数据的一致性，说实话，个人觉得最大努力通知型不太适合于这种场景。目前，<code>sharding-jdbc</code>也正在开发另一种柔性事务方案<code>TCC</code>，我们后面将要讲解。 </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/15/RPC细节详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/RPC细节详解/" itemprop="url">RPC细节详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-15T12:12:57+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/RPC/" itemprop="url" rel="index">
                    <span itemprop="name">RPC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="RPC细节详解"><a href="#RPC细节详解" class="headerlink" title="RPC细节详解"></a>RPC细节详解</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/CepNdL2A_QMcESgQVZBn2g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/CepNdL2A_QMcESgQVZBn2g</a></p>
</blockquote>
<p><br></p>
<h2 id="服务化有什么好处？"><a href="#服务化有什么好处？" class="headerlink" title="服务化有什么好处？"></a>服务化有什么好处？</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务化的一个好处就是，不限定服务的提供方使用什么技术选型，能够实现大公司跨团队的技术解耦，如下图所示：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajJKEXqU1FOxlgWnlmfDOesGb5IZJmRM4cIotWyzEvpq5dJo1UribibP7w.jpeg" alt="img"></p>
<ul>
<li>服务A：欧洲团队维护，技术背景是<code>Java</code></li>
<li>服务B：美洲团队维护，用<code>C++</code>实现</li>
<li>服务C：中国团队维护，技术栈是<code>go</code></li>
</ul>
<p><strong>服务的上游调用方，按照接口、协议即可完成对远端服务的调用</strong>。</p>
<p>但实际上，大部分互联网公司，研发团队规模有限，大都使用同一套技术体系来实现服务：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajLD3x1spUicBVI0roEN3CtwqBPticAjLpW8uxuETgzjhELYuQicS1zQCaw.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样的话，如果没有统一的服务框架，各个团队的服务提供方就需要各自实现一套<strong>序列化、反序列化、网络框架、连接池、收发线程、超时处理、状态机</strong>等“业务之外”的重复技术劳动，造成整体的低效。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因此，<strong>统一服务框架把上述“业务之外”的工作统一实现，是服务化首要解决的问题</strong>。</p>
<h2 id="什么是RPC？"><a href="#什么是RPC？" class="headerlink" title="什么是RPC？"></a>什么是RPC？</h2><p><code>Remote Procedure Call Protocol</code>，远程过程调用。</p>
<h3 id="什么是“远程”，为什么“远”？"><a href="#什么是“远程”，为什么“远”？" class="headerlink" title="什么是“远程”，为什么“远”？"></a>什么是“远程”，为什么“远”？</h3><p>先来看下什么是“近”，即“本地函数调用”。</p>
<p>当我们写下：</p>
<blockquote>
<p><em>int result = Add(1, 2);</em></p>
</blockquote>
<p><strong>这行代码的时候，到底发生了什么？</strong></p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajZMiaQGz9B7JTsicoxKDMTNl0Uwh0yxA5JDQkEp2ZGKTDZsvcXCFdWia4A.jpeg" alt="img"></p>
<ul>
<li>传递两个入参</li>
<li>调用了本地代码段中的函数，执行运算逻辑</li>
<li>返回一个出参</li>
</ul>
<p>这三个动作，都发生在同一个进程空间里，这是<strong>本地函数调用</strong>。</p>
<p><strong>那有没有办法，调用一个跨进程的函数呢？</strong></p>
<p>典型的，这个进程部署在另一台服务器上。</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajV0E0Qib9eKiavqbn7cwHLyjn7Rb54U8anhwDBrc2q7Xf5rMlXlQhvOAg.jpeg" alt="img"></p>
<p>最容易想到的，两个进程约定一个协议格式，使用<code>Socket</code>通信，来传输：</p>
<ul>
<li><strong>入参</strong></li>
<li><strong>调用哪个函数</strong></li>
<li><strong>出参</strong></li>
</ul>
<p>如果能够实现，那这就是“远程”过程调用。</p>
<p><strong>Socket通信只能传递连续的字节流，如何将入参、函数都放到连续的字节流里呢？</strong></p>
<p>假设，设计一个11字节的请求报文：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjaj5pAeBtd89DtFcBdQGJ5TlCERSaHrfDC4gxiaOVPDJDP3txA7AN2D8nw.jpeg" alt="img"></p>
<ul>
<li>前3个字节填入函数名<code>“add”</code></li>
<li>中间4个字节填入第一个参数<code>“1”</code></li>
<li>末尾4个字节填入第二个参数<code>“2”</code></li>
</ul>
<p>同理，可以设计一个4字节响应报文：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjaj5knFI6ahjAMM6k135icQ09RibPxHtibBClHz5LDEcW2cdPIZOJhwLV7Mw.jpeg" alt="img"></p>
<ul>
<li>4个字节填入处理结果<code>“3”</code></li>
</ul>
<p>调用方的代码可能变为：</p>
<blockquote>
<p><em>request = MakePacket(“add”, 1, 2);</em></p>
<p><em>SendRequest_ToService_B(request);</em></p>
<p><em>response = RecieveRespnse_FromService_B();</em></p>
<p><em>int result = unMakePacket(respnse);</em></p>
</blockquote>
<p>这4个步骤是：</p>
<p>（1）将传入参数变为字节流；</p>
<p>（2）将字节流发给服务B；</p>
<p>（3）从服务B接受返回字节流；</p>
<p>（4）将返回字节流变为传出参数；</p>
<p>服务方的代码可能变为：</p>
<blockquote>
<p><em>request = RecieveRequest();</em></p>
<p><em>args/function = unMakePacket(request);</em></p>
<p><em>result = Add(1, 2);</em></p>
<p><em>response = MakePacket(result);</em></p>
<p><em>SendResponse(response);</em></p>
</blockquote>
<p>这个5个步骤也很好理解：</p>
<p>（1）服务端收到字节流；</p>
<p>（2）将字节流转为函数名与参数；</p>
<p>（3）本地调用函数得到结果；</p>
<p>（4）将结果转变为字节流；</p>
<p>（5）将字节流发送给调用方；</p>
<p>这个过程用一张图描述如下：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajHAVga5WYXYZkShwRVd0yyWjrODIGMcmdMNOnSM8TdfAZs5RsWkgs7A.jpeg" alt="img"><br>调用方与服务方的处理步骤都是非常清晰。</p>
<p><strong>这个过程存在最大的问题是什么呢？</strong></p>
<p>调用方太麻烦了，每次都要关注很多底层细节：</p>
<ul>
<li>入参到字节流的转化，即<strong>序列化应用层协议细节</strong></li>
<li><code>socket</code>发送，即<strong>网络传输协议细节</strong></li>
<li><code>socket</code>接收</li>
<li>字节流到出参的转化，即<strong>反序列化应用层协议细节</strong></li>
</ul>
<p><strong>能不能调用层不关注这个细节？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以，<code>RPC</code>框架就是解决这个问题的，它能够让调用方“像调用本地函数一样调用远端的函数（服务）”。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;讲到这里，是不是对<code>RPC</code>，对序列化范序列化有点感觉了？往下看，有更多的底层细节。</p>
<h2 id="RPC框架的职责是什么？"><a href="#RPC框架的职责是什么？" class="headerlink" title="RPC框架的职责是什么？"></a><strong>RPC框架的职责是什么？</strong></h2><p><code>RPC</code>框架，要向调用方屏蔽各种复杂性，要向服务提供方也屏蔽各类复杂性：</p>
<ul>
<li>服务调用方<code>client</code>感觉就像调用本地函数一样，来调用服务</li>
<li>服务提供方<code>server</code>感觉就像实现一个本地函数一样，来实现服务</li>
</ul>
<p>所以整个<code>RPC</code>框架又分为<strong>client部分</strong>与<strong>server部分</strong>，实现上面的目标，把复杂性屏蔽，就是<code>RPC</code>框架的职责。</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajGunLphnsNqnPK4Av9mCLYaW9bXbA5UDXR2BBslzGWvQCStTV1u9Pibw.jpeg" alt="img"></p>
<p>如上图所示，<strong>业务方的职责</strong>是：</p>
<ul>
<li>调用方A，传入参数，执行调用，拿到结果</li>
<li>服务方B，收到参数，执行逻辑，返回结果</li>
</ul>
<h3 id="RPC框架的职责"><a href="#RPC框架的职责" class="headerlink" title="RPC框架的职责"></a>RPC框架的职责</h3><p><strong>RPC框架的职责</strong>是，中间大蓝框的部分：</p>
<ul>
<li><strong>client端</strong>：序列化、反序列化、连接池管理、负载均衡、故障转移、队列管理，超时管理、异步管理等等</li>
<li><strong>server端</strong>：服务端组件、服务端收发包队列、<code>io</code>线程、工作线程、序列化反序列化等</li>
</ul>
<p><code>server</code>端的技术大家了解的比较多，接下来重点讲讲<code>client</code>端的技术细节。</p>
<p>先来看看<code>RPC-client</code>部分的“序列化反序列化”部分。</p>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><h4 id="为什么要进行序列化？"><a href="#为什么要进行序列化？" class="headerlink" title="为什么要进行序列化？"></a>为什么要进行序列化？</h4><p>工程师通常使用“对象”来进行数据的操纵：</p>
<blockquote>
<p><em>class User{</em></p>
<p>​         <em>std::String user_name;</em></p>
<p>​         <em>uint64_t user_id;</em></p>
<p>​         <em>uint32_t user_age;</em></p>
<p><em>};</em></p>
<p><em>User u = new User(“shenjian”);</em></p>
<p><em>u.setUid(123);</em></p>
<p><em>u.setAge(35);</em></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但当需要对数据进行<strong>存储</strong>或者<strong>传输</strong>时，“对象”就不这么好用了，往往需要把数据转化成连续空间的“二进制字节流”，一些典型的场景是：</p>
<ul>
<li>数据库<strong>索引的磁盘存储</strong>：数据库的索引在内存里是<code>b+</code>树，但这个格式是不能够直接存储到磁盘上的，所以需要把<code>b+</code>树转化为连续空间的二进制字节流，才能存储到磁盘上</li>
<li><strong>缓存的KV存储</strong>：<code>redis/memcache</code>是<code>KV</code>类型的缓存，缓存存储的<code>value</code>必须是连续空间的二进制字节流，而不能够是<code>User</code>对象</li>
<li><strong>数据的网络传输</strong>：<code>socke</code>t发送的数据必须是连续空间的二进制字节流，也不能是对象</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<strong>序列化</strong>（<code>Serialization</code>），就是将“对象”形态的数据转化为“连续空间二进制字节流”形态数据的过程。这个过程的逆过程叫做<strong>反序列化</strong>。</p>
<h4 id="怎么进行序列化？"><a href="#怎么进行序列化？" class="headerlink" title="怎么进行序列化？"></a>怎么进行序列化？</h4><h5 id="json-xml"><a href="#json-xml" class="headerlink" title="json/xml"></a>json/xml</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这是一个非常细节的问题，要是让你来把“对象”转化为字节流，你会怎么做？很容易想到的一个方法是<code>xml</code>（或者<code>json</code>）这类具有自描述特性的标记性语言：</p>
<blockquote>
<p><em><class name="User"></class></em></p>
<p><em><element name="user_name" type="std::String" value="shenjian"></element></em></p>
<p><em><element name="user_id" type="uint64_t" value="123"></element></em></p>
<p><em><element name="user_age" type="uint32_t" value="35"></element></em></p>
<p><em></em></p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规定好转换规则，发送方很容易把<code>User</code>类的一个对象序列化为<code>xml</code>，服务方收到<code>xml</code>二进制流之后，也很容易将其范序列化为<code>User</code>对象。</p>
<p><em>画外音：语言支持反射时，这个工作很容易。</em></p>
<h5 id="实现二进制协议"><a href="#实现二进制协议" class="headerlink" title="实现二进制协议"></a>实现二进制协议</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二个方法是自己实现二进制协议来进行序列化，还是以上面的<code>User</code>对象为例，可以设计一个这样的通用协议：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOyr5zq7FWiadWwMELZ6xEWCiaQXK0hS6eIoMv9sWNLqEryic5u1GogJqZ5ibvicEOfm7WbN2czwcHVbicpQ.jpeg" alt="img"></p>
<ul>
<li>头4个字节表示序号</li>
<li>序号后面的4个字节表示key的长度m</li>
<li>接下来的m个字节表示key的值</li>
<li>接下来的4个字节表示value的长度n</li>
<li>接下来的n个字节表示value的值</li>
<li>像<code>xml</code>一样递归下去，直到描述完整个对象</li>
</ul>
<p>上面的<code>User</code>对象，用这个协议描述出来可能是这样的：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOyr5zq7FWiadWwMELZ6xEWCiazaicVw41JqHquz5zn6wMW5NOF2TV1K3K2Nx6LXjFBE4b0icEljK7Tb5A.jpeg" alt="img"></p>
<ul>
<li>第一行：序号4个字节（设0表示类名），类名长度4个字节（长度为4），接下来4个字节是类名（”User”），共12字节</li>
<li>第二行：序号4个字节（1表示第一个属性），属性长度4个字节（长度为9），接下来9个字节是属性名（”user_name”），属性值长度4个字节（长度为8），属性值8个字节（值为”shenjian”），共29字节</li>
<li>第三行：序号4个字节（2表示第二个属性），属性长度4个字节（长度为7），接下来7个字节是属性名（”user_id”），属性值长度4个字节（长度为8），属性值8个字节（值为123），共27字节</li>
<li>第四行：序号4个字节（3表示第三个属性），属性长度4个字节（长度为8），接下来8个字节是属性名（”user_name”），属性值长度4个字节（长度为4），属性值4个字节（值为35），共24字节</li>
</ul>
<p>整个二进制字节流共12+29+27+24=92字节。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际的序列化协议要考虑的细节远比这个多，例如：<strong>强类型的语言不仅要还原属性名，属性值，还要还原属性类型；复杂的对象不仅要考虑普通类型，还要考虑对象嵌套类型</strong>等。无论如何，序列化的思路都是类似的。</p>
<h4 id="序列化协议要考虑什么因素？"><a href="#序列化协议要考虑什么因素？" class="headerlink" title="序列化协议要考虑什么因素？"></a>序列化协议要考虑什么因素？</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不管使用成熟协议<code>xml/json</code>，还是自定义二进制协议来序列化对象，序列化协议设计时都需要考虑以下这些因素。</p>
<ul>
<li><strong>解析效率</strong>：这个应该是序列化协议应该首要考虑的因素，像<code>xml/json</code>解析起来比较耗时，需要解析<code>doom</code>树，二进制自定义协议解析起来效率就很高</li>
<li><strong>压缩率，传输有效性</strong>：同样一个对象，<code>xml/json</code>传输起来有大量的<code>xml</code>标签，信息有效性低，二进制自定义协议占用的空间相对来说就小多了</li>
<li><strong>扩展性与兼容性</strong>：是否能够方便的增加字段，增加字段后旧版客户端是否需要强制升级，都是需要考虑的问题，<code>xml/json</code>和上面的二进制协议都能够方便的扩展</li>
<li><strong>可读性与可调试性</strong>：这个很好理解，<code>xml/json</code>的可读性就比二进制协议好很多</li>
<li><strong>跨语言</strong>：上面的两个协议都是跨语言的，有些序列化协议是与开发语言紧密相关的，例如<code>dubbo</code>的序列化协议就只能支持<code>Java</code>的<code>RPC</code>调用</li>
<li><strong>通用性</strong>：<code>xml/json</code>非常通用，都有很好的第三方解析库，各个语言解析起来都十分方便，上面自定义的二进制协议虽然能够跨语言，但每个语言都要写一个简易的协议客户端</li>
</ul>
<h4 id="有哪些常见的序列化方式？"><a href="#有哪些常见的序列化方式？" class="headerlink" title="有哪些常见的序列化方式？"></a>有哪些常见的序列化方式？</h4><ul>
<li><code>xml/json</code>：解析效率，压缩率都较差，扩展性、可读性、通用性较好</li>
<li><code>thrift</code></li>
<li><code>protobuf</code>：Google出品，必属精品，各方面都不错，强烈推荐，属于二进制协议，可读性差了点，但也有类似的<code>to-string</code>协议帮助调试问题</li>
<li><code>Avro</code></li>
<li><code>CORBA</code></li>
<li><code>mc_pack</code>：懂的同学就懂，不懂的就不懂了，09年用过，传说各方面都超越protobuf，懂行的同学可以说一下现状</li>
<li>…</li>
</ul>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOw0bibzTnvt7L6gUYIboKjajGunLphnsNqnPK4Av9mCLYaW9bXbA5UDXR2BBslzGWvQCStTV1u9Pibw.jpeg" alt="img"><br>RPC-client除了：</p>
<ul>
<li>序列化反序列化的部分（上图中的1、4）</li>
</ul>
<p>还包含：</p>
<ul>
<li>发送字节流与接收字节流的部分（上图中的2、3）</li>
</ul>
<p>这一部分，又分为<strong>同步调用与异步调用两种</strong>方式，下面一一来进行介绍。</p>
<p><em>画外音：搞通透RPC-client确实不容易。</em></p>
<h3 id="同步调用与异步调用"><a href="#同步调用与异步调用" class="headerlink" title="同步调用与异步调用"></a>同步调用与异步调用</h3><p>同步调用的代码片段为：</p>
<blockquote>
<p><em>Result = Add(Obj1, Obj2);// 得到Result之前处于阻塞状态</em></p>
</blockquote>
<p>异步调用的代码片段为：</p>
<blockquote>
<p><em>Add(Obj1, Obj2, callback);// 调用后直接返回，不等结果</em></p>
</blockquote>
<p>处理结果通过回调为：</p>
<blockquote>
<p><em>callback(Result){// 得到处理结果后会调用这个回调函数</em></p>
<p>​         <em>…</em></p>
<p><em>}</em></p>
</blockquote>
<p>这两类调用，在<code>RPC-client</code>里，实现方式完全不一样。</p>
<h4 id="RPC-client同步调用架构如何？"><a href="#RPC-client同步调用架构如何？" class="headerlink" title="RPC-client同步调用架构如何？"></a>RPC-client同步调用架构如何？</h4><p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOzqLTC1O0Q9G2HLaH7lial7Hk33AreuWN7XY8419HiasN01CwwTSNwBHnK4tyr5AyUNnpplNHBTXkjw.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>所谓同步调用，在得到结果之前，一直处于阻塞状态，会一直占用一个工作线程</strong>，上图简单的说明了一下组件、交互、流程步骤：</p>
<ul>
<li><strong>左边大框</strong>，代表了调用方的一个<strong>工作线程</strong></li>
<li>左边<strong>粉色中框</strong>，代表了<strong><code>RPC-client</code>组件</strong></li>
<li>右边<strong>橙色框</strong>，代表了<strong><code>RPC-server</code></strong></li>
<li><strong>蓝色两个小框</strong>，代表了同步<code>RPC-client</code>两个核心组件，<strong>序列化组件与连接池组件</strong></li>
<li><strong>白色的流程小框</strong>，以及箭头序号1-10，代表整个工作线程的串行<strong>执行步骤</strong>：</li>
</ul>
<p>1）业务代码发起RPC调用：</p>
<blockquote>
<p><em>Result=Add(Obj1,Obj2)</em></p>
</blockquote>
<p>2）序列化组件，将对象调用序列化成二进制字节流，可理解为一个待发送的包<code>packet1</code>；</p>
<p>3）通过连接池组件拿到一个可用的连接<code>connection</code>；</p>
<p>4）通过连接<code>connection</code>将包<code>packet1</code>发送给<code>RPC-server</code>；</p>
<p>5）发送包在网络传输，发给<code>RPC-server</code>；</p>
<p>6）响应包在网络传输，发回给<code>RPC-client</code>；</p>
<p>7）通过连接<code>connection</code>从<code>RPC-server</code>收取响应包<code>packet2</code>；</p>
<p>8）通过连接池组件，将<code>conneciont</code>放回连接池；</p>
<p>9）序列化组件，将<code>packet2</code>范序列化为<code>Result</code>对象返回给调用方；</p>
<p>10）业务代码获取<code>Result</code>结果，工作线程继续往下走；</p>
<p><em>画外音：请对照架构图中的1-10步骤阅读。</em></p>
<h4 id="连接池组件有什么作用？"><a href="#连接池组件有什么作用？" class="headerlink" title="连接池组件有什么作用？"></a>连接池组件有什么作用？</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RPC</code>框架锁支持的负载均衡、故障转移、发送超时等特性，都是通过连接池组件去实现的。</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOzqLTC1O0Q9G2HLaH7lial7HoMOibUwoaQwlyfXCabFiajEmiaWnfEwRpteRfHlElYhypdyon1o3ehzKQ.jpeg" alt="img"></p>
<p>典型连接池组件对外提供的接口为：</p>
<blockquote>
<p><em>int ConnectionPool::<strong>init</strong>(…);</em></p>
<p><em>Connection ConnectionPool::<strong>getConnection</strong>();</em></p>
<p><em>int ConnectionPool::<strong>putConnection</strong>(Connection t);</em></p>
</blockquote>
<p><strong>init做了些什么？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;和下游<code>RPC-server</code>（一般是一个集群），建立<code>N</code>个<code>tcp</code>长连接，即所谓的连接“池”。</p>
<p><strong>getConnection做了些什么？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从连接“池”中拿一个连接，加锁（置一个标志位），返回给调用方。</p>
<p><strong>putConnection做了些什么？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将一个分配出去的连接放回连接“池”中，解锁（也是置一个标志位）。</p>
<p><strong>如何实现负载均衡？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;连接池中建立了与一个<code>RPC-server</code>集群的连接，连接池在返回连接的时候，需要具备随机性。</p>
<p><strong>如何实现故障转移？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;连接池中建立了与一个<code>RPC-server</code>集群的连接，当连接池发现某一个机器的连接异常后，需要将这个机器的连接排除掉，返回正常的连接，在机器恢复后，再将连接加回来。</p>
<p><strong>如何实现发送超时？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为是同步阻塞调用，拿到一个连接后，使用带超时的<code>send/recv</code>即可实现带超时的发送和接收。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;总的来说，同步的<code>RPC-client</code>的实现是相对比较容易的，序列化组件、连接池组件配合多工作线程数，就能够实现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;遗留问题，<strong>工作线程数设置为多少最合适？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个问题在《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960260&amp;idx=1&amp;sn=051fd566d43d7fd35724bdf55484ee5f&amp;chksm=bd2d06188a5a8f0e64467381c7b3df5bdcb7f81ba055d5d21ec2f8b888492be15527d23070b0&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">工作线程数究竟要设置为多少最合适？</a>》中讨论过，此处不再深究。</p>
<h4 id="RPC-client异步回调架构如何？"><a href="#RPC-client异步回调架构如何？" class="headerlink" title="RPC-client异步回调架构如何？"></a>RPC-client异步回调架构如何？</h4><p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOzqLTC1O0Q9G2HLaH7lial7HC38mBrLmA08V0FicDgLlQY3ILEPLWaHfXV1C3I2Y2HhZh6p5qrY309A.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所谓<strong>异步回调，在得到结果之前，不会处于阻塞状态，理论上任何时间都没有任何线程处于阻塞状态，因此异步回调的模型，理论上只需要很少的工作线程与服务连接就能够达到很高的吞吐量</strong>，如上图所示：</p>
<ul>
<li><strong>左边的框框</strong>，是少量工作线程（少数几个就行了）进行<strong>调用与回调</strong></li>
<li><strong>中间粉色的框框</strong>，代表了<code>RPC-client</code>组件</li>
<li><strong>右边橙色框</strong>，代表了<code>RPC-server</code></li>
<li><strong>蓝色六个小框</strong>，代表了异步<code>RPC-client</code>六个核心组件：<strong>上下文管理器，超时管理器，序列化组件，下游收发队列，下游收发线程，连接池组件</strong></li>
<li><strong>白色的流程小框</strong>，以及箭头序号1-17，代表整个工作线程的串行执行步骤：</li>
</ul>
<p>1）业务代码发起异步<code>RPC</code>调用；</p>
<blockquote>
<p><em>Add(Obj1,Obj2, callback)</em></p>
</blockquote>
<p>2）<strong>上下文管理器，将请求，回调，上下文存储起来</strong>；</p>
<p>3）序列化组件，将对象调用序列化成二进制字节流，可理解为一个待发送的包<code>packet1</code>；</p>
<p>4）<strong>下游收发队列，将报文放入“待发送队列”，此时调用返回，不会阻塞工作线程</strong>；</p>
<p>5）<strong>下游收发线程，将报文从“待发送队列”中取出，通过连接池组件拿到一个可用的连接<code>connection</code></strong>；</p>
<p>6）通过连接<code>connection</code>将包<code>packet1</code>发送给<code>RPC-server</code>；</p>
<p>7）发送包在网络传输，发给<code>RPC-server</code>；</p>
<p>8）响应包在网络传输，发回给<code>RPC-client</code>；</p>
<p>9）通过连接<code>connection</code>从<code>RPC-server</code>收取响应包<code>packet2</code>；</p>
<p>10）<strong>下游收发线程，将报文放入“已接受队列”，通过连接池组件，将<code>conneciont</code>放回连接池</strong>；</p>
<p>11）<strong>下游收发队列里，报文被取出，此时回调将要开始，不会阻塞工作线程</strong>；</p>
<p>12）序列化组件，将<code>packet2</code>范序列化为Result对象；</p>
<p>13）<strong>上下文管理器，将结果，回调，上下文取出</strong>；</p>
<p>14）<strong>通过<code>callback</code>回调业务代码，返回<code>Result</code>结果，工作线程继续往下走</strong>；</p>
<p>如果请求长时间不返回，处理流程是：</p>
<p>15）上下文管理器，请求长时间没有返回；</p>
<p>16）超时管理器拿到超时的上下文；</p>
<p>17）通过<code>timeout_cb</code>回调业务代码，工作线程继续往下走；</p>
<p><em>画外音：请配合架构图仔细看几遍这个流程。</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;序列化组件和连接池组件上文已经介绍过，收发队列与收发线程比较容易理解。下面重点介绍<strong>上下文管理器</strong>与<strong>超时管理器</strong>这两个总的组件。</p>
<h5 id="为什么需要上下文管理器？"><a href="#为什么需要上下文管理器？" class="headerlink" title="为什么需要上下文管理器？"></a>为什么需要上下文管理器？</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于请求包的发送，响应包的回调都是异步的，甚至不在同一个工作线程中完成，需要一个组件来记录一个请求的上下文，把请求-响应-回调等一些信息匹配起来。</p>
<h6 id="如何将请求-响应-回调这些信息匹配起来？"><a href="#如何将请求-响应-回调这些信息匹配起来？" class="headerlink" title="如何将请求-响应-回调这些信息匹配起来？"></a>如何将请求-响应-回调这些信息匹配起来？</h6><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这是一个很有意思的问题，通过一条连接往下游服务发送了<code>a，b，c</code>三个请求包，异步的收到<code>了x，y，z</code>三个响应包：</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOzqLTC1O0Q9G2HLaH7lial7H56OPdL5PQpBlSFaFiaVLVROcMnsOIUXLib9o3DfOYiamMfkRJiaVshRaqw.jpeg" alt="img"></p>
<p><strong>怎么知道哪个请求包与哪个响应包对应？</strong></p>
<p><strong>怎么知道哪个响应包与哪个回调函数对应？</strong></p>
<p>可以<strong>通过<code>“请求id”</code>来实现请求-响应-回调的串联</strong>。</p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="img"><br>整个处理流程如上，通过<strong>请求id，上下文管理器来对应请求-响应-callback之间的映射关系</strong>：</p>
<p>1）生成请求<code>id</code>；</p>
<p>2）生成请求上下文<code>context</code>，上下文中包含发送时间<code>time</code>，回调函数<code>callback</code>等信息；</p>
<p>3）上下文管理器记录<code>req-id</code>与上下文<code>context</code>的映射关系；</p>
<p>4）将<code>req-id</code>打在请求包里发给<code>RPC-server</code>；</p>
<p>5）<code>RPC-server</code>将<code>req-id</code>打在响应包里返回；</p>
<p>6）由响应包中的<code>req-id</code>，通过上下文管理器找到原来的上下文<code>context</code>；</p>
<p>7）从上下文<code>context</code>中拿到回调函数<code>callback</code>；</p>
<p>8）<code>callback</code>将<code>Result</code>带回，推动业务的进一步执行；</p>
<h5 id="如何实现负载均衡，故障转移？"><a href="#如何实现负载均衡，故障转移？" class="headerlink" title="如何实现负载均衡，故障转移？"></a>如何实现负载均衡，故障转移？</h5><p>与同步的连接池思路类似，不同之处在于：</p>
<ul>
<li>同步连接池使用阻塞方式收发，需要与一个服务的一个ip建立多条连接</li>
<li><strong>异步收发，一个服务的一个ip只需要建立少量的连接</strong>（例如，一条tcp连接）</li>
</ul>
<h5 id="如何实现超时发送与接收？"><a href="#如何实现超时发送与接收？" class="headerlink" title="如何实现超时发送与接收？"></a>如何实现超时发送与接收？</h5><p>超时收发，与同步阻塞收发的实现就不一样了：</p>
<ul>
<li>同步阻塞超时，可以直接使用带超时的<code>send/recv</code>来实现</li>
<li><strong>异步非阻塞的<code>nio</code>的网络报文收发，由于连接不会一直等待回包，超时是由超时管理器实现的</strong></li>
</ul>
<p><strong>超时管理器如何实现超时管理？</strong></p>
<p><img src="//blog.com/2019/06/15/RPC细节详解/YrezxckhYOzqLTC1O0Q9G2HLaH7lial7HdB0IHbKePAqWNPfFVYbXwia0EgmE3TMMQKZYgdCWwvNXbYyPORTmiaRg.jpeg" alt="img"></p>
<p>超时管理器，用于实现请求回包超时回调处理。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;每一个请求发送给下游<code>RPC-server</code>，会在上下文管理器中保存<code>req-id</code>与上下文的信息，上下文中保存了请求很多相关信息，例如<code>req-id</code>，回包回调，超时回调，发送时间等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>超时管理器启动<code>timer</code>对上下文管理器中的<code>context</code>进行扫描，看上下文中请求发送时间是否过长，如果过长，就不再等待回包，直接超时回调，推动业务流程继续往下走，并将上下文删除掉</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如果超时回调执行后，正常的回包又到达，通过<code>req-id</code>在上下文管理器里找不到上下文，就直接将请求丢弃</strong>。</p>
<p><em>画外音：因为已经超时处理了，无法恢复上下文。</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;无论如何，异步回调和同步回调相比，除了序列化组件和连接池组件，会<strong>多出上下文管理器，超时管理器，下游收发队列，下游收发线程等组件，并且对调用方的调用习惯有影响</strong>。</p>
<p><em>画外音：编程习惯，由同步变为了回调。</em></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>异步回调能提高系统整体的吞吐量</strong>，具体使用哪种方式实现<code>RPC-client</code>，可以结合业务场景来选取。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>什么是RPC调用？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;像调用本地函数一样，调用一个远端服务。</p>
<p><strong>为什么需要RPC框架？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>RPC</code>框架用于屏蔽<code>RPC</code>调用过程中的序列化，网络传输等技术细节。让调用方只专注于调用，服务方只专注于实现调用。</p>
<p><strong>什么是序列化？为什么需要序列化？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;把对象转化为连续二进制流的过程，叫做序列化。磁盘存储，缓存存储，网络传输只能操作于二进制流，所以必须序列化。</p>
<p><strong>同步RPC-client的核心组件是什么？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同步<code>RPC-client</code>的核心组件是序列化组件、连接池组件。它通过连接池来实现负载均衡与故障转移，通过阻塞的收发来实现超时处理。</p>
<p><strong>异步RPC-client的核心组件是什么？</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;异步<code>RPC-client</code>的核心组件是<strong>序列化组件、连接池组件、收发队列、收发线程、上下文管理器、超时管理器</strong>。它通过“请求id”来关联请求包-响应包-回调函数，<strong>用上下文管理器来管理上下文，用超时管理器中的<code>timer</code>触发超时回调，推进业务流程的超时处理</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/15/中肯的Redis使用规范/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/中肯的Redis使用规范/" itemprop="url">中肯的Redis使用规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-15T12:12:57+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/Redis使用规范/" itemprop="url" rel="index">
                    <span itemprop="name">Redis使用规范</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="中肯的Redis使用规范"><a href="#中肯的Redis使用规范" class="headerlink" title="中肯的Redis使用规范"></a>中肯的Redis使用规范</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://juejin.im/post/5d03030ff265da1b957052e3" target="_blank" rel="noopener">https://juejin.im/post/5d03030ff265da1b957052e3</a></p>
</blockquote>
<p><br></p>
<h1 id="使用规范"><a href="#使用规范" class="headerlink" title="使用规范"></a>使用规范</h1><h2 id="冷热数据区分"><a href="#冷热数据区分" class="headerlink" title="冷热数据区分"></a>冷热数据区分</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽然 <code>Redis</code>支持持久化，但将所有数据存储在 <code>Redis</code> 中，成本非常昂贵。建议将热数据 (如 <code>QPS</code>超过 5k) 的数据加载到 <code>Redis</code>中。低频数据可存储在 <code>Mysql、 ElasticSearch</code>中。</p>
<h2 id="业务数据分离"><a href="#业务数据分离" class="headerlink" title="业务数据分离"></a>业务数据分离</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不要将不相关的数据业务都放到一个<code>Redis</code>中。一方面避免业务相互影响，另一方面避免单实例膨胀，并能在故障时降低影响面，快速恢复。</p>
<h2 id="消息大小限制"><a href="#消息大小限制" class="headerlink" title="消息大小限制"></a>消息大小限制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于<code>Redis</code>是单线程服务，消息过大会阻塞并拖慢其他操作。保持消息内容在<code>1KB</code> 以下是个好的习惯。严禁超过 <code>50KB</code>的单条记录。消息过大还会引起网络带宽的高占用，持久化到磁盘时的 <code>IO</code>问题。</p>
<h2 id="连接数限制"><a href="#连接数限制" class="headerlink" title="连接数限制"></a>连接数限制</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;连接的频繁创建和销毁，会浪费大量的系统资源，极限情况会造成宿主机宕机。请确保使用了正确的 <code>Redis</code> 客户端连接池配置。</p>
<h2 id="缓存-Key-设置失效时间"><a href="#缓存-Key-设置失效时间" class="headerlink" title="缓存 Key 设置失效时间"></a>缓存 Key 设置失效时间</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;作为缓存使用的 <code>Key</code>，必须要设置失效时间。失效时间并不是越长越好，请根据业务性质进行设置。注意，失效时间的单位有的是秒，有的是毫秒，这个很多同学不注意容易搞错。</p>
<h2 id="缓存不能有中间态"><a href="#缓存不能有中间态" class="headerlink" title="缓存不能有中间态"></a>缓存不能有中间态</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>缓存应该仅作缓存用，去掉后业务逻辑不应发生改变，万不可切入到业务里</strong>。</p>
<p>第一，<strong>缓存的高可用会影响业务</strong>；</p>
<p>第二，<strong>产生深耦合会发生无法预料的效果</strong>；</p>
<p>第三，<strong>会对维护行产生负效果</strong>；</p>
<h2 id="扩展方式首选客户端-hash"><a href="#扩展方式首选客户端-hash" class="headerlink" title="扩展方式首选客户端 hash"></a>扩展方式首选客户端 hash</h2><blockquote>
<p>小应用就算了</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如单<code>redis</code>集群并不能为你的数据服务，不要着急扩大你的 <code>redis</code>集群（包括<code>M/S</code>和<code>Cluster</code>)，集群越大，在状态同步和持久化方面的性能越差。 <strong>优先使用客户端 <code>hash</code>进行集群拆分</strong>。如：根据用户 id 分 10 个集群，用户尾号为 0 的落在第一个集群。</p>
<h1 id="操作限制"><a href="#操作限制" class="headerlink" title="操作限制"></a>操作限制</h1><h2 id="严禁使用-Keys"><a href="#严禁使用-Keys" class="headerlink" title="严禁使用 Keys"></a>严禁使用 Keys</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Keys</code> 命令效率极低，属于<code>O(N)</code>操作，会阻塞其他正常命令，在 <code>cluster</code>上，会是灾难性的操作。严禁使用，<code>DBA</code> 应该 <code>rename</code> 此命令，从根源禁用。<strong>使用scan命令迭代遍历</strong>。</p>
<h2 id="严禁使用-Flush"><a href="#严禁使用-Flush" class="headerlink" title="严禁使用 Flush"></a>严禁使用 Flush</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>flush</code> 命令会清空所有数据，属于高危操作。严禁使用，<code>DBA</code> 应该 <code>rename</code> 此命令，从根源禁用，仅 <code>DBA</code>可操作。</p>
<h2 id="严禁作为消息队列使用"><a href="#严禁作为消息队列使用" class="headerlink" title="严禁作为消息队列使用"></a>严禁作为消息队列使用</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如没有非常特殊的需求，严禁将 <code>Redis</code>当作消息队列使用。<code>Redis</code> 当作消息队列使用，会有容量、网络、效率、功能方面的多种问题。如需要消息队列，可使用高吞吐的<code>Kafka</code> 或者高可靠的 <code>RocketMQ</code>。</p>
<p><strong>不支持消息重复消费即不能够多个消费者同时消费一份数据</strong></p>
<p><strong>数据可靠性问题，可能存在丢失，不管RDB还是AOF持久化都有可能丢失一部分数据</strong></p>
<h2 id="严禁不设置范围的批量操作"><a href="#严禁不设置范围的批量操作" class="headerlink" title="严禁不设置范围的批量操作"></a>严禁不设置范围的批量操作</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>redis</code>那么快，慢查询除了网络延迟，就属于这些批量操作函数。大多数线上问题都是由于这些函数引起。</p>
<p>1、<code>[zset]</code>严禁对 <code>zset</code> 的不设范围操作</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>ZRANGE、 ZRANGEBYSCORE</code>等多个操作 <code>ZSET</code> 的函数，<strong>严禁使用<code>ZRANGE myzset 0 -1</code>等这种不设置范围的操作</strong>。请指定范围，如 <code>ZRANGE myzset 0 100</code>。如不确定长度，可使用 <code>ZCARD</code>判断长度</p>
<p>2、<code>[hash]</code><strong>严禁对大数据量 Key 使用 <code>HGETALL</code></strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>HGETALL</code>会取出相关 <code>HASH</code>的所有数据，如果数据条数过大，同样会引起阻塞，请确保业务可控。如不确定长度，可使用 <code>HLEN</code>先判断长度</p>
<p>3、<strong><code>[key] Redis Cluster</code>集群的 <code>mge</code>t 操作<code>Redis Cluster</code> 的 <code>MGET</code> 操作</strong>，会到各分片取数据聚合，相比传统的 <code>M/S</code>架构，性能会下降很多，请提前压测和评估</p>
<p>4、[其他] 严禁使用 <code>sunion, sinter, sdiff</code>等一些<strong>聚合操作</strong></p>
<h2 id="选择性禁用select-函数"><a href="#选择性禁用select-函数" class="headerlink" title="选择性禁用select 函数"></a>选择性禁用select 函数</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select函数用来切换 <code>database</code>，对于使用方来说，这是很容易发生问题的地方，<code>cluster</code>模式也不支持多个 <code>database</code>，且没有任何收益，禁用。</p>
<h2 id="选择性禁用事务"><a href="#选择性禁用事务" class="headerlink" title="选择性禁用事务"></a>选择性禁用事务</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>redis</code> 本身已经很快了，如无大的必要，建议捕获异常进行回滚，不要使用事务函数，很少有人这么干。</p>
<h2 id="选择性禁用-lua-脚本扩展"><a href="#选择性禁用-lua-脚本扩展" class="headerlink" title="选择性禁用 lua 脚本扩展"></a>选择性禁用 lua 脚本扩展</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>lua</code> 脚本虽然能做很多看起来很 <code>cool</code>的事情，但它就像是 <code>SQL</code>的存储过程，会引入性能和一些难以维护的问题，禁用。</p>
<h2 id="禁止长时间-monitor"><a href="#禁止长时间-monitor" class="headerlink" title="禁止长时间 monitor"></a>禁止长时间 monitor</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>monitor</code>函数可以快速看到当前<code>redis</code>正在执行的数据流，但是当心，高峰期长时间阻塞在 <code>monitor</code> 命令上，会严重影响<code>redis</code>的性能。此命令不禁止使用，但使用一定要特别特别注意。</p>
<blockquote>
<p>select 函数可能在多个业务共用同一个Redis实例时使用，用于切换db，隔离不同的业务线</p>
<p>事务、 lua 脚本扩展在实现多命令原子性操作时会用到，可以根据开发使用情况决定是否禁用</p>
</blockquote>
<h1 id="Key-规范"><a href="#Key-规范" class="headerlink" title="Key 规范"></a>Key 规范</h1><p> lua 脚本扩展<code>Redis</code> 的 <code>Key</code> 一定要规范，这样在遇到问题时，能够进行方便的定位。<code>Redis</code> 属于无 <code>scheme</code>的 <code>KV</code>数据库，所以，我们<strong>靠约定来建立其 scheme 语义</strong>。其好处：</p>
<p>1、能够根据某类 <code>key</code> 进行<strong>数据清理</strong></p>
<p>2、能够根据某类 <code>key</code>进行<strong>数据更新</strong></p>
<p>3、能够方面了解到某类 <code>key</code> 的<strong>归属方和应用场景</strong></p>
<p>4、<strong>为统一化、平台化做准备，减少技术变更</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一般，一个 <code>key</code>需要带以下维度：<strong>业务、key 用途、变量等，各个维度使用 : 进行分隔</strong>，以下是几个 <code>key</code> 的实例:</p>
<blockquote>
<p>user:sex 用户 10002232 的性别</p>
<p>msg:achi 201712 的用户发言数量排行榜</p>
</blockquote>
<h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;适当的约束是架构成熟的必要条件，通过约定能达到规范是集体开发的最高境界。<code>Redis</code>用的多，也要用的稳，给点约束、立点规矩，生活将变的美好。通过二次封装<code>redis</code>客户端，直接阻断，效果更佳。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/15/一篇文章带你学习分布式事务/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/15/一篇文章带你学习分布式事务/" itemprop="url">一篇文章带你学习分布式事务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-15T12:12:57+08:00">
                2019-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/分布式事务/" itemprop="url" rel="index">
                    <span itemprop="name">分布式事务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一篇文章带你学习分布式事务"><a href="#一篇文章带你学习分布式事务" class="headerlink" title="一篇文章带你学习分布式事务"></a>一篇文章带你学习分布式事务</h1><p><br></p>
<blockquote>
<p>原文地址：<a href="https://mp.weixin.qq.com/s/RDnf637MY0IVgv2NpNVByw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/RDnf637MY0IVgv2NpNVByw</a></p>
</blockquote>
<p><br></p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWsdrh2rSK3OGU4LzrCLPhdN7qDL36ZVfBAjkCxCeficvB4JJwyOxzuH8mXva1Dw3Miax9eVSY09mLicw.jpeg" alt="img"></p>
<p><strong>小蚂蚁说：</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式事务是企业集成中的一个技术难点，也是每一个分布式系统架构中都会涉及到的一个东西，特别是在这几年越来越火的微服务架构中，几乎可以说是无法避免，本文就围绕分布式事务各方面与大家进行介绍。</p>
<h2 id="一-事务"><a href="#一-事务" class="headerlink" title="一. 事务"></a>一. 事务</h2><h3 id="1-1-什么是事务"><a href="#1-1-什么是事务" class="headerlink" title="1.1 什么是事务"></a>1.1 什么是事务</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;数据库事务（简称：事务，<code>Transaction</code>）是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p>
<p><strong>事务拥有以下四个特性，习惯上被称为ACID特性：</strong></p>
<ol>
<li><p><strong>原子性</strong>（<code>Atomicity</code>）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</p>
</li>
<li><p><strong>一致性</strong>（<code>Consistency</code>）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足完整性约束。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到（这层语义也有说应该属于原子性）。</p>
</li>
<li><p><strong>隔离性</strong>（<code>Isolation</code>）：多个事务并发执行时，一个事务的执行不应影响其他事务的执行，如同只有这一个操作在被数据库所执行一样。</p>
</li>
<li><p><strong>持久性</strong>（<code>Durability</code>）：已被提交的事务对数据库的修改应该永久保存在数据库中。在事务结束时，此操作将不可逆转。</p>
</li>
</ol>
<h3 id="1-2-本地事务"><a href="#1-2-本地事务" class="headerlink" title="1.2 本地事务"></a>1.2 本地事务</h3><p>起初，事务仅限于对单一数据库资源的访问控制：</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcyicGRj2yfQu0VPCUIZaDgHaBGhDgd9txKMNLgtyTwFd2cUE4IGTFsjg.jpeg" alt="img"></p>
<p>架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源：</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWchnk0qgJwYRm5ZbD8Xw6TFazJYSHwJJoicqiarWRDcEE2ribKCOfKbfwfQ.jpeg" alt="img"></p>
<p>这类基于单个服务单一数据库资源访问的事务，被称为本地事务（<code>Local Transaction</code>）。</p>
<h2 id="二-分布式事务应用架构"><a href="#二-分布式事务应用架构" class="headerlink" title="二. 分布式事务应用架构"></a>二. 分布式事务应用架构</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本地事务主要限制在单个会话内，不涉及多个数据库资源。但是在基于<code>SOA</code>（<code>Service-Oriented Architecture</code>，面向服务架构）的分布式应用环境下，越来越多的<strong>应用要求对多个数据库资源，多个服务的访问都能纳入到同一个事务当中，分布式事务应运而生</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最早的分布式事务应用架构很简单，不涉及服务间的访问调用，<strong>仅仅是服务内操作涉及到对多个数据库资源的访问</strong>。</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcX8icicUw1EDVS0uEKXoy6u59zSeUQFCdz6ywgOia69uD8MD6B7ibRSYnrw.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>当一个服务操作访问不同的数据库资源，又希望对它们的访问具有事务特性时，就需要采用分布式事务来协调所有的事务参与者</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于上面介绍的分布式事务应用架构，尽管一个服务操作会访问多个数据库资源，但是毕竟整个事务还是控制在单一服务的内部。<strong>如果一个服务操作需要调用另外一个服务，这时的事务就需要跨越多个服务了。在这种情况下，起始于某个服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来</strong>。下图反映了这样一个跨越多个服务的分布式事务：</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcVfhaMyiaJ1NvgKbt2hibB6nkWSvgPFYwibgzoibOicibM3ibZ0CDbK9TuQ6qQ.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果将上面这两种场景（一个服务可以调用多个数据库资源，也可以调用其他服务）结合在一起，对此进行延伸，整个分布式事务的参与者将会组成如下图所示的<strong>树形拓扑结构</strong>。<strong>在一个跨服务的分布式事务中，事务的发起者和提交均系同一个，它可以是整个调用的客户端，也可以是客户端最先调用的那个服务</strong>。</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcFtibHJA9dYAvAnxzxnovUvXkdv4CwViauH9ibBCy5v3Loly9Qc1gkB1nw.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。尽管有这么多工程细节需要考虑，但分布式事务最核心的还是其 <code>ACID</code> 特性。因此，想要了解一个分布式事务，就先从了解它是怎么实现事务 <code>ACID</code>特性开始。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下文将从两个最常见的分布式事务模型入手，着重分析分布式事务的基础共通点，即如何保证分布式事务的 <code>ACID</code> 特性。</p>
<h2 id="三-常见分布式事务模型-ACID-实现分析"><a href="#三-常见分布式事务模型-ACID-实现分析" class="headerlink" title="三. 常见分布式事务模型 ACID 实现分析"></a>三. 常见分布式事务模型 ACID 实现分析</h2><h3 id="3-1-X-Open-XA-协议"><a href="#3-1-X-Open-XA-协议" class="headerlink" title="3.1 X/Open XA 协议"></a>3.1 X/Open XA 协议</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最早的分布式事务模型是<code>X/Open</code> 国际联盟提出的<code>X/Open Distributed Transaction Processing（DTP）</code>模型，也就是大家常说的<code>X/Open XA</code>协议，简称<code>XA</code>协议。</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWchFAphMkPOIf7c5HjAurVa96tZdicUic8h4uZSA1pt6OKQsjhw36ZvaCg.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>DTP</code> 模型中包含一个<strong>全局事务管理器（<code>TM，Transaction Manager</code>）和多个资源管理器（<code>RM，Resource Manager</code>）</strong>。全局事务管理器负责管理全局事务状态与参与的资源，协同资源一起提交或回滚；资源管理器则负责具体的资源操作。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>XA</code>协议描述了<code>TM</code>与 <code>RM</code>之间的接口，允许多个资源在同一分布式事务中访问。</p>
<p><strong>基于 DTP 模型的分布式事务流程大致如下：</strong></p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcPCI0OWxI0QiarG3sCyeRSVHEsjQJs3R0faUZiaPny0nySjW7f1rBKrKw.jpeg" alt="img"></p>
<ol>
<li><p>应用程序（<code>AP，Application</code>）向 <code>TM</code>申请开始一个全局事务。</p>
</li>
<li><p>针对要操作的 <code>RM</code>，AP 会先向<code>TM</code>注册（<code>TM</code> 负责记录 <code>AP</code> 操作过哪些 <code>RM</code>，即分支事务），<code>TM</code>通过 <code>XA</code>接口函数通知相应 <code>RM</code> 开启分布式事务的子事务，接着 <code>AP</code> 就可以对该<code>RM</code> 管理的资源进行操作。</p>
</li>
<li><p>当<code>AP</code> 对所有 <code>RM</code> 操作完毕后，<code>AP</code>根据执行情况通知<code>TM</code> 提交或回滚该全局事务，<code>TM</code>通过 <code>XA</code>接口函数通知各 <code>RM</code>完成操作。TM 会先要求各个 <code>RM</code>做预提交，所有 <code>RM</code>返回成功后，再要求各 <code>RM</code> 做正式提交，<code>XA</code> 协议要求，一旦<code>RM</code>预提交成功，则后续的正式提交也必须能成功；如果任意一个 <code>RM</code> 预提交失败，则 <code>TM</code> 通知各 <code>RM</code>回滚。</p>
</li>
<li><p>所有 <code>RM</code> 提交或回滚完成后，全局事务结束。</p>
</li>
</ol>
<h4 id="3-1-1-原子性"><a href="#3-1-1-原子性" class="headerlink" title="3.1.1 原子性"></a>3.1.1 原子性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>XA</code>协议使用 <code>2PC</code>（<code>Two Phase Commit</code>，两阶段提交）原子提交协议来保证分布式事务原子性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>两阶段提交是指将提交过程分为两个阶段，即准备阶段（投票阶段）和提交阶段（执行阶段）</strong>：</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWc63NRP9UOMSyaomhkr4NPwSZWhEliaxmhh7vDckMBj6EvJYpX4q3qYVg.jpeg" alt="img"></p>
<h5 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>TM</code>向每个 <code>RM</code>发送准备消息。如果<code>RM</code> 的本地事务操作执行成功，则返回成功；如果<code>RM</code>的本地事务操作执行失败，则返回失败。</p>
<h5 id="提交阶段"><a href="#提交阶段" class="headerlink" title="提交阶段"></a>提交阶段</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果 <code>TM</code>收到了所有<code>RM</code>回复的成功消息，则向每个 <code>RM</code>发送提交消息；否则发送回滚消息；<code>RM</code>根据<code>TM</code> 的指令执行提交或者回滚本地事务操作，释放所有事务处理过程中使用的锁资源。</p>
<h4 id="3-1-2-隔离性"><a href="#3-1-2-隔离性" class="headerlink" title="3.1.2 隔离性"></a>3.1.2 隔离性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>XA</code> 协议中没有描述如何实现分布式事务的隔离性，但是<code>XA</code> 协议要求<code>DTP</code> 模型中的每个<code>RM</code>都要实现本地事务，也就是说，基于 <code>XA</code>协议实现的分布式事务的隔离性是由每个<code>RM</code> 本地事务的隔离性来保证的，当一个分布式事务的所有子事务都是隔离的，那么这个分布式事务天然的就实现了隔离性</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以 <code>MySQL</code> 来举例，<strong><code>MySQL</code>使用<code>2PL</code>（<code>Two-Phase Locking</code>，两阶段锁）机制来控制本地事务的并发，保证隔离性</strong>。<strong><code>2PL</code> 与 <code>2PC</code> 类似，也是将锁操作分为加锁和解锁两个阶段，并且保证两个阶段完全不相交</strong>。加锁阶段，只加锁，不放锁。解锁阶段，只放锁，不加锁。</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcMJicwWxibBoEVPnJjJymqaFasjLECqpiaINZQw7m3DRn7PpvoefIobttg.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图所示，<strong>在一个本地事务中，每执行一条更新操作之前，都会先获取对应的锁资源，只有获取锁资源成功才会执行该操作，并且一旦获取了锁资源就会持有该锁资源直到本事务执行结束</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>MySQL</code> 通过这种<code>2PL</code>机制，可以保证在本地事务执行过程中，其他并发事务不能操作相同资源，从而实现了事务隔离</strong>。</p>
<h4 id="3-1-3-一致性"><a href="#3-1-3-一致性" class="headerlink" title="3.1.3 一致性"></a>3.1.3 一致性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前面提到一致性有两层语义，<strong>一层是确保事务执行结束后，数据库从一个一致状态转变为另一个一致状态</strong>。<strong>另一层语义是事务执行过程中的中间状态不能被观察到</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;前一层语义的实现很简单，通过原子性、隔离性以及 <code>RM</code> 自身一致性的实现就可以保证。至于后一层语义，我们先来看看单个<code>RM</code> 上的本地事务是怎么实现的。还是以 <code>MySQL</code> 举例，<strong><code>MySQL</code> 通过 <code>MVCC</code>（<code>Multi Version Concurrency Control</code>，多版本并发控制）机制，为每个一致性状态生成快照（<code>Snapshot</code>），每个事务看到的都是各<code>Snapshot</code>对应的一致性状态，从而也就保证了本地事务的中间状态不会被观察到</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽然单个 <code>RM</code> 上实现了<code>Snapshot</code>，但是在分布式应用架构下，会遇到什么问题呢？</p>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWcxIUrzRp8kibMEhHGgpdMscUNjjTebrhtDsj2DWmcna0gZ1EoZ3x42SQ.jpeg" alt="img"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图所示，在 <code>RM1</code>的本地子事务提交完毕到 <code>RM2</code> 的本地子事务提交完毕之间，只能读到 <code>RM1</code>上子事务执行的内容，读不到<code>RM2</code>上的子事务【事务提交存在时间差，导致前面提交的事务被提前看到了变更后的状态即全局事务的某个中间状态】。也就是说，<strong>虽然在单个 <code>RM</code> 上的本地事务是一致的，但是从全局来看，一个全局事务执行过程的中间状态被观察到了，全局一致性就被破坏了</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>XA</code>协议并没有定义怎么实现全局的 <code>Snapshot</code>，像 <code>MySQL</code> 官方文档里就建议使用串行化的隔离级别来保证分布式事务一致性： <code>“As with nondistributed transactions, SERIALIZABLE may be preferred if your applications are sensitive to read phenomena. REPEATABLE READ may not be sufficient for distributed transactions.”</code>（<strong>对于分布式事务来说，可重复读隔离级别不足以保证事务一致性，如果你的程序有全局一致性读要求，可以考虑串行化隔离级别</strong>）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，由于串行化隔离级别的性能较差，所以很多分布式数据库都自己实现了分布式<code>MVCC 机</code>制来提供全局的一致性读。<strong>一个基本思路是用一个集中式或者逻辑上单调递增的东西来控制生成全局 <code>Snapshot</code>，每个事务或者每条 <code>SQL</code> 执行时都去获取一次，从而实现不同隔离级别下的一致性</strong>。比如<code>Google</code>的<code>Spanner</code> 就是用<code>TrueTime</code> 来控制访问全局 <code>Snapshot</code>。</p>
<h4 id="3-1-4-小结"><a href="#3-1-4-小结" class="headerlink" title="3.1.4 小结"></a>3.1.4 小结</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>XA</code> 协议通常实现在数据库资源层，直接作用于资源管理器上</strong>。因此，基于 <code>XA</code>协议实现的分布式事务产品，无论是分布式数据库，还是分布式事务框架，对业务几乎都没有侵入，就像使用普通数据库一样。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>XA</code>协议严格保障事务 <code>ACID</code>特性，能够满足所有业务领域的功能需求，但是，这同样是一把双刃剑。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>由于隔离性的互斥要求，在事务执行过程中，所有的资源都被锁定，只适用于执行时间确定的短事务</strong>。同时，整个事务期间都是独占数据，对于热点数据的并发性能可能会很低，实现了分布式 <code>MVCC</code> 或乐观锁（<code>optimistic locking</code>）以后，性能可能会有所提升。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，<strong>为了保障一致性，要求所有 <code>RM</code> 同等可信、可靠，要求故障恢复机制可靠、快速，在网络故障隔离的情况下，服务基本不可用</strong>。</p>
<h3 id="3-2-TCC-模型"><a href="#3-2-TCC-模型" class="headerlink" title="3.2 TCC 模型"></a>3.2 TCC 模型</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>TCC（Try-Confirm-Cancel）</code>分布式事务模型相对于<code>XA</code> 等传统模型，<strong>其特征在于它不依赖资源管理器（<code>RM</code>）对分布式事务的支持，而是通过对业务逻辑的分解来实现分布式事务</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>TCC</code>模型认为对于业务系统中一个特定的业务逻辑，<strong>其对外提供服务时，必须接受一些不确定性，即对业务逻辑初步操作的调用仅是一个临时性操作，调用它的主业务服务保留了后续的取消权</strong>。如果主业务服务认为全局事务应该回滚，它会要求取消之前的临时性操作，这就对应从业务服务的取消操作。而当主业务服务认为全局事务应该提交时，它会放弃之前临时性操作的取消权，这对应从业务服务的确认操作。<strong>每一个初步操作，最终都会被确认或取消</strong>。</p>
<p><strong>因此，针对一个具体的业务服务，TCC 分布式事务模型需要业务系统提供三段业务逻辑：</strong></p>
<ol>
<li><strong>初步操作<code>Try</code></strong>：完成所有业务检查，预留必须的业务资源。</li>
<li><strong>确认操作 <code>Confirm</code></strong>：真正执行的业务逻辑，不作任何业务检查，只使用 <code>Try</code>阶段预留的业务资源。因此，只要 <code>Try</code>操作成功，<code>Confirm</code> 必须能成功。另外，<code>Confirm</code> 操作需满足<strong>幂等性</strong>，保证一笔分布式事务有且只能成功一次。</li>
<li><strong>取消操作<code>Cancel</code></strong>：释放<code>Try</code> 阶段预留的业务资源。同样的，<code>Cancel</code>操作也需要满足幂等性。</li>
</ol>
<p><img src="//blog.com/2019/06/15/一篇文章带你学习分布式事务/8zGb2W5DJWvfUw7bQiahhMqXO06ryEoWc08pvLUePde6ib7yQD8Xyf2cK1eE554IpGK5G0PXyjYAOzpZAqB4S8xA.jpeg" alt="img"></p>
<p><strong>TCC 分布式事务模型包括三部分：</strong></p>
<ol>
<li><p><strong>主业务服务：</strong>主业务服务为整个业务活动的发起方，服务的编排者，负责发起并完成整个业务活动。</p>
</li>
<li><p><strong>从业务服务：</strong>从业务服务是整个业务活动的参与方，负责提供 <code>TCC</code> 业务操作，实现初步操作（<code>Try</code>）、确认操作（<code>Confirm</code>）、取消操作（<code>Cancel</code>）<strong>三个接口</strong>，供主业务服务调用。</p>
</li>
<li><p><strong>业务活动管理器：</strong>业务活动管理器管理控制整个业务活动，包括记录维护 <code>TCC</code> 全局事务的事务状态和每个从业务服务的子事务状态，并<strong>在业务活动提交时调用所有从业务服务的<code>Confirm</code>操作，在业务活动取消时调用所有从业务服务的 <code>Cancel</code> 操作</strong>。</p>
</li>
</ol>
<p><strong>一个完整的 TCC 分布式事务流程如下：</strong></p>
<ol>
<li><p>主业务服务首先开启本地事务；</p>
</li>
<li><p>主业务服务向业务活动管理器申请启动分布式事务主业务活动；</p>
</li>
<li><p>然后针对要调用的从业务服务，主业务活动先向业务活动管理器注册从业务活动，然后调用从业务服务的 <code>Try</code>接口；</p>
</li>
<li><p>当所有从业务服务的<code>Try</code>接口调用成功，主业务服务提交本地事务；若调用失败，主业务服务回滚本地事务；</p>
</li>
<li><p><strong>若主业务服务提交本地事务，则<code>TCC</code>模型分别调用所有从业务服务的<code>Confirm</code>接口；若主业务服务回滚本地事务，则分别调用 <code>Cancel</code>接口</strong>；</p>
</li>
<li><p>所有从业务服务的 <code>Confirm</code> 或 <code>Cancel</code>操作完成后，全局事务结束。</p>
</li>
</ol>
<h4 id="3-2-1-原子性"><a href="#3-2-1-原子性" class="headerlink" title="3.2.1 原子性"></a>3.2.1 原子性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>TCC</code>模型也使用<code>2PC</code> 原子提交协议来保证事务原子性</strong>。<strong><code>Try</code> 操作对应<code>2PC</code> 的一阶段准备（<code>Prepare</code>）；<code>Confirm</code> 对应 <code>2PC</code>的二阶段提交（<code>Commit</code>），<code>Cancel</code>对应 <code>2PC</code> 的二阶段回滚（<code>Rollback</code>），可以说 <code>TCC</code>就是应用层的 <code>2PC</code></strong>。</p>
<h4 id="3-2-2-隔离性"><a href="#3-2-2-隔离性" class="headerlink" title="3.2.2 隔离性"></a>3.2.2 隔离性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>TCC</code>分布式事务模型仅提供两阶段原子提交协议，保证分布式事务原子性</strong>。<strong>事务的隔离交给业务逻辑来实现</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>隔离的本质是控制并发，防止并发事务操作相同资源而引起的结果错乱</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;举个例子，比如金融行业里管理用户资金，当用户发起交易时，一般会先检查用户资金，如果资金充足，则扣除相应交易金额，增加卖家资金，完成交易。如果没有事务隔离，用户同时发起两笔交易，两笔交易的检查都认为资金充足，实际上却只够支付一笔交易，结果两笔交易都支付成功，导致资损。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以发现，<strong>并发控制是业务逻辑执行正确的保证，但是像两阶段锁这样的并发访问控制技术要求一直持有数据库资源锁直到整个事务执行结束，特别是在分布式事务架构下，要求持有锁到分布式事务第二阶段执行结束，也就是说，分布式事务会加长资源锁的持有时间，导致并发性能进一步下降</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因此，<strong>TCC 模型的隔离性思想就是通过业务的改造，在第一阶段结束之后，从底层数据库资源层面的加锁过渡为上层业务层面的加锁，从而释放底层数据库锁资源，放宽分布式事务锁协议，提高业务并发性能</strong>。</p>
<p>还是以上面的例子举例：</p>
<ol>
<li><p>第一阶段：检查用户资金，如果资金充足，冻结用户本次交易资金，这笔资金被<strong>业务隔离，不允许除本事务之外的其它并发事务动用</strong>   =&gt; 可以标记为<strong>处理中</strong>。</p>
</li>
<li><p>第二阶段：扣除第一阶段预冻结的用户资金，增加卖家资金，完成交易。 采用业务加锁的方式，隔离用户冻结资金，在第一阶段结束后直接释放底层资源锁，该用户和卖家的其他交易都可以立刻并发执行，而不用等到整个分布式事务结束，可以获得更高的并发交易能力。</p>
</li>
</ol>
<h4 id="3-2-3-一致性"><a href="#3-2-3-一致性" class="headerlink" title="3.2.3 一致性"></a>3.2.3 一致性</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;再来看看<code>TCC</code>分布式事务模型下的一致性实现。与 <code>XA</code> 协议实现一致性第一层语义类似，通过原子性保证事务的原子提交、业务隔离性控制事务的并发访问，实现分布式事务的一致性状态转变。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至于第二层语义：事务的中间状态不能被观察到。我们来看看，在<code>SOA</code>分布式应用环境下是否是必须的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还是以账务服务举例。转账业务（用户 A  用户 B），由交易服务和账务服务组成分布式事务，交易服务作为主业务服务，账务服务作为从业务服务，账务服务的 <code>Try</code> 操作预冻结用户 A 的资金；<code>Commit</code>操作扣除用户 A 的预冻结资金，增加用户 B 的可用资金；<code>Cancel</code>操作解冻用户 A 的预冻结资金。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当账务服务执行完 <code>Try</code> 阶段后，交易主业务就可以 <code>Commit</code> 了，然后由<code>TCC</code> 框架调用账务的 <code>Commit</code>阶段。<strong>在账务 <code>Commit</code>阶段还没执行结束的时候，用户 A 可以查询到自己的余额已扣除，但是，此时用户 B 的可用资金还没增加</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从系统的角度来看，确实有问题与不确定性。<strong>在第一阶段执行结束到第二阶段执行结束之间，有一段时间的延时，在这段时间内，看似任何用户都不享有这笔资产</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，从用户的角度来考虑这个问题的话，这个时间间隔可能就无所谓或者根本就不存在。<strong>特别是当这个时间间隔仅仅是几秒钟，对于具体沟通资产转移的用户来讲，这个过程是隐蔽的或确实可以接受的，且保证了结果的最终一致性</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然，对于这样的系统，如果确实需要查看系统的某个一致性状态，可以采用额外的方法实现。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>一般来讲，服务之间的一致性比服务内部的一致性要更加容易弱化</strong>，这也是为什么 <code>XA</code>等直接在资源层面上实现通用分布式事务的模型会注重一致性的保证，而当上升到服务层面，<strong>服务与服务之间已经实现了功能的划分，逻辑的解耦，也就更容易弱化一致性，这就是<code>SOA</code>架构下 <code>BASE</code> 理论的最终一致性思想</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>BASE 理论是指 BA（Basic Availability，基本业务可用性）；S（Soft state，柔性状态）；E（Eventual consistency，最终一致性）。</strong>该理论认为为了可用性、性能与降级服务的需要，可以适当降低一点一致性的要求，即“<strong>基本可用，最终一致</strong>”。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业内通常把严格遵循 <code>ACID</code>的事务称为刚性事务；而<strong>基于<code>BASE</code> 思想实现的事务称为柔性事务</strong>。<strong>柔性事务并不是完全放弃了 <code>ACID</code>，仅仅是放宽了一致性要求：事务完成后的一致性严格遵循，事务中的一致性可适当放宽</strong>；</p>
<h4 id="3-2-4-小结"><a href="#3-2-4-小结" class="headerlink" title="3.2.4 小结"></a>3.2.4 小结</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>TCC</code> 分布式事务模型的业务实现特性决定了其可以跨<code>DB</code>、跨服务实现资源管理，将对不同的 <code>DB</code> 访问、不同的业务操作通过<code>TCC</code>模型协调为一个原子操作，解决了分布式应用架构场景下的事务问题</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong><code>TCC</code>模型通过<code>2PC</code>原子提交协议保证分布式事务的的原子性，把资源层的隔离性上升到业务层，交给业务逻辑来实现</strong>。<strong><code>TCC</code>的每个操作对于资源层来说，就是单个本地事务的使用，操作结束则本地事务结束，规避了资源层在 <code>2PC</code> 和 <code>2PL</code> 下对资源占用导致的性能低下问题</strong>。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时，<code>TCC</code>模型也可以根据业务需要，做一些定制化的功能，比如交易异步化实现削峰填谷等。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是，业务接入 <code>TCC</code> 模型需要拆分业务逻辑成两个阶段，并实现 <code>Try、Confirm、Cancel</code> 三个接口，<strong>定制化程度高，开发成本高</strong>。</p>
<h2 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文首先介绍了典型的分布式事务的架构场景。分布式事务刚开始是为解决单服务多数据库资源的场景而诞生的。随着技术的发展，特别是 <code>SOA</code>分布式应用架构以及微服务时代的到来，服务变成了基本业务单元。因此，又产生了跨服务的分布式事务需求。然后从<code>XA</code> 和 <code>TCC</code> 两种常用的分布式事务模型入手，介绍了其实现机制，着重分析了各模型是如何实现分布式事务<code>ACID</code>特性的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.com/2019/06/14/Laravel定时任务源码分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘泽明">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="搬运工 + 践行者">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/14/Laravel定时任务源码分析/" itemprop="url">Laravel定时任务源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-14T12:12:57+08:00">
                2019-06-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/Laravel/定时任务/" itemprop="url" rel="index">
                    <span itemprop="name">定时任务</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel定时任务源码分析"><a href="#Laravel定时任务源码分析" class="headerlink" title="Laravel定时任务源码分析"></a>Laravel定时任务源码分析</h1><blockquote>
<p>laravel\vendor\laravel\framework\src\Illuminate\Console</p>
</blockquote>
<h2 id="定时任务调度管理类Schedule"><a href="#定时任务调度管理类Schedule" class="headerlink" title="定时任务调度管理类Schedule"></a>定时任务调度管理类Schedule</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Application</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Container</span>\<span class="title">Container</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Process</span>\<span class="title">ProcessUtils</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Schedule</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务相关的事件列表</span></span><br><span class="line"><span class="comment">     * All of the events on the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Console\Scheduling\Event[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $events = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 防止任务重复执行的进程锁</span></span><br><span class="line"><span class="comment">     * The mutex implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Console\Scheduling\Mutex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $mutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new schedule instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $container = Container::getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mutex = $container-&gt;bound(Mutex::class)</span><br><span class="line">                                ? $container-&gt;make(Mutex::class)</span><br><span class="line">                                : $container-&gt;make(CacheMutex::class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个PHP的可执行Closure，可以是一个闭包、PHP对象可执行函数</span></span><br><span class="line"><span class="comment">     * Add a new callback event to the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string|callable  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array   $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Console\Scheduling\CallbackEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">($callback, array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;events[] = $event = <span class="keyword">new</span> CallbackEvent(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mutex, $callback, $parameters</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个Artisan Command</span></span><br><span class="line"><span class="comment">     * Add a new Artisan command event to the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $command</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Console\Scheduling\Event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">command</span><span class="params">($command, array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// getName() 返回command的非空signature</span></span><br><span class="line">        <span class="keyword">if</span> (class_exists($command)) &#123;</span><br><span class="line">            $command = Container::getInstance()-&gt;make($command)-&gt;getName();</span><br><span class="line">        &#125;</span><br><span class="line">	    <span class="comment">// Application::formatCommandString 将返回php artisan xxx		</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;exec(</span><br><span class="line">            Application::formatCommandString($command), $parameters</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * job 方法可用于调度一个队列任务，通过该方法可以很方便地调度任务而不必调用 call 方法手动创建闭包来推送任务到队列</span></span><br><span class="line"><span class="comment">     * Add a new job callback event to the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  object|string  $job</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Console\Scheduling\CallbackEvent</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">job</span><span class="params">($job)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;call(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($job)</span> </span>&#123;</span><br><span class="line">            dispatch(is_string($job) ? resolve($job) : $job);</span><br><span class="line">        &#125;)-&gt;name(is_string($job) ? $job : get_class($job));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加一个shell命令</span></span><br><span class="line"><span class="comment">     * Add a new command event to the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $command</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Console\Scheduling\Event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span><span class="params">($command, array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (count($parameters)) &#123;</span><br><span class="line">            $command .= <span class="string">' '</span>.<span class="keyword">$this</span>-&gt;compileParameters($parameters);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;events[] = $event = <span class="keyword">new</span> Event(<span class="keyword">$this</span>-&gt;mutex, $command);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $event;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数转义，组装shell命令参数</span></span><br><span class="line"><span class="comment">     * Compile parameters for a command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">compileParameters</span><span class="params">(array $parameters)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> collect($parameters)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">                <span class="comment">// 数组拼接为空格分割的字符串</span></span><br><span class="line">                $value = collect($value)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> ProcessUtils::escapeArgument($value);</span><br><span class="line">                &#125;)-&gt;implode(<span class="string">' '</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (! is_numeric($value) &amp;&amp; ! preg_match(<span class="string">'/^(-.$|--.*)/i'</span>, $value)) &#123;</span><br><span class="line">                $value = ProcessUtils::escapeArgument($value);</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// key为字符串保留 数字舍弃</span></span><br><span class="line">            <span class="keyword">return</span> is_numeric($key) ? $value : <span class="string">"&#123;$key&#125;=&#123;$value&#125;"</span>;</span><br><span class="line">        &#125;)-&gt;implode(<span class="string">' '</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get all of the events on the schedule that are due.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dueEvents</span><span class="params">($app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> collect(<span class="keyword">$this</span>-&gt;events)-&gt;filter-&gt;isDue($app);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回事件列表</span></span><br><span class="line"><span class="comment">     * Get all of the events on the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Console\Scheduling\Event[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">events</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;events;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="执行表达式构建器ManagesFrequencies"><a href="#执行表达式构建器ManagesFrequencies" class="headerlink" title="执行表达式构建器ManagesFrequencies"></a>执行表达式构建器ManagesFrequencies</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> ManagesFrequencies</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置执行表达式</span></span><br><span class="line"><span class="comment">     * The Cron expression representing the event's frequency.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $expression</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cron</span><span class="params">($expression)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;expression = $expression;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run between start and end time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $startTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $endTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">between</span><span class="params">($startTime, $endTime)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;when(<span class="keyword">$this</span>-&gt;inTimeInterval($startTime, $endTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to not run between start and end time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $startTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $endTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unlessBetween</span><span class="params">($startTime, $endTime)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skip(<span class="keyword">$this</span>-&gt;inTimeInterval($startTime, $endTime));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run between start and end time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $startTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $endTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Closure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">inTimeInterval</span><span class="params">($startTime, $endTime)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($startTime, $endTime)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Carbon::now(<span class="keyword">$this</span>-&gt;timezone)-&gt;between(</span><br><span class="line">                Carbon::parse($startTime, <span class="keyword">$this</span>-&gt;timezone),</span><br><span class="line">                Carbon::parse($endTime, <span class="keyword">$this</span>-&gt;timezone),</span><br><span class="line">                <span class="keyword">true</span></span><br><span class="line">            );</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run hourly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hourly</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run hourly at a given offset in the hour.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hourlyAt</span><span class="params">($offset)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, $offset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run daily.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">daily</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the command at a given time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">at</span><span class="params">($time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dailyAt($time);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run daily at a given time (10:00, 19:30, etc).</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dailyAt</span><span class="params">($time)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $segments = explode(<span class="string">':'</span>, $time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">2</span>, (int) $segments[<span class="number">0</span>])</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">1</span>, count($segments) == <span class="number">2</span> ? (int) $segments[<span class="number">1</span>] : <span class="string">'0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run twice daily.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $first</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $second</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">twiceDaily</span><span class="params">($first = <span class="number">1</span>, $second = <span class="number">13</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $hours = $first.<span class="string">','</span>.$second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, $hours);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on weekdays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">weekdays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">5</span>, <span class="string">'1-5'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on weekends.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">weekends</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">5</span>, <span class="string">'0,6'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Mondays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mondays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Tuesdays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tuesdays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Wednesdays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wednesdays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Thursdays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">thursdays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Fridays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fridays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Saturdays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saturdays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run only on Sundays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sundays</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;days(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run weekly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">weekly</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">5</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run weekly on a given day and time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $day</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">weeklyOn</span><span class="params">($day, $time = <span class="string">'0:0'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dailyAt($time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">5</span>, $day);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run monthly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">monthly</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run monthly on a given day and time.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $day</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">monthlyOn</span><span class="params">($day = <span class="number">1</span>, $time = <span class="string">'0:0'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dailyAt($time);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">3</span>, $day);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run twice monthly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $first</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $second</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">twiceMonthly</span><span class="params">($first = <span class="number">1</span>, $second = <span class="number">16</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $days = $first.<span class="string">','</span>.$second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">            -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">            -&gt;spliceIntoPosition(<span class="number">3</span>, $days);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run quarterly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">quarterly</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">4</span>, <span class="string">'*/3'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run yearly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">yearly</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">                    -&gt;spliceIntoPosition(<span class="number">4</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run every minute.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">everyMinute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="string">'*'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run every five minutes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">everyFiveMinutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="string">'*/5'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run every ten minutes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">everyTenMinutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="string">'*/10'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Schedule the event to run every thirty minutes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">everyThirtyMinutes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">1</span>, <span class="string">'0,30'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the days of the week the command should run on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|mixed  $days</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">days</span><span class="params">($days)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $days = is_array($days) ? $days : func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;spliceIntoPosition(<span class="number">5</span>, implode(<span class="string">','</span>, $days));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the timezone the date should be evaluated on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \DateTimeZone|string  $timezone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">timezone</span><span class="params">($timezone)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;timezone = $timezone;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Splice the given value into the given position of the expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $position</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">spliceIntoPosition</span><span class="params">($position, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $segments = explode(<span class="string">' '</span>, <span class="keyword">$this</span>-&gt;expression);</span><br><span class="line"></span><br><span class="line">        $segments[$position - <span class="number">1</span>] = $value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cron(implode(<span class="string">' '</span>, $segments));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="command或者shell命令-任务对象Event（基类）"><a href="#command或者shell命令-任务对象Event（基类）" class="headerlink" title="command或者shell命令  任务对象Event（基类）"></a>command或者shell命令  任务对象Event（基类）</h2><blockquote>
<p>任务承载类</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Cron</span>\<span class="title">CronExpression</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span> <span class="title">as</span> <span class="title">HttpClient</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Mail</span>\<span class="title">Mailer</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Process</span>\<span class="title">Process</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Traits</span>\<span class="title">Macroable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Container</span>\<span class="title">Container</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// Macroable 通过__call + 闭包 + 数组 扩展功能</span></span><br><span class="line">    <span class="comment">// ManagesFrequencies 调用频率解析 组装相应表达式</span></span><br><span class="line">    <span class="keyword">use</span> <span class="title">Macroable</span>, <span class="title">ManagesFrequencies</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 命令字符串 如：php arstian xxx, bash test.sh</span></span><br><span class="line"><span class="comment">     * The command string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $command;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行频率相关的表达式</span></span><br><span class="line"><span class="comment">     * The cron expression representing the event's frequency.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $expression = <span class="string">'* * * * * *'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时区</span></span><br><span class="line"><span class="comment">     * The timezone the date should be evaluated on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \DateTimeZone|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $timezone;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行用户</span></span><br><span class="line"><span class="comment">     * The user the command should run as.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许执行的配置环境列表</span></span><br><span class="line"><span class="comment">     * The list of environments the command should run under.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $environments = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否在维护模式</span></span><br><span class="line"><span class="comment">     * Indicates if the command should run in maintenance mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $evenInMaintenanceMode = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否允许同一时刻多个进程并发执行</span></span><br><span class="line"><span class="comment">     * Indicates if the command should not overlap itself.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $withoutOverlapping = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进程锁的有效时间</span></span><br><span class="line"><span class="comment">     * The amount of time the mutex should be valid.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $expiresAt = <span class="number">1440</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否后台运行</span></span><br><span class="line"><span class="comment">     * Indicates if the command should run in background.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $runInBackground = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行前条件肯定检查</span></span><br><span class="line"><span class="comment">     * The array of filter callbacks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $filters = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行前条件否定检查</span></span><br><span class="line"><span class="comment">     * The array of reject callbacks.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $rejects = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标准输出重定向地址</span></span><br><span class="line"><span class="comment">     * The location that output should be sent to.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $output = <span class="string">'/dev/null'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否允许日志输出</span></span><br><span class="line"><span class="comment">     * Indicates whether output should be appended.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $shouldAppendOutput = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行前置操作</span></span><br><span class="line"><span class="comment">     * The array of callbacks to be run before the event is started.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $beforeCallbacks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行后置操作</span></span><br><span class="line"><span class="comment">     * The array of callbacks to be run after the event is finished.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $afterCallbacks = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述信息</span></span><br><span class="line"><span class="comment">     * The human readable description of the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $description;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进程锁</span></span><br><span class="line"><span class="comment">     * The mutex implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Console\Scheduling\Mutex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $mutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new event instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Mutex  $mutex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $command</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Mutex $mutex, $command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mutex = $mutex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;command = $command;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;output = <span class="keyword">$this</span>-&gt;getDefaultOutput();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the default output depending on the OS.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDefaultOutput</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DIRECTORY_SEPARATOR == <span class="string">'\\'</span>) ? <span class="string">'NUL'</span> : <span class="string">'/dev/null'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;withoutOverlapping &amp;&amp;</span><br><span class="line">            ! <span class="keyword">$this</span>-&gt;mutex-&gt;create(<span class="keyword">$this</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;runInBackground</span><br><span class="line">                    ? <span class="keyword">$this</span>-&gt;runCommandInBackground($container)</span><br><span class="line">                    : <span class="keyword">$this</span>-&gt;runCommandInForeground($container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取进程锁标不小心配置了识 执行表达式+shell命令 sha1保证不会重复  但是不小心配置了多个执行表达式时会存在bug,同一时刻有可能会调用多次</span></span><br><span class="line"><span class="comment">     * Get the mutex name for the scheduled command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mutexName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'framework'</span>.DIRECTORY_SEPARATOR.<span class="string">'schedule-'</span>.sha1(<span class="keyword">$this</span>-&gt;expression.<span class="keyword">$this</span>-&gt;command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the command in the foreground.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runCommandInForeground</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callBeforeCallbacks($container);</span><br><span class="line"></span><br><span class="line">        (<span class="keyword">new</span> Process(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;buildCommand(), base_path(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span></span><br><span class="line">        ))-&gt;run();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;callAfterCallbacks($container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the command in the background.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runCommandInBackground</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callBeforeCallbacks($container);</span><br><span class="line"></span><br><span class="line">        (<span class="keyword">new</span> Process(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;buildCommand(), base_path(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span></span><br><span class="line">        ))-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Call all of the "before" callbacks for the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callBeforeCallbacks</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;beforeCallbacks <span class="keyword">as</span> $callback) &#123;</span><br><span class="line">            $container-&gt;call($callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Call all of the "after" callbacks for the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callAfterCallbacks</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;afterCallbacks <span class="keyword">as</span> $callback) &#123;</span><br><span class="line">            $container-&gt;call($callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build the command string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildCommand</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> CommandBuilder)-&gt;buildCommand(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否满足执行条件【时间+环境+状态】</span></span><br><span class="line"><span class="comment">     * Determine if the given event should run based on the Cron expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isDue</span><span class="params">($app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 是否处理维护模式</span></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;runsInMaintenanceMode() &amp;&amp; $app-&gt;isDownForMaintenance()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// expressionPasses 时间检查</span></span><br><span class="line">        <span class="comment">// environment 环境检查</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;expressionPasses() &amp;&amp;</span><br><span class="line">               <span class="keyword">$this</span>-&gt;runsInEnvironment($app-&gt;environment());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the event runs in maintenance mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runsInMaintenanceMode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;evenInMaintenanceMode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前时间是否符合这个执行表达式条件</span></span><br><span class="line"><span class="comment">     * Determine if the Cron expression passes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">expressionPasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $date = Carbon::now();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;timezone) &#123;</span><br><span class="line">            $date-&gt;setTimezone(<span class="keyword">$this</span>-&gt;timezone);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CronExpression::factory(<span class="keyword">$this</span>-&gt;expression)-&gt;isDue($date-&gt;toDateTimeString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the event runs in the given environment.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $environment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runsInEnvironment</span><span class="params">($environment)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;environments) || in_array($environment, <span class="keyword">$this</span>-&gt;environments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行前条件检查</span></span><br><span class="line"><span class="comment">     * Determine if the filters pass for the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Foundation\Application  $app</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filtersPass</span><span class="params">($app)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// true 执行</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;filters <span class="keyword">as</span> $callback) &#123;</span><br><span class="line">            <span class="keyword">if</span> (! $app-&gt;call($callback)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// false 执行</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;rejects <span class="keyword">as</span> $callback) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($app-&gt;call($callback)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send the output of the command to a given location.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $location</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool  $append</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendOutputTo</span><span class="params">($location, $append = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;output = $location;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;shouldAppendOutput = $append;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Append the output of the command to a given location.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $location</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">appendOutputTo</span><span class="params">($location)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sendOutputTo($location, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * E-mail the results of the scheduled operation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|mixed  $addresses</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool  $onlyIfOutputExists</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \LogicException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">emailOutputTo</span><span class="params">($addresses, $onlyIfOutputExists = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ensureOutputIsBeingCapturedForEmail();</span><br><span class="line"></span><br><span class="line">        $addresses = is_array($addresses) ? $addresses : [$addresses];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">(Mailer $mailer)</span> <span class="title">use</span> <span class="params">($addresses, $onlyIfOutputExists)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;emailOutput($mailer, $addresses, $onlyIfOutputExists);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * E-mail the results of the scheduled operation if it produces output.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|mixed  $addresses</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \LogicException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">emailWrittenOutputTo</span><span class="params">($addresses)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;emailOutputTo($addresses, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Ensure that output is being captured for email.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">ensureOutputIsBeingCapturedForEmail</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;output) || <span class="keyword">$this</span>-&gt;output == <span class="keyword">$this</span>-&gt;getDefaultOutput()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sendOutputTo(storage_path(<span class="string">'logs/schedule-'</span>.sha1(<span class="keyword">$this</span>-&gt;mutexName()).<span class="string">'.log'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * E-mail the output of the event to the recipients.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Mail\Mailer  $mailer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $addresses</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool  $onlyIfOutputExists</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">emailOutput</span><span class="params">(Mailer $mailer, $addresses, $onlyIfOutputExists = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = file_exists(<span class="keyword">$this</span>-&gt;output) ? file_get_contents(<span class="keyword">$this</span>-&gt;output) : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($onlyIfOutputExists &amp;&amp; <span class="keyword">empty</span>($text)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $mailer-&gt;raw($text, <span class="function"><span class="keyword">function</span> <span class="params">($m)</span> <span class="title">use</span> <span class="params">($addresses)</span> </span>&#123;</span><br><span class="line">            $m-&gt;to($addresses)-&gt;subject(<span class="keyword">$this</span>-&gt;getEmailSubject());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the e-mail subject line for output results.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getEmailSubject</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;description) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Scheduled Job Output'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register a callback to ping a given URL before the job runs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pingBefore</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;before(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($url)</span> </span>&#123;</span><br><span class="line">            (<span class="keyword">new</span> HttpClient)-&gt;get($url);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register a callback to ping a given URL after the job runs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">thenPing</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($url)</span> </span>&#123;</span><br><span class="line">            (<span class="keyword">new</span> HttpClient)-&gt;get($url);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * State that the command should run in background.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">runInBackground</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;runInBackground = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set which user the command should run as.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">($user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Limit the environments the command should run in.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|mixed  $environments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">environments</span><span class="params">($environments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;environments = is_array($environments) ? $environments : func_get_args();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * State that the command should run even in maintenance mode.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evenInMaintenanceMode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;evenInMaintenanceMode = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Do not allow the event to overlap each other.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $expiresAt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withoutOverlapping</span><span class="params">($expiresAt = <span class="number">1440</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;withoutOverlapping = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;expiresAt = $expiresAt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mutex-&gt;forget(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;)-&gt;skip(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mutex-&gt;exists(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * when 方法用于限制任务基于给定真理测试的结果执行。换句话说，如果给定闭包返回true，只要没有其它约束条件阻止任务运行，该任务就会执行【前置条件检查】</span></span><br><span class="line"><span class="comment">     * Register a callback to further filter the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">when</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filters[] = $callback;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * skip 方法和 when 相反，如果 skip 方法返回true，调度任务将不会执行</span></span><br><span class="line"><span class="comment">     * Register a callback to further filter the schedule.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rejects[] = $callback;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置执行前置处理</span></span><br><span class="line"><span class="comment">     * Register a callback to be called before the operation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;beforeCallbacks[] = $callback;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置执行后置回调</span></span><br><span class="line"><span class="comment">     * Register a callback to be called after the operation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">after</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;then($callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register a callback to be called after the operation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;afterCallbacks[] = $callback;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the human-friendly description of the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $description</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">($description)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;description($description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the human-friendly description of the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $description</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">description</span><span class="params">($description)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;description = $description;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the summary of the event for display.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSummaryForDisplay</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="keyword">$this</span>-&gt;description)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildCommand();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取符合当前正则表达式的下一个绝对时间</span></span><br><span class="line"><span class="comment">     * Determine the next due date for an event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \DateTime|string  $currentTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $nth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool  $allowCurrentDate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Carbon\Carbon</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextRunDate</span><span class="params">($currentTime = <span class="string">'now'</span>, $nth = <span class="number">0</span>, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Carbon::instance($nextDue = CronExpression::factory(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;getExpression()</span><br><span class="line">        )-&gt;getNextRunDate($currentTime, $nth, $allowCurrentDate));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the Cron expression for the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpression</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;expression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置进程锁</span></span><br><span class="line"><span class="comment">     * Set the mutex implementation to be used.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Mutex  $mutex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">preventOverlapsUsing</span><span class="params">(Mutex $mutex)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mutex = $mutex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="PHP-callback-任务对象event"><a href="#PHP-callback-任务对象event" class="headerlink" title="PHP callback  任务对象event"></a>PHP callback  任务对象event</h2><blockquote>
<p><strong>因为进程锁依赖description，而command、shell命令任务可以直接获取命令用于sha1生成进程锁标志，但callback任务不行，所以必须先调用description()方法设置，否则多个callback任务执行会存在问题</strong></p>
</blockquote>
<blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mutexName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&gt; </span>&#123;</span><br><span class="line">&gt;     <span class="keyword">return</span> <span class="string">'framework/schedule-'</span>.sha1(   <span class="keyword">$this</span>-&gt;description);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; <span class="comment">// 如果不设置 每个callback都变成了 'framework/schedule-'   $this-&gt;description返回null</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">LogicException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Container</span>\<span class="title">Container</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackEvent</span> <span class="keyword">extends</span> <span class="title">Event</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The callback to call.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $callback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The parameters to pass to the method.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $parameters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new event instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Mutex  $mutex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $callback</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \InvalidArgumentException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Mutex $mutex, $callback, array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! is_string($callback) &amp;&amp; ! is_callable($callback)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(</span><br><span class="line">                <span class="string">'Invalid scheduled callback event. Must be a string or callable.'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;mutex = $mutex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parameters = $parameters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Container\Container  $container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(Container $container)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;description &amp;&amp; <span class="keyword">$this</span>-&gt;withoutOverlapping &amp;&amp;</span><br><span class="line">            ! <span class="keyword">$this</span>-&gt;mutex-&gt;create(<span class="keyword">$this</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        register_shutdown_function(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;removeMutex();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $response = $container-&gt;call(<span class="keyword">$this</span>-&gt;callback, <span class="keyword">$this</span>-&gt;parameters);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;removeMutex();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">parent</span>::callAfterCallbacks($container);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clear the mutex for the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">removeMutex</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;description) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mutex-&gt;forget(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Do not allow the event to overlap each other.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $expiresAt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withoutOverlapping</span><span class="params">($expiresAt = <span class="number">1440</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;description)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(</span><br><span class="line">                <span class="string">"A scheduled event name is required to prevent overlapping. Use the 'name' method before 'withoutOverlapping'."</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;withoutOverlapping = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;expiresAt = $expiresAt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skip(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mutex-&gt;exists(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the mutex name for the scheduled command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mutexName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'framework/schedule-'</span>.sha1(<span class="keyword">$this</span>-&gt;description);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the summary of the event for display.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSummaryForDisplay</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_string(<span class="keyword">$this</span>-&gt;description)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;description;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> is_string(<span class="keyword">$this</span>-&gt;callback) ? <span class="keyword">$this</span>-&gt;callback : <span class="string">'Closure'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="进程锁Mutex"><a href="#进程锁Mutex" class="headerlink" title="进程锁Mutex"></a>进程锁Mutex</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Mutex</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建锁</span></span><br><span class="line"><span class="comment">     * Attempt to obtain a mutex for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(Event $event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁是否存在</span></span><br><span class="line"><span class="comment">     * Determine if a mutex exists for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exists</span><span class="params">(Event $event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放锁</span></span><br><span class="line"><span class="comment">     * Clear the mutex for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forget</span><span class="params">(Event $event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Cache</span>\<span class="title">Repository</span> <span class="title">as</span> <span class="title">Cache</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheMutex</span> <span class="keyword">implements</span> <span class="title">Mutex</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储介质 如：文件、Redis、数据库</span></span><br><span class="line"><span class="comment">     * The cache repository implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Cache\Repository</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $cache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new overlapping strategy.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Cache\Repository  $cache</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Cache $cache)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache = $cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Attempt to obtain a mutex for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cache-&gt;add(</span><br><span class="line">            $event-&gt;mutexName(), <span class="keyword">true</span>, $event-&gt;expiresAt</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if a mutex exists for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exists</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cache-&gt;has($event-&gt;mutexName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Clear the mutex for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forget</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cache-&gt;forget($event-&gt;mutexName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="执行命令构造器CommandBuilder"><a href="#执行命令构造器CommandBuilder" class="headerlink" title="执行命令构造器CommandBuilder"></a>执行命令构造器CommandBuilder</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Application</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Process</span>\<span class="title">ProcessUtils</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommandBuilder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Build the command for the given event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildCommand</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($event-&gt;runInBackground) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildBackgroundCommand($event);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildForegroundCommand($event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造前台执行命令</span></span><br><span class="line"><span class="comment">     * Build the command for running the event in the foreground.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildForegroundCommand</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $output = ProcessUtils::escapeArgument($event-&gt;output);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ensureCorrectUser(</span><br><span class="line">            $event, $event-&gt;command.($event-&gt;shouldAppendOutput ? <span class="string">' &gt;&gt; '</span> : <span class="string">' &gt; '</span>).$output.<span class="string">' 2&gt;&amp;1'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造后台命令</span></span><br><span class="line"><span class="comment">     * Build the command for running the event in the background.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildBackgroundCommand</span><span class="params">(Event $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $output = ProcessUtils::escapeArgument($event-&gt;output);</span><br><span class="line"></span><br><span class="line">        $redirect = $event-&gt;shouldAppendOutput ? <span class="string">' &gt;&gt; '</span> : <span class="string">' &gt; '</span>;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// 这里相当于一个回调 在执行完成后立刻触发 触发任务的后置钩子函数</span></span><br><span class="line">        $finished = Application::formatCommandString(<span class="string">'schedule:finish'</span>).<span class="string">' "'</span>.$event-&gt;mutexName().<span class="string">'"'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ensureCorrectUser($event,</span><br><span class="line">            <span class="string">'('</span>.$event-&gt;command.$redirect.$output.<span class="string">' 2&gt;&amp;1 '</span>.(windows_os() ? <span class="string">'&amp;'</span> : <span class="string">';'</span>).<span class="string">' '</span>.$finished.<span class="string">') &gt; '</span></span><br><span class="line">            .ProcessUtils::escapeArgument($event-&gt;getDefaultOutput()).<span class="string">' 2&gt;&amp;1 &amp;'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拼接执行用户前缀</span></span><br><span class="line"><span class="comment">     * Finalize the event's command syntax with the correct user.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Event  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $command</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">ensureCorrectUser</span><span class="params">(Event $event, $command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $event-&gt;user &amp;&amp; ! windows_os() ? <span class="string">'sudo -u '</span>.$event-&gt;user.<span class="string">' -- sh -c \''</span>.$command.<span class="string">'\''</span> : $command;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="任务执行ScheduleRunCommand"><a href="#任务执行ScheduleRunCommand" class="headerlink" title="任务执行ScheduleRunCommand"></a>任务执行ScheduleRunCommand</h2><p><strong>所有的任务都是在这个command中来顺序执行的，每一分钟执行一次，需要添加到定时任务crontab</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace Illuminate\Console\Scheduling;</span><br><span class="line"></span><br><span class="line">use Illuminate\Console\Command;</span><br><span class="line"></span><br><span class="line">class ScheduleRunCommand extends Command</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * The console command name.</span><br><span class="line">     *</span><br><span class="line">     * @var string</span><br><span class="line">     */</span><br><span class="line">    protected $name = &apos;schedule:run&apos;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The console command description.</span><br><span class="line">     *</span><br><span class="line">     * @var string</span><br><span class="line">     */</span><br><span class="line">    protected $description = &apos;Run the scheduled commands&apos;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The schedule instance.</span><br><span class="line">     *</span><br><span class="line">     * @var \Illuminate\Console\Scheduling\Schedule</span><br><span class="line">     */</span><br><span class="line">    protected $schedule;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Create a new command instance.</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Console\Scheduling\Schedule  $schedule  任务调度管理类</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function __construct(Schedule $schedule)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;schedule = $schedule;</span><br><span class="line"></span><br><span class="line">        parent::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Execute the console command.</span><br><span class="line">     *</span><br><span class="line">     * @return void</span><br><span class="line">     */</span><br><span class="line">    public function fire()</span><br><span class="line">    &#123;</span><br><span class="line">        $eventsRan = false;</span><br><span class="line"></span><br><span class="line">        // $this-&gt;schedule-&gt;dueEvents($this-&gt;laravel) 获取时间 环境 同时满足的event</span><br><span class="line">        foreach ($this-&gt;schedule-&gt;dueEvents($this-&gt;laravel) as $event) &#123;</span><br><span class="line">            // 判断event某些特定条件是否满足</span><br><span class="line">            if (! $event-&gt;filtersPass($this-&gt;laravel)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $this-&gt;line(&apos;&lt;info&gt;Running scheduled command:&lt;/info&gt; &apos;.$event-&gt;getSummaryForDisplay());</span><br><span class="line"></span><br><span class="line">            // 执行event</span><br><span class="line">            $event-&gt;run($this-&gt;laravel);</span><br><span class="line"></span><br><span class="line">            $eventsRan = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (! $eventsRan) &#123;</span><br><span class="line">            $this-&gt;info(&apos;No scheduled commands are ready to run.&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="后台任务回调执行ScheduleFinishCommand"><a href="#后台任务回调执行ScheduleFinishCommand" class="headerlink" title="后台任务回调执行ScheduleFinishCommand"></a>后台任务回调执行ScheduleFinishCommand</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScheduleFinishCommand</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $signature = <span class="string">'schedule:finish &#123;id&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The console command description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $description = <span class="string">'Handle the completion of a scheduled command'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Indicates whether the command should be shown in the Artisan command list.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $hidden = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The schedule instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Console\Scheduling\Schedule</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $schedule;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new command instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Console\Scheduling\Schedule  $schedule</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Schedule $schedule)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;schedule = $schedule;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里是根据进程锁标识来遍历比较的  </span></span><br><span class="line"><span class="comment">     * Execute the console command.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fire</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        collect(<span class="keyword">$this</span>-&gt;schedule-&gt;events())-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $value-&gt;mutexName() == <span class="keyword">$this</span>-&gt;argument(<span class="string">'id'</span>);</span><br><span class="line">        &#125;)-&gt;each-&gt;callAfterCallbacks(<span class="keyword">$this</span>-&gt;laravel);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>laravel\vendor\mtdowling\cron-expression</p>
</blockquote>
<h2 id="执行表达式解析器"><a href="#执行表达式解析器" class="headerlink" title="执行表达式解析器"></a>执行表达式解析器</h2><h3 id="CronExpression"><a href="#CronExpression" class="headerlink" title="CronExpression"></a>CronExpression</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cron</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTime</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeImmutable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeZone</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">RuntimeException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CRON expression parser that can determine whether or not a CRON expression is</span></span><br><span class="line"><span class="comment"> * due to run, the next run date and previous run date of a CRON expression.</span></span><br><span class="line"><span class="comment"> * The determinations made by this class are accurate if checked run once per</span></span><br><span class="line"><span class="comment"> * minute (seconds are dropped from date time comparisons).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Schedule parts must map to:</span></span><br><span class="line"><span class="comment"> * minute [0-59], hour [0-23], day of month, month [1-12|JAN-DEC], day of week</span></span><br><span class="line"><span class="comment"> * [1-7|MON-SUN], and an optional year.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> http://en.wikipedia.org/wiki/Cron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CronExpression</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> MINUTE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> HOUR = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> DAY = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> MONTH = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">const</span> WEEKDAY = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">const</span> YEAR = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行表达式切分以后的各个部分组成的数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array CRON expression parts</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $cronParts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造字段field校验工具的工厂</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> FieldFactory CRON field factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $fieldFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最多尝试计算次数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int Max iteration count when searching for next run date</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $maxIterationCount = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表达式中年月日时分周各对应第几部分</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array Order in which to test of cron parts</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $order = <span class="keyword">array</span>(<span class="keyword">self</span>::YEAR, <span class="keyword">self</span>::MONTH, <span class="keyword">self</span>::DAY, <span class="keyword">self</span>::WEEKDAY, <span class="keyword">self</span>::HOUR, <span class="keyword">self</span>::MINUTE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Factory method to create a new CronExpression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $expression The CRON expression to create.  There are</span></span><br><span class="line"><span class="comment">     *                           several special predefined values which can be used to substitute the</span></span><br><span class="line"><span class="comment">     *                           CRON expression:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      `<span class="doctag">@yearly</span>`, `<span class="doctag">@annually</span>` - Run once a year, midnight, Jan. 1 - 0 0 1 1 *</span></span><br><span class="line"><span class="comment">     *      `<span class="doctag">@monthly</span>` - Run once a month, midnight, first of month - 0 0 1 * *</span></span><br><span class="line"><span class="comment">     *      `<span class="doctag">@weekly</span>` - Run once a week, midnight on Sun - 0 0 * * 0</span></span><br><span class="line"><span class="comment">     *      `<span class="doctag">@daily</span>` - Run once a day, midnight - 0 0 * * *</span></span><br><span class="line"><span class="comment">     *      `<span class="doctag">@hourly</span>` - Run once an hour, first minute - 0 * * * *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> FieldFactory $fieldFactory Field factory to use</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CronExpression</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">($expression, FieldFactory $fieldFactory = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $mappings = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'@yearly'</span> =&gt; <span class="string">'0 0 1 1 *'</span>,</span><br><span class="line">            <span class="string">'@annually'</span> =&gt; <span class="string">'0 0 1 1 *'</span>,</span><br><span class="line">            <span class="string">'@monthly'</span> =&gt; <span class="string">'0 0 1 * *'</span>,</span><br><span class="line">            <span class="string">'@weekly'</span> =&gt; <span class="string">'0 0 * * 0'</span>,</span><br><span class="line">            <span class="string">'@daily'</span> =&gt; <span class="string">'0 0 * * *'</span>,</span><br><span class="line">            <span class="string">'@hourly'</span> =&gt; <span class="string">'0 * * * *'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($mappings[$expression])) &#123;</span><br><span class="line">            $expression = $mappings[$expression];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>($expression, $fieldFactory ?: <span class="keyword">new</span> FieldFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Validate a CronExpression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $expression The CRON expression to validate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool True if a valid CRON expression was passed. False if not.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> \Cron\CronExpression::factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidExpression</span><span class="params">($expression)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>::factory($expression);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Parse a CRON expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string       $expression   CRON expression (e.g. '8 * * * *')</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> FieldFactory $fieldFactory Factory to create cron fields</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($expression, FieldFactory $fieldFactory)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;fieldFactory = $fieldFactory;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setExpression($expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set or change the CRON expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value CRON expression (e.g. 8 * * * *)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CronExpression</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \InvalidArgumentException if not a valid CRON expression</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setExpression</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cronParts = preg_split(<span class="string">'/\s/'</span>, $value, <span class="number">-1</span>, PREG_SPLIT_NO_EMPTY);</span><br><span class="line">        <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;cronParts) &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(</span><br><span class="line">                $value . <span class="string">' is not a valid CRON expression'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;cronParts <span class="keyword">as</span> $position =&gt; $part) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;setPart($position, $part);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set part of the CRON expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int    $position The position of the CRON expression to set</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value    The value to set</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CronExpression</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \InvalidArgumentException if the value is not valid for the part</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPart</span><span class="params">($position, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;fieldFactory-&gt;getField($position)-&gt;validate($value)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(</span><br><span class="line">                <span class="string">'Invalid CRON field value '</span> . $value . <span class="string">' at position '</span> . $position</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cronParts[$position] = $value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set max iteration count for searching next run dates</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $maxIterationCount Max iteration count when searching for next run date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CronExpression</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setMaxIterationCount</span><span class="params">($maxIterationCount)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;maxIterationCount = $maxIterationCount;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get a next run date relative to the current date or a specific date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime      Relative calculation date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int              $nth              Number of matches to skip before returning a</span></span><br><span class="line"><span class="comment">     *                                           matching next run date.  0, the default, will return the current</span></span><br><span class="line"><span class="comment">     *                                           date and time if the next run date falls on the current date and</span></span><br><span class="line"><span class="comment">     *                                           time.  Setting this value to 1 will skip the first match and go to</span></span><br><span class="line"><span class="comment">     *                                           the second match.  Setting this value to 2 will skip the first 2</span></span><br><span class="line"><span class="comment">     *                                           matches and so on.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $allowCurrentDate Set to TRUE to return the current date if</span></span><br><span class="line"><span class="comment">     *                                           it matches the cron expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \DateTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \RuntimeException on too many iterations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNextRunDate</span><span class="params">($currentTime = <span class="string">'now'</span>, $nth = <span class="number">0</span>, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRunDate($currentTime, $nth, <span class="keyword">false</span>, $allowCurrentDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get a previous run date relative to the current date or a specific date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime      Relative calculation date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int              $nth              Number of matches to skip before returning</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $allowCurrentDate Set to TRUE to return the</span></span><br><span class="line"><span class="comment">     *                                           current date if it matches the cron expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \DateTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \RuntimeException on too many iterations</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> \Cron\CronExpression::getNextRunDate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPreviousRunDate</span><span class="params">($currentTime = <span class="string">'now'</span>, $nth = <span class="number">0</span>, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRunDate($currentTime, $nth, <span class="keyword">true</span>, $allowCurrentDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get multiple run dates starting at the current date or a specific date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int              $total            Set the total number of dates to calculate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime      Relative calculation date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $invert           Set to TRUE to retrieve previous dates</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $allowCurrentDate Set to TRUE to return the</span></span><br><span class="line"><span class="comment">     *                                           current date if it matches the cron expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array Returns an array of run dates</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMultipleRunDates</span><span class="params">($total, $currentTime = <span class="string">'now'</span>, $invert = false, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $matches = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; max(<span class="number">0</span>, $total); $i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                $matches[] = <span class="keyword">$this</span>-&gt;getRunDate($currentTime, $i, $invert, $allowCurrentDate);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException $e) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $matches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get all or part of the CRON expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $part Specify the part to retrieve or NULL to get the full</span></span><br><span class="line"><span class="comment">     *                     cron schedule string.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string|null Returns the CRON expression, a part of the</span></span><br><span class="line"><span class="comment">     *                     CRON expression, or NULL if the part was specified but not found</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getExpression</span><span class="params">($part = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> === $part) &#123;</span><br><span class="line">            <span class="keyword">return</span> implode(<span class="string">' '</span>, <span class="keyword">$this</span>-&gt;cronParts);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($part, <span class="keyword">$this</span>-&gt;cronParts)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cronParts[$part];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper method to output the full expression.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string Full CRON expression</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getExpression();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the cron is due to run based on the current date or a</span></span><br><span class="line"><span class="comment">     * specific date.  This method assumes that the current number of</span></span><br><span class="line"><span class="comment">     * seconds are irrelevant, and should be called once per minute.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime Relative calculation date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool Returns TRUE if the cron is due to run or FALSE if not</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isDue</span><span class="params">($currentTime = <span class="string">'now'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'now'</span> === $currentTime) &#123;</span><br><span class="line">            $currentDate = date(<span class="string">'Y-m-d H:i'</span>);</span><br><span class="line">            $currentTime = strtotime($currentDate);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($currentTime <span class="keyword">instanceof</span> DateTime) &#123;</span><br><span class="line">            $currentDate = <span class="keyword">clone</span> $currentTime;</span><br><span class="line">            <span class="comment">// Ensure time in 'current' timezone is used</span></span><br><span class="line">            $currentDate-&gt;setTimezone(<span class="keyword">new</span> DateTimeZone(date_default_timezone_get()));</span><br><span class="line">            $currentDate = $currentDate-&gt;format(<span class="string">'Y-m-d H:i'</span>);</span><br><span class="line">            $currentTime = strtotime($currentDate);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($currentTime <span class="keyword">instanceof</span> DateTimeImmutable) &#123;</span><br><span class="line">            $currentDate = DateTime::createFromFormat(<span class="string">'U'</span>, $currentTime-&gt;format(<span class="string">'U'</span>));</span><br><span class="line">            $currentDate-&gt;setTimezone(<span class="keyword">new</span> DateTimeZone(date_default_timezone_get()));</span><br><span class="line">            $currentDate = $currentDate-&gt;format(<span class="string">'Y-m-d H:i'</span>);</span><br><span class="line">            $currentTime = strtotime($currentDate);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $currentTime = <span class="keyword">new</span> DateTime($currentTime);</span><br><span class="line">            $currentTime-&gt;setTime($currentTime-&gt;format(<span class="string">'H'</span>), $currentTime-&gt;format(<span class="string">'i'</span>), <span class="number">0</span>);</span><br><span class="line">            $currentDate = $currentTime-&gt;format(<span class="string">'Y-m-d H:i'</span>);</span><br><span class="line">            $currentTime = $currentTime-&gt;getTimeStamp();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getNextRunDate($currentDate, <span class="number">0</span>, <span class="keyword">true</span>)-&gt;getTimestamp() == $currentTime;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the next or previous run date of the expression relative to a date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime      Relative calculation date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int              $nth              Number of matches to skip before returning</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $invert           Set to TRUE to go backwards in time</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $allowCurrentDate Set to TRUE to return the</span></span><br><span class="line"><span class="comment">     *                                           current date if it matches the cron expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \DateTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \RuntimeException on too many iterations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRunDate</span><span class="params">($currentTime = null, $nth = <span class="number">0</span>, $invert = false, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($currentTime <span class="keyword">instanceof</span> DateTime) &#123;</span><br><span class="line">            $currentDate = <span class="keyword">clone</span> $currentTime;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($currentTime <span class="keyword">instanceof</span> DateTimeImmutable) &#123;</span><br><span class="line">            $currentDate = DateTime::createFromFormat(<span class="string">'U'</span>, $currentTime-&gt;format(<span class="string">'U'</span>));</span><br><span class="line">            $currentDate-&gt;setTimezone($currentTime-&gt;getTimezone());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $currentDate = <span class="keyword">new</span> DateTime($currentTime ?: <span class="string">'now'</span>);</span><br><span class="line">            $currentDate-&gt;setTimezone(<span class="keyword">new</span> DateTimeZone(date_default_timezone_get()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $currentDate-&gt;setTime($currentDate-&gt;format(<span class="string">'H'</span>), $currentDate-&gt;format(<span class="string">'i'</span>), <span class="number">0</span>);</span><br><span class="line">        $nextRun = <span class="keyword">clone</span> $currentDate;</span><br><span class="line">        $nth = (int) $nth;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We don't have to satisfy * or null fields</span></span><br><span class="line">        $parts = <span class="keyword">array</span>();</span><br><span class="line">        $fields = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$order <span class="keyword">as</span> $position) &#123;</span><br><span class="line">            $part = <span class="keyword">$this</span>-&gt;getExpression($position);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> === $part || <span class="string">'*'</span> === $part) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $parts[$position] = $part;</span><br><span class="line">            $fields[$position] = <span class="keyword">$this</span>-&gt;fieldFactory-&gt;getField($position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set a hard limit to bail on an impossible date</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="keyword">$this</span>-&gt;maxIterationCount; $i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($parts <span class="keyword">as</span> $position =&gt; $part) &#123;</span><br><span class="line">                $satisfied = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// Get the field object used to validate this part</span></span><br><span class="line">                $field = $fields[$position];</span><br><span class="line">                <span class="comment">// Check if this is singular or a list</span></span><br><span class="line">                <span class="keyword">if</span> (strpos($part, <span class="string">','</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">                    $satisfied = $field-&gt;isSatisfiedBy($nextRun, $part);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (array_map(<span class="string">'trim'</span>, explode(<span class="string">','</span>, $part)) <span class="keyword">as</span> $listPart) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($field-&gt;isSatisfiedBy($nextRun, $listPart)) &#123;</span><br><span class="line">                            $satisfied = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If the field is not satisfied, then start over</span></span><br><span class="line">                <span class="keyword">if</span> (!$satisfied) &#123;</span><br><span class="line">                    $field-&gt;increment($nextRun, $invert, $part);</span><br><span class="line">                    <span class="keyword">continue</span> <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Skip this match if needed</span></span><br><span class="line">            <span class="keyword">if</span> ((!$allowCurrentDate &amp;&amp; $nextRun == $currentDate) || --$nth &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;fieldFactory-&gt;getField(<span class="number">0</span>)-&gt;increment($nextRun, $invert, <span class="keyword">isset</span>($parts[<span class="number">0</span>]) ? $parts[<span class="number">0</span>] : <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $nextRun;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @codeCoverageIgnoreStart</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Impossible CRON expression'</span>);</span><br><span class="line">        <span class="comment">// @codeCoverageIgnoreEnd</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AbstractField"><a href="#AbstractField" class="headerlink" title="AbstractField"></a><strong>AbstractField</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cron</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Abstract CRON expression field</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractField</span> <span class="keyword">implements</span> <span class="title">FieldInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check to see if a field is satisfied by a value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $dateValue Date value to check</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value     Value to test</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfied</span><span class="params">($dateValue, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isIncrementsOfRanges($value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isInIncrementsOfRanges($dateValue, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;isRange($value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isInRange($dateValue, $value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $value == <span class="string">'*'</span> || $dateValue == $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if a value is a range</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value Value to test</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isRange</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strpos($value, <span class="string">'-'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Check if a value is an increments of ranges</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value Value to test</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isIncrementsOfRanges</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strpos($value, <span class="string">'/'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Test if a value is within a range</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $dateValue Set date value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value     Value to test</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isInRange</span><span class="params">($dateValue, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parts = array_map(<span class="string">'trim'</span>, explode(<span class="string">'-'</span>, $value, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $dateValue &gt;= $parts[<span class="number">0</span>] &amp;&amp; $dateValue &lt;= $parts[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Test if a value is within an increments of ranges (offset[-to]/step size)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $dateValue Set date value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value     Value to test</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isInIncrementsOfRanges</span><span class="params">($dateValue, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $parts = array_map(<span class="string">'trim'</span>, explode(<span class="string">'/'</span>, $value, <span class="number">2</span>));</span><br><span class="line">        $stepSize = <span class="keyword">isset</span>($parts[<span class="number">1</span>]) ? (int) $parts[<span class="number">1</span>] : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($stepSize === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        0 23-7/1 * * * /usr/local/etc/rc.d/lighttpd restart </span></span><br><span class="line"><span class="comment">        晚上11点到早上7点之间，每隔一小时重启apache </span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line">        <span class="comment">// 这种写法还是第一次见</span></span><br><span class="line">        <span class="keyword">if</span> (($parts[<span class="number">0</span>] == <span class="string">'*'</span> || $parts[<span class="number">0</span>] === <span class="string">'0'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (int) $dateValue % $stepSize == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $range = explode(<span class="string">'-'</span>, $parts[<span class="number">0</span>], <span class="number">2</span>);</span><br><span class="line">        $offset = $range[<span class="number">0</span>];</span><br><span class="line">        $to = <span class="keyword">isset</span>($range[<span class="number">1</span>]) ? $range[<span class="number">1</span>] : $dateValue;</span><br><span class="line">        <span class="comment">// Ensure that the date value is within the range</span></span><br><span class="line">        <span class="keyword">if</span> ($dateValue &lt; $offset || $dateValue &gt; $to) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($dateValue &gt; $offset &amp;&amp; <span class="number">0</span> === $stepSize) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ($i = $offset; $i &lt;= $to; $i+= $stepSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($i == $dateValue) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a range of values for the given cron expression</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $expression The expression to evaluate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $max           Maximum offset for range</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRangeForExpression</span><span class="params">($expression, $max)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $values = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isRange($expression) || <span class="keyword">$this</span>-&gt;isIncrementsOfRanges($expression)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isIncrementsOfRanges($expression)) &#123;</span><br><span class="line">                <span class="keyword">list</span> ($offset, $to) = explode(<span class="string">'-'</span>, $expression);</span><br><span class="line">                $stepSize = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                $range = array_map(<span class="string">'trim'</span>, explode(<span class="string">'/'</span>, $expression, <span class="number">2</span>));</span><br><span class="line">                $stepSize = <span class="keyword">isset</span>($range[<span class="number">1</span>]) ? $range[<span class="number">1</span>] : <span class="number">0</span>;</span><br><span class="line">                $range = $range[<span class="number">0</span>];</span><br><span class="line">                $range = explode(<span class="string">'-'</span>, $range, <span class="number">2</span>);</span><br><span class="line">                $offset = $range[<span class="number">0</span>];</span><br><span class="line">                $to = <span class="keyword">isset</span>($range[<span class="number">1</span>]) ? $range[<span class="number">1</span>] : $max;</span><br><span class="line">            &#125;</span><br><span class="line">            $offset = $offset == <span class="string">'*'</span> ? <span class="number">0</span> : $offset;</span><br><span class="line">            <span class="keyword">for</span> ($i = $offset; $i &lt;= $to; $i += $stepSize) &#123;</span><br><span class="line">                $values[] = $i;</span><br><span class="line">            &#125;</span><br><span class="line">            sort($values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $values = <span class="keyword">array</span>($expression);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $values;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="HoursField"><a href="#HoursField" class="headerlink" title="HoursField"></a>HoursField</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cron</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTime</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTimeZone</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hours field.  Allows: * , / -</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HoursField</span> <span class="keyword">extends</span> <span class="title">AbstractField</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(DateTime $date, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isSatisfied($date-&gt;format(<span class="string">'H'</span>), $value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">(DateTime $date, $invert = false, $parts = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注意点：$date是一个对象，所以这里面的修改对CronExpression的传入值是有影响的同步修改</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// Change timezone to UTC temporarily. This will</span></span><br><span class="line">        <span class="comment">// allow us to go back or forwards and hour even</span></span><br><span class="line">        <span class="comment">// if DST will be changed between the hours.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 每分钟执行一次 所以直接-1或者+1</span></span><br><span class="line">        <span class="keyword">if</span> (is_null($parts) || $parts == <span class="string">'*'</span>) &#123;</span><br><span class="line">            $timezone = $date-&gt;getTimezone();</span><br><span class="line">            $date-&gt;setTimezone(<span class="keyword">new</span> DateTimeZone(<span class="string">'UTC'</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ($invert) &#123;</span><br><span class="line">                $date-&gt;modify(<span class="string">'-1 hour'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $date-&gt;modify(<span class="string">'+1 hour'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置时区</span></span><br><span class="line">            $date-&gt;setTimezone($timezone);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// $invert为true时，说明是获取已经执行过的前n个执行时间点 所以是从前一小时59分反向查找</span></span><br><span class="line">            <span class="comment">// $invert为false时，说明是获取将要执行的第n个执行时间点 所以是从下一小时0分正向查找</span></span><br><span class="line">            $date-&gt;setTime($date-&gt;format(<span class="string">'H'</span>), $invert ? <span class="number">59</span> : <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取满足表达式要求的所有时间点（一天的所有小时时间点 比如： 13 23 10）</span></span><br><span class="line">        <span class="comment">// 分割表达式部分 看是否是多个特定时间点执行</span></span><br><span class="line">        $parts = strpos($parts, <span class="string">','</span>) !== <span class="keyword">false</span> ? explode(<span class="string">','</span>, $parts) : <span class="keyword">array</span>($parts);</span><br><span class="line">        $hours = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> ($parts <span class="keyword">as</span> $part) &#123;</span><br><span class="line">            <span class="comment">// getRangeForExpression是处理每多少小时执行一次这种情况  结果是升序排列的</span></span><br><span class="line">            $hours = array_merge($hours, <span class="keyword">$this</span>-&gt;getRangeForExpression($part, <span class="number">23</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断离传入时间最近的执行时间点时那个</span></span><br><span class="line">        <span class="comment">// $i是最近一次执行过的时间点  $i + 1是将要执行的时间点</span></span><br><span class="line">        $current_hour = $date-&gt;format(<span class="string">'H'</span>);</span><br><span class="line">        $position = $invert ? count($hours) - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (count($hours) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($hours) - <span class="number">1</span>; $i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((!$invert &amp;&amp; $current_hour &gt;= $hours[$i] &amp;&amp; $current_hour &lt; $hours[$i + <span class="number">1</span>]) ||</span><br><span class="line">                    ($invert &amp;&amp; $current_hour &gt; $hours[$i] &amp;&amp; $current_hour &lt;= $hours[$i + <span class="number">1</span>])) &#123;</span><br><span class="line">                    $position = $invert ? $i : $i + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// !$invert &amp;&amp; $current_hour &gt;= $hours[$i] &amp;&amp; $current_hour &lt; $hours[$i + 1]</span></span><br><span class="line">        <span class="comment">// $position = $invert ? $i : $i + 1;</span></span><br><span class="line">        <span class="comment">// $invert为false时，说明是查找将来的一个执行时间点，所以肯定是大于当前时间的  所以取$i + 1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// $invert &amp;&amp; $current_hour &gt; $hours[$i] &amp;&amp; $current_hour &lt;= $hours[$i + 1]</span></span><br><span class="line">        <span class="comment">// $position = $invert ? $i : $i + 1;</span></span><br><span class="line">        <span class="comment">// $invert为true时，说明是查找将来的一个执行时间点，所以肯定是小于当前时间的  所以取$i</span></span><br><span class="line"></span><br><span class="line">        $hour = $hours[$position];</span><br><span class="line">        <span class="comment">// 没有找到满足条件的最近的执行时间点 说明必须在昨天或明天才可能执行</span></span><br><span class="line">        <span class="keyword">if</span> ((!$invert &amp;&amp; $date-&gt;format(<span class="string">'H'</span>) &gt;= $hour) || ($invert &amp;&amp; $date-&gt;format(<span class="string">'H'</span>) &lt;= $hour)) &#123;</span><br><span class="line">            <span class="comment">// $invert为true时，说明是获取已经执行过的前n个执行时间点 所以是从昨天23点59分反向查找</span></span><br><span class="line">            <span class="comment">// $invert为false时，说明是获取将要执行的第n个执行时间点 所以是从明天0时0分正向查找     </span></span><br><span class="line">            $date-&gt;modify(($invert ? <span class="string">'-'</span> : <span class="string">'+'</span>) . <span class="string">'1 day'</span>);</span><br><span class="line">            $date-&gt;setTime($invert ? <span class="number">23</span> : <span class="number">0</span>, $invert ? <span class="number">59</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 找到了满足条件的最近的执行时间点</span></span><br><span class="line">            $date-&gt;setTime($hour, $invert ? <span class="number">59</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (bool) preg_match(<span class="string">'/^[\*,\/\-0-9]+$/'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="MinutesField"><a href="#MinutesField" class="headerlink" title="MinutesField"></a>MinutesField</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cron</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">DateTime</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Minutes field.  Allows: * , / -</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MinutesField</span> <span class="keyword">extends</span> <span class="title">AbstractField</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isSatisfiedBy</span><span class="params">(DateTime $date, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isSatisfied($date-&gt;format(<span class="string">'i'</span>), $value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">(DateTime $date, $invert = false, $parts = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($parts)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($invert) &#123;</span><br><span class="line">                $date-&gt;modify(<span class="string">'-1 minute'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $date-&gt;modify(<span class="string">'+1 minute'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $parts = strpos($parts, <span class="string">','</span>) !== <span class="keyword">false</span> ? explode(<span class="string">','</span>, $parts) : <span class="keyword">array</span>($parts);</span><br><span class="line">        $minutes = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> ($parts <span class="keyword">as</span> $part) &#123;</span><br><span class="line">            $minutes = array_merge($minutes, <span class="keyword">$this</span>-&gt;getRangeForExpression($part, <span class="number">59</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $current_minute = $date-&gt;format(<span class="string">'i'</span>);</span><br><span class="line">        $position = $invert ? count($minutes) - <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (count($minutes) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($minutes) - <span class="number">1</span>; $i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((!$invert &amp;&amp; $current_minute &gt;= $minutes[$i] &amp;&amp; $current_minute &lt; $minutes[$i + <span class="number">1</span>]) ||</span><br><span class="line">                    ($invert &amp;&amp; $current_minute &gt; $minutes[$i] &amp;&amp; $current_minute &lt;= $minutes[$i + <span class="number">1</span>])) &#123;</span><br><span class="line">                    $position = $invert ? $i : $i + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((!$invert &amp;&amp; $current_minute &gt;= $minutes[$position]) || ($invert &amp;&amp; $current_minute &lt;= $minutes[$position])) &#123;</span><br><span class="line">            $date-&gt;modify(($invert ? <span class="string">'-'</span> : <span class="string">'+'</span>) . <span class="string">'1 hour'</span>);</span><br><span class="line">            $date-&gt;setTime($date-&gt;format(<span class="string">'H'</span>), $invert ? <span class="number">59</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $date-&gt;setTime($date-&gt;format(<span class="string">'H'</span>), $minutes[$position]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (bool) preg_match(<span class="string">'/^[\*,\/\-0-9]+$/'</span>, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FieldFactory"><a href="#FieldFactory" class="headerlink" title="FieldFactory"></a><strong>FieldFactory</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Cron</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">InvalidArgumentException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CRON field factory implementing a flyweight factory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> http://en.wikipedia.org/wiki/Cron</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FieldFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array Cache of instantiated fields</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> $fields = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get an instance of a field object for a cron expression position</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $position CRON expression position value to retrieve</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FieldInterface</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InvalidArgumentException if a position is not valid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getField</span><span class="params">($position)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;fields[$position])) &#123;</span><br><span class="line">            <span class="keyword">switch</span> ($position) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> MinutesField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> HoursField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> DayOfMonthField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> MonthField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> DayOfWeekField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;fields[$position] = <span class="keyword">new</span> YearField();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(</span><br><span class="line">                        $position . <span class="string">' is not a valid position'</span></span><br><span class="line">                    );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;fields[$position];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取执行时间"><a href="#获取执行时间" class="headerlink" title="获取执行时间"></a>获取执行时间</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the next or previous run date of the expression relative to a date</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|\DateTime $currentTime      Relative calculation date  （计算的相对时间）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int              $nth              Number of matches to skip before returning （第几次）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $invert           Set to TRUE to go backwards in time （过去还是未来 invert为true时代表获取过去的第nth的执行时间   invert为false时代表获取接下来的第nth的执行时间）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool             $allowCurrentDate Set to TRUE to return the</span></span><br><span class="line"><span class="comment">     *                                           current date if it matches the cron expression （是否允许包含当前传入的时间  比如：每5分钟执行一次  传入的刚好是5放入整数倍这种）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \DateTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \RuntimeException on too many iterations</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRunDate</span><span class="params">($currentTime = null, $nth = <span class="number">0</span>, $invert = false, $allowCurrentDate = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 设置时区等信息</span></span><br><span class="line">        <span class="keyword">if</span> ($currentTime <span class="keyword">instanceof</span> DateTime) &#123;</span><br><span class="line">            $currentDate = <span class="keyword">clone</span> $currentTime;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($currentTime <span class="keyword">instanceof</span> DateTimeImmutable) &#123;</span><br><span class="line">            $currentDate = DateTime::createFromFormat(<span class="string">'U'</span>, $currentTime-&gt;format(<span class="string">'U'</span>));</span><br><span class="line">            $currentDate-&gt;setTimezone($currentTime-&gt;getTimezone());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $currentDate = <span class="keyword">new</span> DateTime($currentTime ?: <span class="string">'now'</span>);</span><br><span class="line">            $currentDate-&gt;setTimezone(<span class="keyword">new</span> DateTimeZone(date_default_timezone_get()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $currentDate-&gt;setTime($currentDate-&gt;format(<span class="string">'H'</span>), $currentDate-&gt;format(<span class="string">'i'</span>), <span class="number">0</span>);</span><br><span class="line">        $nextRun = <span class="keyword">clone</span> $currentDate;</span><br><span class="line">        $nth = (int) $nth;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We don't have to satisfy * or null fields</span></span><br><span class="line">        <span class="comment">// 获取表达式各部分的值  构造各个部分的校验工具</span></span><br><span class="line">        $parts = <span class="keyword">array</span>();</span><br><span class="line">        $fields = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">self</span>::$order <span class="keyword">as</span> $position) &#123;</span><br><span class="line">            $part = <span class="keyword">$this</span>-&gt;getExpression($position);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> === $part || <span class="string">'*'</span> === $part) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $parts[$position] = $part;</span><br><span class="line">            $fields[$position] = <span class="keyword">$this</span>-&gt;fieldFactory-&gt;getField($position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set a hard limit to bail on an impossible date</span></span><br><span class="line">        <span class="comment">// 计算值 最大计算满足条件的时间 1000次  即nth不能够大于10000</span></span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="keyword">$this</span>-&gt;maxIterationCount; $i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> ($parts <span class="keyword">as</span> $position =&gt; $part) &#123;</span><br><span class="line">                $satisfied = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// Get the field object used to validate this part</span></span><br><span class="line">                $field = $fields[$position];</span><br><span class="line">                <span class="comment">// Check if this is singular or a list</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 1 </span></span><br><span class="line">                <span class="comment">// */5 1-10/5</span></span><br><span class="line">                <span class="comment">// 1-10</span></span><br><span class="line">                <span class="comment">// *</span></span><br><span class="line">                <span class="comment">// 这几种情况判断</span></span><br><span class="line">                <span class="keyword">if</span> (strpos($part, <span class="string">','</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">                    $satisfied = $field-&gt;isSatisfiedBy($nextRun, $part);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 1, 3, 5这种多个特定时间点执行</span></span><br><span class="line">                    <span class="keyword">foreach</span> (array_map(<span class="string">'trim'</span>, explode(<span class="string">','</span>, $part)) <span class="keyword">as</span> $listPart) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($field-&gt;isSatisfiedBy($nextRun, $listPart)) &#123;</span><br><span class="line">                            $satisfied = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If the field is not satisfied, then start over</span></span><br><span class="line">                <span class="comment">// 不满足 开始变更  表达式约束</span></span><br><span class="line">                <span class="keyword">if</span> (!$satisfied) &#123;</span><br><span class="line">                    $field-&gt;increment($nextRun, $invert, $part);</span><br><span class="line">                    <span class="comment">// 继续执行foreach ($parts as $position =&gt; $part) 直到满足条件</span></span><br><span class="line">                    <span class="keyword">continue</span> <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Skip this match if needed</span></span><br><span class="line">            <span class="comment">// 不允许为当前时间  或者 $nth不满足要求</span></span><br><span class="line">            <span class="keyword">if</span> ((!$allowCurrentDate &amp;&amp; $nextRun == $currentDate) || --$nth &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;fieldFactory-&gt;getField(<span class="number">0</span>)-&gt;increment($nextRun, $invert, <span class="keyword">isset</span>($parts[<span class="number">0</span>]) ? $parts[<span class="number">0</span>] : <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">//  for ($i = 0; $i &lt; $this-&gt;maxIterationCount; $i++)  $i加1</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $nextRun;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @codeCoverageIgnoreStart</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Impossible CRON expression'</span>);</span><br><span class="line">        <span class="comment">// @codeCoverageIgnoreEnd</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="为什么要依赖绝对时间，而不是相对时间"><a href="#为什么要依赖绝对时间，而不是相对时间" class="headerlink" title="为什么要依赖绝对时间，而不是相对时间"></a>为什么要依赖绝对时间，而不是相对时间</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;原因在于一方面根据相对时间来判断任务是否应该执行，需要在程序里面<strong>维护每一个任务的上一次执行时间</strong>，且<strong>程序不能够异常退出或者重启</strong>。另一方面在于各个任务的执行时间点不一致，不好控制执行时间，一个任务执行卡住了，后续的任务都得不到执行，需要<strong>使用while死循环保持持续运行，一次执行出问题了，后续都不能够正确执行，而现在使用crontab每分钟执行一次，根据绝对时间来判断任务是否执行，每次调度是独立的，不会相互影响</strong>。</p>
<blockquote>
<p><strong>crontab 执行也是依赖绝对时间</strong></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/42/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><span class="page-number current">43</span><a class="page-number" href="/page/44/">44</a><span class="space">&hellip;</span><a class="page-number" href="/page/147/">147</a><a class="extend next" rel="next" href="/page/44/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">刘泽明</p>
              <p class="site-description motion-element" itemprop="description">做一个懂业务的程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">731</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">394</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">237</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-[object Object]"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘泽明</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
